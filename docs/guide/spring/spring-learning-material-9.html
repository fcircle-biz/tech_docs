<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Framework初心者向け学習教材 - 第9章：Todoアプリケーション開発</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        .navbar {
            background-color: #28a745;
        }
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        .chapter-title {
            color: #28a745;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #28a745;
            padding-bottom: 0.5rem;
        }
        .section-title {
            color: #218838;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        code {
            display: block;
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            white-space: pre;
            overflow-x: auto;
        }
        .quiz-container {
            background-color: #e8f4e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        .quiz-question {
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .diagram {
            max-width: 100%;
            height: auto;
            margin: 1.5rem 0;
            text-align: center;
        }
        .exercise {
            background-color: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1.5rem 0;
        }
        .note {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 1rem;
            margin: 1.5rem 0;
        }
        #table-of-contents .list-group-item {
            border: none;
            padding: 0.5rem 1rem;
        }
        #table-of-contents .list-group-item-action {
            color: #28a745;
        }
        #table-of-contents .list-group-item-action.active,
        .list-group-item.active {
            color: white !important;
            background-color: #28a745;
            border-color: #28a745;
        }
        .section-nav {
            padding-left: 1rem;
        }
        .inline-code {
            background-color: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            display: inline;
        }
        footer {
            background-color: #28a745;
            color: white;
            padding: 1rem 0;
            margin-top: 3rem;
        }
        .table-example {
            width: 100%;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        .table-example th {
            background-color: #e8f4e8;
            border: 1px solid #c3e6cb;
            padding: 0.5rem;
            text-align: center;
        }
        .table-example td {
            border: 1px solid #c3e6cb;
            padding: 0.5rem;
            text-align: center;
        }
        .example-result {
            background-color: #f1f8e9;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .warning {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 1rem;
            margin: 1.5rem 0;
        }
    </style>
</head>
<body data-bs-spy="scroll" data-bs-target="#tableOfContents">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">Spring Framework初心者向け学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#introduction">はじめに</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#chapter9">第9章: Todoアプリケーション開発</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row">
            <!-- Sidebar - Table of Contents -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">目次</h5>
                        </div>
                        <div id="table-of-contents" class="list-group list-group-flush">
                            <a href="#introduction" class="list-group-item list-group-item-action">はじめに</a>
                            <a href="#chapter9" class="list-group-item list-group-item-action">第9章: Todoアプリケーション開発</a>
                            <div class="section-nav">
                                <a href="#project-overview" class="list-group-item list-group-item-action">9.1 プロジェクト概要</a>
                                <a href="#project-setup" class="list-group-item list-group-item-action">9.2 プロジェクトセットアップ</a>
                                <a href="#data-model" class="list-group-item list-group-item-action">9.3 データモデルの作成</a>
                                <a href="#repository-layer" class="list-group-item list-group-item-action">9.4 リポジトリ層の実装</a>
                                <a href="#service-layer" class="list-group-item list-group-item-action">9.5 サービス層の実装</a>
                                <a href="#controller-layer" class="list-group-item list-group-item-action">9.6 コントローラ層の実装</a>
                                <a href="#view-layer" class="list-group-item list-group-item-action">9.7 ビュー層の作成</a>
                                <a href="#form-validation" class="list-group-item list-group-item-action">9.8 フォームバリデーション</a>
                                <a href="#login-implementation" class="list-group-item list-group-item-action">9.9 ログイン機能の実装</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-lg-9">
                <section id="introduction">
                    <h1 class="display-5 mb-4">Spring Framework初心者向け学習教材</h1>
                    <p class="lead">この教材では、Java開発の効率化と保守性の向上を実現するSpring Frameworkについて学習します。この第9章では、これまでに学習した内容を統合して、実践的なTodo管理アプリケーションを開発します。</p>

                    <div class="note">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>実践的なSpringアプリケーションの構築方法</li>
                            <li>Spring Data JDBCを使用したデータベース連携</li>
                            <li>Spring MVCを使用したフロントエンドとバックエンドの連携</li>
                            <li>バリデーションの実装</li>
                            <li>Spring Securityを使用したログイン機能の実装</li>
                        </ul>
                    </div>
                </section>

                <section id="chapter9">
                    <h2 class="chapter-title">第9章：Todoアプリケーション開発</h2>
                    <p>本章では、これまで学んできたSpring Frameworkの知識を活用して、実用的なTodo管理アプリケーションを開発します。CRUD操作の実装、フォームバリデーション、セキュリティ機能など、Webアプリケーション開発に必要な要素を統合的に学びます。</p>

                    <section id="project-overview">
                        <h3 class="section-title">9.1 プロジェクト概要</h3>
                        <p>今回開発するアプリケーションは、ユーザーが自分のタスク（Todo）を管理できるWebアプリケーションです。以下の機能を実装します：</p>

                        <ul>
                            <li><strong>ユーザー認証</strong>：ログイン/ログアウト機能</li>
                            <li><strong>Todo一覧表示</strong>：ユーザーの登録したTodoアイテムの一覧表示</li>
                            <li><strong>Todo登録</strong>：新しいTodoアイテムの作成</li>
                            <li><strong>Todo編集</strong>：既存Todoアイテムの更新</li>
                            <li><strong>Todo削除</strong>：不要になったTodoアイテムの削除</li>
                            <li><strong>バリデーション</strong>：フォーム入力の検証</li>
                        </ul>

                        <div class="diagram">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 300" width="600" height="300">
                                <rect x="200" y="20" width="200" height="50" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="5" />
                                <text x="300" y="50" text-anchor="middle" font-size="16">Todoアプリケーション</text>
                                
                                <rect x="50" y="120" width="150" height="40" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="5" />
                                <text x="125" y="145" text-anchor="middle" font-size="14">ユーザー認証</text>
                                
                                <rect x="225" y="120" width="150" height="40" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="5" />
                                <text x="300" y="145" text-anchor="middle" font-size="14">Todo管理</text>
                                
                                <rect x="400" y="120" width="150" height="40" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="5" />
                                <text x="475" y="145" text-anchor="middle" font-size="14">バリデーション</text>
                                
                                <rect x="150" y="210" width="100" height="30" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="1" rx="3" />
                                <text x="200" y="230" text-anchor="middle" font-size="12">一覧表示</text>
                                
                                <rect x="250" y="210" width="100" height="30" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="1" rx="3" />
                                <text x="300" y="230" text-anchor="middle" font-size="12">登録</text>
                                
                                <rect x="350" y="210" width="100" height="30" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="1" rx="3" />
                                <text x="400" y="230" text-anchor="middle" font-size="12">編集・削除</text>
                                
                                <line x1="300" y1="70" x2="125" y2="120" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                <line x1="300" y1="70" x2="300" y2="120" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                <line x1="300" y1="70" x2="475" y2="120" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                
                                <line x1="300" y1="160" x2="200" y2="210" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                <line x1="300" y1="160" x2="300" y2="210" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                <line x1="300" y1="160" x2="400" y2="210" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                
                                <defs>
                                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                        <path d="M0,0 L0,6 L9,3 z" fill="#000" />
                                    </marker>
                                </defs>
                            </svg>
                            <p class="text-center">図9.1: Todoアプリケーションの機能構成</p>
                        </div>

                        <div class="note">
                            <h5>技術スタック</h5>
                            <ul>
                                <li><strong>JDK21</strong>: 最新のJava開発キット</li>
                                <li><strong>Spring Boot</strong>: Spring Frameworkを簡単に使用するためのツール</li>
                                <li><strong>Spring MVC</strong>: WebアプリケーションのMVCパターン実装</li>
                                <li><strong>Spring Data JDBC</strong>: JDBCを使ったデータアクセス</li>
                                <li><strong>Spring Security</strong>: 認証と認可の機能</li>
                                <li><strong>Thymeleaf</strong>: サーバーサイドJavaテンプレートエンジン</li>
                                <li><strong>PostgreSQL</strong>: リレーショナルデータベース</li>
                                <li><strong>Bootstrap</strong>: レスポンシブUIフレームワーク</li>
                            </ul>
                        </div>
                    </section>

                    <section id="project-setup">
                        <h3 class="section-title">9.2 プロジェクトセットアップ</h3>
                        <p>まず、Spring Boot Initializrを使用して、プロジェクトの基本構造を作成します。</p>

                        <h4>9.2.1 Spring Bootプロジェクトの作成</h4>
                        <p><a href="https://start.spring.io/" target="_blank">Spring Initializr</a> にアクセスして、以下の設定でプロジェクトを作成します：</p>

                        <div class="table-responsive">
                            <table class="table-example">
                                <tr>
                                    <th>項目</th>
                                    <th>選択値</th>
                                </tr>
                                <tr>
                                    <td>Project</td>
                                    <td>Maven</td>
                                </tr>
                                <tr>
                                    <td>Language</td>
                                    <td>Java</td>
                                </tr>
                                <tr>
                                    <td>Spring Boot</td>
                                    <td>3.2.x</td>
                                </tr>
                                <tr>
                                    <td>Project Metadata</td>
                                    <td>
                                        Group: com.example<br>
                                        Artifact: todo-app<br>
                                        Name: todo-app<br>
                                        Package name: com.example.todo<br>
                                        Packaging: Jar<br>
                                        Java: 21
                                    </td>
                                </tr>
                                <tr>
                                    <td>Dependencies</td>
                                    <td>
                                        Spring Web<br>
                                        Spring Data JDBC<br>
                                        PostgreSQL Driver<br>
                                        Spring Security<br>
                                        Thymeleaf<br>
                                        Validation
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <p>「GENERATE」ボタンをクリックして、プロジェクトをダウンロードし、任意のIDEでプロジェクトを開きます。</p>

                        <h4>9.2.2 データベース設定</h4>
                        <p><code>application.properties</code>ファイルを以下のように設定します：</p>

                        <code># データベース接続設定
spring.datasource.url=jdbc:postgresql://localhost:5432/todo_db
spring.datasource.username=postgres
spring.datasource.password=postgres
spring.datasource.driver-class-name=org.postgresql.Driver

# SQLの自動実行
spring.sql.init.mode=always
spring.sql.init.schema-locations=classpath:schema.sql
spring.sql.init.data-locations=classpath:data.sql

# Thymeleafの設定
spring.thymeleaf.cache=false

# ログレベル設定
logging.level.org.springframework.jdbc.core=TRACE

# セッション設定
server.servlet.session.timeout=30m</code>

                        <h4>9.2.3 データベーススキーマの作成</h4>
                        <p><code>src/main/resources/schema.sql</code>を作成し、以下のSQLを追加します：</p>

                        <code>CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,
    enabled BOOLEAN NOT NULL DEFAULT TRUE
);

CREATE TABLE IF NOT EXISTS authorities (
    username VARCHAR(50) NOT NULL,
    authority VARCHAR(50) NOT NULL,
    CONSTRAINT fk_authorities_users FOREIGN KEY(username) REFERENCES users(username)
);

CREATE UNIQUE INDEX IF NOT EXISTS ix_auth_username ON authorities (username, authority);

CREATE TABLE IF NOT EXISTS todos (
    id SERIAL PRIMARY KEY,
    title VARCHAR(100) NOT NULL,
    description TEXT,
    due_date DATE,
    priority INT NOT NULL DEFAULT 0,
    completed BOOLEAN NOT NULL DEFAULT FALSE,
    username VARCHAR(50) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP,
    CONSTRAINT fk_todos_users FOREIGN KEY(username) REFERENCES users(username)
);</code>

                        <h4>9.2.4 初期データの追加</h4>
                        <p><code>src/main/resources/data.sql</code>を作成し、以下のSQLを追加します：</p>

                        <code>-- パスワードは「password」をBCryptでエンコードしたもの
INSERT INTO users (username, password, enabled) 
VALUES ('user1', '$2a$10$rGrv1sC9E2mmCZxmT6vJC.Qf26CkGZA/jUmFnS1k9KgWg4vQM.E26', true)
ON CONFLICT (username) DO NOTHING;

INSERT INTO authorities (username, authority) 
VALUES ('user1', 'ROLE_USER')
ON CONFLICT DO NOTHING;

-- サンプルTodoアイテム
INSERT INTO todos (title, description, due_date, priority, completed, username)
VALUES 
('Spring Boot学習', 'Spring Boot入門ガイドを読む', CURRENT_DATE + INTERVAL '7 day', 1, false, 'user1'),
('買い物リスト作成', '週末の買い物リストを作成する', CURRENT_DATE + INTERVAL '2 day', 2, false, 'user1'),
('プロジェクト計画', '新しいプロジェクトの計画を立てる', CURRENT_DATE + INTERVAL '14 day', 0, false, 'user1')
ON CONFLICT DO NOTHING;</code>

                        <div class="note">
                            <h5>ポイント</h5>
                            <p>初期データでは、ユーザー「user1」とパスワード「password」の組み合わせを使用しています。実際のアプリケーションでは、より強力なパスワードを使用することをお勧めします。</p>
                            <p>今回はBCryptエンコーダーを使用してパスワードをハッシュ化しています。このエンコード済みパスワードは、Spring Securityで認証時に使用されます。</p>
                        </div>
                    </section>

                    <section id="data-model">
                        <h3 class="section-title">9.3 データモデルの作成</h3>
                        <p>アプリケーションで使用するエンティティクラスとDTOを作成します。</p>

                        <h4>9.3.1 Todoエンティティ</h4>
                        <p><code>src/main/java/com/example/todo/model/Todo.java</code>を作成します：</p>

                        <code>package com.example.todo.model;

import java.time.LocalDate;
import java.time.LocalDateTime;

import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Transient;
import org.springframework.data.domain.Persistable;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

@Table("todos")
public class Todo implements Persistable&lt;Long&gt; {
    
    @Id
    private Long id;
    
    private String title;
    
    private String description;
    
    @Column("due_date")
    private LocalDate dueDate;
    
    private int priority;
    
    private boolean completed;
    
    private String username;
    
    @Column("created_at")
    private LocalDateTime createdAt;
    
    @Column("updated_at")
    private LocalDateTime updatedAt;
    
    @Transient
    private boolean isNew = false;
    
    // コンストラクタ
    public Todo() {
    }
    
    public Todo(String title, String description, LocalDate dueDate, 
                int priority, boolean completed, String username) {
        this.title = title;
        this.description = description;
        this.dueDate = dueDate;
        this.priority = priority;
        this.completed = completed;
        this.username = username;
        this.createdAt = LocalDateTime.now();
    }
    
    // Persistableインターフェースの実装メソッド
    @Override
    public Long getId() {
        return id;
    }
    
    @Override
    public boolean isNew() {
        return isNew;
    }
    
    public void setAsNew() {
        this.isNew = true;
    }
    
    // ゲッター・セッター
    public void setId(Long id) {
        this.id = id;
    }
    
    public String getTitle() {
        return title;
    }
    
    public void setTitle(String title) {
        this.title = title;
    }
    
    public String getDescription() {
        return description;
    }
    
    public void setDescription(String description) {
        this.description = description;
    }
    
    public LocalDate getDueDate() {
        return dueDate;
    }
    
    public void setDueDate(LocalDate dueDate) {
        this.dueDate = dueDate;
    }
    
    public int getPriority() {
        return priority;
    }
    
    public void setPriority(int priority) {
        this.priority = priority;
    }
    
    public boolean isCompleted() {
        return completed;
    }
    
    public void setCompleted(boolean completed) {
        this.completed = completed;
    }
    
    public String getUsername() {
        return username;
    }
    
    public void setUsername(String username) {
        this.username = username;
    }
    
    public LocalDateTime getCreatedAt() {
        return createdAt;
    }
    
    public void setCreatedAt(LocalDateTime createdAt) {
        this.createdAt = createdAt;
    }
    
    public LocalDateTime getUpdatedAt() {
        return updatedAt;
    }
    
    public void setUpdatedAt(LocalDateTime updatedAt) {
        this.updatedAt = updatedAt;
    }
}</code>

                        <h4>9.3.2 TodoFormクラス</h4>
                        <p>Todoの作成・編集に使用するフォームクラスを作成します：</p>
                        <p><code>src/main/java/com/example/todo/form/TodoForm.java</code>を作成します：</p>

                        <code>package com.example.todo.form;

import java.time.LocalDate;

import jakarta.validation.constraints.FutureOrPresent;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;

import org.springframework.format.annotation.DateTimeFormat;

public class TodoForm {
    
    private Long id;
    
    @NotBlank(message = "タイトルは必須です")
    @Size(max = 100, message = "タイトルは100文字以内で入力してください")
    private String title;
    
    @Size(max = 500, message = "説明は500文字以内で入力してください")
    private String description;
    
    @FutureOrPresent(message = "期日は今日以降の日付を入力してください")
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    private LocalDate dueDate;
    
    private int priority;
    
    private boolean completed;
    
    // ゲッター・セッター
    public Long getId() {
        return id;
    }
    
    public void setId(Long id) {
        this.id = id;
    }
    
    public String getTitle() {
        return title;
    }
    
    public void setTitle(String title) {
        this.title = title;
    }
    
    public String getDescription() {
        return description;
    }
    
    public void setDescription(String description) {
        this.description = description;
    }
    
    public LocalDate getDueDate() {
        return dueDate;
    }
    
    public void setDueDate(LocalDate dueDate) {
        this.dueDate = dueDate;
    }
    
    public int getPriority() {
        return priority;
    }
    
    public void setPriority(int priority) {
        this.priority = priority;
    }
    
    public boolean isCompleted() {
        return completed;
    }
    
    public void setCompleted(boolean completed) {
        this.completed = completed;
    }
}</code>

                        <div class="note">
                            <h5>ポイント</h5>
                            <ul>
                                <li><strong>バリデーション</strong>: TodoFormクラスにはJakarta Bean Validationアノテーションを使用して入力値の検証ルールを定義しています</li>
                                <li><strong>@DateTimeFormat</strong>: 日付の入力形式を指定しています</li>
                                <li><strong>@Persistable</strong>: Spring Data JDBCでエンティティの新規性を判断するために使用するインターフェース</li>
                                <li><strong>@Table / @Column</strong>: データベーステーブルやカラムとのマッピングを定義</li>
                            </ul>
                        </div>
                    </section>

                    <section id="repository-layer">
                        <h3 class="section-title">9.4 リポジトリ層の実装</h3>
                        <p>Spring Data JDBCを使用して、データアクセス層を実装します。</p>

                        <h4>9.4.1 Todoリポジトリ</h4>
                        <p><code>src/main/java/com/example/todo/repository/TodoRepository.java</code>を作成します：</p>

                        <code>package com.example.todo.repository;

import java.util.List;

import org.springframework.data.jdbc.repository.query.Query;
import org.springframework.data.repository.CrudRepository;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.example.todo.model.Todo;

@Repository
public interface TodoRepository extends CrudRepository&lt;Todo, Long&gt; {
    
    // ユーザー名で検索
    List&lt;Todo&gt; findByUsername(String username);
    
    // 完了していないタスクをユーザー名で検索
    List&lt;Todo&gt; findByUsernameAndCompletedFalseOrderByDueDateAsc(String username);
    
    // 優先度順に検索
    @Query("SELECT * FROM todos WHERE username = :username ORDER BY priority DESC, due_date ASC")
    List&lt;Todo&gt; findByUsernameSortByPriority(@Param("username") String username);
    
    // タイトルで部分一致検索
    @Query("SELECT * FROM todos WHERE username = :username AND title ILIKE '%' || :keyword || '%' ORDER BY due_date ASC")
    List&lt;Todo&gt; searchByTitle(@Param("username") String username, @Param("keyword") String keyword);
}</code>

                        <div class="note">
                            <h5>Spring Data JDBCの特徴</h5>
                            <ul>
                                <li><strong>CrudRepository&lt;T, ID&gt;</strong>: 基本的なCRUD操作（Create, Read, Update, Delete）を提供するインターフェース</li>
                                <li><strong>メソッド名による自動クエリ生成</strong>: findByUsername, findByUsernameAndCompletedFalseOrderByDueDateAscなど</li>
                                <li><strong>@Query</strong>: カスタムSQLクエリを定義するアノテーション</li>
                                <li><strong>@Param</strong>: SQLクエリ内のパラメータをバインドするアノテーション</li>
                            </ul>
                        </div>
                    </section>

                    <section id="service-layer">
                        <h3 class="section-title">9.5 サービス層の実装</h3>
                        <p>ビジネスロジックを実装するサービス層を作成します。</p>

                        <h4>9.5.1 Todoサービス</h4>
                        <p><code>src/main/java/com/example/todo/service/TodoService.java</code>を作成します：</p>

                        <code>package com.example.todo.service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.todo.form.TodoForm;
import com.example.todo.model.Todo;
import com.example.todo.repository.TodoRepository;

@Service
public class TodoService {
    
    private final TodoRepository todoRepository;
    
    @Autowired
    public TodoService(TodoRepository todoRepository) {
        this.todoRepository = todoRepository;
    }
    
    // ユーザーのTodo一覧を取得
    public List&lt;Todo&gt; getAllTodosByUsername(String username) {
        return todoRepository.findByUsername(username);
    }
    
    // 完了していないTodoをユーザー名で検索
    public List&lt;Todo&gt; getActiveTodos(String username) {
        return todoRepository.findByUsernameAndCompletedFalseOrderByDueDateAsc(username);
    }
    
    // 優先度順に取得
    public List&lt;Todo&gt; getTodosByPriority(String username) {
        return todoRepository.findByUsernameSortByPriority(username);
    }
    
    // キーワードで検索
    public List&lt;Todo&gt; searchTodos(String username, String keyword) {
        return todoRepository.searchByTitle(username, keyword);
    }
    
    // IDでTodoを取得
    public Optional&lt;Todo&gt; getTodoById(Long id) {
        return todoRepository.findById(id);
    }
    
    // Todoを新規作成
    @Transactional
    public Todo createTodo(TodoForm form, String username) {
        Todo todo = new Todo();
        todo.setTitle(form.getTitle());
        todo.setDescription(form.getDescription());
        todo.setDueDate(form.getDueDate());
        todo.setPriority(form.getPriority());
        todo.setCompleted(form.isCompleted());
        todo.setUsername(username);
        todo.setCreatedAt(LocalDateTime.now());
        todo.setAsNew(); // 新規作成フラグを設定
        
        return todoRepository.save(todo);
    }
    
    // Todoを更新
    @Transactional
    public Todo updateTodo(Long id, TodoForm form, String username) {
        Optional&lt;Todo&gt; optionalTodo = todoRepository.findById(id);
        
        if (optionalTodo.isPresent()) {
            Todo todo = optionalTodo.get();
            
            // ユーザー所有権の確認
            if (!todo.getUsername().equals(username)) {
                throw new IllegalStateException("このTodoアイテムを編集する権限がありません");
            }
            
            todo.setTitle(form.getTitle());
            todo.setDescription(form.getDescription());
            todo.setDueDate(form.getDueDate());
            todo.setPriority(form.getPriority());
            todo.setCompleted(form.isCompleted());
            todo.setUpdatedAt(LocalDateTime.now());
            
            return todoRepository.save(todo);
        } else {
            throw new IllegalArgumentException("指定されたIDのTodoアイテムが見つかりません: " + id);
        }
    }
    
    // 完了状態を切り替え
    @Transactional
    public Todo toggleCompleted(Long id, String username) {
        Optional&lt;Todo&gt; optionalTodo = todoRepository.findById(id);
        
        if (optionalTodo.isPresent()) {
            Todo todo = optionalTodo.get();
            
            // ユーザー所有権の確認
            if (!todo.getUsername().equals(username)) {
                throw new IllegalStateException("このTodoアイテムを編集する権限がありません");
            }
            
            todo.setCompleted(!todo.isCompleted());
            todo.setUpdatedAt(LocalDateTime.now());
            
            return todoRepository.save(todo);
        } else {
            throw new IllegalArgumentException("指定されたIDのTodoアイテムが見つかりません: " + id);
        }
    }
    
    // Todoを削除
    @Transactional
    public void deleteTodo(Long id, String username) {
        Optional&lt;Todo&gt; optionalTodo = todoRepository.findById(id);
        
        if (optionalTodo.isPresent()) {
            Todo todo = optionalTodo.get();
            
            // ユーザー所有権の確認
            if (!todo.getUsername().equals(username)) {
                throw new IllegalStateException("このTodoアイテムを削除する権限がありません");
            }
            
            todoRepository.deleteById(id);
        } else {
            throw new IllegalArgumentException("指定されたIDのTodoアイテムが見つかりません: " + id);
        }
    }
}</code>

                        <div class="note">
                            <h5>ポイント</h5>
                            <ul>
                                <li><strong>@Service</strong>: サービスクラスであることを示すアノテーション</li>
                                <li><strong>@Transactional</strong>: データの整合性を保つためのトランザクション管理</li>
                                <li><strong>ユーザー所有権の確認</strong>: 他のユーザーのTodoを編集/削除できないようセキュリティチェックを実装</li>
                                <li><strong>Optional&lt;T&gt;</strong>: Javaの機能でnullを安全に扱うための型</li>
                            </ul>
                        </div>
                    </section>

                    <section id="controller-layer">
                        <h3 class="section-title">9.6 コントローラ層の実装</h3>
                        <p>Spring MVCを使用して、HTTP要求を処理するコントローラを実装します。</p>

                        <h4>9.6.1 Todoコントローラ</h4>
                        <p><code>src/main/java/com/example/todo/controller/TodoController.java</code>を作成します：</p>

                        <code>package com.example.todo.controller;

import java.security.Principal;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.example.todo.form.TodoForm;
import com.example.todo.model.Todo;
import com.example.todo.service.TodoService;

import jakarta.validation.Valid;

@Controller
@RequestMapping("/todos")
public class TodoController {
    
    private final TodoService todoService;
    
    @Autowired
    public TodoController(TodoService todoService) {
        this.todoService = todoService;
    }
    
    // Todo一覧表示
    @GetMapping
    public String listTodos(Model model, Principal principal,
                           @RequestParam(required = false) String sort,
                           @RequestParam(required = false) String search) {
        String username = principal.getName();
        List&lt;Todo&gt; todos;
        
        if (search != null && !search.isEmpty()) {
            todos = todoService.searchTodos(username, search);
            model.addAttribute("search", search);
        } else if ("priority".equals(sort)) {
            todos = todoService.getTodosByPriority(username);
            model.addAttribute("sort", "priority");
        } else if ("active".equals(sort)) {
            todos = todoService.getActiveTodos(username);
            model.addAttribute("sort", "active");
        } else {
            todos = todoService.getAllTodosByUsername(username);
        }
        
        model.addAttribute("todos", todos);
        return "todos/list";
    }
    
    // Todo新規作成フォーム表示
    @GetMapping("/new")
    public String newTodoForm(Model model) {
        model.addAttribute("todoForm", new TodoForm());
        return "todos/form";
    }
    
    // Todo新規作成処理
    @PostMapping
    public String createTodo(@Valid @ModelAttribute("todoForm") TodoForm todoForm,
                            BindingResult result,
                            Principal principal,
                            RedirectAttributes redirectAttributes) {
        if (result.hasErrors()) {
            return "todos/form";
        }
        
        String username = principal.getName();
        todoService.createTodo(todoForm, username);
        
        redirectAttributes.addFlashAttribute("success", "Todoが正常に作成されました");
        return "redirect:/todos";
    }
    
    // Todo編集フォーム表示
    @GetMapping("/{id}/edit")
    public String editTodoForm(@PathVariable Long id, Model model, Principal principal) {
        String username = principal.getName();
        Optional&lt;Todo&gt; optionalTodo = todoService.getTodoById(id);
        
        if (optionalTodo.isPresent()) {
            Todo todo = optionalTodo.get();
            
            // ユーザー所有権の確認
            if (!todo.getUsername().equals(username)) {
                return "redirect:/todos?error=unauthorized";
            }
            
            TodoForm todoForm = new TodoForm();
            todoForm.setId(todo.getId());
            todoForm.setTitle(todo.getTitle());
            todoForm.setDescription(todo.getDescription());
            todoForm.setDueDate(todo.getDueDate());
            todoForm.setPriority(todo.getPriority());
            todoForm.setCompleted(todo.isCompleted());
            
            model.addAttribute("todoForm", todoForm);
            return "todos/form";
        } else {
            return "redirect:/todos?error=notfound";
        }
    }
    
    // Todo更新処理
    @PostMapping("/{id}")
    public String updateTodo(@PathVariable Long id,
                            @Valid @ModelAttribute("todoForm") TodoForm todoForm,
                            BindingResult result,
                            Principal principal,
                            RedirectAttributes redirectAttributes) {
        if (result.hasErrors()) {
            return "todos/form";
        }
        
        String username = principal.getName();
        try {
            todoService.updateTodo(id, todoForm, username);
            redirectAttributes.addFlashAttribute("success", "Todoが正常に更新されました");
        } catch (IllegalStateException e) {
            redirectAttributes.addFlashAttribute("error", e.getMessage());
        } catch (IllegalArgumentException e) {
            redirectAttributes.addFlashAttribute("error", e.getMessage());
        }
        
        return "redirect:/todos";
    }
    
    // Todo削除処理
    @PostMapping("/{id}/delete")
    public String deleteTodo(@PathVariable Long id,
                            Principal principal,
                            RedirectAttributes redirectAttributes) {
        String username = principal.getName();
        try {
            todoService.deleteTodo(id, username);
            redirectAttributes.addFlashAttribute("success", "Todoが正常に削除されました");
        } catch (IllegalStateException | IllegalArgumentException e) {
            redirectAttributes.addFlashAttribute("error", e.getMessage());
        }
        
        return "redirect:/todos";
    }
    
    // Todo完了状態トグル処理
    @PostMapping("/{id}/toggle")
    public String toggleTodoCompleted(@PathVariable Long id,
                                    Principal principal,
                                    RedirectAttributes redirectAttributes) {
        String username = principal.getName();
        try {
            Todo todo = todoService.toggleCompleted(id, username);
            String status = todo.isCompleted() ? "完了" : "未完了";
            redirectAttributes.addFlashAttribute("success", "Todoが" + status + "に変更されました");
        } catch (IllegalStateException | IllegalArgumentException e) {
            redirectAttributes.addFlashAttribute("error", e.getMessage());
        }
        
        return "redirect:/todos";
    }
}</code>

                        <h4>9.6.2 ホームコントローラ</h4>
                        <p><code>src/main/java/com/example/todo/controller/HomeController.java</code>を作成します：</p>

                        <code>package com.example.todo.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class HomeController {
    
    @GetMapping("/")
    public String home() {
        return "redirect:/todos";
    }
    
    @GetMapping("/login")
    public String login() {
        return "login";
    }
}</code>

                        <div class="note">
                            <h5>ポイント</h5>
                            <ul>
                                <li><strong>@Controller</strong>: コントローラクラスであることを示すアノテーション</li>
                                <li><strong>@RequestMapping</strong>: コントローラのベースURLを定義</li>
                                <li><strong>@GetMapping / @PostMapping</strong>: HTTP GETとPOSTリクエストを処理するメソッドアノテーション</li>
                                <li><strong>Principal</strong>: 認証済みユーザー情報へのアクセス</li>
                                <li><strong>@Valid</strong>: 入力値のバリデーション実行</li>
                                <li><strong>RedirectAttributes</strong>: リダイレクト先へデータを渡すためのオブジェクト</li>
                            </ul>
                        </div>
                    </section>

                    <section id="view-layer">
                        <h3 class="section-title">9.7 ビュー層の作成</h3>
                        <p>Thymeleafテンプレートエンジンを使用してビューを作成します。</p>

                        <h4>9.7.1 レイアウトテンプレート</h4>
                        <p><code>src/main/resources/templates/layout/default.html</code>を作成します：</p>

                        <code>&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"&gt;
&lt;head th:fragment="head(title)"&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title th:text="${title} + ' - Todo管理アプリ'"&gt;Todo管理アプリ&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
    &lt;link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&amp;display=swap" rel="stylesheet"&gt;
    &lt;style&gt;
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
        }
        .navbar {
            background-color: #28a745;
        }
        .footer {
            background-color: #28a745;
            color: white;
            text-align: center;
            padding: 1rem 0;
            margin-top: 2rem;
        }
        .todo-card {
            margin-bottom: 1rem;
        }
        .priority-high {
            border-left: 5px solid #dc3545;
        }
        .priority-medium {
            border-left: 5px solid #ffc107;
        }
        .priority-low {
            border-left: 5px solid #28a745;
        }
        .completed {
            background-color: #f8f9fa;
            opacity: 0.7;
        }
        .todo-date {
            font-size: 0.8rem;
            color: #6c757d;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;header th:fragment="header"&gt;
        &lt;nav class="navbar navbar-expand-lg navbar-dark fixed-top"&gt;
            &lt;div class="container"&gt;
                &lt;a class="navbar-brand" href="/"&gt;Todo管理アプリ&lt;/a&gt;
                &lt;button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"&gt;
                    &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;
                &lt;/button&gt;
                &lt;div class="collapse navbar-collapse" id="navbarNav"&gt;
                    &lt;ul class="navbar-nav me-auto"&gt;
                        &lt;li class="nav-item" sec:authorize="isAuthenticated()"&gt;
                            &lt;a class="nav-link" th:href="@{/todos}"&gt;Todo一覧&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="nav-item" sec:authorize="isAuthenticated()"&gt;
                            &lt;a class="nav-link" th:href="@{/todos/new}"&gt;新規作成&lt;/a&gt;
                        &lt;/li&gt;
                    &lt;/ul&gt;
                    &lt;ul class="navbar-nav"&gt;
                        &lt;li class="nav-item" sec:authorize="isAuthenticated()"&gt;
                            &lt;span class="nav-link"&gt;ようこそ &lt;span sec:authentication="name"&gt;ユーザー&lt;/span&gt; さん&lt;/span&gt;
                        &lt;/li&gt;
                        &lt;li class="nav-item" sec:authorize="isAuthenticated()"&gt;
                            &lt;form th:action="@{/logout}" method="post" class="d-inline"&gt;
                                &lt;button type="submit" class="btn btn-link nav-link"&gt;ログアウト&lt;/button&gt;
                            &lt;/form&gt;
                        &lt;/li&gt;
                        &lt;li class="nav-item" sec:authorize="!isAuthenticated()"&gt;
                            &lt;a class="nav-link" th:href="@{/login}"&gt;ログイン&lt;/a&gt;
                        &lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/nav&gt;
    &lt;/header&gt;
    
    &lt;div class="container my-4"&gt;
        &lt;div th:fragment="alerts"&gt;
            &lt;div th:if="${success}" class="alert alert-success alert-dismissible fade show"&gt;
                &lt;span th:text="${success}"&gt;操作が成功しました&lt;/span&gt;
                &lt;button type="button" class="btn-close" data-bs-dismiss="alert"&gt;&lt;/button&gt;
            &lt;/div&gt;
            &lt;div th:if="${error}" class="alert alert-danger alert-dismissible fade show"&gt;
                &lt;span th:text="${error}"&gt;エラーが発生しました&lt;/span&gt;
                &lt;button type="button" class="btn-close" data-bs-dismiss="alert"&gt;&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;main&gt;
            &lt;div th:replace="${content}"&gt;メインコンテンツがここに表示されます&lt;/div&gt;
        &lt;/main&gt;
    &lt;/div&gt;
    
    &lt;footer th:fragment="footer" class="footer"&gt;
        &lt;div class="container"&gt;
            &lt;p class="mb-0"&gt;Copyright © 2025 F-Circle All rights reserved.&lt;/p&gt;
        &lt;/div&gt;
    &lt;/footer&gt;
    
    &lt;script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code>

                        <h4>9.7.2 ログインページ</h4>
                        <p><code>src/main/resources/templates/login.html</code>を作成します：</p>

                        <code>&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head th:replace="~{layout/default :: head('ログイン')}"&gt;&lt;/head&gt;
&lt;body&gt;
    &lt;header th:replace="~{layout/default :: header}"&gt;&lt;/header&gt;
    
    &lt;div class="container my-4"&gt;
        &lt;div th:replace="~{layout/default :: alerts}"&gt;&lt;/div&gt;
        
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-6"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-success text-white"&gt;
                        &lt;h5 class="mb-0"&gt;ログイン&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;div th:if="${param.error}" class="alert alert-danger"&gt;
                            ユーザー名またはパスワードが正しくありません。
                        &lt;/div&gt;
                        &lt;div th:if="${param.logout}" class="alert alert-success"&gt;
                            ログアウトしました。
                        &lt;/div&gt;
                        
                        &lt;form th:action="@{/login}" method="post"&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="username" class="form-label"&gt;ユーザー名&lt;/label&gt;
                                &lt;input type="text" id="username" name="username" class="form-control" required autofocus&gt;
                            &lt;/div&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="password" class="form-label"&gt;パスワード&lt;/label&gt;
                                &lt;input type="password" id="password" name="password" class="form-control" required&gt;
                            &lt;/div&gt;
                            &lt;div class="d-grid gap-2"&gt;
                                &lt;button type="submit" class="btn btn-success"&gt;ログイン&lt;/button&gt;
                            &lt;/div&gt;
                        &lt;/form&gt;
                        
                        &lt;div class="mt-3 text-center"&gt;
                            &lt;p class="text-muted"&gt;デモアカウント: user1 / password&lt;/p&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;footer th:replace="~{layout/default :: footer}"&gt;&lt;/footer&gt;
&lt;/body&gt;
&lt;/html&gt;</code>

                        <h4>9.7.3 Todo一覧ページ</h4>
                        <p><code>src/main/resources/templates/todos/list.html</code>を作成します：</p>

                        <code>&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head th:replace="~{layout/default :: head('Todo一覧')}"&gt;&lt;/head&gt;
&lt;body&gt;
    &lt;header th:replace="~{layout/default :: header}"&gt;&lt;/header&gt;
    
    &lt;div class="container my-4"&gt;
        &lt;div th:replace="~{layout/default :: alerts}"&gt;&lt;/div&gt;
        
        &lt;div class="d-flex justify-content-between align-items-center mb-4"&gt;
            &lt;h2&gt;Todo一覧&lt;/h2&gt;
            &lt;a th:href="@{/todos/new}" class="btn btn-success"&gt;新規作成&lt;/a&gt;
        &lt;/div&gt;
        
        &lt;div class="row mb-4"&gt;
            &lt;div class="col-md-6"&gt;
                &lt;div class="btn-group" role="group"&gt;
                    &lt;a th:href="@{/todos}" class="btn" th:classappend="${sort == null ? 'btn-success' : 'btn-outline-success'}"&gt;すべて&lt;/a&gt;
                    &lt;a th:href="@{/todos(sort='active')}" class="btn" th:classappend="${sort == 'active' ? 'btn-success' : 'btn-outline-success'}"&gt;未完了のみ&lt;/a&gt;
                    &lt;a th:href="@{/todos(sort='priority')}" class="btn" th:classappend="${sort == 'priority' ? 'btn-success' : 'btn-outline-success'}"&gt;優先度順&lt;/a&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="col-md-6"&gt;
                &lt;form th:action="@{/todos}" method="get" class="d-flex"&gt;
                    &lt;input type="text" name="search" class="form-control me-2" th:value="${search}" placeholder="タイトルで検索..."&gt;
                    &lt;button type="submit" class="btn btn-outline-success"&gt;検索&lt;/button&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div th:if="${#lists.isEmpty(todos)}" class="alert alert-info"&gt;
            Todoアイテムがありません。
        &lt;/div&gt;
        
        &lt;div th:unless="${#lists.isEmpty(todos)}" class="row"&gt;
            &lt;div class="col-md-12"&gt;
                &lt;div th:each="todo : ${todos}" class="card todo-card" 
                     th:classappend="${todo.completed ? 'completed' : ''} + ' ' + 
                                    ${todo.priority == 2 ? 'priority-high' : 
                                     todo.priority == 1 ? 'priority-medium' : 'priority-low'}"&gt;
                    &lt;div class="card-body"&gt;
                        &lt;div class="d-flex justify-content-between align-items-start"&gt;
                            &lt;div&gt;
                                &lt;h5 class="card-title" th:text="${todo.title}"&gt;Todo Title&lt;/h5&gt;
                                &lt;p class="card-text" th:text="${todo.description}"&gt;Description&lt;/p&gt;
                                &lt;div class="todo-date"&gt;
                                    &lt;span th:if="${todo.dueDate}" th:text="'期限: ' + ${#temporals.format(todo.dueDate, 'yyyy/MM/dd')}"&gt;期限: 2025/01/01&lt;/span&gt;
                                    &lt;span th:if="${todo.dueDate == null}"&gt;期限なし&lt;/span&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                            &lt;div class="d-flex"&gt;
                                &lt;form th:action="@{/todos/{id}/toggle(id=${todo.id})}" method="post" class="me-2"&gt;
                                    &lt;button type="submit" class="btn btn-sm" th:classappend="${todo.completed ? 'btn-secondary' : 'btn-success'}"&gt;
                                        &lt;span th:text="${todo.completed ? '未完了に戻す' : '完了にする'}"&gt;完了&lt;/span&gt;
                                    &lt;/button&gt;
                                &lt;/form&gt;
                                &lt;a th:href="@{/todos/{id}/edit(id=${todo.id})}" class="btn btn-sm btn-primary me-2"&gt;編集&lt;/a&gt;
                                &lt;form th:action="@{/todos/{id}/delete(id=${todo.id})}" method="post" onsubmit="return confirm('本当に削除しますか？');"&gt;
                                    &lt;button type="submit" class="btn btn-sm btn-danger"&gt;削除&lt;/button&gt;
                                &lt;/form&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;footer th:replace="~{layout/default :: footer}"&gt;&lt;/footer&gt;
&lt;/body&gt;
&lt;/html&gt;</code>

                        <h4>9.7.4 Todoフォームページ</h4>
                        <p><code>src/main/resources/templates/todos/form.html</code>を作成します：</p>

                        <code>&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head th:replace="~{layout/default :: head(${todoForm.id == null ? '新規Todo作成' : 'Todo編集'})}"&gt;&lt;/head&gt;
&lt;body&gt;
    &lt;header th:replace="~{layout/default :: header}"&gt;&lt;/header&gt;
    
    &lt;div class="container my-4"&gt;
        &lt;div th:replace="~{layout/default :: alerts}"&gt;&lt;/div&gt;
        
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-8"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-success text-white"&gt;
                        &lt;h5 class="mb-0" th:text="${todoForm.id == null ? '新規Todo作成' : 'Todo編集'}"&gt;Todo作成/編集&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;form th:object="${todoForm}" th:action="${todoForm.id == null ? @{/todos} : @{/todos/{id}(id=${todoForm.id})}}" method="post"&gt;
                            &lt;input type="hidden" th:field="*{id}"&gt;
                            
                            &lt;div class="mb-3"&gt;
                                &lt;label for="title" class="form-label"&gt;タイトル *&lt;/label&gt;
                                &lt;input type="text" th:field="*{title}" class="form-control" th:classappend="${#fields.hasErrors('title')} ? 'is-invalid'" required&gt;
                                &lt;div class="invalid-feedback" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"&gt;タイトルエラー&lt;/div&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="mb-3"&gt;
                                &lt;label for="description" class="form-label"&gt;説明&lt;/label&gt;
                                &lt;textarea th:field="*{description}" class="form-control" th:classappend="${#fields.hasErrors('description')} ? 'is-invalid'" rows="3"&gt;&lt;/textarea&gt;
                                &lt;div class="invalid-feedback" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"&gt;説明エラー&lt;/div&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="mb-3"&gt;
                                &lt;label for="dueDate" class="form-label"&gt;期限&lt;/label&gt;
                                &lt;input type="date" th:field="*{dueDate}" class="form-control" th:classappend="${#fields.hasErrors('dueDate')} ? 'is-invalid'"&gt;
                                &lt;div class="invalid-feedback" th:if="${#fields.hasErrors('dueDate')}" th:errors="*{dueDate}"&gt;期限エラー&lt;/div&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="mb-3"&gt;
                                &lt;label for="priority" class="form-label"&gt;優先度&lt;/label&gt;
                                &lt;select th:field="*{priority}" class="form-select"&gt;
                                    &lt;option value="0"&gt;低&lt;/option&gt;
                                    &lt;option value="1"&gt;中&lt;/option&gt;
                                    &lt;option value="2"&gt;高&lt;/option&gt;
                                &lt;/select&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="mb-3 form-check" th:if="${todoForm.id != null}"&gt;
                                &lt;input type="checkbox" th:field="*{completed}" class="form-check-input"&gt;
                                &lt;label class="form-check-label" for="completed"&gt;完了&lt;/label&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="d-flex justify-content-between"&gt;
                                &lt;a th:href="@{/todos}" class="btn btn-secondary"&gt;キャンセル&lt;/a&gt;
                                &lt;button type="submit" class="btn btn-success"&gt;保存&lt;/button&gt;
                            &lt;/div&gt;
                        &lt;/form&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;footer th:replace="~{layout/default :: footer}"&gt;&lt;/footer&gt;
&lt;/body&gt;
&lt;/html&gt;</code>

                        <div class="note">
                            <h5>ポイント</h5>
                            <ul>
                                <li><strong>テンプレートレイアウト</strong>: Thymeleafの<code>th:replace</code>を使用して、共通部品（ヘッダー、フッターなど）を再利用</li>
                                <li><strong>フォームバインディング</strong>: <code>th:object</code>と<code>th:field</code>を使用して、フォームとJavaオブジェクトをバインド</li>
                                <li><strong>バリデーションメッセージ</strong>: <code>th:errors</code>を使用して、バリデーションエラーを表示</li>
                                <li><strong>条件分岐</strong>: <code>th:if</code>と<code>th:unless</code>を使用して、条件に応じたHTML表示を制御</li>
                                <li><strong>反復処理</strong>: <code>th:each</code>を使用して、コレクションを繰り返し処理</li>
                                <li><strong>セキュリティ統合</strong>: <code>sec:authorize</code>を使用して、認証状態に応じたUI表示を制御</li>
                            </ul>
                        </div>
                    </section>

                    <section id="form-validation">
                        <h3 class="section-title">9.8 フォームバリデーション</h3>
                        <p>フォームのバリデーションには、Jakarta Bean Validationを使用しています。主なバリデーションアノテーションについて説明します。</p>

                        <div class="table-responsive">
                            <table class="table-example">
                                <tr>
                                    <th>アノテーション</th>
                                    <th>説明</th>
                                    <th>使用例</th>
                                </tr>
                                <tr>
                                    <td>@NotNull</td>
                                    <td>nullを許可しない</td>
                                    <td>@NotNull(message = "値は必須です")</td>
                                </tr>
                                <tr>
                                    <td>@NotEmpty</td>
                                    <td>空のコレクション/配列/文字列を許可しない</td>
                                    <td>@NotEmpty(message = "値は必須です")</td>
                                </tr>
                                <tr>
                                    <td>@NotBlank</td>
                                    <td>空白文字のみの文字列を許可しない</td>
                                    <td>@NotBlank(message = "タイトルは必須です")</td>
                                </tr>
                                <tr>
                                    <td>@Size</td>
                                    <td>文字列長、コレクションサイズの範囲を指定</td>
                                    <td>@Size(max = 100, message = "100文字以内で入力してください")</td>
                                </tr>
                                <tr>
                                    <td>@Min / @Max</td>
                                    <td>数値の最小値/最大値を指定</td>
                                    <td>@Min(value = 0, message = "0以上の値を入力してください")</td>
                                </tr>
                                <tr>
                                    <td>@Past / @Future</td>
                                    <td>過去/未来の日付であることを検証</td>
                                    <td>@Future(message = "未来の日付を入力してください")</td>
                                </tr>
                                <tr>
                                    <td>@PastOrPresent / @FutureOrPresent</td>
                                    <td>過去または現在 / 未来または現在の日付であることを検証</td>
                                    <td>@FutureOrPresent(message = "今日以降の日付を入力してください")</td>
                                </tr>
                                <tr>
                                    <td>@Pattern</td>
                                    <td>正規表現パターンによる文字列検証</td>
                                    <td>@Pattern(regexp = "^[A-Za-z0-9]+$", message = "英数字のみ入力可能です")</td>
                                </tr>
                                <tr>
                                    <td>@Email</td>
                                    <td>メールアドレス形式を検証</td>
                                    <td>@Email(message = "有効なメールアドレスを入力してください")</td>
                                </tr>
                            </table>
                        </div>

                        <p>バリデーションを適用するためのステップ：</p>
                        <ol>
                            <li>フォームクラスに適切なバリデーションアノテーションを付与</li>
                            <li>コントローラのメソッドパラメータに<code>@Valid</code>アノテーションを付与</li>
                            <li><code>BindingResult</code>パラメータを追加して、バリデーション結果を取得</li>
                            <li>バリデーションエラーがある場合は、エラーメッセージを表示しフォームを再表示</li>
                        </ol>

                        <div class="example-result">
                            <h5>バリデーションの流れ：</h5>
                            <ol>
                                <li>ユーザーがフォームを送信</li>
                                <li>Spring MVCがフォームデータをTodoFormオブジェクトにバインド</li>
                                <li>Jakartaバリデーションがアノテーションに基づいてバリデーションを実行</li>
                                <li>バリデーションの結果がBindingResultオブジェクトに格納</li>
                                <li>コントローラが<code>result.hasErrors()</code>でエラーの有無を確認</li>
                                <li>エラーがある場合はフォームページを再表示し、エラーメッセージを表示</li>
                                <li>エラーがない場合は処理を続行</li>
                            </ol>
                        </div>
                    </section>

                    <section id="login-implementation">
                        <h3 class="section-title">9.9 ログイン機能の実装</h3>
                        <p>Spring Securityを使用して、ログイン機能を実装します。</p>

                        <h4>9.9.1 SecurityConfig</h4>
                        <p><code>src/main/java/com/example/todo/config/SecurityConfig.java</code>を作成します：</p>

                        <code>package com.example.todo.config;

import javax.sql.DataSource;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.JdbcUserDetailsManager;
import org.springframework.security.provisioning.UserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -> authorize
                .requestMatchers("/css/**", "/js/**", "/images/**").permitAll()
                .requestMatchers("/login", "/signup").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(formLogin -> formLogin
                .loginPage("/login")
                .defaultSuccessUrl("/todos", true)
                .permitAll()
            )
            .logout(logout -> logout
                .logoutSuccessUrl("/login?logout")
                .permitAll()
            );
        
        return http.build();
    }
    
    @Bean
    public UserDetailsManager users(DataSource dataSource) {
        JdbcUserDetailsManager users = new JdbcUserDetailsManager(dataSource);
        users.setUsersByUsernameQuery(
            "select username, password, enabled from users where username = ?");
        users.setAuthoritiesByUsernameQuery(
            "select username, authority from authorities where username = ?");
        return users;
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}</code>

                        <div class="diagram">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 300" width="600" height="300">
                                <!-- ユーザー -->
                                <circle cx="100" cy="150" r="35" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="2" />
                                <text x="100" y="155" text-anchor="middle" font-size="14">ユーザー</text>
                                
                                <!-- Spring Security Filter Chain -->
                                <rect x="200" y="100" width="200" height="100" fill="#ffecb3" stroke="#ffa000" stroke-width="2" rx="5" />
                                <text x="300" y="130" text-anchor="middle" font-size="14">Spring Security</text>
                                <text x="300" y="150" text-anchor="middle" font-size="12">認証フィルター</text>
                                <text x="300" y="170" text-anchor="middle" font-size="12">認可フィルター</text>
                                
                                <!-- コントローラ -->
                                <rect x="450" y="50" width="120" height="50" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="5" />
                                <text x="510" y="80" text-anchor="middle" font-size="14">コントローラ</text>
                                
                                <!-- データベース -->
                                <rect x="450" y="200" width="120" height="50" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="5" />
                                <text x="510" y="230" text-anchor="middle" font-size="14">データベース</text>
                                
                                <!-- 矢印 -->
                                <line x1="135" y1="150" x2="190" y2="150" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                <text x="160" y="140" text-anchor="middle" font-size="12">リクエスト</text>
                                
                                <line x1="400" y1="120" x2="440" y2="80" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                <text x="435" y="90" text-anchor="middle" font-size="12">許可</text>
                                
                                <line x1="300" y1="200" x2="300" y2="250" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                <line x1="300" y1="250" x2="440" y2="250" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                <text x="370" y="240" text-anchor="middle" font-size="12">認証情報確認</text>
                                
                                <line x1="400" y1="180" x2="440" y2="210" stroke="#000" stroke-width="1.5" marker-end="url(#arrow)" />
                                
                                <defs>
                                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                        <path d="M0,0 L0,6 L9,3 z" fill="#000" />
                                    </marker>
                                </defs>
                            </svg>
                            <p class="text-center">図9.2: Spring Securityによる認証・認可フロー</p>
                        </div>

                        <div class="note">
                            <h5>Spring Securityの主要コンポーネント</h5>
                            <ul>
                                <li><strong>SecurityFilterChain</strong>: HTTPリクエストに対するセキュリティフィルタの設定</li>
                                <li><strong>UserDetailsManager</strong>: ユーザー情報の取得と管理</li>
                                <li><strong>PasswordEncoder</strong>: パスワードのハッシュ化と検証</li>
                                <li><strong>認証処理</strong>: ユーザーのIDとパスワードの検証</li>
                                <li><strong>認可処理</strong>: ユーザーがリソースにアクセスする権限があるかの確認</li>
                            </ul>
                        </div>
                    </section>

                </section>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-4">
        <div class="container">
            <p class="mb-0">Copyright © 2025 F-Circle All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>