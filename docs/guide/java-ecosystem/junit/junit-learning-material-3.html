<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JUnit学習教材 第3章 - アサーションとマッチャー</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        /* プリフォーマット */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">JUnit学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../README.md">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.md">JUnitガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="junit-learning-material-1.html">第1章: JUnit基礎とセットアップ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="junit-learning-material-2.html">第2章: 基本的なテストケース</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter3">第3章: アサーションとマッチャー</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="junit-learning-material-4.html">第4章: テストライフサイクル</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="junit-learning-material-5.html">第5章: パラメータ化テスト</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="junit-learning-material-6.html">第6章: 例外テストとタイムアウト</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="junit-learning-material-7.html">第7章: テストの組織化</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第3章: アサーションとマッチャー</h1>
                </div>

                <div id="chapter3">
                    <h2 class="chapter-title">高度なアサーション技法とAssertJライブラリ</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>JUnit 5の高度なアサーションメソッドの使用法</li>
                            <li>コレクションや配列のアサーション</li>
                            <li>カスタムエラーメッセージの作成</li>
                            <li>AssertJライブラリの導入と使用方法</li>
                            <li>流暢なアサーション記法（Fluent Assertions）</li>
                            <li>カスタムマッチャーの作成</li>
                        </ul>
                    </div>

                    <h3 class="section-title">3.1 JUnit 5の高度なアサーション</h3>
                    <p>基本的なアサーションに加えて、JUnit 5では複雑な検証のための高度なアサーションメソッドを提供しています。</p>
                    
                    <h4>配列とコレクションのアサーション</h4>
                    <ul>
                        <li><strong>assertArrayEquals()</strong>: 配列の内容比較</li>
                        <li><strong>assertIterableEquals()</strong>: Iterableの内容比較</li>
                        <li><strong>assertLinesMatch()</strong>: 文字列リストの比較</li>
                    </ul>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 3-1: 配列とコレクションのアサーション</h5>
                        <p>配列やリストを扱うメソッドのテストで、適切なアサーションを使用します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>ArrayUtilsクラスを作成</li>
                            <li>配列操作メソッドを実装</li>
                            <li>適切なアサーションメソッドでテスト</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>ArrayUtils.java</strong></p>
                        <pre><code>import java.util.*;

public class ArrayUtils {
    
    public static int[] sortArray(int[] array) {
        if (array == null) {
            return null;
        }
        int[] result = array.clone();
        Arrays.sort(result);
        return result;
    }
    
    public static List&lt;String&gt; filterByPrefix(List&lt;String&gt; words, String prefix) {
        if (words == null || prefix == null) {
            return new ArrayList&lt;&gt;();
        }
        return words.stream()
                    .filter(word -&gt; word.startsWith(prefix))
                    .collect(Collectors.toList());
    }
    
    public static String[] splitAndTrim(String input, String delimiter) {
        if (input == null || delimiter == null) {
            return new String[0];
        }
        return Arrays.stream(input.split(delimiter))
                     .map(String::trim)
                     .toArray(String[]::new);
    }
}</code></pre>
                        <p><strong>ArrayUtilsTest.java</strong></p>
                        <pre><code>import org.junit.jupiter.api.Test;
import java.util.*;
import static org.junit.jupiter.api.Assertions.*;

class ArrayUtilsTest {
    
    @Test
    void testSortArray() {
        int[] input = {3, 1, 4, 1, 5};
        int[] expected = {1, 1, 3, 4, 5};
        int[] result = ArrayUtils.sortArray(input);
        
        assertArrayEquals(expected, result);
        // 元の配列は変更されていないことを確認
        assertArrayEquals(new int[]{3, 1, 4, 1, 5}, input);
    }
    
    @Test
    void testFilterByPrefix() {
        List&lt;String&gt; words = Arrays.asList("apple", "application", "banana", "apply");
        List&lt;String&gt; expected = Arrays.asList("apple", "application", "apply");
        List&lt;String&gt; result = ArrayUtils.filterByPrefix(words, "app");
        
        assertIterableEquals(expected, result);
    }
    
    @Test
    void testSplitAndTrim() {
        String input = "  apple  ,  banana  ,  cherry  ";
        String[] expected = {"apple", "banana", "cherry"};
        String[] result = ArrayUtils.splitAndTrim(input, ",");
        
        assertArrayEquals(expected, result);
    }
}</code></pre>
                        <h6>期待される結果</h6>
                        <p>配列とコレクションの内容が正確に比較され、すべてのテストが成功します。</p>
                    </div>

                    <h3 class="section-title">3.2 assertAll() - 複数のアサーションをグループ化</h3>
                    <p>assertAll()メソッドを使用すると、複数のアサーションを一度に実行し、すべての失敗を報告できます。</p>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 3-2: assertAll()の使用</h5>
                        <p>ユーザー情報を管理するクラスで、複数の属性を一度にテストします。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>Userクラスを作成</li>
                            <li>assertAll()を使用してまとめてテスト</li>
                            <li>一部のアサーションが失敗した場合の動作を確認</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>User.java</strong></p>
                        <pre><code>public class User {
    private String name;
    private int age;
    private String email;
    
    public User(String name, int age, String email) {
        this.name = name;
        this.age = age;
        this.email = email;
    }
    
    // getters
    public String getName() { return name; }
    public int getAge() { return age; }
    public String getEmail() { return email; }
    
    public boolean isAdult() {
        return age &gt;= 18;
    }
    
    public String getInitials() {
        if (name == null || name.trim().isEmpty()) {
            return "";
        }
        String[] parts = name.trim().split("\\s+");
        StringBuilder initials = new StringBuilder();
        for (String part : parts) {
            if (!part.isEmpty()) {
                initials.append(part.charAt(0));
            }
        }
        return initials.toString().toUpperCase();
    }
}</code></pre>
                        <p><strong>UserTest.java</strong></p>
                        <pre><code>import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

class UserTest {
    
    @Test
    void testUserPropertiesWithAssertAll() {
        User user = new User("John Doe", 25, "john.doe@example.com");
        
        assertAll("user properties",
            () -&gt; assertEquals("John Doe", user.getName()),
            () -&gt; assertEquals(25, user.getAge()),
            () -&gt; assertEquals("john.doe@example.com", user.getEmail()),
            () -&gt; assertTrue(user.isAdult()),
            () -&gt; assertEquals("JD", user.getInitials())
        );
    }
    
    @Test
    void testMinorUser() {
        User minor = new User("Jane Smith", 16, "jane@example.com");
        
        assertAll("minor user properties",
            () -&gt; assertEquals("Jane Smith", minor.getName()),
            () -&gt; assertEquals(16, minor.getAge()),
            () -&gt; assertFalse(minor.isAdult(), "16歳のユーザーは成人ではない"),
            () -&gt; assertEquals("JS", minor.getInitials())
        );
    }
}</code></pre>
                        <h6>期待される結果</h6>
                        <p>すべてのアサーションが実行され、失敗があってもすべての結果が報告されます。</p>
                    </div>

                    <h3 class="section-title">3.3 カスタムエラーメッセージ</h3>
                    <p>テストが失敗した際に、より詳細で理解しやすいメッセージを提供する方法を学びます。</p>

                    <h4>エラーメッセージのベストプラクティス</h4>
                    <ul>
                        <li><strong>具体的な情報</strong>: 何が期待され、何が実際に起こったか</li>
                        <li><strong>コンテキスト情報</strong>: テストの状況や入力値</li>
                        <li><strong>Supplier&lt;String&gt;</strong>: 遅延評価でパフォーマンス向上</li>
                    </ul>

                    <!-- 実習3 -->
                    <div class="exercise-container">
                        <h5>実習 3-3: カスタムエラーメッセージの作成</h5>
                        <p>詳細なエラーメッセージを提供するテストを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>通常のメッセージとSupplier&lt;String&gt;の違いを確認</li>
                            <li>動的なエラーメッセージを作成</li>
                            <li>失敗時のメッセージを確認</li>
                        </ol>
                        <h6>実行例</h6>
                        <pre><code>import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

class CustomErrorMessageTest {
    
    @Test
    void testWithDetailedErrorMessage() {
        int[] numbers = {1, 2, 3, 4, 5};
        int sum = Arrays.stream(numbers).sum();
        
        assertEquals(15, sum, 
            String.format("配列 %s の合計は15であるべきですが、実際は%dでした", 
                         Arrays.toString(numbers), sum));
    }
    
    @Test
    void testWithSupplierMessage() {
        String input = "Hello World";
        int expectedLength = 10; // 意図的に間違った値
        
        assertEquals(expectedLength, input.length(),
            () -&gt; String.format("文字列 '%s' の長さは%dであるべきですが、実際は%dでした",
                               input, expectedLength, input.length()));
    }
    
    @Test
    void testComplexValidation() {
        User user = new User("", -5, "invalid-email");
        
        assertAll("ユーザー検証",
            () -&gt; assertFalse(user.getName().isEmpty(), 
                  "ユーザー名は空であってはいけません"),
            () -&gt; assertTrue(user.getAge() &gt; 0, 
                  () -&gt; "年齢は正の数であるべきです。実際の値: " + user.getAge()),
            () -&gt; assertTrue(user.getEmail().contains("@"), 
                  () -&gt; "メールアドレスは@を含むべきです。実際の値: '" + user.getEmail() + "'")
        );
    }
}</code></pre>
                        <h6>期待される結果</h6>
                        <p>テスト失敗時に詳細で理解しやすいエラーメッセージが表示されます。</p>
                    </div>

                    <h3 class="section-title">3.4 AssertJライブラリの導入</h3>
                    <p>AssertJは、より流暢で読みやすいアサーションを提供するライブラリです。</p>

                    <div class="warning">
                        <h6>AssertJの導入方法</h6>
                        <p><strong>Maven依存関係</strong></p>
                        <pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.assertj&lt;/groupId&gt;
    &lt;artifactId&gt;assertj-core&lt;/artifactId&gt;
    &lt;version&gt;3.24.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
                        <p><strong>Gradle依存関係</strong></p>
                        <pre><code>testImplementation 'org.assertj:assertj-core:3.24.2'</code></pre>
                    </div>

                    <!-- 実習4 -->
                    <div class="exercise-container">
                        <h5>実習 3-4: AssertJの流暢なアサーション</h5>
                        <p>AssertJを使用して、より読みやすいテストを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>AssertJを依存関係に追加</li>
                            <li>流暢なアサーション形式でテストを書き直し</li>
                            <li>JUnitとAssertJのアサーションを比較</li>
                        </ol>
                        <h6>実行例</h6>
                        <pre><code>import org.junit.jupiter.api.Test;
import java.util.*;
import static org.assertj.core.api.Assertions.*;

class AssertJExampleTest {
    
    @Test
    void testStringAssertions() {
        String actual = "Hello AssertJ World";
        
        assertThat(actual)
            .isnot(nullValue())
            .startsWith("Hello")
            .endsWith("World")
            .contains("AssertJ")
            .hasSize(19);
    }
    
    @Test
    void testCollectionAssertions() {
        List&lt;String&gt; fruits = Arrays.asList("apple", "banana", "cherry");
        
        assertThat(fruits)
            .hasSize(3)
            .contains("apple", "cherry")
            .doesNotContain("grape")
            .startsWith("apple")
            .endsWith("cherry");
    }
    
    @Test
    void testObjectAssertions() {
        User user = new User("Alice Johnson", 28, "alice@example.com");
        
        assertThat(user)
            .isNotNull()
            .extracting(User::getName, User::getAge, User::isAdult)
            .containsExactly("Alice Johnson", 28, true);
    }
    
    @Test
    void testNumberAssertions() {
        int score = 85;
        
        assertThat(score)
            .isPositive()
            .isGreaterThan(80)
            .isLessThanOrEqualTo(100)
            .isBetween(70, 90);
    }
    
    @Test
    void testExceptionAssertions() {
        assertThatThrownBy(() -&gt; {
            throw new IllegalArgumentException("Invalid input");
        })
        .isInstanceOf(IllegalArgumentException.class)
        .hasMessage("Invalid input")
        .hasNoCause();
    }
}</code></pre>
                        <h6>期待される結果</h6>
                        <p>流暢な記法によって、テストの意図がより明確に表現され、可読性が向上します。</p>
                    </div>

                    <h3 class="section-title">3.5 カスタムマッチャーの作成</h3>
                    <p>独自の検証ロジックを再利用可能なマッチャーとして作成する方法を学びます。</p>

                    <!-- 実習5 -->
                    <div class="exercise-container">
                        <h5>実習 3-5: カスタムマッチャーの実装</h5>
                        <p>独自のビジネスロジック検証のためのカスタムマッチャーを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>Personクラスの年齢グループ判定マッチャーを作成</li>
                            <li>メールアドレス形式検証マッチャーを作成</li>
                            <li>カスタムマッチャーを使用したテストを実装</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>カスタムマッチャー</strong></p>
                        <pre><code>import org.assertj.core.api.AbstractAssert;
import java.util.regex.Pattern;

public class UserAssert extends AbstractAssert&lt;UserAssert, User&gt; {
    
    private static final Pattern EMAIL_PATTERN = 
        Pattern.compile("^[A-Za-z0-9+_.-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})$");
    
    public UserAssert(User actual) {
        super(actual, UserAssert.class);
    }
    
    public static UserAssert assertThat(User actual) {
        return new UserAssert(actual);
    }
    
    public UserAssert isAdult() {
        isNotNull();
        if (!actual.isAdult()) {
            failWithMessage("Expected user to be adult but age was %d", actual.getAge());
        }
        return this;
    }
    
    public UserAssert isMinor() {
        isNotNull();
        if (actual.isAdult()) {
            failWithMessage("Expected user to be minor but age was %d", actual.getAge());
        }
        return this;
    }
    
    public UserAssert hasValidEmail() {
        isNotNull();
        if (!EMAIL_PATTERN.matcher(actual.getEmail()).matches()) {
            failWithMessage("Expected valid email but was %s", actual.getEmail());
        }
        return this;
    }
    
    public UserAssert hasAgeInRange(int min, int max) {
        isNotNull();
        if (actual.getAge() &lt; min || actual.getAge() &gt; max) {
            failWithMessage("Expected age to be between %d and %d but was %d", 
                          min, max, actual.getAge());
        }
        return this;
    }
}</code></pre>
                        <p><strong>カスタムマッチャーを使用したテスト</strong></p>
                        <pre><code>import org.junit.jupiter.api.Test;
import static com.example.UserAssert.assertThat;

class CustomMatcherTest {
    
    @Test
    void testAdultUserWithCustomMatcher() {
        User user = new User("Bob Wilson", 30, "bob.wilson@company.com");
        
        assertThat(user)
            .isAdult()
            .hasValidEmail()
            .hasAgeInRange(25, 35);
    }
    
    @Test
    void testMinorUserWithCustomMatcher() {
        User minor = new User("Tom Brown", 15, "tom.brown@school.edu");
        
        assertThat(minor)
            .isMinor()
            .hasValidEmail()
            .hasAgeInRange(13, 17);
    }
    
    @Test
    void testInvalidEmailWithCustomMatcher() {
        User userWithInvalidEmail = new User("Invalid User", 25, "not-an-email");
        
        // このテストは失敗することが期待される
        // assertThat(userWithInvalidEmail).hasValidEmail();
    }
}</code></pre>
                        <h6>期待される結果</h6>
                        <p>カスタムマッチャーにより、ドメイン固有の検証ロジックが再利用可能になり、テストコードがより表現力豊かになります。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>assertArrayEquals()とassertEquals()の違いは何ですか？</li>
                            <li>assertAll()メソッドを使用する利点を2つ挙げてください。</li>
                            <li>エラーメッセージでSupplier&lt;String&gt;を使用する理由は何ですか？</li>
                            <li>AssertJの流暢なアサーションの利点を説明してください。</li>
                            <li>カスタムマッチャーを作成する場面として適切なものを選んでください。</li>
                            <li>assertThat(fruits).contains("apple")とassertThat(fruits).containsExactly("apple")の違いは何ですか？</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>assertArrayEquals()は配列の各要素を順番に比較し、assertEquals()は配列オブジェクト自体を比較します</li>
                                <li>1) すべてのアサーションが実行される、2) 複数の失敗を一度に確認できる</li>
                                <li>テストが成功した場合にメッセージ生成処理をスキップでき、パフォーマンスが向上するため</li>
                                <li>メソッドチェインにより読みやすく、豊富なアサーションメソッドが利用できる</li>
                                <li>ドメイン固有の検証ロジックを複数のテストで再利用したい場合</li>
                                <li>contains()は指定した要素が含まれるかチェック、containsExactly()は指定した要素のみが順番通りに含まれるかチェック</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="junit-learning-material-2.html" class="btn btn-secondary">← 前の章</a>
                        <a href="junit-learning-material-4.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>