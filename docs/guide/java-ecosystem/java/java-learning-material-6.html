<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java学習教材 第6章 - 例外処理</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #f57c00;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        .exception-table {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>Java学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="java-learning-material-1.html">第1章: Java基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="java-learning-material-2.html">第2章: Java言語の基本</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="java-learning-material-3.html">第3章: オブジェクト指向プログラミング入門</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="java-learning-material-4.html">第4章: オブジェクト指向プログラミング応用</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="java-learning-material-5.html">第5章: Java API基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="java-learning-material-6.html">第6章: 例外処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="java-learning-material-7.html">第7章: 入出力操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="java-learning-material-8.html">第8章: コレクションフレームワーク応用</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: 例外処理</h1>
                </div>

                <div id="chapter6">
                    <h2 class="chapter-title">プログラムの異常事態に適切に対応する</h2>

                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>例外処理の概念と必要性を理解する</li>
                            <li>try-catch-finally構文の使用法をマスターする</li>
                            <li>Javaの例外の種類と階層構造を把握する</li>
                            <li>例外のスロー（throw）と伝播の仕組みを学ぶ</li>
                            <li>独自例外クラスの作成と活用方法を習得する</li>
                            <li>堅牢なプログラム設計のベストプラクティスを理解する</li>
                        </ul>
                    </div>

                    <!-- 6.1 例外処理とは -->
                    <h3 class="section-title">6.1 例外処理とは何か</h3>
                    <p><strong>例外処理</strong>は、プログラムの実行中に発生する予期しない問題（例外）に適切に対応するメカニズムです。ファイルが見つからない、ネットワーク接続が切れる、不正な入力があるなど、様々な異常事態を適切に処理することができます。</p>

                    <div class="mermaid">
                        flowchart TD
                            A[プログラム実行] --> B{例外が発生？}
                            B -->|No| C[正常処理続行]
                            B -->|Yes| D[例外処理実行]
                            D --> E[適切なエラーメッセージ表示]
                            D --> F[リソースのクリーンアップ]
                            D --> G[代替処理の実行]
                            E --> H[プログラム継続または終了]
                            F --> H
                            G --> H
                            C --> I[プログラム終了]
                    </div>

                    <h4>例外処理が必要な理由</h4>
                    <ul>
                        <li><strong>プログラムの安定性</strong>：予期しないエラーでプログラムが異常終了することを防ぐ</li>
                        <li><strong>ユーザー体験の向上</strong>：分かりやすいエラーメッセージを提供</li>
                        <li><strong>デバッグの容易さ</strong>：問題の詳細情報を取得して原因を特定</li>
                        <li><strong>リソース管理</strong>：ファイルやネットワーク接続などのリソースを確実に解放</li>
                        <li><strong>代替処理</strong>：エラー時に別の処理を実行して継続</li>
                    </ul>

                    <!-- 6.2 try-catch構文 -->
                    <h3 class="section-title">6.2 try-catch構文</h3>
                    <p><strong>try-catch構文</strong>は、例外が発生する可能性のあるコードを安全に実行するための基本的な仕組みです。</p>

                    <pre class="code-block"><code class="language-java">try {
    // 例外が発生する可能性のあるコード
} catch (例外の型 変数名) {
    // 例外が発生した時の処理
} finally {
    // 例外の有無に関係なく必ず実行される処理（オプション）
}</code></pre>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 6-1: try-catch の基本的な使用方法</h5>
                        <p>配列のインデックス範囲外アクセスの例外処理を学びましょう。</p>

                        <pre class="code-block"><code class="language-java">public class BasicExceptionHandling {
    public static void main(String[] args) {
        int[] numbers = {1, 2, 3, 4, 5};
        
        System.out.println("=== 正常なアクセス ===");
        try {
            for (int i = 0; i < numbers.length; i++) {
                System.out.println("numbers[" + i + "] = " + numbers[i]);
            }
        } catch (ArrayIndexOutOfBoundsException e) {
            System.out.println("配列の範囲外アクセスが発生しました: " + e.getMessage());
        }
        
        System.out.println("\n=== 例外が発生するアクセス ===");
        try {
            System.out.println("numbers[10] = " + numbers[10]);  // 範囲外アクセス
            System.out.println("この行は実行されません");
        } catch (ArrayIndexOutOfBoundsException e) {
            System.out.println("例外をキャッチしました！");
            System.out.println("例外の詳細: " + e.getMessage());
            System.out.println("例外の型: " + e.getClass().getSimpleName());
        }
        
        System.out.println("\n=== ゼロ除算の例外処理 ===");
        int a = 10;
        int b = 0;
        
        try {
            int result = a / b;
            System.out.println("結果: " + result);
        } catch (ArithmeticException e) {
            System.out.println("ゼロで割り算をしようとしました: " + e.getMessage());
            System.out.println("代替処理: 結果を0とします");
            System.out.println("代替結果: 0");
        }
        
        System.out.println("\n=== 複数の例外処理 ===");
        String[] texts = {"123", "abc", "456", null, "789"};
        
        for (int i = 0; i < texts.length; i++) {
            try {
                int number = Integer.parseInt(texts[i]);
                int result = 100 / number;
                System.out.println(texts[i] + " → " + number + ", 100/" + number + " = " + result);
            } catch (NumberFormatException e) {
                System.out.println(texts[i] + " → 数値変換エラー: " + e.getMessage());
            } catch (ArithmeticException e) {
                System.out.println(texts[i] + " → 演算エラー: " + e.getMessage());
            } catch (NullPointerException e) {
                System.out.println("null → Nullポインタエラー: " + e.getMessage());
            }
        }
        
        System.out.println("\nプログラムは正常に終了しました");
    }
}</code></pre>

                        <h6>期待される実行結果</h6>
                        <pre class="code-block"><code class="language-bash">=== 正常なアクセス ===
numbers[0] = 1
numbers[1] = 2
numbers[2] = 3
numbers[3] = 4
numbers[4] = 5

=== 例外が発生するアクセス ===
例外をキャッチしました！
例外の詳細: Index 10 out of bounds for length 5
例外の型: ArrayIndexOutOfBoundsException

=== ゼロ除算の例外処理 ===
ゼロで割り算をしようとしました: / by zero
代替処理: 結果を0とします
代替結果: 0

=== 複数の例外処理 ===
123 → 123, 100/123 = 0
abc → 数値変換エラー: For input string: "abc"
456 → 456, 100/456 = 0
null → Nullポインタエラー: null
789 → 789, 100/789 = 0

プログラムは正常に終了しました</code></pre>
                    </div>

                    <!-- 6.3 finally ブロック -->
                    <h3 class="section-title">6.3 finally ブロック</h3>
                    <p><strong>finally ブロック</strong>は、例外の発生有無に関わらず必ず実行されるコードブロックです。リソースのクリーンアップや重要な後処理に使用されます。</p>

                    <div class="highlight">
                        <h6>finally ブロックの特徴</h6>
                        <ul>
                            <li><strong>必ず実行</strong>：例外の有無、return文の有無に関わらず実行</li>
                            <li><strong>リソース管理</strong>：ファイル、データベース接続などのクリーンアップに最適</li>
                            <li><strong>try-with-resources</strong>：Java 7以降の自動リソース管理機能もあり</li>
                        </ul>
                    </div>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 6-2: finally ブロックとリソース管理</h5>
                        <p>finally ブロックの動作とリソース管理を学びましょう。</p>

                        <pre class="code-block"><code class="language-java">import java.io.*;

public class FinallyExample {
    public static void main(String[] args) {
        System.out.println("=== finally ブロックの基本動作 ===");
        
        // 正常ケース
        testFinally(true);
        
        // 例外ケース
        testFinally(false);
        
        System.out.println("\n=== ファイル操作でのfinally ===");
        readFileWithFinally("test.txt");
        
        System.out.println("\n=== try-with-resources の例 ===");
        readFileWithTryWithResources("test.txt");
    }
    
    public static void testFinally(boolean success) {
        System.out.println("\n--- " + (success ? "正常" : "例外") + "ケース ---");
        
        try {
            System.out.println("try ブロック開始");
            
            if (!success) {
                throw new RuntimeException("テスト例外");
            }
            
            System.out.println("try ブロック正常終了");
            return;  // ここでreturnしてもfinallyは実行される
        } catch (RuntimeException e) {
            System.out.println("catch ブロック: " + e.getMessage());
            return;  // ここでreturnしてもfinallyは実行される
        } finally {
            System.out.println("finally ブロック: 必ず実行されます");
        }
        
        // finallyの後に到達することはない（returnがあるため）
    }
    
    public static void readFileWithFinally(String filename) {
        FileReader fileReader = null;
        BufferedReader bufferedReader = null;
        
        try {
            System.out.println("ファイル読み込み開始: " + filename);
            fileReader = new FileReader(filename);
            bufferedReader = new BufferedReader(fileReader);
            
            String line = bufferedReader.readLine();
            System.out.println("読み込み成功: " + line);
            
        } catch (FileNotFoundException e) {
            System.out.println("ファイルが見つかりません: " + filename);
        } catch (IOException e) {
            System.out.println("読み込みエラー: " + e.getMessage());
        } finally {
            // リソースのクリーンアップ
            System.out.println("リソースをクリーンアップします");
            
            try {
                if (bufferedReader != null) {
                    bufferedReader.close();
                    System.out.println("BufferedReader をクローズしました");
                }
            } catch (IOException e) {
                System.out.println("BufferedReader のクローズに失敗: " + e.getMessage());
            }
            
            try {
                if (fileReader != null) {
                    fileReader.close();
                    System.out.println("FileReader をクローズしました");
                }
            } catch (IOException e) {
                System.out.println("FileReader のクローズに失敗: " + e.getMessage());
            }
        }
    }
    
    // Java 7以降のtry-with-resources文
    public static void readFileWithTryWithResources(String filename) {
        try (FileReader fileReader = new FileReader(filename);
             BufferedReader bufferedReader = new BufferedReader(fileReader)) {
            
            System.out.println("try-with-resources でファイル読み込み: " + filename);
            String line = bufferedReader.readLine();
            System.out.println("読み込み成功: " + line);
            
        } catch (FileNotFoundException e) {
            System.out.println("ファイルが見つかりません: " + filename);
        } catch (IOException e) {
            System.out.println("読み込みエラー: " + e.getMessage());
        }
        // リソースは自動的にクローズされる（finallyブロック不要）
        System.out.println("リソースは自動的にクローズされました");
    }
}</code></pre>
                    </div>

                    <!-- 6.4 例外の種類と階層 -->
                    <h3 class="section-title">6.4 例外の種類と階層構造</h3>
                    <p>Javaの例外は階層構造を持ち、大きく <strong>検査例外</strong> と <strong>実行時例外</strong> に分類されます。</p>

                    <div class="mermaid">
                        classDiagram
                            class Throwable {
                                +getMessage()
                                +printStackTrace()
                            }
                            
                            class Error {
                                OutOfMemoryError
                                StackOverflowError
                            }
                            
                            class Exception {
                                IOException
                                ClassNotFoundException
                            }
                            
                            class RuntimeException {
                                NullPointerException
                                ArrayIndexOutOfBoundsException
                                IllegalArgumentException
                            }
                            
                            Throwable <|-- Error
                            Throwable <|-- Exception
                            Exception <|-- RuntimeException
                    </div>

                    <div class="exception-table">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>分類</th>
                                    <th>特徴</th>
                                    <th>処理義務</th>
                                    <th>例</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Error</strong></td>
                                    <td>システムレベルの深刻なエラー</td>
                                    <td>通常は処理しない</td>
                                    <td>OutOfMemoryError, StackOverflowError</td>
                                </tr>
                                <tr>
                                    <td><strong>検査例外<br/>(Checked Exception)</strong></td>
                                    <td>コンパイル時にチェック</td>
                                    <td>必ず処理が必要</td>
                                    <td>IOException, ClassNotFoundException</td>
                                </tr>
                                <tr>
                                    <td><strong>実行時例外<br/>(Runtime Exception)</strong></td>
                                    <td>実行時に発生</td>
                                    <td>処理は任意</td>
                                    <td>NullPointerException, ArrayIndexOutOfBoundsException</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 6.5 例外のスローと伝播 -->
                    <h3 class="section-title">6.5 例外のスローと伝播</h3>
                    <p><strong>throw</strong> キーワードで例外を意図的に発生させ、<strong>throws</strong> キーワードでメソッドが例外を投げる可能性を宣言できます。</p>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 6-3: 例外のスローと伝播</h5>
                        <p>例外を投げる側と受け取る側の処理を学びましょう。</p>

                        <pre class="code-block"><code class="language-java">public class ExceptionThrowExample {
    public static void main(String[] args) {
        System.out.println("=== 例外のスローと伝播 ===");
        
        // 年齢検証の例
        String[] ages = {"25", "15", "-5", "200", "abc"};
        
        for (String ageStr : ages) {
            try {
                int age = validateAge(ageStr);
                System.out.println("有効な年齢: " + age + "歳");
            } catch (IllegalArgumentException e) {
                System.out.println("年齢エラー: " + e.getMessage());
            } catch (NumberFormatException e) {
                System.out.println("数値形式エラー: " + ageStr + " は数値ではありません");
            }
        }
        
        System.out.println("\n=== 階層的な例外処理 ===");
        
        try {
            processUserData("", -10, "invalid-email");
        } catch (UserValidationException e) {
            System.out.println("ユーザーデータエラー: " + e.getMessage());
            System.out.println("詳細: " + e.getDetailMessage());
        }
    }
    
    // throws宣言で例外の可能性を明示
    public static int validateAge(String ageStr) throws IllegalArgumentException, NumberFormatException {
        // NumberFormatExceptionは自動的に伝播
        int age = Integer.parseInt(ageStr);
        
        // 独自の検証ロジックで例外をスロー
        if (age < 0) {
            throw new IllegalArgumentException("年齢は負の値にできません: " + age);
        }
        
        if (age > 150) {
            throw new IllegalArgumentException("年齢が現実的ではありません: " + age);
        }
        
        return age;
    }
    
    // 複数の例外をまとめて処理する例
    public static void processUserData(String name, int age, String email) throws UserValidationException {
        StringBuilder errors = new StringBuilder();
        
        // 名前の検証
        if (name == null || name.trim().isEmpty()) {
            errors.append("名前が入力されていません。");
        }
        
        // 年齢の検証
        if (age < 0 || age > 150) {
            errors.append("年齢が無効です（" + age + "）。");
        }
        
        // メールの検証
        if (email == null || !email.contains("@")) {
            errors.append("メールアドレスが無効です。");
        }
        
        // エラーがある場合は独自例外をスロー
        if (errors.length() > 0) {
            throw new UserValidationException("ユーザーデータの検証に失敗しました", errors.toString());
        }
        
        System.out.println("ユーザーデータは有効です: " + name + ", " + age + "歳, " + email);
    }
}

// 独自例外クラス
class UserValidationException extends Exception {
    private String detailMessage;
    
    public UserValidationException(String message, String detailMessage) {
        super(message);
        this.detailMessage = detailMessage;
    }
    
    public String getDetailMessage() {
        return detailMessage;
    }
}</code></pre>
                    </div>

                    <!-- 6.6 独自例外クラス -->
                    <h3 class="section-title">6.6 独自例外クラスの作成</h3>
                    <p>アプリケーション固有のエラー状況を表現するため、独自の例外クラスを作成できます。これにより、より詳細で意味のあるエラー情報を提供できます。</p>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 6-4: 銀行システムの独自例外</h5>
                        <p>銀行口座システムで使用する独自例外を設計・実装しましょう。</p>

                        <pre class="code-block"><code class="language-java">// 銀行操作の基本例外クラス
class BankException extends Exception {
    private String accountNumber;
    private double currentBalance;
    
    public BankException(String message, String accountNumber, double currentBalance) {
        super(message);
        this.accountNumber = accountNumber;
        this.currentBalance = currentBalance;
    }
    
    public String getAccountNumber() { return accountNumber; }
    public double getCurrentBalance() { return currentBalance; }
    
    @Override
    public String toString() {
        return super.toString() + " [口座: " + accountNumber + ", 残高: " + currentBalance + "]";
    }
}

// 残高不足例外
class InsufficientFundsException extends BankException {
    private double attemptedAmount;
    
    public InsufficientFundsException(String accountNumber, double currentBalance, double attemptedAmount) {
        super("残高が不足しています", accountNumber, currentBalance);
        this.attemptedAmount = attemptedAmount;
    }
    
    public double getAttemptedAmount() { return attemptedAmount; }
    
    @Override
    public String toString() {
        return super.toString() + " [要求額: " + attemptedAmount + "]";
    }
}

// 口座凍結例外
class AccountFrozenException extends BankException {
    private String reason;
    
    public AccountFrozenException(String accountNumber, double currentBalance, String reason) {
        super("口座が凍結されています", accountNumber, currentBalance);
        this.reason = reason;
    }
    
    public String getReason() { return reason; }
}

// 不正な金額例外
class InvalidAmountException extends BankException {
    private double invalidAmount;
    
    public InvalidAmountException(String accountNumber, double currentBalance, double invalidAmount) {
        super("不正な金額が指定されました", accountNumber, currentBalance);
        this.invalidAmount = invalidAmount;
    }
    
    public double getInvalidAmount() { return invalidAmount; }
}

// 銀行口座クラス
class BankAccount {
    private String accountNumber;
    private String ownerName;
    private double balance;
    private boolean isFrozen;
    private String frozenReason;
    
    public BankAccount(String accountNumber, String ownerName, double initialBalance) {
        this.accountNumber = accountNumber;
        this.ownerName = ownerName;
        this.balance = initialBalance;
        this.isFrozen = false;
    }
    
    // 出金処理（複数の例外をスロー）
    public void withdraw(double amount) throws InsufficientFundsException, AccountFrozenException, InvalidAmountException {
        // 金額の妥当性チェック
        if (amount <= 0) {
            throw new InvalidAmountException(accountNumber, balance, amount);
        }
        
        // 口座凍結チェック
        if (isFrozen) {
            throw new AccountFrozenException(accountNumber, balance, frozenReason);
        }
        
        // 残高チェック
        if (balance < amount) {
            throw new InsufficientFundsException(accountNumber, balance, amount);
        }
        
        balance -= amount;
        System.out.println(amount + "円を出金しました。残高: " + balance + "円");
    }
    
    // 入金処理
    public void deposit(double amount) throws InvalidAmountException, AccountFrozenException {
        if (amount <= 0) {
            throw new InvalidAmountException(accountNumber, balance, amount);
        }
        
        if (isFrozen) {
            throw new AccountFrozenException(accountNumber, balance, frozenReason);
        }
        
        balance += amount;
        System.out.println(amount + "円を入金しました。残高: " + balance + "円");
    }
    
    // 口座凍結
    public void freezeAccount(String reason) {
        this.isFrozen = true;
        this.frozenReason = reason;
        System.out.println("口座が凍結されました: " + reason);
    }
    
    // ゲッター
    public String getAccountNumber() { return accountNumber; }
    public String getOwnerName() { return ownerName; }
    public double getBalance() { return balance; }
    public boolean isFrozen() { return isFrozen; }
}

public class CustomExceptionExample {
    public static void main(String[] args) {
        BankAccount account = new BankAccount("123-456-789", "田中太郎", 10000);
        
        System.out.println("=== 正常な取引 ===");
        try {
            account.deposit(5000);
            account.withdraw(3000);
        } catch (BankException e) {
            handleBankException(e);
        }
        
        System.out.println("\n=== 異常な取引のテスト ===");
        
        // 残高不足のテスト
        testTransaction(account, () -> {
            try {
                account.withdraw(20000);  // 残高不足
            } catch (BankException e) { handleBankException(e); }
        }, "残高不足テスト");
        
        // 不正な金額のテスト
        testTransaction(account, () -> {
            try {
                account.withdraw(-1000);  // 負の金額
            } catch (BankException e) { handleBankException(e); }
        }, "負の金額テスト");
        
        // 口座凍結のテスト
        account.freezeAccount("疑わしい取引のため");
        testTransaction(account, () -> {
            try {
                account.deposit(1000);  // 凍結口座への入金
            } catch (BankException e) { handleBankException(e); }
        }, "凍結口座テスト");
    }
    
    private static void testTransaction(BankAccount account, Runnable transaction, String testName) {
        System.out.println("\n--- " + testName + " ---");
        transaction.run();
    }
    
    private static void handleBankException(BankException e) {
        System.out.println("銀行エラーが発生しました:");
        System.out.println("  エラー内容: " + e.getMessage());
        System.out.println("  口座番号: " + e.getAccountNumber());
        System.out.println("  現在残高: " + e.getCurrentBalance() + "円");
        
        // 例外の種類に応じた詳細処理
        if (e instanceof InsufficientFundsException) {
            InsufficientFundsException ife = (InsufficientFundsException) e;
            System.out.println("  要求額: " + ife.getAttemptedAmount() + "円");
            System.out.println("  不足額: " + (ife.getAttemptedAmount() - e.getCurrentBalance()) + "円");
        } else if (e instanceof AccountFrozenException) {
            AccountFrozenException afe = (AccountFrozenException) e;
            System.out.println("  凍結理由: " + afe.getReason());
        } else if (e instanceof InvalidAmountException) {
            InvalidAmountException iae = (InvalidAmountException) e;
            System.out.println("  不正な金額: " + iae.getInvalidAmount());
        }
    }
}</code></pre>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>finally ブロックが実行されないケースはどれですか？</strong>
                                <ul style="list-style-type: none;">
                                    <li>a) try ブロックで例外が発生した場合</li>
                                    <li>b) catch ブロックで return 文を実行した場合</li>
                                    <li>c) try ブロックで System.exit(0) を呼んだ場合</li>
                                    <li>d) finally ブロックが実行されないケースはない</li>
                                </ul>
                            </li>
                            <li>
                                <strong>検査例外（Checked Exception）の特徴として正しいものはどれですか？</strong>
                                <ul style="list-style-type: none;">
                                    <li>a) RuntimeException を継承している</li>
                                    <li>b) コンパイル時に処理が強制される</li>
                                    <li>c) 実行時にのみ発生する</li>
                                    <li>d) 通常はキャッチしなくて良い</li>
                                </ul>
                            </li>
                            <li>
                                <strong>throw と throws の違いとして正しいものはどれですか？</strong>
                                <ul style="list-style-type: none;">
                                    <li>a) throw は例外をキャッチ、throws は例外をスロー</li>
                                    <li>b) throw は例外をスロー、throws は例外の可能性を宣言</li>
                                    <li>c) どちらも同じ機能</li>
                                    <li>d) throw は検査例外、throws は実行時例外専用</li>
                                </ul>
                            </li>
                            <li>
                                <strong>独自例外クラスを作成する際の推奨事項として正しいものはどれですか？</strong>
                                <ul style="list-style-type: none;">
                                    <li>a) 必ず RuntimeException を継承する</li>
                                    <li>b) Exception または RuntimeException を継承する</li>
                                    <li>c) Throwable を直接継承する</li>
                                    <li>d) Error を継承する</li>
                                </ul>
                            </li>
                            <li>
                                <strong>try-with-resources 文の利点として正しいものはどれですか？</strong>
                                <ul style="list-style-type: none;">
                                    <li>a) 例外処理が不要になる</li>
                                    <li>b) リソースの自動クローズが保証される</li>
                                    <li>c) パフォーマンスが大幅に向上する</li>
                                    <li>d) すべての例外が自動的に処理される</li>
                                </ul>
                            </li>
                        </ol>

                        <details style="margin-top: 1rem;">
                            <summary>解答を表示</summary>
                            <div style="margin-top: 0.5rem;">
                                <p><strong>解答:</strong></p>
                                <ol>
                                    <li>c) try ブロックで System.exit(0) を呼んだ場合 - JVMが終了するため finally は実行されない</li>
                                    <li>b) コンパイル時に処理が強制される - 検査例外は必ず処理する必要がある</li>
                                    <li>b) throw は例外をスロー、throws は例外の可能性を宣言 - throw は実際に例外を投げ、throws は宣言</li>
                                    <li>b) Exception または RuntimeException を継承する - 適切な基底クラスを選択</li>
                                    <li>b) リソースの自動クローズが保証される - AutoCloseable リソースが自動的にクローズされる</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- 章のまとめ -->
                    <h3 class="section-title">章のまとめ</h3>
                    <p>この章では、Javaの例外処理について学習しました：</p>

                    <ul>
                        <li><strong>例外処理の基本概念</strong>：プログラムの異常事態に対する適切な対応方法</li>
                        <li><strong>try-catch-finally構文</strong>：例外の補足、処理、リソースクリーンアップ</li>
                        <li><strong>例外の階層構造</strong>：Error、検査例外、実行時例外の違いと使い分け</li>
                        <li><strong>例外のスローと伝播</strong>：throw/throws を使った例外の明示的な制御</li>
                        <li><strong>独自例外クラス</strong>：アプリケーション固有のエラー状況の表現</li>
                        <li><strong>ベストプラクティス</strong>：適切なエラーハンドリングと堅牢なプログラム設計</li>
                    </ul>

                    <div class="highlight">
                        <h6>次章への準備</h6>
                        <p>次章では、ファイル操作、ストリーム処理、オブジェクトのシリアル化など、Javaでの入出力操作について学習します。適切な例外処理の知識は、入出力操作で頻繁に発生する例外への対応に不可欠です。</p>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="java-learning-material-5.html" class="btn btn-secondary">← 前の章: Java API基礎</a>
                        <a href="java-learning-material-7.html" class="btn btn-primary">次の章: 入出力操作 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>

    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>