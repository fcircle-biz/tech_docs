<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring学習教材 第7章 - Spring Securityによる認証・認可</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #4caf50;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #4caf50;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #4caf50;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #66bb6a;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #4caf50;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #4caf50 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>Spring学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-1.html">
                                第1章: JavaとWebの基礎理解
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-2.html">
                                第2章: Spring Bootの導入と開発環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-3.html">
                                第3章: Spring Bootの基本構成とDI
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-4.html">
                                第4章: Webアプリケーション開発の基礎（MVC）
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-5.html">
                                第5章: データベース連携（Spring Data JDBC）
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-6.html">
                                第6章: 入力バリデーションとエラーハンドリング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="spring-learning-material-7.html">
                                第7章: Spring Securityによる認証・認可
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-8.html">
                                第8章: Spring MVCのテスト
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-9.html">
                                第9章: Todoアプリケーション開発
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-10.html">
                                第10章: さらに一歩進んだSpring開発へ①
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-11.html">
                                第11章: さらに一歩進んだSpring開発へ②
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="spring-learning-material-ex-1.html">
                                補足①: Spring Data JPA入門
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: Spring Securityによる認証・認可</h1>
                </div>

                <div id="chapter7">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">セキュアなWebアプリケーションの構築</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>認証と認可の基本概念</li>
                            <li>Spring Securityの導入と基本設定</li>
                            <li>フォームベースのログイン・ログアウト機能</li>
                            <li>URLアクセス制御とロール管理</li>
                            <li>パスワードハッシュ化とセキュリティ強化</li>
                            <li>メソッドレベルのセキュリティ設定</li>
                        </ul>
                    </div>

                    <!-- セクション7.1 -->
                    <h3 class="section-title">7.1 認証と認可の基本概念</h3>
                    <p>
                        Webアプリケーションのセキュリティでは、<strong>認証（Authentication）</strong>と<strong>認可（Authorization）</strong>が重要な概念です。これらを適切に実装することで、不正アクセスからアプリケーションを保護できます。
                    </p>

                    <div class="highlight">
                        <h6>認証と認可の違い</h6>
                        <ul>
                            <li><strong>認証（Authentication）</strong>: 「あなたは誰ですか？」- ユーザーの身元確認</li>
                            <li><strong>認可（Authorization）</strong>: 「あなたは何ができますか？」- アクセス権限の管理</li>
                        </ul>
                    </div>

                    <div class="mermaid">
                        sequenceDiagram
                            participant User as ユーザー
                            participant App as アプリケーション
                            participant Auth as 認証システム
                            participant DB as データベース

                            User->>App: アクセス要求
                            App->>Auth: 認証状態チェック
                            
                            alt 未認証の場合
                                Auth->>User: ログインページ表示
                                User->>Auth: 認証情報入力
                                Auth->>DB: 認証情報照合
                                DB-->>Auth: 照合結果
                                Auth->>Auth: 認証処理
                            end
                            
                            Auth->>App: 認証済みユーザー情報
                            App->>App: 認可チェック
                            
                            alt 権限がある場合
                                App->>User: リソース提供
                            else 権限がない場合
                                App->>User: アクセス拒否
                            end
                    </div>

                    <!-- セクション7.2 -->
                    <h3 class="section-title">7.2 Spring Securityの導入と基本設定</h3>
                    <p>
                        Spring Securityは、Spring Frameworkのセキュリティ機能を提供する強力なライブラリです。認証・認可・攻撃防御などの機能を包括的にサポートします。
                    </p>

                    <pre class="code-block"><code class="language-bash"># build.gradle - Spring Security依存関係追加
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'
}</code></pre>

                    <pre class="code-block"><code class="language-java">package com.example.demo.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                // 公開ページ（認証不要）
                .requestMatchers("/", "/home", "/login", "/register", "/css/**", "/js/**").permitAll()
                // 管理者専用ページ
                .requestMatchers("/admin/**").hasRole("ADMIN")
                // その他のページは認証が必要
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")  // カスタムログインページ
                .defaultSuccessUrl("/dashboard", true)  // ログイン成功時のリダイレクト先
                .failureUrl("/login?error=true")  // ログイン失敗時のURL
                .permitAll()
            )
            .logout(logout -> logout
                .logoutUrl("/logout")
                .logoutSuccessUrl("/")
                .invalidateHttpSession(true)
                .deleteCookies("JSESSIONID")
                .permitAll()
            );

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();  // パスワードハッシュ化
    }
}</code></pre>

                    <div class="warning">
                        <h6>Spring Security導入時の注意点</h6>
                        <p>
                            Spring Security依存関係を追加すると、デフォルトですべてのURLが保護されます。開発時はコンソールに出力される自動生成パスワードを使用するか、独自の設定を行う必要があります。
                        </p>
                    </div>

                    <!-- 実習7-1 -->
                    <div class="exercise-container">
                        <h5>実習 7-1: 基本的なSpring Security設定</h5>
                        <p>Spring Securityを導入し、基本的なログイン・ログアウト機能を実装してみましょう。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>build.gradleにSpring Security依存関係を追加</li>
                            <li>SecurityConfigクラスを作成</li>
                            <li>カスタムログインページを作成</li>
                            <li>アプリケーションを起動してセキュリティ動作を確認</li>
                        </ol>

                        <h6>templates/login.html</h6>
                        <pre class="code-block"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ログイン&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-6"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h4&gt;ログイン&lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;div th:if="${param.error}" class="alert alert-danger"&gt;
                            ユーザー名またはパスワードが正しくありません。
                        &lt;/div&gt;
                        
                        &lt;form th:action="@{/login}" method="post"&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="username" class="form-label"&gt;ユーザー名&lt;/label&gt;
                                &lt;input type="text" class="form-control" id="username" name="username" required&gt;
                            &lt;/div&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="password" class="form-label"&gt;パスワード&lt;/label&gt;
                                &lt;input type="password" class="form-control" id="password" name="password" required&gt;
                            &lt;/div&gt;
                            &lt;button type="submit" class="btn btn-primary w-100"&gt;ログイン&lt;/button&gt;
                        &lt;/form&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

                        <h6>期待される結果</h6>
                        <p>保護されたページにアクセスするとログインページにリダイレクトされ、正しい認証情報でログインすると目的のページにアクセスできることを確認できます。</p>
                    </div>

                    <!-- セクション7.3 -->
                    <h3 class="section-title">7.3 UserDetailsServiceによるユーザー管理</h3>
                    <p>
                        データベースに保存されたユーザー情報を使用するために、<code>UserDetailsService</code>を実装します。これにより、動的なユーザー管理が可能になります。
                    </p>

                    <pre class="code-block"><code class="language-java">package com.example.demo.entity;

import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;

@Table("app_users")
public class AppUser {
    
    @Id
    private Long id;
    private String username;
    private String password;
    private String email;
    private String role;
    private boolean enabled;
    
    // コンストラクタ、getter/setter省略
}</code></pre>

                    <pre class="code-block"><code class="language-java">package com.example.demo.service;

import com.example.demo.entity.AppUser;
import com.example.demo.repository.AppUserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private AppUserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        AppUser user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("User not found: " + username));
        
        List&lt;GrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();
        authorities.add(new SimpleGrantedAuthority("ROLE_" + user.getRole()));
        
        return new User(
            user.getUsername(),
            user.getPassword(),
            user.isEnabled(),
            true, // accountNonExpired
            true, // credentialsNonExpired
            true, // accountNonLocked
            authorities
        );
    }
}</code></pre>

                    <!-- セクション7.4 -->
                    <h3 class="section-title">7.4 ロールベース権限制御</h3>
                    <p>
                        Spring Securityでは、ユーザーの<strong>ロール</strong>や<strong>権限</strong>に基づいてアクセス制御を行うことができます。これにより、機能やデータへのアクセスを細かく制御できます。
                    </p>

                    <pre class="code-block"><code class="language-java">// コントローラーレベルでの権限制御
@Controller
public class AdminController {
    
    // 管理者ロールのみアクセス可能
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/admin/users")
    public String manageUsers(Model model) {
        // ユーザー管理画面
        return "admin/users";
    }
    
    // 特定の権限を持つユーザーのみアクセス可能
    @PreAuthorize("hasAuthority('USER_WRITE')")
    @PostMapping("/admin/users/{id}/delete")
    public String deleteUser(@PathVariable Long id) {
        // ユーザー削除処理
        return "redirect:/admin/users";
    }
}</code></pre>

                    <pre class="code-block"><code class="language-html">&lt;!-- Thymeleafでの権限制御表示 --&gt;
&lt;div sec:authorize="hasRole('ADMIN')"&gt;
    &lt;a href="/admin/dashboard" class="btn btn-warning"&gt;管理者ダッシュボード&lt;/a&gt;
&lt;/div&gt;

&lt;div sec:authorize="hasRole('USER')"&gt;
    &lt;p&gt;ユーザー向けコンテンツ&lt;/p&gt;
&lt;/div&gt;

&lt;div sec:authorize="isAuthenticated()"&gt;
    &lt;p&gt;ようこそ、&lt;span sec:authentication="name"&gt;&lt;/span&gt;さん！&lt;/p&gt;
    &lt;form th:action="@{/logout}" method="post"&gt;
        &lt;button type="submit" class="btn btn-outline-secondary"&gt;ログアウト&lt;/button&gt;
    &lt;/form&gt;
&lt;/div&gt;</code></pre>

                    <div class="highlight">
                        <h6>Spring Securityの権限制御方法</h6>
                        <ul>
                            <li><strong>URL制御</strong>: SecurityFilterChainで設定</li>
                            <li><strong>メソッド制御</strong>: @PreAuthorize、@PostAuthorizeアノテーション</li>
                            <li><strong>画面制御</strong>: Thymeleafのsec:authorize属性</li>
                        </ul>
                    </div>

                    <!-- 実習7-2 -->
                    <div class="exercise-container">
                        <h5>実習 7-2: ユーザー登録機能の実装</h5>
                        <p>新規ユーザーの登録機能を実装し、パスワードのハッシュ化とロール設定を行ってみましょう。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>ユーザー登録フォームを作成</li>
                            <li>UserRegistrationServiceを実装</li>
                            <li>パスワードのハッシュ化を設定</li>
                            <li>デフォルトロール（USER）を設定</li>
                        </ol>

                        <h6>UserRegistrationService.java</h6>
                        <pre class="code-block"><code class="language-java">@Service
public class UserRegistrationService {
    
    @Autowired
    private AppUserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    public AppUser registerUser(String username, String password, String email) {
        // パスワードをハッシュ化
        String hashedPassword = passwordEncoder.encode(password);
        
        AppUser user = new AppUser();
        user.setUsername(username);
        user.setPassword(hashedPassword);
        user.setEmail(email);
        user.setRole("USER");  // デフォルトロール
        user.setEnabled(true);
        
        return userRepository.save(user);
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>新規ユーザーが正常に登録され、ハッシュ化されたパスワードでログインできることを確認できます。</p>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>認証（Authentication）と認可（Authorization）の違いを、具体例を挙げて説明してください。</li>
                            <li>Spring Securityの基本的な処理フローを、SecurityFilterChainの役割と合わせて説明してください。</li>
                            <li>パスワードハッシュ化が重要な理由と、BCryptPasswordEncoderの特徴を説明してください。</li>
                            <li>@PreAuthorizeアノテーションとURL制御の使い分けについて説明してください。</li>
                            <li>Thymeleafでsec:authorize属性を使用する利点を説明してください。</li>
                            <li>UserDetailsServiceの役割と、カスタム実装が必要な理由を説明してください。</li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="spring-learning-material-6.html" class="btn btn-secondary">← 第6章: 入力バリデーションとエラーハンドリング</a>
                        <a href="spring-learning-material-8.html" class="btn btn-primary">第8章: Spring MVCのテスト →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 F-Circle All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>