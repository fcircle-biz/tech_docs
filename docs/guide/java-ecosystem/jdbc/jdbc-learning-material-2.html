<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDBC学習教材 第2章 - データベース接続</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../../index.html">JDBC学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">学習ガイド</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="README.md">JDBC</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-1.html">第1章: JDBCの基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="jdbc-learning-material-2.html">第2章: データベース接続</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-3.html">第3章: 基本的なCRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-4.html">第4章: 例外処理とリソース管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-5.html">第5章: 高度なJDBC機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-6.html">第6章: JDBCとオブジェクト指向設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-7.html">第7章: パフォーマンスとセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-8.html">第8章: 総合プロジェクト</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-9.html">第9章: JDBCリファレンス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-10.html">第10章: データベース固有の設定</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第2章: データベース接続</h1>
                </div>

                <div id="chapter2">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">データベースとの架け橋を築く</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>DriverManagerクラスの役割と使用方法</li>
                            <li>Connection、Statement、ResultSetの基本概念と関係</li>
                            <li>JDBC URLの構成要素と意味を理解する</li>
                            <li>実際のデータベース接続プログラムの作成</li>
                            <li>データベース接続時によくある問題と対処法</li>
                        </ul>
                    </div>

                    <!-- セクション1: DriverManagerクラス -->
                    <h3 class="section-title">2.1 DriverManagerクラスの役割</h3>
                    <p>DriverManagerは、JDBCにおけるデータベース接続管理の中心的な役割を担うクラスです。このクラスは、複数のJDBCドライバを管理し、適切なドライバを自動的に選択してデータベースとの接続を確立します。</p>

                    <div class="highlight">
                        <h6>DriverManagerが行う主な処理</h6>
                        <ol>
                            <li><strong>ドライバの登録</strong>：利用可能なJDBCドライバを内部リストに登録</li>
                            <li><strong>ドライバの選択</strong>：JDBC URLに基づいて最適なドライバを選択</li>
                            <li><strong>接続の確立</strong>：選択されたドライバを使用してデータベース接続を作成</li>
                            <li><strong>接続の管理</strong>：作成された接続の基本的な管理を行う</li>
                        </ol>
                    </div>

                    <div class="mermaid">
                        flowchart TD
                            A["アプリケーション"] --> B["DriverManager.getConnection()"]
                            B --> C{JDBC URLを解析}
                            C --> D["適切なドライバを選択"]
                            D --> E["PostgreSQL Driver"]
                            D --> F["MySQL Driver"]
                            D --> G["Oracle Driver"]
                            E --> H["Connection オブジェクト作成"]
                            F --> H
                            G --> H
                            H --> I["データベース接続確立"]
                            
                            style A fill:#e1f5fe
                            style B fill:#fff3e0
                            style H fill:#e8f5e8
                            style I fill:#f3e5f5
                    </div>

                    <p>DriverManagerを使用した基本的な接続パターン：</p>
                    <pre class="code-block"><code class="language-java">// 基本的な接続パターン
String url = "jdbc:postgresql://localhost:5432/sample_db";
String username = "postgres";
String password = "password";

Connection connection = DriverManager.getConnection(url, username, password);</code></pre>

                    <!-- セクション2: JDBC URLの構造 -->
                    <h3 class="section-title">2.2 JDBC URLの構造と意味</h3>
                    <p>JDBC URLは、データベースの場所や接続に必要な情報を指定するための文字列です。URLの各部分には重要な意味があり、正しく理解することで様々な接続設定に対応できます。</p>

                    <div class="mermaid">
                        flowchart LR
                            A["jdbc:"] --> B["postgresql:"]
                            B --> C["//localhost:5432/"]
                            C --> D["sample_db"]
                            D --> E["?ssl=true&amp;charset=utf8"]
                            
                            A1["プロトコル"] -.-> A
                            B1["データベースの種類"] -.-> B
                            C1["ホスト名:ポート番号"] -.-> C
                            D1["データベース名"] -.-> D
                            E1["接続パラメータ"] -.-> E
                            
                            style A fill:#ffecb3
                            style B fill:#e8f5e8
                            style C fill:#e1f5fe
                            style D fill:#f3e5f5
                            style E fill:#fff3e0
                    </div>

                    <p>各データベースのJDBC URL形式：</p>
                    <ul>
                        <li><strong>PostgreSQL</strong>: <code>jdbc:postgresql://ホスト名:ポート/データベース名</code></li>
                        <li><strong>MySQL</strong>: <code>jdbc:mysql://ホスト名:ポート/データベース名</code></li>
                        <li><strong>Oracle</strong>: <code>jdbc:oracle:thin:@ホスト名:ポート:SID</code></li>
                        <li><strong>SQL Server</strong>: <code>jdbc:sqlserver://ホスト名:ポート;databaseName=データベース名</code></li>
                    </ul>

                    <!-- セクション3: Connection、Statement、ResultSetの関係 -->
                    <h3 class="section-title">2.3 JDBCオブジェクトの階層構造</h3>
                    <p>JDBCでは、データベース操作を行うために3つの主要なオブジェクトが階層的に連携します。それぞれの役割を理解することで、効率的なデータベースプログラムを作成できます。</p>

                    <div class="mermaid">
                        flowchart TD
                            A["Connection<br/>(データベース接続)"] --> B["Statement<br/>(SQL実行器)"]
                            B --> C["ResultSet<br/>(結果セット)"]
                            
                            A1["• 接続管理<br/>• トランザクション制御<br/>• メタデータ取得"] -.-> A
                            B1["• SQL文実行<br/>• パラメータ設定<br/>• バッチ処理"] -.-> B
                            C1["• 行データ取得<br/>• カーソル操作<br/>• データ型変換"] -.-> C
                            
                            style A fill:#e1f5fe
                            style B fill:#fff3e0
                            style C fill:#e8f5e8
                    </div>

                    <h4>Connectionオブジェクト</h4>
                    <p>Connectionは、データベースとの物理的な接続を表すオブジェクトです。一つのConnectionオブジェクトから複数のStatementを作成することができます。</p>
                    <ul>
                        <li><strong>接続管理</strong>：データベースとの接続状態を維持</li>
                        <li><strong>トランザクション制御</strong>：commit、rollbackの実行</li>
                        <li><strong>Statement作成</strong>：SQL実行用のStatementオブジェクト生成</li>
                        <li><strong>メタデータ取得</strong>：データベースの構造情報取得</li>
                    </ul>

                    <h4>Statementオブジェクト</h4>
                    <p>StatementはSQL文を実行するためのオブジェクトです。JDBCでは用途に応じて3種類のStatementが用意されています。</p>
                    <ul>
                        <li><strong>Statement</strong>：基本的なSQL実行（パラメータなし）</li>
                        <li><strong>PreparedStatement</strong>：パラメータ付きSQL実行（推奨）</li>
                        <li><strong>CallableStatement</strong>：ストアドプロシージャ実行</li>
                    </ul>

                    <h4>ResultSetオブジェクト</h4>
                    <p>ResultSetは、SELECT文の実行結果を表すオブジェクトです。テーブル形式のデータを行単位で取得できます。</p>
                    <ul>
                        <li><strong>行移動</strong>：next()メソッドで次の行に移動</li>
                        <li><strong>データ取得</strong>：getXxx()メソッドで列データ取得</li>
                        <li><strong>型変換</strong>：Java型への自動変換</li>
                        <li><strong>NULL処理</strong>：NULL値の適切な処理</li>
                    </ul>

                    <!-- 実習セクション1 -->
                    <div class="exercise-container">
                        <h5>実習 2-1: 基本的なデータベース接続</h5>
                        <p>PostgreSQLデータベースに接続し、基本的な情報を取得するプログラムを作成します。</p>
                        
                        <h6>事前準備</h6>
                        <ol>
                            <li>PostgreSQLサーバーが起動していることを確認</li>
                            <li>テスト用データベース「testdb」を作成</li>
                            <li>PostgreSQL JDBCドライバがクラスパスに設定されていることを確認</li>
                        </ol>

                        <h6>プログラム例</h6>
                        <pre class="code-block"><code class="language-java">import java.sql.*;

public class DatabaseConnection {
    public static void main(String[] args) {
        // データベース接続情報
        String url = "jdbc:postgresql://localhost:5432/testdb";
        String username = "postgres";
        String password = "password";
        
        Connection connection = null;
        
        try {
            // データベースに接続
            connection = DriverManager.getConnection(url, username, password);
            System.out.println("データベース接続に成功しました！");
            
            // データベースの基本情報を取得
            DatabaseMetaData metaData = connection.getMetaData();
            System.out.println("データベース製品名: " + metaData.getDatabaseProductName());
            System.out.println("データベースバージョン: " + metaData.getDatabaseProductVersion());
            System.out.println("JDBCドライババージョン: " + metaData.getDriverVersion());
            
        } catch (SQLException e) {
            System.err.println("データベース接続エラー: " + e.getMessage());
        } finally {
            // 接続を閉じる
            if (connection != null) {
                try {
                    connection.close();
                    System.out.println("データベース接続を閉じました。");
                } catch (SQLException e) {
                    System.err.println("接続終了時エラー: " + e.getMessage());
                }
            }
        }
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash">データベース接続に成功しました！
データベース製品名: PostgreSQL
データベースバージョン: 12.4
JDBCドライババージョン: 42.2.18
データベース接続を閉じました。</code></pre>
                    </div>

                    <!-- セクション4: 接続パラメータとオプション -->
                    <h3 class="section-title">2.4 接続パラメータとオプション設定</h3>
                    <p>JDBC URLには、データベースの動作を制御する様々なパラメータを指定できます。これらのパラメータを理解することで、より効率的で安全な接続を実現できます。</p>

                    <h4>PostgreSQL接続パラメータの例</h4>
                    <pre class="code-block"><code class="language-java">// SSL接続を有効にする
String url = "jdbc:postgresql://localhost:5432/testdb?ssl=true";

// 文字エンコーディングを指定
String url = "jdbc:postgresql://localhost:5432/testdb?characterEncoding=utf8";

// 接続タイムアウトを設定（秒）
String url = "jdbc:postgresql://localhost:5432/testdb?loginTimeout=30";

// 複数パラメータの組み合わせ
String url = "jdbc:postgresql://localhost:5432/testdb?ssl=true&characterEncoding=utf8&loginTimeout=30";</code></pre>

                    <div class="highlight">
                        <h6>よく使用される接続パラメータ</h6>
                        <ul>
                            <li><strong>ssl</strong>：SSL暗号化通信の有効/無効</li>
                            <li><strong>characterEncoding</strong>：文字エンコーディング設定</li>
                            <li><strong>loginTimeout</strong>：接続タイムアウト時間（秒）</li>
                            <li><strong>socketTimeout</strong>：ソケットタイムアウト時間（秒）</li>
                            <li><strong>autoReconnect</strong>：自動再接続の有効/無効</li>
                        </ul>
                    </div>

                    <!-- セクション5: 接続時の問題と対処法 -->
                    <h3 class="section-title">2.5 接続時によくある問題と対処法</h3>
                    <p>データベース接続時には様々な問題が発生する可能性があります。代表的な問題と対処法を理解しておくことで、トラブルシューティングが迅速に行えます。</p>

                    <div class="warning">
                        <h6>よくあるエラーと対処法</h6>
                        <ul>
                            <li><strong>ClassNotFoundException</strong>：JDBCドライバがクラスパスに含まれていない
                                <br>→ ドライバJARファイルをクラスパスに追加</li>
                            <li><strong>SQLException: Connection refused</strong>：データベースサーバーが起動していない
                                <br>→ データベースサーバーの状態確認と起動</li>
                            <li><strong>SQLException: Authentication failed</strong>：ユーザー名またはパスワードが間違っている
                                <br>→ 認証情報の確認と修正</li>
                            <li><strong>SQLException: Database does not exist</strong>：指定されたデータベースが存在しない
                                <br>→ データベース名の確認またはデータベース作成</li>
                        </ul>
                    </div>

                    <!-- 実習セクション2 -->
                    <div class="exercise-container">
                        <h5>実習 2-2: 接続情報を外部ファイルから読み込み</h5>
                        <p>接続情報をプロパティファイルから読み込む、より実践的なプログラムを作成します。</p>
                        
                        <h6>手順1: プロパティファイル作成</h6>
                        <p>database.propertiesファイルを作成：</p>
                        <pre class="code-block"><code class="language-ini"># データベース接続設定
db.url=jdbc:postgresql://localhost:5432/testdb
db.username=postgres
db.password=password
db.driver=org.postgresql.Driver</code></pre>

                        <h6>手順2: プロパティファイルを読み込むプログラム</h6>
                        <pre class="code-block"><code class="language-java">import java.io.*;
import java.sql.*;
import java.util.Properties;

public class DatabaseConnectionWithProperties {
    public static void main(String[] args) {
        Properties props = new Properties();
        Connection connection = null;
        
        try {
            // プロパティファイルを読み込み
            FileInputStream fis = new FileInputStream("database.properties");
            props.load(fis);
            fis.close();
            
            // 接続情報を取得
            String url = props.getProperty("db.url");
            String username = props.getProperty("db.username");
            String password = props.getProperty("db.password");
            String driver = props.getProperty("db.driver");
            
            // ドライバクラスを読み込み（必要に応じて）
            Class.forName(driver);
            
            // データベース接続
            connection = DriverManager.getConnection(url, username, password);
            System.out.println("プロパティファイルを使用した接続に成功しました！");
            
            // 現在の接続情報を表示
            System.out.println("接続URL: " + connection.getMetaData().getURL());
            System.out.println("ユーザー名: " + connection.getMetaData().getUserName());
            
        } catch (IOException e) {
            System.err.println("プロパティファイル読み込みエラー: " + e.getMessage());
        } catch (ClassNotFoundException e) {
            System.err.println("JDBCドライバクラスが見つかりません: " + e.getMessage());
        } catch (SQLException e) {
            System.err.println("データベースエラー: " + e.getMessage());
        } finally {
            if (connection != null) {
                try {
                    connection.close();
                } catch (SQLException e) {
                    System.err.println("接続終了時エラー: " + e.getMessage());
                }
            }
        }
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash">プロパティファイルを使用した接続に成功しました！
接続URL: jdbc:postgresql://localhost:5432/testdb
ユーザー名: postgres</code></pre>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>DriverManagerクラスの主な役割を3つ説明してください。</li>
                            <li>JDBC URL「jdbc:postgresql://localhost:5432/mydb?ssl=true」の各部分の意味を説明してください。</li>
                            <li>Connection、Statement、ResultSetの関係を図で描いて説明してください。</li>
                            <li>「SQLException: Connection refused」エラーが発生した場合の主な原因と対処法を述べてください。</li>
                            <li>データベース接続情報をハードコードせずに管理する方法とその利点を説明してください。</li>
                        </ol>
                        
                        <details>
                            <summary>解答例を見る</summary>
                            <ol>
                                <li>DriverManagerの役割：(1)ドライバの登録・管理、(2)JDBC URLに基づく適切なドライバの選択、(3)データベース接続の確立</li>
                                <li>URL構成：「jdbc:」プロトコル指定、「postgresql:」DB種別、「//localhost:5432/」ホストとポート、「mydb」DB名、「?ssl=true」接続パラメータ</li>
                                <li>Connection→Statement→ResultSetの順で階層的に作成され、Connectionから複数Statement、StatementからResultSetが生成される</li>
                                <li>原因：データベースサーバー未起動、ポート設定誤り、ファイアウォール。対処：サーバー起動確認、ポート番号確認、ネットワーク設定確認</li>
                                <li>プロパティファイル使用の利点：設定変更時の再コンパイル不要、環境別設定の管理容易、セキュリティ向上</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="jdbc-learning-material-1.html" class="btn btn-secondary">← 前の章：JDBCの基礎</a>
                        <a href="jdbc-learning-material-3.html" class="btn btn-primary">次の章：基本的なCRUD操作 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>