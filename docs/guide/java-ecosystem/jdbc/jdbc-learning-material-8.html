<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDBC学習教材 第8章 - 総合プロジェクト</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../../index.html">JDBC学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">学習ガイド</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="README.md">JDBC</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-1.html">第1章: JDBCの基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-2.html">第2章: データベース接続</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-3.html">第3章: 基本的なCRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-4.html">第4章: 例外処理とリソース管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-5.html">第5章: 高度なJDBC機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-6.html">第6章: JDBCとオブジェクト指向設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-7.html">第7章: パフォーマンスとセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="jdbc-learning-material-8.html">第8章: 総合プロジェクト</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-9.html">第9章: JDBCリファレンス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-10.html">第10章: データベース固有の設定</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第8章: 総合プロジェクト - 図書館管理システム</h1>
                </div>

                <div id="chapter8">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">実践的なJDBCアプリケーションの構築</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>要件分析からデータベース設計まで一連の設計プロセス</li>
                            <li>レイヤー化アーキテクチャの実装</li>
                            <li>データアクセス層（DAO）の構築</li>
                            <li>ビジネスロジック層の実装</li>
                            <li>コンソールベースのユーザーインターフェース作成</li>
                            <li>統合テストとドキュメント作成</li>
                        </ul>
                    </div>

                    <!-- セクション1: プロジェクト概要と要件定義 -->
                    <h3 class="section-title">8.1 図書館管理システムの要件定義</h3>
                    <p>図書館管理システムは、書籍の貸出・返却、会員管理、在庫管理などの基本的な図書館業務をサポートするシステムです。このプロジェクトを通じて、これまで学習したJDBCの技術を実際のアプリケーション開発に応用します。</p>

                    <div class="mermaid">
                        flowchart TB
                            A[図書館管理システム] --> B[書籍管理]
                            A --> C[会員管理]
                            A --> D[貸出・返却管理]
                            
                            B --> B1[書籍登録・編集・削除]
                            B --> B2[書籍検索・一覧表示]
                            B --> B3[在庫状況確認]
                            
                            C --> C1[会員登録・編集・削除]
                            C --> C2[会員情報検索]
                            C --> C3[貸出履歴確認]
                            
                            D --> D1[書籍貸出処理]
                            D --> D2[書籍返却処理]
                            D --> D3[延滞管理]
                    </div>

                    <h4>システム要件</h4>
                    <ul>
                        <li><strong>機能要件</strong>：
                            <ul>
                                <li>書籍の基本管理（追加、編集、削除、検索）</li>
                                <li>会員の基本管理（登録、編集、削除、検索）</li>
                                <li>貸出・返却処理とそれに伴う在庫管理</li>
                                <li>貸出履歴の管理と延滞チェック</li>
                                <li>各種統計レポート（人気書籍、延滞状況など）</li>
                            </ul>
                        </li>
                        <li><strong>非機能要件</strong>：
                            <ul>
                                <li>データの整合性保証（トランザクション処理）</li>
                                <li>適切なエラーハンドリングと例外処理</li>
                                <li>SQLインジェクション対策</li>
                                <li>保守性の高いコード設計（レイヤー化、DAO パターン）</li>
                            </ul>
                        </li>
                    </ul>

                    <!-- セクション2: データベース設計 -->
                    <h3 class="section-title">8.2 データベース設計とテーブル構造</h3>
                    <p>図書館管理システムに必要なテーブル構造を設計し、適切な制約とリレーションシップを定義します。</p>

                    <!-- 実習1: データベース設計 -->
                    <div class="exercise-container">
                        <h5>実習 8-1: データベーススキーマの作成</h5>
                        <p>図書館管理システムに必要なテーブルを設計し、DDL文を作成します。</p>

                        <h6>ER図による設計</h6>
                        <div class="mermaid">
                            erDiagram
                                BOOKS {
                                    int book_id PK
                                    string isbn UK
                                    string title
                                    string author
                                    string publisher
                                    int publication_year
                                    string category
                                    int total_copies
                                    int available_copies
                                    timestamp created_at
                                    timestamp updated_at
                                }
                                
                                MEMBERS {
                                    int member_id PK
                                    string membership_number UK
                                    string name
                                    string email UK
                                    string phone
                                    string address
                                    date join_date
                                    string status
                                    timestamp created_at
                                    timestamp updated_at
                                }
                                
                                LOANS {
                                    int loan_id PK
                                    int book_id FK
                                    int member_id FK
                                    date loan_date
                                    date due_date
                                    date return_date
                                    string status
                                    timestamp created_at
                                    timestamp updated_at
                                }
                                
                                BOOKS ||--o{ LOANS : "has"
                                MEMBERS ||--o{ LOANS : "borrows"
                        </div>

                        <h6>テーブル作成SQL</h6>
                        <pre class="code-block"><code class="language-sql">-- 図書館管理システムのデータベース作成
CREATE DATABASE library_management;

-- 書籍テーブル
CREATE TABLE books (
    book_id SERIAL PRIMARY KEY,
    isbn VARCHAR(20) UNIQUE NOT NULL,
    title VARCHAR(255) NOT NULL,
    author VARCHAR(255) NOT NULL,
    publisher VARCHAR(255),
    publication_year INTEGER CHECK (publication_year > 1000 AND publication_year <= EXTRACT(YEAR FROM CURRENT_DATE)),
    category VARCHAR(100),
    total_copies INTEGER NOT NULL DEFAULT 1 CHECK (total_copies > 0),
    available_copies INTEGER NOT NULL DEFAULT 1 CHECK (available_copies >= 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_available_copies CHECK (available_copies <= total_copies)
);

-- 会員テーブル
CREATE TABLE members (
    member_id SERIAL PRIMARY KEY,
    membership_number VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    join_date DATE NOT NULL DEFAULT CURRENT_DATE,
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE' CHECK (status IN ('ACTIVE', 'INACTIVE', 'SUSPENDED')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 貸出テーブル
CREATE TABLE loans (
    loan_id SERIAL PRIMARY KEY,
    book_id INTEGER NOT NULL REFERENCES books(book_id),
    member_id INTEGER NOT NULL REFERENCES members(member_id),
    loan_date DATE NOT NULL DEFAULT CURRENT_DATE,
    due_date DATE NOT NULL,
    return_date DATE,
    status VARCHAR(20) NOT NULL DEFAULT 'BORROWED' CHECK (status IN ('BORROWED', 'RETURNED', 'OVERDUE')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_due_date CHECK (due_date > loan_date),
    CONSTRAINT check_return_date CHECK (return_date IS NULL OR return_date >= loan_date)
);

-- インデックスの作成（検索性能向上）
CREATE INDEX idx_books_title ON books(title);
CREATE INDEX idx_books_author ON books(author);
CREATE INDEX idx_books_category ON books(category);
CREATE INDEX idx_members_name ON members(name);
CREATE INDEX idx_members_email ON members(email);
CREATE INDEX idx_loans_status ON loans(status);
CREATE INDEX idx_loans_due_date ON loans(due_date);

-- 初期データの投入
INSERT INTO books (isbn, title, author, publisher, publication_year, category, total_copies, available_copies) VALUES
('978-4-7981-6804-6', 'Java言語で学ぶデザインパターン入門', '結城浩', 'SBクリエイティブ', 2020, 'プログラミング', 3, 3),
('978-4-295-00712-4', 'スッキリわかるJava入門', '中山清喬', 'インプレス', 2019, 'プログラミング', 5, 5),
('978-4-8156-0651-4', 'データベース設計概論', '黒田久泰', 'インプレス', 2018, 'データベース', 2, 2),
('978-4-7741-9763-0', '改訂新版JavaScript本格入門', '山田祥寛', '技術評論社', 2020, 'プログラミング', 4, 4),
('978-4-295-01067-4', 'Python機械学習プログラミング', '石井一夫', 'インプレス', 2021, 'AI・機械学習', 3, 3);

INSERT INTO members (membership_number, name, email, phone, address) VALUES
('M001', '田中太郎', 'tanaka@example.com', '090-1234-5678', '東京都渋谷区1-2-3'),
('M002', '佐藤花子', 'sato@example.com', '080-9876-5432', '大阪府大阪市2-3-4'),
('M003', '山田次郎', 'yamada@example.com', '070-5555-1111', '愛知県名古屋市3-4-5'),
('M004', '鈴木美咲', 'suzuki@example.com', '090-7777-2222', '福岡県福岡市4-5-6');</code></pre>

                        <h6>期待される結果</h6>
                        <p>正規化された適切なテーブル構造が作成され、参照整合性制約とビジネスルールを反映した制約が適用されます。初期データにより、開発とテストに必要な基本データが準備されます。</p>
                    </div>

                    <!-- セクション3: アーキテクチャ設計 -->
                    <h3 class="section-title">8.3 レイヤー化アーキテクチャの実装</h3>
                    <p>保守性と拡張性を重視したレイヤー化アーキテクチャを採用し、各層の責任を明確に分離します。</p>

                    <div class="mermaid">
                        flowchart TB
                            subgraph "プレゼンテーション層"
                                A[LibraryManagementUI]
                                A1[メニュー表示]
                                A2[ユーザー入力処理]
                                A3[結果表示]
                            end
                            
                            subgraph "ビジネスロジック層"
                                B[LibraryService]
                                B1[貸出ビジネスロジック]
                                B2[在庫管理ロジック]
                                B3[延滞チェック]
                            end
                            
                            subgraph "データアクセス層"
                                C[BookDAO]
                                C1[MemberDAO]
                                C2[LoanDAO]
                            end
                            
                            subgraph "データ層"
                                D[PostgreSQLデータベース]
                            end
                            
                            A --> B
                            B --> C
                            B --> C1
                            B --> C2
                            C --> D
                            C1 --> D
                            C2 --> D
                    </div>

                    <!-- 実習2: Entity クラスの実装 -->
                    <div class="exercise-container">
                        <h5>実習 8-2: エンティティクラスの実装</h5>
                        <p>データベーステーブルに対応するエンティティクラスを実装します。</p>

                        <h6>Bookエンティティクラス</h6>
                        <pre class="code-block"><code class="language-java">import java.time.LocalDateTime;
import java.util.Objects;

/**
 * 書籍エンティティクラス
 */
public class Book {
    private Integer bookId;
    private String isbn;
    private String title;
    private String author;
    private String publisher;
    private Integer publicationYear;
    private String category;
    private Integer totalCopies;
    private Integer availableCopies;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    // デフォルトコンストラクタ
    public Book() {}
    
    // 全フィールドコンストラクタ
    public Book(Integer bookId, String isbn, String title, String author,
                String publisher, Integer publicationYear, String category,
                Integer totalCopies, Integer availableCopies,
                LocalDateTime createdAt, LocalDateTime updatedAt) {
        this.bookId = bookId;
        this.isbn = isbn;
        this.title = title;
        this.author = author;
        this.publisher = publisher;
        this.publicationYear = publicationYear;
        this.category = category;
        this.totalCopies = totalCopies;
        this.availableCopies = availableCopies;
        this.createdAt = createdAt;
        this.updatedAt = updatedAt;
    }
    
    // 新規書籍作成用コンストラクタ
    public Book(String isbn, String title, String author, String publisher,
                Integer publicationYear, String category, Integer totalCopies) {
        this.isbn = isbn;
        this.title = title;
        this.author = author;
        this.publisher = publisher;
        this.publicationYear = publicationYear;
        this.category = category;
        this.totalCopies = totalCopies;
        this.availableCopies = totalCopies; // 初期状態では全て利用可能
    }
    
    // ビジネスメソッド
    public boolean isAvailable() {
        return availableCopies != null && availableCopies > 0;
    }
    
    public boolean canBorrow(int requestedCopies) {
        return isAvailable() && availableCopies >= requestedCopies;
    }
    
    public void borrowCopy() {
        if (canBorrow(1)) {
            availableCopies--;
        } else {
            throw new IllegalStateException("この書籍は現在貸出できません");
        }
    }
    
    public void returnCopy() {
        if (availableCopies < totalCopies) {
            availableCopies++;
        } else {
            throw new IllegalStateException("返却可能な書籍の上限を超えています");
        }
    }
    
    // Getter/Setter methods
    public Integer getBookId() { return bookId; }
    public void setBookId(Integer bookId) { this.bookId = bookId; }
    
    public String getIsbn() { return isbn; }
    public void setIsbn(String isbn) { this.isbn = isbn; }
    
    public String getTitle() { return title; }
    public void setTitle(String title) { this.title = title; }
    
    public String getAuthor() { return author; }
    public void setAuthor(String author) { this.author = author; }
    
    public String getPublisher() { return publisher; }
    public void setPublisher(String publisher) { this.publisher = publisher; }
    
    public Integer getPublicationYear() { return publicationYear; }
    public void setPublicationYear(Integer publicationYear) { this.publicationYear = publicationYear; }
    
    public String getCategory() { return category; }
    public void setCategory(String category) { this.category = category; }
    
    public Integer getTotalCopies() { return totalCopies; }
    public void setTotalCopies(Integer totalCopies) { this.totalCopies = totalCopies; }
    
    public Integer getAvailableCopies() { return availableCopies; }
    public void setAvailableCopies(Integer availableCopies) { this.availableCopies = availableCopies; }
    
    public LocalDateTime getCreatedAt() { return createdAt; }
    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }
    
    public LocalDateTime getUpdatedAt() { return updatedAt; }
    public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
    
    @Override
    public boolean equals(Object obj) {
        if (this == obj) return true;
        if (obj == null || getClass() != obj.getClass()) return false;
        Book book = (Book) obj;
        return Objects.equals(bookId, book.bookId);
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(bookId);
    }
    
    @Override
    public String toString() {
        return String.format("Book{id=%d, title='%s', author='%s', available=%d/%d}",
                           bookId, title, author, availableCopies, totalCopies);
    }
}</code></pre>

                        <h6>Memberエンティティクラス</h6>
                        <pre class="code-block"><code class="language-java">import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Objects;

/**
 * 会員エンティティクラス
 */
public class Member {
    private Integer memberId;
    private String membershipNumber;
    private String name;
    private String email;
    private String phone;
    private String address;
    private LocalDate joinDate;
    private MemberStatus status;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    public enum MemberStatus {
        ACTIVE, INACTIVE, SUSPENDED
    }
    
    // コンストラクタ
    public Member() {}
    
    public Member(Integer memberId, String membershipNumber, String name, String email,
                  String phone, String address, LocalDate joinDate, MemberStatus status,
                  LocalDateTime createdAt, LocalDateTime updatedAt) {
        this.memberId = memberId;
        this.membershipNumber = membershipNumber;
        this.name = name;
        this.email = email;
        this.phone = phone;
        this.address = address;
        this.joinDate = joinDate;
        this.status = status;
        this.createdAt = createdAt;
        this.updatedAt = updatedAt;
    }
    
    public Member(String membershipNumber, String name, String email, String phone, String address) {
        this.membershipNumber = membershipNumber;
        this.name = name;
        this.email = email;
        this.phone = phone;
        this.address = address;
        this.joinDate = LocalDate.now();
        this.status = MemberStatus.ACTIVE;
    }
    
    // ビジネスメソッド
    public boolean isActive() {
        return status == MemberStatus.ACTIVE;
    }
    
    public boolean canBorrowBooks() {
        return isActive();
    }
    
    public void suspend() {
        this.status = MemberStatus.SUSPENDED;
    }
    
    public void reactivate() {
        this.status = MemberStatus.ACTIVE;
    }
    
    // Getter/Setter methods
    public Integer getMemberId() { return memberId; }
    public void setMemberId(Integer memberId) { this.memberId = memberId; }
    
    public String getMembershipNumber() { return membershipNumber; }
    public void setMembershipNumber(String membershipNumber) { this.membershipNumber = membershipNumber; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    
    public String getPhone() { return phone; }
    public void setPhone(String phone) { this.phone = phone; }
    
    public String getAddress() { return address; }
    public void setAddress(String address) { this.address = address; }
    
    public LocalDate getJoinDate() { return joinDate; }
    public void setJoinDate(LocalDate joinDate) { this.joinDate = joinDate; }
    
    public MemberStatus getStatus() { return status; }
    public void setStatus(MemberStatus status) { this.status = status; }
    
    public LocalDateTime getCreatedAt() { return createdAt; }
    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }
    
    public LocalDateTime getUpdatedAt() { return updatedAt; }
    public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
    
    @Override
    public boolean equals(Object obj) {
        if (this == obj) return true;
        if (obj == null || getClass() != obj.getClass()) return false;
        Member member = (Member) obj;
        return Objects.equals(memberId, member.memberId);
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(memberId);
    }
    
    @Override
    public String toString() {
        return String.format("Member{id=%d, name='%s', number='%s', status=%s}",
                           memberId, name, membershipNumber, status);
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>データベーステーブルに対応した適切なエンティティクラスが作成され、ビジネスロジックに必要なメソッドが実装されます。これらのクラスは後続のDAO層とサービス層で使用されます。</p>
                    </div>

                    <!-- セクション4: データアクセス層の実装 -->
                    <h3 class="section-title">8.4 データアクセス層（DAO）の実装</h3>
                    <p>各エンティティに対応するDAOインターフェースと実装クラスを作成し、データベース操作を抽象化します。</p>

                    <!-- 実習3: BookDAO の実装 -->
                    <div class="exercise-container">
                        <h5>実習 8-3: BookDAO の実装</h5>
                        <p>書籍エンティティに対するデータアクセス機能を実装します。</p>

                        <h6>BookDAO インターフェース</h6>
                        <pre class="code-block"><code class="language-java">import java.util.List;
import java.util.Optional;

/**
 * 書籍データアクセスオブジェクトのインターフェース
 */
public interface BookDAO {
    
    // 基本CRUD操作
    Book create(Book book);
    Optional&lt;Book&gt; findById(Integer id);
    List&lt;Book&gt; findAll();
    boolean update(Book book);
    boolean delete(Integer id);
    
    // 業務固有の検索メソッド
    Optional&lt;Book&gt; findByIsbn(String isbn);
    List&lt;Book&gt; findByTitle(String titlePattern);
    List&lt;Book&gt; findByAuthor(String authorPattern);
    List&lt;Book&gt; findByCategory(String category);
    List&lt;Book&gt; findAvailableBooks();
    
    // 在庫管理メソッド
    boolean updateAvailableCopies(Integer bookId, Integer availableCopies);
    boolean borrowBook(Integer bookId);
    boolean returnBook(Integer bookId);
    
    // 統計・レポート用メソッド
    List&lt;Book&gt; findPopularBooks(int limit);
    long getTotalBooksCount();
    long getAvailableBooksCount();
}</code></pre>

                        <h6>BookDAO 実装クラス（一部）</h6>
                        <pre class="code-block"><code class="language-java">import java.sql.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

/**
 * BookDAOの実装クラス
 */
public class BookDAOImpl implements BookDAO {
    private final DatabaseConnection dbConnection;
    
    public BookDAOImpl() {
        this.dbConnection = DatabaseConnection.getInstance();
    }
    
    @Override
    public Book create(Book book) {
        String sql = "INSERT INTO books (isbn, title, author, publisher, publication_year, " +
                    "category, total_copies, available_copies) " +
                    "VALUES (?, ?, ?, ?, ?, ?, ?, ?) RETURNING book_id, created_at, updated_at";
        
        try (Connection connection = dbConnection.getConnection();
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            statement.setString(1, book.getIsbn());
            statement.setString(2, book.getTitle());
            statement.setString(3, book.getAuthor());
            statement.setString(4, book.getPublisher());
            statement.setInt(5, book.getPublicationYear());
            statement.setString(6, book.getCategory());
            statement.setInt(7, book.getTotalCopies());
            statement.setInt(8, book.getAvailableCopies());
            
            try (ResultSet resultSet = statement.executeQuery()) {
                if (resultSet.next()) {
                    book.setBookId(resultSet.getInt("book_id"));
                    book.setCreatedAt(resultSet.getTimestamp("created_at").toLocalDateTime());
                    book.setUpdatedAt(resultSet.getTimestamp("updated_at").toLocalDateTime());
                    return book;
                }
            }
            
        } catch (SQLException e) {
            System.err.println("書籍作成エラー: " + e.getMessage());
        }
        
        return null;
    }
    
    @Override
    public Optional&lt;Book&gt; findById(Integer id) {
        String sql = "SELECT * FROM books WHERE book_id = ?";
        
        try (Connection connection = dbConnection.getConnection();
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            statement.setInt(1, id);
            
            try (ResultSet resultSet = statement.executeQuery()) {
                if (resultSet.next()) {
                    return Optional.of(mapRowToBook(resultSet));
                }
            }
            
        } catch (SQLException e) {
            System.err.println("書籍検索エラー: " + e.getMessage());
        }
        
        return Optional.empty();
    }
    
    @Override
    public List&lt;Book&gt; findByTitle(String titlePattern) {
        String sql = "SELECT * FROM books WHERE title ILIKE ? ORDER BY title";
        List&lt;Book&gt; books = new ArrayList&lt;&gt;();
        
        try (Connection connection = dbConnection.getConnection();
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            statement.setString(1, "%" + titlePattern + "%");
            
            try (ResultSet resultSet = statement.executeQuery()) {
                while (resultSet.next()) {
                    books.add(mapRowToBook(resultSet));
                }
            }
            
        } catch (SQLException e) {
            System.err.println("タイトル検索エラー: " + e.getMessage());
        }
        
        return books;
    }
    
    @Override
    public List&lt;Book&gt; findAvailableBooks() {
        String sql = "SELECT * FROM books WHERE available_copies > 0 ORDER BY title";
        List&lt;Book&gt; books = new ArrayList&lt;&gt;();
        
        try (Connection connection = dbConnection.getConnection();
             PreparedStatement statement = connection.prepareStatement(sql);
             ResultSet resultSet = statement.executeQuery()) {
            
            while (resultSet.next()) {
                books.add(mapRowToBook(resultSet));
            }
            
        } catch (SQLException e) {
            System.err.println("利用可能書籍検索エラー: " + e.getMessage());
        }
        
        return books;
    }
    
    @Override
    public boolean borrowBook(Integer bookId) {
        String sql = "UPDATE books SET available_copies = available_copies - 1, " +
                    "updated_at = CURRENT_TIMESTAMP WHERE book_id = ? AND available_copies > 0";
        
        try (Connection connection = dbConnection.getConnection();
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            statement.setInt(1, bookId);
            int rowsAffected = statement.executeUpdate();
            return rowsAffected > 0;
            
        } catch (SQLException e) {
            System.err.println("書籍貸出エラー: " + e.getMessage());
            return false;
        }
    }
    
    @Override
    public boolean returnBook(Integer bookId) {
        String sql = "UPDATE books SET available_copies = available_copies + 1, " +
                    "updated_at = CURRENT_TIMESTAMP " +
                    "WHERE book_id = ? AND available_copies < total_copies";
        
        try (Connection connection = dbConnection.getConnection();
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            statement.setInt(1, bookId);
            int rowsAffected = statement.executeUpdate();
            return rowsAffected > 0;
            
        } catch (SQLException e) {
            System.err.println("書籍返却エラー: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * ResultSetからBookオブジェクトにマッピング
     */
    private Book mapRowToBook(ResultSet resultSet) throws SQLException {
        Book book = new Book();
        book.setBookId(resultSet.getInt("book_id"));
        book.setIsbn(resultSet.getString("isbn"));
        book.setTitle(resultSet.getString("title"));
        book.setAuthor(resultSet.getString("author"));
        book.setPublisher(resultSet.getString("publisher"));
        book.setPublicationYear(resultSet.getInt("publication_year"));
        book.setCategory(resultSet.getString("category"));
        book.setTotalCopies(resultSet.getInt("total_copies"));
        book.setAvailableCopies(resultSet.getInt("available_copies"));
        
        Timestamp createdAt = resultSet.getTimestamp("created_at");
        if (createdAt != null) {
            book.setCreatedAt(createdAt.toLocalDateTime());
        }
        
        Timestamp updatedAt = resultSet.getTimestamp("updated_at");
        if (updatedAt != null) {
            book.setUpdatedAt(updatedAt.toLocalDateTime());
        }
        
        return book;
    }
    
    // 他のメソッドも同様に実装...
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>BookDAOにより、書籍データに対する包括的なデータアクセス機能が提供されます。貸出・返却時の在庫管理も含まれ、ビジネスロジック層から簡単に利用できます。</p>
                    </div>

                    <!-- セクション5: サービス層とメインアプリケーション -->
                    <h3 class="section-title">8.5 ビジネスロジック層とメインアプリケーション</h3>
                    <p>複数のDAOを組み合わせて、図書館の貸出・返却業務を実現するビジネスロジック層を実装します。</p>

                    <!-- 実習4: ライブラリサービス -->
                    <div class="exercise-container">
                        <h5>実習 8-4: LibraryService の実装</h5>
                        <p>図書館の主要業務を処理するサービス層を実装し、トランザクション管理を含む複合操作を行います。</p>

                        <h6>LibraryService 実装</h6>
                        <pre class="code-block"><code class="language-java">import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

/**
 * 図書館管理システムのビジネスロジックを提供するサービス
 */
public class LibraryService {
    private final BookDAO bookDAO;
    private final MemberDAO memberDAO;
    private final LoanDAO loanDAO;
    
    // 貸出期間（日数）
    private static final int LOAN_PERIOD_DAYS = 14;
    
    public LibraryService(BookDAO bookDAO, MemberDAO memberDAO, LoanDAO loanDAO) {
        this.bookDAO = bookDAO;
        this.memberDAO = memberDAO;
        this.loanDAO = loanDAO;
    }
    
    /**
     * 書籍貸出処理
     * @param bookId 書籍ID
     * @param memberId 会員ID
     * @return 貸出が成功した場合のLoanオブジェクト
     */
    public Optional&lt;Loan&gt; borrowBook(Integer bookId, Integer memberId) {
        try {
            // 1. 書籍の存在と利用可能性確認
            Optional&lt;Book&gt; bookOpt = bookDAO.findById(bookId);
            if (!bookOpt.isPresent()) {
                System.err.println("指定された書籍が見つかりません: " + bookId);
                return Optional.empty();
            }
            
            Book book = bookOpt.get();
            if (!book.isAvailable()) {
                System.err.println("書籍は現在貸出中です: " + book.getTitle());
                return Optional.empty();
            }
            
            // 2. 会員の存在と貸出可能性確認
            Optional&lt;Member&gt; memberOpt = memberDAO.findById(memberId);
            if (!memberOpt.isPresent()) {
                System.err.println("指定された会員が見つかりません: " + memberId);
                return Optional.empty();
            }
            
            Member member = memberOpt.get();
            if (!member.canBorrowBooks()) {
                System.err.println("会員は現在書籍を借りることができません: " + member.getName());
                return Optional.empty();
            }
            
            // 3. 会員の未返却書籍数チェック（最大5冊まで）
            List&lt;Loan&gt; currentLoans = loanDAO.findActiveLoansByMemberId(memberId);
            if (currentLoans.size() >= 5) {
                System.err.println("貸出上限に達しています。現在の貸出数: " + currentLoans.size());
                return Optional.empty();
            }
            
            // 4. 貸出記録の作成
            LocalDate loanDate = LocalDate.now();
            LocalDate dueDate = loanDate.plusDays(LOAN_PERIOD_DAYS);
            
            Loan loan = new Loan(bookId, memberId, loanDate, dueDate);
            
            // 5. トランザクション処理：貸出記録作成 + 在庫減少
            Loan createdLoan = loanDAO.create(loan);
            if (createdLoan != null && bookDAO.borrowBook(bookId)) {
                System.out.println("貸出処理が完了しました:");
                System.out.println("書籍: " + book.getTitle());
                System.out.println("会員: " + member.getName());
                System.out.println("返却期限: " + dueDate);
                return Optional.of(createdLoan);
            } else {
                System.err.println("貸出処理中にエラーが発生しました");
                return Optional.empty();
            }
            
        } catch (Exception e) {
            System.err.println("貸出処理でエラーが発生しました: " + e.getMessage());
            return Optional.empty();
        }
    }
    
    /**
     * 書籍返却処理
     * @param loanId 貸出ID
     * @return 返却が成功した場合true
     */
    public boolean returnBook(Integer loanId) {
        try {
            // 1. 貸出記録の確認
            Optional&lt;Loan&gt; loanOpt = loanDAO.findById(loanId);
            if (!loanOpt.isPresent()) {
                System.err.println("指定された貸出記録が見つかりません: " + loanId);
                return false;
            }
            
            Loan loan = loanOpt.get();
            if (loan.getStatus() != Loan.LoanStatus.BORROWED) {
                System.err.println("この貸出は既に返却済みです");
                return false;
            }
            
            // 2. 書籍情報の取得
            Optional&lt;Book&gt; bookOpt = bookDAO.findById(loan.getBookId());
            Optional&lt;Member&gt; memberOpt = memberDAO.findById(loan.getMemberId());
            
            if (!bookOpt.isPresent() || !memberOpt.isPresent()) {
                System.err.println("書籍または会員の情報が見つかりません");
                return false;
            }
            
            // 3. 延滞チェック
            LocalDate today = LocalDate.now();
            boolean isOverdue = today.isAfter(loan.getDueDate());
            
            // 4. トランザクション処理：返却記録更新 + 在庫増加
            loan.setReturnDate(today);
            loan.setStatus(Loan.LoanStatus.RETURNED);
            
            if (loanDAO.update(loan) && bookDAO.returnBook(loan.getBookId())) {
                System.out.println("返却処理が完了しました:");
                System.out.println("書籍: " + bookOpt.get().getTitle());
                System.out.println("会員: " + memberOpt.get().getName());
                
                if (isOverdue) {
                    long overdueDays = today.toEpochDay() - loan.getDueDate().toEpochDay();
                    System.out.println("注意: " + overdueDays + "日延滞していました");
                    // 実際のシステムでは延滞料金の計算なども行う
                }
                
                return true;
            } else {
                System.err.println("返却処理中にエラーが発生しました");
                return false;
            }
            
        } catch (Exception e) {
            System.err.println("返却処理でエラーが発生しました: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * 会員の貸出履歴取得
     */
    public List&lt;Loan&gt; getMemberLoanHistory(Integer memberId) {
        return loanDAO.findLoansByMemberId(memberId);
    }
    
    /**
     * 延滞書籍のリスト取得
     */
    public List&lt;Loan&gt; getOverdueLoans() {
        return loanDAO.findOverdueLoans();
    }
    
    /**
     * 人気書籍ランキング取得
     */
    public List&lt;Book&gt; getPopularBooks(int limit) {
        return bookDAO.findPopularBooks(limit);
    }
    
    /**
     * システム統計情報取得
     */
    public LibraryStatistics getStatistics() {
        long totalBooks = bookDAO.getTotalBooksCount();
        long availableBooks = bookDAO.getAvailableBooksCount();
        long totalMembers = memberDAO.getTotalMembersCount();
        long activeLoans = loanDAO.getActiveLoanCount();
        long overdueLoans = loanDAO.getOverdueLoanCount();
        
        return new LibraryStatistics(totalBooks, availableBooks, totalMembers, 
                                   activeLoans, overdueLoans);
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>LibraryServiceにより、複雑な貸出・返却業務が適切なトランザクション管理の下で実行されます。ビジネスルールの検証、エラーハンドリング、統計情報の提供など、実際の図書館システムに必要な機能が実装されます。</p>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>総合プロジェクト理解度確認</h5>
                        <ol>
                            <li>
                                <p><strong>図書館管理システムで実装したレイヤー化アーキテクチャの各層の役割を説明し、このアーキテクチャの利点を3つ挙げてください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>BookDAOのborrowBook()メソッドとLibraryServiceのborrowBook()メソッドの違いと、それぞれの役割を説明してください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>書籍貸出処理でトランザクション管理が必要な理由を、具体的な処理手順と共に説明してください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>システムの拡張性を考慮した場合、現在の設計にどのような改善を加えることができますか？3つ提案してください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>実際の図書館システムを本番運用する場合、追加で考慮すべきセキュリティ対策と非機能要件を整理してください。</strong></p>
                            </li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="jdbc-learning-material-7.html" class="btn btn-secondary">← 前の章</a>
                        <a href="jdbc-learning-material-9.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>