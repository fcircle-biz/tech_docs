<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDBC学習教材 第9章 - JDBCリファレンス</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        /* 参照テーブル用のスタイル */
        .reference-table {
            margin: 1rem 0;
        }

        .reference-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../../index.html">JDBC学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">学習ガイド</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="README.md">JDBC</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-1.html">第1章: JDBCの基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-2.html">第2章: データベース接続</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-3.html">第3章: 基本的なCRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-4.html">第4章: 例外処理とリソース管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-5.html">第5章: 高度なJDBC機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-6.html">第6章: JDBCとオブジェクト指向設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-7.html">第7章: パフォーマンスとセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-8.html">第8章: 総合プロジェクト</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="jdbc-learning-material-9.html">第9章: JDBCリファレンス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-10.html">第10章: データベース固有の設定</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第9章: JDBCリファレンス</h1>
                </div>

                <div id="chapter9">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">実践的なJDBCプログラミング参考資料</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>JDBCの主要クラスとインターフェースの詳細</li>
                            <li>JavaとPostgreSQLのデータ型マッピング</li>
                            <li>一般的なエラーコードと対処法</li>
                            <li>デバッグとトラブルシューティングのテクニック</li>
                            <li>パフォーマンス最適化のチェックリスト</li>
                        </ul>
                    </div>

                    <!-- セクション1: 主要クラスとメソッド -->
                    <h3 class="section-title">9.1 JDBC主要クラス・インターフェース一覧</h3>
                    <p>JDBCプログラミングで頻繁に使用される主要なクラスとインターフェースの詳細な参考情報を提供します。</p>

                    <div class="mermaid">
                        classDiagram
                            class DriverManager {
                                +getConnection(url, user, password) Connection
                                +getConnection(url) Connection
                                +registerDriver(Driver) void
                            }
                            
                            class Connection {
                                +createStatement() Statement
                                +prepareStatement(sql) PreparedStatement
                                +setAutoCommit(boolean) void
                                +commit() void
                                +rollback() void
                                +close() void
                            }
                            
                            class Statement {
                                +executeQuery(sql) ResultSet
                                +executeUpdate(sql) int
                                +execute(sql) boolean
                                +close() void
                            }
                            
                            class PreparedStatement {
                                +setString(index, value) void
                                +setInt(index, value) void
                                +executeQuery() ResultSet
                                +executeUpdate() int
                                +addBatch() void
                                +executeBatch() int[]
                            }
                            
                            class ResultSet {
                                +next() boolean
                                +getString(column) String
                                +getInt(column) int
                                +getTimestamp(column) Timestamp
                                +close() void
                            }
                            
                            DriverManager --> Connection
                            Connection --> Statement
                            Connection --> PreparedStatement
                            Statement --> ResultSet
                            PreparedStatement --> ResultSet
                            Statement <|-- PreparedStatement
                    </div>

                    <h4>Connection インターフェースの主要メソッド</h4>
                    <div class="table-responsive reference-table">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>メソッド</th>
                                    <th>戻り値</th>
                                    <th>説明</th>
                                    <th>使用例</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>createStatement()</code></td>
                                    <td>Statement</td>
                                    <td>基本的なSQL文実行用のStatementを作成</td>
                                    <td><code>Statement stmt = conn.createStatement();</code></td>
                                </tr>
                                <tr>
                                    <td><code>prepareStatement(String sql)</code></td>
                                    <td>PreparedStatement</td>
                                    <td>パラメータ化されたSQL用のPreparedStatementを作成</td>
                                    <td><code>PreparedStatement ps = conn.prepareStatement("SELECT * FROM users WHERE id = ?");</code></td>
                                </tr>
                                <tr>
                                    <td><code>setAutoCommit(boolean)</code></td>
                                    <td>void</td>
                                    <td>自動コミットのオン・オフを切り替え</td>
                                    <td><code>conn.setAutoCommit(false);</code></td>
                                </tr>
                                <tr>
                                    <td><code>commit()</code></td>
                                    <td>void</td>
                                    <td>現在のトランザクションをコミット</td>
                                    <td><code>conn.commit();</code></td>
                                </tr>
                                <tr>
                                    <td><code>rollback()</code></td>
                                    <td>void</td>
                                    <td>現在のトランザクションをロールバック</td>
                                    <td><code>conn.rollback();</code></td>
                                </tr>
                                <tr>
                                    <td><code>close()</code></td>
                                    <td>void</td>
                                    <td>データベース接続をクローズ</td>
                                    <td><code>conn.close();</code></td>
                                </tr>
                                <tr>
                                    <td><code>isValid(int timeout)</code></td>
                                    <td>boolean</td>
                                    <td>接続が有効かどうかをチェック</td>
                                    <td><code>if (conn.isValid(5)) { ... }</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4>PreparedStatement インターフェースの主要メソッド</h4>
                    <div class="table-responsive reference-table">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>メソッド</th>
                                    <th>戻り値</th>
                                    <th>説明</th>
                                    <th>使用例</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>setString(int index, String x)</code></td>
                                    <td>void</td>
                                    <td>指定されたパラメータにString値を設定</td>
                                    <td><code>ps.setString(1, "John");</code></td>
                                </tr>
                                <tr>
                                    <td><code>setInt(int index, int x)</code></td>
                                    <td>void</td>
                                    <td>指定されたパラメータにint値を設定</td>
                                    <td><code>ps.setInt(1, 123);</code></td>
                                </tr>
                                <tr>
                                    <td><code>setBigDecimal(int index, BigDecimal x)</code></td>
                                    <td>void</td>
                                    <td>指定されたパラメータにBigDecimal値を設定</td>
                                    <td><code>ps.setBigDecimal(1, new BigDecimal("999.99"));</code></td>
                                </tr>
                                <tr>
                                    <td><code>setTimestamp(int index, Timestamp x)</code></td>
                                    <td>void</td>
                                    <td>指定されたパラメータにTimestamp値を設定</td>
                                    <td><code>ps.setTimestamp(1, Timestamp.valueOf(LocalDateTime.now()));</code></td>
                                </tr>
                                <tr>
                                    <td><code>executeQuery()</code></td>
                                    <td>ResultSet</td>
                                    <td>SELECT文を実行してResultSetを返す</td>
                                    <td><code>ResultSet rs = ps.executeQuery();</code></td>
                                </tr>
                                <tr>
                                    <td><code>executeUpdate()</code></td>
                                    <td>int</td>
                                    <td>INSERT/UPDATE/DELETE文を実行して影響行数を返す</td>
                                    <td><code>int count = ps.executeUpdate();</code></td>
                                </tr>
                                <tr>
                                    <td><code>addBatch()</code></td>
                                    <td>void</td>
                                    <td>バッチ処理にコマンドを追加</td>
                                    <td><code>ps.addBatch();</code></td>
                                </tr>
                                <tr>
                                    <td><code>executeBatch()</code></td>
                                    <td>int[]</td>
                                    <td>バッチ処理を実行</td>
                                    <td><code>int[] results = ps.executeBatch();</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- セクション2: データ型マッピング -->
                    <h3 class="section-title">9.2 JavaとPostgreSQLのデータ型マッピング</h3>
                    <p>Javaのデータ型とPostgreSQLのデータ型の対応関係と、適切な変換方法を理解することは重要です。</p>

                    <div class="table-responsive reference-table">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>PostgreSQL データ型</th>
                                    <th>Java データ型</th>
                                    <th>setXXX メソッド</th>
                                    <th>getXXX メソッド</th>
                                    <th>備考</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>INTEGER</code></td>
                                    <td><code>int / Integer</code></td>
                                    <td><code>setInt()</code></td>
                                    <td><code>getInt()</code></td>
                                    <td>-2,147,483,648 ～ 2,147,483,647</td>
                                </tr>
                                <tr>
                                    <td><code>BIGINT</code></td>
                                    <td><code>long / Long</code></td>
                                    <td><code>setLong()</code></td>
                                    <td><code>getLong()</code></td>
                                    <td>大きな整数値に使用</td>
                                </tr>
                                <tr>
                                    <td><code>DECIMAL / NUMERIC</code></td>
                                    <td><code>BigDecimal</code></td>
                                    <td><code>setBigDecimal()</code></td>
                                    <td><code>getBigDecimal()</code></td>
                                    <td>精密な計算が必要な場合（金額など）</td>
                                </tr>
                                <tr>
                                    <td><code>DOUBLE PRECISION</code></td>
                                    <td><code>double / Double</code></td>
                                    <td><code>setDouble()</code></td>
                                    <td><code>getDouble()</code></td>
                                    <td>浮動小数点数</td>
                                </tr>
                                <tr>
                                    <td><code>VARCHAR / TEXT</code></td>
                                    <td><code>String</code></td>
                                    <td><code>setString()</code></td>
                                    <td><code>getString()</code></td>
                                    <td>可変長文字列</td>
                                </tr>
                                <tr>
                                    <td><code>BOOLEAN</code></td>
                                    <td><code>boolean / Boolean</code></td>
                                    <td><code>setBoolean()</code></td>
                                    <td><code>getBoolean()</code></td>
                                    <td>真偽値</td>
                                </tr>
                                <tr>
                                    <td><code>DATE</code></td>
                                    <td><code>Date / LocalDate</code></td>
                                    <td><code>setDate()</code></td>
                                    <td><code>getDate()</code></td>
                                    <td>日付のみ（時刻なし）</td>
                                </tr>
                                <tr>
                                    <td><code>TIMESTAMP</code></td>
                                    <td><code>Timestamp / LocalDateTime</code></td>
                                    <td><code>setTimestamp()</code></td>
                                    <td><code>getTimestamp()</code></td>
                                    <td>日付と時刻</td>
                                </tr>
                                <tr>
                                    <td><code>TIME</code></td>
                                    <td><code>Time / LocalTime</code></td>
                                    <td><code>setTime()</code></td>
                                    <td><code>getTime()</code></td>
                                    <td>時刻のみ（日付なし）</td>
                                </tr>
                                <tr>
                                    <td><code>BYTEA</code></td>
                                    <td><code>byte[]</code></td>
                                    <td><code>setBytes()</code></td>
                                    <td><code>getBytes()</code></td>
                                    <td>バイナリデータ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 実習1: データ型変換の実践例 -->
                    <div class="exercise-container">
                        <h5>実習 9-1: データ型変換の実践例</h5>
                        <p>様々なデータ型を適切に変換して処理する実例を学習します。</p>

                        <h6>データ型変換ユーティリティクラス</h6>
                        <pre class="code-block"><code class="language-java">import java.math.BigDecimal;
import java.sql.*;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;

/**
 * JDBC データ型変換ユーティリティ
 */
public class JdbcTypeConverter {
    
    /**
     * LocalDateからSQL Dateへの変換
     */
    public static Date localDateToSqlDate(LocalDate localDate) {
        return localDate != null ? Date.valueOf(localDate) : null;
    }
    
    /**
     * SQL DateからLocalDateへの変換
     */
    public static LocalDate sqlDateToLocalDate(Date sqlDate) {
        return sqlDate != null ? sqlDate.toLocalDate() : null;
    }
    
    /**
     * LocalDateTimeからTimestampへの変換
     */
    public static Timestamp localDateTimeToTimestamp(LocalDateTime localDateTime) {
        return localDateTime != null ? Timestamp.valueOf(localDateTime) : null;
    }
    
    /**
     * TimestampからLocalDateTimeへの変換
     */
    public static LocalDateTime timestampToLocalDateTime(Timestamp timestamp) {
        return timestamp != null ? timestamp.toLocalDateTime() : null;
    }
    
    /**
     * LocalTimeからSQL Timeへの変換
     */
    public static Time localTimeToSqlTime(LocalTime localTime) {
        return localTime != null ? Time.valueOf(localTime) : null;
    }
    
    /**
     * SQL TimeからLocalTimeへの変換
     */
    public static LocalTime sqlTimeToLocalTime(Time sqlTime) {
        return sqlTime != null ? sqlTime.toLocalTime() : null;
    }
    
    /**
     * String から BigDecimal への安全な変換
     */
    public static BigDecimal stringToBigDecimal(String str) {
        try {
            return str != null && !str.trim().isEmpty() ? new BigDecimal(str.trim()) : null;
        } catch (NumberFormatException e) {
            throw new IllegalArgumentException("Invalid decimal format: " + str, e);
        }
    }
    
    /**
     * PreparedStatement への値設定（null 安全）
     */
    public static void setStringOrNull(PreparedStatement ps, int index, String value) throws SQLException {
        if (value != null) {
            ps.setString(index, value);
        } else {
            ps.setNull(index, Types.VARCHAR);
        }
    }
    
    public static void setIntegerOrNull(PreparedStatement ps, int index, Integer value) throws SQLException {
        if (value != null) {
            ps.setInt(index, value);
        } else {
            ps.setNull(index, Types.INTEGER);
        }
    }
    
    public static void setBigDecimalOrNull(PreparedStatement ps, int index, BigDecimal value) throws SQLException {
        if (value != null) {
            ps.setBigDecimal(index, value);
        } else {
            ps.setNull(index, Types.DECIMAL);
        }
    }
    
    public static void setLocalDateOrNull(PreparedStatement ps, int index, LocalDate value) throws SQLException {
        if (value != null) {
            ps.setDate(index, Date.valueOf(value));
        } else {
            ps.setNull(index, Types.DATE);
        }
    }
    
    public static void setLocalDateTimeOrNull(PreparedStatement ps, int index, LocalDateTime value) throws SQLException {
        if (value != null) {
            ps.setTimestamp(index, Timestamp.valueOf(value));
        } else {
            ps.setNull(index, Types.TIMESTAMP);
        }
    }
    
    /**
     * ResultSetからの値取得（null 安全）
     */
    public static String getStringOrNull(ResultSet rs, String columnName) throws SQLException {
        String value = rs.getString(columnName);
        return rs.wasNull() ? null : value;
    }
    
    public static Integer getIntegerOrNull(ResultSet rs, String columnName) throws SQLException {
        int value = rs.getInt(columnName);
        return rs.wasNull() ? null : value;
    }
    
    public static LocalDate getLocalDateOrNull(ResultSet rs, String columnName) throws SQLException {
        Date date = rs.getDate(columnName);
        return date != null ? date.toLocalDate() : null;
    }
    
    public static LocalDateTime getLocalDateTimeOrNull(ResultSet rs, String columnName) throws SQLException {
        Timestamp timestamp = rs.getTimestamp(columnName);
        return timestamp != null ? timestamp.toLocalDateTime() : null;
    }
}</code></pre>

                        <h6>使用例</h6>
                        <pre class="code-block"><code class="language-java">public class TypeConversionDemo {
    
    public void insertUserWithNullHandling(User user) {
        String sql = "INSERT INTO users (name, email, age, birth_date, created_at) VALUES (?, ?, ?, ?, ?)";
        
        try (Connection connection = getConnection();
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            // null安全な値設定
            JdbcTypeConverter.setStringOrNull(statement, 1, user.getName());
            JdbcTypeConverter.setStringOrNull(statement, 2, user.getEmail());
            JdbcTypeConverter.setIntegerOrNull(statement, 3, user.getAge());
            JdbcTypeConverter.setLocalDateOrNull(statement, 4, user.getBirthDate());
            JdbcTypeConverter.setLocalDateTimeOrNull(statement, 5, user.getCreatedAt());
            
            statement.executeUpdate();
            System.out.println("ユーザー登録完了: " + user.getName());
            
        } catch (SQLException e) {
            System.err.println("ユーザー登録エラー: " + e.getMessage());
        }
    }
    
    public User getUserById(int userId) {
        String sql = "SELECT * FROM users WHERE id = ?";
        
        try (Connection connection = getConnection();
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            statement.setInt(1, userId);
            
            try (ResultSet rs = statement.executeQuery()) {
                if (rs.next()) {
                    User user = new User();
                    user.setId(rs.getInt("id"));
                    // null安全な値取得
                    user.setName(JdbcTypeConverter.getStringOrNull(rs, "name"));
                    user.setEmail(JdbcTypeConverter.getStringOrNull(rs, "email"));
                    user.setAge(JdbcTypeConverter.getIntegerOrNull(rs, "age"));
                    user.setBirthDate(JdbcTypeConverter.getLocalDateOrNull(rs, "birth_date"));
                    user.setCreatedAt(JdbcTypeConverter.getLocalDateTimeOrNull(rs, "created_at"));
                    return user;
                }
            }
            
        } catch (SQLException e) {
            System.err.println("ユーザー取得エラー: " + e.getMessage());
        }
        
        return null;
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>null値を含むデータでも安全に処理でき、適切なデータ型変換が行われます。エラーハンドリングも含まれており、実用的なコードとして使用できます。</p>
                    </div>

                    <!-- セクション3: 一般的なエラーと対処法 -->
                    <h3 class="section-title">9.3 一般的なエラーコードと対処法</h3>
                    <p>JDBCプログラミングでよく遭遇するエラーコードと、その原因・対処法を理解することで、効率的なデバッグが可能になります。</p>

                    <h4>PostgreSQL 主要エラーコード</h4>
                    <div class="table-responsive reference-table">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>SQLState</th>
                                    <th>エラーの種類</th>
                                    <th>よくある原因</th>
                                    <th>対処法</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>08001</code></td>
                                    <td>接続エラー</td>
                                    <td>データベースサーバーに接続できない</td>
                                    <td>サーバー状態、URL、認証情報を確認</td>
                                </tr>
                                <tr>
                                    <td><code>08004</code></td>
                                    <td>認証失敗</td>
                                    <td>ユーザー名またはパスワードが間違っている</td>
                                    <td>認証情報とユーザー権限を確認</td>
                                </tr>
                                <tr>
                                    <td><code>42601</code></td>
                                    <td>SQL構文エラー</td>
                                    <td>SQL文に構文エラーがある</td>
                                    <td>SQL文の構文を確認・修正</td>
                                </tr>
                                <tr>
                                    <td><code>42703</code></td>
                                    <td>存在しない列</td>
                                    <td>指定した列名がテーブルに存在しない</td>
                                    <td>列名のスペルとテーブル構造を確認</td>
                                </tr>
                                <tr>
                                    <td><code>42P01</code></td>
                                    <td>存在しないテーブル</td>
                                    <td>指定したテーブルが存在しない</td>
                                    <td>テーブル名とスキーマを確認</td>
                                </tr>
                                <tr>
                                    <td><code>23505</code></td>
                                    <td>一意制約違反</td>
                                    <td>UNIQUE制約またはPRIMARY KEY制約に違反</td>
                                    <td>重複する値の挿入を回避</td>
                                </tr>
                                <tr>
                                    <td><code>23503</code></td>
                                    <td>外部キー制約違反</td>
                                    <td>参照先のレコードが存在しない</td>
                                    <td>参照先テーブルの状態を確認</td>
                                </tr>
                                <tr>
                                    <td><code>23502</code></td>
                                    <td>NOT NULL制約違反</td>
                                    <td>NOT NULL制約の列にNULLを挿入しようとした</td>
                                    <td>必須項目に適切な値を設定</td>
                                </tr>
                                <tr>
                                    <td><code>40001</code></td>
                                    <td>デッドロック</td>
                                    <td>複数のトランザクション間でデッドロックが発生</td>
                                    <td>トランザクションを再試行</td>
                                </tr>
                                <tr>
                                    <td><code>57014</code></td>
                                    <td>クエリキャンセル</td>
                                    <td>クエリ実行がタイムアウトまたはキャンセルされた</td>
                                    <td>タイムアウト時間を調整またはクエリ最適化</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- セクション4: デバッグとトラブルシューティング -->
                    <h3 class="section-title">9.4 デバッグとトラブルシューティング</h3>
                    <p>JDBCアプリケーションの問題を効率的に特定し、解決するための実践的な技法を学習します。</p>

                    <!-- 実習2: デバッグ技法 -->
                    <div class="exercise-container">
                        <h5>実習 9-2: 効果的なデバッグ技法</h5>
                        <p>実際の開発現場で役立つデバッグとトラブルシューティングの手法を実装します。</p>

                        <h6>デバッグ用ユーティリティクラス</h6>
                        <pre class="code-block"><code class="language-java">import java.sql.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;

/**
 * JDBC デバッグ・トラブルシューティング用ユーティリティ
 */
public class JdbcDebugUtils {
    private static boolean debugEnabled = true;
    private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
    
    /**
     * デバッグモードの有効/無効を設定
     */
    public static void setDebugEnabled(boolean enabled) {
        debugEnabled = enabled;
    }
    
    /**
     * デバッグ情報を出力
     */
    private static void debugLog(String message) {
        if (debugEnabled) {
            System.out.println("[DEBUG " + LocalDateTime.now().format(FORMATTER) + "] " + message);
        }
    }
    
    /**
     * データベース接続のテスト
     */
    public static boolean testConnection(String url, String username, String password) {
        debugLog("データベース接続をテスト中: " + url);
        
        try (Connection connection = DriverManager.getConnection(url, username, password)) {
            if (connection.isValid(5)) {
                debugLog("接続成功: " + connection.getMetaData().getDatabaseProductName());
                return true;
            } else {
                debugLog("接続は確立されましたが、有効性チェックに失敗しました");
                return false;
            }
        } catch (SQLException e) {
            debugLog("接続エラー: " + e.getMessage());
            debugLog("SQLState: " + e.getSQLState() + ", ErrorCode: " + e.getErrorCode());
            return false;
        }
    }
    
    /**
     * SQL実行時間の測定
     */
    public static class SqlExecutionTimer {
        private final String sql;
        private final long startTime;
        
        public SqlExecutionTimer(String sql) {
            this.sql = sql;
            this.startTime = System.currentTimeMillis();
            debugLog("SQL実行開始: " + sql);
        }
        
        public void end() {
            long executionTime = System.currentTimeMillis() - startTime;
            debugLog("SQL実行完了 (" + executionTime + "ms): " + sql);
        }
        
        public void end(int affectedRows) {
            long executionTime = System.currentTimeMillis() - startTime;
            debugLog("SQL実行完了 (" + executionTime + "ms, " + affectedRows + "行): " + sql);
        }
    }
    
    /**
     * PreparedStatementのパラメータをログ出力
     */
    public static void logParameters(String sql, Object... parameters) {
        if (!debugEnabled) return;
        
        StringBuilder sb = new StringBuilder();
        sb.append("SQL: ").append(sql).append("\n");
        sb.append("Parameters: ");
        
        for (int i = 0; i < parameters.length; i++) {
            sb.append("[").append(i + 1).append("] ");
            Object param = parameters[i];
            if (param == null) {
                sb.append("NULL");
            } else {
                sb.append(param.getClass().getSimpleName()).append(": ").append(param);
            }
            if (i < parameters.length - 1) {
                sb.append(", ");
            }
        }
        
        debugLog(sb.toString());
    }
    
    /**
     * ResultSetの内容を表示（デバッグ用）
     */
    public static void printResultSet(ResultSet rs, int maxRows) throws SQLException {
        if (!debugEnabled) return;
        
        ResultSetMetaData metaData = rs.getMetaData();
        int columnCount = metaData.getColumnCount();
        
        // ヘッダー出力
        StringBuilder header = new StringBuilder();
        for (int i = 1; i <= columnCount; i++) {
            if (i > 1) header.append("\t");
            header.append(metaData.getColumnName(i));
        }
        debugLog("ResultSet: " + header.toString());
        
        // データ出力
        int rowCount = 0;
        while (rs.next() && rowCount < maxRows) {
            StringBuilder row = new StringBuilder();
            for (int i = 1; i <= columnCount; i++) {
                if (i > 1) row.append("\t");
                Object value = rs.getObject(i);
                row.append(value != null ? value.toString() : "NULL");
            }
            debugLog("Row " + (rowCount + 1) + ": " + row.toString());
            rowCount++;
        }
        
        debugLog("表示行数: " + rowCount);
    }
    
    /**
     * SQLExceptionの詳細な分析
     */
    public static void analyzeSqlException(SQLException e) {
        debugLog("=== SQLException 詳細分析 ===");
        
        SQLException current = e;
        int exceptionCount = 0;
        
        while (current != null) {
            exceptionCount++;
            debugLog("Exception #" + exceptionCount + ":");
            debugLog("  Message: " + current.getMessage());
            debugLog("  SQLState: " + current.getSQLState());
            debugLog("  ErrorCode: " + current.getErrorCode());
            
            // SQLState による分類
            String sqlState = current.getSQLState();
            if (sqlState != null) {
                if (sqlState.startsWith("08")) {
                    debugLog("  Category: 接続関連のエラー");
                } else if (sqlState.startsWith("42")) {
                    debugLog("  Category: SQL構文エラー");
                } else if (sqlState.startsWith("23")) {
                    debugLog("  Category: 制約違反エラー");
                } else if (sqlState.startsWith("40")) {
                    debugLog("  Category: トランザクションエラー");
                } else if (sqlState.startsWith("57")) {
                    debugLog("  Category: システムエラー（タイムアウトなど）");
                } else {
                    debugLog("  Category: その他のエラー");
                }
            }
            
            current = current.getNextException();
        }
        
        debugLog("=== スタックトレース ===");
        e.printStackTrace();
    }
    
    /**
     * データベースメタデータの表示
     */
    public static void printDatabaseInfo(Connection connection) throws SQLException {
        if (!debugEnabled) return;
        
        DatabaseMetaData metaData = connection.getMetaData();
        
        debugLog("=== データベース情報 ===");
        debugLog("Product Name: " + metaData.getDatabaseProductName());
        debugLog("Product Version: " + metaData.getDatabaseProductVersion());
        debugLog("Driver Name: " + metaData.getDriverName());
        debugLog("Driver Version: " + metaData.getDriverVersion());
        debugLog("JDBC Version: " + metaData.getJDBCMajorVersion() + "." + metaData.getJDBCMinorVersion());
        debugLog("Transaction Isolation: " + connection.getTransactionIsolation());
        debugLog("Auto Commit: " + connection.getAutoCommit());
    }
}</code></pre>

                        <h6>使用例</h6>
                        <pre class="code-block"><code class="language-java">public class DebuggingExample {
    
    public void debuggableQuery() {
        String url = "jdbc:postgresql://localhost:5432/testdb";
        String username = "user";
        String password = "password";
        
        // 1. 接続テスト
        if (!JdbcDebugUtils.testConnection(url, username, password)) {
            System.err.println("データベース接続に失敗しました");
            return;
        }
        
        try (Connection connection = DriverManager.getConnection(url, username, password)) {
            // 2. データベース情報の表示
            JdbcDebugUtils.printDatabaseInfo(connection);
            
            String sql = "SELECT * FROM users WHERE age > ? AND name LIKE ?";
            
            try (PreparedStatement statement = connection.prepareStatement(sql)) {
                
                // 3. パラメータのログ出力
                Object[] params = {25, "John%"};
                JdbcDebugUtils.logParameters(sql, params);
                
                statement.setInt(1, 25);
                statement.setString(2, "John%");
                
                // 4. 実行時間の測定
                JdbcDebugUtils.SqlExecutionTimer timer = new JdbcDebugUtils.SqlExecutionTimer(sql);
                
                try (ResultSet resultSet = statement.executeQuery()) {
                    timer.end();
                    
                    // 5. 結果セットのデバッグ表示
                    JdbcDebugUtils.printResultSet(resultSet, 10);
                    
                    // 実際の処理...
                }
            }
            
        } catch (SQLException e) {
            // 6. 詳細なエラー分析
            JdbcDebugUtils.analyzeSqlException(e);
        }
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>詳細なデバッグ情報が出力され、SQL実行時間、パラメータ値、結果セットの内容、エラーの詳細分析などが確認できます。本番環境では`setDebugEnabled(false)`でデバッグ出力を無効化できます。</p>
                    </div>

                    <!-- セクション5: パフォーマンスチェックリスト -->
                    <h3 class="section-title">9.5 JDBCパフォーマンス最適化チェックリスト</h3>
                    <p>実用的なJDBCアプリケーションのパフォーマンスを最適化するための包括的なチェックリストです。</p>

                    <div class="highlight">
                        <h5>コネクション管理</h5>
                        <ul>
                            <li>✅ コネクションプールを使用している</li>
                            <li>✅ 不要なコネクションを即座にクローズしている</li>
                            <li>✅ try-with-resources構文を使用している</li>
                            <li>✅ 適切なタイムアウト設定をしている</li>
                        </ul>
                        
                        <h5>SQL最適化</h5>
                        <ul>
                            <li>✅ PreparedStatementを使用している（SQLインジェクション対策も兼ねる）</li>
                            <li>✅ 必要な列のみをSELECTしている（SELECT *を避ける）</li>
                            <li>✅ 適切なWHERE句でデータを絞り込んでいる</li>
                            <li>✅ インデックスを効果的に活用している</li>
                            <li>✅ JOINよりもサブクエリが適している場合は使い分けている</li>
                        </ul>
                        
                        <h5>バッチ処理</h5>
                        <ul>
                            <li>✅ 大量データの挿入・更新でバッチ処理を使用している</li>
                            <li>✅ 適切なバッチサイズを設定している（1000-5000件程度）</li>
                            <li>✅ バッチ実行時にトランザクション管理をしている</li>
                        </ul>
                        
                        <h5>データ転送最適化</h5>
                        <ul>
                            <li>✅ 適切なフェッチサイズを設定している</li>
                            <li>✅ ページングを実装している（大量データ取得時）</li>
                            <li>✅ 不要な大きなデータ（BLOBなど）の取得を避けている</li>
                        </ul>
                        
                        <h5>メモリ管理</h5>
                        <ul>
                            <li>✅ ResultSetを適切にクローズしている</li>
                            <li>✅ 大きなResultSetを長時間保持していない</li>
                            <li>✅ 不要なオブジェクトの生成を最小化している</li>
                        </ul>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>JDBCリファレンス理解度確認</h5>
                        <ol>
                            <li>
                                <p><strong>以下のJavaデータ型に対応する適切なPostgreSQLデータ型を答えてください：</strong></p>
                                <ul>
                                    <li>BigDecimal</li>
                                    <li>LocalDateTime</li>
                                    <li>boolean</li>
                                    <li>byte[]</li>
                                </ul>
                            </li>
                            
                            <li>
                                <p><strong>SQLState「23505」が示すエラーの種類と、その対処法を説明してください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>以下のコードの問題点を指摘し、改良版を書いてください：</strong></p>
                                <pre class="code-block"><code class="language-java">ResultSet rs = statement.executeQuery("SELECT * FROM large_table");
List&lt;Data&gt; dataList = new ArrayList&lt;&gt;();
while (rs.next()) {
    dataList.add(createDataFromResultSet(rs));
}</code></pre>
                            </li>
                            
                            <li>
                                <p><strong>JDBCアプリケーションでよく使用されるデバッグ技法を5つ挙げ、それぞれの使用場面を説明してください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>NULL値を含むデータベース列をJavaで安全に扱うためのベストプラクティスを、コード例と共に説明してください。</strong></p>
                            </li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="jdbc-learning-material-8.html" class="btn btn-secondary">← 前の章</a>
                        <a href="jdbc-learning-material-10.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>