<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struts 1.x学習教材 第9章 - データベース連携と実践的開発</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        .navbar {
            background-color: #6d4c41;
        }
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        .chapter-title {
            color: #6d4c41;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #6d4c41;
            padding-bottom: 0.5rem;
        }
        .section-title {
            color: #8d6e63;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        code {
            display: block;
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            white-space: pre;
            overflow-x: auto;
        }
        .quiz-container {
            background-color: #efebe9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #6d4c41;
        }
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        .nav-link.active {
            background-color: #6d4c41 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="README.md">Struts 1.x学習ガイド</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-1.html">第1章: Struts 1.xの基本概念とMVCアーキテクチャ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-2.html">第2章: 環境構築とプロジェクト作成</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-3.html">第3章: ActionクラスとActionForm</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-4.html">第4章: struts-config.xmlの設定と管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-5.html">第5章: JSPとの連携とTagライブラリ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-6.html">第6章: バリデーション機能とエラーハンドリング</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-7.html">第7章: セッション管理とセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-8.html">第8章: 国際化（i18n）とプロパティファイル</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="struts1-learning-material-9.html">第9章: データベース連携と実践的開発</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-10.html">第10章: デバッグ・テスト・デプロイメント</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第9章: データベース連携と実践的開発</h1>
                </div>

                <div id="chapter9">
                    <h2 class="chapter-title">業務アプリケーション開発のための実践的データベース操作</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>JDBCとO/Rマッパーを使ったデータベース連携</li>
                            <li>DAOパターンによる効率的なデータアクセス層設計</li>
                            <li>トランザクション管理の実装</li>
                            <li>実際のCRUD操作を含む業務アプリケーション開発</li>
                            <li>コネクションプールとパフォーマンス最適化</li>
                        </ul>
                    </div>

                    <h3 class="section-title">9.1 データベース接続の基盤整備</h3>
                    
                    <h4>データソースの設定</h4>
                    <div class="exercise-container">
                        <h5>実習 9-1: コネクションプールの設定</h5>
                        <p>web.xml とコンテキストでのデータソース設定：</p>
                        <code>&lt;!-- web.xml でのリソース参照 --&gt;
&lt;resource-ref&gt;
    &lt;description&gt;DB Connection Pool&lt;/description&gt;
    &lt;res-ref-name&gt;jdbc/AppDB&lt;/res-ref-name&gt;
    &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
&lt;/resource-ref&gt;

&lt;!-- context.xml でのデータソース定義 --&gt;
&lt;Context&gt;
    &lt;Resource name="jdbc/AppDB"
              auth="Container"
              type="javax.sql.DataSource"
              maxTotal="20"
              maxIdle="10"
              maxWaitMillis="10000"
              username="app_user"
              password="app_password"
              driverClassName="com.mysql.cj.jdbc.Driver"
              url="jdbc:mysql://localhost:3306/struts_app?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=JST"/&gt;
&lt;/Context&gt;</code>
                    </div>

                    <h4>データベース接続管理クラス</h4>
                    <div class="exercise-container">
                        <h5>実習 9-2: 接続管理ユーティリティ</h5>
                        <code>package com.example.db;

import java.sql.Connection;
import java.sql.SQLException;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import javax.sql.DataSource;

/**
 * データベース接続管理クラス
 */
public class DatabaseManager {
    
    private static DataSource dataSource;
    
    static {
        try {
            // JNDIからデータソースを取得
            Context context = new InitialContext();
            dataSource = (DataSource) context.lookup("java:comp/env/jdbc/AppDB");
        } catch (NamingException e) {
            throw new RuntimeException("データソースの初期化に失敗しました", e);
        }
    }
    
    /**
     * データベース接続を取得
     */
    public static Connection getConnection() throws SQLException {
        return dataSource.getConnection();
    }
    
    /**
     * リソースのクローズ
     */
    public static void closeConnection(Connection conn) {
        if (conn != null) {
            try {
                conn.close();
            } catch (SQLException e) {
                System.err.println("接続のクローズに失敗: " + e.getMessage());
            }
        }
    }
    
    /**
     * トランザクション開始
     */
    public static void beginTransaction(Connection conn) throws SQLException {
        conn.setAutoCommit(false);
    }
    
    /**
     * トランザクションコミット
     */
    public static void commitTransaction(Connection conn) throws SQLException {
        conn.commit();
        conn.setAutoCommit(true);
    }
    
    /**
     * トランザクションロールバック
     */
    public static void rollbackTransaction(Connection conn) {
        if (conn != null) {
            try {
                conn.rollback();
                conn.setAutoCommit(true);
            } catch (SQLException e) {
                System.err.println("ロールバックに失敗: " + e.getMessage());
            }
        }
    }
}</code>
                    </div>

                    <h3 class="section-title">9.2 DAO パターンの実装</h3>
                    
                    <h4>基底DAOクラスの作成</h4>
                    <div class="exercise-container">
                        <h5>実習 9-3: 汎用DAOの実装</h5>
                        <code>package com.example.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;

import com.example.db.DatabaseManager;

/**
 * 汎用DAO基底クラス
 */
public abstract class BaseDAO&lt;T&gt; {
    
    /**
     * エンティティのIDによる検索
     */
    public abstract T findById(Long id) throws SQLException;
    
    /**
     * 全件検索
     */
    public abstract List&lt;T&gt; findAll() throws SQLException;
    
    /**
     * エンティティの挿入
     */
    public abstract Long insert(T entity) throws SQLException;
    
    /**
     * エンティティの更新
     */
    public abstract boolean update(T entity) throws SQLException;
    
    /**
     * エンティティの削除
     */
    public abstract boolean delete(Long id) throws SQLException;
    
    /**
     * ResultSetからエンティティにマッピング
     */
    protected abstract T mapResultSetToEntity(ResultSet rs) throws SQLException;
    
    /**
     * PreparedStatementにエンティティから値を設定
     */
    protected abstract void setEntityParameters(PreparedStatement ps, T entity) throws SQLException;
    
    /**
     * 共通のクエリ実行メソッド
     */
    protected PreparedStatement prepareStatement(Connection conn, String sql, Object... params) 
            throws SQLException {
        PreparedStatement ps = conn.prepareStatement(sql);
        for (int i = 0; i < params.length; i++) {
            ps.setObject(i + 1, params[i]);
        }
        return ps;
    }
    
    /**
     * リソースのクリーンアップ
     */
    protected void closeResources(Connection conn, PreparedStatement ps, ResultSet rs) {
        if (rs != null) {
            try { rs.close(); } catch (SQLException e) { /* ログ出力 */ }
        }
        if (ps != null) {
            try { ps.close(); } catch (SQLException e) { /* ログ出力 */ }
        }
        if (conn != null) {
            try { conn.close(); } catch (SQLException e) { /* ログ出力 */ }
        }
    }
}</code>
                    </div>

                    <h4>具体的なDAOクラスの実装</h4>
                    <div class="exercise-container">
                        <h5>実習 9-4: UserDAO の実装</h5>
                        <code>package com.example.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

import com.example.bean.User;
import com.example.db.DatabaseManager;

/**
 * ユーザーデータアクセスオブジェクト
 */
public class UserDAO extends BaseDAO&lt;User&gt; {
    
    // SQL クエリ定数
    private static final String SELECT_BY_ID = 
        "SELECT user_id, username, email, first_name, last_name, created_date, updated_date, is_active " +
        "FROM users WHERE user_id = ?";
    
    private static final String SELECT_ALL = 
        "SELECT user_id, username, email, first_name, last_name, created_date, updated_date, is_active " +
        "FROM users ORDER BY username";
    
    private static final String SELECT_BY_USERNAME = 
        "SELECT user_id, username, email, first_name, last_name, created_date, updated_date, is_active " +
        "FROM users WHERE username = ?";
    
    private static final String INSERT_USER = 
        "INSERT INTO users (username, email, first_name, last_name, password_hash, created_date, is_active) " +
        "VALUES (?, ?, ?, ?, ?, NOW(), ?)";
    
    private static final String UPDATE_USER = 
        "UPDATE users SET username = ?, email = ?, first_name = ?, last_name = ?, updated_date = NOW() " +
        "WHERE user_id = ?";
    
    private static final String DELETE_USER = 
        "UPDATE users SET is_active = 0, updated_date = NOW() WHERE user_id = ?";
    
    private static final String COUNT_BY_USERNAME = 
        "SELECT COUNT(*) FROM users WHERE username = ? AND user_id != ?";
    
    @Override
    public User findById(Long id) throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            conn = DatabaseManager.getConnection();
            ps = prepareStatement(conn, SELECT_BY_ID, id);
            rs = ps.executeQuery();
            
            if (rs.next()) {
                return mapResultSetToEntity(rs);
            }
            return null;
            
        } finally {
            closeResources(conn, ps, rs);
        }
    }
    
    @Override
    public List&lt;User&gt; findAll() throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        List&lt;User&gt; users = new ArrayList&lt;&gt;();
        
        try {
            conn = DatabaseManager.getConnection();
            ps = conn.prepareStatement(SELECT_ALL);
            rs = ps.executeQuery();
            
            while (rs.next()) {
                users.add(mapResultSetToEntity(rs));
            }
            
            return users;
            
        } finally {
            closeResources(conn, ps, rs);
        }
    }
    
    /**
     * ユーザー名で検索
     */
    public User findByUsername(String username) throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            conn = DatabaseManager.getConnection();
            ps = prepareStatement(conn, SELECT_BY_USERNAME, username);
            rs = ps.executeQuery();
            
            if (rs.next()) {
                return mapResultSetToEntity(rs);
            }
            return null;
            
        } finally {
            closeResources(conn, ps, rs);
        }
    }
    
    @Override
    public Long insert(User user) throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            conn = DatabaseManager.getConnection();
            
            // 重複チェック
            if (isUsernameDuplicate(user.getUsername(), null)) {
                throw new SQLException("ユーザー名が既に存在します: " + user.getUsername());
            }
            
            ps = conn.prepareStatement(INSERT_USER, Statement.RETURN_GENERATED_KEYS);
            ps.setString(1, user.getUsername());
            ps.setString(2, user.getEmail());
            ps.setString(3, user.getFirstName());
            ps.setString(4, user.getLastName());
            ps.setString(5, user.getPasswordHash());
            ps.setBoolean(6, user.isActive());
            
            int affectedRows = ps.executeUpdate();
            if (affectedRows == 0) {
                throw new SQLException("ユーザーの作成に失敗しました");
            }
            
            rs = ps.getGeneratedKeys();
            if (rs.next()) {
                return rs.getLong(1);
            } else {
                throw new SQLException("IDの取得に失敗しました");
            }
            
        } finally {
            closeResources(conn, ps, rs);
        }
    }
    
    @Override
    public boolean update(User user) throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;
        
        try {
            conn = DatabaseManager.getConnection();
            
            // 重複チェック（自分以外）
            if (isUsernameDuplicate(user.getUsername(), user.getUserId())) {
                throw new SQLException("ユーザー名が既に存在します: " + user.getUsername());
            }
            
            ps = prepareStatement(conn, UPDATE_USER, 
                user.getUsername(), user.getEmail(), user.getFirstName(), 
                user.getLastName(), user.getUserId());
            
            return ps.executeUpdate() > 0;
            
        } finally {
            closeResources(conn, ps, null);
        }
    }
    
    @Override
    public boolean delete(Long id) throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;
        
        try {
            conn = DatabaseManager.getConnection();
            ps = prepareStatement(conn, DELETE_USER, id);
            
            return ps.executeUpdate() > 0;
            
        } finally {
            closeResources(conn, ps, null);
        }
    }
    
    /**
     * ユーザー名の重複チェック
     */
    public boolean isUsernameDuplicate(String username, Long excludeUserId) throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            conn = DatabaseManager.getConnection();
            ps = prepareStatement(conn, COUNT_BY_USERNAME, username, 
                excludeUserId != null ? excludeUserId : 0);
            rs = ps.executeQuery();
            
            if (rs.next()) {
                return rs.getInt(1) > 0;
            }
            return false;
            
        } finally {
            closeResources(conn, ps, rs);
        }
    }
    
    @Override
    protected User mapResultSetToEntity(ResultSet rs) throws SQLException {
        User user = new User();
        user.setUserId(rs.getLong("user_id"));
        user.setUsername(rs.getString("username"));
        user.setEmail(rs.getString("email"));
        user.setFirstName(rs.getString("first_name"));
        user.setLastName(rs.getString("last_name"));
        user.setCreatedDate(rs.getTimestamp("created_date"));
        user.setUpdatedDate(rs.getTimestamp("updated_date"));
        user.setActive(rs.getBoolean("is_active"));
        return user;
    }
    
    @Override
    protected void setEntityParameters(PreparedStatement ps, User entity) throws SQLException {
        // 基本実装では使用しない（個別メソッドで対応）
    }
}</code>
                    </div>

                    <h3 class="section-title">9.3 トランザクション管理</h3>
                    
                    <div class="exercise-container">
                        <h5>実習 9-5: トランザクション対応サービス層</h5>
                        <code>package com.example.service;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

import com.example.bean.User;
import com.example.dao.UserDAO;
import com.example.db.DatabaseManager;
import com.example.exception.BusinessException;

/**
 * ユーザー管理サービス
 */
public class UserService {
    
    private UserDAO userDAO = new UserDAO();
    
    /**
     * ユーザー登録（トランザクション管理）
     */
    public Long registerUser(User user) throws BusinessException {
        Connection conn = null;
        
        try {
            conn = DatabaseManager.getConnection();
            DatabaseManager.beginTransaction(conn);
            
            // 業務ロジックの検証
            validateUserForRegistration(user);
            
            // ユーザー挿入
            Long userId = userDAO.insert(user);
            
            // 関連データの作成（例：プロフィール、設定など）
            createUserProfile(userId, conn);
            createUserSettings(userId, conn);
            
            DatabaseManager.commitTransaction(conn);
            
            return userId;
            
        } catch (SQLException e) {
            DatabaseManager.rollbackTransaction(conn);
            throw new BusinessException("ユーザー登録に失敗しました", e);
        } finally {
            DatabaseManager.closeConnection(conn);
        }
    }
    
    /**
     * ユーザー情報更新（トランザクション管理）
     */
    public boolean updateUser(User user) throws BusinessException {
        Connection conn = null;
        
        try {
            conn = DatabaseManager.getConnection();
            DatabaseManager.beginTransaction(conn);
            
            // 存在チェック
            User existingUser = userDAO.findById(user.getUserId());
            if (existingUser == null) {
                throw new BusinessException("ユーザーが見つかりません: " + user.getUserId());
            }
            
            // 業務ロジックの検証
            validateUserForUpdate(user);
            
            // ユーザー更新
            boolean result = userDAO.update(user);
            
            // 監査ログの記録
            recordAuditLog(user.getUserId(), "USER_UPDATE", conn);
            
            DatabaseManager.commitTransaction(conn);
            
            return result;
            
        } catch (SQLException e) {
            DatabaseManager.rollbackTransaction(conn);
            throw new BusinessException("ユーザー更新に失敗しました", e);
        } finally {
            DatabaseManager.closeConnection(conn);
        }
    }
    
    /**
     * ユーザー削除（論理削除）
     */
    public boolean deleteUser(Long userId) throws BusinessException {
        Connection conn = null;
        
        try {
            conn = DatabaseManager.getConnection();
            DatabaseManager.beginTransaction(conn);
            
            // 存在チェック
            User user = userDAO.findById(userId);
            if (user == null) {
                throw new BusinessException("ユーザーが見つかりません: " + userId);
            }
            
            // 削除前の業務チェック
            if (hasActiveTransactions(userId)) {
                throw new BusinessException("アクティブな取引があるため削除できません");
            }
            
            // 論理削除
            boolean result = userDAO.delete(userId);
            
            // 関連データの無効化
            deactivateUserSessions(userId, conn);
            
            // 監査ログの記録
            recordAuditLog(userId, "USER_DELETE", conn);
            
            DatabaseManager.commitTransaction(conn);
            
            return result;
            
        } catch (SQLException e) {
            DatabaseManager.rollbackTransaction(conn);
            throw new BusinessException("ユーザー削除に失敗しました", e);
        } finally {
            DatabaseManager.closeConnection(conn);
        }
    }
    
    /**
     * ユーザー一覧取得
     */
    public List&lt;User&gt; getAllUsers() throws BusinessException {
        try {
            return userDAO.findAll();
        } catch (SQLException e) {
            throw new BusinessException("ユーザー一覧の取得に失敗しました", e);
        }
    }
    
    /**
     * ユーザー検索
     */
    public User getUserById(Long userId) throws BusinessException {
        try {
            return userDAO.findById(userId);
        } catch (SQLException e) {
            throw new BusinessException("ユーザーの取得に失敗しました", e);
        }
    }
    
    /**
     * ユーザー認証
     */
    public User authenticateUser(String username, String password) throws BusinessException {
        try {
            User user = userDAO.findByUsername(username);
            if (user != null && verifyPassword(password, user.getPasswordHash())) {
                return user;
            }
            return null;
        } catch (SQLException e) {
            throw new BusinessException("ユーザー認証に失敗しました", e);
        }
    }
    
    // プライベートメソッド
    private void validateUserForRegistration(User user) throws BusinessException {
        if (user.getUsername() == null || user.getUsername().trim().length() < 3) {
            throw new BusinessException("ユーザー名は3文字以上で入力してください");
        }
        
        if (user.getEmail() == null || !isValidEmail(user.getEmail())) {
            throw new BusinessException("正しいメールアドレスを入力してください");
        }
    }
    
    private void validateUserForUpdate(User user) throws BusinessException {
        validateUserForRegistration(user);
        
        if (user.getUserId() == null) {
            throw new BusinessException("ユーザーIDが設定されていません");
        }
    }
    
    private boolean isValidEmail(String email) {
        return email.matches("^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$");
    }
    
    private boolean verifyPassword(String plainPassword, String hashedPassword) {
        // パスワードハッシュの検証ロジック
        // 実際の実装では BCrypt などを使用
        return plainPassword.equals(hashedPassword); // 簡略化
    }
    
    private void createUserProfile(Long userId, Connection conn) throws SQLException {
        // ユーザープロフィールテーブルへの初期データ挿入
    }
    
    private void createUserSettings(Long userId, Connection conn) throws SQLException {
        // ユーザー設定テーブルへの初期データ挿入
    }
    
    private boolean hasActiveTransactions(Long userId) throws SQLException {
        // アクティブな取引の存在チェック
        return false; // 簡略化
    }
    
    private void deactivateUserSessions(Long userId, Connection conn) throws SQLException {
        // ユーザーセッションの無効化
    }
    
    private void recordAuditLog(Long userId, String action, Connection conn) throws SQLException {
        // 監査ログの記録
    }
}</code>
                    </div>

                    <h3 class="section-title">9.4 Actionクラスでのサービス層活用</h3>
                    
                    <div class="exercise-container">
                        <h5>実習 9-6: ユーザー管理Action の実装</h5>
                        <code>package com.example.action;

import java.util.List;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessages;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.actions.DispatchAction;

import com.example.bean.User;
import com.example.form.UserForm;
import com.example.service.UserService;
import com.example.exception.BusinessException;

/**
 * ユーザー管理を行うDispatchAction
 */
public class UserManagementAction extends DispatchAction {
    
    private UserService userService = new UserService();
    
    /**
     * ユーザー一覧表示
     */
    public ActionForward list(ActionMapping mapping, ActionForm form,
            HttpServletRequest request, HttpServletResponse response) throws Exception {
        
        try {
            List&lt;User&gt; users = userService.getAllUsers();
            request.setAttribute("userList", users);
            
            return mapping.findForward("list");
            
        } catch (BusinessException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage("error.user.list.failed"));
            saveErrors(request, errors);
            
            return mapping.findForward("error");
        }
    }
    
    /**
     * ユーザー詳細表示
     */
    public ActionForward detail(ActionMapping mapping, ActionForm form,
            HttpServletRequest request, HttpServletResponse response) throws Exception {
        
        String userIdStr = request.getParameter("id");
        
        try {
            Long userId = Long.valueOf(userIdStr);
            User user = userService.getUserById(userId);
            
            if (user == null) {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE, 
                    new ActionMessage("error.user.notfound", userIdStr));
                saveErrors(request, errors);
                return mapping.findForward("list");
            }
            
            request.setAttribute("user", user);
            return mapping.findForward("detail");
            
        } catch (NumberFormatException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage("error.invalid.userid"));
            saveErrors(request, errors);
            return mapping.findForward("list");
            
        } catch (BusinessException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage("error.user.detail.failed"));
            saveErrors(request, errors);
            return mapping.findForward("error");
        }
    }
    
    /**
     * ユーザー登録フォーム表示
     */
    public ActionForward createForm(ActionMapping mapping, ActionForm form,
            HttpServletRequest request, HttpServletResponse response) throws Exception {
        
        // フォームを初期化
        UserForm userForm = (UserForm) form;
        userForm.reset(mapping, request);
        
        return mapping.findForward("createForm");
    }
    
    /**
     * ユーザー登録処理
     */
    public ActionForward create(ActionMapping mapping, ActionForm form,
            HttpServletRequest request, HttpServletResponse response) throws Exception {
        
        UserForm userForm = (UserForm) form;
        
        try {
            // フォームからエンティティに変換
            User user = convertFormToEntity(userForm);
            
            // ユーザー登録
            Long userId = userService.registerUser(user);
            
            // 成功メッセージ
            ActionMessages messages = new ActionMessages();
            messages.add(ActionMessages.GLOBAL_MESSAGE, 
                new ActionMessage("message.user.create.success", user.getUsername()));
            saveMessages(request, messages);
            
            // 詳細画面にリダイレクト
            return new ActionForward("/user/management.do?method=detail&amp;id=" + userId, true);
            
        } catch (BusinessException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, 
                new ActionMessage("error.user.create.failed", e.getMessage()));
            saveErrors(request, errors);
            
            return mapping.findForward("createForm");
        }
    }
    
    /**
     * ユーザー編集フォーム表示
     */
    public ActionForward editForm(ActionMapping mapping, ActionForm form,
            HttpServletRequest request, HttpServletResponse response) throws Exception {
        
        String userIdStr = request.getParameter("id");
        
        try {
            Long userId = Long.valueOf(userIdStr);
            User user = userService.getUserById(userId);
            
            if (user == null) {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE, 
                    new ActionMessage("error.user.notfound", userIdStr));
                saveErrors(request, errors);
                return mapping.findForward("list");
            }
            
            // エンティティからフォームに変換
            UserForm userForm = (UserForm) form;
            convertEntityToForm(user, userForm);
            
            return mapping.findForward("editForm");
            
        } catch (NumberFormatException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage("error.invalid.userid"));
            saveErrors(request, errors);
            return mapping.findForward("list");
            
        } catch (BusinessException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage("error.user.edit.failed"));
            saveErrors(request, errors);
            return mapping.findForward("error");
        }
    }
    
    /**
     * ユーザー更新処理
     */
    public ActionForward update(ActionMapping mapping, ActionForm form,
            HttpServletRequest request, HttpServletResponse response) throws Exception {
        
        UserForm userForm = (UserForm) form;
        
        try {
            // フォームからエンティティに変換
            User user = convertFormToEntity(userForm);
            user.setUserId(Long.valueOf(userForm.getUserId()));
            
            // ユーザー更新
            boolean result = userService.updateUser(user);
            
            if (result) {
                ActionMessages messages = new ActionMessages();
                messages.add(ActionMessages.GLOBAL_MESSAGE, 
                    new ActionMessage("message.user.update.success", user.getUsername()));
                saveMessages(request, messages);
                
                return new ActionForward("/user/management.do?method=detail&amp;id=" + user.getUserId(), true);
            } else {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage("error.user.update.failed"));
                saveErrors(request, errors);
                return mapping.findForward("editForm");
            }
            
        } catch (BusinessException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, 
                new ActionMessage("error.user.update.failed", e.getMessage()));
            saveErrors(request, errors);
            
            return mapping.findForward("editForm");
        }
    }
    
    /**
     * ユーザー削除処理
     */
    public ActionForward delete(ActionMapping mapping, ActionForm form,
            HttpServletRequest request, HttpServletResponse response) throws Exception {
        
        String userIdStr = request.getParameter("id");
        
        try {
            Long userId = Long.valueOf(userIdStr);
            boolean result = userService.deleteUser(userId);
            
            if (result) {
                ActionMessages messages = new ActionMessages();
                messages.add(ActionMessages.GLOBAL_MESSAGE, 
                    new ActionMessage("message.user.delete.success"));
                saveMessages(request, messages);
            } else {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage("error.user.delete.failed"));
                saveErrors(request, errors);
            }
            
            return mapping.findForward("list");
            
        } catch (NumberFormatException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage("error.invalid.userid"));
            saveErrors(request, errors);
            return mapping.findForward("list");
            
        } catch (BusinessException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, 
                new ActionMessage("error.user.delete.failed", e.getMessage()));
            saveErrors(request, errors);
            return mapping.findForward("list");
        }
    }
    
    // ヘルパーメソッド
    private User convertFormToEntity(UserForm form) {
        User user = new User();
        user.setUsername(form.getUsername());
        user.setEmail(form.getEmail());
        user.setFirstName(form.getFirstName());
        user.setLastName(form.getLastName());
        user.setActive(true);
        return user;
    }
    
    private void convertEntityToForm(User user, UserForm form) {
        form.setUserId(String.valueOf(user.getUserId()));
        form.setUsername(user.getUsername());
        form.setEmail(user.getEmail());
        form.setFirstName(user.getFirstName());
        form.setLastName(user.getLastName());
    }
}</code>
                    </div>

                    <h3 class="section-title">9.5 ページング機能の実装</h3>
                    
                    <div class="exercise-container">
                        <h5>実習 9-7: ページング対応の検索機能</h5>
                        <code>package com.example.util;

/**
 * ページング情報を管理するクラス
 */
public class PageInfo {
    private int currentPage = 1;        // 現在のページ（1から開始）
    private int pageSize = 10;          // 1ページあたりの件数
    private int totalRecords = 0;       // 総レコード数
    private int totalPages = 0;         // 総ページ数
    
    public PageInfo(int currentPage, int pageSize) {
        this.currentPage = Math.max(1, currentPage);
        this.pageSize = Math.max(1, pageSize);
    }
    
    /**
     * 総レコード数を設定し、総ページ数を計算
     */
    public void setTotalRecords(int totalRecords) {
        this.totalRecords = totalRecords;
        this.totalPages = (int) Math.ceil((double) totalRecords / pageSize);
    }
    
    /**
     * OFFSET値を計算（0から開始）
     */
    public int getOffset() {
        return (currentPage - 1) * pageSize;
    }
    
    /**
     * 前のページがあるかチェック
     */
    public boolean hasPrevious() {
        return currentPage > 1;
    }
    
    /**
     * 次のページがあるかチェック
     */
    public boolean hasNext() {
        return currentPage < totalPages;
    }
    
    /**
     * ページ番号のリストを生成（表示用）
     */
    public List&lt;Integer&gt; getPageNumbers() {
        List&lt;Integer&gt; pages = new ArrayList&lt;&gt;();
        
        int startPage = Math.max(1, currentPage - 2);
        int endPage = Math.min(totalPages, currentPage + 2);
        
        for (int i = startPage; i &lt;= endPage; i++) {
            pages.add(i);
        }
        
        return pages;
    }
    
    // getter/setter メソッド
    public int getCurrentPage() { return currentPage; }
    public int getPageSize() { return pageSize; }
    public int getTotalRecords() { return totalRecords; }
    public int getTotalPages() { return totalPages; }
}

/**
 * ページング対応のUserDAO拡張
 */
public class UserDAO extends BaseDAO&lt;User&gt; {
    
    private static final String SELECT_WITH_PAGING = 
        "SELECT user_id, username, email, first_name, last_name, created_date, updated_date, is_active " +
        "FROM users WHERE is_active = 1 ORDER BY username LIMIT ? OFFSET ?";
    
    private static final String COUNT_ACTIVE_USERS = 
        "SELECT COUNT(*) FROM users WHERE is_active = 1";
    
    /**
     * ページング対応のユーザー検索
     */
    public List&lt;User&gt; findWithPaging(PageInfo pageInfo) throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        List&lt;User&gt; users = new ArrayList&lt;&gt;();
        
        try {
            conn = DatabaseManager.getConnection();
            
            // 総件数を取得してPageInfoに設定
            int totalCount = getTotalUserCount();
            pageInfo.setTotalRecords(totalCount);
            
            // ページングクエリ実行
            ps = prepareStatement(conn, SELECT_WITH_PAGING, 
                pageInfo.getPageSize(), pageInfo.getOffset());
            rs = ps.executeQuery();
            
            while (rs.next()) {
                users.add(mapResultSetToEntity(rs));
            }
            
            return users;
            
        } finally {
            closeResources(conn, ps, rs);
        }
    }
    
    /**
     * アクティブユーザーの総数を取得
     */
    public int getTotalUserCount() throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            conn = DatabaseManager.getConnection();
            ps = conn.prepareStatement(COUNT_ACTIVE_USERS);
            rs = ps.executeQuery();
            
            if (rs.next()) {
                return rs.getInt(1);
            }
            return 0;
            
        } finally {
            closeResources(conn, ps, rs);
        }
    }
}</code>
                    </div>

                    <h4>JSPでのページング表示</h4>
                    <div class="exercise-container">
                        <h5>実習 9-8: ページング UI の実装</h5>
                        <code>&lt;!-- ユーザー一覧とページング --&gt;
&lt;h2&gt;ユーザー一覧&lt;/h2&gt;

&lt;!-- 検索結果の件数表示 --&gt;
&lt;p&gt;
    全 &lt;strong&gt;&lt;bean:write name="pageInfo" property="totalRecords"/&gt;&lt;/strong&gt; 件中 
    &lt;strong&gt;
        &lt;%= ((PageInfo)request.getAttribute("pageInfo")).getOffset() + 1 %&gt;
    &lt;/strong&gt; ～ 
    &lt;strong&gt;
        &lt;%= Math.min(((PageInfo)request.getAttribute("pageInfo")).getOffset() + 
                    ((PageInfo)request.getAttribute("pageInfo")).getPageSize(),
                    ((PageInfo)request.getAttribute("pageInfo")).getTotalRecords()) %&gt;
    &lt;/strong&gt; 件を表示
&lt;/p&gt;

&lt;!-- ユーザーテーブル --&gt;
&lt;table class="table table-striped"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;ユーザー名&lt;/th&gt;
            &lt;th&gt;メールアドレス&lt;/th&gt;
            &lt;th&gt;氏名&lt;/th&gt;
            &lt;th&gt;登録日&lt;/th&gt;
            &lt;th&gt;操作&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        &lt;logic:iterate id="user" name="userList" type="com.example.bean.User"&gt;
            &lt;tr&gt;
                &lt;td&gt;&lt;bean:write name="user" property="username"/&gt;&lt;/td&gt;
                &lt;td&gt;&lt;bean:write name="user" property="email"/&gt;&lt;/td&gt;
                &lt;td&gt;&lt;bean:write name="user" property="firstName"/&gt; &lt;bean:write name="user" property="lastName"/&gt;&lt;/td&gt;
                &lt;td&gt;&lt;bean:write name="user" property="createdDate" format="yyyy/MM/dd"/&gt;&lt;/td&gt;
                &lt;td&gt;
                    &lt;html:link action="/user/management" paramId="method" paramValue="detail" 
                               paramName="user" paramProperty="userId" name="id"&gt;
                        詳細
                    &lt;/html:link&gt;
                    |
                    &lt;html:link action="/user/management" paramId="method" paramValue="editForm" 
                               paramName="user" paramProperty="userId" name="id"&gt;
                        編集
                    &lt;/html:link&gt;
                &lt;/td&gt;
            &lt;/tr&gt;
        &lt;/logic:iterate&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;!-- ページング ナビゲーション --&gt;
&lt;nav aria-label="ページナビゲーション"&gt;
    &lt;ul class="pagination justify-content-center"&gt;
        &lt;!-- 前のページ --&gt;
        &lt;logic:equal name="pageInfo" property="hasPrevious" value="true"&gt;
            &lt;li class="page-item"&gt;
                &lt;html:link styleClass="page-link" action="/user/management"&gt;
                    &lt;html:param name="method" value="list"/&gt;
                    &lt;html:param name="page" value="${pageInfo.currentPage - 1}"/&gt;
                    &amp;laquo; 前へ
                &lt;/html:link&gt;
            &lt;/li&gt;
        &lt;/logic:equal&gt;
        &lt;logic:equal name="pageInfo" property="hasPrevious" value="false"&gt;
            &lt;li class="page-item disabled"&gt;
                &lt;span class="page-link"&gt;&amp;laquo; 前へ&lt;/span&gt;
            &lt;/li&gt;
        &lt;/logic:equal&gt;
        
        &lt;!-- ページ番号 --&gt;
        &lt;logic:iterate id="pageNum" name="pageInfo" property="pageNumbers" type="java.lang.Integer"&gt;
            &lt;logic:equal name="pageNum" value="${pageInfo.currentPage}"&gt;
                &lt;li class="page-item active"&gt;
                    &lt;span class="page-link"&gt;&lt;bean:write name="pageNum"/&gt;&lt;/span&gt;
                &lt;/li&gt;
            &lt;/logic:equal&gt;
            &lt;logic:notEqual name="pageNum" value="${pageInfo.currentPage}"&gt;
                &lt;li class="page-item"&gt;
                    &lt;html:link styleClass="page-link" action="/user/management"&gt;
                        &lt;html:param name="method" value="list"/&gt;
                        &lt;html:param name="page" value="${pageNum}"/&gt;
                        &lt;bean:write name="pageNum"/&gt;
                    &lt;/html:link&gt;
                &lt;/li&gt;
            &lt;/logic:notEqual&gt;
        &lt;/logic:iterate&gt;
        
        &lt;!-- 次のページ --&gt;
        &lt;logic:equal name="pageInfo" property="hasNext" value="true"&gt;
            &lt;li class="page-item"&gt;
                &lt;html:link styleClass="page-link" action="/user/management"&gt;
                    &lt;html:param name="method" value="list"/&gt;
                    &lt;html:param name="page" value="${pageInfo.currentPage + 1}"/&gt;
                    次へ &amp;raquo;
                &lt;/html:link&gt;
            &lt;/li&gt;
        &lt;/logic:equal&gt;
        &lt;logic:equal name="pageInfo" property="hasNext" value="false"&gt;
            &lt;li class="page-item disabled"&gt;
                &lt;span class="page-link"&gt;次へ &amp;raquo;&lt;/span&gt;
            &lt;/li&gt;
        &lt;/logic:equal&gt;
    &lt;/ul&gt;
&lt;/nav&gt;</code>
                    </div>

                    <div class="warning">
                        <h5>データベース連携時の注意点</h5>
                        <ul>
                            <li><strong>リソース管理</strong>: Connection, PreparedStatement, ResultSet の適切なクローズ</li>
                            <li><strong>SQLインジェクション対策</strong>: PreparedStatementの使用必須</li>
                            <li><strong>トランザクション境界</strong>: ビジネスロジック単位でのトランザクション設計</li>
                            <li><strong>例外処理</strong>: SQLException の適切な処理とロールバック</li>
                            <li><strong>パフォーマンス</strong>: N+1問題の回避、適切なインデックス設計</li>
                            <li><strong>コネクションプール</strong>: 適切なプール設定とモニタリング</li>
                        </ul>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>DAOパターンを使用する利点と、Struts 1.xアプリケーションでの実装方法を説明してください。</li>
                            <li>トランザクション管理をサービス層で行う理由と、実装時の注意点を説明してください。</li>
                            <li>PreparedStatementを使用することで防げるセキュリティ脆弱性と、その仕組みを説明してください。</li>
                            <li>大量データを扱う際のページング実装で考慮すべきパフォーマンス要因を3つ挙げてください。</li>
                            <li>データベース接続でコネクションプールを使用する利点と、設定で重要なパラメータを説明してください。</li>
                        </ol>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="struts1-learning-material-8.html" class="btn btn-secondary">← 前の章</a>
                        <a href="struts1-learning-material-10.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>