<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struts 1.x学習教材 第9章 - データベース連携と実践的開発</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #2196f3;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        /* ボタンスタイル */
        .btn-orange {
            background-color: #f57c00;
            border-color: #f57c00;
            color: white;
        }

        .btn-orange:hover {
            background-color: #e65100;
            border-color: #e65100;
            color: white;
        }

        /* DB関連のスタイル */
        .db-card {
            border: 2px solid #4caf50;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .db-card .card-header {
            background-color: #e8f5e8;
            border-bottom: 1px solid #4caf50;
            font-weight: bold;
            color: #2e7d32;
        }

        /* アニメーション */
        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand text-white fw-bold" href="#main-content">🗄️ Struts 1.x 学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="../README.md">📚 Strutsガイド</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="struts1-learning-material-8.html">⬅️ 第8章</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="struts1-learning-material-10.html">➡️ 第10章</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                        <span>第9章の内容</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#intro">🗄️ はじめに</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#database-basics">📊 データベース連携の基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#jdbc-connection">🔌 JDBC接続管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#dao-pattern">🏗️ DAOパターンの実装</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#crud-operations">✏️ CRUD操作の実装</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#transaction">⚡ トランザクション管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#practical-app">💼 実践的アプリケーション開発</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#exercise">💻 実習課題</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#quiz">📝 理解度確認</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツエリア -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" id="main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                    <h1 class="chapter-title">第9章 - データベース連携と実践的開発</h1>
                </div>

                <!-- 学習目標 -->
                <div class="highlight">
                    <h3>🎯 この章の学習目標</h3>
                    <ul>
                        <li>Webアプリケーションにおけるデータベース連携の重要性を理解する</li>
                        <li>JDBCを使用したデータベース接続と基本操作を習得する</li>
                        <li>DAOパターンによる効果的なデータアクセス層の設計を学ぶ</li>
                        <li>CRUD操作の安全で効率的な実装方法を理解する</li>
                        <li>トランザクション管理とデータ整合性の確保方法を習得する</li>
                        <li>実用的な業務アプリケーションの開発手法を学習する</li>
                    </ul>
                </div>

                <!-- はじめに -->
                <section id="intro">
                    <h2 class="section-title">🗄️ はじめに</h2>
                    
                    <p>実用的なWebアプリケーションでは、<strong>データベース連携</strong>が不可欠です。ユーザーの情報、業務データ、設定情報など、様々なデータを永続化し、効率的に管理する必要があります。Struts 1.xアプリケーションにおけるデータベース連携の実装方法を学習します。</p>

                    <div class="highlight">
                        <h4>💡 なぜデータベース連携が重要なのか？</h4>
                        <p>Webアプリケーションがデータベースと連携する理由：</p>
                        
                        <ul>
                            <li><strong>データ永続化</strong>：アプリケーション再起動後もデータを保持</li>
                            <li><strong>データ共有</strong>：複数のユーザー・セッション間でのデータ共有</li>
                            <li><strong>データ整合性</strong>：ACID特性による信頼性の高いデータ管理</li>
                            <li><strong>高性能</strong>：インデックスやクエリ最適化による高速データアクセス</li>
                            <li><strong>セキュリティ</strong>：アクセス制御と監査機能</li>
                        </ul>
                        
                        <p><strong>例え：</strong> データベースは「企業の書庫システム」のようなものです。重要な書類（データ）を整理整頓して保管し、必要な時に素早く検索・取得できるようにし、複数の部署（ユーザー）が安全にアクセスできるように管理します。</p>
                    </div>

                    <div class="mermaid">
                        graph LR
                            A[Webブラウザ] --> B[Strutsアプリケーション]
                            B --> C[Action層]
                            C --> D[Service層]
                            D --> E[DAO層]
                            E --> F[データベース]
                            
                            F --> G[(ユーザーテーブル)]
                            F --> H[(商品テーブル)]
                            F --> I[(注文テーブル)]
                            
                            style A fill:#e3f2fd
                            style B fill:#fff3e0
                            style C fill:#fff3e0
                            style D fill:#e8f5e8
                            style E fill:#e8f5e8
                            style F fill:#ffecb3
                    </div>
                </section>

                <!-- データベース連携の基礎 -->
                <section id="database-basics">
                    <h2 class="section-title">📊 データベース連携の基礎概念</h2>
                    
                    <p>Webアプリケーションのデータベース連携では、適切なアーキテクチャと設計パターンを採用することが重要です。</p>

                    <h3>🏗️ 多層アーキテクチャの採用</h3>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card db-card h-100">
                                <div class="card-header">
                                    🖥️ プレゼンテーション層
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>JSP、Strutsタグライブラリ</li>
                                        <li>ユーザーインターフェース</li>
                                        <li>入力検証（フロントエンド）</li>
                                        <li>画面遷移制御</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card db-card h-100">
                                <div class="card-header">
                                    ⚙️ ビジネス層（Service層）
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>業務ロジックの実装</li>
                                        <li>トランザクション管理</li>
                                        <li>入力検証（サーバーサイド）</li>
                                        <li>複数DAOの協調制御</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card db-card h-100">
                                <div class="card-header">
                                    🔄 Action層（Controller層）
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>HTTPリクエスト処理</li>
                                        <li>フォームデータの変換</li>
                                        <li>Service層への委譲</li>
                                        <li>レスポンス生成</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card db-card h-100">
                                <div class="card-header">
                                    🗄️ データアクセス層（DAO層）
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>データベースアクセス</li>
                                        <li>SQL実行とマッピング</li>
                                        <li>コネクション管理</li>
                                        <li>例外ハンドリング</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>💾 データベース設計の考慮事項</h3>
                    
                    <div class="info">
                        <h4>🎯 効果的なテーブル設計</h4>
                        <ul>
                            <li><strong>正規化</strong>：データの重複を避け、整合性を保つ</li>
                            <li><strong>主キー設計</strong>：一意性と効率性を考慮した主キー選択</li>
                            <li><strong>外部キー制約</strong>：参照整合性の確保</li>
                            <li><strong>インデックス</strong>：クエリ性能を向上させる適切なインデックス設計</li>
                            <li><strong>データ型選択</strong>：適切なデータ型による性能とストレージの最適化</li>
                        </ul>
                    </div>

                    <h4>📋 サンプルテーブル設計例</h4>
                    
                    <pre class="code-block"><code class="language-sql">-- ユーザーマスタテーブル
CREATE TABLE users (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    salt VARCHAR(32) NOT NULL,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    birth_date DATE,
    gender CHAR(1),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

-- 商品マスタテーブル
CREATE TABLE products (
    product_id INT PRIMARY KEY AUTO_INCREMENT,
    product_name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    category_id INT,
    stock_quantity INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    INDEX idx_category (category_id),
    INDEX idx_price (price)
);

-- 注文テーブル
CREATE TABLE orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING',
    shipping_address TEXT,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);</code></pre>
                </section>

                <!-- JDBC接続管理 -->
                <section id="jdbc-connection">
                    <h2 class="section-title">🔌 JDBC接続管理とコネクションプール</h2>
                    
                    <p>効率的なデータベース連携には、適切なJDBC接続管理が不可欠です。コネクションプールを使用することで、パフォーマンスとリソース管理を最適化できます。</p>

                    <h3>🔧 基本的なJDBC接続</h3>
                    
                    <pre class="code-block"><code class="language-java">// 基本的なJDBC接続クラス
public class DatabaseUtil {
    
    private static final String JDBC_URL = "jdbc:mysql://localhost:3306/myapp";
    private static final String USERNAME = "appuser";
    private static final String PASSWORD = "password";
    
    static {
        try {
            // JDBCドライバの登録
            Class.forName("com.mysql.cj.jdbc.Driver");
        } catch (ClassNotFoundException e) {
            throw new RuntimeException("Failed to load JDBC driver", e);
        }
    }
    
    /**
     * データベース接続を取得
     */
    public static Connection getConnection() throws SQLException {
        return DriverManager.getConnection(JDBC_URL, USERNAME, PASSWORD);
    }
    
    /**
     * リソースのクリーンアップ
     */
    public static void closeResources(Connection conn, PreparedStatement stmt, ResultSet rs) {
        if (rs != null) {
            try { rs.close(); } catch (SQLException e) { /* ログ出力 */ }
        }
        if (stmt != null) {
            try { stmt.close(); } catch (SQLException e) { /* ログ出力 */ }
        }
        if (conn != null) {
            try { conn.close(); } catch (SQLException e) { /* ログ出力 */ }
        }
    }
}</code></pre>

                    <h3>🏊 コネクションプールの実装</h3>
                    
                    <pre class="code-block"><code class="language-java">import javax.sql.DataSource;
import org.apache.commons.dbcp2.BasicDataSource;

// コネクションプール管理クラス
public class ConnectionPoolManager {
    
    private static BasicDataSource dataSource;
    
    static {
        dataSource = new BasicDataSource();
        
        // データベース接続設定
        dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
        dataSource.setUrl("jdbc:mysql://localhost:3306/myapp?useSSL=false&serverTimezone=UTC");
        dataSource.setUsername("appuser");
        dataSource.setPassword("password");
        
        // コネクションプール設定
        dataSource.setInitialSize(5);          // 初期コネクション数
        dataSource.setMaxTotal(20);            // 最大コネクション数
        dataSource.setMaxIdle(10);             // アイドル状態の最大コネクション数
        dataSource.setMinIdle(5);              // アイドル状態の最小コネクション数
        dataSource.setMaxWaitMillis(10000);    // コネクション取得の最大待機時間
        
        // 検証クエリの設定
        dataSource.setValidationQuery("SELECT 1");
        dataSource.setTestOnBorrow(true);
        dataSource.setTestWhileIdle(true);
        dataSource.setTimeBetweenEvictionRunsMillis(30000);
    }
    
    public static DataSource getDataSource() {
        return dataSource;
    }
    
    public static Connection getConnection() throws SQLException {
        return dataSource.getConnection();
    }
    
    public static void shutdown() {
        try {
            if (dataSource != null) {
                dataSource.close();
            }
        } catch (SQLException e) {
            System.err.println("Error closing data source: " + e.getMessage());
        }
    }
}</code></pre>

                    <div class="warning">
                        <h4>⚠️ JDBC使用時の注意点</h4>
                        <ul>
                            <li><strong>リソース管理</strong>：Connection、Statement、ResultSetは必ずクローズする</li>
                            <li><strong>SQLインジェクション対策</strong>：PreparedStatementを使用し、パラメータを適切に設定</li>
                            <li><strong>例外処理</strong>：SQLExceptionを適切にキャッチし、ログに記録</li>
                            <li><strong>コネクションプール</strong>：性能向上のためコネクションプールを活用</li>
                        </ul>
                    </div>
                </section>

                <!-- DAOパターンの実装 -->
                <section id="dao-pattern">
                    <h2 class="section-title">🏗️ DAOパターンの実装</h2>
                    
                    <p><strong>DAO（Data Access Object）パターン</strong>は、データアクセスロジックをビジネスロジックから分離し、保守性と再利用性を向上させる設計パターンです。</p>

                    <h3>📋 DAOの基本構造</h3>
                    
                    <pre class="code-block"><code class="language-java">// Userエンティティクラス
public class User {
    private int userId;
    private String username;
    private String email;
    private String passwordHash;
    private String salt;
    private String firstName;
    private String lastName;
    private Date birthDate;
    private char gender;
    private Date createdAt;
    private Date updatedAt;
    private boolean active;
    
    // コンストラクタ
    public User() {}
    
    public User(String username, String email, String passwordHash) {
        this.username = username;
        this.email = email;
        this.passwordHash = passwordHash;
        this.active = true;
        this.createdAt = new Date();
        this.updatedAt = new Date();
    }
    
    // getter/setterメソッド...
}

// UserDAO インターフェース
public interface UserDAO {
    
    // CRUD基本操作
    void create(User user) throws DAOException;
    User findById(int userId) throws DAOException;
    User findByUsername(String username) throws DAOException;
    User findByEmail(String email) throws DAOException;
    List&lt;User&gt; findAll() throws DAOException;
    void update(User user) throws DAOException;
    void delete(int userId) throws DAOException;
    
    // 業務固有のクエリ
    List&lt;User&gt; findActiveUsers() throws DAOException;
    List&lt;User&gt; searchUsers(String keyword, int limit) throws DAOException;
    boolean existsByUsername(String username) throws DAOException;
    boolean existsByEmail(String email) throws DAOException;
    int countUsers() throws DAOException;
}</code></pre>

                    <h3>🔨 DAO実装クラス</h3>
                    
                    <pre class="code-block"><code class="language-java">public class UserDAOImpl implements UserDAO {
    
    @Override
    public void create(User user) throws DAOException {
        String sql = "INSERT INTO users (username, email, password_hash, salt, first_name, last_name, birth_date, gender) "
                   + "VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
        
        Connection conn = null;
        PreparedStatement stmt = null;
        
        try {
            conn = ConnectionPoolManager.getConnection();
            stmt = conn.prepareStatement(sql, PreparedStatement.RETURN_GENERATED_KEYS);
            
            stmt.setString(1, user.getUsername());
            stmt.setString(2, user.getEmail());
            stmt.setString(3, user.getPasswordHash());
            stmt.setString(4, user.getSalt());
            stmt.setString(5, user.getFirstName());
            stmt.setString(6, user.getLastName());
            stmt.setDate(7, user.getBirthDate() != null ? new java.sql.Date(user.getBirthDate().getTime()) : null);
            stmt.setString(8, String.valueOf(user.getGender()));
            
            int rowsAffected = stmt.executeUpdate();
            if (rowsAffected == 0) {
                throw new DAOException("Creating user failed, no rows affected.");
            }
            
            // 生成されたIDを取得
            ResultSet generatedKeys = stmt.getGeneratedKeys();
            if (generatedKeys.next()) {
                user.setUserId(generatedKeys.getInt(1));
            }
            
        } catch (SQLException e) {
            throw new DAOException("Error creating user: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, null);
        }
    }
    
    @Override
    public User findById(int userId) throws DAOException {
        String sql = "SELECT * FROM users WHERE user_id = ?";
        
        Connection conn = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        
        try {
            conn = ConnectionPoolManager.getConnection();
            stmt = conn.prepareStatement(sql);
            stmt.setInt(1, userId);
            
            rs = stmt.executeQuery();
            
            if (rs.next()) {
                return mapResultSetToUser(rs);
            }
            return null;
            
        } catch (SQLException e) {
            throw new DAOException("Error finding user by ID: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, rs);
        }
    }
    
    @Override
    public List&lt;User&gt; findAll() throws DAOException {
        String sql = "SELECT * FROM users ORDER BY created_at DESC";
        List&lt;User&gt; users = new ArrayList&lt;&gt;();
        
        Connection conn = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        
        try {
            conn = ConnectionPoolManager.getConnection();
            stmt = conn.prepareStatement(sql);
            rs = stmt.executeQuery();
            
            while (rs.next()) {
                users.add(mapResultSetToUser(rs));
            }
            
            return users;
            
        } catch (SQLException e) {
            throw new DAOException("Error finding all users: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, rs);
        }
    }
    
    @Override
    public void update(User user) throws DAOException {
        String sql = "UPDATE users SET username=?, email=?, first_name=?, last_name=?, "
                   + "birth_date=?, gender=?, updated_at=CURRENT_TIMESTAMP WHERE user_id=?";
        
        Connection conn = null;
        PreparedStatement stmt = null;
        
        try {
            conn = ConnectionPoolManager.getConnection();
            stmt = conn.prepareStatement(sql);
            
            stmt.setString(1, user.getUsername());
            stmt.setString(2, user.getEmail());
            stmt.setString(3, user.getFirstName());
            stmt.setString(4, user.getLastName());
            stmt.setDate(5, user.getBirthDate() != null ? new java.sql.Date(user.getBirthDate().getTime()) : null);
            stmt.setString(6, String.valueOf(user.getGender()));
            stmt.setInt(7, user.getUserId());
            
            int rowsAffected = stmt.executeUpdate();
            if (rowsAffected == 0) {
                throw new DAOException("Updating user failed, no rows affected.");
            }
            
        } catch (SQLException e) {
            throw new DAOException("Error updating user: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, null);
        }
    }
    
    // ResultSetからUserオブジェクトにマッピング
    private User mapResultSetToUser(ResultSet rs) throws SQLException {
        User user = new User();
        user.setUserId(rs.getInt("user_id"));
        user.setUsername(rs.getString("username"));
        user.setEmail(rs.getString("email"));
        user.setPasswordHash(rs.getString("password_hash"));
        user.setSalt(rs.getString("salt"));
        user.setFirstName(rs.getString("first_name"));
        user.setLastName(rs.getString("last_name"));
        user.setBirthDate(rs.getDate("birth_date"));
        
        String genderStr = rs.getString("gender");
        user.setGender(genderStr != null && !genderStr.isEmpty() ? genderStr.charAt(0) : ' ');
        
        user.setCreatedAt(rs.getTimestamp("created_at"));
        user.setUpdatedAt(rs.getTimestamp("updated_at"));
        user.setActive(rs.getBoolean("is_active"));
        
        return user;
    }
}</code></pre>

                    <div class="highlight">
                        <h4>💡 DAOパターンの利点</h4>
                        <ul>
                            <li><strong>関心の分離</strong>：ビジネスロジックとデータアクセスロジックを分離</li>
                            <li><strong>テスト容易性</strong>：モックオブジェクトによる単体テストが容易</li>
                            <li><strong>保守性</strong>：データベーススキーマ変更時の影響を局所化</li>
                            <li><strong>再利用性</strong>：複数のサービスクラスから同じDAOを利用可能</li>
                        </ul>
                    </div>
                </section>

                <!-- CRUD操作の実装 -->
                <section id="crud-operations">
                    <h2 class="section-title">✏️ 実践的なCRUD操作の実装</h2>
                    
                    <p>実用的なWebアプリケーションでは、基本的なCRUD操作に加えて、検索、ページング、ソートなどの高度な機能が必要です。</p>

                    <h3>🔍 高度な検索機能の実装</h3>
                    
                    <pre class="code-block"><code class="language-java">// 検索条件クラス
public class UserSearchCriteria {
    private String usernamePattern;
    private String emailPattern;
    private String namePattern;
    private Character gender;
    private Date birthDateFrom;
    private Date birthDateTo;
    private Boolean active;
    private String sortBy = "created_at";
    private String sortOrder = "DESC";
    private int offset = 0;
    private int limit = 20;
    
    // getter/setterメソッド...
}

// UserDAOインターフェースに追加
public interface UserDAO {
    // ... 既存のメソッド ...
    
    List&lt;User&gt; searchUsers(UserSearchCriteria criteria) throws DAOException;
    int countSearchUsers(UserSearchCriteria criteria) throws DAOException;
}

// 検索機能の実装
public class UserDAOImpl implements UserDAO {
    
    @Override
    public List&lt;User&gt; searchUsers(UserSearchCriteria criteria) throws DAOException {
        StringBuilder sql = new StringBuilder("SELECT * FROM users WHERE 1=1");
        List&lt;Object&gt; parameters = new ArrayList&lt;&gt;();
        
        // 動的WHERE句の構築
        appendSearchConditions(sql, parameters, criteria);
        
        // ソート句の追加
        sql.append(" ORDER BY ").append(criteria.getSortBy())
           .append(" ").append(criteria.getSortOrder());
        
        // ページング句の追加
        sql.append(" LIMIT ? OFFSET ?");
        parameters.add(criteria.getLimit());
        parameters.add(criteria.getOffset());
        
        Connection conn = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        List&lt;User&gt; users = new ArrayList&lt;&gt;();
        
        try {
            conn = ConnectionPoolManager.getConnection();
            stmt = conn.prepareStatement(sql.toString());
            
            // パラメータの設定
            for (int i = 0; i < parameters.size(); i++) {
                stmt.setObject(i + 1, parameters.get(i));
            }
            
            rs = stmt.executeQuery();
            
            while (rs.next()) {
                users.add(mapResultSetToUser(rs));
            }
            
            return users;
            
        } catch (SQLException e) {
            throw new DAOException("Error searching users: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, rs);
        }
    }
    
    private void appendSearchConditions(StringBuilder sql, List&lt;Object&gt; parameters, 
                                      UserSearchCriteria criteria) {
        
        if (criteria.getUsernamePattern() != null && !criteria.getUsernamePattern().trim().isEmpty()) {
            sql.append(" AND username LIKE ?");
            parameters.add("%" + criteria.getUsernamePattern() + "%");
        }
        
        if (criteria.getEmailPattern() != null && !criteria.getEmailPattern().trim().isEmpty()) {
            sql.append(" AND email LIKE ?");
            parameters.add("%" + criteria.getEmailPattern() + "%");
        }
        
        if (criteria.getNamePattern() != null && !criteria.getNamePattern().trim().isEmpty()) {
            sql.append(" AND (first_name LIKE ? OR last_name LIKE ?)");
            String namePattern = "%" + criteria.getNamePattern() + "%";
            parameters.add(namePattern);
            parameters.add(namePattern);
        }
        
        if (criteria.getGender() != null) {
            sql.append(" AND gender = ?");
            parameters.add(String.valueOf(criteria.getGender()));
        }
        
        if (criteria.getBirthDateFrom() != null) {
            sql.append(" AND birth_date >= ?");
            parameters.add(new java.sql.Date(criteria.getBirthDateFrom().getTime()));
        }
        
        if (criteria.getBirthDateTo() != null) {
            sql.append(" AND birth_date <= ?");
            parameters.add(new java.sql.Date(criteria.getBirthDateTo().getTime()));
        }
        
        if (criteria.getActive() != null) {
            sql.append(" AND is_active = ?");
            parameters.add(criteria.getActive());
        }
    }
}</code></pre>

                    <h3>📊 Serviceクラスでの業務ロジック実装</h3>
                    
                    <pre class="code-block"><code class="language-java">public class UserService {
    
    private UserDAO userDAO = new UserDAOImpl();
    
    /**
     * ユーザー登録処理
     */
    public User registerUser(String username, String email, String password, 
                           String firstName, String lastName) throws ServiceException {
        
        try {
            // 重複チェック
            if (userDAO.existsByUsername(username)) {
                throw new ServiceException("Username already exists: " + username);
            }
            
            if (userDAO.existsByEmail(email)) {
                throw new ServiceException("Email already exists: " + email);
            }
            
            // パスワードハッシュ化
            String salt = PasswordUtil.generateSalt();
            String hashedPassword = PasswordUtil.hashPassword(password, salt);
            
            // ユーザーオブジェクト作成
            User user = new User(username, email, hashedPassword);
            user.setSalt(salt);
            user.setFirstName(firstName);
            user.setLastName(lastName);
            
            // データベースに保存
            userDAO.create(user);
            
            return user;
            
        } catch (DAOException e) {
            throw new ServiceException("Failed to register user", e);
        }
    }
    
    /**
     * ユーザー認証処理
     */
    public User authenticateUser(String username, String password) throws ServiceException {
        try {
            User user = userDAO.findByUsername(username);
            
            if (user == null || !user.isActive()) {
                return null; // 認証失敗
            }
            
            // パスワード検証
            if (PasswordUtil.verifyPassword(password, user.getPasswordHash(), user.getSalt())) {
                return user; // 認証成功
            }
            
            return null; // 認証失敗
            
        } catch (DAOException e) {
            throw new ServiceException("Authentication failed", e);
        }
    }
    
    /**
     * ユーザー検索処理
     */
    public SearchResult&lt;User&gt; searchUsers(UserSearchCriteria criteria) throws ServiceException {
        try {
            List&lt;User&gt; users = userDAO.searchUsers(criteria);
            int totalCount = userDAO.countSearchUsers(criteria);
            
            return new SearchResult&lt;&gt;(users, totalCount, criteria.getOffset(), criteria.getLimit());
            
        } catch (DAOException e) {
            throw new ServiceException("Failed to search users", e);
        }
    }
}</code></pre>
                </section>

                <!-- トランザクション管理 -->
                <section id="transaction">
                    <h2 class="section-title">⚡ トランザクション管理とデータ整合性</h2>
                    
                    <p>複数のテーブルにまたがる操作や、データ整合性が重要な処理では、適切な<strong>トランザクション管理</strong>が必要です。</p>

                    <h3>🔒 基本的なトランザクション制御</h3>
                    
                    <pre class="code-block"><code class="language-java">// トランザクション管理ユーティリティ
public class TransactionManager {
    
    public static &lt;T&gt; T executeInTransaction(TransactionCallback&lt;T&gt; callback) throws ServiceException {
        Connection conn = null;
        try {
            conn = ConnectionPoolManager.getConnection();
            conn.setAutoCommit(false);
            
            T result = callback.execute(conn);
            
            conn.commit();
            return result;
            
        } catch (Exception e) {
            if (conn != null) {
                try {
                    conn.rollback();
                } catch (SQLException rollbackEx) {
                    // ログに記録
                    System.err.println("Rollback failed: " + rollbackEx.getMessage());
                }
            }
            throw new ServiceException("Transaction failed", e);
            
        } finally {
            if (conn != null) {
                try {
                    conn.setAutoCommit(true);
                    conn.close();
                } catch (SQLException e) {
                    // ログに記録
                    System.err.println("Failed to close connection: " + e.getMessage());
                }
            }
        }
    }
    
    // コールバックインターフェース
    public interface TransactionCallback&lt;T&gt; {
        T execute(Connection conn) throws Exception;
    }
}

// トランザクションを使用した複合操作
public class OrderService {
    
    private UserDAO userDAO = new UserDAOImpl();
    private ProductDAO productDAO = new ProductDAOImpl();
    private OrderDAO orderDAO = new OrderDAOImpl();
    
    /**
     * 注文処理（トランザクション使用）
     */
    public Order createOrder(int userId, List&lt;OrderItem&gt; items) throws ServiceException {
        
        return TransactionManager.executeInTransaction(conn -&gt; {
            
            // 1. ユーザー存在確認
            User user = userDAO.findById(userId, conn);
            if (user == null || !user.isActive()) {
                throw new ServiceException("Invalid user: " + userId);
            }
            
            // 2. 商品在庫確認・引当
            BigDecimal totalAmount = BigDecimal.ZERO;
            for (OrderItem item : items) {
                Product product = productDAO.findById(item.getProductId(), conn);
                if (product == null || !product.isActive()) {
                    throw new ServiceException("Invalid product: " + item.getProductId());
                }
                
                if (product.getStockQuantity() < item.getQuantity()) {
                    throw new ServiceException("Insufficient stock for product: " + product.getProductName());
                }
                
                // 在庫減算
                product.setStockQuantity(product.getStockQuantity() - item.getQuantity());
                productDAO.updateStock(product, conn);
                
                // 合計金額計算
                totalAmount = totalAmount.add(product.getPrice().multiply(new BigDecimal(item.getQuantity())));
            }
            
            // 3. 注文作成
            Order order = new Order();
            order.setUserId(userId);
            order.setTotalAmount(totalAmount);
            order.setStatus("CONFIRMED");
            order.setOrderDate(new Date());
            
            orderDAO.create(order, conn);
            
            // 4. 注文明細作成
            for (OrderItem item : items) {
                item.setOrderId(order.getOrderId());
                orderDAO.createOrderItem(item, conn);
            }
            
            return order;
        });
    }
}</code></pre>

                    <div class="info">
                        <h4>🎯 ACID特性の保証</h4>
                        <ul>
                            <li><strong>Atomicity（原子性）</strong>：すべて成功するかすべて失敗するか</li>
                            <li><strong>Consistency（一貫性）</strong>：データベースの整合性制約を維持</li>
                            <li><strong>Isolation（独立性）</strong>：同時実行トランザクション間の分離</li>
                            <li><strong>Durability（永続性）</strong>：コミット後のデータの永続保存</li>
                        </ul>
                    </div>
                </section>

                <!-- 実践的アプリケーション開発 -->
                <section id="practical-app">
                    <h2 class="section-title">💼 実践的アプリケーション開発</h2>
                    
                    <p>学習した技術を統合して、実用的な業務アプリケーションの開発手法を学習します。</p>

                    <h3>🏗️ アプリケーションアーキテクチャ</h3>
                    
                    <div class="mermaid">
                        graph TB
                            A[JSPページ] --> B[Actionクラス]
                            B --> C[Serviceクラス]
                            C --> D[DAOクラス]
                            D --> E[データベース]
                            
                            F[ActionForm] --> B
                            B --> G[業務例外処理]
                            C --> H[トランザクション管理]
                            
                            I[設定ファイル] --> J[struts-config.xml]
                            I --> K[validation.xml]
                            I --> L[MessageResources.properties]
                            
                            style A fill:#e3f2fd
                            style B fill:#fff3e0
                            style C fill:#e8f5e8
                            style D fill:#e8f5e8
                            style E fill:#ffecb3
                    </div>

                    <h3>📋 実用的な機能実装例</h3>
                    
                    <pre class="code-block"><code class="language-java">// ユーザー一覧表示Action
public class UserListAction extends Action {
    
    private UserService userService = new UserService();
    
    public ActionForward execute(ActionMapping mapping, ActionForm form,
                                HttpServletRequest request, 
                                HttpServletResponse response) throws Exception {
        
        try {
            // 検索条件の取得
            UserSearchForm searchForm = (UserSearchForm) form;
            UserSearchCriteria criteria = createSearchCriteria(searchForm);
            
            // 検索実行
            SearchResult&lt;User&gt; result = userService.searchUsers(criteria);
            
            // 結果をリクエストスコープに設定
            request.setAttribute("userList", result.getItems());
            request.setAttribute("totalCount", result.getTotalCount());
            request.setAttribute("currentPage", criteria.getOffset() / criteria.getLimit() + 1);
            request.setAttribute("totalPages", 
                (result.getTotalCount() + criteria.getLimit() - 1) / criteria.getLimit());
            
            return mapping.findForward("success");
            
        } catch (ServiceException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, 
                      new ActionMessage("error.user.search.failed"));
            saveErrors(request, errors);
            return mapping.findForward("error");
        }
    }
    
    private UserSearchCriteria createSearchCriteria(UserSearchForm form) {
        UserSearchCriteria criteria = new UserSearchCriteria();
        
        if (form.getUsername() != null && !form.getUsername().trim().isEmpty()) {
            criteria.setUsernamePattern(form.getUsername().trim());
        }
        
        if (form.getEmail() != null && !form.getEmail().trim().isEmpty()) {
            criteria.setEmailPattern(form.getEmail().trim());
        }
        
        // ページング設定
        int page = form.getPage() > 0 ? form.getPage() : 1;
        int limit = 20; // 1ページあたりの件数
        criteria.setOffset((page - 1) * limit);
        criteria.setLimit(limit);
        
        return criteria;
    }
}</code></pre>

                    <div class="highlight">
                        <h4>💡 実践的開発のポイント</h4>
                        <ul>
                            <li><strong>レイヤー分離</strong>：各層の責任を明確に分離</li>
                            <li><strong>例外処理</strong>：適切な例外処理とエラーメッセージ</li>
                            <li><strong>ページング</strong>：大量データの効率的な表示</li>
                            <li><strong>検索機能</strong>：ユーザビリティを考慮した検索UI</li>
                            <li><strong>バリデーション</strong>：クライアント・サーバー両面での検証</li>
                        </ul>
                    </div>
                </section>

                <!-- 実習課題 -->
                <section id="exercise">
                    <div class="exercise-container">
                        <h2>💻 実習課題</h2>
                        
                        <h3>📋 課題: 書籍管理システムの開発</h3>
                        <p>データベース連携を活用した書籍管理システムを実装してください。</p>
                        
                        <div class="highlight">
                            <h4>🎯 実装要件</h4>
                            <ul>
                                <li><strong>データベース設計</strong>：書籍、カテゴリ、貸出記録のテーブル設計</li>
                                <li><strong>CRUD機能</strong>：書籍の登録・更新・削除・検索</li>
                                <li><strong>高度な検索</strong>：タイトル・著者・カテゴリによる複合検索</li>
                                <li><strong>貸出管理</strong>：書籍の貸出・返却処理（トランザクション使用）</li>
                                <li><strong>ページング</strong>：大量の書籍データの分割表示</li>
                                <li><strong>レポート機能</strong>：貸出統計の表示</li>
                            </ul>
                        </div>

                        <h4>💡 実装のポイント</h4>
                        <ul>
                            <li>適切なテーブル設計と正規化</li>
                            <li>DAOパターンによるデータアクセス層の実装</li>
                            <li>トランザクション管理による整合性の確保</li>
                            <li>エラーハンドリングとユーザビリティの向上</li>
                        </ul>
                    </div>
                </section>

                <!-- 理解度確認クイズ -->
                <section id="quiz">
                    <div class="quiz-container">
                        <h2>📝 理解度確認クイズ</h2>

                        <div class="quiz-item">
                            <h4>❓ 問題1</h4>
                            <p><strong>DAOパターン</strong>の主な目的は何ですか？</p>
                            
                            <div class="quiz-options">
                                <label><input type="radio" name="q1" value="a"> a) データベースの処理速度を向上させる</label><br>
                                <label><input type="radio" name="q1" value="b"> b) ビジネスロジックとデータアクセスロジックを分離する</label><br>
                                <label><input type="radio" name="q1" value="c"> c) メモリ使用量を削減する</label><br>
                                <label><input type="radio" name="q1" value="d"> d) セキュリティを向上させる</label>
                            </div>
                            
                            <div class="quiz-answer" style="display: none;">
                                <strong>正解: b) ビジネスロジックとデータアクセスロジックを分離する</strong><br>
                                DAOパターンは関心の分離により、保守性と再利用性を向上させることが主な目的です。
                            </div>
                        </div>

                        <div class="quiz-item">
                            <h4>❓ 問題2</h4>
                            <p><strong>トランザクション</strong>で保証されるACID特性のうち、「すべて成功するかすべて失敗するか」を表すのはどれですか？</p>
                            
                            <div class="quiz-options">
                                <label><input type="radio" name="q2" value="a"> a) Atomicity（原子性）</label><br>
                                <label><input type="radio" name="q2" value="b"> b) Consistency（一貫性）</label><br>
                                <label><input type="radio" name="q2" value="c"> c) Isolation（独立性）</label><br>
                                <label><input type="radio" name="q2" value="d"> d) Durability（永続性）</label>
                            </div>
                            
                            <div class="quiz-answer" style="display: none;">
                                <strong>正解: a) Atomicity（原子性）</strong><br>
                                原子性は、トランザクション内のすべての操作が完全に実行されるか、まったく実行されないかを保証する特性です。
                            </div>
                        </div>

                        <div class="quiz-item">
                            <h4>❓ 問題3</h4>
                            <p><strong>PreparedStatement</strong>を使用する主な利点は何ですか？</p>
                            
                            <div class="quiz-options">
                                <label><input type="radio" name="q3" value="a"> a) 実行速度が速い</label><br>
                                <label><input type="radio" name="q3" value="b"> b) SQLインジェクション攻撃を防げる</label><br>
                                <label><input type="radio" name="q3" value="c"> c) メモリ使用量が少ない</label><br>
                                <label><input type="radio" name="q3" value="d"> d) a)とb)の両方</label>
                            </div>
                            
                            <div class="quiz-answer" style="display: none;">
                                <strong>正解: d) a)とb)の両方</strong><br>
                                PreparedStatementは、SQLのコンパイル済み形式により高速実行が可能で、かつパラメータ化によりSQLインジェクション攻撃を防げます。
                            </div>
                        </div>

                        <button type="button" class="btn btn-orange mt-3" onclick="showAllAnswers()">解答を表示</button>
                    </div>
                </section>

                <!-- ナビゲーション -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="struts1-learning-material-8.html" class="btn btn-outline-secondary">⬅️ 第8章に戻る</a>
                    <a href="struts1-learning-material-10.html" class="btn btn-orange">第10章に進む ➡️</a>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap 5 JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // Highlight.js初期化
            hljs.highlightAll();
            
            // Mermaid.js初期化
            mermaid.initialize({
                startOnLoad: true,
                theme: 'default'
            });
            
            // スムーズスクロール
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // サイドバーのアクティブリンク更新
            const observerOptions = {
                root: null,
                rootMargin: '0px 0px -80% 0px',
                threshold: 0.1
            };
            
            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        document.querySelectorAll('.nav-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        const activeLink = document.querySelector(`a[href="#${id}"]`);
                        if (activeLink) {
                            activeLink.classList.add('active');
                        }
                    }
                });
            }, observerOptions);
            
            // セクション要素を監視対象に追加
            document.querySelectorAll('section[id]').forEach(section => {
                observer.observe(section);
            });
        });
        
        // クイズ解答表示機能
        function showAllAnswers() {
            document.querySelectorAll('.quiz-answer').forEach(answer => {
                answer.style.display = 'block';
            });
        }
    </script>
</body>
</html>