<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSP学習教材 第7章 - セッションとスコープ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #f57c00;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .sub-section-title {
            color: #666;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #f57c00;
            padding-left: 0.8rem;
        }

        .highlight {
            background-color: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .exercise-container {
            background-color: #e8f5e8;
            border: 1px solid #81c784;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .quiz-container {
            background-color: #e3f2fd;
            border: 1px solid #64b5f6;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .code-block {
            background-color: #2d3748;
            color: #e2e8f0;
            border-radius: 5px;
            padding: 1rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .code-inline {
            background-color: #f5f5f5;
            color: #d73502;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .nav-link {
            color: #666 !important;
        }

        .nav-link.active {
            color: #f57c00 !important;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #f57c00;
            border-color: #f57c00;
        }

        .btn-primary:hover {
            background-color: #e65100;
            border-color: #e65100;
        }

        .alert-info {
            background-color: #e3f2fd;
            border-color: #81d4fa;
            color: #0277bd;
        }

        .alert-warning {
            background-color: #fff3e0;
            border-color: #ffcc02;
            color: #e65100;
        }

        .alert-danger {
            background-color: #ffebee;
            border-color: #ef5350;
            color: #c62828;
        }

        pre {
            white-space: pre-wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f57c00;
            color: white;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>JSP学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-1.html">
                                第1章: 事前準備
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-2.html">
                                第2章: JSPの基本理解
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-3.html">
                                第3章: スクリプトレットと式
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-4.html">
                                第4章: ディレクティブとインポート
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-5.html">
                                第5章: リクエストとレスポンスの処理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-6.html">
                                第6章: JSPとJavaBeans
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="jsp-learning-material-7.html">
                                第7章: セッションとスコープ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-8.html">
                                第8章: EL（式言語）とJSTL入門
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-9.html">
                                第9章: 簡易Webアプリ開発
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-10.html">
                                第10章: 次のステップへのガイド
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: セッションとスコープ</h1>
                </div>

                <div id="chapter7">
                    <h2 class="chapter-title">セッションとスコープ</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Webアプリケーションにおけるスコープの概念と種類</li>
                            <li>セッション管理の基本とライフサイクル</li>
                            <li>セッション属性の設定と取得</li>
                            <li>ログイン認証の実装方法</li>
                            <li>セッション管理のセキュリティと最適化</li>
                            <li>実践的なセッション活用方法</li>
                        </ul>
                    </div>

                    <h3 class="section-title">7.1 スコープの基本概念</h3>
                    <p>
                        Webアプリケーションでは、データを保持する<strong>スコープ</strong>が複数存在します。
                        スコープとは、データが有効な範囲のことで、適切なスコープを選択することで効率的なアプリケーションを構築できます。
                    </p>

                    <h4 class="sub-section-title">7.1.1 4つのスコープ</h4>
                    
                    <div class="mermaid">
                        graph TD
                            A[アプリケーションスコープ<br>サーバー全体] --> B[セッションスコープ<br>ユーザーごと]
                            B --> C[リクエストスコープ<br>リクエストごと]
                            C --> D[ページスコープ<br>ページごと]
                    </div>

                    <table>
                        <tr>
                            <th>スコープ</th>
                            <th>暗黙オブジェクト</th>
                            <th>有効範囲</th>
                            <th>用途例</th>
                        </tr>
                        <tr>
                            <td>page</td>
                            <td>pageContext</td>
                            <td>現在のJSPページ内</td>
                            <td>一時的な計算結果</td>
                        </tr>
                        <tr>
                            <td>request</td>
                            <td>request</td>
                            <td>現在のリクエスト内</td>
                            <td>フォームデータ、エラーメッセージ</td>
                        </tr>
                        <tr>
                            <td>session</td>
                            <td>session</td>
                            <td>同一セッション内</td>
                            <td>ログイン情報、ショッピングカート</td>
                        </tr>
                        <tr>
                            <td>application</td>
                            <td>application</td>
                            <td>アプリケーション全体</td>
                            <td>設定情報、カウンタ</td>
                        </tr>
                    </table>

                    <h3 class="section-title">7.2 セッション管理の基本</h3>
                    <p>
                        <strong>セッション</strong>は、HTTPの特性（ステートレス）を克服し、複数のリクエストにわたってユーザーの状態を保持する仕組みです。
                    </p>

                    <h4 class="sub-section-title">7.2.1 セッションのライフサイクル</h4>
                    
                    <div class="mermaid">
                        graph LR
                            A[初回アクセス] --> B[セッション作成]
                            B --> C[セッションID発行]
                            C --> D[クライアントに送信]
                            D --> E[後続リクエスト]
                            E --> F[セッション特定]
                            F --> G[データ共有]
                            G --> H[タイムアウト/明示的終了]
                            H --> I[セッション破棄]
                    </div>

                    <div class="exercise-container">
                        <h5>実習 7-1: セッションの基本操作</h5>
                        <p>セッションの作成、データの設定・取得、破棄の基本的な操作を学びましょう。</p>
                        
                        <h6>セッション操作JSP（session-basic.jsp）を作成</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%
    // セッション情報の取得
    String sessionId = session.getId();
    long creationTime = session.getCreationTime();
    long lastAccessedTime = session.getLastAccessedTime();
    int maxInactiveInterval = session.getMaxInactiveInterval();
    
    // セッション属性の設定
    String action = request.getParameter("action");
    if ("set".equals(action)) {
        String username = request.getParameter("username");
        if (username != null && !username.trim().isEmpty()) {
            session.setAttribute("username", username);
            session.setAttribute("loginTime", new java.util.Date());
            session.setAttribute("accessCount", 1);
        }
    } else if ("increment".equals(action)) {
        Integer count = (Integer) session.getAttribute("accessCount");
        if (count != null) {
            session.setAttribute("accessCount", count + 1);
        }
    } else if ("clear".equals(action)) {
        session.invalidate();
        response.sendRedirect("session-basic.jsp");
        return;
    }
    
    // セッション属性の取得
    String username = (String) session.getAttribute("username");
    java.util.Date loginTime = (java.util.Date) session.getAttribute("loginTime");
    Integer accessCount = (Integer) session.getAttribute("accessCount");
%&gt;

&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;セッション管理の基本&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;セッション管理の基本&lt;/h2&gt;
    
    &lt;h3&gt;セッション情報&lt;/h3&gt;
    &lt;p&gt;&lt;strong&gt;セッションID:&lt;/strong&gt; &lt;%= sessionId %&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;作成時刻:&lt;/strong&gt; &lt;%= new java.util.Date(creationTime) %&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;最終アクセス時刻:&lt;/strong&gt; &lt;%= new java.util.Date(lastAccessedTime) %&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;タイムアウト時間:&lt;/strong&gt; &lt;%= maxInactiveInterval %&gt;秒&lt;/p&gt;
    
    &lt;h3&gt;セッション属性&lt;/h3&gt;
    &lt;% if (username != null) { %&gt;
        &lt;div style="background-color: #e8f5e8; padding: 1rem; border-radius: 5px;"&gt;
            &lt;p&gt;&lt;strong&gt;ユーザー名:&lt;/strong&gt; &lt;%= username %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;ログイン時刻:&lt;/strong&gt; &lt;%= loginTime %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;アクセス回数:&lt;/strong&gt; &lt;%= accessCount %&gt;回&lt;/p&gt;
        &lt;/div&gt;
    &lt;% } else { %&gt;
        &lt;p&gt;ログインしていません。&lt;/p&gt;
    &lt;% } %&gt;
    
    &lt;h3&gt;操作メニュー&lt;/h3&gt;
    &lt;% if (username == null) { %&gt;
        &lt;form action="session-basic.jsp" method="post"&gt;
            &lt;input type="hidden" name="action" value="set"&gt;
            &lt;p&gt;
                ユーザー名: &lt;input type="text" name="username" required&gt;
                &lt;input type="submit" value="ログイン"&gt;
            &lt;/p&gt;
        &lt;/form&gt;
    &lt;% } else { %&gt;
        &lt;p&gt;
            &lt;a href="session-basic.jsp?action=increment"&gt;アクセス回数を増やす&lt;/a&gt; |
            &lt;a href="session-basic.jsp?action=clear"&gt;ログアウト&lt;/a&gt;
        &lt;/p&gt;
    &lt;% } %&gt;
    
    &lt;p&gt;&lt;a href="session-basic.jsp"&gt;リロード&lt;/a&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

                        <h6>期待される結果</h6>
                        <p>
                            ユーザー名を入力してログインすると、セッションにデータが保存されます。
                            アクセス回数の増加やログアウト機能も正しく動作します。
                        </p>
                    </div>

                    <h3 class="section-title">7.3 ログイン認証システムの実装</h3>
                    <p>
                        セッションを活用した実践的なログイン認証システムを構築してみましょう。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 7-2: ログイン認証システムの実装</h5>
                        <p>複数のページで共通のログイン状態を管理するシステムを作成します。</p>
                        
                        <h6>1. ログインページ（login.html）を作成</h6>
                        <pre class="code-block"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ログインページ&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;ログイン&lt;/h2&gt;
    &lt;form action="login-process.jsp" method="post"&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;td&gt;ユーザーID:&lt;/td&gt;
                &lt;td&gt;&lt;input type="text" name="userId" required&gt;&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
                &lt;td&gt;パスワード:&lt;/td&gt;
                &lt;td&gt;&lt;input type="password" name="password" required&gt;&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/table&gt;
        &lt;p&gt;&lt;input type="submit" value="ログイン"&gt;&lt;/p&gt;
    &lt;/form&gt;
    
    &lt;p&gt;テスト用アカウント：&lt;/p&gt;
    &lt;ul&gt;
        &lt;li&gt;admin / password123&lt;/li&gt;
        &lt;li&gt;user1 / user123&lt;/li&gt;
    &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

                        <h6>2. ログイン処理JSP（login-process.jsp）を作成</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%
    request.setCharacterEncoding("UTF-8");
    
    String userId = request.getParameter("userId");
    String password = request.getParameter("password");
    
    // 簡単な認証チェック
    boolean loginSuccess = false;
    String userRole = "";
    String userName = "";
    
    if ("admin".equals(userId) && "password123".equals(password)) {
        loginSuccess = true;
        userRole = "管理者";
        userName = "システム管理者";
    } else if ("user1".equals(userId) && "user123".equals(password)) {
        loginSuccess = true;
        userRole = "一般ユーザー";
        userName = "田中太郎";
    }
    
    if (loginSuccess) {
        // セッションにログイン情報を保存
        session.setAttribute("isLoggedIn", true);
        session.setAttribute("userId", userId);
        session.setAttribute("userName", userName);
        session.setAttribute("userRole", userRole);
        session.setAttribute("loginTime", new java.util.Date());
        
        // セッションのタイムアウト時間を30分に設定
        session.setMaxInactiveInterval(30 * 60);
        
        // メニューページにリダイレクト
        response.sendRedirect("menu.jsp");
    } else {
        // ログイン失敗時はエラーメッセージと共に再ログインページへ
        request.setAttribute("errorMessage", "ユーザーIDまたはパスワードが正しくありません。");
%&gt;

&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ログインエラー&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;ログインエラー&lt;/h2&gt;
    &lt;p style="color: red;"&gt;&lt;%= request.getAttribute("errorMessage") %&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href="login.html"&gt;再度ログイン&lt;/a&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

&lt;%
    }
%&gt;</code></pre>

                        <h6>3. メニューページ（menu.jsp）を作成</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%
    // ログインチェック
    Boolean isLoggedIn = (Boolean) session.getAttribute("isLoggedIn");
    if (isLoggedIn == null || !isLoggedIn) {
        response.sendRedirect("login.html");
        return;
    }
    
    String userName = (String) session.getAttribute("userName");
    String userRole = (String) session.getAttribute("userRole");
    java.util.Date loginTime = (java.util.Date) session.getAttribute("loginTime");
%&gt;

&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;メインメニュー&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;メインメニュー&lt;/h2&gt;
    
    &lt;div style="background-color: #e3f2fd; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;"&gt;
        &lt;p&gt;&lt;strong&gt;ようこそ、&lt;%= userName %&gt;さん！&lt;/strong&gt;&lt;/p&gt;
        &lt;p&gt;権限: &lt;%= userRole %&gt;&lt;/p&gt;
        &lt;p&gt;ログイン時刻: &lt;%= loginTime %&gt;&lt;/p&gt;
    &lt;/div&gt;
    
    &lt;h3&gt;利用可能な機能&lt;/h3&gt;
    &lt;ul&gt;
        &lt;li&gt;&lt;a href="profile.jsp"&gt;プロフィール表示&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href="shopping-cart.jsp"&gt;ショッピングカート&lt;/a&gt;&lt;/li&gt;
        &lt;% if ("管理者".equals(userRole)) { %&gt;
            &lt;li&gt;&lt;a href="admin.jsp"&gt;管理者メニュー&lt;/a&gt;&lt;/li&gt;
        &lt;% } %&gt;
    &lt;/ul&gt;
    
    &lt;p&gt;&lt;a href="logout.jsp"&gt;ログアウト&lt;/a&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

                        <h6>4. ログアウト処理（logout.jsp）を作成</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%
    // セッションを無効化してログアウト
    session.invalidate();
%&gt;

&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ログアウト完了&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;ログアウト完了&lt;/h2&gt;
    &lt;p&gt;正常にログアウトしました。&lt;/p&gt;
    &lt;p&gt;&lt;a href="login.html"&gt;再ログイン&lt;/a&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

                        <h6>期待される結果</h6>
                        <p>
                            ログイン認証システムが構築され、セッションを使用してユーザー状態が管理されます。
                            権限に応じて表示内容が変わり、ログアウト機能も正常に動作します。
                        </p>
                    </div>

                    <h3 class="section-title">7.4 ショッピングカートの実装</h3>
                    <p>
                        セッションを活用した実践的な例として、商品をカートに追加・削除できるショッピングカート機能を実装します。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 7-3: ショッピングカートシステム</h5>
                        <p>商品の追加・削除・数量変更ができるショッピングカート機能を作成します。</p>
                        
                        <h6>1. 商品一覧ページ（product-list.jsp）を作成</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%@ page import="java.util.*" %&gt;
&lt;%
    // 商品情報（実際はデータベースから取得）
    Map&lt;String, Map&lt;String, Object&gt;&gt; products = new HashMap&lt;&gt;();
    
    Map&lt;String, Object&gt; product1 = new HashMap&lt;&gt;();
    product1.put("name", "ノートパソコン");
    product1.put("price", 89800);
    product1.put("description", "高性能ノートパソコン");
    products.put("P001", product1);
    
    Map&lt;String, Object&gt; product2 = new HashMap&lt;&gt;();
    product2.put("name", "マウス");
    product2.put("price", 2980);
    product2.put("description", "ワイヤレスマウス");
    products.put("P002", product2);
    
    Map&lt;String, Object&gt; product3 = new HashMap&lt;&gt;();
    product3.put("name", "キーボード");
    product3.put("price", 8500);
    product3.put("description", "メカニカルキーボード");
    products.put("P003", product3);
    
    // セッションにカート情報がない場合は初期化
    Map&lt;String, Integer&gt; cart = (Map&lt;String, Integer&gt;) session.getAttribute("cart");
    if (cart == null) {
        cart = new HashMap&lt;&gt;();
        session.setAttribute("cart", cart);
    }
%&gt;

&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;商品一覧&lt;/title&gt;
    &lt;style&gt;
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f57c00; color: white; }
        .cart-info { background-color: #e3f2fd; padding: 1rem; margin-bottom: 1rem; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;商品一覧&lt;/h2&gt;
    
    &lt;div class="cart-info"&gt;
        &lt;p&gt;&lt;strong&gt;カート内商品数:&lt;/strong&gt; 
        &lt;%
            int totalItems = 0;
            for (Integer quantity : cart.values()) {
                totalItems += quantity;
            }
        %&gt;
        &lt;%= totalItems %&gt;個 | &lt;a href="shopping-cart.jsp"&gt;カートを見る&lt;/a&gt;
        &lt;/p&gt;
    &lt;/div&gt;
    
    &lt;table&gt;
        &lt;tr&gt;
            &lt;th&gt;商品コード&lt;/th&gt;
            &lt;th&gt;商品名&lt;/th&gt;
            &lt;th&gt;価格&lt;/th&gt;
            &lt;th&gt;説明&lt;/th&gt;
            &lt;th&gt;操作&lt;/th&gt;
        &lt;/tr&gt;
        &lt;%
            for (Map.Entry&lt;String, Map&lt;String, Object&gt;&gt; entry : products.entrySet()) {
                String productId = entry.getKey();
                Map&lt;String, Object&gt; product = entry.getValue();
        %&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;%= productId %&gt;&lt;/td&gt;
            &lt;td&gt;&lt;%= product.get("name") %&gt;&lt;/td&gt;
            &lt;td&gt;￥&lt;%= product.get("price") %&gt;&lt;/td&gt;
            &lt;td&gt;&lt;%= product.get("description") %&gt;&lt;/td&gt;
            &lt;td&gt;
                &lt;a href="cart-action.jsp?action=add&amp;productId=&lt;%= productId %&gt;"&gt;カートに追加&lt;/a&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;% } %&gt;
    &lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

                        <h6>2. カート操作処理（cart-action.jsp）を作成</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%@ page import="java.util.*" %&gt;
&lt;%
    String action = request.getParameter("action");
    String productId = request.getParameter("productId");
    String quantityStr = request.getParameter("quantity");
    
    Map&lt;String, Integer&gt; cart = (Map&lt;String, Integer&gt;) session.getAttribute("cart");
    if (cart == null) {
        cart = new HashMap&lt;&gt;();
        session.setAttribute("cart", cart);
    }
    
    if ("add".equals(action) && productId != null) {
        // 商品をカートに追加
        Integer currentQuantity = cart.get(productId);
        if (currentQuantity == null) {
            cart.put(productId, 1);
        } else {
            cart.put(productId, currentQuantity + 1);
        }
        response.sendRedirect("product-list.jsp");
    } else if ("remove".equals(action) && productId != null) {
        // 商品をカートから削除
        cart.remove(productId);
        response.sendRedirect("shopping-cart.jsp");
    } else if ("update".equals(action) && productId != null && quantityStr != null) {
        // 数量を更新
        try {
            int quantity = Integer.parseInt(quantityStr);
            if (quantity &gt; 0) {
                cart.put(productId, quantity);
            } else {
                cart.remove(productId);
            }
        } catch (NumberFormatException e) {
            // 無効な数値の場合は何もしない
        }
        response.sendRedirect("shopping-cart.jsp");
    } else {
        response.sendRedirect("product-list.jsp");
    }
%&gt;</code></pre>

                        <h6>3. ショッピングカートページ（shopping-cart.jsp）を作成</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%@ page import="java.util.*" %&gt;
&lt;%
    // 商品マスター情報
    Map&lt;String, Map&lt;String, Object&gt;&gt; products = new HashMap&lt;&gt;();
    
    Map&lt;String, Object&gt; product1 = new HashMap&lt;&gt;();
    product1.put("name", "ノートパソコン");
    product1.put("price", 89800);
    products.put("P001", product1);
    
    Map&lt;String, Object&gt; product2 = new HashMap&lt;&gt;();
    product2.put("name", "マウス");
    product2.put("price", 2980);
    products.put("P002", product2);
    
    Map&lt;String, Object&gt; product3 = new HashMap&lt;&gt;();
    product3.put("name", "キーボード");
    product3.put("price", 8500);
    products.put("P003", product3);
    
    // カート情報の取得
    Map&lt;String, Integer&gt; cart = (Map&lt;String, Integer&gt;) session.getAttribute("cart");
    if (cart == null) {
        cart = new HashMap&lt;&gt;();
    }
%&gt;

&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ショッピングカート&lt;/title&gt;
    &lt;style&gt;
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f57c00; color: white; }
        .total { background-color: #fff3e0; font-weight: bold; }
        input[type="number"] { width: 60px; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;ショッピングカート&lt;/h2&gt;
    
    &lt;% if (cart.isEmpty()) { %&gt;
        &lt;p&gt;カートは空です。&lt;/p&gt;
        &lt;p&gt;&lt;a href="product-list.jsp"&gt;商品一覧に戻る&lt;/a&gt;&lt;/p&gt;
    &lt;% } else { %&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;商品名&lt;/th&gt;
                &lt;th&gt;単価&lt;/th&gt;
                &lt;th&gt;数量&lt;/th&gt;
                &lt;th&gt;小計&lt;/th&gt;
                &lt;th&gt;操作&lt;/th&gt;
            &lt;/tr&gt;
            &lt;%
                int totalAmount = 0;
                for (Map.Entry&lt;String, Integer&gt; entry : cart.entrySet()) {
                    String productId = entry.getKey();
                    Integer quantity = entry.getValue();
                    Map&lt;String, Object&gt; product = products.get(productId);
                    if (product != null) {
                        String name = (String) product.get("name");
                        Integer price = (Integer) product.get("price");
                        int subtotal = price * quantity;
                        totalAmount += subtotal;
            %&gt;
            &lt;tr&gt;
                &lt;td&gt;&lt;%= name %&gt;&lt;/td&gt;
                &lt;td&gt;￥&lt;%= price %&gt;&lt;/td&gt;
                &lt;td&gt;
                    &lt;form action="cart-action.jsp" method="post" style="display: inline;"&gt;
                        &lt;input type="hidden" name="action" value="update"&gt;
                        &lt;input type="hidden" name="productId" value="&lt;%= productId %&gt;"&gt;
                        &lt;input type="number" name="quantity" value="&lt;%= quantity %&gt;" min="0"&gt;
                        &lt;input type="submit" value="更新"&gt;
                    &lt;/form&gt;
                &lt;/td&gt;
                &lt;td&gt;￥&lt;%= subtotal %&gt;&lt;/td&gt;
                &lt;td&gt;
                    &lt;a href="cart-action.jsp?action=remove&amp;productId=&lt;%= productId %&gt;"&gt;削除&lt;/a&gt;
                &lt;/td&gt;
            &lt;/tr&gt;
            &lt;% } } %&gt;
            &lt;tr class="total"&gt;
                &lt;td colspan="3"&gt;合計&lt;/td&gt;
                &lt;td&gt;￥&lt;%= totalAmount %&gt;&lt;/td&gt;
                &lt;td&gt;&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/table&gt;
        
        &lt;p&gt;
            &lt;a href="product-list.jsp"&gt;買い物を続ける&lt;/a&gt; |
            &lt;a href="#"&gt;注文手続きへ&lt;/a&gt;
        &lt;/p&gt;
    &lt;% } %&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

                        <h6>期待される結果</h6>
                        <p>
                            商品をカートに追加し、数量の変更や削除が可能なショッピングカートシステムが動作します。
                            セッションを使用してカート情報が複数のページ間で共有されます。
                        </p>
                    </div>

                    <h3 class="section-title">7.5 セッション管理のベストプラクティス</h3>
                    
                    <h4 class="sub-section-title">7.5.1 セキュリティ対策</h4>
                    <div class="alert alert-warning">
                        <strong>重要なセキュリティ対策：</strong>
                        <ul>
                            <li>セッションIDの推測困難性を確保</li>
                            <li>HTTPS通信でセッション情報を保護</li>
                            <li>適切なセッションタイムアウト時間の設定</li>
                            <li>ログアウト時の確実なセッション破棄</li>
                            <li>セッション固定攻撃対策</li>
                        </ul>
                    </div>

                    <h4 class="sub-section-title">7.5.2 パフォーマンス最適化</h4>
                    <ul>
                        <li>セッションに保存するデータ量を最小限に抑制</li>
                        <li>不要になったセッション属性の削除</li>
                        <li>適切なセッションタイムアウト時間の設定</li>
                        <li>クラスタ環境でのセッション共有戦略</li>
                    </ul>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>JSPの4つのスコープを範囲の短い順に並べてください。</li>
                            <li>セッションを無効化するために使用するメソッドは何ですか？</li>
                            <li>セッションのタイムアウト時間を設定するメソッドは何ですか？</li>
                            <li>ショッピングカートの実装において、セッションスコープが適している理由を説明してください。</li>
                            <li>セッション管理において重要なセキュリティ対策を3つ挙げてください。</li>
                        </ol>
                        
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>page &lt; request &lt; session &lt; application</li>
                                <li>session.invalidate()メソッド</li>
                                <li>session.setMaxInactiveInterval()メソッド</li>
                                <li>
                                    複数のページ間で買い物カートの内容を共有する必要があり、
                                    ユーザーごとに異なる情報を保持する必要があるため
                                </li>
                                <li>
                                    ・HTTPS通信の使用<br>
                                    ・適切なセッションタイムアウト設定<br>
                                    ・ログアウト時の確実なセッション破棄
                                </li>
                            </ol>
                        </details>
                    </div>

                    <div class="highlight">
                        <h5>まとめ</h5>
                        <p>この章では、セッションとスコープ管理について学習しました。</p>
                        <ul>
                            <li>4つのスコープ（page、request、session、application）の特徴と使い分け</li>
                            <li>セッション管理の基本的なライフサイクル</li>
                            <li>ログイン認証システムの実装方法</li>
                            <li>ショッピングカートなど実践的なセッション活用例</li>
                            <li>セッション管理におけるセキュリティとパフォーマンス対策</li>
                        </ul>
                        <p>次の章では、EL（式言語）とJSTLについて学習し、JSPコードをより簡潔に記述する方法を学びます。</p>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="jsp-learning-material-6.html" class="btn btn-secondary">&larr; 前の章</a>
                        <a href="jsp-learning-material-8.html" class="btn btn-primary">次の章 &rarr;</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>