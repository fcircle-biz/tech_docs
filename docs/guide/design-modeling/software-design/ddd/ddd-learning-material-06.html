<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" id="viewport-meta">
    <title>DDD学習教材 第6章 - 集約 - 一貫性を保つためのまとまり</title>

    <!-- ダークモード早期適用（フラッシュ防止） -->
    <script>
        (function() {
            const saved = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === 'dark' || (saved === null && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // DDD - Indigo (設計手法用)
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts - Noto Sans JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- カスタムスタイル -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="font-sans bg-slate-50 text-slate-800 antialiased">
    <!-- ヘッダー/ナビゲーションバー -->
    <header class="fixed top-0 left-0 right-0 z-50 text-white header-rich header-rich-shadow">
        <nav class="w-full px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="flex items-center justify-between py-3">
                <!-- 左側: ロゴとタイトルセクション -->
                <div class="flex items-center gap-4">
                    <!-- アイコン -->
                    <div class="relative group">
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-400/30 to-orange-400/30 rounded-2xl blur-lg group-hover:blur-xl transition-all"></div>
                        <div class="relative w-14 h-14 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                            <i class="fas fa-project-diagram text-3xl icon-rotate-hover drop-shadow-lg"></i>
                        </div>
                    </div>

                    <!-- タイトルとメタ情報 -->
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-bold tracking-wide drop-shadow-md">DDD学習教材</span>
                            <span class="hidden sm:inline-flex items-center gap-1 px-2 py-0.5 bg-white/20 rounded-md text-[10px] font-semibold uppercase tracking-wider">
                                <i class="fas fa-star text-yellow-300 text-[8px]"></i>
                                初級
                            </span>
                        </div>
                        <div class="flex items-center gap-3 text-[11px] text-white/90 font-medium">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-cubes text-[9px]"></i>
                                <span>設計・モデリング</span>
                            </div>
                            <div class="hidden sm:flex items-center gap-1">
                                <i class="fas fa-clock text-[9px]"></i>
                                <span>推奨 45分</span>
                            </div>
                            <div class="hidden lg:flex items-center gap-1">
                                <i class="fas fa-language text-[9px]"></i>
                                <span>日本語</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側: サイドバートグルボタン -->
                <button id="sidebar-toggle-btn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white/20 transition-all active:scale-95" title="サイドバーの表示/非表示">
                    <i class="fas fa-bars text-lg"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- メインレイアウト -->
    <div class="flex min-h-screen pt-20">
        <!-- サイドバーはsidebar-content.jsで動的に生成されます -->

        <!-- メインコンテンツ -->
        <main class="flex-1 min-w-0">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-10 py-6">
                <!-- パンくずリスト -->
                <nav class="flex items-center gap-2 text-sm text-slate-500 mb-6">
                    <a href="https://fcircle-biz.github.io/tech_docs/" class="hover:text-primary-600 transition-colors">ホーム</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <a href="../" class="hover:text-primary-600 transition-colors">設計・モデリング</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-slate-700">第6章</span>
                </nav>

                <!-- 章ヘッダー -->
                <header class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                                     bg-primary-100 text-primary-700">
                            第6章
                        </span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">集約 - 一貫性を保つためのまとまり</h1>
                    <p class="text-slate-600">関連するエンティティと値オブジェクトをグループ化する集約の概念を学びます。集約ルート、整合性境界、不変条件の保護について理解し、適切な集約の設計方法を習得します。</p>
                </header>

                <!-- 学習目標カード -->
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200
                            rounded-xl p-5 mb-6 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-amber-400 rounded-lg
                                    flex items-center justify-center">
                            <i class="fas fa-lightbulb text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-amber-800 mb-3">この章で学ぶこと</h2>
                            <ul class="space-y-2">
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>集約とは何か、なぜ必要なのかを理解する</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>集約ルートの役割と整合性境界の概念を学ぶ</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>不変条件を保護する集約の設計方法を習得する</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>「注文」と「注文明細」の関係を例に実践的な集約設計を行う</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- セクション1: 集約とは何か -->
                <section class="prose prose-slate max-w-none">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        6.1 集約とは何か
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>集約（Aggregate）</strong>は、関連するエンティティと値オブジェクトをひとつのまとまりとしてグループ化したものです。集約は、ビジネスルールの一貫性を保つための境界を定義します。
                    </p>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        これまで学んだエンティティと値オブジェクトは、通常単独で存在するわけではなく、互いに関連し合っています。例えば、「注文」には複数の「注文明細」が含まれ、「注文明細」には「商品」や「数量」などの情報があります。これらをバラバラに扱うと、データの整合性が崩れてしまう可能性があります。
                    </p>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r-lg overflow-hidden">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-blue-900 font-medium break-words">集約の目的</p>
                                <p class="text-blue-800 text-sm mt-1 break-words">
                                    集約の主な目的は、<strong>不変条件（ビジネスルール）を保護すること</strong>です。例えば「注文の合計金額は、すべての注文明細の小計の合計と一致しなければならない」というルールを、集約の境界内で確実に守ることができます。
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 集約のイメージ図 -->
                    <div class="bg-slate-100 rounded-xl p-6 my-6">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-cube text-primary-500"></i>
                            集約のイメージ
                        </h3>
                        <div class="mermaid">
graph TB
    subgraph AGG["集約: 注文"]
        ROOT["<strong>集約ルート</strong><br/>注文エンティティ<br/>注文ID<br/>顧客<br/>注文日<br/>合計金額"]
        ITEM1["注文明細1<br/>商品<br/>数量<br/>小計"]
        ITEM2["注文明細2<br/>商品<br/>数量<br/>小計"]
        ITEM3["注文明細3<br/>商品<br/>数量<br/>小計"]

        ROOT -->|管理| ITEM1
        ROOT -->|管理| ITEM2
        ROOT -->|管理| ITEM3
    end

    EXTERNAL["外部からのアクセス"]
    EXTERNAL -.唯一の入口.-> ROOT

    style ROOT fill:#6366f1,stroke:#4338ca,color:#fff
    style AGG fill:#e0e7ff,stroke:#6366f1
    style EXTERNAL fill:#f1f5f9,stroke:#94a3b8
                        </div>
                    </div>
                </section>

                <!-- セクション2: 集約ルート -->
                <section class="prose prose-slate max-w-none mt-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        6.2 集約ルート - 集約への唯一の入口
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        集約の中で、外部からアクセスできる唯一のエンティティを<strong>集約ルート（Aggregate Root）</strong>と呼びます。集約ルートは、集約全体の整合性を保つ責任を持ちます。
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
                        <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                            <h4 class="font-semibold text-emerald-800 mb-2 flex items-center gap-2">
                                <i class="fas fa-check-circle"></i>
                                集約ルートの責務
                            </h4>
                            <ul class="space-y-2 text-emerald-900 text-sm">
                                <li class="flex items-start gap-2">
                                    <span class="text-emerald-600">●</span>
                                    <span>集約内の全オブジェクトへのアクセスを制御</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-emerald-600">●</span>
                                    <span>不変条件（ビジネスルール）の検証と保護</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-emerald-600">●</span>
                                    <span>集約全体のライフサイクル管理</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-emerald-600">●</span>
                                    <span>他の集約との関係の調整</span>
                                </li>
                            </ul>
                        </div>

                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-semibold text-red-800 mb-2 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                やってはいけないこと
                            </h4>
                            <ul class="space-y-2 text-red-900 text-sm">
                                <li class="flex items-start gap-2">
                                    <span class="text-red-600">×</span>
                                    <span>集約ルートを経由せずに内部オブジェクトを直接変更</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-red-600">×</span>
                                    <span>集約の境界を越えた参照の保持</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-red-600">×</span>
                                    <span>集約内の一部のオブジェクトだけを永続化</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-red-600">×</span>
                                    <span>複数の集約を同時にトランザクションで更新</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-6 rounded-r-lg overflow-hidden">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-key text-emerald-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-emerald-900 font-medium break-words">重要なルール</p>
                                <p class="text-emerald-800 text-sm mt-1 break-words">
                                    外部から集約内のオブジェクトにアクセスするには、<strong>必ず集約ルートを経由</strong>しなければなりません。これにより、集約ルートがすべての変更を監視し、不変条件を保護できます。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション3: 整合性境界と不変条件 -->
                <section class="prose prose-slate max-w-none mt-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        6.3 整合性境界と不変条件の保護
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        集約は、<strong>整合性境界（Consistency Boundary）</strong>を定義します。これは、「この境界内では常にビジネスルールが守られている」という保証を提供する範囲です。
                    </p>

                    <div class="bg-purple-100 rounded-lg p-4 my-6">
                        <h4 class="font-semibold text-purple-900 mb-3">不変条件の例</h4>
                        <div class="space-y-3">
                            <div class="bg-purple-50 p-3 rounded">
                                <p class="text-purple-900 font-medium text-sm">注文の合計金額</p>
                                <p class="text-purple-800 text-xs mt-1">
                                    「注文の合計金額は、すべての注文明細の小計の合計と一致しなければならない」
                                </p>
                            </div>
                            <div class="bg-purple-50 p-3 rounded">
                                <p class="text-purple-900 font-medium text-sm">注文明細の数量</p>
                                <p class="text-purple-800 text-xs mt-1">
                                    「注文明細の数量は1以上でなければならない」
                                </p>
                            </div>
                            <div class="bg-purple-50 p-3 rounded">
                                <p class="text-purple-900 font-medium text-sm">注文ステータス</p>
                                <p class="text-purple-800 text-xs mt-1">
                                    「発送済みの注文は、注文明細を追加・削除できない」
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- トランザクション境界の図 -->
                    <div class="bg-slate-100 rounded-xl p-6 my-6">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-shield-alt text-primary-500"></i>
                            集約とトランザクション境界
                        </h3>
                        <div class="mermaid">
flowchart TD
    subgraph TX1["トランザクション1"]
        AGG1["集約: 注文A<br/>整合性が保証される"]
    end

    subgraph TX2["トランザクション2"]
        AGG2["集約: 注文B<br/>整合性が保証される"]
    end

    subgraph TX3["トランザクション3"]
        AGG3["集約: 商品C<br/>整合性が保証される"]
    end

    CLIENT["クライアント"]
    CLIENT -->|変更リクエスト| TX1
    CLIENT -->|変更リクエスト| TX2
    CLIENT -->|変更リクエスト| TX3

    TX1 -.結果整合性.-> TX2
    TX2 -.結果整合性.-> TX3

    style AGG1 fill:#6366f1,stroke:#4338ca,color:#fff
    style AGG2 fill:#6366f1,stroke:#4338ca,color:#fff
    style AGG3 fill:#6366f1,stroke:#4338ca,color:#fff
    style TX1 fill:#e0e7ff,stroke:#6366f1
    style TX2 fill:#e0e7ff,stroke:#6366f1
    style TX3 fill:#e0e7ff,stroke:#6366f1
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r-lg overflow-hidden">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-blue-900 font-medium break-words">トランザクション境界</p>
                                <p class="text-blue-800 text-sm mt-1 break-words">
                                    原則として、<strong>1つのトランザクションで変更できるのは1つの集約のみ</strong>です。複数の集約を同時に更新する必要がある場合は、結果整合性（イベント駆動など）を検討します。これにより、システムのスケーラビリティが向上します。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション4: 注文と注文明細の実例 -->
                <section class="prose prose-slate max-w-none mt-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        6.4 実例: 注文と注文明細の集約設計
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        ECサイトの「注文」と「注文明細」を例に、実践的な集約設計を見ていきましょう。
                    </p>

                    <!-- コード例: 集約設計の悪い例 -->
                    <div class="my-6">
                        <h4 class="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                            <i class="fas fa-times-circle text-red-500"></i>
                            悪い設計例: 集約ルートを経由しない変更
                        </h4>
                        <div class="code-block-wrapper">
                            <div class="code-header">
                                <span class="code-title">Python</span>
                                <button class="copy-btn" onclick="copyCode(this)">
                                    <i class="fas fa-copy"></i> コピー
                                </button>
                            </div>
                            <pre><code class="language-python"># 悪い例: 注文明細を直接変更している
order = order_repository.find_by_id(order_id)
order_item = order_item_repository.find_by_id(item_id)

# 注文を経由せずに明細を変更（集約の境界を無視）
order_item.change_quantity(new_quantity)
order_item_repository.save(order_item)

# 問題: 注文の合計金額が更新されない！
# 不変条件が破られる可能性がある</code></pre>
                        </div>
                    </div>

                    <!-- コード例: 集約設計の良い例 -->
                    <div class="my-6">
                        <h4 class="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                            <i class="fas fa-check-circle text-emerald-500"></i>
                            良い設計例: 集約ルートを経由する変更
                        </h4>
                        <div class="code-block-wrapper">
                            <div class="code-header">
                                <span class="code-title">Python</span>
                                <button class="copy-btn" onclick="copyCode(this)">
                                    <i class="fas fa-copy"></i> コピー
                                </button>
                            </div>
                            <pre><code class="language-python"># 良い例: 集約ルート（注文）を経由して変更
from dataclasses import dataclass, field
from typing import List
from enum import Enum

class OrderStatus(Enum):
    """注文ステータス"""
    PENDING = "pending"      # 保留中
    CONFIRMED = "confirmed"  # 確定済み
    SHIPPED = "shipped"      # 発送済み
    DELIVERED = "delivered"  # 配達済み

@dataclass
class OrderItem:
    """注文明細（エンティティ）"""
    item_id: str
    product_name: str
    unit_price: int
    quantity: int

    def subtotal(self) -> int:
        """小計を計算"""
        return self.unit_price * self.quantity

@dataclass
class Order:
    """注文（集約ルート）"""
    order_id: str
    customer_name: str
    status: OrderStatus
    items: List[OrderItem] = field(default_factory=list)

    def add_item(self, product_name: str,
                 unit_price: int, quantity: int):
        """注文明細を追加"""
        # 不変条件チェック
        if self.status != OrderStatus.PENDING:
            raise ValueError("確定済みの注文には明細を追加できません")

        item = OrderItem(
            item_id=f"item-{len(self.items) + 1}",
            product_name=product_name,
            unit_price=unit_price,
            quantity=quantity
        )
        self.items.append(item)

    def change_item_quantity(self, item_id: str,
                            new_quantity: int):
        """注文明細の数量を変更（集約ルート経由）"""
        # 不変条件チェック
        if self.status != OrderStatus.PENDING:
            raise ValueError("確定済みの注文は変更できません")
        if new_quantity < 1:
            raise ValueError("数量は1以上でなければなりません")

        # 該当する明細を検索
        item = next((i for i in self.items
                    if i.item_id == item_id), None)
        if item is None:
            raise ValueError("指定された明細が見つかりません")

        # 数量を変更
        item.quantity = new_quantity

    def total_amount(self) -> int:
        """合計金額を計算（常に最新の値）"""
        return sum(item.subtotal() for item in self.items)

    def confirm(self):
        """注文を確定する"""
        if len(self.items) == 0:
            raise ValueError("明細がない注文は確定できません")
        self.status = OrderStatus.CONFIRMED

# 使用例
order = Order(
    order_id="ORD-001",
    customer_name="田中太郎",
    status=OrderStatus.PENDING
)

# 集約ルートのメソッドを使って明細を追加
order.add_item("ノートPC", 120000, 1)
order.add_item("マウス", 3000, 2)

# 合計金額は常に正確
print(f"合計: {order.total_amount()}円")  # 126000円

# 集約ルート経由で数量変更
order.change_item_quantity("item-2", 3)
print(f"合計: {order.total_amount()}円")  # 129000円

# 注文を確定
order.confirm()

# 確定後の変更は拒否される
# order.add_item("キーボード", 8000, 1)  # ValueError!</code></pre>
                        </div>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-6 rounded-r-lg overflow-hidden">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-emerald-900 font-medium break-words">この設計の利点</p>
                                <ul class="text-emerald-800 text-sm mt-2 space-y-1 break-words">
                                    <li>• 合計金額が常に正確（明細の小計の合計と一致）</li>
                                    <li>• 確定済み注文の変更を防止（不変条件の保護）</li>
                                    <li>• すべての変更が集約ルート経由（整合性が保証される）</li>
                                    <li>• ビジネスルールがコードに明示的に表現されている</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション5: 集約の境界を決める -->
                <section class="prose prose-slate max-w-none mt-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        6.5 適切な集約の境界を決める
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        集約の境界を適切に設計することは、DDDで最も難しい課題の一つです。大きすぎる集約は性能問題を引き起こし、小さすぎる集約は整合性の管理が困難になります。
                    </p>

                    <!-- 集約設計のガイドライン -->
                    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-xl p-5 mb-6 overflow-hidden">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center">
                                <i class="fas fa-compass text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-emerald-800 mb-2 break-words">集約設計の4つのガイドライン</h3>
                                <div class="space-y-3">
                                    <div class="bg-emerald-100 p-3 rounded-lg">
                                        <p class="text-emerald-900 font-medium text-sm">1. 不変条件を守る最小単位で設計</p>
                                        <p class="text-emerald-800 text-xs mt-1">
                                            一緒に整合性を保つ必要があるオブジェクトだけを集約に含める。それ以外は別の集約にする。
                                        </p>
                                    </div>
                                    <div class="bg-emerald-100 p-3 rounded-lg">
                                        <p class="text-emerald-900 font-medium text-sm">2. 小さな集約を優先</p>
                                        <p class="text-emerald-800 text-xs mt-1">
                                            集約は可能な限り小さく保つ。大きな集約は、性能問題や同時実行制御の複雑さを引き起こす。
                                        </p>
                                    </div>
                                    <div class="bg-emerald-100 p-3 rounded-lg">
                                        <p class="text-emerald-900 font-medium text-sm">3. IDによる参照を使う</p>
                                        <p class="text-emerald-800 text-xs mt-1">
                                            他の集約を参照する場合は、オブジェクト参照ではなくIDを使う。これにより境界が明確になる。
                                        </p>
                                    </div>
                                    <div class="bg-emerald-100 p-3 rounded-lg">
                                        <p class="text-emerald-900 font-medium text-sm">4. 結果整合性を受け入れる</p>
                                        <p class="text-emerald-800 text-xs mt-1">
                                            複数の集約間の整合性は、即時ではなく結果的に一致すれば良いケースが多い。
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 参照方法の比較 -->
                    <div class="bg-slate-100 rounded-xl p-6 my-6">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-link text-primary-500"></i>
                            集約間の参照方法
                        </h3>
                        <div class="mermaid">
flowchart LR
    subgraph BAD["悪い例: オブジェクト参照"]
        O1["注文集約"]
        C1["顧客集約"]
        O1 -->|直接参照| C1
    end

    subgraph GOOD["良い例: IDによる参照"]
        O2["注文集約<br/>customer_id: 123"]
        C2["顧客集約<br/>customer_id: 123"]
        O2 -.IDで参照.-> C2
    end

    style BAD fill:#fee2e2,stroke:#ef4444
    style GOOD fill:#d1fae5,stroke:#10b981
    style O1 fill:#fca5a5,stroke:#dc2626
    style C1 fill:#fca5a5,stroke:#dc2626
    style O2 fill:#6ee7b7,stroke:#059669
    style C2 fill:#6ee7b7,stroke:#059669
                        </div>
                    </div>
                </section>

                <!-- セクション6: よくある間違い -->
                <section class="prose prose-slate max-w-none mt-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        6.6 集約設計でよくある間違い
                    </h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 my-6">
                        <!-- 間違い1 -->
                        <div class="bg-gradient-to-br from-red-50 to-orange-50 border border-red-200 rounded-xl p-5">
                            <h4 class="font-semibold text-red-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                                間違い1: 大きすぎる集約
                            </h4>
                            <p class="text-red-900 text-sm mb-2">
                                関連するすべてのオブジェクトを1つの集約にまとめてしまう。
                            </p>
                            <div class="bg-red-100 p-2 rounded text-xs text-red-800">
                                <strong>問題点:</strong>
                                <ul class="mt-1 space-y-1 ml-4">
                                    <li>• メモリ使用量の増加</li>
                                    <li>• トランザクション競合の増加</li>
                                    <li>• パフォーマンスの低下</li>
                                </ul>
                            </div>
                        </div>

                        <!-- 間違い2 -->
                        <div class="bg-gradient-to-br from-red-50 to-orange-50 border border-red-200 rounded-xl p-5">
                            <h4 class="font-semibold text-red-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                                間違い2: 集約の境界を無視
                            </h4>
                            <p class="text-red-900 text-sm mb-2">
                                集約ルートを経由せずに内部オブジェクトを直接変更する。
                            </p>
                            <div class="bg-red-100 p-2 rounded text-xs text-red-800">
                                <strong>問題点:</strong>
                                <ul class="mt-1 space-y-1 ml-4">
                                    <li>• 不変条件が破られる</li>
                                    <li>• データの整合性が失われる</li>
                                    <li>• バグの温床になる</li>
                                </ul>
                            </div>
                        </div>

                        <!-- 間違い3 -->
                        <div class="bg-gradient-to-br from-red-50 to-orange-50 border border-red-200 rounded-xl p-5">
                            <h4 class="font-semibold text-red-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                                間違い3: 複数集約の同時更新
                            </h4>
                            <p class="text-red-900 text-sm mb-2">
                                1つのトランザクションで複数の集約を更新しようとする。
                            </p>
                            <div class="bg-red-100 p-2 rounded text-xs text-red-800">
                                <strong>問題点:</strong>
                                <ul class="mt-1 space-y-1 ml-4">
                                    <li>• スケーラビリティの低下</li>
                                    <li>• デッドロックのリスク</li>
                                    <li>• 分散システムでの実装困難</li>
                                </ul>
                            </div>
                        </div>

                        <!-- 間違い4 -->
                        <div class="bg-gradient-to-br from-red-50 to-orange-50 border border-red-200 rounded-xl p-5">
                            <h4 class="font-semibold text-red-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                                間違い4: 集約間のオブジェクト参照
                            </h4>
                            <p class="text-red-900 text-sm mb-2">
                                他の集約のオブジェクトへの直接参照を保持する。
                            </p>
                            <div class="bg-red-100 p-2 rounded text-xs text-red-800">
                                <strong>問題点:</strong>
                                <ul class="mt-1 space-y-1 ml-4">
                                    <li>• 集約の境界が曖昧になる</li>
                                    <li>• 循環参照のリスク</li>
                                    <li>• 永続化が複雑化</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 実習カード -->
                <div class="bg-gradient-to-r from-purple-50 to-fuchsia-50 border border-purple-200
                            rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-purple-500 rounded-lg
                                    flex items-center justify-center">
                            <i class="fas fa-code text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-purple-800 mb-4 break-words">実習: ブログ記事とコメントの集約を設計する</h3>
                            <div class="space-y-4">
                                <div class="bg-purple-100 p-4 rounded-lg">
                                    <p class="text-purple-900 font-medium mb-2 break-words">要件</p>
                                    <ul class="text-purple-800 text-sm space-y-1 break-words">
                                        <li>• ブログ記事には、タイトル、本文、著者、公開日がある</li>
                                        <li>• 1つの記事には複数のコメントを投稿できる</li>
                                        <li>• コメントには、投稿者名、本文、投稿日時がある</li>
                                        <li>• 下書き状態の記事にはコメントを投稿できない</li>
                                        <li>• 記事が削除されると、すべてのコメントも削除される</li>
                                    </ul>
                                </div>
                                <div class="bg-purple-100 p-4 rounded-lg">
                                    <p class="text-purple-900 font-medium mb-2 break-words">課題</p>
                                    <ol class="text-purple-800 text-sm space-y-2 break-words list-decimal ml-5">
                                        <li>集約ルートはどのエンティティか考えてください</li>
                                        <li>集約内で保護すべき不変条件を3つ挙げてください</li>
                                        <li>Pythonで集約ルート（BlogPost）クラスを実装してください（add_comment、publishメソッドを含む）</li>
                                    </ol>
                                </div>
                                <details class="mt-4">
                                    <summary class="cursor-pointer text-purple-600 hover:text-purple-700 font-medium break-words">
                                        解答例を表示
                                    </summary>
                                    <div class="mt-3 bg-purple-100 p-4 rounded-lg break-words">
                                        <p class="text-purple-900 font-medium mb-2">解答例</p>
                                        <div class="code-block-wrapper mt-2">
                                            <div class="code-header">
                                                <span class="code-title">Python</span>
                                                <button class="copy-btn" onclick="copyCode(this)">
                                                    <i class="fas fa-copy"></i> コピー
                                                </button>
                                            </div>
                                            <pre><code class="language-python">from dataclasses import dataclass, field
from typing import List
from datetime import datetime
from enum import Enum

class PostStatus(Enum):
    """記事のステータス"""
    DRAFT = "draft"          # 下書き
    PUBLISHED = "published"  # 公開中

@dataclass
class Comment:
    """コメント（エンティティ）"""
    comment_id: str
    author_name: str
    content: str
    posted_at: datetime

@dataclass
class BlogPost:
    """ブログ記事（集約ルート）"""
    post_id: str
    title: str
    content: str
    author: str
    status: PostStatus
    published_at: datetime = None
    comments: List[Comment] = field(default_factory=list)

    def publish(self):
        """記事を公開する"""
        if self.status == PostStatus.PUBLISHED:
            raise ValueError("既に公開済みです")

        self.status = PostStatus.PUBLISHED
        self.published_at = datetime.now()

    def add_comment(self, author_name: str, content: str):
        """コメントを追加"""
        # 不変条件: 下書き状態ではコメント不可
        if self.status != PostStatus.PUBLISHED:
            raise ValueError("公開前の記事にはコメントできません")

        # 不変条件: コメント内容は空でない
        if not content.strip():
            raise ValueError("コメント内容は必須です")

        comment = Comment(
            comment_id=f"cmt-{len(self.comments) + 1}",
            author_name=author_name,
            content=content,
            posted_at=datetime.now()
        )
        self.comments.append(comment)

    def comment_count(self) -> int:
        """コメント数を取得"""
        return len(self.comments)

# 使用例
post = BlogPost(
    post_id="POST-001",
    title="DDDを学ぶ",
    content="集約について解説します...",
    author="山田太郎",
    status=PostStatus.DRAFT
)

# 下書き状態ではコメント不可
# post.add_comment("佐藤花子", "面白い!")  # ValueError!

# 公開してからコメント可能
post.publish()
post.add_comment("佐藤花子", "とても分かりやすいです！")
print(f"コメント数: {post.comment_count()}")  # 1</code></pre>
                                        </div>
                                        <div class="mt-3 text-purple-800 text-sm">
                                            <p class="font-medium">保護している不変条件:</p>
                                            <ul class="mt-1 space-y-1 ml-4">
                                                <li>1. 下書き状態の記事にはコメントを投稿できない</li>
                                                <li>2. コメント内容は空でない</li>
                                                <li>3. 記事が削除されると、すべてのコメントも削除される（集約全体が削除される）</li>
                                            </ul>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 理解度確認クイズ -->
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200
                            rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-lg
                                    flex items-center justify-center">
                            <i class="fas fa-question text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-blue-800 mb-4 break-words">理解度確認クイズ</h3>
                            <ol class="space-y-4">
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q1. 集約の主な目的は何ですか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            不変条件（ビジネスルール）を保護することです。集約は関連するオブジェクトをグループ化し、整合性境界を定義することで、ビジネスルールが常に守られることを保証します。
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q2. 集約ルートの役割を3つ挙げてください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            ① 集約内の全オブジェクトへのアクセスを制御する<br>
                                            ② 不変条件の検証と保護を行う<br>
                                            ③ 集約全体のライフサイクルを管理する<br>
                                            （その他、他の集約との関係の調整なども該当）
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q3. なぜ1つのトランザクションで変更できるのは1つの集約のみが原則なのですか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            スケーラビリティを向上させるためです。複数の集約を同時に更新すると、トランザクション競合やデッドロックのリスクが増加し、システムのスケールが困難になります。複数の集約間の整合性は、結果整合性（イベント駆動など）で実現します。
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q4. 集約間の参照は、なぜIDを使うべきなのですか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            集約の境界を明確にし、独立性を保つためです。オブジェクト参照を使うと集約の境界が曖昧になり、循環参照や永続化の複雑化などの問題が発生します。IDによる参照を使うことで、各集約が独立して管理できます。
                                        </p>
                                    </details>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 章のまとめ -->
                <div class="bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200 rounded-xl p-6 my-8">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-clipboard-check text-primary-500"></i>
                        この章のまとめ
                    </h3>
                    <ul class="space-y-2 text-slate-700">
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                            <span>集約は、関連するエンティティと値オブジェクトをグループ化し、不変条件を保護する</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                            <span>集約ルートは、集約への唯一の入口であり、整合性を保つ責任を持つ</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                            <span>整合性境界は、常にビジネスルールが守られている範囲を定義する</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                            <span>1つのトランザクションで変更できるのは1つの集約のみが原則</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                            <span>集約は可能な限り小さく保ち、集約間の参照はIDを使う</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                            <span>注文と注文明細のように、一緒に整合性を保つ必要があるオブジェクトを集約にまとめる</span>
                        </li>
                    </ul>
                </div>

                <!-- 章間ナビゲーション -->
                <nav class="flex items-center justify-between pt-6 mt-6 border-t border-slate-200">
                    <a href="ddd-learning-material-05.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl
                              bg-slate-100 hover:bg-slate-200 transition-colors">
                        <i class="fas fa-arrow-left text-slate-400 group-hover:text-slate-600
                                  transition-transform group-hover:-translate-x-1"></i>
                        <div>
                            <span class="text-xs text-slate-500 block">前の章</span>
                            <span class="text-slate-700 font-medium">値オブジェクト</span>
                        </div>
                    </a>
                    <a href="ddd-learning-material-07.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl
                              bg-primary-500 hover:bg-primary-600 text-white transition-colors">
                        <div class="text-right">
                            <span class="text-xs text-primary-100 block">次の章</span>
                            <span class="font-medium">リポジトリ</span>
                        </div>
                        <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- フッター -->
    <footer class="bg-slate-800 text-slate-300">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <p class="text-sm text-center md:text-left">
                    &copy; 2025 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。
                </p>
                <div class="flex items-center gap-4">
                    <a href="https://github.com/fcircle-biz/tech_docs" class="hover:text-white transition-colors">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- スクロールトップボタン -->
    <button id="scroll-top-btn"
            class="fixed bottom-6 right-6 w-12 h-12 bg-primary-500 text-white rounded-full
                   shadow-lg hover:bg-primary-600 transition-all duration-300
                   opacity-0 invisible translate-y-4"
            onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- サイドバー生成 -->
    <script src="sidebar-content.js"></script>

    <!-- 共通JavaScript -->
    <script src="main.js"></script>

    <!-- 描画ツール -->
    <script src="drawing-tool.js"></script>
</body>
</html>
