<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python SQLModel学習教材 第2章 - モデル定義と型安全性</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #306998;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #306998;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #306998;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #4b8bbe;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #306998;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #306998 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Python SQLModel 学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.html">概要</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://sqlmodel.tiangolo.com/" target="_blank">公式ドキュメント</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-1.html">
                                第1章: SQLModel入門と環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="python-sqlmodel-learning-material-2.html">
                                第2章: モデル定義と型安全性
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-3.html">
                                第3章: 基本的なCRUD操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-4.html">
                                第4章: リレーションシップと結合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-5.html">
                                第5章: FastAPIとの統合開発
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-6.html">
                                第6章: 高度なクエリとパフォーマンス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-7.html">
                                第7章: データベースマイグレーション
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-8.html">
                                第8章: 実践的なWeb API開発
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第2章: モデル定義と型安全性</h1>
                </div>

                <div id="chapter2">
                    <h2 class="chapter-title">高度なモデル定義</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>SQLModelのフィールド定義の詳細</li>
                            <li>型ヒントとバリデーションの活用</li>
                            <li>オプショナルフィールドとデフォルト値の設定</li>
                            <li>カスタムバリデーション関数の実装</li>
                            <li>複数のモデルクラスの管理</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.1 Fieldクラスの詳細</h3>
                    <p>SQLModelでは、<code>Field</code>クラスを使用してフィールドの詳細な設定を行います。これはPydanticのFieldとSQLAlchemyのColumnの機能を統合しています。</p>
                    
                    <div class="exercise-container">
                        <h5>実習 2-1: 詳細なフィールド定義</h5>
                        <p>さまざまなフィールドオプションを使用して、より詳細なモデルを作成します。</p>
                        
                        <h6>実行例 (models.py)</h6>
                        <pre class="code-block"><code class="language-python">from datetime import datetime
from typing import Optional
from sqlmodel import SQLModel, Field
from enum import Enum

class UserStatus(str, Enum):
    ACTIVE = "active"
    INACTIVE = "inactive"
    SUSPENDED = "suspended"

class User(SQLModel, table=True):
    # 主キー
    id: Optional[int] = Field(default=None, primary_key=True)
    
    # 必須フィールド（バリデーション付き）
    username: str = Field(
        min_length=3,
        max_length=50,
        regex=r"^[a-zA-Z0-9_]+$",
        description="ユーザー名（英数字とアンダースコアのみ）"
    )
    
    # ユニーク制約
    email: str = Field(
        max_length=255,
        unique=True,
        index=True,
        description="メールアドレス"
    )
    
    # 数値バリデーション
    age: Optional[int] = Field(
        default=None,
        ge=0,  # 以上
        le=150,  # 以下
        description="年齢"
    )
    
    # Enum型
    status: UserStatus = Field(default=UserStatus.ACTIVE)
    
    # 日時フィールド
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: Optional[datetime] = Field(default=None)
    
    # 浮動小数点数
    score: Optional[float] = Field(
        default=0.0,
        ge=0.0,
        le=100.0,
        description="スコア（0-100）"
    )
    
    # テキストフィールド
    bio: Optional[str] = Field(
        default=None,
        max_length=1000,
        description="自己紹介"
    )</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>詳細なバリデーション機能を持つUserモデルが定義されます。</p>
                    </div>

                    <h3 class="section-title">2.2 カスタムバリデーション</h3>
                    <p>Pydanticのvalidator機能を使用して、複雑なバリデーションロジックを実装できます。</p>

                    <div class="exercise-container">
                        <h5>実習 2-2: カスタムバリデーションの実装</h5>
                        <p>メールアドレスの形式チェックやパスワード強度の検証を実装します。</p>
                        
                        <h6>実行例 (validation_models.py)</h6>
                        <pre class="code-block"><code class="language-python">import re
from typing import Optional
from sqlmodel import SQLModel, Field
from pydantic import validator, EmailStr

class UserWithValidation(SQLModel, table=True):
    __tablename__ = "users_validated"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(min_length=3, max_length=50)
    email: str = Field(max_length=255, unique=True)
    password_hash: str = Field(min_length=8)
    age: Optional[int] = Field(default=None)
    
    @validator('username')
    def validate_username(cls, v):
        if not re.match(r'^[a-zA-Z0-9_]+$', v):
            raise ValueError('ユーザー名は英数字とアンダースコアのみ使用可能です')
        return v.lower()  # 小文字に変換
    
    @validator('email')
    def validate_email(cls, v):
        email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(email_pattern, v):
            raise ValueError('有効なメールアドレスを入力してください')
        return v.lower()
    
    @validator('password_hash')
    def validate_password(cls, v):
        # パスワード強度チェック（簡単な例）
        if len(v) < 8:
            raise ValueError('パスワードは8文字以上である必要があります')
        if not re.search(r'[A-Z]', v):
            raise ValueError('パスワードには大文字を含める必要があります')
        if not re.search(r'[a-z]', v):
            raise ValueError('パスワードには小文字を含める必要があります')
        if not re.search(r'\d', v):
            raise ValueError('パスワードには数字を含める必要があります')
        return v
    
    @validator('age')
    def validate_age(cls, v):
        if v is not None and (v < 0 or v > 150):
            raise ValueError('年齢は0-150の範囲で入力してください')
        return v</code></pre>
                        
                        <h6>バリデーションのテスト</h6>
                        <pre class="code-block"><code class="language-python">from pydantic import ValidationError

def test_validation():
    try:
        # 正常なケース
        user = UserWithValidation(
            username="john_doe",
            email="john@example.com",
            password_hash="SecurePass123",
            age=25
        )
        print("ユーザー作成成功:", user.username)
        
        # エラーケース
        invalid_user = UserWithValidation(
            username="john@doe",  # 無効な文字
            email="invalid-email",  # 無効なメール
            password_hash="weak",  # 弱いパスワード
            age=200  # 無効な年齢
        )
    except ValidationError as e:
        print("バリデーションエラー:")
        for error in e.errors():
            print(f"- {error['loc'][0]}: {error['msg']}")

if __name__ == "__main__":
    test_validation()</code></pre>
                    </div>

                    <h3 class="section-title">2.3 複数モデルの管理</h3>
                    <p>実際のアプリケーションでは複数のモデルを管理する必要があります。適切な設計パターンを学びましょう。</p>

                    <div class="exercise-container">
                        <h5>実習 2-3: 複数モデルの実装</h5>
                        <p>ユーザー、投稿、カテゴリの3つのモデルを作成し、基本的な関係を定義します。</p>
                        
                        <h6>実行例 (complete_models.py)</h6>
                        <pre class="code-block"><code class="language-python">from datetime import datetime
from typing import Optional, List
from sqlmodel import SQLModel, Field, Relationship
from enum import Enum

class PostStatus(str, Enum):
    DRAFT = "draft"
    PUBLISHED = "published"
    ARCHIVED = "archived"

# カテゴリモデル
class Category(SQLModel, table=True):
    __tablename__ = "categories"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(max_length=100, unique=True)
    description: Optional[str] = Field(default=None, max_length=500)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    
    # リレーションシップ（後で定義）
    posts: List["Post"] = Relationship(back_populates="category")

# ユーザーモデル（改良版）
class User(SQLModel, table=True):
    __tablename__ = "users"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(min_length=3, max_length=50, unique=True, index=True)
    email: str = Field(max_length=255, unique=True, index=True)
    full_name: Optional[str] = Field(default=None, max_length=200)
    is_active: bool = Field(default=True)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    last_login: Optional[datetime] = Field(default=None)
    
    # リレーションシップ
    posts: List["Post"] = Relationship(back_populates="author")

# 投稿モデル
class Post(SQLModel, table=True):
    __tablename__ = "posts"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    title: str = Field(min_length=1, max_length=200)
    content: str = Field(min_length=1)
    status: PostStatus = Field(default=PostStatus.DRAFT)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: Optional[datetime] = Field(default=None)
    published_at: Optional[datetime] = Field(default=None)
    
    # 外部キー
    author_id: int = Field(foreign_key="users.id")
    category_id: Optional[int] = Field(default=None, foreign_key="categories.id")
    
    # リレーションシップ
    author: User = Relationship(back_populates="posts")
    category: Optional[Category] = Relationship(back_populates="posts")</code></pre>
                        
                        <h6>データベース作成とテスト</h6>
                        <pre class="code-block"><code class="language-python">from sqlmodel import create_engine, Session

# データベース設定
DATABASE_URL = "sqlite:///./blog.db"
engine = create_engine(DATABASE_URL, echo=True)

def create_tables():
    SQLModel.metadata.create_all(engine)
    print("全テーブルが作成されました")

def create_sample_data():
    with Session(engine) as session:
        # カテゴリ作成
        tech_category = Category(
            name="技術",
            description="プログラミングや技術に関する投稿"
        )
        
        # ユーザー作成
        user = User(
            username="tech_blogger",
            email="blogger@example.com",
            full_name="技術ブロガー"
        )
        
        session.add(tech_category)
        session.add(user)
        session.commit()
        session.refresh(tech_category)
        session.refresh(user)
        
        # 投稿作成
        post = Post(
            title="SQLModelの始め方",
            content="SQLModelは素晴らしいライブラリです...",
            status=PostStatus.PUBLISHED,
            author_id=user.id,
            category_id=tech_category.id,
            published_at=datetime.utcnow()
        )
        
        session.add(post)
        session.commit()
        
        print(f"サンプルデータが作成されました: {post.title}")

if __name__ == "__main__":
    create_tables()
    create_sample_data()</code></pre>
                    </div>

                    <h3 class="section-title">2.4 型安全性の活用</h3>
                    <p>SQLModelの型安全性を最大限に活用する方法を学びます。IDE支援とmypyによる静的型チェックを組み合わせることで、堅牢なコードが書けます。</p>

                    <div class="warning">
                        <h6>型安全性のベストプラクティス</h6>
                        <ul>
                            <li><strong>Optional型の明示</strong>: Noneになり得るフィールドは必ずOptional[型]で定義</li>
                            <li><strong>Enum型の活用</strong>: 固定値はEnumクラスで定義して型安全性を確保</li>
                            <li><strong>mypy導入</strong>: 静的型チェックツールで実行前にエラーを発見</li>
                            <li><strong>IDEの活用</strong>: VS CodeやPyCharmの型ヒント機能を活用</li>
                        </ul>
                    </div>

                    <pre class="code-block"><code class="language-python"># 型安全性の例
def process_user(user: User) -> str:
    # IDEが型を認識してオートコンプリート
    if user.is_active:  # bool型として認識
        return f"アクティブユーザー: {user.username}"  # str型として認識
    else:
        return "非アクティブユーザーです"

# mypyでチェックされる型エラーの例
def bad_example(user: User):
    user.age = "thirty"  # エラー: str型をint型に代入不可
    user.created_at = "2024-01-01"  # エラー: str型をdatetime型に代入不可</code></pre>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>Field()のge=0, le=150パラメータの意味は何ですか？</li>
                            <li>@validatorデコレータの役割は何ですか？</li>
                            <li>Enum型を使用するメリットを2つ挙げてください。</li>
                            <li>Optional[int]とintの違いは何ですか？</li>
                            <li>default_factoryを使用する場面はいつですか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答例</summary>
                            <ol>
                                <li>ge=0は0以上、le=150は150以下という数値の範囲制限</li>
                                <li>カスタムバリデーションロジックを定義し、入力値の検証を行う</li>
                                <li>型安全性の確保、有効な値の制限、IDEでのオートコンプリート支援</li>
                                <li>Optional[int]はNoneまたはint、intはNoneを許可しない</li>
                                <li>実行時に動的に値を生成したい場合（datetime.utcnowなど）</li>
                            </ol>
                        </details>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="python-sqlmodel-learning-material-1.html" class="btn btn-secondary">← 前の章：SQLModel入門</a>
                        <a href="python-sqlmodel-learning-material-3.html" class="btn btn-primary">次の章：基本的なCRUD操作 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>