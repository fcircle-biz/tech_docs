<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python SQLAlchemy学習教材 第3章 - SQLAlchemy ORM基礎</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #306998;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
        }

        /* タイトル */
        .chapter-title {
            color: #306998;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #306998;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #4b8bbe;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f4fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #306998;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #306998 !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Python SQLAlchemy 学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">学習ガイドに戻る</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-1.html">第1章: SQLAlchemy入門と環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-2.html">第2章: SQLAlchemy Core基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter3">第3章: SQLAlchemy ORM基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-4.html">第4章: リレーションシップとJOIN操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-5.html">第5章: 高度なクエリとパフォーマンス最適化</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-6.html">第6章: データベースマイグレーション（Alembic）</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-7.html">第7章: トランザクション管理とエラーハンドリング</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-8.html">第8章: 実践的なアプリケーション開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第3章: SQLAlchemy ORM基礎</h1>
                </div>

                <div id="chapter3">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">SQLAlchemy ORM基礎</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>SQLAlchemy ORMの基本概念とDeclarative Base</li>
                            <li>モデルクラスの定義方法と各種カラム設定</li>
                            <li>Sessionの概念と基本的な使い方</li>
                            <li>ORMを使った基本的なCRUD操作</li>
                            <li>クエリメソッドとフィルタリング手法</li>
                        </ul>
                    </div>

                    <!-- セクション3.1 -->
                    <h3 class="section-title">3.1 SQLAlchemy ORMの概要</h3>
                    <p>SQLAlchemy ORMは、Pythonクラスとデータベーステーブルを対応付けるオブジェクト関係マッピング（ORM）機能を提供します。これにより、オブジェクト指向的な方法でデータベース操作を行えます。</p>

                    <p>ORMの主な利点：</p>
                    <ul>
                        <li><strong>抽象化</strong>: SQLを直接書かずにPythonオブジェクトで操作</li>
                        <li><strong>型安全性</strong>: Pythonの型システムとIDEサポート</li>
                        <li><strong>生産性</strong>: 反復的なSQLコードの削減</li>
                        <li><strong>保守性</strong>: ビジネスロジックとデータアクセスの分離</li>
                    </ul>

                    <!-- セクション3.2 -->
                    <h3 class="section-title">3.2 Declarative Baseとモデル定義</h3>
                    <p>SQLAlchemy 2.0では、DeclarativeMetaクラスを使ってモデルクラスを定義します。</p>

                    <h4>基本的なモデル定義</h4>
                    <pre class="code-block"><code class="language-python">from sqlalchemy import create_engine, Column, Integer, String, DateTime, Boolean, ForeignKey
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column, sessionmaker
from datetime import datetime
from typing import Optional

# Declarative Base クラス
class Base(DeclarativeBase):
    pass

# Userモデルの定義
class User(Base):
    __tablename__ = 'users'
    
    # SQLAlchemy 2.0 の新しい記法
    id: Mapped[int] = mapped_column(primary_key=True)
    username: Mapped[str] = mapped_column(String(50), unique=True)
    email: Mapped[str] = mapped_column(String(120), unique=True)
    full_name: Mapped[Optional[str]] = mapped_column(String(100))
    is_active: Mapped[bool] = mapped_column(Boolean, default=True)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)

    def __repr__(self):
        return f"&lt;User(username='{self.username}', email='{self.email}')&gt;"

# Postモデルの定義
class Post(Base):
    __tablename__ = 'posts'
    
    id: Mapped[int] = mapped_column(primary_key=True)
    title: Mapped[str] = mapped_column(String(200))
    content: Mapped[Optional[str]] = mapped_column(String(5000))
    author_id: Mapped[int] = mapped_column(ForeignKey('users.id'))
    published: Mapped[bool] = mapped_column(Boolean, default=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)

    def __repr__(self):
        return f"&lt;Post(title='{self.title}', published={self.published})&gt;"
</code></pre>

                    <!-- 実習3-1 -->
                    <div class="exercise-container">
                        <h5>実習 3-1: モデルクラスの定義とテーブル作成</h5>
                        <p>ORMモデルクラスを定義し、データベースにテーブルを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>Declarative Baseを作成する</li>
                            <li>複数のモデルクラスを定義する</li>
                            <li>リレーションシップを設定する</li>
                            <li>テーブルを作成する</li>
                        </ol>

                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python"># orm_models.py
from sqlalchemy import create_engine, String, DateTime, Boolean, ForeignKey, Text
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column, sessionmaker, relationship
from datetime import datetime
from typing import Optional, List

class Base(DeclarativeBase):
    pass

# カテゴリモデル
class Category(Base):
    __tablename__ = 'categories'
    
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(50), unique=True)
    description: Mapped[Optional[str]] = mapped_column(String(200))
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    
    # リレーションシップ（後で詳しく学習）
    products: Mapped[List["Product"]] = relationship(back_populates="category")

    def __repr__(self):
        return f"&lt;Category(name='{self.name}')&gt;"

# 商品モデル
class Product(Base):
    __tablename__ = 'products'
    
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(100))
    price: Mapped[int] = mapped_column()  # 価格（円）
    description: Mapped[Optional[str]] = mapped_column(Text)
    category_id: Mapped[int] = mapped_column(ForeignKey('categories.id'))
    stock_quantity: Mapped[int] = mapped_column(default=0)
    is_available: Mapped[bool] = mapped_column(Boolean, default=True)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    updated_at: Mapped[datetime] = mapped_column(
        DateTime, 
        default=datetime.utcnow, 
        onupdate=datetime.utcnow
    )
    
    # リレーションシップ
    category: Mapped["Category"] = relationship(back_populates="products")

    def __repr__(self):
        return f"&lt;Product(name='{self.name}', price={self.price})&gt;"

# データベースエンジンとセッション設定
DATABASE_URL = 'sqlite:///orm_example.db'
engine = create_engine(DATABASE_URL, echo=True)

# テーブル作成
print("Creating tables...")
Base.metadata.create_all(engine)
print("Tables created successfully!")

# セッションファクトリーの作成
SessionLocal = sessionmaker(bind=engine)

# テーブル作成の確認
with engine.connect() as conn:
    from sqlalchemy import text
    result = conn.execute(text("""
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name NOT LIKE 'sqlite_%'
    """))
    
    print("\n--- Created Tables ---")
    for row in result:
        print(f"Table: {row[0]}")
</code></pre>

                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash">Creating tables...
CREATE TABLE categories (...)
CREATE TABLE products (...)
Tables created successfully!

--- Created Tables ---
Table: categories
Table: products</code></pre>
                    </div>

                    <!-- セクション3.3 -->
                    <h3 class="section-title">3.3 セッション管理</h3>
                    <p>SQLAlchemy ORMでは、Sessionオブジェクトがデータベースとの接続とトランザクションを管理します。</p>

                    <h4>セッションの基本概念</h4>
                    <ul>
                        <li><strong>Unit of Work</strong>: 一連の操作を一つのトランザクションとして管理</li>
                        <li><strong>Identity Map</strong>: 同じオブジェクトの重複読み込みを防ぐ</li>
                        <li><strong>Lazy Loading</strong>: 必要になったときにデータを読み込む</li>
                        <li><strong>Change Tracking</strong>: オブジェクトの変更を自動追跡</li>
                    </ul>

                    <h4>セッションの使用パターン</h4>
                    <pre class="code-block"><code class="language-python"># パターン1: context managerを使用（推奨）
with SessionLocal() as session:
    # データベース操作
    user = User(username='alice', email='alice@example.com')
    session.add(user)
    session.commit()

# パターン2: 手動管理
session = SessionLocal()
try:
    # データベース操作
    session.add(user)
    session.commit()
except Exception as e:
    session.rollback()
    raise
finally:
    session.close()

# パターン3: 自動コミット無効化
with SessionLocal() as session:
    with session.begin():
        # この中での操作は自動的にコミットされる
        session.add(user)
</code></pre>

                    <!-- セクション3.4 -->
                    <h3 class="section-title">3.4 ORMでのCRUD操作</h3>
                    <p>ORMを使用した基本的なデータベース操作を学習します。</p>

                    <!-- 実習3-2 -->
                    <div class="exercise-container">
                        <h5>実習 3-2: ORMを使ったCRUD操作</h5>
                        <p>SQLAlchemy ORMを使って基本的なデータベース操作を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>データの作成（Create）</li>
                            <li>データの読み取り（Read）</li>
                            <li>データの更新（Update）</li>
                            <li>データの削除（Delete）</li>
                        </ol>

                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python"># orm_crud.py
from orm_models import Base, Category, Product, SessionLocal, engine
from sqlalchemy import select

# すでに作成されたモデルとエンジンを使用
print("=== ORM CRUD Operations ===")

with SessionLocal() as session:
    # 1. CREATE - データの作成
    print("\n1. CREATE Operations")
    
    # カテゴリの作成
    electronics = Category(
        name='Electronics',
        description='電子製品カテゴリ'
    )
    books = Category(
        name='Books',
        description='書籍カテゴリ'
    )
    
    # セッションに追加（まだデータベースには保存されない）
    session.add(electronics)
    session.add(books)
    
    # 複数オブジェクトを同時に追加
    categories = [
        Category(name='Clothing', description='衣類'),
        Category(name='Sports', description='スポーツ用品')
    ]
    session.add_all(categories)
    
    # データベースに保存
    session.commit()
    print("Categories created and committed")
    
    # 商品の作成
    products = [
        Product(
            name='MacBook Pro',
            price=198000,
            description='高性能ノートパソコン',
            category_id=electronics.id,  # 関連付け
            stock_quantity=5
        ),
        Product(
            name='Python実践入門',
            price=3200,
            description='Python学習書',
            category_id=books.id,
            stock_quantity=20
        ),
        Product(
            name='Wireless Mouse',
            price=2800,
            category_id=electronics.id,
            stock_quantity=15
        )
    ]
    
    session.add_all(products)
    session.commit()
    print("Products created and committed")
    
    # 2. READ - データの読み取り
    print("\n2. READ Operations")
    
    # 全件取得
    stmt = select(Category)
    categories = session.execute(stmt).scalars().all()
    print("All categories:")
    for category in categories:
        print(f"  {category.name}: {category.description}")
    
    # 条件付き取得
    stmt = select(Product).where(Product.price < 10000)
    affordable_products = session.execute(stmt).scalars().all()
    print("\nAffordable products (under 10,000 yen):")
    for product in affordable_products:
        print(f"  {product.name}: {product.price}円")
    
    # 単一レコード取得
    stmt = select(Product).where(Product.name == 'MacBook Pro')
    macbook = session.execute(stmt).scalar_one_or_none()
    if macbook:
        print(f"\nFound MacBook: {macbook.name} - {macbook.price}円")
    
    # IDによる取得
    category_1 = session.get(Category, 1)
    print(f"Category ID 1: {category_1.name}")
    
    # 3. UPDATE - データの更新
    print("\n3. UPDATE Operations")
    
    # オブジェクトの属性を変更
    macbook.price = 185000
    macbook.description = '高性能ノートパソコン（特価！）'
    
    # 在庫更新
    mouse = session.execute(
        select(Product).where(Product.name == 'Wireless Mouse')
    ).scalar_one()
    mouse.stock_quantity = 10
    
    session.commit()
    print("Products updated")
    
    # 更新結果の確認
    updated_macbook = session.get(Product, macbook.id)
    print(f"Updated MacBook price: {updated_macbook.price}円")
    
    # 4. DELETE - データの削除
    print("\n4. DELETE Operations")
    
    # 在庫0の商品を作成（削除テスト用）
    out_of_stock = Product(
        name='Discontinued Item',
        price=1000,
        category_id=electronics.id,
        stock_quantity=0,
        is_available=False
    )
    session.add(out_of_stock)
    session.commit()
    
    # 削除実行
    item_to_delete = session.execute(
        select(Product).where(Product.name == 'Discontinued Item')
    ).scalar_one()
    
    session.delete(item_to_delete)
    session.commit()
    print("Discontinued item deleted")
    
    # 最終的な商品リスト
    print("\n=== Final Product List ===")
    all_products = session.execute(select(Product)).scalars().all()
    for product in all_products:
        print(f"  {product.name}: {product.price}円 (在庫: {product.stock_quantity})")
    
    print(f"\nTotal products: {len(all_products)}")
</code></pre>

                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash">=== ORM CRUD Operations ===

1. CREATE Operations
Categories created and committed
Products created and committed

2. READ Operations
All categories:
  Electronics: 電子製品カテゴリ
  Books: 書籍カテゴリ
  Clothing: 衣類
  Sports: スポーツ用品

Affordable products (under 10,000 yen):
  Python実践入門: 3200円
  Wireless Mouse: 2800円

Found MacBook: MacBook Pro - 198000円
Category ID 1: Electronics

3. UPDATE Operations
Products updated
Updated MacBook price: 185000円

4. DELETE Operations
Discontinued item deleted

=== Final Product List ===
  MacBook Pro: 185000円 (在庫: 5)
  Python実践入門: 3200円 (在庫: 20)
  Wireless Mouse: 2800円 (在庫: 10)

Total products: 3</code></pre>
                    </div>

                    <!-- セクション3.5 -->
                    <h3 class="section-title">3.5 クエリメソッドとフィルタリング</h3>
                    <p>SQLAlchemy ORMは豊富なクエリメソッドを提供し、柔軟なデータ取得が可能です。</p>

                    <h4>主要なクエリメソッド</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>基本クエリ</h5>
                            <pre class="code-block"><code class="language-python"># 全件取得
session.execute(select(Product)).scalars().all()

# 単一レコード取得
session.execute(select(Product)).scalar_one()

# IDによる取得
session.get(Product, 1)</code></pre>
                        </div>
                        <div class="col-md-6">
                            <h5>フィルタリング</h5>
                            <pre class="code-block"><code class="language-python"># 条件指定
select(Product).where(Product.price > 1000)

# 複数条件（AND）
select(Product).where(
    (Product.price > 1000) & (Product.is_available == True)
)

# OR条件
from sqlalchemy import or_
select(Product).where(
    or_(Product.price < 1000, Product.stock_quantity > 50)
)</code></pre>
                        </div>
                    </div>

                    <h4>高度なクエリ機能</h4>
                    <pre class="code-block"><code class="language-python">from sqlalchemy import func, desc

# 並び替え
select(Product).order_by(Product.price.desc())

# LIKE検索
select(Product).where(Product.name.ilike('%book%'))

# 範囲検索
select(Product).where(Product.price.between(1000, 10000))

# リスト検索
select(Product).where(Product.category_id.in_([1, 2, 3]))

# 集計関数
session.execute(select(func.count(Product.id))).scalar()
session.execute(select(func.avg(Product.price))).scalar()

# グループ化
select(Product.category_id, func.count(Product.id)).group_by(Product.category_id)

# LIMIT/OFFSET
select(Product).limit(10).offset(20)
</code></pre>

                    <div class="warning">
                        <h5>SQLAlchemy 2.0での重要な変更点</h5>
                        <ul>
                            <li><strong>新しいクエリ記法</strong>: session.query()は廃止され、select()が標準になりました</li>
                            <li><strong>Result処理</strong>: execute()の結果をscalar()やscalars()で処理する必要があります</li>
                            <li><strong>型ヒント</strong>: Mapped[]型ヒントの使用が推奨されています</li>
                            <li><strong>セッション管理</strong>: context managerの使用が強く推奨されています</li>
                        </ul>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>SQLAlchemy ORMとCoreの主な違いを3つ挙げ、それぞれの利点を説明してください。</li>
                            <li>以下のモデル定義の問題点を指摘し、修正してください：
                                <pre class="code-block"><code class="language-python">class User(Base):
    __tablename__ = 'users'
    id = Column(Integer)
    email = Column(String)
    password = Column(String)</code></pre>
                            </li>
                            <li>セッションのUnit of WorkパターンとIdentity Mapの役割を説明してください。</li>
                            <li>以下のクエリをSQLAlchemy 2.0記法で書き直してください：
                                <pre class="code-block"><code class="language-python">users = session.query(User).filter(User.age > 18).all()</code></pre>
                            </li>
                            <li>ORMでのデータ更新において、オブジェクトの変更追跡（Change Tracking）がどのように機能するか説明してください。</li>
                        </ol>
                        
                        <div class="mt-3">
                            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#answers3">
                                解答を表示
                            </button>
                        </div>
                        
                        <div class="collapse mt-3" id="answers3">
                            <div class="card card-body">
                                <h6>解答例</h6>
                                <p><strong>1.</strong> ORM: オブジェクト指向、開発効率高、型安全性。Core: SQL直接制御、高パフォーマンス、複雑クエリ対応。ORM: ビジネスロジック重視、Core: データアクセス層重視。</p>
                                <p><strong>2.</strong> 修正版：</p>
                                <pre class="code-block"><code class="language-python">class User(Base):
    __tablename__ = 'users'
    id: Mapped[int] = mapped_column(primary_key=True)
    email: Mapped[str] = mapped_column(String(255), unique=True)
    password: Mapped[str] = mapped_column(String(255))</code></pre>
                                <p><strong>3.</strong> Unit of Work: 一連の操作をトランザクション単位で管理。Identity Map: 同一主キーのオブジェクト重複防止とキャッシュ機能。</p>
                                <p><strong>4.</strong> 修正版：</p>
                                <pre class="code-block"><code class="language-python">users = session.execute(select(User).where(User.age > 18)).scalars().all()</code></pre>
                                <p><strong>5.</strong> セッションがオブジェクトの状態変化を追跡し、commit()時に変更されたオブジェクトのみUPDATE文を自動生成・実行。</p>
                            </div>
                        </div>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="python-sqlalchemy-learning-material-2.html" class="btn btn-secondary">← 前の章</a>
                        <a href="python-sqlalchemy-learning-material-4.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>