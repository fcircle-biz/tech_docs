<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI学習教材 第2章 - ルーティングとリクエスト処理</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #2e7d32;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #2e7d32;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d32;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #4caf50;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d32;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #2e7d32 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>FastAPI学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="fastapi-learning-material-1.html">
                                第1章: FastAPI入門と環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="fastapi-learning-material-2.html">
                                第2章: ルーティングとリクエスト処理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="fastapi-learning-material-3.html">
                                第3章: Pydanticモデルとデータ検証
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="fastapi-learning-material-4.html">
                                第4章: レスポンス処理と例外ハンドリング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="fastapi-learning-material-5.html">
                                第5章: 依存性注入とミドルウェア
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="fastapi-learning-material-6.html">
                                第6章: データベース連携とORM
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="fastapi-learning-material-7.html">
                                第7章: 認証とセキュリティ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="fastapi-learning-material-8.html">
                                第8章: 非同期処理とパフォーマンス最適化
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="fastapi-learning-material-9.html">
                                第9章: テストとドキュメント
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="fastapi-learning-material-10.html">
                                第10章: デプロイメントと本番環境
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第2章: ルーティングとリクエスト処理</h1>
                </div>

                <div id="chapter2">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">APIエンドポイントの設計とリクエスト処理</h2>
                    
                    <!-- 学習目標（必須） -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>FastAPIにおけるルーティングの基礎概念と設定方法</li>
                            <li>パスパラメータとクエリパラメータの使い分け</li>
                            <li>リクエストボディの受け取りと処理方法</li>
                            <li>HTTPメソッドの適切な選択と使用法</li>
                            <li>パスオペレーション関数の設計とベストプラクティス</li>
                        </ul>
                    </div>

                    <!-- セクション1: ルーティングの基礎 -->
                    <h3 class="section-title">2.1 ルーティングとは何か</h3>
                    
                    <p>ルーティングは、クライアントからのHTTPリクエストを適切な処理関数に振り分ける仕組みです。FastAPIでは、デコレータを使用して直感的にルーティングを定義できます。</p>
                    
                    <div class="mermaid">
                        graph LR
                            A["HTTP Request<br/>GET /users/123"] --> B["FastAPIルーター"]
                            B --> C["パス解析"]
                            C --> D["適切なハンドラー関数"]
                            D --> E["ビジネスロジック実行"]
                            E --> F["HTTPレスポンス"]
                    </div>

                    <p><strong>ルーティングの基本構造</strong></p>
                    <p>FastAPIでは、以下のパターンでルーティングを定義します：</p>
                    
                    <pre class="code-block"><code class="language-python">from fastapi import FastAPI

app = FastAPI()

@app.{HTTPメソッド}("{パス}")
def 処理関数():
    # ビジネスロジック
    return レスポンス</code></pre>

                    <div class="highlight">
                        <h6>なぜルーティングが重要なのか</h6>
                        <ul>
                            <li><strong>URLの意味付け</strong>: リソースや操作を表現する直感的なURL設計</li>
                            <li><strong>RESTful設計</strong>: HTTPメソッドとパスでAPIの意図を明確に表現</li>
                            <li><strong>保守性</strong>: 機能ごとに分離された処理関数で管理しやすいコード</li>
                            <li><strong>拡張性</strong>: 新機能追加時の影響範囲を限定</li>
                        </ul>
                    </div>

                    <!-- セクション2: HTTPメソッドの使い分け -->
                    <h3 class="section-title">2.2 HTTPメソッドの理解と使い分け</h3>
                    
                    <p>RESTful APIでは、各HTTPメソッドに特定の意味があります。FastAPIでこれらを適切に使い分けることで、API設計の意図が明確になります。</p>

                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>HTTPメソッド</th>
                                <th>用途</th>
                                <th>ボディ</th>
                                <th>冪等性</th>
                                <th>例</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>GET</strong></td>
                                <td>データの取得</td>
                                <td>なし</td>
                                <td>あり</td>
                                <td>ユーザー一覧取得</td>
                            </tr>
                            <tr>
                                <td><strong>POST</strong></td>
                                <td>データの作成</td>
                                <td>あり</td>
                                <td>なし</td>
                                <td>新規ユーザー作成</td>
                            </tr>
                            <tr>
                                <td><strong>PUT</strong></td>
                                <td>データの完全更新</td>
                                <td>あり</td>
                                <td>あり</td>
                                <td>ユーザー情報置換</td>
                            </tr>
                            <tr>
                                <td><strong>PATCH</strong></td>
                                <td>データの部分更新</td>
                                <td>あり</td>
                                <td>なし</td>
                                <td>ユーザー名のみ更新</td>
                            </tr>
                            <tr>
                                <td><strong>DELETE</strong></td>
                                <td>データの削除</td>
                                <td>なし</td>
                                <td>あり</td>
                                <td>ユーザー削除</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="exercise-container">
                        <h5>実習 2-1: 基本的なHTTPメソッドの実装</h5>
                        <p>ユーザー管理システムの基本的なCRUD操作を実装します。</p>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI

app = FastAPI()

# 仮のユーザーデータベース
users_db = [
    {"id": 1, "name": "太郎", "email": "taro@example.com"},
    {"id": 2, "name": "花子", "email": "hanako@example.com"}
]

@app.get("/users")
def get_users():
    """すべてのユーザーを取得"""
    return {"users": users_db}

@app.get("/users/{user_id}")
def get_user(user_id: int):
    """特定のユーザーを取得"""
    for user in users_db:
        if user["id"] == user_id:
            return user
    return {"message": "ユーザーが見つかりません"}

@app.post("/users")
def create_user(user_data: dict):
    """新規ユーザーを作成"""
    new_id = max([user["id"] for user in users_db]) + 1
    new_user = {
        "id": new_id,
        "name": user_data["name"],
        "email": user_data["email"]
    }
    users_db.append(new_user)
    return {"message": "ユーザーが作成されました", "user": new_user}</code></pre>
                        <h6>期待される結果</h6>
                        <p>各エンドポイントが適切に動作し、Swagger UIで操作をテストできます。</p>
                    </div>

                    <!-- セクション3: パスパラメータ -->
                    <h3 class="section-title">2.3 パスパラメータの活用</h3>
                    
                    <p>パスパラメータは、URL内に埋め込まれた動的な値を受け取る仕組みです。リソースを一意に識別する際に使用されます。</p>

                    <div class="mermaid">
                        graph LR
                            A["/users/123"] --> B["パス解析"]
                            B --> C["user_id = 123"]
                            C --> D["関数に渡される"]
                    </div>

                    <p><strong>パスパラメータの基本的な使い方</strong></p>
                    
                    <div class="exercise-container">
                        <h5>実習 2-2: パスパラメータの詳細実装</h5>
                        <p>様々な型のパスパラメータを使用したエンドポイントを作成します。</p>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, Path
from enum import Enum

app = FastAPI()

# 商品カテゴリーを定義（Enum使用）
class CategoryEnum(str, Enum):
    electronics = "electronics"
    books = "books"
    clothing = "clothing"

@app.get("/items/{item_id}")
def get_item(
    item_id: int = Path(..., ge=1, description="商品ID（1以上）")
):
    """商品情報を取得（バリデーション付き）"""
    return {
        "item_id": item_id,
        "name": f"商品{item_id}",
        "category": "electronics"
    }

@app.get("/categories/{category}/items/{item_id}")
def get_item_by_category(
    category: CategoryEnum,
    item_id: int = Path(..., ge=1, le=9999, description="商品ID")
):
    """カテゴリー別商品取得"""
    return {
        "category": category,
        "item_id": item_id,
        "path": f"/{category}/items/{item_id}"
    }

@app.get("/files/{file_path:path}")
def read_file(file_path: str):
    """ファイルパス（スラッシュを含む）を受け取る"""
    return {"file_path": file_path}</code></pre>
                        <h6>期待される結果</h6>
                        <p>型変換、バリデーション、Enumによる制限が正しく機能することを確認します。</p>
                    </div>

                    <div class="highlight">
                        <h6>パスパラメータのベストプラクティス</h6>
                        <ul>
                            <li><strong>型指定</strong>: 必ず適切な型（int, str, Enum等）を指定</li>
                            <li><strong>バリデーション</strong>: Path()を使用して制約条件を設定</li>
                            <li><strong>説明文</strong>: APIドキュメントのためのdescription追加</li>
                            <li><strong>一意性</strong>: パスパラメータはリソースを一意に特定できるもの</li>
                        </ul>
                    </div>

                    <!-- セクション4: クエリパラメータ -->
                    <h3 class="section-title">2.4 クエリパラメータによる柔軟な検索</h3>
                    
                    <p>クエリパラメータは、URL末尾の「?」以降に記述されるパラメータで、フィルタリングや並び替えなど、オプショナルな条件指定に使用されます。</p>

                    <div class="mermaid">
                        graph LR
                            A["/users?page=1&limit=10&sort=name"] --> B["クエリ解析"]
                            B --> C["page=1, limit=10, sort=name"]
                            C --> D["関数パラメータに渡される"]
                    </div>

                    <div class="exercise-container">
                        <h5>実習 2-3: クエリパラメータによる検索・フィルタリング</h5>
                        <p>商品検索APIでクエリパラメータを活用した機能を実装します。</p>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, Query
from typing import Optional
from enum import Enum

app = FastAPI()

# ソート順の定義
class SortOrder(str, Enum):
    asc = "asc"
    desc = "desc"

# サンプル商品データ
products = [
    {"id": 1, "name": "ノートパソコン", "category": "electronics", "price": 80000},
    {"id": 2, "name": "Python入門書", "category": "books", "price": 3000},
    {"id": 3, "name": "Tシャツ", "category": "clothing", "price": 2500},
    {"id": 4, "name": "スマートフォン", "category": "electronics", "price": 60000},
]

@app.get("/products")
def search_products(
    q: Optional[str] = Query(None, description="商品名での検索キーワード"),
    category: Optional[str] = Query(None, description="カテゴリーフィルター"),
    min_price: Optional[int] = Query(None, ge=0, description="最低価格"),
    max_price: Optional[int] = Query(None, ge=0, description="最高価格"),
    limit: int = Query(10, ge=1, le=100, description="取得件数"),
    sort: SortOrder = Query(SortOrder.asc, description="並び順"),
    page: int = Query(1, ge=1, description="ページ番号")
):
    """商品検索API（複数条件対応）"""
    
    # フィルタリング処理
    filtered_products = products.copy()
    
    if q:
        filtered_products = [p for p in filtered_products if q.lower() in p["name"].lower()]
    
    if category:
        filtered_products = [p for p in filtered_products if p["category"] == category]
    
    if min_price is not None:
        filtered_products = [p for p in filtered_products if p["price"] >= min_price]
    
    if max_price is not None:
        filtered_products = [p for p in filtered_products if p["price"] <= max_price]
    
    # ソート処理
    if sort == SortOrder.desc:
        filtered_products.sort(key=lambda x: x["price"], reverse=True)
    else:
        filtered_products.sort(key=lambda x: x["price"])
    
    # ページネーション
    start_index = (page - 1) * limit
    end_index = start_index + limit
    paginated_products = filtered_products[start_index:end_index]
    
    return {
        "products": paginated_products,
        "total": len(filtered_products),
        "page": page,
        "limit": limit,
        "total_pages": (len(filtered_products) + limit - 1) // limit
    }</code></pre>
                        <h6>期待される結果</h6>
                        <p>様々なクエリパラメータの組み合わせで商品検索ができ、ページネーションが正しく機能します。</p>
                    </div>

                    <div class="warning">
                        <h6>クエリパラメータ使用時の注意点</h6>
                        <ul>
                            <li>デフォルト値の設定で必須/任意を明確にする</li>
                            <li>Query()でバリデーションルールを設定する</li>
                            <li>大量のデータ取得を防ぐためlimitの上限を設定</li>
                            <li>SQLインジェクション対策を考慮した値の処理</li>
                        </ul>
                    </div>

                    <!-- セクション5: リクエストボディ -->
                    <h3 class="section-title">2.5 リクエストボディの処理</h3>
                    
                    <p>リクエストボディは、POST、PUT、PATCHメソッドでクライアントからサーバーに送信されるデータです。FastAPIでは、Pythonの辞書や後に学習するPydanticモデルで受け取れます。</p>

                    <div class="mermaid">
                        sequenceDiagram
                            participant C as クライアント
                            participant F as FastAPI
                            participant H as ハンドラー関数
                            
                            C->>F: POST /users<br/>{"name": "太郎", "email": "taro@example.com"}
                            F->>F: JSON解析・バリデーション
                            F->>H: user_data パラメータに渡す
                            H->>H: ビジネスロジック実行
                            H->>F: レスポンスデータ
                            F->>C: JSON レスポンス
                    </div>

                    <div class="exercise-container">
                        <h5>実習 2-4: リクエストボディを使った投稿システム</h5>
                        <p>ブログ投稿システムを例に、リクエストボディの処理を学習します。</p>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, Body
from typing import Optional
from datetime import datetime

app = FastAPI()

# ブログ投稿データベース（仮）
blog_posts = []

@app.post("/posts")
def create_post(post_data: dict = Body(...)):
    """新規ブログ投稿の作成"""
    
    # 必須フィールドのチェック
    required_fields = ["title", "content", "author"]
    for field in required_fields:
        if field not in post_data:
            return {"error": f"必須フィールド '{field}' が不足しています"}
    
    # 新規投稿の作成
    new_post = {
        "id": len(blog_posts) + 1,
        "title": post_data["title"],
        "content": post_data["content"],
        "author": post_data["author"],
        "tags": post_data.get("tags", []),  # オプショナル
        "published": post_data.get("published", True),
        "created_at": datetime.now().isoformat(),
        "updated_at": datetime.now().isoformat()
    }
    
    blog_posts.append(new_post)
    
    return {
        "message": "投稿が作成されました",
        "post": new_post
    }

@app.put("/posts/{post_id}")
def update_post(post_id: int, post_data: dict):
    """投稿の完全更新（PUT）"""
    
    # 投稿の検索
    for i, post in enumerate(blog_posts):
        if post["id"] == post_id:
            # 完全置換
            updated_post = {
                "id": post_id,
                "title": post_data["title"],
                "content": post_data["content"],
                "author": post_data["author"],
                "tags": post_data.get("tags", []),
                "published": post_data.get("published", True),
                "created_at": post["created_at"],  # 作成日は保持
                "updated_at": datetime.now().isoformat()
            }
            blog_posts[i] = updated_post
            return {"message": "投稿が更新されました", "post": updated_post}
    
    return {"error": "投稿が見つかりません"}

@app.patch("/posts/{post_id}")
def partial_update_post(post_id: int, post_data: dict):
    """投稿の部分更新（PATCH）"""
    
    # 投稿の検索
    for post in blog_posts:
        if post["id"] == post_id:
            # 部分更新（送信されたフィールドのみ更新）
            for key, value in post_data.items():
                if key in ["title", "content", "author", "tags", "published"]:
                    post[key] = value
            post["updated_at"] = datetime.now().isoformat()
            
            return {"message": "投稿が部分更新されました", "post": post}
    
    return {"error": "投稿が見つかりません"}</code></pre>
                        <h6>期待される結果</h6>
                        <p>POST、PUT、PATCHでそれぞれ異なる更新動作が確認でき、Swagger UIで各操作をテストできます。</p>
                    </div>

                    <!-- セクション6: 複合パラメータの使用 -->
                    <h3 class="section-title">2.6 複合パラメータの組み合わせ</h3>
                    
                    <p>実際のAPIでは、パスパラメータ、クエリパラメータ、リクエストボディを組み合わせて使用することが一般的です。</p>

                    <div class="exercise-container">
                        <h5>実習 2-5: 複合パラメータを使った高度なAPI</h5>
                        <p>ユーザーのブログ投稿管理システムで、複数種類のパラメータを組み合わせます。</p>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, Path, Query, Body
from typing import Optional

app = FastAPI()

@app.post("/users/{user_id}/posts")
def create_user_post(
    # パスパラメータ
    user_id: int = Path(..., ge=1, description="ユーザーID"),
    
    # クエリパラメータ
    draft: bool = Query(False, description="下書きとして保存"),
    notify_followers: bool = Query(True, description="フォロワーに通知"),
    
    # リクエストボディ
    post_data: dict = Body(...)
):
    """特定ユーザーの投稿作成（複合パラメータ）"""
    
    # バリデーション
    if "title" not in post_data or "content" not in post_data:
        return {"error": "titleとcontentは必須です"}
    
    # 新規投稿の作成
    new_post = {
        "id": 101,  # 実際はDB生成
        "user_id": user_id,
        "title": post_data["title"],
        "content": post_data["content"],
        "draft": draft,
        "notify_sent": notify_followers and not draft,
        "created_at": "2025-01-01T12:00:00"
    }
    
    return {
        "message": "投稿が作成されました",
        "post": new_post,
        "notifications": {
            "draft_mode": draft,
            "followers_notified": notify_followers and not draft
        }
    }

@app.get("/users/{user_id}/posts")
def get_user_posts(
    # パスパラメータ
    user_id: int = Path(..., ge=1),
    
    # クエリパラメータによる絞り込み
    include_drafts: bool = Query(False, description="下書きも含む"),
    tag: Optional[str] = Query(None, description="タグフィルター"),
    limit: int = Query(10, ge=1, le=50),
    offset: int = Query(0, ge=0)
):
    """ユーザーの投稿一覧取得（フィルタリング付き）"""
    
    # 模擬データ
    all_posts = [
        {"id": 1, "user_id": user_id, "title": "投稿1", "draft": False, "tags": ["tech"]},
        {"id": 2, "user_id": user_id, "title": "下書き1", "draft": True, "tags": ["personal"]},
    ]
    
    # フィルタリング
    filtered_posts = []
    for post in all_posts:
        if not include_drafts and post["draft"]:
            continue
        if tag and tag not in post.get("tags", []):
            continue
        filtered_posts.append(post)
    
    # ページネーション
    paginated_posts = filtered_posts[offset:offset + limit]
    
    return {
        "user_id": user_id,
        "posts": paginated_posts,
        "total": len(filtered_posts),
        "returned": len(paginated_posts),
        "filters": {
            "include_drafts": include_drafts,
            "tag": tag
        }
    }</code></pre>
                        <h6>期待される結果</h6>
                        <p>パスパラメータでユーザー指定、クエリパラメータで条件指定、ボディでデータ送信が正しく動作します。</p>
                    </div>

                    <!-- セクション7: エラーハンドリング基礎 -->
                    <h3 class="section-title">2.7 基本的なエラーハンドリング</h3>
                    
                    <p>適切なエラー処理は、API設計の重要な要素です。FastAPIでは、HTTPExceptionを使用して標準的なHTTPエラーレスポンスを返せます。</p>

                    <div class="exercise-container">
                        <h5>実習 2-6: エラーハンドリングの実装</h5>
                        <p>適切なエラーレスポンスを返すエンドポイントを作成します。</p>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, HTTPException, Path
from typing import List, Dict

app = FastAPI()

# 仮のユーザーデータベース
users: List[Dict] = [
    {"id": 1, "name": "太郎", "email": "taro@example.com", "active": True},
    {"id": 2, "name": "花子", "email": "hanako@example.com", "active": False},
]

@app.get("/users/{user_id}")
def get_user_with_error_handling(
    user_id: int = Path(..., ge=1, description="ユーザーID")
):
    """エラーハンドリング付きユーザー取得"""
    
    # ユーザー検索
    for user in users:
        if user["id"] == user_id:
            if not user["active"]:
                raise HTTPException(
                    status_code=403,
                    detail="このユーザーはアクティブではありません"
                )
            return {"user": user}
    
    # ユーザーが見つからない場合
    raise HTTPException(
        status_code=404,
        detail=f"ID {user_id} のユーザーは存在しません"
    )

@app.delete("/users/{user_id}")
def delete_user(user_id: int = Path(..., ge=1)):
    """ユーザー削除（エラー処理付き）"""
    
    for i, user in enumerate(users):
        if user["id"] == user_id:
            deleted_user = users.pop(i)
            return {
                "message": "ユーザーが削除されました",
                "deleted_user": deleted_user
            }
    
    raise HTTPException(
        status_code=404,
        detail="削除対象のユーザーが見つかりません"
    )</code></pre>
                        <h6>期待される結果</h6>
                        <p>適切なHTTPステータスコードとエラーメッセージが返され、APIドキュメントにもエラー情報が反映されます。</p>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>以下のURL「/users/123?page=2&limit=10」において、パスパラメータとクエリパラメータを識別してください。</strong>
                                <details>
                                    <summary>解答例</summary>
                                    <p>パスパラメータ: 123（user_id）<br>
                                    クエリパラメータ: page=2, limit=10</p>
                                </details>
                            </li>
                            <li>
                                <strong>RESTful APIにおいて、新規リソース作成とデータの完全更新に使用するHTTPメソッドはそれぞれ何ですか？</strong>
                                <details>
                                    <summary>解答例</summary>
                                    <p>新規リソース作成: POST<br>
                                    データの完全更新: PUT</p>
                                </details>
                            </li>
                            <li>
                                <strong>FastAPIでパスパラメータに制約条件を設定するために使用する関数は何ですか？</strong>
                                <details>
                                    <summary>解答例</summary>
                                    <p>Path()関数<br>
                                    例: user_id: int = Path(..., ge=1, description="ユーザーID")</p>
                                </details>
                            </li>
                            <li>
                                <strong>404エラー（Not Found）を返すために使用するFastAPIの例外クラスと、その基本的な使用方法を説明してください。</strong>
                                <details>
                                    <summary>解答例</summary>
                                    <p>HTTPException クラス<br>
                                    使用例: raise HTTPException(status_code=404, detail="リソースが見つかりません")</p>
                                </details>
                            </li>
                        </ol>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">2.8 まとめ</h3>
                    <p>この章では、FastAPIにおけるルーティングとリクエスト処理の基礎を学習しました。</p>
                    
                    <div class="highlight">
                        <h6>この章で習得したスキル</h6>
                        <ul>
                            <li>HTTPメソッドの適切な使い分けと実装方法</li>
                            <li>パスパラメータを使ったリソース特定</li>
                            <li>クエリパラメータによる柔軟な検索・フィルタリング</li>
                            <li>リクエストボディを使ったデータ受信</li>
                            <li>複合パラメータの組み合わせ活用</li>
                            <li>基本的なエラーハンドリングの実装</li>
                        </ul>
                    </div>

                    <p>次の章では、Pydanticモデルを使用した型安全なデータ検証とシリアライゼーションについて詳しく学習します。</p>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="fastapi-learning-material-1.html" class="btn btn-secondary">← 前の章: FastAPI入門と環境構築</a>
                        <a href="fastapi-learning-material-3.html" class="btn btn-primary">次の章: Pydanticモデルとデータ検証 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 F-Circle All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>