<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI学習教材 第4章 - レスポンス処理と例外ハンドリング</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar { background-color: #2e7d32; }
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        .chapter-title {
            color: #2e7d32;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d32;
            padding-bottom: 0.5rem;
        }
        .section-title {
            color: #4caf50;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d32;
        }
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .nav-link.active {
            background-color: #2e7d32 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand"><strong>FastAPI学習教材</strong></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-1.html">第1章: FastAPI入門と環境構築</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-2.html">第2章: ルーティングとリクエスト処理</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-3.html">第3章: Pydanticモデルとデータ検証</a></li>
                        <li class="nav-item"><a class="nav-link active" href="fastapi-learning-material-4.html">第4章: レスポンス処理と例外ハンドリング</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-5.html">第5章: 依存性注入とミドルウェア</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-6.html">第6章: データベース連携とORM</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-7.html">第7章: 認証とセキュリティ</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-8.html">第8章: 非同期処理とパフォーマンス最適化</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-9.html">第9章: テストとドキュメント</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-10.html">第10章: デプロイメントと本番環境</a></li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第4章: レスポンス処理と例外ハンドリング</h1>
                </div>

                <div id="chapter4">
                    <h2 class="chapter-title">堅牢なAPIのためのエラー処理と適切なレスポンス</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>HTTPステータスコードの理解と適切な使い分け</li>
                            <li>FastAPIでのカスタムレスポンス作成方法</li>
                            <li>HTTPExceptionを使った例外処理</li>
                            <li>カスタム例外ハンドラーの実装</li>
                            <li>エラーレスポンスの統一化とベストプラクティス</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.1 HTTPステータスコードの理解</h3>
                    <p>APIの品質を決める重要な要素の一つが、適切なHTTPステータスコードの使用です。クライアント側がAPIの実行結果を正しく理解できるよう、状況に応じた適切なコードを返す必要があります。</p>

                    <div class="mermaid">
                        graph TD
                            A["HTTPリクエスト"] --> B["FastAPI処理"]
                            B --> C{"処理結果"}
                            C -->|成功| D["2xx 成功"]
                            C -->|クライアントエラー| E["4xx クライアントエラー"]
                            C -->|サーバーエラー| F["5xx サーバーエラー"]
                            
                            D --> G["200 OK<br/>201 Created<br/>204 No Content"]
                            E --> H["400 Bad Request<br/>401 Unauthorized<br/>404 Not Found"]
                            F --> I["500 Internal Server Error<br/>503 Service Unavailable"]
                    </div>

                    <div class="exercise-container">
                        <h5>実習 4-1: 適切なHTTPステータスコードの実装</h5>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, HTTPException, status
from fastapi.responses import JSONResponse
from pydantic import BaseModel
from typing import List

app = FastAPI()

class User(BaseModel):
    id: int
    name: str
    email: str
    active: bool

users_db = [
    User(id=1, name="太郎", email="taro@example.com", active=True),
    User(id=2, name="花子", email="hanako@example.com", active=False),
]

@app.post("/users", status_code=status.HTTP_201_CREATED)
def create_user(user_data: dict):
    """ユーザー作成（201 Createdを返す）"""
    new_user = User(
        id=len(users_db) + 1,
        name=user_data["name"],
        email=user_data["email"],
        active=True
    )
    users_db.append(new_user)
    return {"message": "ユーザーが作成されました", "user": new_user}

@app.get("/users/{user_id}")
def get_user(user_id: int):
    """ユーザー取得（404 Not Foundの適切な処理）"""
    for user in users_db:
        if user.id == user_id:
            return user
    
    # ユーザーが見つからない場合
    raise HTTPException(
        status_code=status.HTTP_404_NOT_FOUND,
        detail=f"ID {user_id} のユーザーは存在しません"
    )

@app.put("/users/{user_id}")
def update_user(user_id: int, user_data: dict):
    """ユーザー更新（適切なステータスコード）"""
    for i, user in enumerate(users_db):
        if user.id == user_id:
            if not user.active:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail="非アクティブユーザーは更新できません"
                )
            
            users_db[i] = User(
                id=user_id,
                name=user_data.get("name", user.name),
                email=user_data.get("email", user.email),
                active=user_data.get("active", user.active)
            )
            return {"message": "ユーザーが更新されました", "user": users_db[i]}
    
    raise HTTPException(
        status_code=status.HTTP_404_NOT_FOUND,
        detail="更新対象のユーザーが見つかりません"
    )

@app.delete("/users/{user_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_user(user_id: int):
    """ユーザー削除（204 No Contentを返す）"""
    for i, user in enumerate(users_db):
        if user.id == user_id:
            del users_db[i]
            return  # 204の場合はレスポンスボディなし
    
    raise HTTPException(
        status_code=status.HTTP_404_NOT_FOUND,
        detail="削除対象のユーザーが見つかりません"
    )</code></pre>
                    </div>

                    <h3 class="section-title">4.2 カスタム例外ハンドラーの実装</h3>
                    <p>アプリケーション全体で一貫したエラーレスポンス形式を提供するために、カスタム例外ハンドラーを実装できます。</p>

                    <div class="exercise-container">
                        <h5>実習 4-2: 統一されたエラーハンドリング</h5>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, HTTPException, Request, status
from fastapi.responses import JSONResponse
from fastapi.exceptions import RequestValidationError
from pydantic import ValidationError
import traceback
from datetime import datetime

app = FastAPI()

# カスタム例外クラスの定義
class BusinessLogicError(Exception):
    def __init__(self, message: str, error_code: str = "BUSINESS_ERROR"):
        self.message = message
        self.error_code = error_code
        super().__init__(self.message)

class DatabaseError(Exception):
    def __init__(self, message: str = "データベースエラーが発生しました"):
        self.message = message
        super().__init__(self.message)

# 統一エラーレスポンス形式
def create_error_response(
    error_type: str,
    message: str,
    status_code: int,
    details: dict = None
):
    """統一されたエラーレスポンス作成"""
    error_response = {
        "error": {
            "type": error_type,
            "message": message,
            "timestamp": datetime.now().isoformat(),
            "status_code": status_code
        }
    }
    
    if details:
        error_response["error"]["details"] = details
    
    return JSONResponse(
        status_code=status_code,
        content=error_response
    )

# HTTPException用カスタムハンドラー
@app.exception_handler(HTTPException)
async def http_exception_handler(request: Request, exc: HTTPException):
    """HTTP例外のカスタムハンドラー"""
    return create_error_response(
        error_type="HTTP_ERROR",
        message=exc.detail,
        status_code=exc.status_code,
        details={"path": str(request.url)}
    )

# バリデーションエラー用ハンドラー
@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    """リクエストバリデーションエラーのハンドラー"""
    error_details = []
    for error in exc.errors():
        error_details.append({
            "field": ".".join(str(x) for x in error["loc"]),
            "message": error["msg"],
            "type": error["type"]
        })
    
    return create_error_response(
        error_type="VALIDATION_ERROR",
        message="リクエストデータが無効です",
        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        details={"validation_errors": error_details}
    )

# ビジネスロジックエラー用ハンドラー
@app.exception_handler(BusinessLogicError)
async def business_logic_exception_handler(request: Request, exc: BusinessLogicError):
    """ビジネスロジックエラーのハンドラー"""
    return create_error_response(
        error_type="BUSINESS_ERROR",
        message=exc.message,
        status_code=status.HTTP_400_BAD_REQUEST,
        details={"error_code": exc.error_code}
    )

# データベースエラー用ハンドラー
@app.exception_handler(DatabaseError)
async def database_exception_handler(request: Request, exc: DatabaseError):
    """データベースエラーのハンドラー"""
    return create_error_response(
        error_type="DATABASE_ERROR",
        message="データベース処理中にエラーが発生しました",
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR
    )

# 一般的な例外用ハンドラー
@app.exception_handler(Exception)
async def general_exception_handler(request: Request, exc: Exception):
    """予期しない例外のハンドラー"""
    # 本番環境では詳細なエラー情報をログに記録
    print(f"Unexpected error: {traceback.format_exc()}")
    
    return create_error_response(
        error_type="INTERNAL_ERROR",
        message="内部サーバーエラーが発生しました",
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR
    )</code></pre>
                    </div>

                    <h3 class="section-title">4.3 カスタムレスポンスクラス</h3>
                    <p>特定の形式のレスポンスが必要な場合、カスタムレスポンスクラスを作成できます。</p>

                    <div class="exercise-container">
                        <h5>実習 4-3: カスタムレスポンス実装</h5>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, Response
from fastapi.responses import JSONResponse, FileResponse, RedirectResponse
from typing import Any, Dict
import json

app = FastAPI()

class APIResponse(JSONResponse):
    """統一されたAPIレスポンス形式"""
    def __init__(
        self,
        data: Any = None,
        message: str = "success",
        status_code: int = 200,
        success: bool = True,
        **kwargs
    ):
        response_content = {
            "success": success,
            "message": message,
            "data": data,
            "timestamp": datetime.now().isoformat()
        }
        
        super().__init__(
            content=response_content,
            status_code=status_code,
            **kwargs
        )

@app.get("/users")
def get_users():
    """統一レスポンス形式でユーザー一覧を返す"""
    users = [
        {"id": 1, "name": "太郎"},
        {"id": 2, "name": "花子"}
    ]
    
    return APIResponse(
        data=users,
        message="ユーザー一覧を取得しました"
    )

@app.get("/download/report")
def download_report():
    """ファイルダウンロードレスポンス"""
    # 実際のファイル生成処理をシミュレート
    file_path = "/path/to/report.pdf"  # 実際のファイルパス
    
    return FileResponse(
        path=file_path,
        filename="monthly_report.pdf",
        media_type="application/pdf"
    )

@app.get("/redirect-to-docs")
def redirect_to_docs():
    """リダイレクトレスポンス"""
    return RedirectResponse(
        url="/docs",
        status_code=status.HTTP_302_FOUND
    )

@app.get("/health")
def health_check():
    """ヘルスチェック用レスポンス"""
    return APIResponse(
        data={
            "status": "healthy",
            "version": "1.0.0",
            "uptime": "24 hours"
        },
        message="アプリケーションは正常に動作しています"
    )</code></pre>
                    </div>

                    <h3 class="section-title">4.4 バリデーションエラーのカスタマイズ</h3>
                    <p>Pydanticのバリデーションエラーをユーザーフレンドリーな形式で返すためのカスタマイズ方法を学習します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-4: ユーザーフレンドリーなバリデーションエラー</h5>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, HTTPException
from fastapi.exceptions import RequestValidationError
from pydantic import BaseModel, Field, ValidationError, validator
from typing import List, Dict, Any

app = FastAPI()

# 日本語エラーメッセージマッピング
ERROR_MESSAGES = {
    "value_error.missing": "この項目は必須です",
    "value_error.number.not_ge": "値が小さすぎます",
    "value_error.number.not_le": "値が大きすぎます",
    "value_error.str.min_length": "文字数が不足しています",
    "value_error.str.max_length": "文字数が超過しています",
    "value_error.email": "有効なメールアドレスを入力してください",
    "type_error.integer": "整数を入力してください",
    "type_error.str": "文字列を入力してください"
}

def translate_validation_error(error: Dict[str, Any]) -> str:
    """バリデーションエラーを日本語に翻訳"""
    error_type = error.get("type", "")
    
    # カスタムエラーメッセージがある場合
    if error_type in ERROR_MESSAGES:
        base_message = ERROR_MESSAGES[error_type]
        
        # 制約値を含むエラーメッセージの生成
        ctx = error.get("ctx", {})
        if "limit_value" in ctx:
            limit = ctx["limit_value"]
            if "min_length" in error_type:
                return f"{limit}文字以上で入力してください"
            elif "max_length" in error_type:
                return f"{limit}文字以下で入力してください"
            elif "not_ge" in error_type:
                return f"{limit}以上の値を入力してください"
            elif "not_le" in error_type:
                return f"{limit}以下の値を入力してください"
        
        return base_message
    
    # デフォルトメッセージ
    return error.get("msg", "入力値が無効です")

@app.exception_handler(RequestValidationError)
async def custom_validation_exception_handler(request, exc: RequestValidationError):
    """カスタムバリデーションエラーハンドラー"""
    formatted_errors = {}
    
    for error in exc.errors():
        field_path = ".".join(str(x) for x in error["loc"][1:])  # 'body'を除外
        if not field_path:
            field_path = "root"
        
        # フィールドごとにエラーをグループ化
        if field_path not in formatted_errors:
            formatted_errors[field_path] = []
        
        translated_message = translate_validation_error(error)
        formatted_errors[field_path].append(translated_message)
    
    return JSONResponse(
        status_code=422,
        content={
            "error": {
                "type": "VALIDATION_ERROR",
                "message": "入力データに問題があります",
                "field_errors": formatted_errors,
                "timestamp": datetime.now().isoformat()
            }
        }
    )

class UserRegistration(BaseModel):
    name: str = Field(..., min_length=2, max_length=20)
    email: str = Field(..., regex=r'^[^@]+@[^@]+\.[^@]+$')
    age: int = Field(..., ge=13, le=100)
    password: str = Field(..., min_length=8)

@app.post("/register")
def register_user(user: UserRegistration):
    """ユーザー登録（カスタムバリデーション付き）"""
    return {
        "message": "ユーザー登録が完了しました",
        "user": {"name": user.name, "email": user.email}
    }</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>新規リソース作成時に返すべき適切なHTTPステータスコードは？</strong>
                                <details><summary>解答</summary><p>201 Created</p></details>
                            </li>
                            <li>
                                <strong>FastAPIでカスタム例外ハンドラーを定義するデコレータは？</strong>
                                <details><summary>解答</summary><p>@app.exception_handler(ExceptionClass)</p></details>
                            </li>
                            <li>
                                <strong>リクエストデータのバリデーションエラー時のステータスコードは？</strong>
                                <details><summary>解答</summary><p>422 Unprocessable Entity</p></details>
                            </li>
                        </ol>
                    </div>

                    <h3 class="section-title">4.5 まとめ</h3>
                    <div class="highlight">
                        <h6>この章で習得したスキル</h6>
                        <ul>
                            <li>適切なHTTPステータスコードの使い分け</li>
                            <li>統一されたエラーレスポンス形式の実装</li>
                            <li>カスタム例外ハンドラーによる一元的エラー処理</li>
                            <li>ユーザーフレンドリーなバリデーションエラーメッセージ</li>
                            <li>カスタムレスポンスクラスの活用</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="fastapi-learning-material-3.html" class="btn btn-secondary">← 前の章: Pydanticモデルとデータ検証</a>
                        <a href="fastapi-learning-material-5.html" class="btn btn-primary">次の章: 依存性注入とミドルウェア →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 F-Circle All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>