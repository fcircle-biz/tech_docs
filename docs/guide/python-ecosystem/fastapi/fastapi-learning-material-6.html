<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI学習教材 第6章 - データベース連携とORM</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #2e7d32; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #2e7d32; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #2e7d32; padding-bottom: 0.5rem; }
        .section-title { color: #4caf50; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container { background-color: #e8f5e8; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #2e7d32; }
        .exercise-container { background-color: #f3e5f5; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #9c27b0; }
        .highlight { background-color: #ffecb3; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #ffc107; }
        .code-block { background-color: #1e1e1e; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #2e7d32 !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid"><a class="navbar-brand"><strong>FastAPI学習教材</strong></a></div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-1.html">第1章: FastAPI入門と環境構築</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-2.html">第2章: ルーティングとリクエスト処理</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-3.html">第3章: Pydanticモデルとデータ検証</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-4.html">第4章: レスポンス処理と例外ハンドリング</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-5.html">第5章: 依存性注入とミドルウェア</a></li>
                        <li class="nav-item"><a class="nav-link active" href="fastapi-learning-material-6.html">第6章: データベース連携とORM</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-7.html">第7章: 認証とセキュリティ</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-8.html">第8章: 非同期処理とパフォーマンス最適化</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-9.html">第9章: テストとドキュメント</a></li>
                        <li class="nav-item"><a class="nav-link" href="fastapi-learning-material-10.html">第10章: デプロイメントと本番環境</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: データベース連携とORM</h1>
                </div>

                <div id="chapter6">
                    <h2 class="chapter-title">永続化データの管理：SQLAlchemyとORMパターン</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>SQLAlchemyとORMの基本概念</li>
                            <li>データベースモデルの定義と関係性設計</li>
                            <li>CRUD操作の実装とトランザクション管理</li>
                            <li>マイグレーションとスキーマ管理</li>
                            <li>パフォーマンス最適化とクエリ改善</li>
                        </ul>
                    </div>

                    <h3 class="section-title">6.1 SQLAlchemyのセットアップ</h3>
                    <p>SQLAlchemyは、Pythonでもっとも人気のあるORMライブラリです。FastAPIとの連携により、型安全で効率的なデータベース操作が可能になります。</p>

                    <div class="mermaid">
                        graph TB
                            A["FastAPI Application"] --> B["SQLAlchemy ORM"]
                            B --> C["Database Models"]
                            C --> D["PostgreSQL/MySQL/SQLite"]
                            B --> E["Session Management"]
                            E --> F["Transaction Control"]
                            
                            G["Pydantic Models"] --> H["Data Validation"]
                            H --> B
                            B --> I["Query Results"]
                            I --> G
                    </div>

                    <div class="exercise-container">
                        <h5>実習 6-1: SQLAlchemyのセットアップとモデル定義</h5>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python"># database.py
from sqlalchemy import create_engine, Column, Integer, String, Boolean, DateTime, ForeignKey, Text
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, Session, relationship
from datetime import datetime
import os

# データベースURL設定
DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///./test.db")

# SQLAlchemyエンジン作成
engine = create_engine(
    DATABASE_URL,
    connect_args={"check_same_thread": False} if "sqlite" in DATABASE_URL else {}
)

# セッションファクトリー
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# ベースクラス
Base = declarative_base()

# データベースモデル定義
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, index=True, nullable=False)
    email = Column(String(100), unique=True, index=True, nullable=False)
    full_name = Column(String(100), nullable=False)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # リレーション
    posts = relationship("Post", back_populates="author", cascade="all, delete-orphan")
    comments = relationship("Comment", back_populates="user", cascade="all, delete-orphan")

class Post(Base):
    __tablename__ = "posts"
    
    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(200), nullable=False, index=True)
    content = Column(Text, nullable=False)
    is_published = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # 外部キー
    author_id = Column(Integer, ForeignKey("users.id"))
    
    # リレーション
    author = relationship("User", back_populates="posts")
    comments = relationship("Comment", back_populates="post", cascade="all, delete-orphan")

class Comment(Base):
    __tablename__ = "comments"
    
    id = Column(Integer, primary_key=True, index=True)
    content = Column(Text, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # 外部キー
    user_id = Column(Integer, ForeignKey("users.id"))
    post_id = Column(Integer, ForeignKey("posts.id"))
    
    # リレーション
    user = relationship("User", back_populates="comments")
    post = relationship("Post", back_populates="comments")

# データベース初期化
def init_db():
    """データベーステーブル作成"""
    Base.metadata.create_all(bind=engine)

def get_db():
    """データベースセッション取得"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()</code></pre>
                    </div>

                    <h3 class="section-title">6.2 CRUD操作の実装</h3>
                    <p>Create（作成）、Read（読取）、Update（更新）、Delete（削除）の基本操作を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-2: CRUD操作とAPIエンドポイント</h5>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python"># schemas.py
from pydantic import BaseModel, EmailStr
from typing import List, Optional
from datetime import datetime

class UserBase(BaseModel):
    username: str
    email: EmailStr
    full_name: str

class UserCreate(UserBase):
    pass

class UserUpdate(BaseModel):
    username: Optional[str] = None
    email: Optional[EmailStr] = None
    full_name: Optional[str] = None
    is_active: Optional[bool] = None

class User(UserBase):
    id: int
    is_active: bool
    created_at: datetime
    updated_at: datetime
    
    class Config:
        orm_mode = True

class PostBase(BaseModel):
    title: str
    content: str
    is_published: bool = False

class PostCreate(PostBase):
    pass

class Post(PostBase):
    id: int
    author_id: int
    created_at: datetime
    updated_at: datetime
    
    class Config:
        orm_mode = True

# crud.py
from sqlalchemy.orm import Session
from sqlalchemy import and_, or_
from . import models, schemas
from typing import List, Optional

class UserCRUD:
    def create_user(self, db: Session, user: schemas.UserCreate) -> models.User:
        """ユーザー作成"""
        db_user = models.User(**user.dict())
        db.add(db_user)
        db.commit()
        db.refresh(db_user)
        return db_user
    
    def get_user(self, db: Session, user_id: int) -> Optional[models.User]:
        """ユーザー取得（ID指定）"""
        return db.query(models.User).filter(models.User.id == user_id).first()
    
    def get_user_by_email(self, db: Session, email: str) -> Optional[models.User]:
        """ユーザー取得（メール指定）"""
        return db.query(models.User).filter(models.User.email == email).first()
    
    def get_users(
        self, 
        db: Session, 
        skip: int = 0, 
        limit: int = 100,
        active_only: bool = True
    ) -> List[models.User]:
        """ユーザー一覧取得"""
        query = db.query(models.User)
        
        if active_only:
            query = query.filter(models.User.is_active == True)
        
        return query.offset(skip).limit(limit).all()
    
    def update_user(
        self, 
        db: Session, 
        user_id: int, 
        user_update: schemas.UserUpdate
    ) -> Optional[models.User]:
        """ユーザー更新"""
        db_user = self.get_user(db, user_id)
        if not db_user:
            return None
        
        update_data = user_update.dict(exclude_unset=True)
        for field, value in update_data.items():
            setattr(db_user, field, value)
        
        db.commit()
        db.refresh(db_user)
        return db_user
    
    def delete_user(self, db: Session, user_id: int) -> bool:
        """ユーザー削除"""
        db_user = self.get_user(db, user_id)
        if not db_user:
            return False
        
        db.delete(db_user)
        db.commit()
        return True

class PostCRUD:
    def create_post(
        self, 
        db: Session, 
        post: schemas.PostCreate, 
        author_id: int
    ) -> models.Post:
        """投稿作成"""
        db_post = models.Post(**post.dict(), author_id=author_id)
        db.add(db_post)
        db.commit()
        db.refresh(db_post)
        return db_post
    
    def get_posts_by_user(
        self, 
        db: Session, 
        user_id: int, 
        published_only: bool = True
    ) -> List[models.Post]:
        """ユーザーの投稿一覧取得"""
        query = db.query(models.Post).filter(models.Post.author_id == user_id)
        
        if published_only:
            query = query.filter(models.Post.is_published == True)
        
        return query.order_by(models.Post.created_at.desc()).all()

# インスタンス作成
user_crud = UserCRUD()
post_crud = PostCRUD()

# main.py（APIエンドポイント）
from fastapi import FastAPI, Depends, HTTPException, status
from sqlalchemy.orm import Session
from . import models, schemas, crud
from .database import get_db, init_db

app = FastAPI()

# データベース初期化
init_db()

@app.post("/users/", response_model=schemas.User, status_code=status.HTTP_201_CREATED)
def create_user(user: schemas.UserCreate, db: Session = Depends(get_db)):
    """ユーザー作成"""
    # 重複チェック
    if crud.user_crud.get_user_by_email(db, user.email):
        raise HTTPException(
            status_code=400, 
            detail="このメールアドレスは既に登録されています"
        )
    
    return crud.user_crud.create_user(db=db, user=user)

@app.get("/users/{user_id}", response_model=schemas.User)
def read_user(user_id: int, db: Session = Depends(get_db)):
    """ユーザー詳細取得"""
    db_user = crud.user_crud.get_user(db, user_id=user_id)
    if db_user is None:
        raise HTTPException(status_code=404, detail="ユーザーが見つかりません")
    return db_user

@app.get("/users/", response_model=List[schemas.User])
def read_users(
    skip: int = 0, 
    limit: int = 100, 
    active_only: bool = True,
    db: Session = Depends(get_db)
):
    """ユーザー一覧取得"""
    users = crud.user_crud.get_users(db, skip=skip, limit=limit, active_only=active_only)
    return users

@app.put("/users/{user_id}", response_model=schemas.User)
def update_user(
    user_id: int, 
    user_update: schemas.UserUpdate, 
    db: Session = Depends(get_db)
):
    """ユーザー更新"""
    db_user = crud.user_crud.update_user(db, user_id, user_update)
    if db_user is None:
        raise HTTPException(status_code=404, detail="ユーザーが見つかりません")
    return db_user

@app.delete("/users/{user_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_user(user_id: int, db: Session = Depends(get_db)):
    """ユーザー削除"""
    if not crud.user_crud.delete_user(db, user_id):
        raise HTTPException(status_code=404, detail="ユーザーが見つかりません")
    return</code></pre>
                    </div>

                    <h3 class="section-title">6.3 トランザクション管理</h3>
                    <p>データの整合性を保つため、適切なトランザクション管理が重要です。</p>

                    <div class="exercise-container">
                        <h5>実習 6-3: トランザクション管理の実装</h5>
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python">from sqlalchemy.orm import Session
from contextlib import contextmanager
from typing import Generator
import logging

logger = logging.getLogger(__name__)

@contextmanager
def db_transaction(db: Session) -> Generator[Session, None, None]:
    """データベーストランザクション管理"""
    try:
        yield db
        db.commit()
    except Exception as e:
        logger.error(f"Transaction failed: {e}")
        db.rollback()
        raise
    finally:
        db.close()

class BlogService:
    """ブログ関連の複合操作"""
    
    def create_user_with_welcome_post(
        self, 
        db: Session, 
        user_data: schemas.UserCreate
    ) -> models.User:
        """ユーザー作成と同時にウェルカム投稿作成"""
        
        with db_transaction(db):
            # ユーザー作成
            db_user = models.User(**user_data.dict())
            db.add(db_user)
            db.flush()  # IDを取得するため
            
            # ウェルカム投稿作成
            welcome_post = models.Post(
                title=f"{user_data.full_name}さん、ようこそ！",
                content="新規ユーザー登録ありがとうございます。",
                is_published=True,
                author_id=db_user.id
            )
            db.add(welcome_post)
            
            return db_user
    
    def transfer_posts(
        self, 
        db: Session, 
        from_user_id: int, 
        to_user_id: int
    ) -> bool:
        """投稿の所有者変更（一括）"""
        
        with db_transaction(db):
            # ユーザー存在確認
            from_user = crud.user_crud.get_user(db, from_user_id)
            to_user = crud.user_crud.get_user(db, to_user_id)
            
            if not from_user or not to_user:
                raise HTTPException(404, "ユーザーが見つかりません")
            
            # 投稿の所有者変更
            posts_updated = db.query(models.Post).filter(
                models.Post.author_id == from_user_id
            ).update({"author_id": to_user_id})
            
            logger.info(f"Transferred {posts_updated} posts from user {from_user_id} to {to_user_id}")
            
            return posts_updated > 0

blog_service = BlogService()

# API エンドポイント
@app.post("/users/with-welcome-post", response_model=schemas.User)
def create_user_with_welcome(
    user: schemas.UserCreate, 
    db: Session = Depends(get_db)
):
    """ユーザー作成（ウェルカム投稿付き）"""
    try:
        return blog_service.create_user_with_welcome_post(db, user)
    except Exception as e:
        raise HTTPException(500, f"ユーザー作成に失敗しました: {str(e)}")

@app.post("/admin/transfer-posts")
def transfer_user_posts(
    from_user_id: int, 
    to_user_id: int, 
    db: Session = Depends(get_db)
):
    """投稿の所有者変更（管理者機能）"""
    try:
        success = blog_service.transfer_posts(db, from_user_id, to_user_id)
        if success:
            return {"message": "投稿の移行が完了しました"}
        else:
            return {"message": "移行対象の投稿がありませんでした"}
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(500, f"投稿移行に失敗しました: {str(e)}")</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>SQLAlchemyでモデルのベースクラスとして使用するものは？</strong>
                                <details><summary>解答</summary><p>declarative_base()で作成したBase</p></details>
                            </li>
                            <li>
                                <strong>Pydanticモデルでormmodeを有効にする設定は？</strong>
                                <details><summary>解答</summary><p>class Config: orm_mode = True</p></details>
                            </li>
                            <li>
                                <strong>SQLAlchemyでテーブル間のリレーションを定義する関数は？</strong>
                                <details><summary>解答</summary><p>relationship()</p></details>
                            </li>
                        </ol>
                    </div>

                    <h3 class="section-title">6.4 まとめ</h3>
                    <div class="highlight">
                        <h6>この章で習得したスキル</h6>
                        <ul>
                            <li>SQLAlchemyによるORM設計とモデル定義</li>
                            <li>効率的なCRUD操作の実装</li>
                            <li>データベースリレーションの管理</li>
                            <li>トランザクション管理と例外処理</li>
                            <li>PydanticとSQLAlchemyの連携</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="fastapi-learning-material-5.html" class="btn btn-secondary">← 前の章: 依存性注入とミドルウェア</a>
                        <a href="fastapi-learning-material-7.html" class="btn btn-primary">次の章: 認証とセキュリティ →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 F-Circle All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'default' });</script>
</body>
</html>