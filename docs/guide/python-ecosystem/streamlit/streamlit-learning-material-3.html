<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit学習教材 第3章 - データ表示と可視化</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #4caf50;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        /* タイトル */
        .chapter-title {
            color: #4caf50;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #4caf50;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #66bb6a;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #4caf50;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info-box {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #2196F3;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #4caf50 !important;
            color: white !important;
        }

        .nav-link {
            color: #666;
        }

        .nav-link:hover {
            background-color: #e8f5e8;
            color: #4caf50;
        }

        pre {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }

        code {
            background-color: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Streamlit学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="../README.md">学習ガイドに戻る</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        章の一覧
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-1.html">第1章: 入門と環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-2.html">第2章: 基本的なUIコンポーネント</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter3">第3章: データ表示と可視化</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-4.html">第4章: ユーザー入力とインタラクション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-5.html">第5章: セッション状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-6.html">第6章: ファイル操作とデータ処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-7.html">第7章: マルチページアプリケーション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-8.html">第8章: データベース連携とAPI統合</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-9.html">第9章: デプロイメントと本番環境</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-10.html">第10章: 実践的なデータ分析アプリ開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第3章: データ表示と可視化</h1>
                </div>

                <div id="chapter3">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">データを魅力的に表示する</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>DataFrameとテーブルの効果的な表示方法</li>
                            <li>Streamlit内蔵のグラフコンポーネントの活用</li>
                            <li>Plotly・Matplotlibとの連携によるカスタムグラフ作成</li>
                            <li>メトリクスとKPIの視覚的表示</li>
                            <li>プログレスバーとスピナーの実装</li>
                        </ul>
                    </div>

                    <!-- セクション1: DataFrame表示 -->
                    <h3 class="section-title">3.1 DataFrameとテーブルの表示</h3>
                    <p>Streamlitはpandasと密接に連携し、DataFrameを美しく表示するための機能を提供します。</p>
                    
                    <h4>DataFrame表示コンポーネント</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>コンポーネント</th>
                                <th>特徴</th>
                                <th>用途</th>
                                <th>例</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>st.dataframe()</code></td>
                                <td>インタラクティブ</td>
                                <td>大きなデータセット</td>
                                <td>ソート・フィルタ可能</td>
                            </tr>
                            <tr>
                                <td><code>st.table()</code></td>
                                <td>静的表示</td>
                                <td>小さなデータセット</td>
                                <td>レポート形式</td>
                            </tr>
                            <tr>
                                <td><code>st.data_editor()</code></td>
                                <td>編集可能</td>
                                <td>データ入力・編集</td>
                                <td>フォーム代替</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="exercise-container">
                        <h5>実習 3-1: DataFrame表示の基本</h5>
                        <p>様々な方法でDataFrameを表示し、その違いを確認します。</p>
                        
                        <h6>dataframe_demo.py を作成</h6>
                        <pre><code>import streamlit as st
import pandas as pd
import numpy as np

# ページ設定
st.set_page_config(
    page_title="DataFrame表示デモ",
    page_icon="📊",
    layout="wide"
)

st.title("📊 DataFrame表示の比較")

# サンプルデータの作成
@st.cache_data
def load_sample_data():
    np.random.seed(42)
    data = {
        '商品名': ['商品A', '商品B', '商品C', '商品D', '商品E'],
        '売上': np.random.randint(1000, 10000, 5),
        '利益率': np.random.uniform(0.1, 0.3, 5).round(3),
        '在庫': np.random.randint(10, 100, 5),
        '評価': np.random.uniform(3.5, 5.0, 5).round(1)
    }
    return pd.DataFrame(data)

df = load_sample_data()

# データの概要
st.header("📋 サンプルデータ")
st.write("5つの商品の売上データです。")

# 表示方法の比較
col1, col2 = st.columns(2)

with col1:
    st.subheader("st.dataframe() - インタラクティブ")
    st.write("ソート・検索・列幅変更が可能")
    st.dataframe(
        df,
        use_container_width=True,
        hide_index=True
    )

with col2:
    st.subheader("st.table() - 静的表示")
    st.write("シンプルな静的テーブル")
    st.table(df)

# データエディタ
st.divider()
st.subheader("st.data_editor() - 編集可能")
st.write("セル値を直接編集できます（変更は一時的）")

edited_df = st.data_editor(
    df,
    use_container_width=True,
    hide_index=True,
    num_rows="dynamic"  # 行の追加・削除を許可
)

# 変更の確認
if not df.equals(edited_df):
    st.success("データが変更されました！")
    st.write("変更後のデータ:")
    st.dataframe(edited_df, use_container_width=True)

# カスタムフォーマット
st.divider()
st.subheader("カスタムフォーマット")

# 列のフォーマットを指定
formatted_df = df.copy()
formatted_df['売上'] = formatted_df['売上'].apply(lambda x: f"¥{x:,}")
formatted_df['利益率'] = formatted_df['利益率'].apply(lambda x: f"{x:.1%}")

st.dataframe(
    formatted_df,
    use_container_width=True,
    hide_index=True,
    column_config={
        "評価": st.column_config.ProgressColumn(
            "評価",
            help="商品の評価（5点満点）",
            min_value=0,
            max_value=5,
        ),
        "在庫": st.column_config.NumberColumn(
            "在庫数",
            help="現在の在庫数",
            format="%d 個",
        )
    }
)
</code></pre>
                        
                        <h6>実行と確認</h6>
                        <pre><code>streamlit run dataframe_demo.py</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>異なるDataFrame表示方法と、データエディタの編集機能が確認できます。</p>
                    </div>

                    <!-- セクション2: 基本グラフ -->
                    <h3 class="section-title">3.2 Streamlit内蔵グラフコンポーネント</h3>
                    <p>Streamlitには、簡単にグラフを作成できる内蔵コンポーネントが用意されています。</p>

                    <h4>内蔵グラフコンポーネント</h4>
                    <div class="info-box">
                        <h6>主要なグラフタイプ</h6>
                        <ul>
                            <li><strong>st.line_chart()</strong>: 線グラフ（時系列データ）</li>
                            <li><strong>st.area_chart()</strong>: 面グラフ（累積データ）</li>
                            <li><strong>st.bar_chart()</strong>: 棒グラフ（カテゴリ比較）</li>
                            <li><strong>st.scatter_chart()</strong>: 散布図（相関関係）</li>
                            <li><strong>st.map()</strong>: 地図上にポイント表示</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 3-2: 内蔵グラフの作成</h5>
                        <p>Streamlitの内蔵グラフコンポーネントを使用して、様々なグラフを作成します。</p>
                        
                        <h6>builtin_charts.py を作成</h6>
                        <pre><code>import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

# ページ設定
st.set_page_config(
    page_title="内蔵グラフデモ",
    page_icon="📈",
    layout="wide"
)

st.title("📈 Streamlit内蔵グラフデモ")

# サンプルデータの生成
@st.cache_data
def generate_chart_data():
    # 時系列データ
    dates = pd.date_range(start='2024-01-01', end='2024-12-31', freq='D')
    time_series = pd.DataFrame({
        'date': dates,
        '売上': np.random.randint(1000, 5000, len(dates)) + 
                np.sin(np.arange(len(dates)) * 2 * np.pi / 365) * 500,
        '利益': np.random.randint(200, 1000, len(dates)) + 
                np.sin(np.arange(len(dates)) * 2 * np.pi / 365) * 100
    }).set_index('date')
    
    # カテゴリデータ
    categories = pd.DataFrame({
        'カテゴリ': ['電子機器', '衣類', '食品', '書籍', 'スポーツ'],
        '売上': [15000, 12000, 8000, 5000, 7000]
    }).set_index('カテゴリ')
    
    # 散布図データ
    scatter_data = pd.DataFrame({
        '広告費': np.random.randint(100, 1000, 50),
        '売上': np.random.randint(1000, 10000, 50)
    })
    # 相関関係を追加
    scatter_data['売上'] += scatter_data['広告費'] * 2 + np.random.normal(0, 500, 50)
    
    # 地図データ（東京周辺）
    map_data = pd.DataFrame({
        'lat': [35.6762 + np.random.normal(0, 0.01, 10)],
        'lon': [139.6503 + np.random.normal(0, 0.01, 10)]
    })
    
    return time_series, categories, scatter_data, map_data

time_series, categories, scatter_data, map_data = generate_chart_data()

# レイアウト
tab1, tab2, tab3, tab4 = st.tabs(["📊 時系列", "📊 カテゴリ", "🔗 相関", "🗺️ 地図"])

with tab1:
    st.subheader("時系列グラフ")
    
    # 線グラフ
    st.write("**線グラフ（st.line_chart）**")
    st.line_chart(time_series)
    
    # 面グラフ
    st.write("**面グラフ（st.area_chart）**")
    st.area_chart(time_series)
    
    # 期間選択
    col1, col2 = st.columns(2)
    with col1:
        start_date = st.date_input("開始日", datetime(2024, 1, 1))
    with col2:
        end_date = st.date_input("終了日", datetime(2024, 3, 31))
    
    # フィルタリングされたデータ
    filtered_data = time_series[start_date:end_date]
    st.write("**期間フィルタ適用後**")
    st.line_chart(filtered_data)

with tab2:
    st.subheader("カテゴリ別データ")
    
    # 棒グラフ
    st.write("**棒グラフ（st.bar_chart）**")
    st.bar_chart(categories)
    
    # データテーブル
    st.write("**データテーブル**")
    st.dataframe(categories, use_container_width=True)

with tab3:
    st.subheader("散布図")
    
    # 散布図
    st.write("**散布図（st.scatter_chart）**")
    st.scatter_chart(
        scatter_data,
        x='広告費',
        y='売上',
        size=20
    )
    
    # 相関係数の計算
    correlation = scatter_data['広告費'].corr(scatter_data['売上'])
    st.metric("相関係数", f"{correlation:.3f}")

with tab4:
    st.subheader("地図表示")
    
    # 地図
    st.write("**地図（st.map）**")
    st.map(map_data)
    
    # 地図データ
    st.write("**座標データ**")
    st.dataframe(map_data)

# グラフ作成のポイント
st.divider()
st.subheader("📝 内蔵グラフのポイント")

col1, col2 = st.columns(2)

with col1:
    st.markdown("""
    **メリット**
    - 簡単な記述でグラフ作成
    - pandasとの親和性が高い
    - レスポンシブデザイン
    - 基本的なインタラクティブ機能
    """)

with col2:
    st.markdown("""
    **制約**
    - カスタマイズ性が限定的
    - デザインの細かい調整不可
    - 複雑なグラフは作成困難
    - アニメーション機能なし
    """)
</code></pre>
                        
                        <h6>実行と確認</h6>
                        <pre><code>streamlit run builtin_charts.py</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>4つのタブで異なるタイプのグラフと、期間フィルタリング機能が確認できます。</p>
                    </div>

                    <!-- セクション3: カスタムグラフ -->
                    <h3 class="section-title">3.3 PlotlyとMatplotlibの連携</h3>
                    <p>より高度なカスタマイズやアニメーションが必要な場合は、外部ライブラリと連携します。</p>

                    <div class="info-box">
                        <h6>外部ライブラリの特徴</h6>
                        <ul>
                            <li><strong>Plotly</strong>: インタラクティブ、美しいデザイン、アニメーション対応</li>
                            <li><strong>Matplotlib</strong>: 高度なカスタマイズ、学術的なグラフ</li>
                            <li><strong>Seaborn</strong>: 統計的可視化、美しいデフォルトスタイル</li>
                            <li><strong>Altair</strong>: 宣言的な文法、簡潔なコード</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 3-3: カスタムグラフの作成</h5>
                        <p>PlotlyとMatplotlibを使用して、カスタマイズされたグラフを作成します。</p>
                        
                        <h6>必要なライブラリのインストール</h6>
                        <pre><code>pip install plotly matplotlib seaborn</code></pre>
                        
                        <h6>custom_charts.py を作成</h6>
                        <pre><code>import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
import matplotlib.pyplot as plt
import seaborn as sns

# ページ設定
st.set_page_config(
    page_title="カスタムグラフデモ",
    page_icon="🎨",
    layout="wide"
)

st.title("🎨 カスタムグラフデモ")

# サンプルデータ
@st.cache_data
def load_data():
    # 売上データ
    np.random.seed(42)
    dates = pd.date_range('2024-01-01', '2024-12-31', freq='M')
    sales_data = pd.DataFrame({
        'date': dates,
        '東京': np.random.randint(1000, 5000, len(dates)),
        '大阪': np.random.randint(800, 4000, len(dates)),
        '名古屋': np.random.randint(600, 3000, len(dates))
    })
    
    # 散布図データ
    scatter_data = pd.DataFrame({
        'x': np.random.randn(100),
        'y': np.random.randn(100),
        'size': np.random.randint(10, 100, 100),
        'color': np.random.choice(['A', 'B', 'C'], 100)
    })
    
    return sales_data, scatter_data

sales_data, scatter_data = load_data()

# タブで整理
tab1, tab2, tab3 = st.tabs(["📊 Plotly", "📈 Matplotlib", "🎯 複合グラフ"])

with tab1:
    st.subheader("Plotlyによるインタラクティブグラフ")
    
    # 線グラフ
    fig_line = px.line(
        sales_data.melt(id_vars='date', var_name='都市', value_name='売上'),
        x='date', y='売上', color='都市',
        title="月別売上推移（インタラクティブ）"
    )
    fig_line.update_layout(
        xaxis_title="月",
        yaxis_title="売上 (万円)",
        hovermode='x unified'
    )
    st.plotly_chart(fig_line, use_container_width=True)
    
    # バブルチャート
    fig_bubble = px.scatter(
        scatter_data, x='x', y='y', size='size', color='color',
        title="バブルチャート",
        size_max=30
    )
    st.plotly_chart(fig_bubble, use_container_width=True)
    
    # 3Dプロット
    fig_3d = go.Figure(data=[go.Scatter3d(
        x=scatter_data['x'],
        y=scatter_data['y'],
        z=scatter_data['size'],
        mode='markers',
        marker=dict(
            size=scatter_data['size']/5,
            color=scatter_data['size'],
            colorscale='Viridis',
            opacity=0.8
        )
    )])
    fig_3d.update_layout(title="3Dプロット", scene=dict(
        xaxis_title='X軸',
        yaxis_title='Y軸',
        zaxis_title='Z軸'
    ))
    st.plotly_chart(fig_3d, use_container_width=True)

with tab2:
    st.subheader("Matplotlibによる統計グラフ")
    
    # スタイル選択
    style = st.selectbox(
        "Matplotlibスタイルを選択",
        ['default', 'seaborn-v0_8', 'ggplot', 'classic']
    )
    
    # ヒストグラム
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 5))
    
    # スタイル適用
    plt.style.use(style)
    
    # ヒストグラム
    ax1.hist(scatter_data['x'], bins=20, alpha=0.7, color='skyblue', edgecolor='black')
    ax1.set_title('データ分布（ヒストグラム）')
    ax1.set_xlabel('値')
    ax1.set_ylabel('頻度')
    ax1.grid(True, alpha=0.3)
    
    # ボックスプロット
    cities_data = [sales_data['東京'], sales_data['大阪'], sales_data['名古屋']]
    ax2.boxplot(cities_data, labels=['東京', '大阪', '名古屋'])
    ax2.set_title('都市別売上分布（ボックスプロット）')
    ax2.set_ylabel('売上 (万円)')
    ax2.grid(True, alpha=0.3)
    
    plt.tight_layout()
    st.pyplot(fig)
    
    # Seabornによる相関行列
    fig_corr, ax_corr = plt.subplots(figsize=(8, 6))
    correlation_matrix = sales_data[['東京', '大阪', '名古屋']].corr()
    sns.heatmap(correlation_matrix, annot=True, cmap='coolwarm', center=0, ax=ax_corr)
    ax_corr.set_title('都市間売上の相関関係')
    st.pyplot(fig_corr)

with tab3:
    st.subheader("複合グラフとダッシュボード")
    
    # メトリクス表示
    col1, col2, col3 = st.columns(3)
    
    with col1:
        total_tokyo = sales_data['東京'].sum()
        avg_tokyo = sales_data['東京'].mean()
        st.metric(
            label="東京 総売上",
            value=f"¥{total_tokyo:,}万",
            delta=f"平均 ¥{avg_tokyo:.0f}万"
        )
    
    with col2:
        total_osaka = sales_data['大阪'].sum()
        avg_osaka = sales_data['大阪'].mean()
        st.metric(
            label="大阪 総売上",
            value=f"¥{total_osaka:,}万",
            delta=f"平均 ¥{avg_osaka:.0f}万"
        )
    
    with col3:
        total_nagoya = sales_data['名古屋'].sum()
        avg_nagoya = sales_data['名古屋'].mean()
        st.metric(
            label="名古屋 総売上",
            value=f"¥{total_nagoya:,}万",
            delta=f"平均 ¥{avg_nagoya:.0f}万"
        )
    
    # 動的フィルタリング
    st.subheader("📅 期間フィルタ")
    selected_months = st.slider(
        "表示する月を選択",
        min_value=1,
        max_value=12,
        value=(1, 12),
        format="月"
    )
    
    # フィルタ適用
    filtered_sales = sales_data[
        (sales_data['date'].dt.month >= selected_months[0]) &
        (sales_data['date'].dt.month <= selected_months[1])
    ]
    
    # フィルタ後のグラフ
    fig_filtered = px.bar(
        filtered_sales.melt(id_vars='date', var_name='都市', value_name='売上'),
        x='date', y='売上', color='都市',
        title=f"{selected_months[0]}月〜{selected_months[1]}月の売上"
    )
    st.plotly_chart(fig_filtered, use_container_width=True)

# グラフライブラリの比較
st.divider()
st.subheader("📊 グラフライブラリの使い分け")

comparison_data = {
    'ライブラリ': ['Streamlit内蔵', 'Plotly', 'Matplotlib', 'Seaborn'],
    '学習コスト': ['低', '中', '高', '中'],
    'インタラクティブ': ['△', '◎', '×', '△'],
    'カスタマイズ性': ['△', '◎', '◎', '○'],
    '美しさ': ['○', '◎', '△', '◎'],
    '適用場面': ['プロトタイプ', 'ダッシュボード', '学術論文', '統計分析']
}

st.table(pd.DataFrame(comparison_data))
</code></pre>
                        
                        <h6>実行と確認</h6>
                        <pre><code>streamlit run custom_charts.py</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>Plotly、Matplotlib、複合グラフの各タブで高度なカスタマイズグラフが表示されます。</p>
                    </div>

                    <!-- セクション4: メトリクスとKPI -->
                    <h3 class="section-title">3.4 メトリクスとKPIの表示</h3>
                    <p>ビジネスダッシュボードでは、重要な指標を分かりやすく表示することが重要です。</p>

                    <div class="exercise-container">
                        <h5>実習 3-4: KPIダッシュボード</h5>
                        <p>メトリクス、プログレスバー、ゲージチャートを組み合わせたKPIダッシュボードを作成します。</p>
                        
                        <h6>kpi_dashboard.py を作成</h6>
                        <pre><code>import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import time

# ページ設定
st.set_page_config(
    page_title="KPIダッシュボード",
    page_icon="📊",
    layout="wide"
)

st.title("📊 KPIダッシュボード")

# サンプルデータ生成
@st.cache_data
def generate_kpi_data():
    current_month = {
        'sales': 150000,
        'target': 200000,
        'customers': 1250,
        'conversion': 0.125,
        'satisfaction': 4.2
    }
    
    previous_month = {
        'sales': 140000,
        'target': 180000,
        'customers': 1100,
        'conversion': 0.110,
        'satisfaction': 4.0
    }
    
    return current_month, previous_month

current, previous = generate_kpi_data()

# ヘッダー情報
st.markdown("### 📅 2024年3月 月次レポート")
st.markdown("---")

# KPIメトリクス
col1, col2, col3, col4 = st.columns(4)

with col1:
    sales_delta = current['sales'] - previous['sales']
    sales_delta_pct = (sales_delta / previous['sales']) * 100
    st.metric(
        label="💰 売上",
        value=f"¥{current['sales']:,}",
        delta=f"{sales_delta_pct:+.1f}%"
    )

with col2:
    customer_delta = current['customers'] - previous['customers']
    customer_delta_pct = (customer_delta / previous['customers']) * 100
    st.metric(
        label="👥 顧客数",
        value=f"{current['customers']:,}人",
        delta=f"{customer_delta_pct:+.1f}%"
    )

with col3:
    conv_delta = current['conversion'] - previous['conversion']
    conv_delta_pct = (conv_delta / previous['conversion']) * 100
    st.metric(
        label="📈 コンバージョン率",
        value=f"{current['conversion']:.1%}",
        delta=f"{conv_delta_pct:+.1f}%"
    )

with col4:
    sat_delta = current['satisfaction'] - previous['satisfaction']
    st.metric(
        label="⭐ 顧客満足度",
        value=f"{current['satisfaction']:.1f}/5.0",
        delta=f"{sat_delta:+.1f}"
    )

# プログレスと達成率
st.markdown("### 📊 目標達成状況")

col1, col2 = st.columns(2)

with col1:
    # 売上目標の進捗
    progress = current['sales'] / current['target']
    st.write("**売上目標達成率**")
    st.progress(progress)
    st.write(f"{progress:.1%} 達成 ({current['sales']:,} / {current['target']:,})")
    
    if progress >= 1.0:
        st.success("🎉 目標達成！")
    elif progress >= 0.8:
        st.warning("⚠️ もう少しで達成")
    else:
        st.error("🔥 努力が必要")

with col2:
    # 満足度ゲージ
    fig_gauge = go.Figure(go.Indicator(
        mode = "gauge+number+delta",
        value = current['satisfaction'],
        domain = {'x': [0, 1], 'y': [0, 1]},
        title = {'text': "顧客満足度"},
        delta = {'reference': previous['satisfaction']},
        gauge = {
            'axis': {'range': [None, 5]},
            'bar': {'color': "darkblue"},
            'steps': [
                {'range': [0, 2], 'color': "lightgray"},
                {'range': [2, 3], 'color': "gray"},
                {'range': [3, 4], 'color': "lightgreen"},
                {'range': [4, 5], 'color': "green"}
            ],
            'threshold': {
                'line': {'color': "red", 'width': 4},
                'thickness': 0.75,
                'value': 4.5
            }
        }
    ))
    fig_gauge.update_layout(height=300)
    st.plotly_chart(fig_gauge, use_container_width=True)

# 詳細分析
st.markdown("### 📈 詳細分析")

tab1, tab2, tab3 = st.tabs(["📊 トレンド", "🎯 目標分析", "📋 詳細データ"])

with tab1:
    # 月次トレンド（サンプルデータ）
    months = ['1月', '2月', '3月']
    sales_trend = [120000, 140000, 150000]
    target_trend = [150000, 180000, 200000]
    
    trend_df = pd.DataFrame({
        '月': months,
        '実績': sales_trend,
        '目標': target_trend
    })
    
    st.write("**月次売上トレンド**")
    st.line_chart(trend_df.set_index('月'))

with tab2:
    # 目標分析
    st.write("**目標達成要因分析**")
    
    factors = ['新規顧客', '既存顧客', 'アップセル', 'クロスセル']
    contributions = [30, 45, 15, 10]
    
    fig_pie = go.Figure(data=[go.Pie(
        labels=factors,
        values=contributions,
        hole=.3
    )])
    fig_pie.update_layout(title="売上貢献要因")
    st.plotly_chart(fig_pie, use_container_width=True)

with tab3:
    # 詳細データ
    st.write("**月次比較表**")
    
    comparison_df = pd.DataFrame({
        '指標': ['売上', '顧客数', 'コンバージョン率', '満足度'],
        '今月': [f"¥{current['sales']:,}", f"{current['customers']:,}人", 
                f"{current['conversion']:.1%}", f"{current['satisfaction']:.1f}"],
        '前月': [f"¥{previous['sales']:,}", f"{previous['customers']:,}人", 
                f"{previous['conversion']:.1%}", f"{previous['satisfaction']:.1f}"],
        '変化': [f"{((current['sales']/previous['sales']-1)*100):+.1f}%",
                f"{((current['customers']/previous['customers']-1)*100):+.1f}%",
                f"{((current['conversion']/previous['conversion']-1)*100):+.1f}%",
                f"{(current['satisfaction']-previous['satisfaction']):+.1f}"]
    })
    
    st.dataframe(comparison_df, use_container_width=True, hide_index=True)

# リアルタイム更新デモ
st.markdown("### ⚡ リアルタイム更新")

if st.button("データを更新"):
    # プログレスバーとスピナー
    progress_bar = st.progress(0)
    status_text = st.empty()
    
    for i in range(100):
        progress_bar.progress(i + 1)
        status_text.text(f'更新中... {i+1}%')
        time.sleep(0.01)
    
    status_text.text('更新完了!')
    st.success("データが正常に更新されました。")
    st.balloons()  # お祝いアニメーション
</code></pre>
                        
                        <h6>実行と確認</h6>
                        <pre><code>streamlit run kpi_dashboard.py</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>KPIメトリクス、プログレスバー、ゲージチャート、リアルタイム更新機能を含む本格的なダッシュボードが表示されます。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>DataFrameの表示で、ユーザーがデータを編集できるコンポーネントはどれですか？</strong>
                                <ul style="list-style-type: none;">
                                    <li>a) st.dataframe()</li>
                                    <li>b) st.table()</li>
                                    <li>c) st.data_editor()</li>
                                    <li>d) st.write()</li>
                                </ul>
                                <details style="margin-top: 0.5rem;">
                                    <summary>解答を見る</summary>
                                    <p><strong>答え: c)</strong> st.data_editor() はユーザーがセル値を直接編集できます。</p>
                                </details>
                            </li>
                            
                            <li>
                                <strong>Streamlitで地図上にポイントを表示するコンポーネントは何ですか？</strong>
                                <ul style="list-style-type: none;">
                                    <li>a) st.map()</li>
                                    <li>b) st.geo()</li>
                                    <li>c) st.location()</li>
                                    <li>d) st.coordinates()</li>
                                </ul>
                                <details style="margin-top: 0.5rem;">
                                    <summary>解答を見る</summary>
                                    <p><strong>答え: a)</strong> st.map() で緯度・経度データから地図上にポイントを表示できます。</p>
                                </details>
                            </li>
                            
                            <li>
                                <strong>外部ライブラリ（Plotly、Matplotlib）を使う利点を3つ挙げてください</strong>
                                <details style="margin-top: 0.5rem;">
                                    <summary>解答を見る</summary>
                                    <p><strong>答え例:</strong><br>
                                    1. 高度なカスタマイズが可能<br>
                                    2. インタラクティブ機能が豊富<br>
                                    3. アニメーション対応<br>
                                    4. 複雑なグラフタイプに対応<br>
                                    5. 美しいデザイン</p>
                                </details>
                            </li>
                            
                            <li>
                                <strong>KPIダッシュボードで重要な要素を3つ答えてください</strong>
                                <details style="margin-top: 0.5rem;">
                                    <summary>解答を見る</summary>
                                    <p><strong>答え例:</strong><br>
                                    1. 分かりやすいメトリクス表示<br>
                                    2. 前期比較・変化率の表示<br>
                                    3. 目標達成状況の視覚化<br>
                                    4. 適切な色使いとアラート<br>
                                    5. リアルタイム更新機能</p>
                                </details>
                            </li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="streamlit-learning-material-2.html" class="btn btn-secondary">← 前の章: 基本的なUIコンポーネント</a>
                        <a href="streamlit-learning-material-4.html" class="btn btn-primary">次の章: ユーザー入力とインタラクション →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>