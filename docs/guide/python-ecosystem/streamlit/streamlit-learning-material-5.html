<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit学習教材 第5章 - セッション状態管理</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #4caf50;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        /* タイトル */
        .chapter-title {
            color: #4caf50;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #4caf50;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #66bb6a;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #4caf50;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .info-box {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #2196F3;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #4caf50 !important;
            color: white !important;
        }

        .nav-link {
            color: #666;
        }

        .nav-link:hover {
            background-color: #e8f5e8;
            color: #4caf50;
        }

        pre {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }

        code {
            background-color: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Streamlit学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="../README.md">学習ガイドに戻る</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        章の一覧
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-1.html">第1章: 入門と環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-2.html">第2章: 基本的なUIコンポーネント</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-3.html">第3章: データ表示と可視化</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-4.html">第4章: ユーザー入力とインタラクション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter5">第5章: セッション状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-6.html">第6章: ファイル操作とデータ処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-7.html">第7章: マルチページアプリケーション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-8.html">第8章: データベース連携とAPI統合</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-9.html">第9章: デプロイメントと本番環境</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="streamlit-learning-material-10.html">第10章: 実践的なデータ分析アプリ開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第5章: セッション状態管理</h1>
                </div>

                <div id="chapter5">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">st.session_stateで動的なアプリを構築する</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>st.session_stateの概念と基本的な使い方</li>
                            <li>ページ間でのデータ共有と状態の永続化</li>
                            <li>動的なUI更新とコールバック関数の実装</li>
                            <li>フォームとセッション状態の連携</li>
                            <li>複雑なアプリケーション状態の管理パターン</li>
                        </ul>
                    </div>

                    <!-- セクション1: st.session_state の基礎 -->
                    <h3 class="section-title">5.1 セッション状態とは</h3>
                    <p>Streamlitアプリは、ユーザーが何らかの操作を行うたびにスクリプト全体が再実行されます。st.session_stateを使用することで、この再実行間でデータを保持できます。</p>
                    
                    <div class="info-box">
                        <h6>セッション状態の特徴</h6>
                        <ul>
                            <li><strong>永続性</strong>: ページリロードまでデータが保持される</li>
                            <li><strong>ユーザー別</strong>: 各ユーザーセッションで独立したデータ</li>
                            <li><strong>辞書型</strong>: キーと値のペアでデータを管理</li>
                            <li><strong>型自由</strong>: 文字列、数値、リスト、オブジェクトなど任意の型を保存可能</li>
                        </ul>
                    </div>

                    <h4>基本的な使用方法</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>操作</th>
                                <th>コード例</th>
                                <th>説明</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>値の設定</td>
                                <td><code>st.session_state['key'] = value</code></td>
                                <td>キーに値を設定</td>
                            </tr>
                            <tr>
                                <td>値の取得</td>
                                <td><code>value = st.session_state['key']</code></td>
                                <td>キーから値を取得</td>
                            </tr>
                            <tr>
                                <td>存在確認</td>
                                <td><code>'key' in st.session_state</code></td>
                                <td>キーの存在確認</td>
                            </tr>
                            <tr>
                                <td>デフォルト値</td>
                                <td><code>st.session_state.get('key', default)</code></td>
                                <td>キーが存在しない場合のデフォルト値</td>
                            </tr>
                            <tr>
                                <td>削除</td>
                                <td><code>del st.session_state['key']</code></td>
                                <td>キーと値を削除</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="exercise-container">
                        <h5>実習 5-1: 基本的なセッション状態管理</h5>
                        <p>カウンターアプリを作成して、セッション状態の基本的な使い方を学習します。</p>
                        
                        <h6>session_basics.py を作成</h6>
                        <pre><code>import streamlit as st

# ページ設定
st.set_page_config(
    page_title="セッション状態デモ",
    page_icon="🔄",
    layout="wide"
)

st.title("🔄 セッション状態管理デモ")

# セッション状態の初期化
if 'counter' not in st.session_state:
    st.session_state.counter = 0

if 'name' not in st.session_state:
    st.session_state.name = ""

if 'history' not in st.session_state:
    st.session_state.history = []

# カウンター機能
st.subheader("📊 カウンター")

col1, col2, col3, col4 = st.columns(4)

with col1:
    if st.button("➕ +1"):
        st.session_state.counter += 1
        st.session_state.history.append(f"+1 (合計: {st.session_state.counter})")

with col2:
    if st.button("➖ -1"):
        st.session_state.counter -= 1
        st.session_state.history.append(f"-1 (合計: {st.session_state.counter})")

with col3:
    if st.button("🔄 リセット"):
        st.session_state.counter = 0
        st.session_state.history.append("リセット")

with col4:
    if st.button("➗ 半分"):
        st.session_state.counter = st.session_state.counter // 2
        st.session_state.history.append(f"半分 (合計: {st.session_state.counter})")

# 現在の値を表示
st.metric("現在のカウンター値", st.session_state.counter)

# 名前の設定
st.divider()
st.subheader("👤 ユーザー情報")

# コールバック関数
def update_name():
    st.session_state.name = st.session_state.name_input
    st.session_state.history.append(f"名前を'{st.session_state.name}'に変更")

name_input = st.text_input(
    "お名前を入力してください",
    value=st.session_state.name,
    key="name_input",
    on_change=update_name
)

if st.session_state.name:
    st.success(f"こんにちは、{st.session_state.name}さん！")
    st.write(f"あなたのカウンター値は **{st.session_state.counter}** です。")

# 履歴表示
st.divider()
st.subheader("📝 操作履歴")

if st.session_state.history:
    # 最新の10件を表示
    recent_history = st.session_state.history[-10:]
    for i, action in enumerate(reversed(recent_history)):
        st.write(f"{len(recent_history) - i}. {action}")
    
    if st.button("📝 履歴をクリア"):
        st.session_state.history = []
        st.success("履歴がクリアされました")
else:
    st.info("まだ操作履歴がありません")

# デバッグ情報
st.divider()
st.subheader("🔍 デバッグ情報")

with st.expander("セッション状態の内容を表示"):
    st.write("**現在のセッション状態:**")
    
    # セッション状態の全内容を表示
    for key, value in st.session_state.items():
        if key.startswith('_'):  # プライベートキーは除外
            continue
        
        if isinstance(value, list):
            st.write(f"- **{key}**: リスト (要素数: {len(value)})")
            if value:
                st.write(f"  最新: {value[-1] if value else 'なし'}")
        else:
            st.write(f"- **{key}**: {value} ({type(value).__name__})")

# セッション状態をクリアするボタン
if st.button("🗑️ 全データをクリア", type="secondary"):
    # 特定のキーのみクリア（システムキーは保持）
    keys_to_clear = ['counter', 'name', 'history', 'name_input']
    for key in keys_to_clear:
        if key in st.session_state:
            del st.session_state[key]
    st.rerun()
</code></pre>
                        
                        <h6>実行と確認</h6>
                        <pre><code>streamlit run session_basics.py</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>カウンター操作、名前入力、履歴表示が連動し、ページリロードしても状態が保持されることが確認できます。</p>
                    </div>

                    <!-- セクション2: 複雑な状態管理 -->
                    <h3 class="section-title">5.2 複雑なアプリケーション状態の管理</h3>
                    <p>大規模なアプリケーションでは、複数の状態を効率的に管理する必要があります。</p>

                    <div class="exercise-container">
                        <h5>実習 5-2: ショッピングカートアプリ</h5>
                        <p>セッション状態を活用したショッピングカート機能を実装し、複雑な状態管理を学習します。</p>
                        
                        <h6>shopping_cart.py を作成</h6>
                        <pre><code>import streamlit as st
import pandas as pd
from datetime import datetime

# ページ設定
st.set_page_config(
    page_title="ショッピングカート",
    page_icon="🛒",
    layout="wide"
)

# セッション状態の初期化
if 'cart' not in st.session_state:
    st.session_state.cart = {}

if 'purchase_history' not in st.session_state:
    st.session_state.purchase_history = []

if 'user_info' not in st.session_state:
    st.session_state.user_info = {
        'name': '',
        'email': '',
        'address': ''
    }

# 商品データ
PRODUCTS = {
    'laptop': {'name': 'ノートパソコン', 'price': 89800, 'stock': 5},
    'mouse': {'name': 'ワイヤレスマウス', 'price': 2980, 'stock': 15},
    'keyboard': {'name': 'メカニカルキーボード', 'price': 12800, 'stock': 8},
    'monitor': {'name': '4Kモニター', 'price': 45600, 'stock': 3},
    'headphones': {'name': 'ノイズキャンセリングヘッドホン', 'price': 25400, 'stock': 10}
}

# ヘルパー関数
def add_to_cart(product_id, quantity=1):
    """商品をカートに追加"""
    if product_id in st.session_state.cart:
        st.session_state.cart[product_id] += quantity
    else:
        st.session_state.cart[product_id] = quantity
    
    # 在庫チェック
    if st.session_state.cart[product_id] > PRODUCTS[product_id]['stock']:
        st.session_state.cart[product_id] = PRODUCTS[product_id]['stock']
        return False  # 在庫不足
    return True  # 成功

def remove_from_cart(product_id):
    """商品をカートから削除"""
    if product_id in st.session_state.cart:
        del st.session_state.cart[product_id]

def get_cart_total():
    """カート合計金額を計算"""
    total = 0
    for product_id, quantity in st.session_state.cart.items():
        total += PRODUCTS[product_id]['price'] * quantity
    return total

def get_cart_items_count():
    """カート内商品数を計算"""
    return sum(st.session_state.cart.values())

# メインアプリ
st.title("🛒 オンラインショップ")

# ヘッダー情報
col1, col2, col3 = st.columns([2, 1, 1])

with col1:
    if st.session_state.user_info['name']:
        st.write(f"👤 ようこそ、{st.session_state.user_info['name']}さん")
    else:
        st.write("👤 ゲストユーザー")

with col2:
    cart_count = get_cart_items_count()
    st.metric("🛒 カート", f"{cart_count}点")

with col3:
    cart_total = get_cart_total()
    st.metric("💰 合計", f"¥{cart_total:,}")

# タブで機能を分離
tab1, tab2, tab3, tab4 = st.tabs(["🛍️ 商品一覧", "🛒 カート", "👤 ユーザー情報", "📋 購入履歴"])

with tab1:
    st.subheader("商品一覧")
    
    # 商品表示
    cols = st.columns(2)
    
    for i, (product_id, product) in enumerate(PRODUCTS.items()):
        with cols[i % 2]:
            with st.container():
                st.write(f"**{product['name']}**")
                st.write(f"価格: ¥{product['price']:,}")
                st.write(f"在庫: {product['stock']}個")
                
                # カート内の数量表示
                cart_qty = st.session_state.cart.get(product_id, 0)
                if cart_qty > 0:
                    st.write(f"カート内: {cart_qty}個")
                
                col_qty, col_add = st.columns([1, 1])
                
                with col_qty:
                    quantity = st.number_input(
                        "数量",
                        min_value=1,
                        max_value=product['stock'],
                        value=1,
                        key=f"qty_{product_id}"
                    )
                
                with col_add:
                    if st.button(f"カートに追加", key=f"add_{product_id}"):
                        if add_to_cart(product_id, quantity):
                            st.success(f"{product['name']}を{quantity}個追加しました")
                        else:
                            st.warning("在庫不足のため、在庫数まで追加しました")
                
                st.divider()

with tab2:
    st.subheader("ショッピングカート")
    
    if not st.session_state.cart:
        st.info("カートは空です")
    else:
        # カート内容を表示
        cart_data = []
        
        for product_id, quantity in st.session_state.cart.items():
            product = PRODUCTS[product_id]
            subtotal = product['price'] * quantity
            cart_data.append({
                '商品名': product['name'],
                '単価': f"¥{product['price']:,}",
                '数量': quantity,
                '小計': f"¥{subtotal:,}"
            })
        
        df = pd.DataFrame(cart_data)
        st.dataframe(df, use_container_width=True, hide_index=True)
        
        # カート操作
        st.divider()
        col1, col2, col3 = st.columns(3)
        
        with col1:
            # 商品削除
            if st.session_state.cart:
                product_to_remove = st.selectbox(
                    "削除する商品",
                    options=["選択してください"] + [PRODUCTS[pid]['name'] for pid in st.session_state.cart.keys()]
                )
                
                if st.button("🗑️ 商品を削除"):
                    if product_to_remove != "選択してください":
                        # 商品名からIDを逆引き
                        product_id = next(pid for pid, p in PRODUCTS.items() if p['name'] == product_to_remove)
                        remove_from_cart(product_id)
                        st.success(f"{product_to_remove}を削除しました")
                        st.rerun()
        
        with col2:
            if st.button("🛒 カートを空にする"):
                st.session_state.cart = {}
                st.success("カートを空にしました")
                st.rerun()
        
        with col3:
            # 購入ボタン
            if st.button("💳 購入する", type="primary"):
                if st.session_state.user_info['name'] and st.session_state.user_info['email']:
                    # 購入処理
                    purchase_data = {
                        'date': datetime.now(),
                        'items': dict(st.session_state.cart),
                        'total': get_cart_total(),
                        'user_info': dict(st.session_state.user_info)
                    }
                    
                    st.session_state.purchase_history.append(purchase_data)
                    st.session_state.cart = {}
                    
                    st.success("購入が完了しました！")
                    st.balloons()
                else:
                    st.error("購入前にユーザー情報を入力してください")

with tab3:
    st.subheader("ユーザー情報")
    
    with st.form("user_info_form"):
        name = st.text_input(
            "お名前",
            value=st.session_state.user_info['name'],
            placeholder="田中太郎"
        )
        
        email = st.text_input(
            "メールアドレス",
            value=st.session_state.user_info['email'],
            placeholder="user@example.com"
        )
        
        address = st.text_area(
            "住所",
            value=st.session_state.user_info['address'],
            placeholder="〒123-4567 東京都...",
            height=100
        )
        
        if st.form_submit_button("💾 情報を保存"):
            st.session_state.user_info = {
                'name': name,
                'email': email,
                'address': address
            }
            st.success("ユーザー情報を保存しました")

with tab4:
    st.subheader("購入履歴")
    
    if not st.session_state.purchase_history:
        st.info("購入履歴がありません")
    else:
        for i, purchase in enumerate(reversed(st.session_state.purchase_history)):
            with st.expander(f"購入 #{len(st.session_state.purchase_history) - i} - {purchase['date'].strftime('%Y/%m/%d %H:%M')}"):
                st.write(f"**購入者**: {purchase['user_info']['name']}")
                st.write(f"**合計金額**: ¥{purchase['total']:,}")
                
                st.write("**購入商品**:")
                for product_id, quantity in purchase['items'].items():
                    product_name = PRODUCTS[product_id]['name']
                    price = PRODUCTS[product_id]['price']
                    st.write(f"- {product_name} × {quantity}個 (¥{price * quantity:,})")
        
        # 統計情報
        st.divider()
        st.subheader("📊 購入統計")
        
        total_purchases = len(st.session_state.purchase_history)
        total_spent = sum(p['total'] for p in st.session_state.purchase_history)
        avg_purchase = total_spent / total_purchases if total_purchases > 0 else 0
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("総購入回数", f"{total_purchases}回")
        
        with col2:
            st.metric("総支払額", f"¥{total_spent:,}")
        
        with col3:
            st.metric("平均購入額", f"¥{avg_purchase:,.0f}")
</code></pre>
                        
                        <h6>実行と確認</h6>
                        <pre><code>streamlit run shopping_cart.py</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>完全に機能するショッピングカートシステムが表示され、セッション状態による複雑なデータ管理が確認できます。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>セッション状態の特徴として正しくないものはどれですか？</strong>
                                <ul style="list-style-type: none;">
                                    <li>a) ページリロードまでデータが保持される</li>
                                    <li>b) 全ユーザーでデータが共有される</li>
                                    <li>c) 辞書型でデータを管理する</li>
                                    <li>d) 任意の型のデータを保存できる</li>
                                </ul>
                                <details style="margin-top: 0.5rem;">
                                    <summary>解答を見る</summary>
                                    <p><strong>答え: b)</strong> セッション状態は各ユーザーセッションで独立したデータを持ちます。</p>
                                </details>
                            </li>
                            
                            <li>
                                <strong>セッション状態でコールバック関数を使用する利点を説明してください</strong>
                                <details style="margin-top: 0.5rem;">
                                    <summary>解答を見る</summary>
                                    <p><strong>答え:</strong> 入力値の変更時に即座に処理を実行でき、ユーザーのアクションに応じてリアルタイムで状態を更新できます。また、ボタンクリックを待つ必要がなく、よりスムーズなユーザー体験を提供できます。</p>
                                </details>
                            </li>
                            
                            <li>
                                <strong>複雑なアプリケーションでセッション状態を効率的に管理するコツを3つ挙げてください</strong>
                                <details style="margin-top: 0.5rem;">
                                    <summary>解答を見る</summary>
                                    <p><strong>答え例:</strong><br>
                                    1. 関連するデータは辞書やオブジェクトにまとめる<br>
                                    2. 状態の初期化を関数化して再利用する<br>
                                    3. 状態変更のロジックをヘルパー関数に分離する<br>
                                    4. 不要になった状態は削除してメモリを節約する</p>
                                </details>
                            </li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="streamlit-learning-material-4.html" class="btn btn-secondary">← 前の章: ユーザー入力とインタラクション</a>
                        <a href="streamlit-learning-material-6.html" class="btn btn-primary">次の章: ファイル操作とデータ処理 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>