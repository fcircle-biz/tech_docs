<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django学習教材 第7章 - Django REST Framework入門</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #2e7d32;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        /* タイトル */
        .chapter-title {
            color: #2e7d32;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d32;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #388e3c;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d32;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #2e7d32 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>Django学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-1.html">
                                第1章: Django入門と環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-2.html">
                                第2章: モデルとデータベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-3.html">
                                第3章: ビューとURLルーティング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-4.html">
                                第4章: テンプレートとフロントエンド統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-5.html">
                                第5章: フォームとユーザー入力処理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-6.html">
                                第6章: 認証とユーザー管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="django-learning-material-7.html">
                                第7章: Django REST Framework入門
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-8.html">
                                第8章: テストとデバッグ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-9.html">
                                第9章: デプロイメントと本番環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-10.html">
                                第10章: 高度な機能と最適化
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: Django REST Framework入門</h1>
                </div>

                <div id="chapter7">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">RESTful APIの構築とモダンWeb開発</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>RESTful API設計の原則と重要性</li>
                            <li>Django REST Frameworkの基本概念と構造</li>
                            <li>シリアライザーによるデータの相互変換</li>
                            <li>ViewSetとRouterを使用したAPI構築</li>
                            <li>認証とパーミッションによるAPI保護</li>
                            <li>ペジネーションとフィルタリングの実装</li>
                        </ul>
                    </div>

                    <!-- セクション1: REST APIの基礎 -->
                    <h3 class="section-title">7.1 RESTful API設計の原則</h3>
                    
                    <p>REST（Representational State Transfer）は、Webアプリケーション間でデータをやり取りするための設計原則です。現代のWebアプリケーションでは、フロントエンド（React、Vue.js等）とバックエンド（Django）を分離し、API経由でデータ通信を行う構成が主流となっています。</p>

                    <h4>RESTの基本原則</h4>
                    <ul>
                        <li><strong>クライアント・サーバー分離</strong>：UIの関心事とデータストレージの関心事を分離</li>
                        <li><strong>ステートレス</strong>：サーバーはクライアントの状態を保持しない</li>
                        <li><strong>統一インターフェース</strong>：一貫したURIとHTTPメソッドの使用</li>
                        <li><strong>階層化システム</strong>：システムを階層で構成し、コンポーネント間の相互作用を制限</li>
                        <li><strong>キャッシュ可能</strong>：レスポンスはキャッシュ可能または不可能を明示</li>
                    </ul>

                    <h4>HTTP メソッドとCRUD操作の対応</h4>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead class="table-success">
                                <tr>
                                    <th>HTTPメソッド</th>
                                    <th>CRUD操作</th>
                                    <th>URL例</th>
                                    <th>説明</th>
                                    <th>冪等性</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>GET</strong></td>
                                    <td>Read（読み取り）</td>
                                    <td>
                                        <code>/api/articles/</code><br>
                                        <code>/api/articles/1/</code>
                                    </td>
                                    <td>
                                        リソースの一覧取得<br>
                                        特定リソースの詳細取得
                                    </td>
                                    <td>✓</td>
                                </tr>
                                <tr>
                                    <td><strong>POST</strong></td>
                                    <td>Create（作成）</td>
                                    <td><code>/api/articles/</code></td>
                                    <td>新しいリソースの作成</td>
                                    <td>✗</td>
                                </tr>
                                <tr>
                                    <td><strong>PUT</strong></td>
                                    <td>Update（完全更新）</td>
                                    <td><code>/api/articles/1/</code></td>
                                    <td>リソース全体の置き換え</td>
                                    <td>✓</td>
                                </tr>
                                <tr>
                                    <td><strong>PATCH</strong></td>
                                    <td>Update（部分更新）</td>
                                    <td><code>/api/articles/1/</code></td>
                                    <td>リソースの一部フィールドのみ更新</td>
                                    <td>✗</td>
                                </tr>
                                <tr>
                                    <td><strong>DELETE</strong></td>
                                    <td>Delete（削除）</td>
                                    <td><code>/api/articles/1/</code></td>
                                    <td>指定したリソースの削除</td>
                                    <td>✓</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h5>HTTPメソッドの特徴</h5>
                            <ul>
                                <li><strong>GET</strong>: 安全（サーバー状態を変更しない）で冪等</li>
                                <li><strong>POST</strong>: 非冪等（実行の度に新しいリソースが作成される可能性）</li>
                                <li><strong>PUT</strong>: 冪等（同じ結果を何度でも得られる）</li>
                                <li><strong>PATCH</strong>: 一般的に非冪等（実装依存）</li>
                                <li><strong>DELETE</strong>: 冪等（削除済みリソースの削除は影響なし）</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>RESTful URL設計のポイント</h5>
                            <ul>
                                <li><strong>リソース指向</strong>: 動詞ではなく名詞でリソースを表現</li>
                                <li><strong>階層構造</strong>: 関連性を/で表現（例: <code>/users/1/posts/</code>）</li>
                                <li><strong>複数形</strong>: コレクションは複数形で統一</li>
                                <li><strong>一意性</strong>: IDでの個別リソース識別</li>
                                <li><strong>予測可能</strong>: 規則性のあるURL構造</li>
                            </ul>
                        </div>
                    </div>

                    <h4>API設計のベストプラクティス</h4>
                    <pre class="code-block"><code class="language-python"># URL設計の例
# 良い例：リソース中心の設計
GET    /api/articles/          # 記事一覧取得
POST   /api/articles/          # 記事作成
GET    /api/articles/1/        # 記事詳細取得
PUT    /api/articles/1/        # 記事更新
DELETE /api/articles/1/        # 記事削除

# ネストされたリソース
GET    /api/articles/1/comments/     # 記事の コメント一覧
POST   /api/articles/1/comments/     # 記事にコメント作成

# フィルタリングと検索
GET    /api/articles/?category=tech&author=john
GET    /api/articles/?search=django&ordering=-created_at</code></pre>

                    <!-- セクション2: Django REST Frameworkの基本 -->
                    <h3 class="section-title">7.2 Django REST Frameworkの基本構造</h3>
                    
                    <p>Django REST Framework（DRF）は、DjangoでRESTful APIを構築するための強力なツールキットです。シリアライザー、ビューセット、ルーター等の抽象化レイヤーを提供し、迅速なAPI開発を支援します。</p>

                    <h4>DRFの主要コンポーネント</h4>
                    <div class="mermaid">
                        classDiagram
                            class Serializer {
                                +fields: dict
                                +validate()
                                +create()
                                +update()
                                +to_representation()
                                +to_internal_value()
                            }
                            
                            class ViewSet {
                                +queryset: QuerySet
                                +serializer_class: Serializer
                                +permission_classes: list
                                +list()
                                +create()
                                +retrieve()
                                +update()
                                +destroy()
                            }
                            
                            class Router {
                                +register()
                                +get_urls()
                            }
                            
                            class Permission {
                                +has_permission()
                                +has_object_permission()
                            }
                            
                            class Authentication {
                                +authenticate()
                                +authenticate_header()
                            }
                            
                            ViewSet --> Serializer : uses
                            ViewSet --> Permission : enforces
                            ViewSet --> Authentication : uses
                            Router --> ViewSet : routes_to
                    </div>

                    <pre class="code-block"><code class="language-python"># インストールと設定
# pip install djangorestframework

# settings.py
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',  # Django REST Framework を追加
    'your_app',
]

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.SessionAuthentication',
        'rest_framework.authentication.TokenAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_FILTER_BACKENDS': [
        'rest_framework.filters.SearchFilter',
        'rest_framework.filters.OrderingFilter',
    ],
}</code></pre>

                    <!-- セクション3: シリアライザー -->
                    <h3 class="section-title">7.3 シリアライザーによるデータ変換</h3>
                    
                    <p>シリアライザーは、PythonオブジェクトとJSONデータ間の相互変換を行う重要なコンポーネントです。データの検証、整形、変換を統一的に処理します。</p>

                    <pre class="code-block"><code class="language-python"># models.py
from django.db import models
from django.contrib.auth.models import User

class Category(models.Model):
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

class Article(models.Model):
    title = models.CharField(max_length=200)
    content = models.TextField()
    author = models.ForeignKey(User, on_delete=models.CASCADE, related_name='articles')
    category = models.ForeignKey(Category, on_delete=models.CASCADE, related_name='articles')
    tags = models.ManyToManyField('Tag', blank=True)
    is_published = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

class Tag(models.Model):
    name = models.CharField(max_length=50, unique=True)
    color = models.CharField(max_length=7, default='#007bff')  # HEX color

class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.CASCADE, related_name='comments')
    author = models.ForeignKey(User, on_delete=models.CASCADE)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)

# serializers.py
from rest_framework import serializers
from .models import Article, Category, Tag, Comment

class TagSerializer(serializers.ModelSerializer):
    """タグシリアライザー"""
    class Meta:
        model = Tag
        fields = ['id', 'name', 'color']

class CategorySerializer(serializers.ModelSerializer):
    """カテゴリシリアライザー"""
    articles_count = serializers.SerializerMethodField()
    
    class Meta:
        model = Category
        fields = ['id', 'name', 'description', 'articles_count', 'created_at']
        read_only_fields = ['created_at']
    
    def get_articles_count(self, obj):
        """カテゴリに属する記事数を取得"""
        return obj.articles.filter(is_published=True).count()

class CommentSerializer(serializers.ModelSerializer):
    """コメントシリアライザー"""
    author_name = serializers.CharField(source='author.username', read_only=True)
    
    class Meta:
        model = Comment
        fields = ['id', 'content', 'author', 'author_name', 'created_at']
        read_only_fields = ['author', 'created_at']

class ArticleSerializer(serializers.ModelSerializer):
    """記事シリアライザー"""
    author_name = serializers.CharField(source='author.username', read_only=True)
    category_name = serializers.CharField(source='category.name', read_only=True)
    tags = TagSerializer(many=True, read_only=True)
    comments = CommentSerializer(many=True, read_only=True)
    comments_count = serializers.SerializerMethodField()
    read_time = serializers.SerializerMethodField()
    
    class Meta:
        model = Article
        fields = [
            'id', 'title', 'content', 'author', 'author_name',
            'category', 'category_name', 'tags', 'is_published',
            'comments', 'comments_count', 'read_time',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['author', 'created_at', 'updated_at']
    
    def get_comments_count(self, obj):
        """コメント数を取得"""
        return obj.comments.count()
    
    def get_read_time(self, obj):
        """読了時間を計算（分）"""
        word_count = len(obj.content.split())
        return max(1, word_count // 200)  # 1分あたり200語と仮定
    
    def validate_title(self, value):
        """タイトルのカスタムバリデーション"""
        if len(value) < 5:
            raise serializers.ValidationError("タイトルは5文字以上で入力してください。")
        return value
    
    def create(self, validated_data):
        """記事作成時の処理"""
        # リクエストユーザーを author として設定
        validated_data['author'] = self.context['request'].user
        return super().create(validated_data)</code></pre>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 7-1: 基本的なAPIエンドポイントの作成</h5>
                        <p>この実習では、記事管理システムのRESTful APIを構築し、基本的なCRUD操作を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>Django REST Frameworkをインストール・設定する</li>
                            <li>Article、Category、Tagモデルを作成する</li>
                            <li>対応するシリアライザーを実装する</li>
                            <li>基本的なAPIビューを作成する</li>
                            <li>URLルーティングを設定する</li>
                        </ol>

                        <h6>ビューの実装例</h6>
                        <pre class="code-block"><code class="language-python"># views.py
from rest_framework import generics, status
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticatedOrReadOnly
from django.db.models import Q
from .models import Article, Category, Tag
from .serializers import ArticleSerializer, CategorySerializer, TagSerializer

class ArticleListCreateView(generics.ListCreateAPIView):
    """記事一覧取得・作成API"""
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_queryset(self):
        queryset = Article.objects.select_related('author', 'category').prefetch_related('tags', 'comments')
        
        # 検索機能
        search = self.request.query_params.get('search')
        if search:
            queryset = queryset.filter(
                Q(title__icontains=search) | Q(content__icontains=search)
            )
        
        # カテゴリフィルター
        category = self.request.query_params.get('category')
        if category:
            queryset = queryset.filter(category__name=category)
        
        # 公開済みのみフィルター
        if not self.request.user.is_authenticated:
            queryset = queryset.filter(is_published=True)
        
        return queryset.order_by('-created_at')

class ArticleDetailView(generics.RetrieveUpdateDestroyAPIView):
    """記事詳細取得・更新・削除API"""
    queryset = Article.objects.select_related('author', 'category').prefetch_related('tags', 'comments')
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    
    def get_permissions(self):
        """権限を動的に設定"""
        if self.request.method in ['PUT', 'PATCH', 'DELETE']:
            # 更新・削除は作成者のみ許可
            return [IsAuthenticatedOrReadOnly()]
        return super().get_permissions()</code></pre>

                        <h6>期待される結果</h6>
                        <p>APIエンドポイントが正常に動作し、JSON形式でデータの取得・作成・更新・削除ができることを確認してください。</p>
                    </div>

                    <!-- セクション4: ViewSetとRouter -->
                    <h3 class="section-title">7.4 ViewSetとRouterによる効率的なAPI構築</h3>
                    
                    <p>ViewSetは、関連するビューロジックを一つのクラスにまとめ、Routerは標準的なURLパターンを自動生成します。この組み合わせにより、少ないコードでRESTful APIを構築できます。</p>

                    <pre class="code-block"><code class="language-python"># views.py
from rest_framework import viewsets, filters, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated, IsAuthenticatedOrReadOnly
from django_filters.rest_framework import DjangoFilterBackend
from .models import Article, Category, Tag
from .serializers import ArticleSerializer, CategorySerializer, TagSerializer
from .permissions import IsAuthorOrReadOnly

class CategoryViewSet(viewsets.ModelViewSet):
    """カテゴリViewSet"""
    queryset = Category.objects.all()
    serializer_class = CategorySerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    filter_backends = [filters.SearchFilter, filters.OrderingFilter]
    search_fields = ['name', 'description']
    ordering_fields = ['name', 'created_at']
    ordering = ['name']

class TagViewSet(viewsets.ModelViewSet):
    """タグViewSet"""
    queryset = Tag.objects.all()
    serializer_class = TagSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]
    filter_backends = [filters.SearchFilter]
    search_fields = ['name']

class ArticleViewSet(viewsets.ModelViewSet):
    """記事ViewSet"""
    serializer_class = ArticleSerializer
    permission_classes = [IsAuthenticatedOrReadOnly, IsAuthorOrReadOnly]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['category', 'is_published', 'tags']
    search_fields = ['title', 'content']
    ordering_fields = ['created_at', 'updated_at', 'title']
    ordering = ['-created_at']
    
    def get_queryset(self):
        return Article.objects.select_related('author', 'category').prefetch_related('tags', 'comments')
    
    @action(detail=True, methods=['post'], permission_classes=[IsAuthenticated])
    def toggle_publish(self, request, pk=None):
        """記事の公開状態を切り替え"""
        article = self.get_object()
        
        # 作成者のみ実行可能
        if article.author != request.user:
            return Response(
                {'error': '権限がありません。'}, 
                status=status.HTTP_403_FORBIDDEN
            )
        
        article.is_published = not article.is_published
        article.save()
        
        return Response({
            'message': f'記事を{"公開" if article.is_published else "非公開"}に設定しました。',
            'is_published': article.is_published
        })
    
    @action(detail=False, methods=['get'])
    def my_articles(self, request):
        """自分の記事一覧"""
        if not request.user.is_authenticated:
            return Response(
                {'error': 'ログインが必要です。'}, 
                status=status.HTTP_401_UNAUTHORIZED
            )
        
        articles = self.get_queryset().filter(author=request.user)
        serializer = self.get_serializer(articles, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def published(self, request):
        """公開記事のみ取得"""
        articles = self.get_queryset().filter(is_published=True)
        serializer = self.get_serializer(articles, many=True)
        return Response(serializer.data)

# permissions.py
from rest_framework import permissions

class IsAuthorOrReadOnly(permissions.BasePermission):
    """作成者のみ編集可能、他は読み取り専用"""
    
    def has_object_permission(self, request, view, obj):
        # 読み取り権限は全員に許可
        if request.method in permissions.SAFE_METHODS:
            return True
        
        # 書き込み権限は作成者のみ
        return obj.author == request.user

# urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

# Routerの設定
router = DefaultRouter()
router.register(r'categories', views.CategoryViewSet)
router.register(r'tags', views.TagViewSet)
router.register(r'articles', views.ArticleViewSet)

urlpatterns = [
    path('api/v1/', include(router.urls)),
    path('api-auth/', include('rest_framework.urls')),  # ブラウザブルAPI用
]</code></pre>

                    <!-- セクション5: 認証とパーミッション -->
                    <h3 class="section-title">7.5 API認証とパーミッション</h3>
                    
                    <p>API には適切な認証とパーミッション制御が不可欠です。DRFでは、複数の認証方式とパーミッションクラスを提供し、セキュアなAPIを構築できます。</p>

                    <h4>認証方式の比較</h4>
                    <div class="mermaid">
                        graph TD
                            A[API認証方式] --> B[SessionAuthentication]
                            A --> C[TokenAuthentication]
                            A --> D[JWTAuthentication]
                            A --> E[BasicAuthentication]
                            
                            B --> B1[Django標準セッション<br/>Webアプリケーションとの統合]
                            C --> C1[トークンベース<br/>モバイルアプリ・SPA向け]
                            D --> D1[JWT（JSON Web Token）<br/>ステートレス・スケーラブル]
                            E --> E1[Basic認証<br/>開発・テスト環境]
                    </div>

                    <pre class="code-block"><code class="language-python"># Token認証の設定
# settings.py
INSTALLED_APPS = [
    # ...
    'rest_framework',
    'rest_framework.authtoken',  # Token認証用
]

# トークン作成用シグナル
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.contrib.auth.models import User
from rest_framework.authtoken.models import Token

@receiver(post_save, sender=User)
def create_auth_token(sender, instance=None, created=False, **kwargs):
    if created:
        Token.objects.create(user=instance)

# JWT認証の設定（django-rest-framework-simplejwt使用）
# pip install djangorestframework-simplejwt

# settings.py
from datetime import timedelta

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=60),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': True,
    
    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,
    
    'AUTH_HEADER_TYPES': ('Bearer',),
    'AUTH_HEADER_NAME': 'HTTP_AUTHORIZATION',
    'USER_ID_FIELD': 'id',
    'USER_ID_CLAIM': 'user_id',
}

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
        'rest_framework.authentication.SessionAuthentication',
    ],
}

# JWT認証ビュー
from rest_framework_simplejwt.views import (
    TokenObtainPairView,
    TokenRefreshView,
)

urlpatterns = [
    path('api/token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
]</code></pre>

                    <!-- セクション6: フィルタリングとペジネーション -->
                    <h3 class="section-title">7.6 高度なフィルタリングとペジネーション</h3>
                    
                    <p>大量のデータを効率的に処理するため、適切なフィルタリング、検索、ペジネーション機能の実装が重要です。</p>

                    <pre class="code-block"><code class="language-python"># カスタムペジネーションクラス
from rest_framework.pagination import PageNumberPagination
from rest_framework.response import Response

class CustomPageNumberPagination(PageNumberPagination):
    page_size = 10
    page_size_query_param = 'page_size'
    max_page_size = 100
    
    def get_paginated_response(self, data):
        return Response({
            'pagination': {
                'page': self.page.number,
                'pages': self.page.paginator.num_pages,
                'per_page': self.page.paginator.per_page,
                'total': self.page.paginator.count,
                'next': self.get_next_link(),
                'previous': self.get_previous_link(),
            },
            'results': data
        })

# カスタムフィルターセット
import django_filters
from django_filters import rest_framework as filters

class ArticleFilter(filters.FilterSet):
    # 日付範囲フィルター
    created_after = filters.DateFilter(field_name='created_at', lookup_expr='gte')
    created_before = filters.DateFilter(field_name='created_at', lookup_expr='lte')
    
    # 複数選択フィルター
    category = filters.ModelMultipleChoiceFilter(
        queryset=Category.objects.all(),
        to_field_name='name'
    )
    
    # カスタム検索フィルター
    title_contains = filters.CharFilter(field_name='title', lookup_expr='icontains')
    author_name = filters.CharFilter(field_name='author__username', lookup_expr='icontains')
    
    # 数値範囲フィルター
    min_comments = filters.NumberFilter(method='filter_min_comments')
    
    class Meta:
        model = Article
        fields = {
            'is_published': ['exact'],
            'created_at': ['exact', 'year', 'month', 'day'],
        }
    
    def filter_min_comments(self, queryset, name, value):
        return queryset.annotate(
            comments_count=models.Count('comments')
        ).filter(comments_count__gte=value)</code></pre>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 7-2: 完全なAPIシステムの構築</h5>
                        <p>この実習では、認証、パーミッション、フィルタリング機能を含む完全なREST APIシステムを構築します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>JWT認証システムを実装する</li>
                            <li>カスタムパーミッションクラスを作成する</li>
                            <li>高度なフィルタリング機能を実装する</li>
                            <li>カスタムペジネーションを設定する</li>
                            <li>API ドキュメントを自動生成する</li>
                        </ol>

                        <h6>API ドキュメント生成</h6>
                        <pre class="code-block"><code class="language-python"># API ドキュメント自動生成（drf-spectacular使用）
# pip install drf-spectacular

# settings.py
INSTALLED_APPS = [
    # ...
    'drf_spectacular',
]

REST_FRAMEWORK = {
    # ...
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
}

SPECTACULAR_SETTINGS = {
    'TITLE': 'Blog API',
    'DESCRIPTION': 'ブログシステムのREST API',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
}

# urls.py
from drf_spectacular.views import SpectacularAPIView, SpectacularSwaggerView

urlpatterns = [
    path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
    path('api/docs/', SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui'),
]</code></pre>

                        <h6>期待される結果</h6>
                        <p>完全なAPIシステムが動作し、認証、フィルタリング、ペジネーション機能が正常に動作することを確認してください。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>RESTful API設計の5つの基本原則を説明してください。</li>
                            <li>Django REST Frameworkにおけるシリアライザーの役割と主要なメソッドを挙げてください。</li>
                            <li>ViewSetと通常のAPIViewの違いとそれぞれの適用場面を説明してください。</li>
                            <li>API認証における Token認証とJWT認証の違いを比較してください。</li>
                            <li>大量データを扱うAPIで考慮すべきパフォーマンス最適化手法を3つ挙げてください。</li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="django-learning-material-6.html" class="btn btn-secondary">← 前の章</a>
                        <a href="django-learning-material-8.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>