<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django学習教材 第6章 - 認証とユーザー管理</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #2e7d32;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        /* タイトル */
        .chapter-title {
            color: #2e7d32;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d32;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #388e3c;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d32;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #2e7d32 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>Django学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-1.html">
                                第1章: Django入門と環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-2.html">
                                第2章: モデルとデータベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-3.html">
                                第3章: ビューとURLルーティング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-4.html">
                                第4章: テンプレートとフロントエンド統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-5.html">
                                第5章: フォームとユーザー入力処理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="django-learning-material-6.html">
                                第6章: 認証とユーザー管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-7.html">
                                第7章: Django REST Framework入門
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-8.html">
                                第8章: テストとデバッグ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-9.html">
                                第9章: デプロイメントと本番環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-10.html">
                                第10章: 高度な機能と最適化
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: 認証とユーザー管理</h1>
                </div>

                <div id="chapter6">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">Django認証システムによるセキュアなユーザー管理</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Django認証システムの基本構造と仕組み</li>
                            <li>ユーザーモデルのカスタマイズ方法</li>
                            <li>ログイン・ログアウト・ユーザー登録機能の実装</li>
                            <li>パーミッションとグループによるアクセス制御</li>
                            <li>デコレータやミックスインによる認証機能</li>
                            <li>パスワードリセット機能の実装</li>
                        </ul>
                    </div>

                    <!-- セクション1: Django認証システムの基礎 -->
                    <h3 class="section-title">6.1 Django認証システムの基礎</h3>
                    
                    <p>Django認証システムは、Webアプリケーションにおけるユーザー管理の核心的な機能を提供します。ユーザーの識別、認証、認可を統合的に処理し、セキュリティを確保しながら使いやすいAPIを提供しています。</p>

                    <h4>認証システムの構成要素</h4>
                    <div class="mermaid">
                        classDiagram
                            class User {
                                +username: CharField
                                +first_name: CharField
                                +last_name: CharField
                                +email: EmailField
                                +password: CharField
                                +is_active: BooleanField
                                +is_staff: BooleanField
                                +is_superuser: BooleanField
                                +date_joined: DateTimeField
                                +last_login: DateTimeField
                                +check_password()
                                +set_password()
                                +has_perm()
                            }
                            
                            class Permission {
                                +name: CharField
                                +content_type: ForeignKey
                                +codename: CharField
                            }
                            
                            class Group {
                                +name: CharField
                                +permissions: ManyToManyField
                            }
                            
                            class Session {
                                +session_key: CharField
                                +session_data: TextField
                                +expire_date: DateTimeField
                            }
                            
                            User ||--o{ Permission : has
                            User ||--o{ Group : belongs_to
                            Group ||--o{ Permission : contains
                            User ||--o{ Session : creates
                    </div>

                    <h4>認証プロセスの流れ</h4>
                    <p>Django認証システムは以下のステップで動作します：</p>
                    
                    <div class="mermaid">
                        sequenceDiagram
                            participant User as ユーザー
                            participant Browser as ブラウザ
                            participant Django as Djangoサーバー
                            participant DB as データベース
                            participant Session as セッション

                            User->>Browser: ログイン情報入力
                            Browser->>Django: ログインリクエスト
                            Django->>DB: ユーザー認証
                            DB->>Django: 認証結果
                            alt 認証成功
                                Django->>Session: セッション作成
                                Session->>Django: セッションID
                                Django->>Browser: セッションクッキー設定
                                Browser->>User: ログイン完了
                            else 認証失敗
                                Django->>Browser: エラーレスポンス
                                Browser->>User: ログイン失敗表示
                            end
                    </div>

                    <pre class="code-block"><code class="language-python"># Django認証システムの基本的な使用例
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.models import User
from django.shortcuts import render, redirect
from django.contrib import messages

def user_login(request):
    """ユーザーログイン処理"""
    if request.method == 'POST':
        username = request.POST['username']
        password = request.POST['password']
        
        # ユーザー認証
        user = authenticate(request, username=username, password=password)
        
        if user is not None:
            if user.is_active:
                # ログイン処理
                login(request, user)
                messages.success(request, 'ログインしました。')
                return redirect('dashboard')
            else:
                messages.error(request, 'アカウントが無効化されています。')
        else:
            messages.error(request, 'ユーザー名またはパスワードが正しくありません。')
    
    return render(request, 'auth/login.html')

def user_logout(request):
    """ユーザーログアウト処理"""
    logout(request)
    messages.info(request, 'ログアウトしました。')
    return redirect('home')</code></pre>

                    <!-- セクション2: ユーザーモデルのカスタマイズ -->
                    <h3 class="section-title">6.2 ユーザーモデルのカスタマイズ</h3>
                    
                    <p>Djangoの標準ユーザーモデルは多くの場合に十分ですが、アプリケーションの要件によってはカスタマイズが必要になります。ユーザーモデルをカスタマイズする方法は主に3つあります。</p>

                    <h4>カスタマイズ方法の比較</h4>
                    <div class="mermaid">
                        graph TD
                            A[ユーザーモデルカスタマイズの選択肢] --> B[プロキシモデル]
                            A --> C[OneToOneField拡張]
                            A --> D[AbstractUser継承]
                            A --> E[AbstractBaseUser継承]
                            
                            B --> B1[既存フィールドはそのまま<br/>メソッドや動作のみ変更]
                            C --> C1[既存Userモデル + 追加フィールド<br/>最も簡単で安全]
                            D --> D1[標準フィールド + カスタムフィールド<br/>比較的簡単]
                            E --> E2[完全カスタム<br/>最も柔軟だが複雑]
                    </div>

                    <h5>方法1: OneToOneFieldによる拡張（推奨）</h5>
                    <pre class="code-block"><code class="language-python"># models.py
from django.db import models
from django.contrib.auth.models import User
from django.db.models.signals import post_save
from django.dispatch import receiver

class UserProfile(models.Model):
    """ユーザープロファイル拡張モデル"""
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    phone_number = models.CharField(max_length=15, blank=True)
    birth_date = models.DateField(null=True, blank=True)
    avatar = models.ImageField(upload_to='avatars/', blank=True)
    bio = models.TextField(max_length=500, blank=True)
    website = models.URLField(blank=True)
    location = models.CharField(max_length=100, blank=True)
    
    # ソーシャルメディア情報
    twitter_handle = models.CharField(max_length=50, blank=True)
    github_username = models.CharField(max_length=39, blank=True)
    
    # プライバシー設定
    is_profile_public = models.BooleanField(default=True)
    email_notifications = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'ユーザープロフィール'
        verbose_name_plural = 'ユーザープロフィール一覧'
    
    def __str__(self):
        return f"{self.user.username}のプロフィール"
    
    def get_full_name(self):
        """フルネームを取得"""
        return f"{self.user.first_name} {self.user.last_name}".strip()
    
    def get_short_name(self):
        """短縮名を取得"""
        return self.user.first_name or self.user.username

# ユーザー作成時にプロフィールを自動作成
@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    if created:
        UserProfile.objects.create(user=instance)

@receiver(post_save, sender=User)
def save_user_profile(sender, instance, **kwargs):
    instance.userprofile.save()</code></pre>

                    <h5>方法2: AbstractUserによるカスタマイズ</h5>
                    <pre class="code-block"><code class="language-python"># models.py - 新規プロジェクトの場合に推奨
from django.contrib.auth.models import AbstractUser
from django.db import models

class CustomUser(AbstractUser):
    """カスタムユーザーモデル"""
    email = models.EmailField('メールアドレス', unique=True)  # emailを必須でユニークに
    phone_number = models.CharField('電話番号', max_length=15, blank=True)
    birth_date = models.DateField('生年月日', null=True, blank=True)
    avatar = models.ImageField('アバター', upload_to='avatars/', blank=True)
    bio = models.TextField('自己紹介', max_length=500, blank=True)
    
    # 認証にemailを使用
    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = ['username']  # createsuperuser時に要求される追加フィールド
    
    class Meta:
        verbose_name = 'ユーザー'
        verbose_name_plural = 'ユーザー一覧'
    
    def get_short_name(self):
        return self.first_name or self.username

# settings.py
AUTH_USER_MODEL = 'myapp.CustomUser'  # カスタムユーザーモデルを指定</code></pre>

                    <!-- セクション3: 認証ビューの実装 -->
                    <h3 class="section-title">6.3 認証関連ビューの実装</h3>
                    
                    <p>Django認証システムでは、ログイン・ログアウト・ユーザー登録などの基本的な認証機能を簡単に実装できます。クラスベースビューと関数ベースビューの両方でアプローチが可能です。</p>

                    <pre class="code-block"><code class="language-python"># views.py
from django.shortcuts import render, redirect
from django.contrib.auth import login, authenticate
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth.decorators import login_required
from django.contrib.auth.views import LoginView, LogoutView
from django.contrib import messages
from django.urls import reverse_lazy
from .forms import CustomUserCreationForm, UserProfileForm

# 関数ベースビューでの実装
def signup(request):
    """ユーザー登録"""
    if request.method == 'POST':
        form = CustomUserCreationForm(request.POST)
        if form.is_valid():
            user = form.save()
            username = form.cleaned_data.get('username')
            messages.success(request, f'アカウント {username} が作成されました。')
            
            # 自動ログイン
            user = authenticate(username=username, password=form.cleaned_data['password1'])
            login(request, user)
            return redirect('profile')
    else:
        form = CustomUserCreationForm()
    return render(request, 'registration/signup.html', {'form': form})

@login_required
def profile(request):
    """プロフィール表示・編集"""
    if request.method == 'POST':
        form = UserProfileForm(request.POST, request.FILES, instance=request.user.userprofile)
        if form.is_valid():
            form.save()
            messages.success(request, 'プロフィールを更新しました。')
            return redirect('profile')
    else:
        form = UserProfileForm(instance=request.user.userprofile)
    
    return render(request, 'registration/profile.html', {'form': form})

# クラスベースビューでの実装
class CustomLoginView(LoginView):
    """カスタムログインビュー"""
    template_name = 'registration/login.html'
    redirect_authenticated_user = True
    
    def get_success_url(self):
        return reverse_lazy('dashboard')
    
    def form_valid(self, form):
        messages.success(self.request, 'ログインしました。')
        return super().form_valid(form)

class CustomLogoutView(LogoutView):
    """カスタムログアウトビュー"""
    next_page = reverse_lazy('home')
    
    def dispatch(self, request, *args, **kwargs):
        messages.info(request, 'ログアウトしました。')
        return super().dispatch(request, *args, **kwargs)</code></pre>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 6-1: ユーザー登録とプロフィール管理システムの構築</h5>
                        <p>この実習では、完全なユーザー登録・ログイン・プロフィール管理機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>UserProfileモデルを作成してユーザー情報を拡張する</li>
                            <li>カスタムユーザー登録フォームを作成する</li>
                            <li>ログイン・ログアウト・登録のビューを実装する</li>
                            <li>プロフィール表示・編集機能を作成する</li>
                            <li>適切なテンプレートを作成する</li>
                        </ol>

                        <h6>フォームの実装例</h6>
                        <pre class="code-block"><code class="language-python"># forms.py
from django import forms
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth.models import User
from .models import UserProfile

class CustomUserCreationForm(UserCreationForm):
    """カスタムユーザー登録フォーム"""
    email = forms.EmailField(
        required=True,
        help_text='有効なメールアドレスを入力してください。'
    )
    first_name = forms.CharField(
        max_length=30, 
        required=True,
        help_text='名前を入力してください。'
    )
    last_name = forms.CharField(
        max_length=30, 
        required=True,
        help_text='姓を入力してください。'
    )
    
    class Meta:
        model = User
        fields = ('username', 'first_name', 'last_name', 'email', 'password1', 'password2')
    
    def save(self, commit=True):
        user = super().save(commit=False)
        user.email = self.cleaned_data['email']
        user.first_name = self.cleaned_data['first_name']
        user.last_name = self.cleaned_data['last_name']
        if commit:
            user.save()
        return user

class UserProfileForm(forms.ModelForm):
    """ユーザープロフィール編集フォーム"""
    class Meta:
        model = UserProfile
        fields = ['phone_number', 'birth_date', 'avatar', 'bio', 'website', 
                  'location', 'twitter_handle', 'github_username', 
                  'is_profile_public', 'email_notifications']
        widgets = {
            'birth_date': forms.DateInput(attrs={'type': 'date'}),
            'bio': forms.Textarea(attrs={'rows': 4}),
        }</code></pre>

                        <h6>期待される結果</h6>
                        <p>ユーザーが新規登録でき、ログイン後にプロフィール情報を編集できることを確認してください。</p>
                    </div>

                    <!-- セクション4: アクセス制御とパーミッション -->
                    <h3 class="section-title">6.4 アクセス制御とパーミッション</h3>
                    
                    <p>Webアプリケーションでは、すべてのユーザーが同じ機能にアクセスできるわけではありません。Djangoのパーミッションシステムを使用して、適切なアクセス制御を実装できます。</p>

                    <h4>パーミッションシステムの構造</h4>
                    <div class="mermaid">
                        classDiagram
                            class User {
                                +user_permissions: ManyToMany
                                +groups: ManyToMany
                                +is_superuser: Boolean
                                +has_perm()
                                +has_perms()
                                +get_all_permissions()
                            }
                            
                            class Group {
                                +name: CharField
                                +permissions: ManyToMany
                            }
                            
                            class Permission {
                                +name: CharField
                                +content_type: ForeignKey
                                +codename: CharField
                            }
                            
                            class ContentType {
                                +app_label: CharField
                                +model: CharField
                            }
                            
                            User ||--o{ Group : belongs_to
                            User ||--o{ Permission : has_directly
                            Group ||--o{ Permission : contains
                            Permission }o--|| ContentType : defines_for
                    </div>

                    <pre class="code-block"><code class="language-python"># デコレータを使用したアクセス制御
from django.contrib.auth.decorators import login_required, permission_required
from django.contrib.auth.mixins import LoginRequiredMixin, PermissionRequiredMixin
from django.core.exceptions import PermissionDenied
from django.shortcuts import get_object_or_404
from django.views.generic import CreateView, UpdateView, DeleteView

# 関数ベースビューでの実装
@login_required
@permission_required('blog.add_post', raise_exception=True)
def create_post(request):
    """ブログ投稿作成（権限チェック付き）"""
    if request.method == 'POST':
        # 投稿作成処理
        pass
    return render(request, 'blog/create_post.html')

@login_required
def edit_post(request, post_id):
    """ブログ投稿編集（所有者チェック付き）"""
    post = get_object_or_404(BlogPost, id=post_id)
    
    # 所有者または管理者のみ編集可能
    if post.author != request.user and not request.user.has_perm('blog.change_post'):
        raise PermissionDenied("この投稿を編集する権限がありません。")
    
    if request.method == 'POST':
        # 編集処理
        pass
    return render(request, 'blog/edit_post.html', {'post': post})

# クラスベースビューでの実装
class BlogPostCreateView(LoginRequiredMixin, PermissionRequiredMixin, CreateView):
    """ブログ投稿作成ビュー"""
    model = BlogPost
    form_class = BlogPostForm
    permission_required = 'blog.add_blogpost'
    
    def form_valid(self, form):
        form.instance.author = self.request.user
        return super().form_valid(form)

class BlogPostUpdateView(LoginRequiredMixin, UpdateView):
    """ブログ投稿更新ビュー"""
    model = BlogPost
    form_class = BlogPostForm
    
    def get_object(self, queryset=None):
        obj = super().get_object(queryset)
        # 所有者チェック
        if obj.author != self.request.user and not self.request.user.has_perm('blog.change_blogpost'):
            raise PermissionDenied("この投稿を編集する権限がありません。")
        return obj</code></pre>

                    <h4>カスタムパーミッションの定義</h4>
                    <pre class="code-block"><code class="language-python"># models.py - カスタムパーミッションの定義
class BlogPost(models.Model):
    title = models.CharField(max_length=200)
    content = models.TextField()
    author = models.ForeignKey(User, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    is_published = models.BooleanField(default=False)
    
    class Meta:
        permissions = [
            ('can_publish_post', 'Can publish blog posts'),
            ('can_feature_post', 'Can feature blog posts'),
            ('can_moderate_comments', 'Can moderate comments'),
        ]
    
    def __str__(self):
        return self.title

# カスタムパーミッションの使用例
@login_required
@permission_required('blog.can_publish_post', raise_exception=True)
def publish_post(request, post_id):
    """投稿を公開する"""
    post = get_object_or_404(BlogPost, id=post_id)
    post.is_published = True
    post.save()
    messages.success(request, '投稿が公開されました。')
    return redirect('post_detail', post_id=post.id)</code></pre>

                    <!-- セクション5: パスワードリセット機能 -->
                    <h3 class="section-title">6.5 パスワードリセット機能の実装</h3>
                    
                    <p>パスワードを忘れたユーザーが安全にパスワードをリセットできる機能は、現代のWebアプリケーションで必須の機能です。Djangoでは、メール送信を伴うセキュアなパスワードリセット機能を簡単に実装できます。</p>

                    <h4>パスワードリセットのフロー</h4>
                    <div class="mermaid">
                        sequenceDiagram
                            participant User as ユーザー
                            participant App as アプリケーション
                            participant Email as メールサーバー
                            participant DB as データベース

                            User->>App: パスワードリセット要求
                            App->>DB: ユーザー存在確認
                            DB->>App: ユーザー情報
                            App->>DB: リセットトークン生成・保存
                            App->>Email: リセットメール送信
                            Email->>User: リセットリンク付きメール
                            User->>App: リセットリンククリック
                            App->>DB: トークン検証
                            alt トークン有効
                                App->>User: パスワード変更フォーム
                                User->>App: 新パスワード送信
                                App->>DB: パスワード更新
                                App->>User: 完了メッセージ
                            else トークン無効
                                App->>User: エラーメッセージ
                            end
                    </div>

                    <pre class="code-block"><code class="language-python"># urls.py
from django.contrib.auth import views as auth_views
from django.urls import path

urlpatterns = [
    # パスワードリセット関連のURL
    path('password_reset/', 
         auth_views.PasswordResetView.as_view(
             template_name='registration/password_reset.html',
             email_template_name='registration/password_reset_email.html',
             subject_template_name='registration/password_reset_subject.txt',
             success_url='/accounts/password_reset/done/'
         ), 
         name='password_reset'),
    
    path('password_reset/done/', 
         auth_views.PasswordResetDoneView.as_view(
             template_name='registration/password_reset_done.html'
         ), 
         name='password_reset_done'),
    
    path('reset/&lt;uidb64&gt;/&lt;token&gt;/', 
         auth_views.PasswordResetConfirmView.as_view(
             template_name='registration/password_reset_confirm.html',
             success_url='/accounts/reset/done/'
         ), 
         name='password_reset_confirm'),
    
    path('reset/done/', 
         auth_views.PasswordResetCompleteView.as_view(
             template_name='registration/password_reset_complete.html'
         ), 
         name='password_reset_complete'),
]

# settings.py - メール設定
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'your-email@gmail.com'
EMAIL_HOST_PASSWORD = 'your-app-password'
DEFAULT_FROM_EMAIL = 'noreply@yoursite.com'</code></pre>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 6-2: 完全な認証システムの実装</h5>
                        <p>この実習では、ログイン・登録・パスワードリセット・プロフィール管理を含む完全な認証システムを構築します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>認証関連のURLパターンを設定する</li>
                            <li>カスタム認証ビューを実装する</li>
                            <li>パスワードリセット機能を実装する</li>
                            <li>適切なテンプレートを作成する</li>
                            <li>メール送信設定を構成する</li>
                        </ol>

                        <h6>テンプレート例</h6>
                        <pre class="code-block"><code class="language-html">&lt;!-- registration/login.html --&gt;
&lt;div class="row justify-content-center"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header"&gt;
                &lt;h3&gt;ログイン&lt;/h3&gt;
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
                &lt;form method="post"&gt;
                    {% csrf_token %}
                    &lt;div class="mb-3"&gt;
                        &lt;label for="username" class="form-label"&gt;ユーザー名&lt;/label&gt;
                        &lt;input type="text" class="form-control" name="username" required&gt;
                    &lt;/div&gt;
                    &lt;div class="mb-3"&gt;
                        &lt;label for="password" class="form-label"&gt;パスワード&lt;/label&gt;
                        &lt;input type="password" class="form-control" name="password" required&gt;
                    &lt;/div&gt;
                    &lt;button type="submit" class="btn btn-primary"&gt;ログイン&lt;/button&gt;
                &lt;/form&gt;
                &lt;div class="mt-3"&gt;
                    &lt;p&gt;&lt;a href="{% url 'password_reset' %}"&gt;パスワードを忘れた方はこちら&lt;/a&gt;&lt;/p&gt;
                    &lt;p&gt;&lt;a href="{% url 'signup' %}"&gt;新規登録はこちら&lt;/a&gt;&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>

                        <h6>期待される結果</h6>
                        <p>完全な認証フローが動作し、メール送信を伴うパスワードリセット機能が正常に動作することを確認してください。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>Django認証システムの主要コンポーネントを4つ挙げて、それぞれの役割を説明してください。</li>
                            <li>ユーザーモデルをカスタマイズする3つの方法を比較し、それぞれの利点と欠点を述べてください。</li>
                            <li><code>@login_required</code>デコレータと<code>LoginRequiredMixin</code>の違いと使用場面を説明してください。</li>
                            <li>パーミッションシステムでオブジェクトレベルの権限制御を実装する方法を説明してください。</li>
                            <li>パスワードリセット機能のセキュリティ上の考慮点を3つ挙げてください。</li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="django-learning-material-5.html" class="btn btn-secondary">← 前の章</a>
                        <a href="django-learning-material-7.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 F-Circle All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>