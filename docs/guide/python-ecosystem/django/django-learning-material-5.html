<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django学習教材 第5章 - フォームとユーザー入力処理</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #2e7d32;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        /* タイトル */
        .chapter-title {
            color: #2e7d32;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d32;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #388e3c;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d32;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #2e7d32 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>Django学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-1.html">
                                第1章: Django入門と環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-2.html">
                                第2章: モデルとデータベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-3.html">
                                第3章: ビューとURLルーティング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-4.html">
                                第4章: テンプレートとフロントエンド統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="django-learning-material-5.html">
                                第5章: フォームとユーザー入力処理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-6.html">
                                第6章: 認証とユーザー管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-7.html">
                                第7章: Django REST Framework入門
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-8.html">
                                第8章: テストとデバッグ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-9.html">
                                第9章: デプロイメントと本番環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-10.html">
                                第10章: 高度な機能と最適化
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第5章: フォームとユーザー入力処理</h1>
                </div>

                <div id="chapter5">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">Djangoフォームによる安全な入力処理</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Djangoフォームクラスの基本概念と作成方法</li>
                            <li>フォームバリデーションの実装と活用</li>
                            <li>ModelFormを使用したモデル連携フォーム</li>
                            <li>CSRFプロテクションによるセキュリティ対策</li>
                            <li>ファイルアップロード機能の実装</li>
                            <li>フォームセットを使用した複数データ処理</li>
                        </ul>
                    </div>

                    <!-- セクション1: Djangoフォームの基礎 -->
                    <h3 class="section-title">5.1 Djangoフォームの基礎概念</h3>
                    
                    <p>Djangoフォームは、HTMLフォームの生成、データの検証、そしてPythonデータ型への変換を統合的に処理する強力なシステムです。従来のHTMLフォームと比べて、セキュリティ、バリデーション、再利用性の面で大きな利点を提供します。</p>

                    <h4>なぜDjangoフォームを使用するのか</h4>
                    <p>Webアプリケーションにおけるユーザー入力処理は、以下の課題を抱えています：</p>
                    <ul>
                        <li><strong>セキュリティリスク</strong>：XSS攻撃やCSRF攻撃への対策が必要</li>
                        <li><strong>データ検証の複雑さ</strong>：入力値の形式チェックやビジネスロジックの検証</li>
                        <li><strong>エラーハンドリング</strong>：バリデーションエラーの適切な表示</li>
                        <li><strong>HTMLコードの重複</strong>：同様のフォーム構造の繰り返し記述</li>
                    </ul>

                    <p>Djangoフォームは、これらの課題を解決する包括的なソリューションを提供します。</p>

                    <div class="mermaid">
                        sequenceDiagram
                            participant User as ユーザー
                            participant Template as テンプレート
                            participant Form as フォームクラス
                            participant View as ビュークラス
                            participant Model as モデル

                            User->>Template: フォーム表示要求
                            Template->>Form: フォーム生成
                            Form->>Template: HTMLフォーム
                            Template->>User: フォーム画面表示
                            User->>View: フォーム送信
                            View->>Form: データ検証要求
                            Form->>Form: バリデーション実行
                            alt バリデーション成功
                                Form->>View: 検証済みデータ
                                View->>Model: データ保存
                                Model->>View: 保存完了
                                View->>User: 成功レスポンス
                            else バリデーション失敗
                                Form->>View: エラー情報
                                View->>Template: エラー付きフォーム
                                Template->>User: エラー表示
                            end
                    </div>

                    <h4>フォームクラスの基本構造</h4>
                    <p>Djangoフォームは、<code>django.forms.Form</code>クラスを継承して作成されます。各フィールドはフォームフィールドクラスのインスタンスとして定義されます。</p>

                    <pre class="code-block"><code class="language-python"># forms.py
from django import forms

class ContactForm(forms.Form):
    """お問い合わせフォーム"""
    name = forms.CharField(
        max_length=100,
        label='お名前',
        help_text='フルネームでご入力ください'
    )
    email = forms.EmailField(
        label='メールアドレス',
        help_text='返信先メールアドレス'
    )
    subject = forms.CharField(
        max_length=200,
        label='件名'
    )
    message = forms.CharField(
        widget=forms.Textarea(attrs={'rows': 5}),
        label='メッセージ',
        help_text='具体的な内容をお書きください'
    )</code></pre>

                    <!-- セクション2: フォームフィールドタイプ -->
                    <h3 class="section-title">5.2 フォームフィールドタイプと属性</h3>
                    
                    <p>Djangoフォームでは、様々な種類の入力データに対応したフィールドタイプが提供されています。各フィールドタイプは、特定のデータ型と検証ルールを持っています。</p>

                    <h4>主要なフォームフィールド</h4>
                    <div class="mermaid">
                        classDiagram
                            class Field {
                                +required: boolean
                                +label: string
                                +help_text: string
                                +widget: Widget
                                +validators: list
                                +clean()
                                +validate()
                            }
                            
                            Field &lt;|-- CharField
                            Field &lt;|-- EmailField
                            Field &lt;|-- IntegerField
                            Field &lt;|-- DateField
                            Field &lt;|-- BooleanField
                            Field &lt;|-- ChoiceField
                            Field &lt;|-- FileField
                            Field &lt;|-- ImageField
                            
                            class CharField {
                                +max_length: int
                                +min_length: int
                                +strip: boolean
                            }
                            
                            class EmailField {
                                +domain_whitelist: list
                            }
                            
                            class IntegerField {
                                +max_value: int
                                +min_value: int
                            }
                            
                            class DateField {
                                +input_formats: list
                            }
                            
                            class ChoiceField {
                                +choices: list
                                +empty_value: string
                            }
                            
                            class FileField {
                                +allow_empty_file: boolean
                            }
                    </div>

                    <pre class="code-block"><code class="language-python"># 様々なフィールドタイプの使用例
class RegistrationForm(forms.Form):
    # 文字列フィールド
    username = forms.CharField(
        max_length=30,
        min_length=3,
        label='ユーザー名',
        help_text='3-30文字で入力してください'
    )
    
    # メールフィールド
    email = forms.EmailField(
        label='メールアドレス'
    )
    
    # パスワードフィールド
    password = forms.CharField(
        widget=forms.PasswordInput(),
        min_length=8,
        label='パスワード',
        help_text='8文字以上で入力してください'
    )
    
    # 数値フィールド
    age = forms.IntegerField(
        min_value=18,
        max_value=100,
        label='年齢'
    )
    
    # 日付フィールド
    birth_date = forms.DateField(
        widget=forms.DateInput(attrs={'type': 'date'}),
        label='生年月日'
    )
    
    # 選択フィールド
    GENDER_CHOICES = [
        ('M', '男性'),
        ('F', '女性'),
        ('O', 'その他'),
    ]
    gender = forms.ChoiceField(
        choices=GENDER_CHOICES,
        label='性別'
    )
    
    # ブールフィールド
    agree_terms = forms.BooleanField(
        label='利用規約に同意する',
        required=True
    )</code></pre>

                    <!-- セクション3: フォームバリデーション -->
                    <h3 class="section-title">5.3 フォームバリデーション</h3>
                    
                    <p>フォームバリデーションは、ユーザーの入力データが要求される形式や条件を満たしているかを確認する重要なプロセスです。Djangoでは、複数のレベルでバリデーションを実装できます。</p>

                    <h4>バリデーションの階層構造</h4>
                    <div class="mermaid">
                        flowchart TB
                            A["フォームデータ受信"] --> B["フィールドレベル検証"]
                            B --> C["clean_フィールド名() メソッド"]
                            C --> D["フォームレベル検証"]
                            D --> E["clean() メソッド"]
                            E --> F{検証結果}
                            F -->|成功| G["cleaned_data生成"]
                            F -->|失敗| H["ValidationErrorエラー"]
                            H --> I["エラーメッセージ表示"]
                            G --> J["データ処理完了"]
                    </div>

                    <pre class="code-block"><code class="language-python"># カスタムバリデーションの実装例
from django import forms
from django.core.exceptions import ValidationError
import re

class UserRegistrationForm(forms.Form):
    username = forms.CharField(max_length=30)
    email = forms.EmailField()
    password1 = forms.CharField(widget=forms.PasswordInput())
    password2 = forms.CharField(widget=forms.PasswordInput())
    
    def clean_username(self):
        """ユーザー名のカスタムバリデーション"""
        username = self.cleaned_data['username']
        
        # 英数字とアンダースコアのみ許可
        if not re.match(r'^[a-zA-Z0-9_]+$', username):
            raise ValidationError(
                'ユーザー名は英数字とアンダースコアのみ使用できます。'
            )
        
        # 予約語チェック
        reserved_names = ['admin', 'root', 'system']
        if username.lower() in reserved_names:
            raise ValidationError(
                f'"{username}"は予約されているため使用できません。'
            )
        
        return username
    
    def clean_email(self):
        """メールアドレスの重複チェック"""
        email = self.cleaned_data['email']
        
        # データベースでの重複チェック（実際の実装では必要）
        # if User.objects.filter(email=email).exists():
        #     raise ValidationError('このメールアドレスは既に使用されています。')
        
        return email
    
    def clean(self):
        """フォームレベルでのバリデーション"""
        cleaned_data = super().clean()
        password1 = cleaned_data.get('password1')
        password2 = cleaned_data.get('password2')
        
        # パスワード一致チェック
        if password1 and password2 and password1 != password2:
            raise ValidationError('パスワードが一致しません。')
        
        # パスワード強度チェック
        if password1:
            if len(password1) < 8:
                raise ValidationError('パスワードは8文字以上で入力してください。')
            
            if not re.search(r'[A-Z]', password1):
                raise ValidationError('パスワードには大文字を含めてください。')
            
            if not re.search(r'[0-9]', password1):
                raise ValidationError('パスワードには数字を含めてください。')
        
        return cleaned_data</code></pre>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 5-1: 基本的なお問い合わせフォームの作成</h5>
                        <p>この実習では、基本的なお問い合わせフォームを作成し、バリデーション機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>新しいDjangoアプリケーション「contact」を作成する</li>
                            <li>forms.pyファイルでContactFormクラスを定義する</li>
                            <li>ビューでフォームの表示と処理を実装する</li>
                            <li>テンプレートでフォームを表示する</li>
                            <li>カスタムバリデーションを追加する</li>
                        </ol>

                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python"># contact/forms.py
from django import forms
from django.core.exceptions import ValidationError

class ContactForm(forms.Form):
    SUBJECT_CHOICES = [
        ('inquiry', 'お問い合わせ'),
        ('support', 'サポート'),
        ('bug', 'バグ報告'),
        ('other', 'その他'),
    ]
    
    name = forms.CharField(
        max_length=100,
        label='お名前',
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'フルネームでご入力ください'
        })
    )
    
    email = forms.EmailField(
        label='メールアドレス',
        widget=forms.EmailInput(attrs={
            'class': 'form-control',
            'placeholder': 'example@domain.com'
        })
    )
    
    subject = forms.ChoiceField(
        choices=SUBJECT_CHOICES,
        label='件名',
        widget=forms.Select(attrs={'class': 'form-control'})
    )
    
    message = forms.CharField(
        label='メッセージ',
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'rows': 5,
            'placeholder': '詳細な内容をご記入ください'
        }),
        min_length=10
    )
    
    def clean_name(self):
        name = self.cleaned_data['name']
        if len(name.split()) < 2:
            raise ValidationError('姓と名を両方入力してください。')
        return name</code></pre>

                        <h6>期待される結果</h6>
                        <p>フォームが正しく表示され、入力データのバリデーションが機能すること。エラーメッセージが適切に表示されることを確認してください。</p>
                    </div>

                    <!-- セクション4: ModelForm -->
                    <h3 class="section-title">5.4 ModelFormによるモデル連携</h3>
                    
                    <p>ModelFormは、Djangoモデルから自動的にフォームフィールドを生成する強力な機能です。モデルの定義とフォームの定義を重複して書く必要がなくなり、保守性と一貫性が向上します。</p>

                    <h4>ModelFormの利点</h4>
                    <ul>
                        <li><strong>コードの重複削減</strong>：モデルフィールドからフォームフィールドを自動生成</li>
                        <li><strong>一貫性の保証</strong>：モデルとフォームの定義が自動的に同期</li>
                        <li><strong>簡単な保存処理</strong>：save()メソッドで直接モデルインスタンスを保存</li>
                        <li><strong>バリデーションの統合</strong>：モデルレベルとフォームレベルの検証が統合</li>
                    </ul>

                    <pre class="code-block"><code class="language-python"># models.py
from django.db import models

class BlogPost(models.Model):
    title = models.CharField(max_length=200, verbose_name='タイトル')
    slug = models.SlugField(max_length=200, unique=True)
    content = models.TextField(verbose_name='本文')
    author = models.ForeignKey(
        'auth.User', 
        on_delete=models.CASCADE,
        verbose_name='著者'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    published = models.BooleanField(default=False, verbose_name='公開')
    
    class Meta:
        verbose_name = 'ブログ投稿'
        verbose_name_plural = 'ブログ投稿一覧'
        ordering = ['-created_at']

# forms.py
from django import forms
from .models import BlogPost

class BlogPostForm(forms.ModelForm):
    class Meta:
        model = BlogPost
        fields = ['title', 'content', 'published']
        widgets = {
            'title': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': '魅力的なタイトルを入力してください'
            }),
            'content': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 10,
                'placeholder': 'ブログの内容を書いてください...'
            }),
        }
        help_texts = {
            'published': '公開すると他のユーザーが閲覧できます。',
        }
    
    def clean_title(self):
        title = self.cleaned_data['title']
        if len(title) < 5:
            raise ValidationError('タイトルは5文字以上で入力してください。')
        return title
    
    def save(self, commit=True):
        # スラッグを自動生成
        post = super().save(commit=False)
        if not post.slug:
            from django.utils.text import slugify
            post.slug = slugify(post.title)
        
        if commit:
            post.save()
        return post</code></pre>

                    <!-- セクション5: CSRFプロテクション -->
                    <h3 class="section-title">5.5 CSRFプロテクションによるセキュリティ</h3>
                    
                    <p>CSRF（Cross-Site Request Forgery）攻撃は、悪意のあるWebサイトが、ユーザーの認証情報を悪用して別のサイトに不正なリクエストを送信する攻撃手法です。Djangoでは、CSRFプロテクション機能が標準で提供されています。</p>

                    <h4>CSRFプロテクションの仕組み</h4>
                    <div class="mermaid">
                        sequenceDiagram
                            participant Browser as ブラウザ
                            participant Django as Djangoサーバー
                            participant Form as フォーム

                            Browser->>Django: フォーム表示要求
                            Django->>Django: CSRFトークン生成
                            Django->>Browser: フォーム + CSRFトークン
                            Browser->>Form: ユーザー入力
                            Form->>Django: フォーム送信 + CSRFトークン
                            Django->>Django: トークン検証
                            alt トークン有効
                                Django->>Browser: 処理実行
                            else トークン無効
                                Django->>Browser: 403 Forbidden
                            end
                    </div>

                    <pre class="code-block"><code class="language-html">&lt;!-- テンプレートでのCSRFトークンの使用 --&gt;
&lt;form method="post"&gt;
    {% csrf_token %}
    &lt;div class="mb-3"&gt;
        &lt;label for="title" class="form-label"&gt;タイトル&lt;/label&gt;
        &lt;input type="text" class="form-control" id="title" name="title" required&gt;
    &lt;/div&gt;
    &lt;div class="mb-3"&gt;
        &lt;label for="content" class="form-label"&gt;内容&lt;/label&gt;
        &lt;textarea class="form-control" id="content" name="content" rows="5" required&gt;&lt;/textarea&gt;
    &lt;/div&gt;
    &lt;button type="submit" class="btn btn-primary"&gt;投稿する&lt;/button&gt;
&lt;/form&gt;</code></pre>

                    <div class="warning">
                        <h6>重要：CSRFプロテクションの注意点</h6>
                        <ul>
                            <li><code>{% csrf_token %}</code>タグを必ずフォーム内に含める</li>
                            <li>POSTリクエストでは必須（GETリクエストでは不要）</li>
                            <li>Ajaxリクエストでも適切にトークンを送信する</li>
                            <li>開発時に無効化する場合は本番環境では必ず有効化する</li>
                        </ul>
                    </div>

                    <!-- セクション6: ファイルアップロード -->
                    <h3 class="section-title">5.6 ファイルアップロード処理</h3>
                    
                    <p>Webアプリケーションでは、画像や文書ファイルのアップロード機能が頻繁に必要になります。Djangoでは、ファイルアップロードを安全かつ効率的に処理するための機能が提供されています。</p>

                    <pre class="code-block"><code class="language-python"># models.py
from django.db import models
from django.core.validators import FileExtensionValidator

class UserProfile(models.Model):
    user = models.OneToOneField('auth.User', on_delete=models.CASCADE)
    avatar = models.ImageField(
        upload_to='avatars/%Y/%m/',  # 年月でディレクトリ分け
        blank=True,
        null=True,
        validators=[FileExtensionValidator(['jpg', 'jpeg', 'png'])],
        help_text='JPG、JPEG、PNG形式のファイルをアップロードしてください'
    )
    resume = models.FileField(
        upload_to='resumes/',
        blank=True,
        null=True,
        validators=[FileExtensionValidator(['pdf', 'doc', 'docx'])],
        help_text='履歴書（PDF、DOC、DOCX形式）'
    )
    bio = models.TextField(max_length=500, blank=True)

# forms.py
class UserProfileForm(forms.ModelForm):
    class Meta:
        model = UserProfile
        fields = ['avatar', 'resume', 'bio']
        widgets = {
            'bio': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 4
            }),
        }
    
    def clean_avatar(self):
        avatar = self.cleaned_data.get('avatar')
        if avatar:
            # ファイルサイズチェック（2MB以下）
            if avatar.size > 2 * 1024 * 1024:
                raise ValidationError('画像ファイルは2MB以下にしてください。')
        return avatar
    
    def clean_resume(self):
        resume = self.cleaned_data.get('resume')
        if resume:
            # ファイルサイズチェック（5MB以下）
            if resume.size > 5 * 1024 * 1024:
                raise ValidationError('履歴書ファイルは5MB以下にしてください。')
        return resume</code></pre>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 5-2: ユーザープロフィール管理フォームの作成</h5>
                        <p>この実習では、ファイルアップロード機能を含むユーザープロフィール管理フォームを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>UserProfileモデルを作成する</li>
                            <li>画像とファイルアップロードフィールドを定義する</li>
                            <li>ModelFormでプロフィール編集フォームを作成する</li>
                            <li>ファイルサイズと形式のバリデーションを実装する</li>
                            <li>テンプレートでファイル選択UIを作成する</li>
                        </ol>

                        <h6>ビューの実装例</h6>
                        <pre class="code-block"><code class="language-python"># views.py
from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from .forms import UserProfileForm
from .models import UserProfile

@login_required
def edit_profile(request):
    try:
        profile = request.user.userprofile
    except UserProfile.DoesNotExist:
        profile = UserProfile.objects.create(user=request.user)
    
    if request.method == 'POST':
        form = UserProfileForm(request.POST, request.FILES, instance=profile)
        if form.is_valid():
            form.save()
            messages.success(request, 'プロフィールを更新しました。')
            return redirect('edit_profile')
    else:
        form = UserProfileForm(instance=profile)
    
    return render(request, 'profile/edit.html', {'form': form})</code></pre>

                        <h6>期待される結果</h6>
                        <p>ファイルアップロード機能が正常に動作し、適切なバリデーションが実行されることを確認してください。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>Djangoフォームを使用する主な利点を3つ挙げてください。</li>
                            <li>フォームバリデーションが実行される順序を説明してください。</li>
                            <li>ModelFormと通常のFormの違いは何ですか？</li>
                            <li>CSRFプロテクションが防ぐ攻撃の種類と仕組みを説明してください。</li>
                            <li>ファイルアップロード時に考慮すべきセキュリティ要素を挙げてください。</li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="django-learning-material-4.html" class="btn btn-secondary">← 前の章</a>
                        <a href="django-learning-material-6.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 F-Circle All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>