<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" id="viewport-meta">
    <title>SAS Viya学習教材 第9章 - SAS Model Studioによる機械学習（応用）</title>

    <!-- ダークモード早期適用（フラッシュ防止） -->
    <script>
        (function() {
            const saved = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === 'dark' || (saved === null && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // SAS Viya - Blue
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts - Noto Sans JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- SAS言語サポート（デフォルトに含まれないため追加） -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sas.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- カスタムスタイル -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="font-sans bg-slate-50 text-slate-800 antialiased">
    <!-- ヘッダー/ナビゲーションバー -->
    <header class="fixed top-0 left-0 right-0 z-50 text-white header-rich header-rich-shadow">
        <nav class="w-full px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="flex items-center justify-between py-3">
                <!-- 左側: ロゴとタイトルセクション -->
                <div class="flex items-center gap-4">
                    <!-- アイコン -->
                    <div class="relative group">
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-400/30 to-cyan-400/30 rounded-2xl blur-lg group-hover:blur-xl transition-all"></div>
                        <div class="relative w-14 h-14 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                            <i class="fas fa-chart-bar text-3xl icon-rotate-hover drop-shadow-lg"></i>
                        </div>
                    </div>

                    <!-- タイトルとメタ情報 -->
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-bold tracking-wide drop-shadow-md">SAS Viya学習教材</span>
                            <span class="hidden sm:inline-flex items-center gap-1 px-2 py-0.5 bg-white/20 rounded-md text-[10px] font-semibold uppercase tracking-wider">
                                <i class="fas fa-star text-yellow-300 text-[8px]"></i>
                                中級
                            </span>
                        </div>
                        <div class="flex items-center gap-3 text-[11px] text-white/90 font-medium">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-brain text-[9px]"></i>
                                <span>データ・AI</span>
                            </div>
                            <div class="hidden sm:flex items-center gap-1">
                                <i class="fas fa-clock text-[9px]"></i>
                                <span>推奨 90分</span>
                            </div>
                            <div class="hidden lg:flex items-center gap-1">
                                <i class="fas fa-language text-[9px]"></i>
                                <span>日本語</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側: サイドバートグルボタン -->
                <button id="sidebar-toggle-btn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white/20 transition-all active:scale-95" title="サイドバーの表示/非表示">
                    <i class="fas fa-bars text-lg"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- メインレイアウト -->
    <div class="flex min-h-screen pt-20">
        <!-- サイドバーはsidebar-content.jsで動的に生成されます -->

        <!-- メインコンテンツ -->
        <main class="flex-1 min-w-0">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-10 py-6">
                <!-- パンくずリスト -->
                <nav class="flex items-center gap-2 text-sm text-slate-500 mb-6">
                    <a href="https://fcircle-biz.github.io/tech_docs/" class="hover:text-primary-600 transition-colors">ホーム</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <a href="https://fcircle-biz.github.io/tech_docs/guide/data-ai-category/data-ai/sas-viya/" class="hover:text-primary-600 transition-colors">SAS Viya</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-slate-700">第9章</span>
                </nav>

                <!-- 章ヘッダー -->
                <header class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                                     bg-primary-100 text-primary-700">
                            第9章
                        </span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">SAS Model Studioによる機械学習（応用）</h1>
                    <p class="text-slate-600">高度な機械学習テクニックを習得します。特徴量エンジニアリング、ハイパーパラメータチューニング、アンサンブル学習、モデル解釈性（説明可能AI）を実践的に学びます。</p>
                </header>

                <!-- 学習目標カード -->
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200
                            rounded-xl p-5 mb-6 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-amber-400 rounded-lg
                                    flex items-center justify-center">
                            <i class="fas fa-lightbulb text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-amber-800 mb-3">この章で学ぶこと</h2>
                            <ul class="space-y-2">
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>特徴量エンジニアリングの手法とベストプラクティス</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>ハイパーパラメータチューニングの戦略（Grid Search、Random Search、Bayesian Optimization）</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>アンサンブル学習（Bagging、Boosting、Stacking）の実装</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>モデル解釈性と説明可能AI（XAI）の実践</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>クラス不均衡データへの対処法（SMOTE、Class Weighting）</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- セクション1: 特徴量エンジニアリング -->
                <section class="prose prose-slate max-w-none mb-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        9.1 特徴量エンジニアリング
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>特徴量エンジニアリング（Feature Engineering）</strong>は、機械学習モデルの性能を左右する最も重要なプロセスの一つです。生データから有用な特徴量を作成・選択・変換することで、モデルの予測精度を大幅に向上させることができます。
                    </p>

                    <h3 class="text-lg font-semibold text-slate-800 mt-6 mb-3">特徴量エンジニアリングの主要手法</h3>

                    <!-- Mermaid図: 特徴量エンジニアリングのワークフロー -->
                    <div class="my-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">特徴量エンジニアリングのワークフロー</h4>
                        <div class="mermaid">
flowchart TD
    Raw["生データ"] --> Clean["データクレンジング"]
    Clean --> Transform["特徴量変換"]
    Transform --> Create["新規特徴量作成"]
    Create --> Select["特徴量選択"]
    Select --> Model["モデル学習"]

    Transform --> T1["正規化・標準化"]
    Transform --> T2["対数変換"]
    Transform --> T3["カテゴリエンコーディング"]

    Create --> C1["多項式特徴量"]
    Create --> C2["交互作用項"]
    Create --> C3["集約統計量"]

    Select --> S1["フィルタ法"]
    Select --> S2["ラッパー法"]
    Select --> S3["組み込み法"]
                        </div>
                    </div>

                    <div class="space-y-4 my-6">
                        <!-- 数値変換 -->
                        <div class="bg-blue-100 border border-blue-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-blue-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-calculator"></i>
                                数値変換
                            </h4>
                            <ul class="text-blue-900 text-sm space-y-1 ml-6 list-disc">
                                <li><strong>標準化（Standardization）:</strong> 平均0、標準偏差1に変換</li>
                                <li><strong>正規化（Normalization）:</strong> 0〜1の範囲にスケーリング</li>
                                <li><strong>対数変換:</strong> 右裾の長い分布を正規分布に近づける</li>
                                <li><strong>Box-Cox変換:</strong> データの歪度を最適化</li>
                            </ul>
                        </div>

                        <!-- カテゴリ変換 -->
                        <div class="bg-purple-100 border border-purple-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-purple-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-tag"></i>
                                カテゴリ変換
                            </h4>
                            <ul class="text-purple-900 text-sm space-y-1 ml-6 list-disc">
                                <li><strong>One-Hot Encoding:</strong> カテゴリをバイナリベクトルに変換</li>
                                <li><strong>Label Encoding:</strong> カテゴリを整数に変換</li>
                                <li><strong>Target Encoding:</strong> 目的変数の平均値でエンコーディング</li>
                                <li><strong>Frequency Encoding:</strong> 出現頻度でエンコーディング</li>
                            </ul>
                        </div>

                        <!-- 新規特徴量作成 -->
                        <div class="bg-emerald-100 border border-emerald-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-emerald-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-plus-circle"></i>
                                新規特徴量作成
                            </h4>
                            <ul class="text-emerald-900 text-sm space-y-1 ml-6 list-disc">
                                <li><strong>多項式特徴量:</strong> x, x², x³などの多項式を生成</li>
                                <li><strong>交互作用項:</strong> 複数変数の積（x₁ × x₂）を作成</li>
                                <li><strong>集約統計量:</strong> グループごとの平均・合計・最大値など</li>
                                <li><strong>時間特徴量:</strong> 日付から曜日・月・四半期などを抽出</li>
                            </ul>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-slate-800 mt-6 mb-3">Model Studioでの特徴量エンジニアリング実践</h3>

                    <!-- コードブロック: 特徴量変換パイプライン -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">feature_engineering_pipeline.sas</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-sas">/* CASセッション開始 */
cas mysession;

/* データをCASにロード */
proc casutil;
  load data=work.customer_data casout="customers";
quit;

/* 特徴量エンジニアリングパイプライン */
proc cas;
  /* 標準化 */
  dataPreprocess.transform /
    table={name="customers"}
    copyVars={"CustomerID", "Churn"}
    casout={name="customers_scaled"}
    requestPackages={
      {method="standardize",
       inputs={"Age", "Income", "Tenure"}}
    };

  /* カテゴリエンコーディング */
  dataPreprocess.transform /
    table={name="customers_scaled"}
    casout={name="customers_encoded"}
    requestPackages={
      {method="onehot",
       inputs={"Gender", "Region"}}
    };
quit;</code></pre>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r-lg overflow-hidden">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-blue-900 font-medium break-words">ヒント</p>
                                <p class="text-blue-800 text-sm mt-1 break-words">
                                    Model Studioでは、Data Explorationノードで特徴量の分布を確認し、Transformationノードで変換を適用できます。変換前後の分布を比較してデータ品質を確認しましょう。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション2: ハイパーパラメータチューニング -->
                <section class="prose prose-slate max-w-none mb-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        9.2 ハイパーパラメータチューニング
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>ハイパーパラメータチューニング</strong>は、モデルの性能を最大化するために最適なパラメータ設定を見つけるプロセスです。SAS Model Studioでは、複数のチューニング手法を簡単に利用できます。
                    </p>

                    <h3 class="text-lg font-semibold text-slate-800 mt-6 mb-3">主要なチューニング手法</h3>

                    <!-- チューニング手法比較表 -->
                    <div class="overflow-x-auto my-6">
                        <table class="min-w-full bg-white border border-slate-200 rounded-lg">
                            <thead class="bg-primary-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800 border-b border-slate-200">手法</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800 border-b border-slate-200">特徴</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800 border-b border-slate-200">メリット</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800 border-b border-slate-200">デメリット</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm text-slate-700">
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-3 font-medium">Grid Search</td>
                                    <td class="px-4 py-3">全組み合わせを網羅的に探索</td>
                                    <td class="px-4 py-3">確実に最適解を発見</td>
                                    <td class="px-4 py-3">計算コストが高い</td>
                                </tr>
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-3 font-medium">Random Search</td>
                                    <td class="px-4 py-3">ランダムに組み合わせを選択</td>
                                    <td class="px-4 py-3">効率的、広範囲を探索</td>
                                    <td class="px-4 py-3">最適解を見逃す可能性</td>
                                </tr>
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-3 font-medium">Bayesian Optimization</td>
                                    <td class="px-4 py-3">過去の結果から次の探索点を決定</td>
                                    <td class="px-4 py-3">少ない試行で最適解に到達</td>
                                    <td class="px-4 py-3">実装が複雑</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium">Genetic Algorithm</td>
                                    <td class="px-4 py-3">進化アルゴリズムで探索</td>
                                    <td class="px-4 py-3">局所最適解から脱出しやすい</td>
                                    <td class="px-4 py-3">収束が遅い場合がある</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Mermaid図: ハイパーパラメータチューニングのフロー -->
                    <div class="my-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">ハイパーパラメータチューニングのフロー</h4>
                        <div class="mermaid">
flowchart LR
    Start["パラメータ空間定義"] --> Strategy["探索戦略選択"]
    Strategy --> GS["Grid Search"]
    Strategy --> RS["Random Search"]
    Strategy --> BO["Bayesian Opt"]

    GS --> CV["交差検証"]
    RS --> CV
    BO --> CV

    CV --> Eval["モデル評価"]
    Eval --> Best{最良か?}
    Best -->|No| Strategy
    Best -->|Yes| Final["最適パラメータ"]
                        </div>
                    </div>

                    <!-- 実習カード -->
                    <div class="bg-gradient-to-r from-purple-50 to-fuchsia-50 border border-purple-200
                                rounded-xl p-5 my-6 overflow-hidden">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-10 h-10 bg-purple-500 rounded-lg
                                        flex items-center justify-center">
                                <i class="fas fa-laptop-code text-white"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-purple-800 mb-3 break-words">実習: ランダムフォレストのハイパーパラメータチューニング</h3>

                                <h4 class="text-purple-900 font-medium mb-2 break-words">手順:</h4>
                                <ol class="space-y-2 text-purple-900 list-decimal ml-5">
                                    <li class="break-words">Model Studioで新しいパイプラインを作成</li>
                                    <li class="break-words">Random Forestノードを追加し、プロパティを開く</li>
                                    <li class="break-words">「Hyperparameter Tuning」タブで以下を設定:
                                        <ul class="list-disc ml-5 mt-1">
                                            <li>Number of trees: 100〜500（ステップ100）</li>
                                            <li>Max depth: 5〜20（ステップ5）</li>
                                            <li>Min samples split: 2〜10（ステップ2）</li>
                                        </ul>
                                    </li>
                                    <li class="break-words">探索手法を「Random Search」に設定（試行回数20回）</li>
                                    <li class="break-words">評価指標を「AUC」に設定</li>
                                    <li class="break-words">パイプラインを実行し、最適パラメータを確認</li>
                                </ol>

                                <h4 class="text-purple-900 font-medium mb-2 mt-4 break-words">期待される結果:</h4>
                                <p class="text-purple-800 text-sm break-words">
                                    チューニング後のAUCが0.02〜0.05程度向上することが期待されます。チューニング履歴グラフで各パラメータの影響を確認しましょう。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション3: アンサンブル学習 -->
                <section class="prose prose-slate max-w-none mb-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        9.3 アンサンブル学習
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>アンサンブル学習</strong>は、複数のモデルを組み合わせることで、単一モデルよりも高い予測精度を実現する手法です。SAS Model Studioでは、主要なアンサンブル手法を簡単に実装できます。
                    </p>

                    <h3 class="text-lg font-semibold text-slate-800 mt-6 mb-3">アンサンブル学習の主要手法</h3>

                    <!-- Mermaid図: アンサンブル手法の比較 -->
                    <div class="my-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">アンサンブル学習の手法</h4>
                        <div class="mermaid">
graph TB
    Data["訓練データ"] --> Ensemble["アンサンブル学習"]

    Ensemble --> Bagging["Bagging"]
    Ensemble --> Boosting["Boosting"]
    Ensemble --> Stacking["Stacking"]

    Bagging --> RF["Random Forest"]
    Bagging --> BC["Bagging Classifier"]

    Boosting --> GB["Gradient Boosting"]
    Boosting --> XGB["XGBoost"]
    Boosting --> ADA["AdaBoost"]

    Stacking --> L1["レベル1モデル"]
    Stacking --> Meta["メタモデル"]

    RF --> Result["最終予測"]
    BC --> Result
    GB --> Result
    XGB --> Result
    ADA --> Result
    Meta --> Result
                        </div>
                    </div>

                    <div class="space-y-4 my-6">
                        <!-- Bagging -->
                        <div class="bg-blue-100 border border-blue-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-blue-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-layer-group"></i>
                                Bagging（Bootstrap Aggregating）
                            </h4>
                            <p class="text-blue-900 text-sm mb-2">
                                データをランダムサンプリング（復元抽出）して複数のモデルを並列に訓練し、結果を平均化または多数決で統合します。
                            </p>
                            <ul class="text-blue-900 text-sm space-y-1 ml-6 list-disc">
                                <li><strong>代表例:</strong> Random Forest、Bagging Classifier</li>
                                <li><strong>メリット:</strong> 過学習を抑制、分散を削減</li>
                                <li><strong>適用場面:</strong> 高分散モデル（決定木など）の安定化</li>
                            </ul>
                        </div>

                        <!-- Boosting -->
                        <div class="bg-emerald-100 border border-emerald-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-emerald-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-chart-line"></i>
                                Boosting
                            </h4>
                            <p class="text-emerald-900 text-sm mb-2">
                                弱学習器を逐次的に訓練し、前のモデルの誤分類に重点を置くことで、徐々に精度を向上させます。
                            </p>
                            <ul class="text-emerald-900 text-sm space-y-1 ml-6 list-disc">
                                <li><strong>代表例:</strong> Gradient Boosting、XGBoost、LightGBM、AdaBoost</li>
                                <li><strong>メリット:</strong> 高精度、バイアスを削減</li>
                                <li><strong>適用場面:</strong> Kaggleなど高精度が求められるコンペ</li>
                            </ul>
                        </div>

                        <!-- Stacking -->
                        <div class="bg-purple-100 border border-purple-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-purple-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-sitemap"></i>
                                Stacking
                            </h4>
                            <p class="text-purple-900 text-sm mb-2">
                                複数の異なるモデルの予測結果を特徴量として、メタモデルで最終予測を行います。
                            </p>
                            <ul class="text-purple-900 text-sm space-y-1 ml-6 list-disc">
                                <li><strong>構成:</strong> レベル1モデル（多様なアルゴリズム） + メタモデル（ロジスティック回帰など）</li>
                                <li><strong>メリット:</strong> 異なるモデルの長所を組み合わせ</li>
                                <li><strong>適用場面:</strong> 最高精度を追求する場合</li>
                            </ul>
                        </div>
                    </div>

                    <!-- コードブロック: Gradient Boostingの実装 -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">gradient_boosting_example.sas</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-sas">/* Gradient Boostingモデルの構築 */
proc gradboost data=mycaslib.train_data
    ntrees=500
    maxdepth=6
    learningrate=0.05
    seed=12345;
  target Churn / level=binary;
  input Age Income Tenure / level=interval;
  input Gender Region / level=nominal;
  save model=mycaslib.gb_model;
  score out=mycaslib.gb_predictions;
run;

/* モデル性能評価 */
proc assess data=mycaslib.gb_predictions;
  var Churn;
  fitstat;
  rocout rocout=mycaslib.roc_curve;
run;</code></pre>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-6 rounded-r-lg overflow-hidden">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-emerald-900 font-medium break-words">重要ポイント</p>
                                <p class="text-emerald-800 text-sm mt-1 break-words">
                                    Model Studioの「Ensemble」ノードを使用すると、複数のモデルを自動的に組み合わせてアンサンブルモデルを構築できます。通常、単一モデルよりもAUCが0.03〜0.08程度向上します。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション4: モデル解釈性と説明可能AI -->
                <section class="prose prose-slate max-w-none mb-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        9.4 モデル解釈性と説明可能AI（XAI）
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>説明可能AI（Explainable AI, XAI）</strong>は、ブラックボックスモデルの予測を人間が理解できる形で説明する技術です。金融・医療・人事などの分野では、モデルの透明性が法的要件になっている場合もあります。
                    </p>

                    <h3 class="text-lg font-semibold text-slate-800 mt-6 mb-3">主要な解釈手法</h3>

                    <!-- Mermaid図: XAI手法の分類 -->
                    <div class="my-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">XAI手法の分類</h4>
                        <div class="mermaid">
graph TB
    XAI["説明可能AI（XAI）"] --> Global["グローバル解釈"]
    XAI --> Local["ローカル解釈"]

    Global --> FI["Feature Importance<br/>（特徴量重要度）"]
    Global --> PDP["Partial Dependence Plot<br/>（部分依存プロット）"]
    Global --> ICE["ICE Plot<br/>（個別条件付き期待値）"]

    Local --> LIME["LIME<br/>（局所近似）"]
    Local --> SHAP["SHAP<br/>（Shapley値）"]
    Local --> CA["Counterfactual<br/>（反事実的説明）"]

    style FI fill:#dbeafe
    style SHAP fill:#dbeafe
                        </div>
                    </div>

                    <div class="space-y-4 my-6">
                        <!-- Feature Importance -->
                        <div class="bg-blue-100 border border-blue-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-blue-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-star"></i>
                                Feature Importance（特徴量重要度）
                            </h4>
                            <p class="text-blue-900 text-sm">
                                各特徴量がモデルの予測にどれだけ貢献しているかを数値化します。Random Forestでは不純度の減少量、Gradient Boostingではゲインで計算されます。
                            </p>
                        </div>

                        <!-- SHAP -->
                        <div class="bg-emerald-100 border border-emerald-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-emerald-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-chart-bar"></i>
                                SHAP（SHapley Additive exPlanations）
                            </h4>
                            <p class="text-emerald-900 text-sm">
                                ゲーム理論のShapley値に基づき、各特徴量が個別の予測にどれだけ貢献したかを定量化します。最も信頼性の高い解釈手法の一つです。
                            </p>
                        </div>

                        <!-- LIME -->
                        <div class="bg-purple-100 border border-purple-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-purple-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-microscope"></i>
                                LIME（Local Interpretable Model-agnostic Explanations）
                            </h4>
                            <p class="text-purple-900 text-sm">
                                個別予測の周辺で線形モデルを近似し、どの特徴量が予測を左右したかを説明します。モデルに依存しない（model-agnostic）手法です。
                            </p>
                        </div>

                        <!-- Partial Dependence Plot -->
                        <div class="bg-orange-100 border border-orange-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-orange-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-wave-square"></i>
                                Partial Dependence Plot（PDP）
                            </h4>
                            <p class="text-orange-900 text-sm">
                                特定の特徴量が変化したときに予測値がどう変わるかを可視化します。他の特徴量は平均化されます。特徴量と予測の関係性を理解するのに有効です。
                            </p>
                        </div>
                    </div>

                    <!-- 実習カード -->
                    <div class="bg-gradient-to-r from-purple-50 to-fuchsia-50 border border-purple-200
                                rounded-xl p-5 my-6 overflow-hidden">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-10 h-10 bg-purple-500 rounded-lg
                                        flex items-center justify-center">
                                <i class="fas fa-laptop-code text-white"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-purple-800 mb-3 break-words">実習: モデル解釈性の実践</h3>

                                <h4 class="text-purple-900 font-medium mb-2 break-words">手順:</h4>
                                <ol class="space-y-2 text-purple-900 list-decimal ml-5">
                                    <li class="break-words">Gradient Boostingモデルを構築（前セクションのコード参照）</li>
                                    <li class="break-words">Model Studioで「Model Interpretation」ノードを追加</li>
                                    <li class="break-words">Feature Importanceを確認し、上位5つの重要な特徴量をメモ</li>
                                    <li class="break-words">Partial Dependence Plotで、最も重要な特徴量の影響を可視化</li>
                                    <li class="break-words">SHAP値を使って、特定の顧客（例: 解約予測が高い顧客）の予測理由を分析</li>
                                    <li class="break-words">レポートを作成し、ビジネス担当者に説明できる形でまとめる</li>
                                </ol>

                                <h4 class="text-purple-900 font-medium mb-2 mt-4 break-words">期待される結果:</h4>
                                <p class="text-purple-800 text-sm break-words">
                                    「なぜこの顧客は解約リスクが高いのか」を具体的に説明できるようになります（例: 「契約期間が短く、サポート問い合わせが多いため」）。
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r-lg overflow-hidden">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-blue-900 font-medium break-words">ヒント</p>
                                <p class="text-blue-800 text-sm mt-1 break-words">
                                    規制の厳しい業界（金融、医療、人事など）では、モデルの説明可能性が法的要件になっている場合があります。モデル構築時から解釈性を考慮しましょう。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション5: クラス不均衡データへの対処 -->
                <section class="prose prose-slate max-w-none mb-8">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        9.5 クラス不均衡データへの対処法
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>クラス不均衡</strong>は、正例と負例の比率が大きく偏っているデータのことです（例: 解約率5%、詐欺率0.1%）。不均衡データでは、マジョリティクラスに偏った予測をしてしまう問題が発生します。
                    </p>

                    <h3 class="text-lg font-semibold text-slate-800 mt-6 mb-3">不均衡データの問題点</h3>
                    <ul class="space-y-2 text-slate-600 mb-4">
                        <li class="flex items-start gap-2">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                            <span><strong>マジョリティクラス偏重:</strong> 全て「解約しない」と予測しても正解率95%になってしまう</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                            <span><strong>マイノリティクラスの見逃し:</strong> 少数派（重要なケース）を検出できない</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                            <span><strong>評価指標の問題:</strong> 正解率（Accuracy）では性能を正しく評価できない</span>
                        </li>
                    </ul>

                    <h3 class="text-lg font-semibold text-slate-800 mt-6 mb-3">対処法の分類</h3>

                    <!-- Mermaid図: 不均衡データ対処法 -->
                    <div class="my-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">クラス不均衡データ対処法</h4>
                        <div class="mermaid">
flowchart TB
    Problem["クラス不均衡データ"] --> Approach["対処アプローチ"]

    Approach --> Data["データレベル"]
    Approach --> Algo["アルゴリズムレベル"]
    Approach --> Eval["評価指標変更"]

    Data --> OS["オーバーサンプリング<br/>（SMOTE）"]
    Data --> US["アンダーサンプリング"]
    Data --> Hybrid["ハイブリッド"]

    Algo --> Weight["クラス重み付け"]
    Algo --> Focal["Focal Loss"]
    Algo --> Ensemble["コスト考慮アンサンブル"]

    Eval --> Prec["Precision/Recall"]
    Eval --> F1["F1-Score"]
    Eval --> AUC["AUC-ROC"]
                        </div>
                    </div>

                    <div class="space-y-4 my-6">
                        <!-- SMOTE -->
                        <div class="bg-emerald-100 border border-emerald-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-emerald-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-clone"></i>
                                SMOTE（Synthetic Minority Over-sampling Technique）
                            </h4>
                            <p class="text-emerald-900 text-sm mb-2">
                                マイノリティクラスの既存サンプルから、新しい合成サンプルを生成してバランスを取ります。
                            </p>
                            <ul class="text-emerald-900 text-sm space-y-1 ml-6 list-disc">
                                <li><strong>メリット:</strong> 情報を失わずにバランス改善</li>
                                <li><strong>デメリット:</strong> ノイズも増幅される可能性</li>
                            </ul>
                        </div>

                        <!-- クラス重み付け -->
                        <div class="bg-blue-100 border border-blue-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-blue-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-balance-scale"></i>
                                クラス重み付け（Class Weighting）
                            </h4>
                            <p class="text-blue-900 text-sm mb-2">
                                マイノリティクラスの誤分類に大きなペナルティを与えることで、モデルがマイノリティクラスを重視するようにします。
                            </p>
                            <ul class="text-blue-900 text-sm space-y-1 ml-6 list-disc">
                                <li><strong>メリット:</strong> データを変更せずにアルゴリズム側で対処</li>
                                <li><strong>デメリット:</strong> 重みの設定が難しい</li>
                            </ul>
                        </div>

                        <!-- 評価指標 -->
                        <div class="bg-purple-100 border border-purple-200 rounded-lg p-4 overflow-hidden">
                            <h4 class="text-purple-900 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-chart-pie"></i>
                                適切な評価指標の選択
                            </h4>
                            <p class="text-purple-900 text-sm">
                                正解率（Accuracy）ではなく、Precision、Recall、F1-Score、AUC-ROCなど、クラス不均衡に頑健な指標を使用します。
                            </p>
                        </div>
                    </div>

                    <!-- コードブロック: SMOTEの実装 -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">smote_implementation.sas</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-sas">/* SMOTEによるオーバーサンプリング */
proc cas;
  dataPreprocess.smote /
    table={name="imbalanced_data"}
    target="Churn"
    k=5  /* 最近傍数 */
    oversamplePct=200  /* 200%にオーバーサンプリング */
    casout={name="balanced_data", replace=true};
quit;

/* バランス調整後のデータでモデル学習 */
proc gradboost data=mycaslib.balanced_data
    ntrees=300;
  target Churn / level=binary;
  input Age Income Tenure / level=interval;
  save model=mycaslib.smote_model;
run;</code></pre>
                    </div>

                    <div class="bg-red-50 border-l-4 border-red-500 p-4 my-6 rounded-r-lg overflow-hidden">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-circle text-red-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-red-900 font-medium break-words">注意事項</p>
                                <p class="text-red-800 text-sm mt-1 break-words">
                                    SMOTEは訓練データにのみ適用し、テストデータには適用しないでください。テストデータは現実の分布を反映する必要があります。また、過度なオーバーサンプリングは過学習を引き起こす可能性があります。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 章のまとめ -->
                <div class="bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200 rounded-xl p-6 my-8">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-check-circle text-primary-500"></i>
                        第9章のまとめ
                    </h3>
                    <ul class="space-y-2 text-slate-700">
                        <li class="flex items-start gap-2">
                            <i class="fas fa-arrow-right text-primary-500 mt-1 text-sm"></i>
                            <span>特徴量エンジニアリングはモデル性能向上の鍵である（変換、作成、選択）</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-arrow-right text-primary-500 mt-1 text-sm"></i>
                            <span>ハイパーパラメータチューニングで最適なモデル設定を探索できる（Grid Search、Random Search、Bayesian Optimization）</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-arrow-right text-primary-500 mt-1 text-sm"></i>
                            <span>アンサンブル学習により単一モデルより高精度を実現できる（Bagging、Boosting、Stacking）</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-arrow-right text-primary-500 mt-1 text-sm"></i>
                            <span>説明可能AI（XAI）でブラックボックスモデルの予測を解釈できる（SHAP、LIME、PDP）</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-arrow-right text-primary-500 mt-1 text-sm"></i>
                            <span>クラス不均衡データにはSMOTE、クラス重み付け、適切な評価指標で対処する</span>
                        </li>
                    </ul>
                </div>

                <!-- 理解度確認クイズ -->
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200
                            rounded-xl p-5 my-6 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-lg
                                    flex items-center justify-center">
                            <i class="fas fa-question text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-blue-800 mb-4 break-words">理解度確認クイズ</h3>
                            <ol class="space-y-4">
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q1. 特徴量エンジニアリングの3つの主要プロセスを挙げてください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            ①特徴量変換（標準化、正規化、エンコーディング）、②新規特徴量作成（多項式、交互作用項、集約統計量）、③特徴量選択（フィルタ法、ラッパー法、組み込み法）
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q2. BaggingとBoostingの主な違いは何ですか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            Baggingは複数のモデルを並列に訓練して結果を平均化し、分散を削減します。Boostingは弱学習器を逐次的に訓練し、前のモデルの誤りに重点を置いてバイアスを削減します。
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q3. SHAP（SHapley Additive exPlanations）の特徴と利点を説明してください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            SHAPはゲーム理論のShapley値に基づき、各特徴量が個別の予測にどれだけ貢献したかを定量化します。モデルに依存せず（model-agnostic）、理論的に裏付けられた信頼性の高い解釈手法です。
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q4. クラス不均衡データでAccuracy（正解率）を評価指標として使うべきでない理由を説明してください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            例えば解約率5%のデータで全て「解約しない」と予測しても正解率95%になってしまいます。これではマイノリティクラス（重要なケース）を全く検出できません。代わりにPrecision、Recall、F1-Score、AUC-ROCなどを使用すべきです。
                                        </p>
                                    </details>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 次のステップ -->
                <div class="bg-primary-50 border border-primary-200 rounded-xl p-6 my-8">
                    <h3 class="text-lg font-semibold text-primary-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-forward text-primary-600"></i>
                        次のステップ
                    </h3>
                    <p class="text-primary-900 mb-3">
                        第9章で高度な機械学習テクニックを習得しました。次の第10章では、これらの技術を活用して予測モデリングと時系列分析を実践します。
                    </p>
                    <ul class="space-y-2 text-primary-900">
                        <li class="flex items-start gap-2">
                            <i class="fas fa-circle text-primary-500 mt-1 text-xs"></i>
                            <span>回帰分析と分類モデルの実践</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-circle text-primary-500 mt-1 text-xs"></i>
                            <span>時系列予測の基礎と手法</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-circle text-primary-500 mt-1 text-xs"></i>
                            <span>SAS Visual Forecastingを使った需要予測・売上予測</span>
                        </li>
                    </ul>
                </div>

                <!-- 章間ナビゲーション -->
                <nav class="flex items-center justify-between pt-6 mt-6 border-t border-slate-200">
                    <a href="sas-viya-learning-material-08.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl
                              bg-slate-100 hover:bg-slate-200 transition-colors">
                        <i class="fas fa-arrow-left text-slate-400 group-hover:text-slate-600
                                  transition-transform group-hover:-translate-x-1"></i>
                        <div>
                            <span class="text-xs text-slate-500 block">前の章</span>
                            <span class="text-slate-700 font-medium">第8章: 機械学習（基礎）</span>
                        </div>
                    </a>
                    <a href="sas-viya-learning-material-10.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl
                              bg-primary-500 hover:bg-primary-600 text-white transition-colors">
                        <div class="text-right">
                            <span class="text-xs text-primary-100 block">次の章</span>
                            <span class="font-medium">第10章: 予測モデリングと時系列分析</span>
                        </div>
                        <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- フッター -->
    <footer class="bg-slate-800 text-slate-300">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <p class="text-sm text-center md:text-left">
                    &copy; 2025 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。
                </p>
                <div class="flex items-center gap-4">
                    <a href="https://github.com/fcircle-biz/tech_docs" class="hover:text-white transition-colors">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- スクロールトップボタン -->
    <button id="scroll-top-btn"
            class="fixed bottom-6 right-6 w-12 h-12 bg-primary-500 text-white rounded-full
                   shadow-lg hover:bg-primary-600 transition-all duration-300
                   opacity-0 invisible translate-y-4"
            onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- サイドバー生成 -->
    <script src="sidebar-content.js"></script>

    <!-- 共通JavaScript -->
    <script src="main.js"></script>

    <!-- 描画ツール -->
    <script src="drawing-tool.js"></script>
</body>
</html>
