<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL学習教材 第8章 - インデックスとパフォーマンス最適化</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #1976d2; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #1976d2; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #1976d2; padding-bottom: 0.5rem; }
        .section-title { color: #42a5f5; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container { background-color: #e1f5fe; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #1976d2; }
        .exercise-container { background-color: #f3e5f5; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #9c27b0; }
        .highlight { background-color: #ffecb3; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #ffc107; }
        .warning { background-color: #ffebee; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #f44336; }
        .code-block { background-color: #1e1e1e; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #1976d2 !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SQL学習教材</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-01.html">第1章: 基礎概念</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-02.html">第2章: データ型</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-03.html">第3章: CRUD操作</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-04.html">第4章: SELECT文の詳細</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-05.html">第5章: 結合（JOIN）</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-06.html">第6章: 集計とグループ化</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-07.html">第7章: サブクエリ</a></li>
                        <li class="nav-item"><a class="nav-link active" href="sql-learning-material-08.html">第8章: パフォーマンス</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-09.html">第9章: トランザクション</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-10.html">第10章: DB設計</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第8章: インデックスとパフォーマンス最適化</h1>
                </div>

                <div id="chapter8">
                    <h2 class="chapter-title">インデックスとパフォーマンス最適化</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>インデックスの仕組みと種類</li>
                            <li>インデックスの作成と削除</li>
                            <li>実行計画の読み方と分析</li>
                            <li>クエリの最適化技法</li>
                            <li>パフォーマンス監視とチューニング</li>
                        </ul>
                    </div>

                    <h3 class="section-title">8.1 インデックスの基本概念</h3>
                    <p>インデックスは、テーブルのデータを効率的に検索するための仕組みです。書籍の索引と同様に、データの場所を素早く特定できます。</p>

                    <div class="exercise-container">
                        <h5>実習 8-1: インデックスの作成と確認</h5>
                        <pre class="code-block"><code class="language-sql">-- インデックスの作成
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_customers_email ON customers(email);
CREATE INDEX idx_orders_customer_date ON orders(customer_id, order_date);

-- 複合インデックスの作成
CREATE INDEX idx_products_category_price ON products(category_id, price);

-- 一意インデックス
CREATE UNIQUE INDEX idx_products_code_unique ON products(product_code);

-- インデックス一覧の確認
SELECT schemaname, tablename, indexname, indexdef 
FROM pg_indexes 
WHERE tablename IN ('products', 'customers', 'orders');

-- インデックスのサイズ確認
SELECT 
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes;</code></pre>
                    </div>

                    <h3 class="section-title">8.2 実行計画の確認</h3>
                    <p>EXPLAIN文を使用してクエリの実行計画を確認し、パフォーマンスを分析します。</p>

                    <div class="exercise-container">
                        <h5>実習 8-2: 実行計画の分析</h5>
                        <pre class="code-block"><code class="language-sql">-- 実行計画の確認
EXPLAIN SELECT * FROM products WHERE price > 5000;

-- 詳細な実行計画（実際のコストと実行時間）
EXPLAIN (ANALYZE, BUFFERS) 
SELECT p.product_name, c.category_name 
FROM products p
JOIN categories c ON p.category_id = c.category_id
WHERE p.price BETWEEN 1000 AND 10000;

-- インデックス使用の確認
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM customers WHERE email = 'tanaka@example.com';

-- 結合のパフォーマンス分析
EXPLAIN (ANALYZE, BUFFERS)
SELECT c.name, COUNT(o.order_id) as order_count
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.name
HAVING COUNT(o.order_id) > 1;</code></pre>
                    </div>

                    <h3 class="section-title">8.3 クエリ最適化技法</h3>
                    <div class="warning">
                        <h6>パフォーマンス最適化のポイント</h6>
                        <ul>
                            <li><strong>WHERE句の最適化</strong>: 選択性の高い条件を最初に配置</li>
                            <li><strong>不要なカラムの除外</strong>: SELECT * を避け、必要な列のみ指定</li>
                            <li><strong>適切なJOIN</strong>: 結合順序とJOIN種類の最適化</li>
                            <li><strong>LIMIT句の活用</strong>: 大量データの取得制限</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 8-3: クエリの最適化</h5>
                        <pre class="code-block"><code class="language-sql">-- 最適化前：非効率なクエリ
SELECT * 
FROM products p, categories c, orders o
WHERE p.category_id = c.category_id
AND p.product_id = o.product_id
AND p.price > 1000;

-- 最適化後：効率的なクエリ
SELECT p.product_name, c.category_name, SUM(o.quantity) as total_sold
FROM products p
INNER JOIN categories c ON p.category_id = c.category_id
INNER JOIN orders o ON p.product_id = o.product_id
WHERE p.price > 1000
GROUP BY p.product_id, p.product_name, c.category_name
ORDER BY total_sold DESC
LIMIT 20;

-- インデックスを活用した範囲検索
SELECT product_name, price FROM products 
WHERE price BETWEEN 5000 AND 15000 
AND category_id = 1
ORDER BY price;</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>問題1:</strong> インデックスを作成する主な目的は何ですか？</li>
                            <li><strong>問題2:</strong> 複合インデックスを作成する際の列の順序が重要な理由は？</li>
                            <li><strong>問題3:</strong> EXPLAIN文で確認できる情報には何がありますか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を表示</summary>
                            <div class="mt-2">
                                <strong>解答:</strong>
                                <ol>
                                    <li>データの検索速度を向上させるため</li>
                                    <li>検索条件で使用される頻度や選択性を考慮して、効率的なインデックススキャンを実現するため</li>
                                    <li>実行計画、コスト、実行時間、使用されるインデックスなど</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="sql-learning-material-07.html" class="btn btn-secondary">← 前の章: サブクエリ</a>
                        <a href="sql-learning-material-09.html" class="btn btn-primary">次の章: トランザクション →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>