<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL学習教材 第9章 - トランザクションとデータの整合性</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #1976d2; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #1976d2; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #1976d2; padding-bottom: 0.5rem; }
        .section-title { color: #42a5f5; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container { background-color: #e1f5fe; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #1976d2; }
        .exercise-container { background-color: #f3e5f5; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #9c27b0; }
        .highlight { background-color: #ffecb3; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #ffc107; }
        .warning { background-color: #ffebee; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #f44336; }
        .code-block { background-color: #1e1e1e; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #1976d2 !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SQL学習教材</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-01.html">第1章: 基礎概念</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-02.html">第2章: データ型</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-03.html">第3章: CRUD操作</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-04.html">第4章: SELECT文の詳細</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-05.html">第5章: 結合（JOIN）</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-06.html">第6章: 集計とグループ化</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-07.html">第7章: サブクエリ</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-08.html">第8章: パフォーマンス</a></li>
                        <li class="nav-item"><a class="nav-link active" href="sql-learning-material-09.html">第9章: トランザクション</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-10.html">第10章: DB設計</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第9章: トランザクションとデータの整合性</h1>
                </div>

                <div id="chapter9">
                    <h2 class="chapter-title">トランザクションとデータの整合性</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>トランザクションの基本概念とACID特性</li>
                            <li>BEGIN、COMMIT、ROLLBACKの使用方法</li>
                            <li>制約による整合性の保持</li>
                            <li>分離レベルとロック機構</li>
                            <li>実践的なトランザクション処理</li>
                        </ul>
                    </div>

                    <h3 class="section-title">9.1 トランザクションとACID特性</h3>
                    <p>トランザクションは、一連のデータベース操作をひとつの論理単位として扱う仕組みです。</p>

                    <h4>ACID特性</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white"><h6>原子性（Atomicity）</h6></div>
                                <div class="card-body"><p>トランザクション内の処理は全て実行されるか、全て実行されない</p></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white"><h6>一貫性（Consistency）</h6></div>
                                <div class="card-body"><p>データベースの整合性制約を常に満たす</p></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white"><h6>独立性（Isolation）</h6></div>
                                <div class="card-body"><p>同時実行される他のトランザクションから影響を受けない</p></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-warning text-white"><h6>持続性（Durability）</h6></div>
                                <div class="card-body"><p>コミットされた変更は永続的に保存される</p></div>
                            </div>
                        </div>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 9-1: 基本的なトランザクション制御</h5>
                        <pre class="code-block"><code class="language-sql">-- トランザクションの開始
BEGIN;

-- 複数の操作を実行
INSERT INTO customers (name, email) VALUES ('新規顧客', 'new@example.com');
UPDATE products SET stock_quantity = stock_quantity - 1 WHERE product_id = 1;
INSERT INTO orders (customer_id, product_id, quantity) VALUES (CURRVAL('customers_customer_id_seq'), 1, 1);

-- 正常終了の場合
COMMIT;

-- 異常時のロールバック例
BEGIN;
UPDATE products SET price = price * 1.1;  -- 10%値上げ
-- 何らかのエラーが発生した場合
ROLLBACK;  -- 変更を取り消し

-- セーブポイントの使用
BEGIN;
INSERT INTO categories (category_name) VALUES ('新カテゴリ1');
SAVEPOINT sp1;
INSERT INTO categories (category_name) VALUES ('新カテゴリ2');
SAVEPOINT sp2;
-- エラーが発生
ROLLBACK TO sp1;  -- sp1まで戻る
COMMIT;</code></pre>
                    </div>

                    <h3 class="section-title">9.2 制約による整合性保持</h3>
                    <p>データベース制約は、データの整合性を自動的に保証する重要な仕組みです。</p>

                    <div class="exercise-container">
                        <h5>実習 9-2: 各種制約の活用</h5>
                        <pre class="code-block"><code class="language-sql">-- CHECK制約の詳細例
CREATE TABLE accounts (
    account_id SERIAL PRIMARY KEY,
    account_number VARCHAR(20) UNIQUE NOT NULL,
    balance DECIMAL(15,2) DEFAULT 0,
    status VARCHAR(10) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT chk_balance_positive CHECK (balance >= 0),
    CONSTRAINT chk_valid_status CHECK (status IN ('active', 'inactive', 'suspended'))
);

-- 外部キー制約でのCASCADE設定
CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    quantity INTEGER CHECK (quantity > 0),
    unit_price DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE RESTRICT
);

-- 制約違反のテスト
BEGIN;
INSERT INTO accounts (account_number, balance) VALUES ('ACC001', -100);  -- エラー：残高負数
ROLLBACK;</code></pre>
                    </div>

                    <h3 class="section-title">9.3 実践的なトランザクション処理</h3>
                    <p>実際のビジネス処理を想定した複合トランザクションを実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 9-3: 注文処理トランザクション</h5>
                        <pre class="code-block"><code class="language-sql">-- 注文処理の複合トランザクション
CREATE OR REPLACE FUNCTION process_order(
    p_customer_id INTEGER,
    p_product_id INTEGER,
    p_quantity INTEGER
) RETURNS BOOLEAN AS $$
DECLARE
    v_stock INTEGER;
    v_price DECIMAL(10,2);
    v_order_id INTEGER;
BEGIN
    -- トランザクション開始（関数内では自動的に開始）
    
    -- 在庫確認
    SELECT stock_quantity, price INTO v_stock, v_price
    FROM products 
    WHERE product_id = p_product_id FOR UPDATE;
    
    IF v_stock < p_quantity THEN
        RAISE EXCEPTION '在庫不足: 必要=%、在庫=%', p_quantity, v_stock;
    END IF;
    
    -- 注文レコード作成
    INSERT INTO orders (customer_id, product_id, quantity, status)
    VALUES (p_customer_id, p_product_id, p_quantity, 'processing')
    RETURNING order_id INTO v_order_id;
    
    -- 在庫減算
    UPDATE products 
    SET stock_quantity = stock_quantity - p_quantity,
        updated_at = NOW()
    WHERE product_id = p_product_id;
    
    -- 処理完了
    UPDATE orders 
    SET status = 'confirmed' 
    WHERE order_id = v_order_id;
    
    RETURN TRUE;
EXCEPTION
    WHEN OTHERS THEN
        -- エラー時は自動的にロールバック
        RAISE;
        RETURN FALSE;
END;
$$ LANGUAGE plpgsql;

-- 関数の実行
SELECT process_order(1, 1, 2);</code></pre>
                    </div>

                    <div class="warning">
                        <h6>トランザクション処理の注意点</h6>
                        <ul>
                            <li><strong>デッドロック</strong>: 複数のトランザクションが互いの資源を待機する状況を避ける</li>
                            <li><strong>長時間トランザクション</strong>: ロックによる他の処理への影響を最小化</li>
                            <li><strong>適切な分離レベル</strong>: 要件に応じた分離レベルの選択</li>
                            <li><strong>エラーハンドリング</strong>: 適切な例外処理とロールバック</li>
                        </ul>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>問題1:</strong> ACID特性の4つの要素を説明してください。</li>
                            <li><strong>問題2:</strong> COMMITとROLLBACKの違いは何ですか？</li>
                            <li><strong>問題3:</strong> 外部キー制約でCASCADEオプションを使用する場合の影響は？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を表示</summary>
                            <div class="mt-2">
                                <strong>解答:</strong>
                                <ol>
                                    <li>原子性（全実行か全不実行）、一貫性（整合性維持）、独立性（他トランザクション非干渉）、持続性（永続保存）</li>
                                    <li>COMMIT：変更を確定・永続化、ROLLBACK：変更を取り消し・初期状態に戻す</li>
                                    <li>参照元レコード削除時に参照先レコードも自動削除される</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="sql-learning-material-08.html" class="btn btn-secondary">← 前の章: パフォーマンス</a>
                        <a href="sql-learning-material-10.html" class="btn btn-primary">次の章: DB設計 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>