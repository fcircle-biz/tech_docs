<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL学習教材 第4章 - SELECT文の詳細とデータの絞り込み</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #1976d2;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #1976d2;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #42a5f5;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #1976d2;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #1976d2 !important;
            color: white !important;
        }
        
        .operator-table th {
            background-color: #1976d2;
            color: white;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SQL学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../README.md">ガイドTOP</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-1.html">第1章: 基礎概念</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-2.html">第2章: データ型</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-3.html">第3章: CRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="sql-learning-material-4.html">第4章: SELECT文の詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-5.html">第5章: 結合（JOIN）</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-6.html">第6章: 集計とグループ化</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-7.html">第7章: サブクエリ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-8.html">第8章: パフォーマンス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-9.html">第9章: トランザクション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-10.html">第10章: DB設計</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第4章: SELECT文の詳細とデータの絞り込み</h1>
                </div>

                <div id="chapter4">
                    <h2 class="chapter-title">SELECT文の詳細とデータの絞り込み</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>WHERE句による条件指定の詳細</li>
                            <li>比較演算子と論理演算子の活用</li>
                            <li>LIKE演算子によるパターン検索</li>
                            <li>ORDER BY句によるソート機能</li>
                            <li>LIMIT句とOFFSET句による結果の制限</li>
                            <li>複合条件での効率的なデータ検索</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.1 WHERE句による条件指定</h3>
                    <p>
                        WHERE句は、テーブルから必要なレコードだけを選択するために使用します。
                        効率的なクエリを作成するために最も重要な要素の一つです。
                    </p>

                    <div class="mermaid">
                        flowchart TD
                            A[SELECT文] --> B[SELECT 列名]
                            A --> C[FROM テーブル名]
                            A --> D[WHERE 条件]
                            A --> E[ORDER BY]
                            A --> F[LIMIT]
                            
                            D --> G[比較演算子]
                            D --> H[論理演算子]
                            D --> I[LIKE検索]
                            D --> J[NULL検査]
                    </div>

                    <h4>基本的な比較演算子</h4>
                    <div class="table-responsive">
                        <table class="table operator-table">
                            <thead>
                                <tr>
                                    <th>演算子</th>
                                    <th>意味</th>
                                    <th>例</th>
                                    <th>説明</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>=</td>
                                    <td>等しい</td>
                                    <td>price = 1000</td>
                                    <td>価格が1000と等しい</td>
                                </tr>
                                <tr>
                                    <td>&lt;&gt; または !=</td>
                                    <td>等しくない</td>
                                    <td>status &lt;&gt; 'deleted'</td>
                                    <td>ステータスが'deleted'ではない</td>
                                </tr>
                                <tr>
                                    <td>&lt;</td>
                                    <td>より小さい</td>
                                    <td>age &lt; 30</td>
                                    <td>年齢が30未満</td>
                                </tr>
                                <tr>
                                    <td>&gt;</td>
                                    <td>より大きい</td>
                                    <td>salary &gt; 300000</td>
                                    <td>給与が300000より多い</td>
                                </tr>
                                <tr>
                                    <td>&lt;=</td>
                                    <td>以下</td>
                                    <td>stock_quantity &lt;= 10</td>
                                    <td>在庫数が10以下</td>
                                </tr>
                                <tr>
                                    <td>&gt;=</td>
                                    <td>以上</td>
                                    <td>created_at &gt;= '2024-01-01'</td>
                                    <td>2024年1月1日以降に作成</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 4-1: 比較演算子を使った条件指定</h5>
                        <p>様々な比較演算子を使ってデータを絞り込んでみます。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 価格が3000円以上の商品
SELECT product_name, price FROM products 
WHERE price >= 3000;

-- 在庫数が20未満の商品
SELECT product_name, stock_quantity FROM products 
WHERE stock_quantity < 20;

-- 特定のカテゴリではない商品
SELECT product_name, category_id FROM products 
WHERE category_id <> 1;

-- 日付範囲での検索（2024年以降に作成された顧客）
SELECT name, created_at FROM customers 
WHERE created_at >= '2024-01-01';

-- NULL値の検索
SELECT * FROM customers WHERE phone IS NULL;
SELECT * FROM customers WHERE phone IS NOT NULL;</code></pre>
                    </div>

                    <h3 class="section-title">4.2 論理演算子による複合条件</h3>
                    <p>
                        複数の条件を組み合わせる場合は、論理演算子を使用します。
                        AND、OR、NOTを適切に使い分けることで、複雑な条件も表現できます。
                    </p>

                    <h4>論理演算子の種類</h4>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6>AND演算子</h6>
                                </div>
                                <div class="card-body">
                                    <p>全ての条件が真の場合のみ真</p>
                                    <small>条件1 AND 条件2</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6>OR演算子</h6>
                                </div>
                                <div class="card-body">
                                    <p>いずれかの条件が真の場合に真</p>
                                    <small>条件1 OR 条件2</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header bg-warning text-white">
                                    <h6>NOT演算子</h6>
                                </div>
                                <div class="card-body">
                                    <p>条件の真偽を反転</p>
                                    <small>NOT 条件1</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 4-2: 論理演算子による複合条件</h5>
                        <p>複数の条件を組み合わせた検索を実行します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- AND演算子：価格が1000円以上かつ3000円以下の商品
SELECT product_name, price FROM products 
WHERE price >= 1000 AND price <= 3000;

-- OR演算子：カテゴリ1または2の商品
SELECT product_name, category_id FROM products 
WHERE category_id = 1 OR category_id = 2;

-- NOT演算子：削除されていない商品
SELECT product_name, is_active FROM products 
WHERE NOT (is_active = false);

-- 複合条件：価格が2000円以上で、かつ在庫が10個以上の商品
SELECT product_name, price, stock_quantity FROM products 
WHERE price >= 2000 AND stock_quantity >= 10;

-- 括弧を使った条件の優先順位制御
SELECT product_name, price, category_id FROM products 
WHERE (category_id = 1 OR category_id = 2) AND price > 2000;</code></pre>
                    </div>

                    <h3 class="section-title">4.3 BETWEEN、IN演算子</h3>
                    <p>
                        範囲指定や複数値との比較では、専用の演算子を使用すると
                        より読みやすいクエリを作成できます。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 4-3: BETWEEN、IN演算子の活用</h5>
                        <p>範囲指定や複数値検索の効率的な記述方法を学習します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- BETWEEN演算子：価格が1000円から3000円の範囲
SELECT product_name, price FROM products 
WHERE price BETWEEN 1000 AND 3000;
-- これは以下と同じ意味
-- WHERE price >= 1000 AND price <= 3000

-- IN演算子：特定の値のいずれかに一致
SELECT product_name, category_id FROM products 
WHERE category_id IN (1, 2, 3);
-- これは以下と同じ意味
-- WHERE category_id = 1 OR category_id = 2 OR category_id = 3

-- NOT IN演算子：特定の値以外
SELECT product_name, category_id FROM products 
WHERE category_id NOT IN (1, 4);

-- 日付の範囲指定
SELECT name, created_at FROM customers 
WHERE created_at BETWEEN '2024-01-01' AND '2024-12-31';

-- 文字列での範囲指定（辞書順）
SELECT product_name FROM products 
WHERE product_name BETWEEN 'A' AND 'P';</code></pre>
                    </div>

                    <h3 class="section-title">4.4 LIKE演算子によるパターン検索</h3>
                    <p>
                        LIKE演算子は文字列の部分一致検索に使用します。
                        ワイルドカード文字と組み合わせて柔軟な検索が可能です。
                    </p>

                    <h4>ワイルドカード文字</h4>
                    <div class="table-responsive">
                        <table class="table operator-table">
                            <thead>
                                <tr>
                                    <th>記号</th>
                                    <th>意味</th>
                                    <th>例</th>
                                    <th>マッチする例</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>%</td>
                                    <td>0文字以上の任意文字列</td>
                                    <td>'田%'</td>
                                    <td>田中、田村、田</td>
                                </tr>
                                <tr>
                                    <td>_</td>
                                    <td>任意の1文字</td>
                                    <td>'田_'</td>
                                    <td>田中、田村（2文字のみ）</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 4-4: LIKE演算子によるパターン検索</h5>
                        <p>様々なパターンマッチングを実行してみます。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 前方一致：「ノート」で始まる商品名
SELECT product_name FROM products 
WHERE product_name LIKE 'ノート%';

-- 後方一致：「書」で終わる商品名
SELECT product_name FROM products 
WHERE product_name LIKE '%書';

-- 部分一致：「コーヒー」を含む商品名
SELECT product_name FROM products 
WHERE product_name LIKE '%コーヒー%';

-- メールアドレスのドメイン検索
SELECT name, email FROM customers 
WHERE email LIKE '%@example.com';

-- 特定パターン：商品コードが「PRD」で始まり、数字が続く
SELECT product_code, product_name FROM products 
WHERE product_code LIKE 'PRD%';

-- NOT LIKE：特定パターンを除外
SELECT product_name FROM products 
WHERE product_name NOT LIKE '%書%';

-- 大文字小文字を区別しない検索（PostgreSQL）
SELECT product_name FROM products 
WHERE product_name ILIKE '%coffee%';</code></pre>
                    </div>

                    <h3 class="section-title">4.5 ORDER BY句による結果のソート</h3>
                    <p>
                        ORDER BY句を使用して、クエリ結果を指定した列で並び替えることができます。
                        昇順（ASC）または降順（DESC）を選択可能です。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 4-5: ORDER BY句によるソート</h5>
                        <p>様々なソート方法を実行してみます。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 価格の昇順（安い順）
SELECT product_name, price FROM products 
ORDER BY price ASC;  -- ASCは省略可能

-- 価格の降順（高い順）
SELECT product_name, price FROM products 
ORDER BY price DESC;

-- 複数列でのソート：カテゴリ昇順、その中で価格降順
SELECT product_name, category_id, price FROM products 
ORDER BY category_id ASC, price DESC;

-- 文字列のソート（五十音順）
SELECT name FROM customers 
ORDER BY name;

-- 日付のソート（新しい順）
SELECT name, created_at FROM customers 
ORDER BY created_at DESC;

-- NULLの扱い（PostgreSQLではNULLは最後に表示）
SELECT name, phone FROM customers 
ORDER BY phone NULLS FIRST;  -- NULLを最初に表示

-- 列番号でのソート（あまり推奨されない）
SELECT product_name, price FROM products 
ORDER BY 2 DESC;  -- 2番目の列（price）で降順</code></pre>
                    </div>

                    <h3 class="section-title">4.6 LIMIT句とOFFSET句によるページング</h3>
                    <p>
                        大量のデータを扱う際は、LIMIT句で取得件数を制限し、
                        OFFSET句でページング機能を実現できます。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 4-6: LIMIT句とOFFSET句の活用</h5>
                        <p>結果の制限とページング機能を実装します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 最初の3件のみを取得
SELECT product_name, price FROM products 
ORDER BY price 
LIMIT 3;

-- 4件目から3件を取得（2ページ目の表示）
SELECT product_name, price FROM products 
ORDER BY price 
LIMIT 3 OFFSET 3;

-- 価格の高い商品TOP5
SELECT product_name, price FROM products 
ORDER BY price DESC 
LIMIT 5;

-- ページング処理の例
-- 1ページ目（1-10件目）
SELECT product_name, price FROM products 
ORDER BY product_id 
LIMIT 10 OFFSET 0;

-- 2ページ目（11-20件目）
SELECT product_name, price FROM products 
ORDER BY product_id 
LIMIT 10 OFFSET 10;

-- 3ページ目（21-30件目）
SELECT product_name, price FROM products 
ORDER BY product_id 
LIMIT 10 OFFSET 20;</code></pre>
                    </div>

                    <h3 class="section-title">4.7 複合条件の実践例</h3>
                    <p>
                        実際のビジネスシナリオを想定した複雑な検索条件を作成してみましょう。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 4-7: 複合条件による高度な検索</h5>
                        <p>実践的な検索クエリを作成します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- ビジネス要件：在庫が少ない高価格商品を優先的にチェック
SELECT 
    product_name,
    price,
    stock_quantity,
    category_id
FROM products 
WHERE price >= 5000 
  AND stock_quantity <= 15 
  AND is_active = true
ORDER BY stock_quantity ASC, price DESC;

-- 顧客検索：メールアドレスが設定済みで、今年登録された顧客
SELECT 
    name,
    email,
    created_at
FROM customers 
WHERE email IS NOT NULL 
  AND email <> ''
  AND created_at >= '2024-01-01'
ORDER BY created_at DESC;

-- 商品検索：特定カテゴリで、名前に特定キーワードを含む商品
SELECT 
    product_code,
    product_name,
    price,
    stock_quantity
FROM products 
WHERE category_id IN (1, 2) 
  AND (product_name LIKE '%パソコン%' OR product_name LIKE '%書籍%')
  AND price BETWEEN 1000 AND 50000
ORDER BY category_id, price;

-- 月別売上分析用：特定期間の注文データ
SELECT 
    o.order_id,
    c.name AS customer_name,
    p.product_name,
    p.price,
    o.quantity,
    (p.price * o.quantity) AS total_amount,
    o.order_date
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
JOIN products p ON o.product_id = p.product_id
WHERE o.order_date BETWEEN '2024-01-01' AND '2024-12-31'
  AND o.status IN ('confirmed', 'completed')
ORDER BY o.order_date DESC, total_amount DESC;</code></pre>
                    </div>

                    <div class="warning">
                        <h6>SELECT文の最適化のポイント</h6>
                        <ul>
                            <li><strong>必要な列のみ選択</strong>: SELECT * は避け、必要な列を明示的に指定</li>
                            <li><strong>WHERE句の最適化</strong>: インデックスが使われる条件を優先的に配置</li>
                            <li><strong>LIMIT句の活用</strong>: 大量データの場合は必ず件数制限を設定</li>
                            <li><strong>ORDER BYの考慮</strong>: ソートは処理コストが高いため、必要な場合のみ使用</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>問題1:</strong> 価格が1000円以上3000円以下の商品を検索するSQL文として、正しいのはどれですか？
                                <br>a) WHERE price > 1000 AND price < 3000
                                <br>b) WHERE price BETWEEN 1000 AND 3000
                                <br>c) WHERE price >= 1000 AND price <= 3000
                                <br>d) b) と c) の両方
                            </li>
                            <li>
                                <strong>問題2:</strong> 名前が「田」で始まる顧客を検索するLIKE演算子の正しい使用法は？
                                <br>a) WHERE name LIKE '田%'
                                <br>b) WHERE name LIKE '%田'
                                <br>c) WHERE name LIKE '%田%'
                                <br>d) WHERE name LIKE '田_'
                            </li>
                            <li>
                                <strong>問題3:</strong> 以下のSQL文の実行結果は何件になりますか？
                                <pre class="code-block"><code class="language-sql">SELECT * FROM products 
WHERE category_id IN (1, 2) 
LIMIT 5 OFFSET 3;</code></pre>
                                <small>ヒント: カテゴリ1, 2に10件のレコードがあるとして</small>
                            </li>
                            <li>
                                <strong>問題4:</strong> NULL値を検索する正しいSQL文は？
                                <br>a) WHERE phone = NULL
                                <br>b) WHERE phone IS NULL  
                                <br>c) WHERE phone == NULL
                                <br>d) WHERE phone LIKE NULL
                            </li>
                            <li>
                                <strong>問題5:</strong> ORDER BY句を使わずに結果の順序は保証されますか？理由も含めて答えてください。
                            </li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を表示</summary>
                            <div class="mt-2">
                                <strong>解答:</strong>
                                <ol>
                                    <li>d) b) と c) の両方（BETWEENは境界値を含む、ANDを使った条件も同じ結果）</li>
                                    <li>a) WHERE name LIKE '田%'（前方一致検索）</li>
                                    <li>5件（OFFSET 3で4件目から始まり、LIMIT 5で最大5件まで取得）</li>
                                    <li>b) WHERE phone IS NULL（NULLの比較にはIS/IS NOTを使用）</li>
                                    <li>いいえ、保証されません。リレーショナルデータベースでは、ORDER BY句がない限り結果の順序は不定です</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="sql-learning-material-3.html" class="btn btn-secondary">← 前の章: CRUD操作</a>
                        <a href="sql-learning-material-5.html" class="btn btn-primary">次の章: 結合（JOIN） →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>