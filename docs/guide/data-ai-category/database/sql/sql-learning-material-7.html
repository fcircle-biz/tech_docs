<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL学習教材 第7章 - サブクエリと高度なクエリ技法</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #1976d2;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #1976d2;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #42a5f5;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #1976d2;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #1976d2 !important;
            color: white !important;
        }
        
        .subquery-type {
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .scalar-subquery { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        .table-subquery { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        .correlated-subquery { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .exists-subquery { background-color: #f3e5f5; border-left: 4px solid #9c27b0; }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SQL学習教材</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../README.md">ガイドTOP</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-01.html">第1章: 基礎概念</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-02.html">第2章: データ型</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-03.html">第3章: CRUD操作</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-04.html">第4章: SELECT文の詳細</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-05.html">第5章: 結合（JOIN）</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-06.html">第6章: 集計とグループ化</a></li>
                        <li class="nav-item"><a class="nav-link active" href="sql-learning-material-07.html">第7章: サブクエリ</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-08.html">第8章: パフォーマンス</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-09.html">第9章: トランザクション</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-10.html">第10章: DB設計</a></li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: サブクエリと高度なクエリ技法</h1>
                </div>

                <div id="chapter7">
                    <h2 class="chapter-title">サブクエリと高度なクエリ技法</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>サブクエリの基本概念と種類</li>
                            <li>スカラーサブクエリとテーブルサブクエリ</li>
                            <li>相関サブクエリの理解と活用</li>
                            <li>EXISTS句による存在チェック</li>
                            <li>WITH句（CTE）による可読性の高いクエリ作成</li>
                            <li>ウィンドウ関数の基本</li>
                        </ul>
                    </div>

                    <h3 class="section-title">7.1 サブクエリの基本概念</h3>
                    <p>
                        サブクエリは、SQL文の中に埋め込まれた別のSELECT文です。
                        メインクエリの条件として使用し、複雑な検索条件を表現できます。
                    </p>

                    <div class="mermaid">
                        flowchart TD
                            A[メインクエリ] --> B[サブクエリ1]
                            A --> C[サブクエリ2]
                            B --> D[結果1]
                            C --> E[結果2]
                            D --> F[最終結果]
                            E --> F
                    </div>

                    <h4>サブクエリの種類</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="scalar-subquery">
                                <h6><strong>スカラーサブクエリ</strong></h6>
                                <p>単一の値を返すサブクエリ</p>
                                <small>SELECT, WHERE句で使用</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="table-subquery">
                                <h6><strong>テーブルサブクエリ</strong></h6>
                                <p>複数の行・列を返すサブクエリ</p>
                                <small>FROM句、IN演算子で使用</small>
                            </div>
                        </div>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 7-1: 基本的なサブクエリ</h5>
                        <p>スカラーサブクエリとテーブルサブクエリの基本的な使用方法を学習します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- スカラーサブクエリ：平均価格より高い商品
SELECT 
    product_name,
    price,
    (SELECT AVG(price) FROM products) AS average_price
FROM products 
WHERE price > (SELECT AVG(price) FROM products)
ORDER BY price DESC;

-- IN演算子でのサブクエリ：注文がある商品のみ
SELECT 
    product_name,
    price
FROM products 
WHERE product_id IN (
    SELECT DISTINCT product_id 
    FROM orders
)
ORDER BY price;

-- FROM句でのサブクエリ：カテゴリ別平均価格
SELECT 
    category_avg.category_id,
    c.category_name,
    category_avg.avg_price,
    category_avg.product_count
FROM (
    SELECT 
        category_id,
        AVG(price) AS avg_price,
        COUNT(*) AS product_count
    FROM products
    GROUP BY category_id
) category_avg
JOIN categories c ON category_avg.category_id = c.category_id
ORDER BY category_avg.avg_price DESC;</code></pre>
                    </div>

                    <h3 class="section-title">7.2 相関サブクエリ</h3>
                    <div class="correlated-subquery">
                        <h6><strong>相関サブクエリ</strong></h6>
                        <p>外部クエリの値を参照するサブクエリ。外部クエリの各行に対して実行されます。</p>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 7-2: 相関サブクエリの活用</h5>
                        <p>外部クエリの値を参照する相関サブクエリを使った複雑な条件検索を実行します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 各カテゴリ内で平均価格より高い商品
SELECT 
    p1.product_name,
    p1.price,
    c.category_name
FROM products p1
JOIN categories c ON p1.category_id = c.category_id
WHERE p1.price > (
    SELECT AVG(p2.price)
    FROM products p2 
    WHERE p2.category_id = p1.category_id
)
ORDER BY c.category_name, p1.price DESC;

-- 最後に注文した日付を取得
SELECT 
    c.name,
    c.email,
    (SELECT MAX(o.order_date) 
     FROM orders o 
     WHERE o.customer_id = c.customer_id) AS last_order_date
FROM customers c
ORDER BY last_order_date DESC NULLS LAST;

-- 各顧客の注文回数を表示
SELECT 
    c.name,
    (SELECT COUNT(*) 
     FROM orders o 
     WHERE o.customer_id = c.customer_id) AS order_count
FROM customers c
ORDER BY order_count DESC;</code></pre>
                    </div>

                    <h3 class="section-title">7.3 EXISTS句による存在チェック</h3>
                    <div class="exists-subquery">
                        <h6><strong>EXISTS句</strong></h6>
                        <p>サブクエリが1行以上の結果を返すかどうかをチェック。TRUE/FALSEを返します。</p>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 7-3: EXISTS句の使用</h5>
                        <p>EXISTS、NOT EXISTSを使った効率的な存在チェッククエリを作成します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 注文履歴がある顧客
SELECT 
    c.name,
    c.email,
    c.created_at
FROM customers c
WHERE EXISTS (
    SELECT 1 
    FROM orders o 
    WHERE o.customer_id = c.customer_id
)
ORDER BY c.name;

-- 注文履歴がない顧客
SELECT 
    c.name,
    c.email,
    c.created_at
FROM customers c
WHERE NOT EXISTS (
    SELECT 1 
    FROM orders o 
    WHERE o.customer_id = c.customer_id
)
ORDER BY c.created_at DESC;

-- 売れたことがない商品
SELECT 
    p.product_name,
    p.price,
    p.stock_quantity
FROM products p
WHERE NOT EXISTS (
    SELECT 1 
    FROM orders o 
    WHERE o.product_id = p.product_id
)
ORDER BY p.price DESC;</code></pre>
                    </div>

                    <h3 class="section-title">7.4 WITH句（CTE）による可読性向上</h3>
                    <p>
                        WITH句（Common Table Expression）を使用すると、
                        複雑なクエリを段階的に構築し、可読性を向上させることができます。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 7-4: WITH句（CTE）の活用</h5>
                        <p>WITH句を使って複雑な分析クエリを見やすく構造化します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 顧客別売上分析（WITH句使用）
WITH customer_orders AS (
    SELECT 
        c.customer_id,
        c.name,
        c.email,
        COUNT(o.order_id) AS order_count,
        SUM(p.price * o.quantity) AS total_spent,
        AVG(p.price * o.quantity) AS avg_order_value,
        MAX(o.order_date) AS last_order_date
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
    LEFT JOIN products p ON o.product_id = p.product_id
    GROUP BY c.customer_id, c.name, c.email
),
customer_segments AS (
    SELECT 
        *,
        CASE 
            WHEN total_spent >= 50000 THEN 'VIP'
            WHEN total_spent >= 20000 THEN 'Premium'
            WHEN total_spent > 0 THEN 'Regular'
            ELSE 'No Purchase'
        END AS customer_segment
    FROM customer_orders
)
SELECT 
    customer_segment,
    COUNT(*) AS customer_count,
    AVG(total_spent) AS avg_spent_per_segment,
    AVG(order_count) AS avg_orders_per_segment
FROM customer_segments
GROUP BY customer_segment
ORDER BY avg_spent_per_segment DESC NULLS LAST;

-- 複数CTEの使用例：月次売上トレンド分析
WITH monthly_sales AS (
    SELECT 
        DATE_TRUNC('month', o.order_date) AS sales_month,
        SUM(p.price * o.quantity) AS monthly_revenue,
        COUNT(DISTINCT o.customer_id) AS unique_customers,
        COUNT(o.order_id) AS total_orders
    FROM orders o
    JOIN products p ON o.product_id = p.product_id
    GROUP BY DATE_TRUNC('month', o.order_date)
),
sales_with_growth AS (
    SELECT 
        sales_month,
        monthly_revenue,
        unique_customers,
        total_orders,
        LAG(monthly_revenue) OVER (ORDER BY sales_month) AS prev_month_revenue,
        (monthly_revenue - LAG(monthly_revenue) OVER (ORDER BY sales_month)) / 
        LAG(monthly_revenue) OVER (ORDER BY sales_month) * 100 AS growth_rate
    FROM monthly_sales
)
SELECT 
    sales_month,
    monthly_revenue,
    unique_customers,
    total_orders,
    ROUND(growth_rate, 2) AS growth_percentage
FROM sales_with_growth
ORDER BY sales_month;</code></pre>
                    </div>

                    <h3 class="section-title">7.5 ウィンドウ関数の基本</h3>
                    <p>
                        ウィンドウ関数は、行のグループに対して計算を行いながら、
                        個々の行の詳細を保持する強力な機能です。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 7-5: ウィンドウ関数の活用</h5>
                        <p>ランキング、移動平均、累積計算などのウィンドウ関数を使用します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 商品の価格ランキング（カテゴリ別）
SELECT 
    p.product_name,
    c.category_name,
    p.price,
    RANK() OVER (PARTITION BY c.category_id ORDER BY p.price DESC) AS price_rank,
    DENSE_RANK() OVER (PARTITION BY c.category_id ORDER BY p.price DESC) AS dense_price_rank,
    ROW_NUMBER() OVER (PARTITION BY c.category_id ORDER BY p.price DESC) AS row_num
FROM products p
JOIN categories c ON p.category_id = c.category_id
ORDER BY c.category_name, p.price DESC;

-- 顧客別の注文履歴と累積金額
SELECT 
    o.order_id,
    c.name AS customer_name,
    o.order_date,
    p.product_name,
    (p.price * o.quantity) AS order_amount,
    SUM(p.price * o.quantity) OVER (
        PARTITION BY c.customer_id 
        ORDER BY o.order_date 
        ROWS UNBOUNDED PRECEDING
    ) AS cumulative_spent,
    AVG(p.price * o.quantity) OVER (
        PARTITION BY c.customer_id 
        ORDER BY o.order_date 
        ROWS 2 PRECEDING
    ) AS moving_avg_3_orders
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
JOIN products p ON o.product_id = p.product_id
ORDER BY c.name, o.order_date;</code></pre>
                    </div>

                    <div class="warning">
                        <h6>サブクエリのパフォーマンス最適化</h6>
                        <ul>
                            <li><strong>相関サブクエリの注意</strong>: 外部クエリの行数分だけ実行されるため、データ量が多い場合は注意</li>
                            <li><strong>EXISTS vs IN</strong>: 大量データの場合はEXISTSが効率的</li>
                            <li><strong>JOINとの使い分け</strong>: 場合によってはJOINの方が高速</li>
                            <li><strong>インデックス</strong>: サブクエリで使用する列にはインデックスを設定</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>問題1:</strong> スカラーサブクエリとテーブルサブクエリの違いは何ですか？</li>
                            <li><strong>問題2:</strong> EXISTS句とIN演算子の使い分けについて説明してください。</li>
                            <li><strong>問題3:</strong> WITH句（CTE）を使用する利点は何ですか？</li>
                            <li><strong>問題4:</strong> 相関サブクエリでパフォーマンス問題が発生しやすい理由は？</li>
                            <li><strong>問題5:</strong> ウィンドウ関数のPARTITION BY句の役割を説明してください。</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を表示</summary>
                            <div class="mt-2">
                                <strong>解答:</strong>
                                <ol>
                                    <li>スカラーサブクエリは単一値を返す、テーブルサブクエリは複数の行・列を返す</li>
                                    <li>EXISTS: 存在チェックに最適、NULL値の処理が安全。IN: 値の一致チェック、小さなリストに適している</li>
                                    <li>複雑なクエリの可読性向上、段階的な処理、再利用可能な中間結果の定義</li>
                                    <li>外部クエリの各行に対してサブクエリが実行されるため、データ量に比例して処理時間が増加</li>
                                    <li>結果セットをグループ分けし、各グループ内でウィンドウ関数を実行する範囲を定義</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="sql-learning-material-06.html" class="btn btn-secondary">← 前の章: 集計とグループ化</a>
                        <a href="sql-learning-material-08.html" class="btn btn-primary">次の章: パフォーマンス →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>