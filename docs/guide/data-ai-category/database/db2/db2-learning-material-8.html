<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB2学習教材 第8章 - 基本的なデータベース管理操作</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #003d73;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #003d73;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #003d73;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #0062cc;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コード */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            color: #d63384;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e6f1ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #003d73;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #003d73 !important;
            color: white !important;
        }

        .nav-link:hover {
            background-color: #0062cc !important;
            color: white !important;
        }

        /* テーブル */
        .table th {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">DB2学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">ガイドライン一覧</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>目次</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-1.html">第1章: DB2の基本概念と環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-2.html">第2章: Docker環境でのDB2セットアップ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-3.html">第3章: DB2クライアントツールの導入</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-4.html">第4章: DB2 SQLの基本</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-5.html">第5章: テーブル設計とインデックス基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-6.html">第6章: DB2組み込み関数とストアドプロシージャ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-7.html">第7章: ユーザー管理と基本的なセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter8">第8章: 基本的なデータベース管理操作</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第8章: 基本的なデータベース管理操作</h1>
                </div>

                <div id="chapter8">
                    <h2 class="chapter-title">基本的なデータベース管理操作</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>DB2 Export/Importユーティリティによるデータ移行</li>
                            <li>基本的なバックアップ・リストア操作</li>
                            <li>データベースの健全性チェックと保守操作</li>
                            <li>パフォーマンス監視とシステム情報の確認</li>
                            <li>日常的な管理タスクの自動化</li>
                        </ul>
                    </div>

                    <!-- 8.1 データのエクスポート・インポート -->
                    <h3 class="section-title">8.1 データのエクスポート・インポート</h3>
                    <p>DB2のExport/Importユーティリティは、データの移行やバックアップに広く使用されています。異なるシステム間でのデータ移行や、テスト環境へのデータ展開に活用できます。</p>

                    <h4>Export/Importの特徴</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>操作</th>
                                    <th>用途</th>
                                    <th>ファイル形式</th>
                                    <th>制限事項</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>EXPORT</td>
                                    <td>データの抽出</td>
                                    <td>DEL, IXF, WSF</td>
                                    <td>ロックされたテーブルは処理不可</td>
                                </tr>
                                <tr>
                                    <td>IMPORT</td>
                                    <td>データの挿入</td>
                                    <td>DEL, IXF, ASC</td>
                                    <td>テーブル構造は事前に作成が必要</td>
                                </tr>
                                <tr>
                                    <td>LOAD</td>
                                    <td>高速データ投入</td>
                                    <td>DEL, IXF, ASC</td>
                                    <td>排他制御、トリガー実行されない</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 実習 8-1 -->
                    <div class="exercise-container">
                        <h5>実習 8-1: Export/Importによるデータ移行</h5>
                        <p>テーブルデータのエクスポートとインポートを実践的に学習します。</p>
                        
                        <h6>実行する操作（コンテナ内で実行）</h6>
                        <pre class="code-block"><code class="language-sql"># DB2コンテナ内でのエクスポート操作
docker exec -it db2-learning bash
su - db2inst1

# 作業ディレクトリの作成
mkdir -p /tmp/db2_export

# データのエクスポート（DEL形式）
db2 "EXPORT TO /tmp/db2_export/customers.del OF DEL 
     SELECT * FROM sales_dept.customers_master"

# データのエクスポート（IXF形式、構造も含む）
db2 "EXPORT TO /tmp/db2_export/products.ixf OF IXF 
     SELECT * FROM sales_dept.products_master"

# 条件を指定したエクスポート
db2 "EXPORT TO /tmp/db2_export/recent_orders.del OF DEL 
     SELECT * FROM sales_dept.order_headers 
     WHERE order_date >= CURRENT DATE - 30 DAYS"

# エクスポートファイルの確認
ls -la /tmp/db2_export/

# ファイル内容の確認（先頭10行）
head -10 /tmp/db2_export/customers.del</code></pre>

                        <h6>SQLでのエクスポート実行</h6>
                        <pre class="code-block"><code class="language-sql">-- SQL文でのエクスポート実行
EXPORT TO '/tmp/db2_export/employee_summary.del' OF DEL
    MODIFIED BY COLDEL, CHARDEL" 
    SELECT 
        emp_id,
        first_name || ' ' || last_name as full_name,
        department,
        salary,
        hire_date
    FROM sales_dept.employee_info;

-- 複雑なクエリのエクスポート
EXPORT TO '/tmp/db2_export/sales_report.del' OF DEL
    SELECT 
        c.company_name,
        COUNT(o.order_id) as total_orders,
        SUM(o.total_amount) as total_sales,
        AVG(o.total_amount) as avg_order_value,
        MAX(o.order_date) as last_order_date
    FROM sales_dept.customers_master c
    LEFT JOIN sales_dept.order_headers o ON c.customer_id = o.customer_id
    GROUP BY c.customer_id, c.company_name
    ORDER BY total_sales DESC;</code></pre>

                        <h6>インポート操作</h6>
                        <pre class="code-block"><code class="language-sql"># バックアップ用テーブルの作成
db2 "CREATE TABLE sales_dept.customers_backup LIKE sales_dept.customers_master"

# DELファイルからのインポート
db2 "IMPORT FROM /tmp/db2_export/customers.del OF DEL 
     INSERT INTO sales_dept.customers_backup"

# IXFファイルからの新規テーブル作成とインポート
db2 "IMPORT FROM /tmp/db2_export/products.ixf OF IXF 
     CREATE INTO sales_dept.products_imported"

# インポート結果の確認
db2 "SELECT COUNT(*) as imported_count FROM sales_dept.customers_backup"
db2 "SELECT COUNT(*) as original_count FROM sales_dept.customers_master"</code></pre>

                        <h6>エクスポート・インポートのオプション</h6>
                        <ul>
                            <li><strong>MODIFIED BY COLDEL</strong>: 列区切り文字の指定</li>
                            <li><strong>MODIFIED BY CHARDEL</strong>: 文字列囲み文字の指定</li>
                            <li><strong>MESSAGES</strong>: エラーメッセージファイルの指定</li>
                            <li><strong>REPLACE/INSERT/CREATE</strong>: インポート時の動作指定</li>
                        </ul>
                    </div>

                    <!-- 8.2 バックアップとリストア -->
                    <h3 class="section-title">8.2 バックアップとリストア</h3>
                    <p>DB2のバックアップ・リストア機能は、データベースの完全な保護を提供します。定期的なバックアップにより、システム障害やデータ破損からの迅速な復旧が可能になります。</p>

                    <!-- 実習 8-2 -->
                    <div class="exercise-container">
                        <h5>実習 8-2: データベースのバックアップとリストア</h5>
                        <p>データベース全体のバックアップ作成とリストア操作を学習します。</p>
                        
                        <h6>バックアップ操作</h6>
                        <pre class="code-block"><code class="language-sql"># バックアップディレクトリの作成
mkdir -p /tmp/db2_backup

# データベースの完全バックアップ
db2 "BACKUP DATABASE testdb TO /tmp/db2_backup"

# 圧縮バックアップの作成
db2 "BACKUP DATABASE testdb TO /tmp/db2_backup COMPRESS"

# バックアップファイルの確認
ls -la /tmp/db2_backup/

# バックアップの詳細情報
db2ckbkp /tmp/db2_backup/TESTDB.0.db2inst1.NODE0000.CATN0000.20240101120000.001</code></pre>

                        <h6>バックアップ情報の確認</h6>
                        <pre class="code-block"><code class="language-sql">-- バックアップ履歴の確認
db2 "SELECT 
    BACKUP_ID,
    BACKUP_TYPE,
    BACKUP_START,
    BACKUP_SIZE,
    BACKUP_LOCATION
FROM SYSIBMADM.DB_HISTORY 
WHERE OPERATION = 'B'
ORDER BY BACKUP_START DESC"</code></pre>

                        <h6>リストア操作（注意：既存データが削除されます）</h6>
                        <pre class="code-block"><code class="language-sql"># リストア前の準備（全ての接続を切断）
db2 "FORCE APPLICATIONS ALL"
db2 "DEACTIVATE DATABASE testdb"

# データベースのリストア
db2 "RESTORE DATABASE testdb FROM /tmp/db2_backup"

# リストア後の接続
db2 "ACTIVATE DATABASE testdb"
db2 "CONNECT TO testdb"

# リストア結果の確認
db2 "SELECT COUNT(*) FROM sales_dept.customers_master"</code></pre>

                        <h6>増分バックアップ（高度な機能）</h6>
                        <pre class="code-block"><code class="language-sql"># アーカイブログモードの有効化が必要
db2 "UPDATE DB CFG FOR testdb USING LOGARCHMETH1 DISK:/tmp/db2_logs"

# 増分バックアップの作成
db2 "BACKUP DATABASE testdb INCREMENTAL TO /tmp/db2_backup"

# ログファイルのアーカイブ
db2 "ARCHIVE LOG FOR DATABASE testdb"</code></pre>

                        <h6>バックアップのベストプラクティス</h6>
                        <ul>
                            <li><strong>定期的な実行</strong>: 日次または週次の自動バックアップ</li>
                            <li><strong>複数世代管理</strong>: 複数のバックアップファイルを保持</li>
                            <li><strong>オフサイト保管</strong>: 物理的に異なる場所への保管</li>
                            <li><strong>復旧テスト</strong>: 定期的なリストアテストの実施</li>
                        </ul>
                    </div>

                    <!-- 8.3 データベースの健全性チェック -->
                    <h3 class="section-title">8.3 データベースの健全性チェック</h3>
                    <p>DB2は、データベースの整合性とパフォーマンスを維持するための様々な診断・保守コマンドを提供しています。</p>

                    <!-- 実習 8-3 -->
                    <div class="exercise-container">
                        <h5>実習 8-3: データベースの診断と保守</h5>
                        <p>データベースの健全性チェックと基本的な保守操作を実行します。</p>
                        
                        <h6>健全性チェックコマンド</h6>
                        <pre class="code-block"><code class="language-sql"># データベース接続状態の確認
db2pd -d testdb -applications

# データベースの設定確認
db2 "GET DB CFG FOR testdb"

# テーブルスペースの使用状況
db2pd -d testdb -tablespaces

# インデックスの整合性チェック
db2 "CHECK INDEX ALL FOR TABLE sales_dept.order_headers"

# テーブルの整合性チェック
db2 "CHECK TABLE sales_dept.customers_master"

# 統計情報の更新
db2 "RUNSTATS ON TABLE sales_dept.order_headers WITH DISTRIBUTION AND DETAILED INDEXES ALL"

# REORGが必要かどうかの確認
db2 "SELECT 
    TABSCHEMA,
    TABNAME,
    CARD,
    OVERFLOW,
    NPAGES,
    FPAGES,
    ACTIVE_BLOCKS,
    CASE 
        WHEN FPAGES > 0 THEN DECIMAL((NPAGES - FPAGES) * 100 / NPAGES, 5, 2)
        ELSE 0
    END as UNUSED_PERCENT
FROM SYSCAT.TABLES 
WHERE TABSCHEMA = 'SALES_DEPT'
  AND TYPE = 'T'"</code></pre>

                        <h6>パフォーマンス関連の確認</h6>
                        <pre class="code-block"><code class="language-sql">-- バッファープールの使用状況
db2 "SELECT 
    BP_NAME,
    POOL_DATA_P_READS as PHYSICAL_READS,
    POOL_DATA_L_READS as LOGICAL_READS,
    CASE 
        WHEN POOL_DATA_L_READS > 0 THEN
            DECIMAL((POOL_DATA_L_READS - POOL_DATA_P_READS) * 100 / POOL_DATA_L_READS, 5, 2)
        ELSE 0
    END as HIT_RATIO_PERCENT
FROM SYSIBMADM.BP_HITRATIO"

-- 長時間実行中のSQL
db2pd -d testdb -dynamic

-- ロック待機状況
db2pd -d testdb -locks wait

-- データベースサイズの確認
db2 "CALL SYSIBMADM.ADMINTABINFO('SALES_DEPT', 'ORDER_HEADERS')"</code></pre>

                        <h6>保守操作の実行</h6>
                        <pre class="code-block"><code class="language-sql"># テーブルの再編成（REORGが必要な場合）
db2 "REORG TABLE sales_dept.order_headers"

# インデックスの再構築
db2 "REORG INDEXES ALL FOR TABLE sales_dept.order_headers"

# 統計情報の再収集
db2 "RUNSTATS ON TABLE sales_dept.order_headers AND INDEXES ALL"

# 不要な領域の回収
db2 "ALTER TABLESPACE USERSPACE1 REDUCE"</code></pre>

                        <h6>診断結果の分析ポイント</h6>
                        <ul>
                            <li><strong>Hit Ratio</strong>: 95%以上が望ましい</li>
                            <li><strong>Unused Space</strong>: 20%以上でREORG検討</li>
                            <li><strong>Lock Waits</strong>: 長時間の待機は要調査</li>
                            <li><strong>Statistics</strong>: 定期的な更新が必要</li>
                        </ul>
                    </div>

                    <!-- 8.4 システム監視と情報収集 -->
                    <h3 class="section-title">8.4 システム監視と情報収集</h3>
                    <p>DB2の豊富な監視機能を活用することで、システムの状態を継続的に把握し、問題の早期発見と解決が可能になります。</p>

                    <!-- 実習 8-4 -->
                    <div class="exercise-container">
                        <h5>実習 8-4: システム監視とパフォーマンス分析</h5>
                        <p>DB2の監視機能を使用して、システムの状態を詳細に分析します。</p>
                        
                        <h6>システム情報の収集</h6>
                        <pre class="code-block"><code class="language-sql"># DB2のバージョンとレベル情報
db2level

# インスタンス情報の確認
db2pd -inst

# データベース一覧と状態
db2 "LIST ACTIVE DATABASES"

# 接続中のアプリケーション
db2 "LIST APPLICATIONS"

# メモリ使用状況
db2pd -d testdb -mempool

# CPU使用率（システムレベル）
db2pd -d testdb -osinfo</code></pre>

                        <h6>パフォーマンス監視</h6>
                        <pre class="code-block"><code class="language-sql">-- I/O統計の確認
db2 "SELECT 
    TBSP_NAME,
    POOL_DATA_P_READS,
    POOL_DATA_WRITES,
    POOL_INDEX_P_READS,
    POOL_INDEX_WRITES,
    DIRECT_READS,
    DIRECT_WRITES
FROM SYSIBMADM.BP_READ_IO 
ORDER BY POOL_DATA_P_READS DESC"

-- SQL文の実行統計
db2 "SELECT 
    EXECUTABLE_ID,
    STMT_TEXT,
    NUM_EXECUTIONS,
    TOTAL_CPU_TIME,
    TOTAL_CPU_TIME/NUM_EXECUTIONS as AVG_CPU_TIME,
    ROWS_READ,
    ROWS_WRITTEN
FROM SYSIBMADM.TOP_DYNAMIC_SQL 
WHERE NUM_EXECUTIONS > 1
ORDER BY TOTAL_CPU_TIME DESC
FETCH FIRST 10 ROWS ONLY"

-- テーブルアクセス統計
db2 "SELECT 
    TABSCHEMA,
    TABNAME,
    ROWS_READ,
    ROWS_INSERTED,
    ROWS_UPDATED,
    ROWS_DELETED,
    OVERFLOW_ACCESSES,
    PAGE_REORGS
FROM SYSCAT.TABLES 
WHERE TABSCHEMA = 'SALES_DEPT'
ORDER BY ROWS_READ DESC"</code></pre>

                        <h6>問題の特定と診断</h6>
                        <pre class="code-block"><code class="language-sql"># エラーログの確認
db2diag -A

# 最近のエラーメッセージ
db2 "SELECT 
    MESSAGE_TIME,
    MESSAGE_LEVEL,
    MESSAGE_TEXT
FROM SYSIBMADM.PDLOGMSGS_LAST24HOURS 
WHERE MESSAGE_LEVEL IN ('Error', 'Severe', 'Critical')
ORDER BY MESSAGE_TIME DESC"

# デッドロック情報の確認
db2pd -d testdb -locks wait

# 長時間ロック待機の確認
db2 "SELECT 
    APPLICATION_HANDLE,
    LOCK_OBJECT_NAME,
    LOCK_MODE,
    LOCK_STATUS,
    LOCK_WAIT_START_TIME
FROM SYSIBMADM.LOCKWAITS"

# 実行計画のキャッシュ情報
db2pd -d testdb -dynamic | head -50</code></pre>

                        <h6>アラート監視の設定</h6>
                        <pre class="code-block"><code class="language-sql">-- 健全性インジケーターの確認
db2 "SELECT 
    HI_ID,
    HI_TIMESTAMP,
    HI_VALUE,
    HI_ALERT_STATE,
    HI_ALARM_STATE
FROM SYSIBMADM.HEALTH_HI_HIS 
WHERE HI_TIMESTAMP >= CURRENT TIMESTAMP - 1 HOUR
ORDER BY HI_TIMESTAMP DESC"

-- データベースサイズのトレンド
db2 "SELECT 
    SNAPSHOT_TIMESTAMP,
    DB_SIZE,
    DB_CAPACITY
FROM SYSIBMADM.SNAPDB_INFO 
ORDER BY SNAPSHOT_TIMESTAMP DESC
FETCH FIRST 5 ROWS ONLY"</code></pre>

                        <h6>監視指標の目安</h6>
                        <ul>
                            <li><strong>Buffer Pool Hit Ratio</strong>: 90%以上維持</li>
                            <li><strong>Lock Wait Time</strong>: 平均1秒以下</li>
                            <li><strong>Log Utilization</strong>: 80%以下</li>
                            <li><strong>Tablespace Usage</strong>: 90%以下</li>
                        </ul>
                    </div>

                    <!-- 8.5 自動化と運用保守 -->
                    <h3 class="section-title">8.5 自動化と運用保守</h3>
                    <p>日常的な管理タスクを自動化することで、運用効率を向上させ、人的エラーを削減できます。</p>

                    <!-- 実習 8-5 -->
                    <div class="exercise-container">
                        <h5>実習 8-5: 基本的な運用自動化の実装</h5>
                        <p>日常的な管理タスクを自動化するスクリプトとプロシージャを作成します。</p>
                        
                        <h6>日次バックアップスクリプト例</h6>
                        <pre class="code-block"><code class="language-sql">#!/bin/bash
# daily_backup.sh - DB2日次バックアップスクリプト

# 設定
DB_NAME="testdb"
BACKUP_DIR="/tmp/db2_backup"
LOG_FILE="/tmp/backup_$(date +%Y%m%d).log"
RETENTION_DAYS=7

# ログ出力関数
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" | tee -a $LOG_FILE
}

# バックアップ実行
log "Starting backup for database $DB_NAME"

# バックアップディレクトリの確認・作成
if [ ! -d "$BACKUP_DIR" ]; then
    mkdir -p "$BACKUP_DIR"
    log "Created backup directory: $BACKUP_DIR"
fi

# DB2環境の設定
. ~db2inst1/sqllib/db2profile

# バックアップ実行
BACKUP_FILE="$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).bak"
db2 "BACKUP DATABASE $DB_NAME TO $BACKUP_DIR COMPRESS" >> $LOG_FILE 2>&1

if [ $? -eq 0 ]; then
    log "Backup completed successfully"
    
    # 古いバックアップファイルの削除
    find $BACKUP_DIR -name "*.001" -mtime +$RETENTION_DAYS -delete
    log "Old backup files cleaned up"
else
    log "ERROR: Backup failed"
    exit 1
fi

log "Backup process completed"</code></pre>

                        <h6>統計情報更新のストアドプロシージャ</h6>
                        <pre class="code-block"><code class="language-sql">-- 統計情報更新プロシージャの作成
CREATE OR REPLACE PROCEDURE sales_dept.update_table_statistics()
LANGUAGE SQL
BEGIN
    DECLARE table_name VARCHAR(100);
    DECLARE schema_name VARCHAR(100) DEFAULT 'SALES_DEPT';
    DECLARE sqlcode INTEGER DEFAULT 0;
    DECLARE update_count INTEGER DEFAULT 0;
    
    -- カーソルの定義
    DECLARE stats_cursor CURSOR FOR
        SELECT TABNAME
        FROM SYSCAT.TABLES
        WHERE TABSCHEMA = schema_name
          AND TYPE = 'T'
          AND STATS_TIME < CURRENT TIMESTAMP - 7 DAYS;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET sqlcode = 100;
    
    OPEN stats_cursor;
    
    stats_loop: LOOP
        FETCH stats_cursor INTO table_name;
        
        IF sqlcode <> 0 THEN
            LEAVE stats_loop;
        END IF;
        
        -- 統計情報の更新実行
        EXECUTE IMMEDIATE 
            'RUNSTATS ON TABLE ' || schema_name || '.' || table_name ||
            ' WITH DISTRIBUTION AND DETAILED INDEXES ALL';
        
        SET update_count = update_count + 1;
    END LOOP;
    
    CLOSE stats_cursor;
    
    -- 結果をログテーブルに記録
    INSERT INTO sales_dept.access_log (table_name, operation, details)
    VALUES ('STATISTICS_UPDATE', 'MAINTENANCE', 
            'Updated statistics for ' || CHAR(update_count) || ' tables');
            
END;

-- プロシージャの実行
CALL sales_dept.update_table_statistics();</code></pre>

                        <h6>健全性チェックプロシージャ</h6>
                        <pre class="code-block"><code class="language-sql">-- 健全性チェック用プロシージャ
CREATE OR REPLACE PROCEDURE sales_dept.health_check(
    OUT check_result VARCHAR(1000)
)
LANGUAGE SQL
BEGIN
    DECLARE check_messages VARCHAR(1000) DEFAULT '';
    DECLARE hit_ratio DECIMAL(5,2);
    DECLARE lock_waits INTEGER;
    DECLARE log_usage DECIMAL(5,2);
    
    -- バッファープールヒット率の確認
    SELECT 
        DECIMAL((POOL_DATA_L_READS - POOL_DATA_P_READS) * 100 / POOL_DATA_L_READS, 5, 2)
    INTO hit_ratio
    FROM SYSIBMADM.BP_HITRATIO 
    WHERE BP_NAME = 'IBMDEFAULTBP';
    
    IF hit_ratio < 90 THEN
        SET check_messages = check_messages || 'WARNING: Buffer pool hit ratio is ' || CHAR(hit_ratio) || '%. ';
    END IF;
    
    -- ロック待機の確認
    SELECT COUNT(*)
    INTO lock_waits
    FROM SYSIBMADM.LOCKWAITS;
    
    IF lock_waits > 0 THEN
        SET check_messages = check_messages || 'WARNING: ' || CHAR(lock_waits) || ' lock waits detected. ';
    END IF;
    
    -- 結果の設定
    IF LENGTH(check_messages) = 0 THEN
        SET check_result = 'OK: All health checks passed';
    ELSE
        SET check_result = check_messages;
    END IF;
    
    -- ログ記録
    INSERT INTO sales_dept.access_log (table_name, operation, details)
    VALUES ('HEALTH_CHECK', 'MONITORING', check_result);
    
END;

-- 健全性チェックの実行
CALL sales_dept.health_check(?);</code></pre>

                        <h6>運用自動化のベストプラクティス</h6>
                        <ul>
                            <li><strong>エラーハンドリング</strong>: 適切な例外処理とログ出力</li>
                            <li><strong>実行スケジュール</strong>: cronやタスクスケジューラーでの定期実行</li>
                            <li><strong>監視アラート</strong>: 異常時の自動通知機能</li>
                            <li><strong>バックアップ検証</strong>: 作成されたバックアップの整合性確認</li>
                        </ul>
                    </div>

                    <!-- 8.6 運用のまとめ -->
                    <h3 class="section-title">8.6 運用のまとめ</h3>
                    <p>DB2データベースの安定運用には、計画的な保守作業と継続的な監視が不可欠です。</p>

                    <div class="highlight">
                        <h5>日常運用のチェックリスト</h5>
                        <h6>日次作業</h6>
                        <ul>
                            <li>データベースの稼働状況確認</li>
                            <li>バックアップの成功確認</li>
                            <li>エラーログの確認とアラート対応</li>
                            <li>ディスク使用量の監視</li>
                        </ul>
                        
                        <h6>週次作業</h6>
                        <ul>
                            <li>統計情報の更新</li>
                            <li>REORGの必要性確認</li>
                            <li>パフォーマンス指標の分析</li>
                            <li>古いログファイルの清理</li>
                        </ul>
                        
                        <h6>月次作業</h6>
                        <ul>
                            <li>完全バックアップの実行</li>
                            <li>健全性チェックの実行</li>
                            <li>容量計画の見直し</li>
                            <li>セキュリティ設定の監査</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h5>⚠️ 運用時の注意点</h5>
                        <ul>
                            <li><strong>変更管理</strong>: 本番環境への変更は慎重に計画・実行</li>
                            <li><strong>バックアップテスト</strong>: 定期的なリストアテストの実施</li>
                            <li><strong>ドキュメント管理</strong>: 運用手順書の最新版維持</li>
                            <li><strong>緊急時対応</strong>: 障害時の連絡体制と対応手順の確立</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>DB2でテーブルデータをDEL形式でエクスポートするSQL文はどれですか？</strong>
                                <ol type="a">
                                    <li>EXPORT TO filename OF DEL SELECT * FROM table</li>
                                    <li>BACKUP TABLE table TO filename</li>
                                    <li>DUMP TABLE table TO filename</li>
                                    <li>SAVE TABLE table AS filename</li>
                                </ol>
                            </li>
                            <li><strong>DB2データベースのバックアップを作成するコマンドはどれですか？</strong>
                                <ol type="a">
                                    <li>BACKUP TABLE database TO directory</li>
                                    <li>BACKUP DATABASE database TO directory</li>
                                    <li>SAVE DATABASE database TO directory</li>
                                    <li>DUMP DATABASE database TO directory</li>
                                </ol>
                            </li>
                            <li><strong>テーブルの統計情報を更新するDB2コマンドはどれですか？</strong>
                                <ol type="a">
                                    <li>UPDATE STATISTICS</li>
                                    <li>ANALYZE TABLE</li>
                                    <li>RUNSTATS</li>
                                    <li>COMPUTE STATS</li>
                                </ol>
                            </li>
                            <li><strong>DB2でバッファープールのヒット率を確認するビューはどれですか？</strong>
                                <ol type="a">
                                    <li>SYSIBMADM.BUFFER_POOL_STATUS</li>
                                    <li>SYSIBMADM.BP_HITRATIO</li>
                                    <li>SYSCAT.BUFFERPOOLS</li>
                                    <li>SYSMON.BP_STATISTICS</li>
                                </ol>
                            </li>
                        </ol>
                        
                        <details style="margin-top: 1rem;">
                            <summary>解答を見る</summary>
                            <div style="margin-top: 0.5rem;">
                                <p><strong>解答:</strong></p>
                                <ol>
                                    <li>a) EXPORT TO filename OF DEL SELECT * FROM table</li>
                                    <li>b) BACKUP DATABASE database TO directory</li>
                                    <li>c) RUNSTATS</li>
                                    <li>b) SYSIBMADM.BP_HITRATIO</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- 学習完了メッセージ -->
                    <div class="highlight" style="margin-top: 3rem;">
                        <h5>🎉 DB2学習ガイドライン完了！</h5>
                        <p>お疲れさまでした！この8章にわたるDB2学習ガイドラインを完了されました。これで以下のスキルを身につけることができました：</p>
                        <ul>
                            <li>Docker環境でのDB2データベース環境構築</li>
                            <li>DB2クライアントツールによる基本操作</li>
                            <li>DB2 SQLの特徴的な機能の活用</li>
                            <li>効率的なテーブル・インデックス設計</li>
                            <li>組み込み関数とストアドプロシージャの実装</li>
                            <li>セキュリティと権限管理</li>
                            <li>データベースの運用・保守</li>
                        </ul>
                        <p>これらの知識を基に、実際のプロジェクトでDB2を効果的に活用してください。継続的な学習と実践により、さらなるスキル向上を目指しましょう！</p>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="db2-learning-material-7.html" class="btn btn-secondary">← 前の章</a>
                        <a href="../README.md" class="btn btn-success">ガイドライン一覧に戻る</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>