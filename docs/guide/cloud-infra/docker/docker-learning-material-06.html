<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker学習教材 第6章 - Dockerボリュームとデータ永続化</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
            line-height: 1.8;
        }

        /* ナビゲーション - Docker Blue */
        .navbar {
            background-color: #2496ED;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 1rem;
        }

        /* タイトル */
        .chapter-title {
            color: #2496ED;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 3px solid #2496ED;
            padding-bottom: 0.5rem;
            font-weight: bold;
        }

        .section-title {
            color: #1D63ED;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e7f3ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2496ED;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #fff9e6;
            border-radius: 8px;
            padding: 1.2rem;
            margin: 1.5rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            color: white;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        pre code.hljs {
            background-color: #1e1e1e;
            padding: 1rem;
            border-radius: 5px;
        }

        /* Mermaid図表 */
        .mermaid {
            text-align: center;
            margin: 2rem 0;
        }

        /* ナビゲーションボタン */
        .chapter-nav {
            margin: 2rem 0;
        }

        /* サイドバーリンク */
        .sidebar a {
            color: #2496ED;
            text-decoration: none;
        }

        .sidebar a:hover {
            text-decoration: underline;
        }

        /* 折りたたみコンテンツ */
        .collapse-trigger {
            cursor: pointer;
            color: #2496ED;
            user-select: none;
        }

        .collapse-trigger:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Docker学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="docker-learning-material-01.html">第1章</a></li>
                    <li class="nav-item"><a class="nav-link" href="docker-learning-material-02.html">第2章</a></li>
                    <li class="nav-item"><a class="nav-link" href="docker-learning-material-03.html">第3章</a></li>
                    <li class="nav-item"><a class="nav-link" href="docker-learning-material-04.html">第4章</a></li>
                    <li class="nav-item"><a class="nav-link" href="docker-learning-material-05.html">第5章</a></li>
                    <li class="nav-item"><a class="nav-link active" href="docker-learning-material-06.html">第6章</a></li>
                    <li class="nav-item"><a class="nav-link" href="docker-learning-material-07.html">第7章</a></li>
                    <li class="nav-item"><a class="nav-link" href="docker-learning-material-08.html">第8章</a></li>
                    <li class="nav-item"><a class="nav-link" href="docker-learning-material-09.html">第9章</a></li>
                    <li class="nav-item"><a class="nav-link" href="docker-learning-material-10.html">第10章</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <h5 class="mt-3">目次</h5>
                <ul class="nav flex-column">
                    <li class="nav-item"><a href="#intro">はじめに</a></li>
                    <li class="nav-item"><a href="#data-problem">データ永続化の問題</a></li>
                    <li class="nav-item"><a href="#mount-types">3種類のマウント方式</a></li>
                    <li class="nav-item"><a href="#volumes">Dockerボリューム</a></li>
                    <li class="nav-item"><a href="#bind-mounts">バインドマウント</a></li>
                    <li class="nav-item"><a href="#tmpfs">tmpfsマウント</a></li>
                    <li class="nav-item"><a href="#comparison">方式の比較と使い分け</a></li>
                    <li class="nav-item"><a href="#backup">バックアップとリストア</a></li>
                    <li class="nav-item"><a href="#practical">実践的な使用例</a></li>
                    <li class="nav-item"><a href="#exercises">実習課題</a></li>
                    <li class="nav-item"><a href="#quiz">理解度確認クイズ</a></li>
                </ul>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <h1 class="chapter-title">第6章 - Dockerボリュームとデータ永続化</h1>

                <!-- 学習目標 -->
                <div class="highlight">
                    <h4>学習目標</h4>
                    <ul>
                        <li>コンテナのデータが一時的である理由を理解する</li>
                        <li>3種類のマウント方式（ボリューム、バインドマウント、tmpfs）の違いを理解する</li>
                        <li>Dockerボリュームを作成・管理できる</li>
                        <li>バインドマウントを使った開発環境の構築ができる</li>
                        <li>データのバックアップとリストアができる</li>
                    </ul>
                </div>

                <!-- はじめに -->
                <section id="intro">
                    <h2 class="section-title">はじめに</h2>
                    <p>
                        Dockerコンテナは<strong>一時的（ephemeral）</strong>な存在です。コンテナを削除すると、その中に保存されていたデータもすべて失われます。しかし、データベースやログファイルなど、永続化が必要なデータを扱う場合があります。
                    </p>
                    <p>
                        この章では、Dockerにおける<strong>データ永続化</strong>の仕組みを学びます。データをコンテナのライフサイクルとは独立して保存し、コンテナを再作成してもデータが失われないようにする方法を習得します。
                    </p>
                </section>

                <!-- データ永続化の問題 -->
                <section id="data-problem">
                    <h2 class="section-title">データ永続化の問題</h2>

                    <h3>コンテナの一時的な性質</h3>
                    <p>
                        Dockerコンテナ内のファイルシステムは、デフォルトで<strong>一時的</strong>です。コンテナを削除すると、その中で作成・変更されたすべてのデータが失われます。
                    </p>

                    <div class="mermaid">
                        graph LR
                            A[コンテナ起動] --> B[データ作成/変更]
                            B --> C[コンテナ削除]
                            C --> D[データ消失]
                            style D fill:#ffebee
                    </div>

                    <h3>問題のデモンストレーション</h3>
                    <pre class="code-block"><code class="language-bash"># PostgreSQLコンテナを起動
docker run --name test-db -e POSTGRES_PASSWORD=secret -d postgres

# データベースに接続してテーブルを作成
docker exec -it test-db psql -U postgres -c "CREATE TABLE users (id SERIAL, name TEXT);"
docker exec -it test-db psql -U postgres -c "INSERT INTO users (name) VALUES ('Alice');"

# データが存在することを確認
docker exec -it test-db psql -U postgres -c "SELECT * FROM users;"

# コンテナを削除
docker rm -f test-db

# 再度起動
docker run --name test-db -e POSTGRES_PASSWORD=secret -d postgres

# データが消えている！
docker exec -it test-db psql -U postgres -c "SELECT * FROM users;"
# エラー: relation "users" does not exist</code></pre>

                    <h3>データ永続化が必要なケース</h3>
                    <ul>
                        <li><strong>データベース</strong>：ユーザーデータ、トランザクション記録</li>
                        <li><strong>ログファイル</strong>：アプリケーションログ、アクセスログ</li>
                        <li><strong>アップロードファイル</strong>：ユーザーがアップロードした画像や文書</li>
                        <li><strong>設定ファイル</strong>：コンテナ外で管理したい設定</li>
                        <li><strong>開発中のソースコード</strong>：ホットリロードのため</li>
                    </ul>

                    <div class="warning">
                        <strong>重要：</strong>コンテナは「いつでも削除・再作成できる」ように設計すべきです。そのため、永続化が必要なデータはコンテナの外に保存する必要があります。
                    </div>
                </section>

                <!-- 3種類のマウント方式 -->
                <section id="mount-types">
                    <h2 class="section-title">3種類のマウント方式</h2>

                    <p>Dockerには、ホストとコンテナ間でデータを共有する3つの主要な方法があります：</p>

                    <div class="mermaid">
                        graph TD
                            A[データ永続化の方法] --> B[Volumes<br/>ボリューム]
                            A --> C[Bind Mounts<br/>バインドマウント]
                            A --> D[tmpfs Mounts<br/>tmpfsマウント]
                            B --> E[Dockerが管理]
                            C --> F[ホストのパスを指定]
                            D --> G[メモリ上に保存]
                    </div>

                    <h3>1. Volumes（ボリューム）</h3>
                    <ul>
                        <li><strong>Dockerが完全に管理</strong>する領域</li>
                        <li>ホストファイルシステムの特定のディレクトリ（通常 <code>/var/lib/docker/volumes/</code>）に保存</li>
                        <li><strong>推奨される方法</strong>（最も安全で移植性が高い）</li>
                        <li>複数のコンテナで共有可能</li>
                    </ul>

                    <h3>2. Bind Mounts（バインドマウント）</h3>
                    <ul>
                        <li>ホストマシンの<strong>任意のパス</strong>をコンテナにマウント</li>
                        <li>開発時に便利（ソースコードの変更を即座に反映）</li>
                        <li>ホストのファイルシステムに依存するため、移植性は低い</li>
                        <li>設定ファイルの注入にも使用</li>
                    </ul>

                    <h3>3. tmpfs Mounts（tmpfsマウント）</h3>
                    <ul>
                        <li>ホストのメモリ上にのみ保存（ディスクには書き込まない）</li>
                        <li>一時的なデータの保存に使用</li>
                        <li>コンテナ停止時にデータは消失</li>
                        <li>機密情報の一時保存に有用</li>
                    </ul>

                    <div class="mermaid">
                        graph LR
                            A[ホスト] -->|Volume| B[Dockerボリューム領域]
                            A -->|Bind Mount| C[任意のディレクトリ]
                            A -->|tmpfs| D[メモリ]
                            B -.->|マウント| E[コンテナ]
                            C -.->|マウント| E
                            D -.->|マウント| E
                            style B fill:#e7f3ff
                            style C fill:#fff9e6
                            style D fill:#f3e5f5
                    </div>
                </section>

                <!-- Dockerボリューム -->
                <section id="volumes">
                    <h2 class="section-title">Dockerボリューム（推奨）</h2>

                    <h3>ボリュームの特徴</h3>
                    <p>
                        Dockerボリュームは、Dockerが完全に管理するデータ領域です。最も推奨される永続化方法で、以下の利点があります：
                    </p>
                    <ul>
                        <li>Dockerが自動的に管理するため、パスを気にする必要がない</li>
                        <li>Linux、Windows、macOS間で移植性が高い</li>
                        <li>バックアップやマイグレーションが簡単</li>
                        <li>複数のコンテナで安全に共有可能</li>
                        <li>ボリュームドライバーで拡張可能（リモートストレージ等）</li>
                    </ul>

                    <h3>ボリュームの作成</h3>
                    <pre class="code-block"><code class="language-bash"># 名前付きボリュームを作成
docker volume create my-volume

# ボリューム一覧を表示
docker volume ls

# ボリュームの詳細情報
docker volume inspect my-volume</code></pre>

                    <h3>ボリュームの使用</h3>
                    <pre class="code-block"><code class="language-bash"># ボリュームをマウントしてコンテナを起動
docker run -d \
  --name postgres-db \
  -v my-volume:/var/lib/postgresql/data \
  -e POSTGRES_PASSWORD=secret \
  postgres

# または --mount構文（より明示的）
docker run -d \
  --name postgres-db \
  --mount source=my-volume,target=/var/lib/postgresql/data \
  -e POSTGRES_PASSWORD=secret \
  postgres</code></pre>

                    <h3>匿名ボリューム vs 名前付きボリューム</h3>

                    <h4>匿名ボリューム</h4>
                    <pre class="code-block"><code class="language-bash"># ボリューム名を指定しない（自動生成される）
docker run -d -v /var/lib/postgresql/data postgres

# 自動生成された名前（ランダムなハッシュ）
docker volume ls
# DRIVER    VOLUME NAME
# local     a1b2c3d4e5f6...</code></pre>

                    <h4>名前付きボリューム（推奨）</h4>
                    <pre class="code-block"><code class="language-bash"># わかりやすい名前を付ける
docker run -d -v postgres-data:/var/lib/postgresql/data postgres

# 管理しやすい
docker volume ls
# DRIVER    VOLUME NAME
# local     postgres-data</code></pre>

                    <div class="highlight">
                        <strong>ベストプラクティス：</strong>名前付きボリュームを使用することで、管理が容易になります。匿名ボリュームは、一時的な用途でのみ使用しましょう。
                    </div>

                    <h3>ボリュームの削除</h3>
                    <pre class="code-block"><code class="language-bash"># 特定のボリュームを削除
docker volume rm my-volume

# 使用されていないすべてのボリュームを削除
docker volume prune

# コンテナ削除時にボリュームも削除
docker rm -v container-name</code></pre>

                    <h3>Docker Composeでのボリューム使用</h3>
                    <pre class="code-block"><code class="language-yaml">version: '3.8'

services:
  db:
    image: postgres:15
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: secret

volumes:
  postgres-data:  # 名前付きボリュームを宣言</code></pre>
                </section>

                <!-- バインドマウント -->
                <section id="bind-mounts">
                    <h2 class="section-title">バインドマウント</h2>

                    <h3>バインドマウントの特徴</h3>
                    <p>
                        バインドマウントは、ホストマシンの任意のファイルやディレクトリをコンテナにマウントします。主に開発環境で使用されます。
                    </p>

                    <h3>使用例：開発時のソースコード共有</h3>
                    <pre class="code-block"><code class="language-bash"># カレントディレクトリをコンテナの /app にマウント
docker run -d \
  --name dev-server \
  -v $(pwd):/app \
  -p 3000:3000 \
  node:18 \
  npm start

# ホストでファイルを編集すると、即座にコンテナに反映される</code></pre>

                    <h3>絶対パスと相対パス</h3>
                    <pre class="code-block"><code class="language-bash"># 絶対パスを使用（推奨）
docker run -v /home/user/myapp:/app myimage

# 相対パス（カレントディレクトリ基準）
docker run -v $(pwd):/app myimage

# Windowsの場合
docker run -v C:\Users\user\myapp:/app myimage</code></pre>

                    <h3>読み取り専用マウント</h3>
                    <pre class="code-block"><code class="language-bash"># :ro オプションで読み取り専用
docker run -v $(pwd)/config:/app/config:ro myimage

# コンテナからは変更できない（安全性向上）</code></pre>

                    <h3>Docker Composeでのバインドマウント</h3>
                    <pre class="code-block"><code class="language-yaml">version: '3.8'

services:
  web:
    build: .
    volumes:
      # 開発用：ソースコードをマウント
      - ./src:/app/src
      # 設定ファイルを読み取り専用でマウント
      - ./config.json:/app/config.json:ro
      # node_modulesは名前付きボリュームで保護
      - node_modules:/app/node_modules
    ports:
      - "3000:3000"

volumes:
  node_modules:</code></pre>

                    <h3>バインドマウントの利点と欠点</h3>

                    <div class="highlight">
                        <h5>利点</h5>
                        <ul>
                            <li>開発時にコードの変更が即座に反映される（ホットリロード）</li>
                            <li>ホストから直接ファイルを編集できる</li>
                            <li>設定ファイルの注入が簡単</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h5>欠点</h5>
                        <ul>
                            <li>ホストのパスに依存するため、移植性が低い</li>
                            <li>Windows/macOSではファイルシステムの違いでパフォーマンスが低下することがある</li>
                            <li>セキュリティリスク（ホストのファイルに直接アクセス）</li>
                        </ul>
                    </div>

                    <h3>開発環境での典型的な使用例</h3>
                    <pre class="code-block"><code class="language-yaml"># docker-compose.dev.yml
version: '3.8'

services:
  frontend:
    build: ./frontend
    volumes:
      - ./frontend/src:/app/src  # ソースコードをマウント
      - /app/node_modules        # node_modulesは除外
    environment:
      - NODE_ENV=development

  backend:
    build: ./backend
    volumes:
      - ./backend/src:/app/src
      - ./backend/tests:/app/tests
    environment:
      - DEBUG=true</code></pre>
                </section>

                <!-- tmpfsマウント -->
                <section id="tmpfs">
                    <h2 class="section-title">tmpfsマウント</h2>

                    <h3>tmpfsマウントの特徴</h3>
                    <p>
                        tmpfsマウントは、ホストのメモリ上に一時的なファイルシステムを作成します。ディスクには書き込まれないため、高速で、機密情報の一時保存に適しています。
                    </p>

                    <h3>使用例</h3>
                    <pre class="code-block"><code class="language-bash"># tmpfsマウントを使用
docker run -d \
  --name temp-container \
  --tmpfs /tmp:rw,size=100m \
  myimage

# /tmp ディレクトリはメモリ上に作成され、コンテナ停止時に消失</code></pre>

                    <h3>tmpfsの用途</h3>
                    <ul>
                        <li><strong>一時ファイル</strong>：処理中の一時データ</li>
                        <li><strong>機密情報</strong>：パスワードやトークンの一時保存（ディスクに残らない）</li>
                        <li><strong>キャッシュ</strong>：高速なキャッシュストレージ</li>
                        <li><strong>作業用ディレクトリ</strong>：一時的な作業領域</li>
                    </ul>

                    <div class="warning">
                        <strong>注意：</strong>tmpfsはLinuxコンテナでのみ使用可能です。Windowsコンテナでは使用できません。
                    </div>

                    <h3>Docker Composeでのtmpfs使用</h3>
                    <pre class="code-block"><code class="language-yaml">version: '3.8'

services:
  app:
    image: myapp
    tmpfs:
      - /tmp
      - /run:size=100m,mode=1777</code></pre>
                </section>

                <!-- 方式の比較と使い分け -->
                <section id="comparison">
                    <h2 class="section-title">方式の比較と使い分け</h2>

                    <h3>比較表</h3>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>特徴</th>
                                <th>Volume</th>
                                <th>Bind Mount</th>
                                <th>tmpfs</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>管理者</td>
                                <td>Docker</td>
                                <td>ホストOS</td>
                                <td>メモリ</td>
                            </tr>
                            <tr>
                                <td>保存場所</td>
                                <td>/var/lib/docker/volumes/</td>
                                <td>ホストの任意のパス</td>
                                <td>ホストのメモリ</td>
                            </tr>
                            <tr>
                                <td>移植性</td>
                                <td>高い</td>
                                <td>低い</td>
                                <td>中</td>
                            </tr>
                            <tr>
                                <td>永続性</td>
                                <td>永続</td>
                                <td>永続</td>
                                <td>一時的</td>
                            </tr>
                            <tr>
                                <td>共有</td>
                                <td>可能</td>
                                <td>可能</td>
                                <td>不可</td>
                            </tr>
                            <tr>
                                <td>推奨用途</td>
                                <td>本番環境、データベース</td>
                                <td>開発環境、設定ファイル</td>
                                <td>一時データ、機密情報</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>使い分けのガイドライン</h3>

                    <div class="highlight">
                        <h5>Dockerボリュームを使用すべき場合</h5>
                        <ul>
                            <li>本番環境でのデータ永続化</li>
                            <li>データベースのデータ保存</li>
                            <li>複数のコンテナでデータを共有</li>
                            <li>バックアップやマイグレーションを行う</li>
                        </ul>
                    </div>

                    <div class="highlight">
                        <h5>バインドマウントを使用すべき場合</h5>
                        <ul>
                            <li>開発環境でソースコードを共有</li>
                            <li>設定ファイルをコンテナに注入</li>
                            <li>ホストから直接ファイルを編集したい</li>
                            <li>ログファイルをホストで監視</li>
                        </ul>
                    </div>

                    <div class="highlight">
                        <h5>tmpfsマウントを使用すべき場合</h5>
                        <ul>
                            <li>機密情報の一時保存</li>
                            <li>高速な一時ストレージが必要</li>
                            <li>ディスクI/Oを削減したい</li>
                            <li>データを永続化したくない</li>
                        </ul>
                    </div>
                </section>

                <!-- バックアップとリストア -->
                <section id="backup">
                    <h2 class="section-title">ボリュームのバックアップとリストア</h2>

                    <h3>ボリュームのバックアップ</h3>
                    <p>ボリュームのデータをバックアップする方法を学びます。</p>

                    <pre class="code-block"><code class="language-bash"># バックアップ用の一時コンテナを起動して、tarアーカイブを作成
docker run --rm \
  -v postgres-data:/data \
  -v $(pwd):/backup \
  ubuntu \
  tar czf /backup/postgres-backup.tar.gz -C /data .

# postgres-data ボリュームの内容が postgres-backup.tar.gz に保存される</code></pre>

                    <h3>バックアップの仕組み</h3>
                    <div class="mermaid">
                        graph LR
                            A[postgres-dataボリューム] -->|マウント| B[一時コンテナ]
                            C[ホストのカレントディレクトリ] -->|マウント| B
                            B -->|tar圧縮| D[backup.tar.gz]
                            D -->|保存| C
                            style B fill:#e7f3ff
                    </div>

                    <h3>ボリュームのリストア</h3>
                    <pre class="code-block"><code class="language-bash"># 新しいボリュームを作成
docker volume create postgres-data-restored

# バックアップから復元
docker run --rm \
  -v postgres-data-restored:/data \
  -v $(pwd):/backup \
  ubuntu \
  tar xzf /backup/postgres-backup.tar.gz -C /data

# 復元したボリュームを使用
docker run -d \
  -v postgres-data-restored:/var/lib/postgresql/data \
  postgres</code></pre>

                    <h3>実践的なバックアップスクリプト</h3>
                    <pre class="code-block"><code class="language-bash">#!/bin/bash
# backup-volume.sh

VOLUME_NAME=$1
BACKUP_DIR="./backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${VOLUME_NAME}_${TIMESTAMP}.tar.gz"

mkdir -p ${BACKUP_DIR}

docker run --rm \
  -v ${VOLUME_NAME}:/data \
  -v ${BACKUP_DIR}:/backup \
  ubuntu \
  tar czf /backup/${VOLUME_NAME}_${TIMESTAMP}.tar.gz -C /data .

echo "Backup saved to: ${BACKUP_FILE}"

# 使用例：
# ./backup-volume.sh postgres-data</code></pre>

                    <h3>Docker Composeでのバックアップ</h3>
                    <pre class="code-block"><code class="language-bash"># サービスを停止してからバックアップ（データ整合性のため）
docker compose down

# バックアップ実行
docker run --rm \
  -v myapp_postgres-data:/data \
  -v $(pwd)/backups:/backup \
  ubuntu \
  tar czf /backup/backup-$(date +%Y%m%d).tar.gz -C /data .

# サービスを再開
docker compose up -d</code></pre>
                </section>

                <!-- 実践的な使用例 -->
                <section id="practical">
                    <h2 class="section-title">実践的な使用例</h2>

                    <h3>例1：WordPressの完全な永続化</h3>
                    <pre class="code-block"><code class="language-yaml">version: '3.8'

services:
  wordpress:
    image: wordpress:latest
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: secret
      WORDPRESS_DB_NAME: wordpress
    volumes:
      # WordPressのファイルを永続化
      - wordpress_data:/var/www/html

  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: secret
    volumes:
      # データベースを永続化
      - db_data:/var/lib/mysql

volumes:
  wordpress_data:
  db_data:</code></pre>

                    <h3>例2：開発環境（ホットリロード対応）</h3>
                    <pre class="code-block"><code class="language-yaml">version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    volumes:
      # ソースコードをバインドマウント（開発用）
      - ./frontend/src:/app/src
      # node_modulesはボリュームで保護
      - node_modules_frontend:/app/node_modules
    environment:
      - NODE_ENV=development

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend/src:/app/src
      - node_modules_backend:/app/node_modules
    environment:
      - NODE_ENV=development

  db:
    image: postgres:15
    volumes:
      # データベースは名前付きボリューム
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: devpass

volumes:
  node_modules_frontend:
  node_modules_backend:
  postgres_data:</code></pre>

                    <h3>例3：ログの外部保存</h3>
                    <pre class="code-block"><code class="language-yaml">version: '3.8'

services:
  app:
    build: .
    volumes:
      # アプリケーションログをホストに保存
      - ./logs:/var/log/app
      # 一時ファイルはtmpfs（高速）
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100m</code></pre>
                </section>

                <!-- 実習課題 -->
                <section id="exercises">
                    <h2 class="section-title">実習課題</h2>

                    <div class="exercise-container">
                        <h4>実習1：データベースのデータ永続化</h4>
                        <p><strong>目的：</strong>ボリュームを使ってデータを永続化する</p>

                        <p><strong>手順：</strong></p>
                        <ol>
                            <li>名前付きボリューム<code>mysql-data</code>を作成</li>
                            <li>MySQLコンテナを起動し、ボリュームをマウント</li>
                            <li>データベースとテーブルを作成し、データを挿入</li>
                            <li>コンテナを削除</li>
                            <li>同じボリュームで新しいコンテナを起動</li>
                            <li>データが保持されているか確認</li>
                        </ol>

                        <p><strong>確認コマンド例：</strong></p>
                        <pre class="code-block"><code class="language-bash">docker volume create mysql-data
docker run -d --name mysql-test -v mysql-data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=pass mysql:8.0
docker exec -it mysql-test mysql -ppass -e "CREATE DATABASE testdb;"
docker rm -f mysql-test
docker run -d --name mysql-test2 -v mysql-data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=pass mysql:8.0
docker exec -it mysql-test2 mysql -ppass -e "SHOW DATABASES;"</code></pre>
                    </div>

                    <div class="exercise-container">
                        <h4>実習2：バインドマウントで開発環境構築</h4>
                        <p><strong>目的：</strong>ソースコードの変更をリアルタイムに反映する</p>

                        <p><strong>手順：</strong></p>
                        <ol>
                            <li>シンプルなHTMLファイルを作成</li>
                            <li>Nginxコンテナでカレントディレクトリをマウント</li>
                            <li>ブラウザでアクセス</li>
                            <li>HTMLファイルをホスト側で編集</li>
                            <li>ブラウザをリロードして変更が反映されることを確認</li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h4>実習3：ボリュームのバックアップとリストア</h4>
                        <p><strong>目的：</strong>データのバックアップとリストアを実践する</p>

                        <p><strong>手順：</strong></p>
                        <ol>
                            <li>データを含むボリュームを作成</li>
                            <li>バックアップスクリプトを使ってtarアーカイブを作成</li>
                            <li>元のボリュームを削除</li>
                            <li>新しいボリュームを作成し、バックアップから復元</li>
                            <li>データが正しく復元されているか確認</li>
                        </ol>
                    </div>
                </section>

                <!-- 理解度確認クイズ -->
                <section id="quiz">
                    <h2 class="section-title">理解度確認クイズ</h2>

                    <div class="quiz-container">
                        <h4>Q1: コンテナのデータ</h4>
                        <p>ボリュームを使用せずにコンテナを削除した場合、コンテナ内のデータはどうなりますか？</p>
                        <ol type="a">
                            <li>ホストマシンに自動的に保存される</li>
                            <li>すべて失われる</li>
                            <li>Docker Hubにバックアップされる</li>
                            <li>別のコンテナに移動される</li>
                        </ol>
                        <div class="collapse-trigger" data-bs-toggle="collapse" data-bs-target="#answer1">
                            <strong>解答を表示 ▼</strong>
                        </div>
                        <div class="collapse mt-2" id="answer1">
                            <div class="alert alert-info">
                                <strong>答え：b) すべて失われる</strong><br>
                                コンテナは一時的な存在であり、ボリュームやバインドマウントを使用しない限り、コンテナ内のデータはコンテナの削除と共に失われます。
                            </div>
                        </div>
                    </div>

                    <div class="quiz-container">
                        <h4>Q2: 推奨される永続化方法</h4>
                        <p>本番環境でデータベースのデータを永続化する場合、最も推奨される方法はどれですか？</p>
                        <ol type="a">
                            <li>バインドマウント</li>
                            <li>tmpfsマウント</li>
                            <li>Dockerボリューム</li>
                            <li>コンテナ内のファイルシステム</li>
                        </ol>
                        <div class="collapse-trigger" data-bs-toggle="collapse" data-bs-target="#answer2">
                            <strong>解答を表示 ▼</strong>
                        </div>
                        <div class="collapse mt-2" id="answer2">
                            <div class="alert alert-info">
                                <strong>答え：c) Dockerボリューム</strong><br>
                                Dockerボリュームは、Dockerが完全に管理し、移植性が高く、本番環境でのデータ永続化に最も適しています。
                            </div>
                        </div>
                    </div>

                    <div class="quiz-container">
                        <h4>Q3: バインドマウントの用途</h4>
                        <p>バインドマウントが最も適している用途はどれですか？</p>
                        <ol type="a">
                            <li>本番環境のデータベース</li>
                            <li>開発環境でのソースコード共有</li>
                            <li>一時的なキャッシュデータ</li>
                            <li>機密情報の保存</li>
                        </ol>
                        <div class="collapse-trigger" data-bs-toggle="collapse" data-bs-target="#answer3">
                            <strong>解答を表示 ▼</strong>
                        </div>
                        <div class="collapse mt-2" id="answer3">
                            <div class="alert alert-info">
                                <strong>答え：b) 開発環境でのソースコード共有</strong><br>
                                バインドマウントは、ホストのファイルをコンテナにマウントするため、開発時にソースコードの変更をリアルタイムに反映させるのに最適です。
                            </div>
                        </div>
                    </div>

                    <div class="quiz-container">
                        <h4>Q4: tmpfsマウントの特徴</h4>
                        <p>tmpfsマウントについて正しいものはどれですか？</p>
                        <ol type="a">
                            <li>ディスクに永続的に保存される</li>
                            <li>メモリ上に一時的に保存される</li>
                            <li>Docker Hubに自動アップロードされる</li>
                            <li>複数のコンテナで共有できる</li>
                        </ol>
                        <div class="collapse-trigger" data-bs-toggle="collapse" data-bs-target="#answer4">
                            <strong>解答を表示 ▼</strong>
                        </div>
                        <div class="collapse mt-2" id="answer4">
                            <div class="alert alert-info">
                                <strong>答え：b) メモリ上に一時的に保存される</strong><br>
                                tmpfsマウントはホストのメモリ上にのみ保存され、コンテナが停止するとデータは失われます。高速で、機密情報の一時保存に適しています。
                            </div>
                        </div>
                    </div>

                    <div class="quiz-container">
                        <h4>Q5: ボリュームのバックアップ</h4>
                        <p>ボリュームをバックアップする一般的な方法として正しいものはどれですか？</p>
                        <ol type="a">
                            <li>docker volume backup コマンドを使用</li>
                            <li>一時コンテナを使ってtarアーカイブを作成</li>
                            <li>Docker Hubに自動的にバックアップされる</li>
                            <li>ボリュームは自動的に複製される</li>
                        </ol>
                        <div class="collapse-trigger" data-bs-toggle="collapse" data-bs-target="#answer5">
                            <strong>解答を表示 ▼</strong>
                        </div>
                        <div class="collapse mt-2" id="answer5">
                            <div class="alert alert-info">
                                <strong>答え：b) 一時コンテナを使ってtarアーカイブを作成</strong><br>
                                ボリュームのバックアップは、ボリュームをマウントした一時コンテナを起動し、<code>tar</code>コマンドでアーカイブを作成するのが一般的な方法です。
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ナビゲーション -->
                <div class="chapter-nav">
                    <a href="docker-learning-material-05.html" class="btn btn-outline-primary">&larr; 前の章へ</a>
                    <a href="docker-learning-material-07.html" class="btn btn-primary">次の章へ &rarr;</a>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js初期化 -->
    <script>
        hljs.highlightAll();
    </script>

    <!-- Mermaid初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>
