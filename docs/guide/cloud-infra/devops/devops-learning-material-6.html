<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps学習教材 第6章 - Infrastructure as Code (IaC)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #0d6efd; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #0d6efd; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #0d6efd; padding-bottom: 0.5rem; }
        .section-title { color: #0dcaf0; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container, .exercise-container, .highlight, .info-box { border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; }
        .quiz-container { background-color: #cfe2ff; border-left: 4px solid #0d6efd; }
        .exercise-container { background-color: #f3e5f5; border-left: 4px solid #9c27b0; }
        .highlight { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; }
        .info-box { background-color: #e7f3ff; border-left: 4px solid #0d6efd; padding: 1rem; }
        .code-block { background-color: #1e1e1e; color: white; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #0d6efd !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">DevOps学習教材</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="devops-learning-material-5.html">第5章</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#chapter6">第6章</a></li>
                    <li class="nav-item"><a class="nav-link" href="devops-learning-material-7.html">第7章</a></li>
                    <li class="nav-item"><a class="nav-link" href="README.html">目次</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link active" href="#chapter6">第6章: Infrastructure as Code</a></li>
                        <li class="nav-item"><a class="nav-link" href="#section6-1">6.1 IaCとは</a></li>
                        <li class="nav-item"><a class="nav-link" href="#section6-2">6.2 Terraform</a></li>
                        <li class="nav-item"><a class="nav-link" href="#section6-3">6.3 Ansible</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: Infrastructure as Code (IaC)</h1>
                </div>

                <div id="chapter6">
                    <h2 class="chapter-title">インフラの自動化とコード管理</h2>

                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Infrastructure as Code（IaC）の概念とメリットを理解する</li>
                            <li>Terraformの基礎と実践方法を習得する</li>
                            <li>Ansibleによる構成管理を学ぶ</li>
                            <li>TerraformとAnsibleの使い分けを理解する</li>
                            <li>実際にAWSインフラをコード化する</li>
                        </ul>
                    </div>

                    <h3 class="section-title" id="section6-1">6.1 Infrastructure as Code とは</h3>

                    <p>Infrastructure as Code（IaC）は、インフラストラクチャをコードで定義・管理する手法です。手動設定ではなく、コードでインフラを記述することで、自動化・再現性・バージョン管理が可能になります。</p>

                    <h4>IaCのメリット</h4>

                    <div class="mermaid">
                        flowchart TD
                            A["従来の手動設定"] --> B["時間がかかる<br/>ヒューマンエラー<br/>ドキュメント不足"]
                            C["IaC（コード化）"] --> D["自動化<br/>再現可能<br/>バージョン管理"]
                            D --> E["インフラの変更を<br/>素早く安全に実施"]
                    </div>

                    <ul>
                        <li><strong>再現性</strong>: 同じコードから同じインフラを何度でも構築できる</li>
                        <li><strong>バージョン管理</strong>: Gitでインフラの変更履歴を追跡</li>
                        <li><strong>レビュー可能</strong>: Pull Requestでインフラ変更をレビュー</li>
                        <li><strong>ドキュメント</strong>: コード自体が最新のドキュメント</li>
                        <li><strong>自動化</strong>: CI/CDパイプラインでインフラをデプロイ</li>
                        <li><strong>災害復旧</strong>: インフラを迅速に再構築可能</li>
                    </ul>

                    <h4>IaCの主要ツール</h4>

                    <table class="table table-bordered">
                        <thead class="table-primary">
                            <tr><th>ツール</th><th>タイプ</th><th>特徴</th><th>対応クラウド</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Terraform</strong></td>
                                <td>プロビジョニング</td>
                                <td>宣言的、マルチクラウド</td>
                                <td>AWS、Azure、GCP等</td>
                            </tr>
                            <tr>
                                <td><strong>Ansible</strong></td>
                                <td>構成管理</td>
                                <td>エージェントレス、YAML</td>
                                <td>マルチクラウド、オンプレ</td>
                            </tr>
                            <tr>
                                <td><strong>CloudFormation</strong></td>
                                <td>プロビジョニング</td>
                                <td>AWS専用、JSON/YAML</td>
                                <td>AWS</td>
                            </tr>
                            <tr>
                                <td><strong>Pulumi</strong></td>
                                <td>プロビジョニング</td>
                                <td>実際のプログラミング言語</td>
                                <td>マルチクラウド</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="section-title" id="section6-2">6.2 Terraform基礎</h3>

                    <p>Terraformは、HashiCorp社が開発したオープンソースのIaCツールです。HCL（HashiCorp Configuration Language）という宣言的な言語でインフラを定義します。</p>

                    <h4>Terraformの基本概念</h4>

                    <div class="info-box">
                        <h6>主要な構成要素</h6>
                        <ul>
                            <li><strong>Provider</strong>: クラウドプロバイダー（AWS、Azure等）の接続設定</li>
                            <li><strong>Resource</strong>: 作成するインフラリソース（EC2、VPC等）</li>
                            <li><strong>Variable</strong>: パラメータ化された値</li>
                            <li><strong>Output</strong>: 他のモジュールやユーザーに公開する値</li>
                            <li><strong>State</strong>: 現在のインフラの状態を記録するファイル</li>
                        </ul>
                    </div>

                    <h4>基本的なTerraformコード</h4>

                    <pre class="code-block"><code class="language-bash"># main.tf

# 1. Providerの設定
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = var.aws_region
}

# 2. Variableの定義
variable "aws_region" {
  description = "AWS region"
  default     = "ap-northeast-1"
}

variable "instance_type" {
  description = "EC2 instance type"
  default     = "t3.micro"
}

# 3. VPCの作成
resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true

  tags = {
    Name = "main-vpc"
  }
}

# 4. Subnetの作成
resource "aws_subnet" "public" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.1.0/24"
  availability_zone       = "${var.aws_region}a"
  map_public_ip_on_launch = true

  tags = {
    Name = "public-subnet"
  }
}

# 5. EC2インスタンスの作成
resource "aws_instance" "web" {
  ami           = "ami-0c55b159cbfafe1f0"  # Amazon Linux 2
  instance_type = var.instance_type
  subnet_id     = aws_subnet.public.id

  tags = {
    Name = "web-server"
  }
}

# 6. Outputの定義
output "instance_public_ip" {
  description = "Public IP of EC2 instance"
  value       = aws_instance.web.public_ip
}</code></pre>

                    <h4>Terraformワークフロー</h4>

                    <div class="mermaid">
                        flowchart LR
                            A["terraform init<br/>（初期化）"] --> B["terraform plan<br/>（変更プレビュー）"]
                            B --> C["terraform apply<br/>（適用）"]
                            C --> D["terraform destroy<br/>（削除）"]
                    </div>

                    <pre class="code-block"><code class="language-bash"># 1. 初期化（プロバイダープラグインのダウンロード）
terraform init

# 2. 変更内容の確認（dry-run）
terraform plan

# 3. インフラの作成・更新
terraform apply

# 4. 特定のリソースのみ更新
terraform apply -target=aws_instance.web

# 5. インフラの削除
terraform destroy</code></pre>

                    <h4>Terraformモジュール</h4>

                    <p>再利用可能なインフラコンポーネントをモジュール化します。</p>

                    <pre class="code-block"><code class="language-bash"># modules/vpc/main.tf
resource "aws_vpc" "this" {
  cidr_block = var.cidr_block

  tags = merge(
    var.tags,
    {
      Name = var.name
    }
  )
}

# modules/vpc/variables.tf
variable "cidr_block" {
  type = string
}

variable "name" {
  type = string
}

variable "tags" {
  type    = map(string)
  default = {}
}

# modules/vpc/outputs.tf
output "vpc_id" {
  value = aws_vpc.this.id
}

# ルートディレクトリのmain.tf（モジュールの使用）
module "vpc" {
  source = "./modules/vpc"

  cidr_block = "10.0.0.0/16"
  name       = "production-vpc"
  tags = {
    Environment = "production"
    ManagedBy   = "terraform"
  }
}</code></pre>

                    <h3 class="section-title" id="section6-3">6.3 Ansible基礎</h3>

                    <p>Ansibleは、構成管理・アプリケーションデプロイ・タスク自動化のためのツールです。エージェントレスでSSH経由で操作します。</p>

                    <h4>Ansibleの基本構成</h4>

                    <pre class="code-block"><code class="language-yaml"># inventory.ini（インベントリファイル）
[webservers]
web1.example.com
web2.example.com

[databases]
db1.example.com

[all:vars]
ansible_user=ubuntu
ansible_ssh_private_key_file=~/.ssh/id_rsa

# playbook.yml（Playbook）
---
- name: Setup web server
  hosts: webservers
  become: yes  # sudoで実行

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Nginx
      apt:
        name: nginx
        state: present

    - name: Start Nginx service
      service:
        name: nginx
        state: started
        enabled: yes

    - name: Copy website files
      copy:
        src: ./website/
        dest: /var/www/html/
        owner: www-data
        group: www-data
        mode: '0644'</code></pre>

                    <h4>Ansibleの実行</h4>

                    <pre class="code-block"><code class="language-bash"># Playbookの実行
ansible-playbook -i inventory.ini playbook.yml

# 特定のホストのみ実行
ansible-playbook -i inventory.ini playbook.yml --limit web1.example.com

# Dry-run（変更を実際に適用しない）
ansible-playbook -i inventory.ini playbook.yml --check

# Ad-hocコマンド（1回限りのタスク）
ansible webservers -i inventory.ini -m ping
ansible webservers -i inventory.ini -m shell -a "df -h"</code></pre>

                    <h4>TerraformとAnsibleの使い分け</h4>

                    <table class="table table-bordered">
                        <thead class="table-primary">
                            <tr><th>観点</th><th>Terraform</th><th>Ansible</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>用途</td><td>インフラのプロビジョニング</td><td>構成管理・アプリデプロイ</td></tr>
                            <tr><td>対象</td><td>クラウドリソース（VPC、EC2等）</td><td>OS内部の設定</td></tr>
                            <tr><td>言語</td><td>HCL（宣言的）</td><td>YAML（手続き的）</td></tr>
                            <tr><td>エージェント</td><td>不要</td><td>不要（SSH使用）</td></tr>
                            <tr><td>状態管理</td><td>ステートファイルで管理</td><td>べき等性で管理</td></tr>
                        </tbody>
                    </table>

                    <div class="info-box">
                        <h6>組み合わせ例</h6>
                        <p><strong>Terraform</strong>でAWSのVPC、EC2、RDSを作成 → <strong>Ansible</strong>でEC2インスタンス内のNginx、アプリケーション、設定ファイルをデプロイ</p>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 6-1: TerraformでEC2インスタンスを作成</h5>

                        <h6>前提条件</h6>
                        <ul>
                            <li>AWSアカウント</li>
                            <li>AWS CLIの設定（<code>aws configure</code>）</li>
                            <li>Terraformのインストール</li>
                        </ul>

                        <h6>手順</h6>
                        <pre class="code-block"><code class="language-bash"># プロジェクトディレクトリの作成
mkdir terraform-demo && cd terraform-demo

# main.tfの作成
cat > main.tf << 'EOF'
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = "ap-northeast-1"
}

resource "aws_instance" "example" {
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t3.micro"

  tags = {
    Name = "terraform-demo"
  }
}

output "instance_id" {
  value = aws_instance.example.id
}

output "public_ip" {
  value = aws_instance.example.public_ip
}
EOF

# 初期化
terraform init

# プレビュー
terraform plan

# 適用
terraform apply

# 確認（AWS Management Consoleで確認）

# 削除（実習終了後）
terraform destroy</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>Q: Infrastructure as Code（IaC）の主なメリットを3つ挙げてください。</strong><br>
                                A: 再現性（同じインフラを何度でも構築）、バージョン管理（Gitで履歴追跡）、自動化（CI/CDで自動デプロイ）。</li>
                            <li><strong>Q: TerraformとAnsibleの主な違いは何ですか？</strong><br>
                                A: Terraformはインフラのプロビジョニング（クラウドリソースの作成）、Ansibleは構成管理（OS内部の設定・アプリデプロイ）を行います。</li>
                            <li><strong>Q: Terraformのワークフローにおける4つの主要コマンドは何ですか？</strong><br>
                                A: <code>terraform init</code>（初期化）、<code>terraform plan</code>（変更プレビュー）、<code>terraform apply</code>（適用）、<code>terraform destroy</code>（削除）。</li>
                            <li><strong>Q: Terraformのステートファイルの役割は何ですか？</strong><br>
                                A: 現在のインフラの状態を記録し、コードと実際のインフラの差分を管理します。これにより、Terraformは変更が必要なリソースのみを更新できます。</li>
                            <li><strong>Q: Ansibleがエージェントレスであることのメリットは何ですか？</strong><br>
                                A: 管理対象サーバーに専用エージェントをインストールする必要がなく、SSH経由で操作できるため、セットアップが簡単で、サーバーへの負荷も少なくなります。</li>
                        </ol>
                    </div>

                    <h3 class="section-title">まとめ</h3>
                    <div class="highlight">
                        <h6>重要ポイント</h6>
                        <ul>
                            <li>IaCでインフラをコード化し、自動化・再現性・バージョン管理を実現</li>
                            <li>Terraformでクラウドリソースをプロビジョニング</li>
                            <li>Ansibleでサーバー内部の構成管理</li>
                            <li>TerraformとAnsibleを組み合わせて完全な自動化</li>
                            <li>GitでIaCコードを管理し、Pull Requestでレビュー</li>
                        </ul>
                    </div>

                    <p>次の章では、「クラウドプラットフォームとDevOps」について学びます。AWS、Azure、GCPのDevOpsサービスを活用した実践的な開発手法を習得します。</p>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="devops-learning-material-5.html" class="btn btn-secondary">← 前の章: Kubernetes</a>
                        <a href="devops-learning-material-7.html" class="btn btn-primary">次の章: クラウドプラットフォーム →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'default' });</script>
</body>
</html>
