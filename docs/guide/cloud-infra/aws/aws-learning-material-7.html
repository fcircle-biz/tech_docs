<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS学習教材 第7章 - 監視と運用管理（CloudWatch・CloudTrail）</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
            line-height: 1.8;
        }

        /* ナビゲーション - AWS Orange */
        .navbar {
            background-color: #FF9900;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 1rem;
        }

        /* タイトル */
        .chapter-title {
            color: #FF9900;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 3px solid #FF9900;
            padding-bottom: 0.5rem;
            font-weight: bold;
        }

        .section-title {
            color: #EC7211;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #FFF3E0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #FF9900;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #fff9e6;
            border-radius: 8px;
            padding: 1.2rem;
            margin: 1.5rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            color: white;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #FF9900 !important;
            color: white !important;
            border-radius: 5px;
        }

        .nav-link {
            color: #333;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background-color: #FFF3E0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <strong>AWS学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aws-learning-material-1.html">
                                第1章: AWS入門とアカウント設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-learning-material-2.html">
                                第2章: コンピューティングとネットワークの基礎
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-learning-material-3.html">
                                第3章: ストレージサービス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-learning-material-4.html">
                                第4章: データベースサービス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-learning-material-5.html">
                                第5章: ネットワークとコンテンツ配信
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-learning-material-6.html">
                                第6章: セキュリティとアクセス管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aws-learning-material-7.html">
                                第7章: 監視と運用管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-learning-material-8.html">
                                第8章: サーバーレスコンピューティング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-learning-material-9.html">
                                第9章: コンテナサービス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-learning-material-10.html">
                                第10章: ベストプラクティスとコスト最適化
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: 監視と運用管理（CloudWatch・CloudTrail）</h1>
                </div>

                <div id="chapter7">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">リソース監視とログ管理による運用効率化</h2>

                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>CloudWatchでメトリクスを監視し、アラームを設定する方法</li>
                            <li>CloudWatch Logsでログを集約・分析する方法</li>
                            <li>CloudTrailでAPI呼び出しを監査する方法</li>
                            <li>自動化により運用タスクを効率化する方法</li>
                            <li>運用のベストプラクティスと障害対応</li>
                        </ul>
                    </div>

                    <!-- セクション1: Amazon CloudWatchの基礎 -->
                    <h3 class="section-title">7.1 Amazon CloudWatch とは</h3>
                    <p>
                        <strong>Amazon CloudWatch</strong>は、AWSリソースとアプリケーションの<strong>監視とオブザーバビリティ</strong>を提供するサービスです。
                        CloudWatchを使用することで、リソースのパフォーマンスメトリクスを収集・可視化し、
                        問題を早期に検知してアラートを発行できます。
                    </p>

                    <h4>7.1.1 オブザーバビリティとは</h4>
                    <p>
                        <strong>オブザーバビリティ（Observability）</strong>とは、システムの内部状態を外部から観察・理解できる能力のことです。
                        オブザーバビリティは以下の3つの柱で構成されます：
                    </p>
                    <ul>
                        <li><strong>メトリクス（Metrics）</strong>：数値データ（CPU使用率、リクエスト数、レイテンシーなど）</li>
                        <li><strong>ログ（Logs）</strong>：イベントの詳細記録（アプリケーションログ、エラーログなど）</li>
                        <li><strong>トレース（Traces）</strong>：リクエストの処理経路（分散システムでのリクエストフロー）</li>
                    </ul>

                    <div class="mermaid">
                        flowchart TD
                            subgraph Observability[オブザーバビリティの3つの柱]
                                M[メトリクス<br/>CPU使用率、リクエスト数]
                                L[ログ<br/>アプリケーションログ、エラーログ]
                                T[トレース<br/>リクエストの処理経路]
                            end
                            subgraph CW[Amazon CloudWatch]
                                CWM[CloudWatch Metrics]
                                CWL[CloudWatch Logs]
                                CWX[X-Ray]
                            end
                            M --> CWM
                            L --> CWL
                            T --> CWX
                            CWM --> D[ダッシュボード]
                            CWL --> D
                            CWX --> D
                            D --> Alert[アラーム・通知]
                    </div>

                    <h4>7.1.2 メトリクスの種類</h4>
                    <p>CloudWatchでは、2種類のメトリクスを扱います：</p>
                    <ul>
                        <li><strong>標準メトリクス</strong>：AWSサービスが自動的に提供するメトリクス
                            <ul>
                                <li>EC2：CPUUtilization、NetworkIn/Out、DiskReadBytes</li>
                                <li>RDS：DatabaseConnections、ReadLatency、WriteLatency</li>
                                <li>ELB：RequestCount、TargetResponseTime、HealthyHostCount</li>
                            </ul>
                        </li>
                        <li><strong>カスタムメトリクス</strong>：ユーザーが独自に送信するメトリクス
                            <ul>
                                <li>アプリケーション固有のメトリクス（処理件数、キュー長など）</li>
                                <li>ビジネスメトリクス（売上、ユーザー登録数など）</li>
                            </ul>
                        </li>
                    </ul>

                    <h4>7.1.3 ダッシュボードの作成とカスタマイズ</h4>
                    <p>
                        <strong>CloudWatchダッシュボード</strong>は、複数のメトリクスを1つの画面で可視化できるカスタマイズ可能なビューです。
                        ダッシュボードには以下のウィジェットタイプがあります：
                    </p>
                    <ul>
                        <li><strong>折れ線グラフ</strong>：時系列データの推移を表示</li>
                        <li><strong>棒グラフ</strong>：複数のリソースの比較</li>
                        <li><strong>数値</strong>：現在の値を大きく表示</li>
                        <li><strong>ログテーブル</strong>：CloudWatch Logsのクエリ結果</li>
                    </ul>

                    <!-- セクション2: CloudWatch Alarmsとイベント -->
                    <h3 class="section-title">7.2 CloudWatch Alarms とイベント</h3>

                    <h4>7.2.1 アラームの作成と閾値設定</h4>
                    <p>
                        <strong>CloudWatch Alarm</strong>は、メトリクスが指定した閾値を超えた場合に、
                        自動的にアクションを実行する仕組みです。アラームには3つの状態があります：
                    </p>
                    <ul>
                        <li><strong>OK</strong>：メトリクスが閾値以内</li>
                        <li><strong>ALARM</strong>：メトリクスが閾値を超えた</li>
                        <li><strong>INSUFFICIENT_DATA</strong>：データが不足しており判定不可</li>
                    </ul>

                    <h4>7.2.2 アラームアクション</h4>
                    <p>アラームがALARM状態になった際に実行できるアクション：</p>
                    <ul>
                        <li><strong>SNS通知</strong>：メール、SMS、Lambda関数の実行</li>
                        <li><strong>Auto Scalingアクション</strong>：EC2インスタンスの自動追加/削除</li>
                        <li><strong>EC2アクション</strong>：インスタンスの停止、終了、再起動、復旧</li>
                        <li><strong>Systems Managerアクション</strong>：自動修復スクリプトの実行</li>
                    </ul>

                    <div class="mermaid">
                        flowchart LR
                            subgraph EC2[EC2インスタンス]
                                CPU[CPU使用率]
                            end
                            subgraph CW[CloudWatch]
                                M[メトリクス収集]
                                A[アラーム<br/>CPU &gt; 80%]
                            end
                            subgraph SNS[Amazon SNS]
                                T[トピック]
                            end
                            subgraph Action[アクション]
                                E[メール通知]
                                L[Lambda実行]
                                AS[Auto Scaling]
                            end

                            CPU --> M
                            M --> A
                            A -->|ALARM状態| T
                            T --> E
                            T --> L
                            T --> AS
                    </div>

                    <h4>7.2.3 複合アラームによる複雑な条件設定</h4>
                    <p>
                        <strong>複合アラーム</strong>は、複数のアラームを論理演算子（AND、OR、NOT）で組み合わせて、
                        より複雑な条件を設定できます。
                    </p>
                    <p>例：「CPU使用率が80%以上 AND メモリ使用率が90%以上」の場合のみアラート</p>

                    <div class="exercise-container">
                        <h5>実習 7-1: EC2のCPU使用率監視アラームの作成とSNS通知設定</h5>
                        <p>EC2インスタンスのCPU使用率を監視し、閾値を超えた場合にメール通知を送信してみましょう。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>まず、SNSトピックを作成：
                                <ul>
                                    <li>SNSコンソールで「Create topic」</li>
                                    <li>タイプ：Standard、名前：<code>EC2-CPU-Alert</code></li>
                                    <li>「Create subscription」でメールアドレスを登録</li>
                                    <li>受信したメールで購読を確認</li>
                                </ul>
                            </li>
                            <li>CloudWatchコンソールで「Alarms」→「Create alarm」</li>
                            <li>「Select metric」→「EC2」→「Per-Instance Metrics」</li>
                            <li>監視するインスタンスの「CPUUtilization」を選択</li>
                            <li>条件設定：
                                <ul>
                                    <li>閾値タイプ：Static</li>
                                    <li>条件：Greater（より大きい）</li>
                                    <li>閾値：80</li>
                                </ul>
                            </li>
                            <li>アクション設定：
                                <ul>
                                    <li>「In alarm」状態で<code>EC2-CPU-Alert</code>トピックに通知</li>
                                </ul>
                            </li>
                            <li>アラーム名：<code>EC2-High-CPU</code>で作成</li>
                            <li>テスト：EC2でCPU負荷をかけるコマンドを実行
<pre class="code-block"><code class="language-bash"># ストレステスト（5分間）
stress --cpu 4 --timeout 300s</code></pre>
                            </li>
                            <li>メールでアラート通知を受信することを確認</li>
                        </ol>
                        <h6>確認ポイント</h6>
                        <ul>
                            <li>CPU使用率が閾値を超えるとアラームがALARM状態に遷移すること</li>
                            <li>SNS経由でメール通知が届くこと</li>
                            <li>CPU使用率が下がるとOK状態に戻ること</li>
                        </ul>
                    </div>

                    <!-- セクション3: CloudWatch Logs -->
                    <h3 class="section-title">7.3 CloudWatch Logs</h3>

                    <h4>7.3.1 ロググループとログストリームの概念</h4>
                    <p>CloudWatch Logsは、ログデータを階層的に管理します：</p>
                    <ul>
                        <li><strong>ロググループ</strong>：同じ保持期間やアクセス制御設定を共有するログストリームの集合
                            <ul>
                                <li>例：<code>/aws/lambda/my-function</code>、<code>/var/log/syslog</code></li>
                            </ul>
                        </li>
                        <li><strong>ログストリーム</strong>：同じソースからのログイベントのシーケンス
                            <ul>
                                <li>例：特定のEC2インスタンスからのログ、特定のLambda実行のログ</li>
                            </ul>
                        </li>
                        <li><strong>ログイベント</strong>：個々のログエントリ（タイムスタンプとメッセージ）</li>
                    </ul>

                    <div class="mermaid">
                        flowchart TD
                            subgraph LG1[ロググループ: /aws/ec2/webserver]
                                LS1[ログストリーム:<br/>i-0123456789abcdef0]
                                LS2[ログストリーム:<br/>i-abcdef0123456789]
                            end
                            subgraph LG2[ロググループ: /var/log/application]
                                LS3[ログストリーム:<br/>app-server-1]
                                LS4[ログストリーム:<br/>app-server-2]
                            end
                            LS1 --> E1[ログイベント1<br/>2025-10-30 10:00:00 - Started]
                            LS1 --> E2[ログイベント2<br/>2025-10-30 10:01:00 - Processing]
                    </div>

                    <h4>7.3.2 EC2、Lambda、ECSからのログ収集</h4>
                    <p>各AWSサービスからCloudWatch Logsにログを送信する方法：</p>

                    <p><strong>EC2からのログ収集</strong></p>
                    <ul>
                        <li><strong>CloudWatch Logs Agent</strong>：従来のエージェント（非推奨）</li>
                        <li><strong>CloudWatch unified agent</strong>：推奨される統合エージェント
                            <ul>
                                <li>ログとシステムメトリクス（メモリ、ディスク等）を収集</li>
                                <li>設定ファイルでログファイルのパスを指定</li>
                            </ul>
                        </li>
                    </ul>

                    <p><strong>Lambdaからのログ収集</strong></p>
                    <ul>
                        <li>Lambda関数の標準出力とエラー出力が自動的にCloudWatch Logsに送信</li>
                        <li>ロググループ名：<code>/aws/lambda/&lt;関数名&gt;</code></li>
                    </ul>

                    <p><strong>ECSからのログ収集</strong></p>
                    <ul>
                        <li>タスク定義でログドライバーとして<code>awslogs</code>を指定</li>
                        <li>コンテナの標準出力がCloudWatch Logsに送信される</li>
                    </ul>

                    <h4>7.3.3 ログの検索とフィルタリング</h4>
                    <p>
                        CloudWatch Logsでは、<strong>フィルタパターン</strong>を使用してログを検索できます。
                        フィルタパターンの例：
                    </p>
                    <ul>
                        <li><code>[ERROR]</code>：「ERROR」という文字列を含むログ</li>
                        <li><code>[time, request_id, event_type = "UserLogin", ...]</code>：構造化ログの解析</li>
                        <li><code>{ $.statusCode = 500 }</code>：JSONログからステータスコード500を抽出</li>
                    </ul>

                    <h4>7.3.4 CloudWatch Logs Insightsによる高度なログクエリ</h4>
                    <p>
                        <strong>Logs Insights</strong>は、SQLライクなクエリ言語を使用して、
                        大量のログデータを高速に分析できる機能です。
                    </p>
                    <p>クエリ例：</p>
                    <pre class="code-block"><code class="language-sql">-- ステータスコード別のリクエスト数を集計
fields @timestamp, @message
| filter @message like /status_code/
| parse @message "status_code=*" as status
| stats count() by status

-- レイテンシーの高いリクエストを抽出
fields @timestamp, latency, request_id
| filter latency > 1000
| sort latency desc
| limit 20

-- エラーログの時系列集計
filter @message like /ERROR/
| stats count() as error_count by bin(5m)</code></pre>

                    <div class="exercise-container">
                        <h5>実習 7-2: CloudWatch Logsを使ったアプリケーションログの集約</h5>
                        <p>EC2インスタンスからアプリケーションログをCloudWatch Logsに送信してみましょう。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>EC2にCloudWatch unified agentをインストール：
<pre class="code-block"><code class="language-bash"># Amazon Linux 2の場合
sudo yum install -y amazon-cloudwatch-agent</code></pre>
                            </li>
                            <li>エージェント設定ファイルを作成（<code>/opt/aws/amazon-cloudwatch-agent/etc/config.json</code>）：
<pre class="code-block"><code class="language-json">{
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list": [
          {
            "file_path": "/var/log/myapp/application.log",
            "log_group_name": "/myapp/application",
            "log_stream_name": "{instance_id}"
          }
        ]
      }
    }
  }
}</code></pre>
                            </li>
                            <li>EC2インスタンスロールに<code>CloudWatchAgentServerPolicy</code>をアタッチ</li>
                            <li>エージェントを起動：
<pre class="code-block"><code class="language-bash">sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
  -a fetch-config -m ec2 -s \
  -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json</code></pre>
                            </li>
                            <li>テストログを生成：
<pre class="code-block"><code class="language-bash">mkdir -p /var/log/myapp
echo "$(date) - Application started" >> /var/log/myapp/application.log
echo "$(date) - Processing request #1" >> /var/log/myapp/application.log
echo "$(date) - ERROR: Failed to connect to database" >> /var/log/myapp/application.log</code></pre>
                            </li>
                            <li>CloudWatchコンソールで「Logs」→「Log groups」から<code>/myapp/application</code>を確認</li>
                            <li>Logs Insightsでエラーログを検索：
<pre class="code-block"><code class="language-sql">fields @timestamp, @message
| filter @message like /ERROR/
| sort @timestamp desc</code></pre>
                            </li>
                        </ol>
                        <h6>確認ポイント</h6>
                        <ul>
                            <li>ロググループにログストリームが作成されていること</li>
                            <li>ログイベントがリアルタイムで表示されること</li>
                            <li>Logs Insightsでログを検索・分析できること</li>
                        </ul>
                    </div>

                    <!-- セクション4: AWS CloudTrail -->
                    <h3 class="section-title">7.4 AWS CloudTrail</h3>

                    <h4>7.4.1 CloudTrailとは</h4>
                    <p>
                        <strong>AWS CloudTrail</strong>は、AWSアカウント内で実行されたすべてのAPI呼び出しを記録する<strong>監査ログサービス</strong>です。
                        CloudTrailは、以下のような情報を記録します：
                    </p>
                    <ul>
                        <li><strong>誰が</strong>：どのIAMユーザーまたはロールが操作を実行したか</li>
                        <li><strong>何を</strong>：どのAPIアクションを実行したか（例：CreateBucket、RunInstances）</li>
                        <li><strong>いつ</strong>：操作が実行された日時</li>
                        <li><strong>どこから</strong>：送信元IPアドレス</li>
                        <li><strong>結果</strong>：操作が成功したか失敗したか</li>
                    </ul>

                    <h4>7.4.2 トレイルの作成と設定</h4>
                    <p>
                        <strong>トレイル</strong>は、CloudTrailログを収集し、指定したS3バケットに保存する設定です。
                        トレイルには以下の種類があります：
                    </p>
                    <ul>
                        <li><strong>単一リージョントレイル</strong>：特定のリージョンのイベントのみを記録</li>
                        <li><strong>すべてのリージョントレイル</strong>：すべてのリージョンのイベントを記録（推奨）</li>
                        <li><strong>組織トレイル</strong>：AWS Organizations内のすべてのアカウントのイベントを記録</li>
                    </ul>

                    <h4>7.4.3 管理イベントとデータイベント</h4>
                    <p>CloudTrailは2種類のイベントを記録できます：</p>
                    <ul>
                        <li><strong>管理イベント</strong>：AWSリソースに対する管理操作（無料で記録）
                            <ul>
                                <li>例：EC2インスタンスの起動、IAMユーザーの作成、S3バケットの作成</li>
                            </ul>
                        </li>
                        <li><strong>データイベント</strong>：リソース内のデータ操作（有料）
                            <ul>
                                <li>例：S3オブジェクトのGetObject、PutObject、Lambda関数の実行</li>
                            </ul>
                        </li>
                    </ul>

                    <h4>7.4.4 CloudTrailログの分析</h4>
                    <p>CloudTrailログは、S3に保存されたJSON形式のファイルです。ログを分析する方法：</p>
                    <ul>
                        <li><strong>CloudTrailコンソール</strong>：Event historyで過去90日間のイベントを検索</li>
                        <li><strong>CloudWatch Logs統合</strong>：リアルタイム監視とアラーム設定</li>
                        <li><strong>Amazon Athena</strong>：SQLクエリでS3のログファイルを分析</li>
                        <li><strong>AWS CLI</strong>：<code>aws cloudtrail lookup-events</code>コマンドで検索</li>
                    </ul>

                    <div class="mermaid">
                        flowchart LR
                            subgraph User[ユーザー/アプリケーション]
                                U[IAMユーザー]
                            end
                            subgraph AWS[AWS API]
                                API[EC2 RunInstances<br/>S3 CreateBucket<br/>IAM CreateUser]
                            end
                            subgraph CT[CloudTrail]
                                Log[ログ記録]
                            end
                            subgraph Storage[ストレージ]
                                S3[S3バケット<br/>長期保存]
                                CWL[CloudWatch Logs<br/>リアルタイム分析]
                            end

                            U -->|1. API呼び出し| API
                            API -->|2. イベント通知| Log
                            Log -->|3. ログ保存| S3
                            Log -->|4. ログ送信| CWL
                            CWL -->|5. アラーム| SNS[SNS通知]
                    </div>

                    <div class="exercise-container">
                        <h5>実習 7-3: CloudTrailログの有効化と特定APIアクションの追跡</h5>
                        <p>CloudTrailトレイルを作成し、セキュリティ関連のAPI操作を追跡してみましょう。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>CloudTrailコンソールで「Create trail」</li>
                            <li>トレイル設定：
                                <ul>
                                    <li>名前：<code>my-organization-trail</code></li>
                                    <li>すべてのリージョンのイベントを記録：有効</li>
                                    <li>管理イベント：読み取りと書き込み</li>
                                </ul>
                            </li>
                            <li>S3バケット：新しいバケットを作成（名前：<code>my-cloudtrail-logs-[account-id]</code>）</li>
                            <li>CloudWatch Logsへの配信を有効化：
                                <ul>
                                    <li>新しいロググループ：<code>/aws/cloudtrail/my-trail</code></li>
                                    <li>IAMロールを自動作成</li>
                                </ul>
                            </li>
                            <li>トレイルを作成</li>
                            <li>テスト操作を実行：
<pre class="code-block"><code class="language-bash"># 新しいS3バケットを作成
aws s3 mb s3://my-test-bucket-$(date +%s)

# IAMユーザーのリストを取得
aws iam list-users</code></pre>
                            </li>
                            <li>CloudTrailコンソールの「Event history」で操作を確認</li>
                            <li>CloudWatch Logs Insightsでログを検索：
<pre class="code-block"><code class="language-sql">fields @timestamp, eventName, userIdentity.principalId, sourceIPAddress
| filter eventName like /CreateBucket|CreateUser|DeleteBucket/
| sort @timestamp desc
| limit 20</code></pre>
                            </li>
                        </ol>
                        <h6>確認ポイント</h6>
                        <ul>
                            <li>実行したAPI操作がCloudTrailに記録されていること</li>
                            <li>ユーザー情報、IPアドレス、タイムスタンプが記録されていること</li>
                            <li>CloudWatch Logsで特定のイベントを検索できること</li>
                        </ul>
                    </div>

                    <!-- セクション5: 運用自動化とその他の管理サービス -->
                    <h3 class="section-title">7.5 運用自動化とその他の管理サービス</h3>

                    <h4>7.5.1 AWS Systems Manager</h4>
                    <p>
                        <strong>AWS Systems Manager</strong>は、AWSリソースとオンプレミスリソースを統合的に管理するサービスです。
                        主要な機能：
                    </p>
                    <ul>
                        <li><strong>Session Manager</strong>：ブラウザベースのシェルアクセス（SSHキー不要）</li>
                        <li><strong>Patch Manager</strong>：OSパッチの自動適用</li>
                        <li><strong>State Manager</strong>：設定の継続的な適用</li>
                        <li><strong>Automation</strong>：運用タスクの自動化</li>
                        <li><strong>Parameter Store</strong>：設定値とシークレットの保存</li>
                    </ul>

                    <h4>7.5.2 Session Manager：ブラウザベースのシェルアクセス</h4>
                    <p>
                        <strong>Session Manager</strong>を使用すると、SSHポートを開放せずに、
                        ブラウザからEC2インスタンスに安全にアクセスできます。
                    </p>
                    <p>Session Managerの利点：</p>
                    <ul>
                        <li>SSHキーの管理不要</li>
                        <li>セキュリティグループでSSHポート（22）を開放する必要がない</li>
                        <li>すべてのセッションがCloudTrailに記録される</li>
                        <li>セッションログをS3やCloudWatch Logsに保存可能</li>
                    </ul>

                    <h4>7.5.3 Patch Manager：パッチ管理の自動化</h4>
                    <p>
                        <strong>Patch Manager</strong>は、EC2インスタンスとオンプレミスサーバーに対して、
                        OSパッチを自動的に適用する機能です。
                    </p>
                    <p>パッチ管理のワークフロー：</p>
                    <ol>
                        <li>パッチベースラインを定義（どのパッチを適用するか）</li>
                        <li>メンテナンスウィンドウを設定（パッチ適用のスケジュール）</li>
                        <li>自動的にパッチがスキャン・適用される</li>
                        <li>パッチコンプライアンスレポートで適用状況を確認</li>
                    </ol>

                    <h4>7.5.4 AWS Trusted Advisor</h4>
                    <p>
                        <strong>AWS Trusted Advisor</strong>は、AWSアカウントをベストプラクティスに基づいて評価し、
                        改善の推奨事項を提供するサービスです。
                    </p>
                    <p>5つのカテゴリーでチェックを実行：</p>
                    <ul>
                        <li><strong>コスト最適化</strong>：未使用のリソース、リザーブドインスタンスの推奨</li>
                        <li><strong>パフォーマンス</strong>：スループットの改善、レイテンシーの削減</li>
                        <li><strong>セキュリティ</strong>：セキュリティグループの設定、MFAの有効化</li>
                        <li><strong>耐障害性</strong>：マルチAZ構成、バックアップの有無</li>
                        <li><strong>サービス制限</strong>：サービスクォータの使用状況</li>
                    </ul>

                    <h4>7.5.5 AWS Personal Health Dashboard</h4>
                    <p>
                        <strong>Personal Health Dashboard</strong>は、使用しているAWSサービスの健全性を表示し、
                        リソースに影響する可能性のあるイベントを通知します。
                    </p>
                    <p>表示される情報：</p>
                    <ul>
                        <li>進行中のメンテナンス</li>
                        <li>サービス障害の影響</li>
                        <li>推奨されるアクション</li>
                        <li>過去のイベント履歴</li>
                    </ul>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>オブザーバビリティの3つの柱とは何ですか？</strong>
                                <details>
                                    <summary>解答例を表示</summary>
                                    <p>
                                        1. <strong>メトリクス</strong>：数値データ（CPU使用率、リクエスト数、レイテンシーなど）<br>
                                        2. <strong>ログ</strong>：イベントの詳細記録（アプリケーションログ、エラーログなど）<br>
                                        3. <strong>トレース</strong>：リクエストの処理経路（分散システムでのリクエストフロー）
                                    </p>
                                </details>
                            </li>
                            <li>
                                <strong>CloudWatch Alarmの3つの状態とそれぞれの意味を説明してください。</strong>
                                <details>
                                    <summary>解答例を表示</summary>
                                    <p>
                                        <strong>OK</strong>：メトリクスが設定した閾値以内にある正常な状態<br>
                                        <strong>ALARM</strong>：メトリクスが閾値を超えた異常な状態<br>
                                        <strong>INSUFFICIENT_DATA</strong>：メトリクスのデータが不足しており、判定できない状態
                                    </p>
                                </details>
                            </li>
                            <li>
                                <strong>CloudWatch LogsとCloudTrailの違いは何ですか？</strong>
                                <details>
                                    <summary>解答例を表示</summary>
                                    <p>
                                        <strong>CloudWatch Logs</strong>は、アプリケーションやシステムのログデータ（標準出力、エラーログ、アクセスログなど）を
                                        収集・保存・分析するサービスです。<br>
                                        <strong>CloudTrail</strong>は、AWSアカウント内で実行されたすべてのAPI呼び出しを記録する監査ログサービスで、
                                        「誰が」「何を」「いつ」実行したかを追跡します。
                                    </p>
                                </details>
                            </li>
                            <li>
                                <strong>CloudTrailの管理イベントとデータイベントの違いを説明してください。</strong>
                                <details>
                                    <summary>解答例を表示</summary>
                                    <p>
                                        <strong>管理イベント</strong>は、AWSリソースに対する管理操作（EC2インスタンスの起動、IAMユーザーの作成など）で、
                                        無料で記録されます。<br>
                                        <strong>データイベント</strong>は、リソース内のデータ操作（S3オブジェクトのGetObject/PutObject、Lambda関数の実行など）で、
                                        有料で記録されます。
                                    </p>
                                </details>
                            </li>
                            <li>
                                <strong>AWS Systems Manager Session Managerを使用する利点を3つ挙げてください。</strong>
                                <details>
                                    <summary>解答例を表示</summary>
                                    <p>
                                        1. SSHキーの管理が不要<br>
                                        2. セキュリティグループでSSHポート（22）を開放する必要がなく、セキュリティリスクが軽減される<br>
                                        3. すべてのセッションがCloudTrailに記録され、監査証跡が残る
                                    </p>
                                </details>
                            </li>
                            <li>
                                <strong>CloudWatch Logs Insightsの主な用途は何ですか？</strong>
                                <details>
                                    <summary>解答例を表示</summary>
                                    <p>
                                        CloudWatch Logs Insightsは、SQLライクなクエリ言語を使用して、大量のログデータを高速に分析できる機能です。
                                        エラーログの抽出、レイテンシーの高いリクエストの特定、ステータスコード別の集計など、
                                        複雑なログ分析を効率的に実行できます。
                                    </p>
                                </details>
                            </li>
                        </ol>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">まとめ</h3>
                    <p>この章では、AWSの監視と運用管理について学習しました：</p>
                    <ul>
                        <li><strong>CloudWatch</strong>：メトリクス監視、アラーム設定、ダッシュボード作成によるリソース監視</li>
                        <li><strong>CloudWatch Logs</strong>：ログの集約、検索、分析によるトラブルシューティング</li>
                        <li><strong>CloudTrail</strong>：API呼び出しの監査ログ記録によるセキュリティとコンプライアンス</li>
                        <li><strong>Systems Manager</strong>：Session Manager、Patch Manager、Automationによる運用自動化</li>
                        <li><strong>Trusted Advisor</strong>：ベストプラクティスに基づく改善推奨</li>
                    </ul>
                    <p>
                        次の章では、サーバー管理不要のサーバーレスアーキテクチャを実現するLambdaとAPI Gatewayについて学習します。
                    </p>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-5 mb-4">
                        <a href="aws-learning-material-6.html" class="btn btn-secondary">← 前の章：セキュリティとアクセス管理</a>
                        <a href="aws-learning-material-8.html" class="btn btn-primary">次の章：サーバーレスコンピューティング →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>

    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>
