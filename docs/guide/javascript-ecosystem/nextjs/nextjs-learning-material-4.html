<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next.js学習教材 第4章 - サーバーコンポーネントとクライアントコンポーネント</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #667eea; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #667eea; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; }
        .section-title { color: #764ba2; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container { background-color: rgba(102, 126, 234, 0.1); border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #667eea; }
        .exercise-container { background-color: #f3e5f5; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #764ba2; }
        .highlight { background-color: #ffecb3; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #667eea; }
        .warning { background-color: #ffebee; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #f44336; }
        .code-block { background-color: #1e1e1e; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #667eea !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand"><strong>Next.js学習教材</strong></a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-1.html">第1章: Next.js入門と環境構築</a></li>
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-2.html">第2章: Reactの基礎とコンポーネント設計</a></li>
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-3.html">第3章: ページとルーティング（App Router）</a></li>
                        <li class="nav-item"><a class="nav-link active" href="nextjs-learning-material-4.html">第4章: サーバーコンポーネントとクライアントコンポーネント</a></li>
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-5.html">第5章: データフェッチングとレンダリング戦略</a></li>
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-6.html">第6章: APIルートとサーバーアクション</a></li>
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-7.html">第7章: スタイリングと画像最適化</a></li>
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-8.html">第8章: 認証とミドルウェア</a></li>
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-9.html">第9章: パフォーマンス最適化とベストプラクティス</a></li>
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-10.html">第10章: デプロイメントと本番環境設定</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第4章: サーバーコンポーネントとクライアントコンポーネント</h1>
                </div>

                <div id="chapter4">
                    <h2 class="chapter-title">React Server Componentsの革新</h2>

                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>React Server Components（RSC）の概念と利点を理解する</li>
                            <li>サーバーコンポーネントとクライアントコンポーネントの違いを把握する</li>
                            <li>"use client"ディレクティブの使い方を習得する</li>
                            <li>適切なコンポーネントの使い分けを学ぶ</li>
                            <li>パフォーマンス最適化の基本を理解する</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.1 React Server Componentsとは</h3>

                    <h4>4.1.1 従来のReactとの違い</h4>
                    <p>
                        従来のReactアプリケーションでは、すべてのコンポーネントが<strong>ブラウザ（クライアント）</strong>で実行されていました。Next.js 13のApp Routerでは、デフォルトで<strong>サーバー側</strong>で実行されるコンポーネントが導入されました。
                    </p>

                    <div class="mermaid">
                        flowchart LR
                            subgraph 従来["従来のReact"]
                                A1["すべてのコンポーネント<br/>がクライアントで実行"]
                                A1 --> A2["JavaScriptバンドルが大きい"]
                            end
                            
                            subgraph NextJS["Next.js App Router"]
                                B1["サーバーコンポーネント<br/>（デフォルト）"]
                                B2["クライアントコンポーネント<br/>（'use client'指定）"]
                                B1 --> B3["軽量なバンドル"]
                                B2 --> B3
                            end
                    </div>

                    <h4>4.1.2 サーバーコンポーネントの利点</h4>
                    <ul>
                        <li><strong>バンドルサイズの削減</strong>：サーバーコンポーネントのコードはブラウザに送られない</li>
                        <li><strong>直接データアクセス</strong>：データベースやファイルシステムに直接アクセス可能</li>
                        <li><strong>セキュリティ向上</strong>：APIキーや機密情報をサーバー側で安全に扱える</li>
                        <li><strong>初回表示の高速化</strong>：サーバーでHTMLを生成してから送信</li>
                        <li><strong>SEO最適化</strong>：検索エンジンが完全なHTMLを取得できる</li>
                    </ul>

                    <h3 class="section-title">4.2 サーバーコンポーネントの基本</h3>

                    <h4>4.2.1 デフォルトはサーバーコンポーネント</h4>
                    <p>
                        App Routerでは、特に指定しない限り、すべてのコンポーネントがサーバーコンポーネントです：
                    </p>

                    <pre class="code-block"><code class="language-javascript">// app/components/ServerComponent.js
// デフォルトでサーバーコンポーネント

export default function ServerComponent() {
  // サーバー側で実行される
  const serverTime = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
  
  return (
    &lt;div&gt;
      &lt;h2&gt;サーバーコンポーネント&lt;/h2&gt;
      &lt;p&gt;サーバー時刻: {serverTime}&lt;/p&gt;
    &lt;/div&gt;
  );
}</code></pre>

                    <h4>4.2.2 サーバーコンポーネントでできること</h4>

                    <pre class="code-block"><code class="language-javascript">// app/page.js
import fs from 'fs/promises';  // Node.jsのfsモジュールを直接使用可能

export default async function HomePage() {
  // ファイルシステムに直接アクセス
  const data = await fs.readFile('data.txt', 'utf-8');
  
  // 環境変数を直接使用（クライアントに送信されない）
  const apiKey = process.env.SECRET_API_KEY;
  
  // データベースクエリ（例）
  // const users = await db.users.findMany();
  
  return (
    &lt;div&gt;
      &lt;h1&gt;サーバーで取得したデータ&lt;/h1&gt;
      &lt;p&gt;{data}&lt;/p&gt;
    &lt;/div&gt;
  );
}</code></pre>

                    <h4>4.2.3 サーバーコンポーネントでできないこと</h4>

                    <div class="warning">
                        <h6>サーバーコンポーネントの制限</h6>
                        <ul>
                            <li>useState、useEffect などのReact Hooksは使用不可</li>
                            <li>イベントハンドラ（onClick等）は使用不可</li>
                            <li>ブラウザAPI（window、document等）は使用不可</li>
                            <li>クライアント側のライブラリは使用不可</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.3 クライアントコンポーネント</h3>

                    <h4>4.3.1 "use client"ディレクティブ</h4>
                    <p>
                        クライアントコンポーネントとして扱うには、ファイルの先頭に<code>'use client'</code>を記述します：
                    </p>

                    <pre class="code-block"><code class="language-javascript">// app/components/Counter.js
'use client';  // クライアントコンポーネントとして指定

import { useState } from 'react';

export default function Counter() {
  const [count, setCount] = useState(0);
  
  return (
    &lt;div&gt;
      &lt;p&gt;カウント: {count}&lt;/p&gt;
      &lt;button onClick={() =&gt; setCount(count + 1)}&gt;
        +1
      &lt;/button&gt;
    &lt;/div&gt;
  );
}</code></pre>

                    <h4>4.3.2 クライアントコンポーネントが必要な場合</h4>
                    <p>以下の機能を使う場合は、クライアントコンポーネントにする必要があります：</p>

                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>機能</th>
                                    <th>例</th>
                                    <th>理由</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>State管理</td>
                                    <td>useState、useReducer</td>
                                    <td>状態はクライアント側で管理</td>
                                </tr>
                                <tr>
                                    <td>副作用</td>
                                    <td>useEffect、useLayoutEffect</td>
                                    <td>ブラウザのライフサイクルに依存</td>
                                </tr>
                                <tr>
                                    <td>イベントハンドラ</td>
                                    <td>onClick、onChange</td>
                                    <td>ユーザーインタラクション</td>
                                </tr>
                                <tr>
                                    <td>ブラウザAPI</td>
                                    <td>localStorage、window</td>
                                    <td>ブラウザ環境でのみ利用可能</td>
                                </tr>
                                <tr>
                                    <td>カスタムフック</td>
                                    <td>useRouter、useSearchParams</td>
                                    <td>クライアント側のルーティング</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 class="section-title">4.4 コンポーネントの使い分け</h3>

                    <h4>4.4.1 使い分けの基本原則</h4>
                    <div class="highlight">
                        <h6>推奨される使い分け</h6>
                        <ul>
                            <li><strong>デフォルトはサーバーコンポーネント</strong>を使用</li>
                            <li><strong>インタラクティブな部品のみ</strong>クライアントコンポーネントに</li>
                            <li>できるだけ<strong>葉（末端）のコンポーネント</strong>をクライアント化</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 4-1: サーバーとクライアントの組み合わせ</h5>
                        
                        <h6>適切な設計パターン</h6>
                        <pre class="code-block"><code class="language-javascript">// app/page.js（サーバーコンポーネント）
import Counter from './components/Counter';
import LikeButton from './components/LikeButton';

export default async function Page() {
  // サーバーでデータ取得
  const posts = await fetch('https://api.example.com/posts').then(res =&gt; res.json());
  
  return (
    &lt;div&gt;
      &lt;h1&gt;ブログ記事一覧&lt;/h1&gt;
      {posts.map(post =&gt; (
        &lt;article key={post.id}&gt;
          &lt;h2&gt;{post.title}&lt;/h2&gt;
          &lt;p&gt;{post.content}&lt;/p&gt;
          {/* クライアントコンポーネントを埋め込む */}
          &lt;LikeButton postId={post.id} initialLikes={post.likes} /&gt;
        &lt;/article&gt;
      ))}
    &lt;/div&gt;
  );
}</code></pre>

                        <pre class="code-block"><code class="language-javascript">// app/components/LikeButton.js（クライアントコンポーネント）
'use client';

import { useState } from 'react';

export default function LikeButton({ postId, initialLikes }) {
  const [likes, setLikes] = useState(initialLikes);
  const [liked, setLiked] = useState(false);
  
  const handleLike = async () => {
    if (liked) return;
    
    setLikes(likes + 1);
    setLiked(true);
    
    // APIにいいねを送信
    await fetch(`/api/posts/${postId}/like`, { method: 'POST' });
  };
  
  return (
    &lt;button onClick={handleLike} disabled={liked}&gt;
      ❤️ {likes} {liked ? '済' : ''}
    &lt;/button&gt;
  );
}</code></pre>
                    </div>

                    <h4>4.4.2 悪い例：過度なクライアントコンポーネント化</h4>

                    <div class="warning">
                        <pre class="code-block"><code class="language-javascript">// ❌ 悪い例：ページ全体をクライアントコンポーネントに
'use client';

export default function Page() {
  const [data, setData] = useState([]);
  
  useEffect(() => {
    fetch('/api/data').then(res => res.json()).then(setData);
  }, []);
  
  // 大量のコンポーネントツリー...
}</code></pre>

                        <p>この設計の問題点：</p>
                        <ul>
                            <li>JavaScriptバンドルが大きくなる</li>
                            <li>初回表示が遅くなる</li>
                            <li>SEO効果が低下する</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.5 コンポーネント間のデータ受け渡し</h3>

                    <h4>4.5.1 サーバー → クライアントコンポーネント</h4>
                    <p>Propsを使って、サーバーコンポーネントからクライアントコンポーネントへデータを渡せます：</p>

                    <pre class="code-block"><code class="language-javascript">// app/page.js（サーバーコンポーネント）
import UserProfile from './components/UserProfile';

export default async function Page() {
  const user = await fetchUserData();
  
  return (
    &lt;div&gt;
      &lt;UserProfile user={user} /&gt;
    &lt;/div&gt;
  );
}</code></pre>

                    <pre class="code-block"><code class="language-javascript">// app/components/UserProfile.js（クライアントコンポーネント）
'use client';

import { useState } from 'react';

export default function UserProfile({ user }) {
  const [isEditing, setIsEditing] = useState(false);
  
  return (
    &lt;div&gt;
      &lt;h2&gt;{user.name}&lt;/h2&gt;
      &lt;button onClick={() =&gt; setIsEditing(!isEditing)}&gt;
        {isEditing ? '保存' : '編集'}
      &lt;/button&gt;
    &lt;/div&gt;
  );
}</code></pre>

                    <h4>4.5.2 クライアントコンポーネント内にサーバーコンポーネント</h4>
                    <p>
                        クライアントコンポーネントの<code>children</code>として、サーバーコンポーネントを渡すことができます：
                    </p>

                    <pre class="code-block"><code class="language-javascript">// app/components/ClientWrapper.js（クライアントコンポーネント）
'use client';

export default function ClientWrapper({ children }) {
  return (
    &lt;div style={{ border: '2px solid blue' }}&gt;
      {children}
    &lt;/div&gt;
  );
}</code></pre>

                    <pre class="code-block"><code class="language-javascript">// app/page.js（サーバーコンポーネント）
import ClientWrapper from './components/ClientWrapper';
import ServerData from './components/ServerData';

export default function Page() {
  return (
    &lt;ClientWrapper&gt;
      {/* ServerDataはサーバーコンポーネント */}
      &lt;ServerData /&gt;
    &lt;/ClientWrapper&gt;
  );
}</code></pre>

                    <h3 class="section-title">4.6 パフォーマンスの考察</h3>

                    <div class="mermaid">
                        flowchart TB
                            A["ページアクセス"]
                            A --> B["サーバーコンポーネント<br/>実行（サーバー側）"]
                            B --> C["HTMLを生成"]
                            C --> D["クライアントに送信"]
                            D --> E["クライアントコンポーネント<br/>ハイドレーション"]
                            E --> F["インタラクティブに"]
                    </div>

                    <h4>4.6.1 バンドルサイズの比較</h4>

                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>コンポーネントタイプ</th>
                                    <th>バンドルに含まれる</th>
                                    <th>JavaScriptサイズ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>サーバーコンポーネント</td>
                                    <td>❌ 含まれない</td>
                                    <td>0 KB（クライアント側）</td>
                                </tr>
                                <tr>
                                    <td>クライアントコンポーネント</td>
                                    <td>✅ 含まれる</td>
                                    <td>コンポーネントのサイズ分</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>App Routerでデフォルトのコンポーネントタイプは何ですか？</strong>
                                <div style="margin-top: 10px; padding: 10px; background-color: white; border-radius: 5px;">
                                    回答：サーバーコンポーネント（特に指定しない限り）
                                </div>
                            </li>
                            <li>
                                <strong>useStateを使用したい場合、ファイル先頭に何を記述する必要がありますか？</strong>
                                <div style="margin-top: 10px; padding: 10px; background-color: white; border-radius: 5px;">
                                    回答：'use client'ディレクティブ
                                </div>
                            </li>
                            <li>
                                <strong>サーバーコンポーネントの主な利点を2つ挙げてください。</strong>
                                <div style="margin-top: 10px; padding: 10px; background-color: white; border-radius: 5px;">
                                    回答例：（1）バンドルサイズの削減、（2）データベースやファイルシステムへの直接アクセス
                                </div>
                            </li>
                        </ol>
                    </div>

                    <h3 class="section-title">4.7 まとめ</h3>
                    <p>この章では、サーバーコンポーネントとクライアントコンポーネントについて学びました：</p>
                    <ul>
                        <li>App Routerではデフォルトがサーバーコンポーネント</li>
                        <li>サーバーコンポーネントはバンドルサイズを削減し、パフォーマンスを向上</li>
                        <li>クライアントコンポーネントは'use client'で指定</li>
                        <li>インタラクティブな機能にはクライアントコンポーネントが必要</li>
                        <li>適切な使い分けがパフォーマンス最適化の鍵</li>
                    </ul>

                    <div class="highlight">
                        <h6>次の章の予告</h6>
                        <p>
                            第5章では、<strong>データフェッチングとレンダリング戦略</strong>について学びます。SSG、SSR、ISRなどの異なるレンダリング方式と、それぞれの使い分けを理解していきます。
                        </p>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="nextjs-learning-material-3.html" class="btn btn-secondary">← 前の章</a>
                        <a href="nextjs-learning-material-5.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>
