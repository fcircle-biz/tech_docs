<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python SQLAlchemy学習教材 第2章 - SQLAlchemy Core基礎</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #306998;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
        }

        /* タイトル */
        .chapter-title {
            color: #306998;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #306998;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #4b8bbe;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f4fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #306998;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #306998 !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Python SQLAlchemy 学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">学習ガイドに戻る</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-01.html">第1章: SQLAlchemy入門と環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter2">第2章: SQLAlchemy Core基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-03.html">第3章: SQLAlchemy ORM基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-04.html">第4章: リレーションシップとJOIN操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-05.html">第5章: 高度なクエリとパフォーマンス最適化</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-06.html">第6章: データベースマイグレーション（Alembic）</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-07.html">第7章: トランザクション管理とエラーハンドリング</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlalchemy-learning-material-08.html">第8章: 実践的なアプリケーション開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第2章: SQLAlchemy Core基礎</h1>
                </div>

                <div id="chapter2">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">SQLAlchemy Core基礎</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>SQLAlchemy Coreの基本概念とアーキテクチャ</li>
                            <li>MetaDataとTableの定義方法</li>
                            <li>Column定義と各種データ型の使い方</li>
                            <li>基本的なCRUD操作（Create、Read、Update、Delete）</li>
                            <li>クエリビルダーを使った動的なSQL構築</li>
                        </ul>
                    </div>

                    <!-- セクション2.1 -->
                    <h3 class="section-title">2.1 SQLAlchemy Coreの概要</h3>
                    <p>SQLAlchemy Coreは、PythonのオブジェクトとSQLの中間的な表現を提供する低レベルAPIです。SQLに近い制御を保ちながら、Pythonの表現力を活用できます。</p>

                    <p>主要なコンポーネント：</p>
                    <ul>
                        <li><strong>Engine</strong>: データベース接続プールとダイアレクト管理</li>
                        <li><strong>MetaData</strong>: テーブル定義の中央管理</li>
                        <li><strong>Table</strong>: データベーステーブルの定義</li>
                        <li><strong>Column</strong>: テーブルの列定義</li>
                        <li><strong>Connection</strong>: 実際のデータベース接続</li>
                    </ul>

                    <!-- セクション2.2 -->
                    <h3 class="section-title">2.2 MetaDataとTableの定義</h3>
                    <p>MetaDataオブジェクトはデータベーススキーマの情報を一元管理し、Tableオブジェクトはデータベーステーブルを表現します。</p>

                    <h4>基本的なテーブル定義</h4>
                    <pre class="code-block"><code class="language-python">from sqlalchemy import MetaData, Table, Column, Integer, String, DateTime, Boolean, ForeignKey
from datetime import datetime

# MetaDataオブジェクトの作成
metadata = MetaData()

# usersテーブルの定義
users = Table(
    'users',
    metadata,
    Column('id', Integer, primary_key=True, autoincrement=True),
    Column('username', String(50), nullable=False, unique=True),
    Column('email', String(120), nullable=False, unique=True),
    Column('full_name', String(100)),
    Column('is_active', Boolean, default=True),
    Column('created_at', DateTime, default=datetime.utcnow),
    Column('updated_at', DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
)

# postsテーブルの定義（外部キー付き）
posts = Table(
    'posts',
    metadata,
    Column('id', Integer, primary_key=True, autoincrement=True),
    Column('title', String(200), nullable=False),
    Column('content', String(5000)),
    Column('author_id', Integer, ForeignKey('users.id'), nullable=False),
    Column('published', Boolean, default=False),
    Column('created_at', DateTime, default=datetime.utcnow)
)</code></pre>

                    <!-- 実習2-1 -->
                    <div class="exercise-container">
                        <h5>実習 2-1: テーブル定義とスキーマ作成</h5>
                        <p>SQLAlchemy Coreを使ってテーブルを定義し、データベースに作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>MetaDataとTableオブジェクトを定義する</li>
                            <li>複数のテーブルを作成する</li>
                            <li>外部キー制約を設定する</li>
                            <li>スキーマを確認する</li>
                        </ol>

                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python"># table_definition.py
from sqlalchemy import (
    create_engine, MetaData, Table, Column, 
    Integer, String, DateTime, Boolean, ForeignKey, text
)
from datetime import datetime

# データベース接続
engine = create_engine('sqlite:///core_example.db', echo=True)
metadata = MetaData()

# categoriesテーブル
categories = Table(
    'categories',
    metadata,
    Column('id', Integer, primary_key=True),
    Column('name', String(50), nullable=False, unique=True),
    Column('description', String(200)),
    Column('created_at', DateTime, default=datetime.utcnow)
)

# productsテーブル
products = Table(
    'products',
    metadata,
    Column('id', Integer, primary_key=True),
    Column('name', String(100), nullable=False),
    Column('price', Integer, nullable=False),  # 価格は整数（円）
    Column('category_id', Integer, ForeignKey('categories.id')),
    Column('stock_quantity', Integer, default=0),
    Column('is_available', Boolean, default=True),
    Column('created_at', DateTime, default=datetime.utcnow),
    Column('updated_at', DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
)

# テーブル作成
print("Creating tables...")
metadata.create_all(engine)

# スキーマ確認
with engine.connect() as conn:
    # SQLiteの場合のテーブル一覧取得
    result = conn.execute(text("""
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name NOT LIKE 'sqlite_%'
    """))
    
    print("\n--- Created Tables ---")
    for row in result:
        print(f"Table: {row[0]}")
    
    # テーブル構造の確認
    for table_name in ['categories', 'products']:
        print(f"\n--- {table_name} table structure ---")
        result = conn.execute(text(f"PRAGMA table_info({table_name})"))
        for row in result:
            print(f"Column: {row[1]}, Type: {row[2]}, NotNull: {row[3]}, Default: {row[4]}, PK: {row[5]}") 
</code></pre>

                        <h6>期待される結果</h6>
                        <p>実行すると以下のような出力が表示され、テーブルが作成されます：</p>
                        <pre class="code-block"><code class="language-bash">Creating tables...
CREATE TABLE categories (...)
CREATE TABLE products (...)

--- Created Tables ---
Table: categories
Table: products

--- categories table structure ---
Column: id, Type: INTEGER, NotNull: 0, Default: None, PK: 1
Column: name, Type: VARCHAR(50), NotNull: 1, Default: None, PK: 0
...</code></pre>
                    </div>

                    <!-- セクション2.3 -->
                    <h3 class="section-title">2.3 データ型とカラム制約</h3>
                    <p>SQLAlchemyは豊富なデータ型と制約オプションを提供しています。</p>

                    <h4>主要なデータ型</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>数値型</h5>
                            <pre class="code-block"><code class="language-python">from sqlalchemy import Integer, Float, Numeric

Column('age', Integer)
Column('price', Float)
Column('decimal_price', Numeric(10, 2))  # 精度10、小数点以下2桁</code></pre>
                        </div>
                        <div class="col-md-6">
                            <h5>文字列型</h5>
                            <pre class="code-block"><code class="language-python">from sqlalchemy import String, Text

Column('name', String(50))       # 固定長
Column('description', Text)      # 可変長</code></pre>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h5>日時型</h5>
                            <pre class="code-block"><code class="language-python">from sqlalchemy import DateTime, Date, Time

Column('created_at', DateTime)
Column('birth_date', Date)
Column('start_time', Time)</code></pre>
                        </div>
                        <div class="col-md-6">
                            <h5>その他</h5>
                            <pre class="code-block"><code class="language-python">from sqlalchemy import Boolean, JSON

Column('is_active', Boolean)
Column('settings', JSON)        # JSON型（対応DBのみ）</code></pre>
                        </div>
                    </div>

                    <!-- セクション2.4 -->
                    <h3 class="section-title">2.4 基本的なCRUD操作</h3>
                    <p>SQLAlchemy Coreを使った基本的なデータベース操作を学習します。</p>

                    <!-- 実習2-2 -->
                    <div class="exercise-container">
                        <h5>実習 2-2: CRUD操作の実装</h5>
                        <p>Create（作成）、Read（読み取り）、Update（更新）、Delete（削除）の基本操作を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>データの挿入（INSERT）</li>
                            <li>データの取得（SELECT）</li>
                            <li>データの更新（UPDATE）</li>
                            <li>データの削除（DELETE）</li>
                        </ol>

                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-python"># crud_operations.py
from sqlalchemy import create_engine, MetaData, Table, Column, Integer, String, select, insert, update, delete
from datetime import datetime

# 既存のテーブル定義を再利用
engine = create_engine('sqlite:///core_example.db', echo=True)
metadata = MetaData()

# テーブル定義（既存テーブルを反映）
categories = Table(
    'categories',
    metadata,
    Column('id', Integer, primary_key=True),
    Column('name', String(50), nullable=False, unique=True),
    Column('description', String(200)),
    autoload_with=engine  # 既存テーブル構造を自動読み込み
)

products = Table(
    'products',
    metadata,
    autoload_with=engine
)

with engine.connect() as conn:
    # 1. CREATE - データの挿入
    print("=== CREATE操作 ===")
    
    # カテゴリの挿入
    stmt = insert(categories).values([
        {'name': 'Electronics', 'description': '電子製品'},
        {'name': 'Books', 'description': '書籍'},
        {'name': 'Clothing', 'description': '衣類'}
    ])
    result = conn.execute(stmt)
    conn.commit()
    print(f"Inserted {result.rowcount} categories")
    
    # 製品の挿入
    stmt = insert(products).values([
        {
            'name': 'Laptop',
            'price': 89800,
            'category_id': 1,
            'stock_quantity': 10
        },
        {
            'name': 'Python Book',
            'price': 3200,
            'category_id': 2,
            'stock_quantity': 50
        }
    ])
    result = conn.execute(stmt)
    conn.commit()
    print(f"Inserted {result.rowcount} products")
    
    # 2. READ - データの取得
    print("\n=== READ操作 ===")
    
    # 全カテゴリ取得
    stmt = select(categories)
    result = conn.execute(stmt)
    print("All categories:")
    for row in result:
        print(f"  ID: {row.id}, Name: {row.name}, Description: {row.description}")
    
    # 条件付き取得
    stmt = select(products).where(products.c.price < 50000)
    result = conn.execute(stmt)
    print("\nProducts under 50,000 yen:")
    for row in result:
        print(f"  {row.name}: {row.price}円 (Stock: {row.stock_quantity})")
    
    # JOINを使った取得
    stmt = select(
        products.c.name.label('product_name'),
        products.c.price,
        categories.c.name.label('category_name')
    ).select_from(
        products.join(categories, products.c.category_id == categories.c.id)
    )
    result = conn.execute(stmt)
    print("\nProducts with categories:")
    for row in result:
        print(f"  {row.product_name} ({row.category_name}): {row.price}円")
    
    # 3. UPDATE - データの更新
    print("\n=== UPDATE操作 ===")
    
    # 在庫数を更新
    stmt = update(products).where(
        products.c.name == 'Laptop'
    ).values(stock_quantity=8)
    result = conn.execute(stmt)
    conn.commit()
    print(f"Updated {result.rowcount} product(s)")
    
    # 更新結果の確認
    stmt = select(products).where(products.c.name == 'Laptop')
    result = conn.execute(stmt)
    row = result.fetchone()
    print(f"Laptop stock after update: {row.stock_quantity}")
    
    # 4. DELETE - データの削除
    print("\n=== DELETE操作 ===")
    
    # 在庫0の商品を削除（まず在庫0の商品を作成）
    stmt = insert(products).values(
        name='Out of Stock Item',
        price=1000,
        category_id=1,
        stock_quantity=0,
        is_available=False
    )
    conn.execute(stmt)
    conn.commit()
    
    # 在庫0かつ販売停止の商品を削除
    stmt = delete(products).where(
        (products.c.stock_quantity == 0) & (products.c.is_available == False)
    )
    result = conn.execute(stmt)
    conn.commit()
    print(f"Deleted {result.rowcount} out-of-stock product(s)")
    
    # 最終的な商品一覧
    print("\n=== 最終的な商品一覧 ===")
    stmt = select(products)
    result = conn.execute(stmt)
    for row in result:
        print(f"  {row.name}: {row.price}円 (在庫: {row.stock_quantity})")
</code></pre>

                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash">=== CREATE操作 ===
Inserted 3 categories
Inserted 2 products

=== READ操作 ===
All categories:
  ID: 1, Name: Electronics, Description: 電子製品
  ID: 2, Name: Books, Description: 書籍
  ID: 3, Name: Clothing, Description: 衣類

Products under 50,000 yen:
  Python Book: 3200円 (Stock: 50)

Products with categories:
  Laptop (Electronics): 89800円
  Python Book (Books): 3200円

=== UPDATE操作 ===
Updated 1 product(s)
Laptop stock after update: 8

=== DELETE操作 ===
Deleted 1 out-of-stock product(s)

=== 最終的な商品一覧 ===
  Laptop: 89800円 (在庫: 8)
  Python Book: 3200円 (在庫: 50)</code></pre>
                    </div>

                    <!-- セクション2.5 -->
                    <h3 class="section-title">2.5 クエリビルダーと動的SQL</h3>
                    <p>SQLAlchemy Coreの強力な機能の一つは、動的にSQLクエリを構築できることです。</p>

                    <h4>条件分岐を含むクエリ</h4>
                    <pre class="code-block"><code class="language-python">def search_products(name_filter=None, min_price=None, max_price=None, category_id=None):
    """動的な商品検索クエリ"""
    stmt = select(products)
    
    # 条件を段階的に追加
    if name_filter:
        stmt = stmt.where(products.c.name.ilike(f'%{name_filter}%'))
    
    if min_price is not None:
        stmt = stmt.where(products.c.price >= min_price)
    
    if max_price is not None:
        stmt = stmt.where(products.c.price <= max_price)
    
    if category_id:
        stmt = stmt.where(products.c.category_id == category_id)
    
    # 並び順の指定
    stmt = stmt.order_by(products.c.price.desc())
    
    return stmt

# 使用例
with engine.connect() as conn:
    # 価格帯で検索
    query = search_products(min_price=1000, max_price=10000)
    result = conn.execute(query)
    print("Products in price range 1000-10000:")
    for row in result:
        print(f"  {row.name}: {row.price}円")
</code></pre>

                    <div class="warning">
                        <h5>SQLAlchemy 2.0での重要な変更点</h5>
                        <ul>
                            <li><strong>新しいクエリ構文</strong>: select()関数を使用する新しい記法が標準になりました</li>
                            <li><strong>自動コミット廃止</strong>: 明示的にcommit()を呼ぶ必要があります</li>
                            <li><strong>Result.fetchone()の変更</strong>: 結果がない場合はNoneを返します</li>
                            <li><strong>テキストSQL</strong>: 生のSQLを使用する際はtext()でラップが必須です</li>
                        </ul>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>MetaDataオブジェクトの役割と、複数のテーブル定義を管理する利点を説明してください。</li>
                            <li>以下のテーブル定義で不適切な部分を指摘し、修正してください：
                                <pre class="code-block"><code class="language-python">users = Table(
    'users',
    metadata,
    Column('id', Integer),
    Column('email', String),
    Column('password', String(50))
)</code></pre>
                            </li>
                            <li>以下のクエリの問題点を説明し、SQLAlchemy 2.0記法で修正してください：
                                <pre class="code-block"><code class="language-python">result = conn.execute("SELECT * FROM products WHERE price > " + str(min_price))</code></pre>
                            </li>
                            <li>動的なクエリ構築において、条件の組み合わせを効率的に処理する方法を実装してください。</li>
                            <li>外部キー制約の定義方法と、参照整合性が保たれる利点を説明してください。</li>
                        </ol>
                        
                        <div class="mt-3">
                            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#answers2">
                                解答を表示
                            </button>
                        </div>
                        
                        <div class="collapse mt-3" id="answers2">
                            <div class="card card-body">
                                <h6>解答例</h6>
                                <p><strong>1.</strong> MetaDataはテーブル定義の中央管理を行い、スキーマの一貫性保持、DDL生成の自動化、テーブル間の依存関係管理を提供します。</p>
                                <p><strong>2.</strong> 修正点：</p>
                                <pre class="code-block"><code class="language-python">users = Table(
    'users',
    metadata,
    Column('id', Integer, primary_key=True),      # 主キー指定
    Column('email', String(255), unique=True),    # 長さ指定、ユニーク制約
    Column('password', String(255))               # 十分な長さ（ハッシュ化を考慮）
)</code></pre>
                                <p><strong>3.</strong> SQLインジェクション脆弱性、修正版：</p>
                                <pre class="code-block"><code class="language-python">from sqlalchemy import select, text
stmt = select(products).where(products.c.price > min_price)
result = conn.execute(stmt)</code></pre>
                                <p><strong>4.</strong> クエリビルダーパターンで条件を段階的に追加し、Noneチェックで不要な条件を除外。</p>
                                <p><strong>5.</strong> ForeignKey('table.column')で定義。データ整合性保証、カスケード操作、JOINクエリの最適化が利点。</p>
                            </div>
                        </div>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="python-sqlalchemy-learning-material-01.html" class="btn btn-secondary">← 前の章</a>
                        <a href="python-sqlalchemy-learning-material-03.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>