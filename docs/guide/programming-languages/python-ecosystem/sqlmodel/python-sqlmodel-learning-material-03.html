<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python SQLModel学習教材 第3章 - 基本的なCRUD操作</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #306998;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #306998;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #306998;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #4b8bbe;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #306998;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #306998 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Python SQLModel 学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.html">概要</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://sqlmodel.tiangolo.com/" target="_blank">公式ドキュメント</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-01.html">
                                第1章: SQLModel入門と環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-02.html">
                                第2章: モデル定義と型安全性
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="python-sqlmodel-learning-material-03.html">
                                第3章: 基本的なCRUD操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-04.html">
                                第4章: リレーションシップと結合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-05.html">
                                第5章: FastAPIとの統合開発
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-06.html">
                                第6章: 高度なクエリとパフォーマンス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-07.html">
                                第7章: データベースマイグレーション
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="python-sqlmodel-learning-material-08.html">
                                第8章: 実践的なWeb API開発
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第3章: 基本的なCRUD操作</h1>
                </div>

                <div id="chapter3">
                    <h2 class="chapter-title">セッション管理とCRUD操作</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>SQLModelにおけるセッション管理の重要性</li>
                            <li>Create（作成）操作の実装方法</li>
                            <li>Read（読み取り）操作とクエリの構築</li>
                            <li>Update（更新）操作の効率的な実装</li>
                            <li>Delete（削除）操作と関連データの処理</li>
                            <li>フィルタリング、ソート、ページネーションの実装</li>
                        </ul>
                    </div>

                    <h3 class="section-title">3.1 セッション管理の基礎</h3>
                    <p>SQLModelでは、データベース操作を<strong>Session</strong>オブジェクトを通じて実行します。セッションは以下の重要な役割を担います：</p>
                    
                    <ul>
                        <li><strong>トランザクション管理</strong>: 複数の操作をまとめて実行・ロールバック</li>
                        <li><strong>Identity Map</strong>: 同じレコードのインスタンスを一意に管理</li>
                        <li><strong>Unit of Work</strong>: 変更をまとめて効率的にデータベースに反映</li>
                    </ul>

                    <div class="exercise-container">
                        <h5>実習 3-1: セッション管理パターンの実装</h5>
                        <p>安全で効率的なセッション管理パターンを学習し、実装します。</p>
                        
                        <h6>実行例 (session_manager.py)</h6>
                        <pre class="code-block"><code class="language-python">from contextlib import contextmanager
from sqlmodel import create_engine, Session
from typing import Generator

# データベース設定
DATABASE_URL = "sqlite:///./app.db"
engine = create_engine(DATABASE_URL, echo=True)

# セッション管理のヘルパー関数
@contextmanager
def get_session() -> Generator[Session, None, None]:
    """安全なセッション管理のコンテキストマネージャー"""
    session = Session(engine)
    try:
        yield session
        session.commit()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()

# 基本的な使用方法
def example_session_usage():
    with get_session() as session:
        # ここでデータベース操作を実行
        # 正常終了時は自動的にcommit
        # エラー時は自動的にrollback
        pass</code></pre>
                    </div>

                    <h3 class="section-title">3.2 Create（作成）操作</h3>
                    <p>新しいレコードをデータベースに追加する操作を学習します。単一レコードと複数レコードの効率的な作成方法を習得しましょう。</p>

                    <div class="exercise-container">
                        <h5>実習 3-2: データ作成操作の実装</h5>
                        <p>ユーザーデータの作成を通じて、さまざまな作成パターンを学習します。</p>
                        
                        <h6>実行例 (crud_create.py)</h6>
                        <pre class="code-block"><code class="language-python">from datetime import datetime
from typing import List
from sqlmodel import SQLModel, Field, select

class User(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(max_length=50, unique=True)
    email: str = Field(max_length=255, unique=True)
    full_name: Optional[str] = Field(default=None, max_length=200)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    is_active: bool = Field(default=True)

def create_single_user(username: str, email: str, full_name: str = None) -> User:
    """単一ユーザーの作成"""
    with get_session() as session:
        user = User(
            username=username,
            email=email,
            full_name=full_name
        )
        session.add(user)
        session.flush()  # IDを取得するためにflush
        session.refresh(user)  # 最新の状態を取得
        return user

def create_multiple_users(users_data: List[dict]) -> List[User]:
    """複数ユーザーの一括作成"""
    with get_session() as session:
        users = []
        for user_data in users_data:
            user = User(**user_data)
            users.append(user)
            session.add(user)
        
        session.flush()  # 一括でIDを取得
        
        # 作成されたユーザーのリストを返す
        for user in users:
            session.refresh(user)
        
        return users

def create_user_safely(username: str, email: str) -> Optional[User]:
    """重複チェック付きの安全なユーザー作成"""
    with get_session() as session:
        # 既存ユーザーをチェック
        existing_user = session.exec(
            select(User).where(
                (User.username == username) | 
                (User.email == email)
            )
        ).first()
        
        if existing_user:
            print(f"ユーザーは既に存在します: {existing_user.username}")
            return None
        
        # 新規ユーザー作成
        user = User(username=username, email=email)
        session.add(user)
        session.flush()
        session.refresh(user)
        return user

# 使用例
if __name__ == "__main__":
    # 単一ユーザー作成
    user1 = create_single_user(
        username="john_doe",
        email="john@example.com",
        full_name="John Doe"
    )
    print(f"作成されたユーザー: {user1.username} (ID: {user1.id})")
    
    # 複数ユーザー作成
    users_data = [
        {"username": "alice", "email": "alice@example.com", "full_name": "Alice Smith"},
        {"username": "bob", "email": "bob@example.com", "full_name": "Bob Johnson"},
        {"username": "charlie", "email": "charlie@example.com", "full_name": "Charlie Brown"}
    ]
    
    created_users = create_multiple_users(users_data)
    print(f"作成されたユーザー数: {len(created_users)}")
    
    # 重複チェック付き作成
    duplicate_user = create_user_safely("john_doe", "john2@example.com")
    print(f"重複チェック結果: {duplicate_user}")</code></pre>
                    </div>

                    <h3 class="section-title">3.3 Read（読み取り）操作</h3>
                    <p>データベースからデータを取得する様々な方法を学習します。効率的なクエリの構築とフィルタリング技術を習得しましょう。</p>

                    <div class="exercise-container">
                        <h5>実習 3-3: データ読み取り操作の実装</h5>
                        <p>様々な条件でのデータ取得方法を実装します。</p>
                        
                        <h6>実行例 (crud_read.py)</h6>
                        <pre class="code-block"><code class="language-python">from typing import List, Optional
from sqlmodel import select, or_, and_, func

def get_user_by_id(user_id: int) -> Optional[User]:
    """IDによるユーザー取得"""
    with get_session() as session:
        user = session.get(User, user_id)
        return user

def get_user_by_username(username: str) -> Optional[User]:
    """ユーザー名による取得"""
    with get_session() as session:
        statement = select(User).where(User.username == username)
        user = session.exec(statement).first()
        return user

def get_all_users() -> List[User]:
    """全ユーザーの取得"""
    with get_session() as session:
        statement = select(User)
        users = session.exec(statement).all()
        return users

def get_active_users() -> List[User]:
    """アクティブなユーザーのみを取得"""
    with get_session() as session:
        statement = select(User).where(User.is_active == True)
        users = session.exec(statement).all()
        return users

def search_users(search_term: str) -> List[User]:
    """ユーザー名または氏名での検索"""
    with get_session() as session:
        statement = select(User).where(
            or_(
                User.username.contains(search_term),
                User.full_name.contains(search_term)
            )
        )
        users = session.exec(statement).all()
        return users

def get_users_with_pagination(page: int = 1, per_page: int = 10) -> tuple[List[User], int]:
    """ページネーション付きユーザー取得"""
    with get_session() as session:
        # 総件数を取得
        count_statement = select(func.count(User.id))
        total_count = session.exec(count_statement).one()
        
        # ページネーション付きでデータを取得
        offset = (page - 1) * per_page
        statement = select(User).offset(offset).limit(per_page)
        users = session.exec(statement).all()
        
        return users, total_count

def get_users_sorted(sort_by: str = "created_at", ascending: bool = True) -> List[User]:
    """ソート付きユーザー取得"""
    with get_session() as session:
        # ソートフィールドを動的に選択
        sort_field = getattr(User, sort_by, User.created_at)
        
        if ascending:
            statement = select(User).order_by(sort_field)
        else:
            statement = select(User).order_by(sort_field.desc())
        
        users = session.exec(statement).all()
        return users

# 使用例
if __name__ == "__main__":
    # ID指定取得
    user = get_user_by_id(1)
    if user:
        print(f"ユーザー取得: {user.username}")
    
    # 検索
    search_results = search_users("john")
    print(f"検索結果: {len(search_results)}件")
    
    # ページネーション
    users, total = get_users_with_pagination(page=1, per_page=5)
    print(f"ページ1: {len(users)}件 / 総件数: {total}件")
    
    # ソート
    sorted_users = get_users_sorted("username", ascending=True)
    print("ユーザー名でソート:")
    for user in sorted_users[:3]:
        print(f"  {user.username}")</code></pre>
                    </div>

                    <h3 class="section-title">3.4 Update（更新）操作</h3>
                    <p>既存データの更新を効率的に行う方法を学習します。部分更新と一括更新のテクニックを習得しましょう。</p>

                    <div class="exercise-container">
                        <h5>実習 3-4: データ更新操作の実装</h5>
                        <p>様々なパターンでのデータ更新方法を実装します。</p>
                        
                        <h6>実行例 (crud_update.py)</h6>
                        <pre class="code-block"><code class="language-python">from datetime import datetime
from typing import Dict, Any

def update_user(user_id: int, **kwargs) -> Optional[User]:
    """ユーザー情報の部分更新"""
    with get_session() as session:
        user = session.get(User, user_id)
        if not user:
            return None
        
        # 更新可能なフィールドのみを更新
        updatable_fields = {"username", "email", "full_name", "is_active"}
        
        for field, value in kwargs.items():
            if field in updatable_fields and hasattr(user, field):
                setattr(user, field, value)
        
        # 更新日時を記録（フィールドがある場合）
        if hasattr(user, 'updated_at'):
            user.updated_at = datetime.utcnow()
        
        session.add(user)
        session.flush()
        session.refresh(user)
        return user

def update_user_email(user_id: int, new_email: str) -> bool:
    """メールアドレスの更新（重複チェック付き）"""
    with get_session() as session:
        # 既存のメールアドレスをチェック
        existing_user = session.exec(
            select(User).where(
                and_(User.email == new_email, User.id != user_id)
            )
        ).first()
        
        if existing_user:
            print(f"メールアドレスは既に使用されています: {new_email}")
            return False
        
        # 対象ユーザーを取得して更新
        user = session.get(User, user_id)
        if not user:
            print(f"ユーザーが見つかりません: ID {user_id}")
            return False
        
        user.email = new_email
        session.add(user)
        return True

def bulk_update_users(user_ids: List[int], **kwargs) -> int:
    """複数ユーザーの一括更新"""
    with get_session() as session:
        updated_count = 0
        
        for user_id in user_ids:
            user = session.get(User, user_id)
            if user:
                for field, value in kwargs.items():
                    if hasattr(user, field):
                        setattr(user, field, value)
                session.add(user)
                updated_count += 1
        
        return updated_count

def activate_user(user_id: int) -> bool:
    """ユーザーのアクティブ化"""
    with get_session() as session:
        user = session.get(User, user_id)
        if not user:
            return False
        
        user.is_active = True
        session.add(user)
        return True

def deactivate_user(user_id: int) -> bool:
    """ユーザーの非アクティブ化"""
    with get_session() as session:
        user = session.get(User, user_id)
        if not user:
            return False
        
        user.is_active = False
        session.add(user)
        return True

# 使用例
if __name__ == "__main__":
    # 部分更新
    updated_user = update_user(1, full_name="John Smith Updated", is_active=True)
    if updated_user:
        print(f"ユーザー更新: {updated_user.full_name}")
    
    # メールアドレス更新
    email_updated = update_user_email(1, "john.smith@example.com")
    print(f"メール更新結果: {email_updated}")
    
    # 一括更新
    user_ids = [1, 2, 3]
    updated_count = bulk_update_users(user_ids, is_active=True)
    print(f"一括更新されたユーザー数: {updated_count}")
    
    # アクティブ化
    activated = activate_user(1)
    print(f"アクティブ化結果: {activated}")</code></pre>
                    </div>

                    <h3 class="section-title">3.5 Delete（削除）操作</h3>
                    <p>データの削除を安全に実行する方法を学習します。物理削除と論理削除のパターンを理解しましょう。</p>

                    <div class="exercise-container">
                        <h5>実習 3-5: データ削除操作の実装</h5>
                        <p>安全なデータ削除パターンを実装します。</p>
                        
                        <h6>実行例 (crud_delete.py)</h6>
                        <pre class="code-block"><code class="language-python">def delete_user(user_id: int) -> bool:
    """ユーザーの物理削除"""
    with get_session() as session:
        user = session.get(User, user_id)
        if not user:
            return False
        
        session.delete(user)
        return True

def soft_delete_user(user_id: int) -> bool:
    """ユーザーの論理削除（非アクティブ化）"""
    with get_session() as session:
        user = session.get(User, user_id)
        if not user:
            return False
        
        user.is_active = False
        # deleted_atフィールドがある場合
        if hasattr(user, 'deleted_at'):
            user.deleted_at = datetime.utcnow()
        
        session.add(user)
        return True

def delete_inactive_users() -> int:
    """非アクティブユーザーの一括削除"""
    with get_session() as session:
        statement = select(User).where(User.is_active == False)
        inactive_users = session.exec(statement).all()
        
        deleted_count = 0
        for user in inactive_users:
            session.delete(user)
            deleted_count += 1
        
        return deleted_count

def delete_users_by_condition(condition) -> int:
    """条件に基づくユーザー削除"""
    with get_session() as session:
        statement = select(User).where(condition)
        users_to_delete = session.exec(statement).all()
        
        deleted_count = 0
        for user in users_to_delete:
            session.delete(user)
            deleted_count += 1
        
        return deleted_count

# 使用例
if __name__ == "__main__":
    # 単一ユーザー削除
    deleted = delete_user(999)  # 存在しないID
    print(f"削除結果: {deleted}")
    
    # 論理削除
    soft_deleted = soft_delete_user(1)
    print(f"論理削除結果: {soft_deleted}")
    
    # 一括削除
    deleted_count = delete_inactive_users()
    print(f"削除されたユーザー数: {deleted_count}")</code></pre>
                    </div>

                    <div class="warning">
                        <h6>削除操作の注意事項</h6>
                        <ul>
                            <li><strong>外部キー制約</strong>: 関連データがある場合の削除は慎重に</li>
                            <li><strong>論理削除の推奨</strong>: 本番環境では物理削除より論理削除を推奨</li>
                            <li><strong>バックアップ</strong>: 削除前には必ずバックアップを取得</li>
                            <li><strong>トランザクション</strong>: 複数レコードの削除は一つのトランザクション内で</li>
                        </ul>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>セッションのcommit()とflush()の違いは何ですか？</li>
                            <li>session.refresh(user)の目的は何ですか？</li>
                            <li>物理削除と論理削除の違いとそれぞれのメリットは？</li>
                            <li>ページネーションでoffsetとlimitを使う理由は？</li>
                            <li>一括更新でセッションを使用する際の注意点は？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答例</summary>
                            <ol>
                                <li>flush()は変更をDBに送信するがトランザクションはコミットしない、commit()はトランザクションを確定する</li>
                                <li>データベースから最新の状態（自動生成されたIDなど）を取得するため</li>
                                <li>物理削除：実際にレコードを削除、論理削除：フラグで削除状態を管理。論理削除は復元可能で監査に有利</li>
                                <li>大量データを効率的にページ分割して表示するため</li>
                                <li>メモリ使用量の管理、トランザクションサイズの制限、エラー処理の重要性</li>
                            </ol>
                        </details>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="python-sqlmodel-learning-material-02.html" class="btn btn-secondary">← 前の章：モデル定義と型安全性</a>
                        <a href="python-sqlmodel-learning-material-04.html" class="btn btn-primary">次の章：リレーションシップと結合 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>