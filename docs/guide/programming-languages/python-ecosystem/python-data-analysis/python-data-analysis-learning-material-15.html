<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" id="viewport-meta">
    <title>Pythonデータ分析入門 第15章 - 総合演習 - 売上データ分析プロジェクト</title>

    <!-- ダークモード早期適用（フラッシュ防止） -->
    <script>
        (function() {
            const saved = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === 'dark' || (saved === null && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Python - Blue
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts - Noto Sans JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="styles.css">
</head>
<body class="font-sans bg-slate-50 text-slate-800 antialiased">
    <!-- ヘッダー/ナビゲーションバー -->
    <header class="fixed top-0 left-0 right-0 z-50 text-white header-rich header-rich-shadow">
        <nav class="w-full px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="flex items-center justify-between py-3">
                <!-- 左側: ロゴとタイトルセクション -->
                <div class="flex items-center gap-4">
                    <!-- アイコン -->
                    <div class="relative group">
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-400/30 to-orange-400/30 rounded-2xl blur-lg group-hover:blur-xl transition-all"></div>
                        <div class="relative w-14 h-14 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                            <i class="fab fa-python text-3xl icon-rotate-hover drop-shadow-lg"></i>
                        </div>
                    </div>

                    <!-- タイトルとメタ情報 -->
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-bold tracking-wide drop-shadow-md">Pythonデータ分析入門</span>
                            <span class="hidden sm:inline-flex items-center gap-1 px-2 py-0.5 bg-white/20 rounded-md text-[10px] font-semibold uppercase tracking-wider">
                                <i class="fas fa-star text-yellow-300 text-[8px]"></i>
                                初級
                            </span>
                        </div>
                        <div class="flex items-center gap-3 text-[11px] text-white/90 font-medium">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-chart-bar text-[9px]"></i>
                                <span>データ分析</span>
                            </div>
                            <div class="hidden sm:flex items-center gap-1">
                                <i class="fas fa-clock text-[9px]"></i>
                                <span>所要時間 約23時間</span>
                            </div>
                            <div class="hidden lg:flex items-center gap-1">
                                <i class="fas fa-language text-[9px]"></i>
                                <span>日本語</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側: サイドバートグルボタン -->
                <button id="sidebar-toggle-btn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white/20 transition-all active:scale-95" title="サイドバーの表示/非表示">
                    <i class="fas fa-bars text-lg"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- メインレイアウト -->
    <div class="flex min-h-screen pt-20">
        <!-- サイドバーはsidebar-content.jsで動的に生成されます -->

        <!-- メインコンテンツ -->
        <main class="flex-1 min-w-0">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-10 py-6">
                <!-- パンくずリスト -->
                <nav class="flex items-center gap-2 text-sm text-slate-500 mb-6">
                    <a href="https://fcircle-biz.github.io/tech_docs/" class="hover:text-primary-600 transition-colors">ホーム</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <a href="https://fcircle-biz.github.io/tech_docs/guide/programming-languages/python-ecosystem/python-data-analysis/" class="hover:text-primary-600 transition-colors">Pythonデータ分析入門</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-slate-700">第15章</span>
                </nav>

                <!-- 章ヘッダー -->
                <header class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-700">
                            第15章
                        </span>
                        <span class="text-sm text-slate-500">
                            <i class="fas fa-clock mr-1"></i>所要時間: 約2.5時間
                        </span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">
                        総合演習 - 売上データ分析プロジェクト
                    </h1>
                    <p class="text-slate-600">
                        これまでの学習で身につけたNumPy・pandas・matplotlibの知識を総動員し、架空の売上データを使った一連のデータ分析プロジェクトを実践します。「データ読み込み → 前処理 → 集計 → 可視化 → レポート作成」という実務に近い分析フローを体験しましょう。
                    </p>
                </header>

                <!-- 学習目標カード -->
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 rounded-xl p-5 mb-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-amber-400 rounded-lg flex items-center justify-center">
                            <i class="fas fa-lightbulb text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-amber-800 mb-3">この章で学ぶこと</h2>
                            <ul class="space-y-2">
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>データ分析プロジェクトの進め方と分析計画の立て方</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>実際のデータに対するデータクリーニングの実践</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>月別・カテゴリ別の売上分析と集計手法</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>トレンド分析と季節性の可視化・把握</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>分析結果をまとめたレポート（グラフ）の作成</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- セクション 15.1 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        15.1 プロジェクト概要と分析の進め方
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        この章では、架空のEコマース企業「FCマート」の1年分の売上データを分析します。経営陣から「売上の傾向を把握して、来期の戦略に活かしたい」というテーマが与えられた想定で進めます。
                    </p>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        実務のデータ分析は「思いつきでコードを書く」のではなく、<strong>分析計画（何を明らかにしたいか）</strong>を先に立てることが重要です。今回は以下の4つの問いに答えることをゴールとします。
                    </p>

                    <!-- 分析テーマカード -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-7 h-7 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">Q1</div>
                                <h4 class="font-semibold text-blue-900">月ごとの売上推移は？</h4>
                            </div>
                            <p class="text-blue-800 text-sm">1月〜12月の売上金額の変化を把握し、ピーク月や低迷月を特定する</p>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-7 h-7 bg-emerald-500 rounded-full flex items-center justify-center text-white text-sm font-bold">Q2</div>
                                <h4 class="font-semibold text-emerald-900">カテゴリ別の売上構成は？</h4>
                            </div>
                            <p class="text-emerald-800 text-sm">商品カテゴリごとの売上比率を把握し、最も貢献しているカテゴリを特定する</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-7 h-7 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">Q3</div>
                                <h4 class="font-semibold text-purple-900">上位商品はどれか？</h4>
                            </div>
                            <p class="text-purple-800 text-sm">売上上位10商品を特定し、どの商品が最も収益に貢献しているかを把握する</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-7 h-7 bg-orange-500 rounded-full flex items-center justify-center text-white text-sm font-bold">Q4</div>
                                <h4 class="font-semibold text-orange-900">季節性のパターンはあるか？</h4>
                            </div>
                            <p class="text-orange-800 text-sm">四半期ごとの売上を比較し、季節的な傾向や繁忙期を明らかにする</p>
                        </div>
                    </div>

                    <!-- 分析フロー図 -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-sitemap text-primary-500"></i>
                            今回のプロジェクト分析フロー
                        </h3>
                        <div class="mermaid">
flowchart LR
    A["Step 1\nデータ準備"] --> B["Step 2\nデータ確認"]
    B --> C["Step 3\nデータクリーニング"]
    C --> D["Step 4\n集計・分析"]
    D --> E["Step 5\n可視化"]
    E --> F["Step 6\nレポート作成"]

    style A fill:#dbeafe,stroke:#3b82f6,color:#1e40af
    style B fill:#fef3c7,stroke:#f59e0b,color:#92400e
    style C fill:#fee2e2,stroke:#ef4444,color:#7f1d1d
    style D fill:#d1fae5,stroke:#10b981,color:#064e3b
    style E fill:#ede9fe,stroke:#8b5cf6,color:#4c1d95
    style F fill:#fce7f3,stroke:#ec4899,color:#831843
                        </div>
                    </div>
                </section>

                <!-- セクション 15.2 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        15.2 Step 1 - サンプルデータの準備
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        まず、分析に使うサンプルデータを作成します。実務では外部のCSVファイルやデータベースから読み込みますが、ここでは学習用にPythonコードでデータを生成します。
                    </p>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        このデータには<strong>意図的に欠損値や異常値を含めています</strong>。実際の業務データと同様に、前処理が必要な状態から始めます。
                    </p>

                    <!-- コードブロック: データ準備 -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">sales_project.ipynb - セル1: データ準備</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.ticker as ticker

# 日本語フォント設定（環境に応じて調整）
plt.rcParams['font.family'] = 'Noto Sans JP'
plt.rcParams['axes.unicode_minus'] = False

# 再現性のためシードを設定
np.random.seed(42)

# --- サンプル売上データの生成 ---
n_records = 500   # レコード数

# 商品カテゴリと価格帯の定義
categories = {
    '家電': (15000, 80000),    # （最低価格, 最高価格）
    '衣料品': (3000, 25000),
    '食品': (500, 5000),
    '書籍': (1000, 4000),
    'スポーツ': (5000, 40000),
}
cat_names = list(categories.keys())

# 月別売上に季節性を持たせるための係数
seasonal = {1: 0.85, 2: 0.80, 3: 0.90, 4: 0.95,
            5: 1.00, 6: 1.05, 7: 1.10, 8: 1.15,
            9: 1.00, 10: 1.05, 11: 1.20, 12: 1.50}

# ランダムに月・カテゴリ・商品名を割り当て
months   = np.random.randint(1, 13, n_records)
cat_list = np.random.choice(cat_names, n_records)

# カテゴリに応じた単価を生成
unit_prices = []
for cat in cat_list:
    lo, hi = categories[cat]
    unit_prices.append(np.random.randint(lo, hi))

quantities = np.random.randint(1, 6, n_records)  # 購入個数1〜5

# 売上金額 = 単価 × 個数（季節係数はここでは省略）
sales_amounts = np.array(unit_prices) * quantities

# DataFrameを作成
df_raw = pd.DataFrame({
    '取引ID': [f'TXN{str(i).zfill(4)}' for i in range(1, n_records + 1)],
    '月':     months,
    'カテゴリ': cat_list,
    '単価':    unit_prices,
    '個数':    quantities,
    '売上金額': sales_amounts,
})

# --- 意図的に欠損値・異常値を挿入 ---
# 欠損値：20件の「カテゴリ」をNaN
nan_idx = np.random.choice(df_raw.index, 20, replace=False)
df_raw.loc[nan_idx, 'カテゴリ'] = np.nan

# 異常値：個数が100の外れ値を5件挿入
outlier_idx = np.random.choice(df_raw.index, 5, replace=False)
df_raw.loc[outlier_idx, '個数'] = 100

print(f"データ件数: {len(df_raw)}")
print(f"\n先頭5行:")
print(df_raw.head())</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-4">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例</p>
                        <pre class="text-slate-600 text-sm">データ件数: 500

先頭5行:
    取引ID  月  カテゴリ    単価  個数   売上金額
0  TXN0001  7    家電   52340   3  157020
1  TXN0002  3   衣料品   18760   2   37520
2  TXN0003  11    食品    2840   4   11360
3  TXN0004   8   書籍    3120   1    3120
4  TXN0005   1  スポーツ  22540   3   67620</pre>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                            <div>
                                <p class="text-blue-900 font-medium">実務でのデータ取得</p>
                                <p class="text-blue-800 text-sm mt-1">
                                    実際の業務では <code class="bg-blue-100 px-1 rounded font-mono">pd.read_csv('sales_data.csv')</code> のようにCSVファイルから読み込みます。このような手動作成データは、コードのテストや学習に非常に便利です。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 15.3 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        15.3 Step 2 - データの全体確認
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        分析を始める前に、まずデータの<strong>全体像を把握</strong>します。データの件数・型・欠損値・統計量を確認することで、どのような前処理が必要かが見えてきます。
                    </p>

                    <!-- コードブロック: データ確認 -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">sales_project.ipynb - セル2: データ確認</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># --- データの基本情報を確認 ---
print("=== データ型と欠損値の確認 ===")
print(df_raw.info())

print("\n=== 基本統計量 ===")
print(df_raw.describe())

print("\n=== 欠損値の件数 ===")
print(df_raw.isnull().sum())

print("\n=== カテゴリの分布 ===")
print(df_raw['カテゴリ'].value_counts())</code></pre>
                    </div>

                    <!-- データ確認のポイント解説 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white border border-slate-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-search text-primary-500"></i>
                                <h4 class="font-semibold text-slate-800">info() で確認</h4>
                            </div>
                            <ul class="text-slate-600 text-sm space-y-1">
                                <li>・全体の行数・列数</li>
                                <li>・各列のデータ型</li>
                                <li>・非null値の件数（欠損の有無）</li>
                                <li>・メモリ使用量</li>
                            </ul>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-calculator text-emerald-500"></i>
                                <h4 class="font-semibold text-slate-800">describe() で確認</h4>
                            </div>
                            <ul class="text-slate-600 text-sm space-y-1">
                                <li>・平均・標準偏差</li>
                                <li>・最小値・最大値</li>
                                <li>・四分位数（25%/50%/75%）</li>
                                <li>・異常値の有無の手がかり</li>
                            </ul>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-chart-pie text-purple-500"></i>
                                <h4 class="font-semibold text-slate-800">value_counts() で確認</h4>
                            </div>
                            <ul class="text-slate-600 text-sm space-y-1">
                                <li>・カテゴリの種類と件数</li>
                                <li>・偏りや想定外の値の発見</li>
                                <li>・NaNの件数確認も可能</li>
                                <li>・表記ゆれの検出に有効</li>
                            </ul>
                        </div>
                    </div>

                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-circle text-orange-600 mt-1"></i>
                            <div>
                                <p class="text-orange-900 font-medium">統計量で異常値を発見する</p>
                                <p class="text-orange-800 text-sm mt-1">
                                    <code class="bg-orange-100 px-1 rounded font-mono">describe()</code> の「個数」列の最大値（max）が 100 になっているはずです。他の値の最大値は5なので、これが意図的に挿入した外れ値です。平均値と最大値の乖離が大きい場合は異常値の可能性があります。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 15.4 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        15.4 Step 3 - データクリーニング
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        確認で判明した問題を修正します。今回は「欠損値（カテゴリがNaN）」と「異常値（個数が100）」の2種類の問題に対処します。クリーニング前後の件数を必ず確認しましょう。
                    </p>

                    <!-- コードブロック: クリーニング -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">sales_project.ipynb - セル3: データクリーニング</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># クリーニング前の件数を記録
before = len(df_raw)
print(f"クリーニング前: {before} 件")

# --- 欠損値の処理：カテゴリがNaNの行を除外 ---
# カテゴリ不明のデータはどのカテゴリにも分類できないため除外
df_clean = df_raw.dropna(subset=['カテゴリ']).copy()
print(f"欠損値除去後: {len(df_clean)} 件（{before - len(df_clean)} 件除外）")

# --- 異常値の処理：個数が10以上の行を除外 ---
# 1回の購入で100個は現実的ではないため除外（閾値: 10個以上）
df_clean = df_clean[df_clean['個数'] <= 10].copy()
print(f"異常値除去後: {len(df_clean)} 件（{before - len(df_clean)} 件除外）")

# --- 日付列の追加：月から四半期を算出 ---
df_clean['四半期'] = pd.cut(
    df_clean['月'],
    bins=[0, 3, 6, 9, 12],
    labels=['Q1（1〜3月）', 'Q2（4〜6月）', 'Q3（7〜9月）', 'Q4（10〜12月）']
)

# クリーニング完了の確認
print(f"\nクリーニング完了: {len(df_clean)} 件")
print(f"残存欠損値:\n{df_clean.isnull().sum()}")
print(f"\n四半期の分布:")
print(df_clean['四半期'].value_counts().sort_index())</code></pre>
                    </div>

                    <!-- クリーニング方針の図 -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-filter text-primary-500"></i>
                            クリーニングの判断基準
                        </h3>
                        <div class="mermaid">
flowchart TD
    A["欠損値の検出"] --> B{"除外 vs 補完"}
    B -->|"カテゴリ不明\n（分類不可能）"| C["該当行を除外\ndropna()"]
    B -->|"数値の欠損\n（平均等で推測可能）"| D["平均値・中央値で補完\nfillna()"]
    E["異常値の検出"] --> F{"除外 vs 修正"}
    F -->|"ありえない値\n（測定・入力ミス）"| G["閾値でフィルタ\ndf[df['列'] <= 閾値]"]
    F -->|"外れ値だが\n実際の値かもしれない"| H["フラグ付与して\n別途調査"]

    style C fill:#fee2e2,stroke:#ef4444,color:#7f1d1d
    style D fill:#d1fae5,stroke:#10b981,color:#064e3b
    style G fill:#fee2e2,stroke:#ef4444,color:#7f1d1d
    style H fill:#fef3c7,stroke:#f59e0b,color:#92400e
                        </div>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div>
                                <p class="text-emerald-900 font-medium">クリーニングの原則</p>
                                <p class="text-emerald-800 text-sm mt-1">
                                    元のデータ（<code class="bg-emerald-100 px-1 rounded font-mono">df_raw</code>）は必ず保持し、クリーニング済みデータは別の変数（<code class="bg-emerald-100 px-1 rounded font-mono">df_clean</code>）に保存します。「どのような処理をしたか」をコードのコメントで必ず記録しておきましょう。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 15.5 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        15.5 Step 4 - 集計・分析
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        クリーニングが完了したデータを使って、分析計画で立てた4つの問いに答えます。<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">groupby</code> と <code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">pivot_table</code> を中心に使います。
                    </p>

                    <h3 class="text-base font-semibold text-slate-700 mt-6 mb-3">Q1. 月別売上の集計</h3>

                    <!-- コードブロック: 月別集計 -->
                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">sales_project.ipynb - セル4: 月別集計</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 月別の売上金額を合計・件数を集計
monthly = df_clean.groupby('月').agg(
    売上合計=('売上金額', 'sum'),
    取引件数=('取引ID', 'count'),
    平均単価=('単価', 'mean')
).reset_index()

# 月番号を「X月」の文字列に変換
monthly['月ラベル'] = monthly['月'].astype(str) + '月'

print("=== 月別売上サマリ ===")
print(monthly[['月ラベル', '売上合計', '取引件数', '平均単価']].to_string(index=False))</code></pre>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mt-6 mb-3">Q2. カテゴリ別売上の集計</h3>

                    <!-- コードブロック: カテゴリ別集計 -->
                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">sales_project.ipynb - セル5: カテゴリ別集計</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># カテゴリ別の売上集計
category_sales = df_clean.groupby('カテゴリ')['売上金額'].sum().sort_values(ascending=False)

# 売上比率（%）を算出
category_ratio = (category_sales / category_sales.sum() * 100).round(1)

# 結果を結合して表示
category_summary = pd.DataFrame({
    '売上合計': category_sales,
    '売上比率(%)': category_ratio
})
print("=== カテゴリ別売上 ===")
print(category_summary)</code></pre>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mt-6 mb-3">Q3 & Q4. 四半期・ピボットテーブル分析</h3>

                    <!-- コードブロック: ピボット分析 -->
                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">sales_project.ipynb - セル6: ピボット分析</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 四半期×カテゴリのピボットテーブル
pivot = pd.pivot_table(
    df_clean,
    values='売上金額',
    index='四半期',
    columns='カテゴリ',
    aggfunc='sum',
    fill_value=0
)
# 各行に「合計」列を追加
pivot['合計'] = pivot.sum(axis=1)

print("=== 四半期×カテゴリ 売上ピボット（円） ===")
print(pivot.to_string())</code></pre>
                    </div>
                </section>

                <!-- セクション 15.6 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        15.6 Step 5 - データの可視化
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        集計結果をグラフで可視化します。複数のグラフをひとつの図（<strong>サブプロット</strong>）にまとめてレポートとして仕上げます。
                    </p>

                    <!-- コードブロック: 可視化 -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">sales_project.ipynb - セル7: 可視化レポート</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 2×2のサブプロット（4枚のグラフを並べる）
fig, axes = plt.subplots(2, 2, figsize=(14, 10))
fig.suptitle('FCマート 年間売上分析レポート', fontsize=16, fontweight='bold', y=1.02)

# --- グラフ1: 月別売上推移（折れ線グラフ） ---
ax1 = axes[0, 0]
ax1.plot(monthly['月ラベル'], monthly['売上合計'],
         marker='o', linewidth=2, color='steelblue', markersize=6)
ax1.fill_between(range(len(monthly)), monthly['売上合計'], alpha=0.15, color='steelblue')
ax1.set_title('月別売上推移', fontsize=13, fontweight='bold')
ax1.set_xlabel('月')
ax1.set_ylabel('売上金額（円）')
ax1.tick_params(axis='x', rotation=45)
ax1.yaxis.set_major_formatter(ticker.FuncFormatter(lambda x, _: f'{x/10000:.0f}万'))
ax1.grid(True, alpha=0.3)

# --- グラフ2: カテゴリ別売上構成（円グラフ） ---
ax2 = axes[0, 1]
colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444']
ax2.pie(category_sales.values, labels=category_sales.index,
        autopct='%1.1f%%', colors=colors, startangle=90,
        textprops={'fontsize': 11})
ax2.set_title('カテゴリ別売上構成', fontsize=13, fontweight='bold')

# --- グラフ3: カテゴリ別売上棒グラフ ---
ax3 = axes[1, 0]
bars = ax3.bar(category_sales.index, category_sales.values,
               color=colors, edgecolor='white', linewidth=0.5)
ax3.set_title('カテゴリ別売上金額', fontsize=13, fontweight='bold')
ax3.set_xlabel('カテゴリ')
ax3.set_ylabel('売上金額（円）')
ax3.yaxis.set_major_formatter(ticker.FuncFormatter(lambda x, _: f'{x/10000:.0f}万'))
# 棒の上に値を表示
for bar, val in zip(bars, category_sales.values):
    ax3.text(bar.get_x() + bar.get_width() / 2, bar.get_height() + 50000,
             f'{val/10000:.0f}万', ha='center', va='bottom', fontsize=9)
ax3.grid(True, axis='y', alpha=0.3)

# --- グラフ4: 四半期別売上（積み上げ棒グラフ） ---
ax4 = axes[1, 1]
pivot_plot = pivot.drop(columns=['合計'])
pivot_plot.plot(kind='bar', stacked=True, ax=ax4, color=colors,
                edgecolor='white', linewidth=0.5)
ax4.set_title('四半期×カテゴリ別売上', fontsize=13, fontweight='bold')
ax4.set_xlabel('四半期')
ax4.set_ylabel('売上金額（円）')
ax4.yaxis.set_major_formatter(ticker.FuncFormatter(lambda x, _: f'{x/10000:.0f}万'))
ax4.tick_params(axis='x', rotation=15)
ax4.legend(title='カテゴリ', bbox_to_anchor=(1.01, 1), loc='upper left', fontsize=9)
ax4.grid(True, axis='y', alpha=0.3)

plt.tight_layout()
plt.savefig('sales_report.png', dpi=150, bbox_inches='tight')
plt.show()
print("グラフを sales_report.png に保存しました")</code></pre>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div>
                                <p class="text-emerald-900 font-medium">savefig でグラフをファイル保存</p>
                                <p class="text-emerald-800 text-sm mt-1">
                                    <code class="bg-emerald-100 px-1 rounded font-mono">plt.savefig('ファイル名.png', dpi=150, bbox_inches='tight')</code> でグラフ画像を保存できます。<code class="bg-emerald-100 px-1 rounded font-mono">dpi=150</code> で解像度を上げ、<code class="bg-emerald-100 px-1 rounded font-mono">bbox_inches='tight'</code> で余白を自動調整します。<strong>必ず <code class="bg-emerald-100 px-1 rounded font-mono">plt.show()</code> の前に呼び出してください</strong>（showの後は空になります）。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 15.7 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        15.7 Step 6 - 分析結果のまとめ（レポート作成）
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        グラフが完成したら、数値を使って分析結果を文章でまとめます。Jupyter Notebookでは<strong>Markdownセル</strong>を使って、コードと考察を一緒に記述できます。
                    </p>

                    <!-- コードブロック: 数値サマリの出力 -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">sales_project.ipynb - セル8: 数値サマリ出力</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 分析結果の数値サマリをコードで出力
total_sales = df_clean['売上金額'].sum()
top_month   = monthly.loc[monthly['売上合計'].idxmax(), '月ラベル']
top_cat     = category_sales.index[0]
top_cat_pct = category_ratio.iloc[0]
best_q      = pivot['合計'].idxmax()

print("=" * 40)
print("  FCマート 年間売上分析 - 主要結果")
print("=" * 40)
print(f"  年間売上総額  : {total_sales:,.0f} 円")
print(f"  最高売上月    : {top_month}")
print(f"  売上No.1カテゴリ: {top_cat}（{top_cat_pct}%）")
print(f"  最高売上四半期: {best_q}")
print("=" * 40)</code></pre>
                    </div>

                    <!-- レポート構成の説明 -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-file-alt text-primary-500"></i>
                            分析レポートの推奨構成
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-lg">
                                <span class="flex-shrink-0 w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</span>
                                <div>
                                    <p class="font-medium text-slate-800">背景・目的</p>
                                    <p class="text-slate-600 text-sm">なぜこの分析を行うのか、何を明らかにしたいのかを記述する</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-lg">
                                <span class="flex-shrink-0 w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</span>
                                <div>
                                    <p class="font-medium text-slate-800">データ概要</p>
                                    <p class="text-slate-600 text-sm">データの件数・期間・項目の説明、前処理で実施した内容を記述する</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-lg">
                                <span class="flex-shrink-0 w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center text-sm font-bold">3</span>
                                <div>
                                    <p class="font-medium text-slate-800">分析結果（グラフと数値）</p>
                                    <p class="text-slate-600 text-sm">各問いに対するグラフと、読み取れる具体的な数値・傾向を記述する</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-lg">
                                <span class="flex-shrink-0 w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center text-sm font-bold">4</span>
                                <div>
                                    <p class="font-medium text-slate-800">考察・示唆</p>
                                    <p class="text-slate-600 text-sm">分析結果から何が言えるか、どのような施策が考えられるかを記述する</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-lg">
                                <span class="flex-shrink-0 w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center text-sm font-bold">5</span>
                                <div>
                                    <p class="font-medium text-slate-800">次のアクション</p>
                                    <p class="text-slate-600 text-sm">この分析を受けて、次に何を調べるべきか、どう施策に活かすかを提案する</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                            <div>
                                <p class="text-blue-900 font-medium">「数値」で語ることが重要</p>
                                <p class="text-blue-800 text-sm mt-1">
                                    「売上が高い」ではなく「12月の売上は1月比で約XX%増加した」のように、具体的な数値を使って表現することでレポートの説得力が増します。分析コードで数値を出力し、それをMarkdownに貼り付ける習慣をつけましょう。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 実習カード -->
                <div class="bg-gradient-to-r from-purple-50 to-fuchsia-50 border border-purple-200 rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-code text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-purple-800 mb-3 break-words">
                                実習 15-1: 売上データ分析プロジェクトを完成させる
                            </h3>
                            <p class="text-purple-900 mb-4 break-words">
                                本章で紹介したコードをJupyter Notebookで順番に実行し、4枚のグラフが含まれた分析レポートを完成させましょう。
                            </p>

                            <h4 class="font-medium text-purple-800 mb-2">手順</h4>
                            <ol class="space-y-3 mb-4">
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">1</span>
                                    <span class="flex-1 min-w-0 break-words">新しいJupyter Notebookを作成し、<code class="bg-purple-100 px-1 rounded font-mono">sales_project.ipynb</code> として保存する</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">2</span>
                                    <span class="flex-1 min-w-0 break-words">セル1〜8のコードを順番に入力し、Shift+Enterで実行する（エラーが出たらメッセージを確認して修正する）</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">3</span>
                                    <span class="flex-1 min-w-0 break-words">4枚のグラフが表示され、<code class="bg-purple-100 px-1 rounded font-mono">sales_report.png</code> が保存されることを確認する</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">4</span>
                                    <span class="flex-1 min-w-0 break-words">Markdownセルを追加して、分析結果の考察を自分の言葉でまとめてみる</span>
                                </li>
                            </ol>

                            <h4 class="font-medium text-purple-800 mb-2 mt-4">発展課題（余裕があれば）</h4>
                            <ul class="space-y-2 mb-4">
                                <li class="flex items-start gap-2 text-purple-900">
                                    <i class="fas fa-plus-circle text-purple-400 mt-1 flex-shrink-0"></i>
                                    <span class="flex-1 min-w-0 break-words">売上上位10商品をランキング形式で表示する棒グラフを追加する（ヒント: 単価でソートして上位10件を取り出す）</span>
                                </li>
                                <li class="flex items-start gap-2 text-purple-900">
                                    <i class="fas fa-plus-circle text-purple-400 mt-1 flex-shrink-0"></i>
                                    <span class="flex-1 min-w-0 break-words">カテゴリ別の月次推移をヒートマップで表現する（ヒント: <code class="bg-purple-100 px-1 rounded font-mono">plt.imshow()</code> または seaborn の heatmap を使用）</span>
                                </li>
                                <li class="flex items-start gap-2 text-purple-900">
                                    <i class="fas fa-plus-circle text-purple-400 mt-1 flex-shrink-0"></i>
                                    <span class="flex-1 min-w-0 break-words">分析結果をCSVファイルに書き出して保存する（<code class="bg-purple-100 px-1 rounded font-mono">df_clean.to_csv('cleaned_sales.csv', index=False)</code>）</span>
                                </li>
                            </ul>

                            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-lg p-3 mt-2">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-check-circle text-emerald-600 mt-0.5"></i>
                                    <div>
                                        <p class="text-emerald-800 font-medium text-sm">成功の目印</p>
                                        <p class="text-emerald-700 text-sm mt-1">4枚グラフのレポート画像（sales_report.png）が保存され、分析サマリの数値が出力されれば完成です</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- セクション 15.8 まとめ -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        15.8 この章のまとめ
                    </h2>

                    <div class="bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-flag-checkered text-primary-500"></i>
                            学んだこと
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">分析計画を先に立てることで、目的に沿った分析ができる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">元データ（df_raw）とクリーニング済みデータ（df_clean）は必ず分けて管理する</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">groupby + agg で月別・カテゴリ別の集計ができる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">pivot_table で多次元の集計（四半期×カテゴリ）ができる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">subplots で複数グラフをひとつの図にまとめ、savefig で保存できる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">レポートは「目的 → データ → 結果 → 考察 → アクション」の構成で整理する</span>
                            </div>
                        </div>
                    </div>

                    <!-- 全体のスキルマップ -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-trophy text-yellow-500"></i>
                            第1〜15章で習得したスキルの全体像
                        </h3>
                        <div class="mermaid">
flowchart TB
    subgraph Part1["第1部: NumPy基礎（第1〜3章）"]
        N1["配列操作・演算"]
        N2["統計関数・乱数"]
    end
    subgraph Part2["第2部: pandas基礎（第4〜7章）"]
        P1["Series・DataFrame"]
        P2["読み込み・書き出し"]
        P3["フィルタリング・選択"]
    end
    subgraph Part3["第3部: データ加工（第8〜11章）"]
        D1["前処理・クリーニング"]
        D2["変換・加工"]
        D3["groupby・集計"]
        D4["結合・マージ"]
    end
    subgraph Part4["第4部: 可視化（第12〜14章）"]
        V1["基本グラフ作成"]
        V2["多様なグラフ選択"]
        V3["カスタマイズ・保存"]
    end
    subgraph Part5["第5部: 実践（第15章）"]
        R1["総合プロジェクト"]
    end

    Part1 --> Part2
    Part2 --> Part3
    Part3 --> Part4
    Part4 --> Part5

    style Part1 fill:#dbeafe,stroke:#3b82f6,color:#1e40af
    style Part2 fill:#d1fae5,stroke:#10b981,color:#064e3b
    style Part3 fill:#fef3c7,stroke:#f59e0b,color:#92400e
    style Part4 fill:#ede9fe,stroke:#8b5cf6,color:#4c1d95
    style Part5 fill:#fce7f3,stroke:#ec4899,color:#831843
                        </div>
                    </div>
                </section>

                <!-- 理解度確認クイズ -->
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-question text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-blue-800 mb-4 break-words">理解度確認クイズ</h3>
                            <ol class="space-y-5">
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q1. データ分析プロジェクトで「分析計画を先に立てる」ことの利点を説明してください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <div class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            <p class="text-sm">目的が明確になるため、分析の方向性が定まり、不要な分析に時間を費やすことがなくなります。また、「何を明らかにしたいか」が決まっていることで、必要なグラフや集計の種類も自然に決まり、効率的に作業を進められます。分析後に「結局何が言いたかったのか」という混乱も防げます。</p>
                                        </div>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q2. 元データ（df_raw）とクリーニング済みデータ（df_clean）を別々の変数に保持する理由は何ですか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <div class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            <p class="text-sm">クリーニング処理を誤って行った場合や、後で別の前処理方針を試したい場合に、元データから再始できるようにするためです。元データを上書きしてしまうと復元できません。また、元データとクリーニング後を比較して「どれだけのデータを除外したか」を後から確認する際にも重要です。</p>
                                        </div>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q3. <code class="bg-blue-100 px-1 rounded font-mono">plt.savefig()</code> は <code class="bg-blue-100 px-1 rounded font-mono">plt.show()</code> の前後どちらで呼び出す必要がありますか？その理由も答えてください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words text-sm">
                                            <strong>plt.show() の前</strong>に呼び出す必要があります。<code class="bg-blue-200 px-1 rounded font-mono">plt.show()</code> を実行すると描画バッファがクリアされ、グラフの内容が消えてしまいます。そのため保存は必ず表示の前に行います。順序: <strong>グラフ作成 → savefig → show</strong> が正しい順序です。
                                        </p>
                                    </details>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- トラブルシューティング -->
                <div class="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl overflow-hidden mb-8">
                    <div class="bg-orange-100 px-6 py-3 border-b border-orange-200">
                        <h3 class="font-semibold text-orange-800 flex items-center gap-2">
                            <i class="fas fa-tools"></i>
                            よくあるトラブルと解決方法
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <details class="group">
                            <summary class="flex items-center gap-3 cursor-pointer list-none p-3 rounded-lg bg-white border border-orange-200 hover:bg-orange-50 transition-colors">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="font-medium text-orange-800">グラフの日本語が文字化け（□□□）になる</span>
                                <i class="fas fa-chevron-down ml-auto text-orange-400 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="mt-3 pl-10 text-orange-900 text-sm">
                                <p class="mb-2"><strong>原因:</strong> matplotlibのデフォルトフォントが日本語に対応していない。</p>
                                <p><strong>解決方法:</strong> コードの冒頭に <code class="bg-orange-100 px-1 rounded font-mono">plt.rcParams['font.family'] = 'IPAexGothic'</code>（Linux/Mac）または <code class="bg-orange-100 px-1 rounded font-mono">'MS Gothic'</code>（Windows）を設定する。または <code class="bg-orange-100 px-1 rounded font-mono">japanize_matplotlib</code> ライブラリをインストールして使用する。</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center gap-3 cursor-pointer list-none p-3 rounded-lg bg-white border border-orange-200 hover:bg-orange-50 transition-colors">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="font-medium text-orange-800">ピボットテーブルの「四半期」列がNaNになる</span>
                                <i class="fas fa-chevron-down ml-auto text-orange-400 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="mt-3 pl-10 text-orange-900 text-sm">
                                <p class="mb-2"><strong>原因:</strong> <code class="bg-orange-100 px-1 rounded font-mono">pd.cut()</code> でグループ化された「四半期」列がCategorical型になっており、NaN（未分類）が含まれている場合がある。</p>
                                <p><strong>解決方法:</strong> <code class="bg-orange-100 px-1 rounded font-mono">pivot_table</code> の引数に <code class="bg-orange-100 px-1 rounded font-mono">observed=True</code> を追加する。または <code class="bg-orange-100 px-1 rounded font-mono">df_clean.dropna(subset=['四半期'])</code> で四半期がNaNの行を除外してからピボット処理を行う。</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center gap-3 cursor-pointer list-none p-3 rounded-lg bg-white border border-orange-200 hover:bg-orange-50 transition-colors">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="font-medium text-orange-800">savefig で保存した画像のグラフが切れている</span>
                                <i class="fas fa-chevron-down ml-auto text-orange-400 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="mt-3 pl-10 text-orange-900 text-sm">
                                <p class="mb-2"><strong>原因:</strong> 凡例やラベルがfigure領域の外に出てしまっている。</p>
                                <p><strong>解決方法:</strong> <code class="bg-orange-100 px-1 rounded font-mono">plt.savefig('file.png', bbox_inches='tight')</code> の <code class="bg-orange-100 px-1 rounded font-mono">bbox_inches='tight'</code> オプションで自動的に余白を調整します。それでも切れる場合は <code class="bg-orange-100 px-1 rounded font-mono">fig.tight_layout()</code> を先に呼び出すか、<code class="bg-orange-100 px-1 rounded font-mono">figsize</code> を大きくします。</p>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- 章間ナビゲーション -->
                <nav class="flex items-center justify-between pt-6 mt-6 border-t border-slate-200">
                    <a href="python-data-analysis-learning-material-14.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 transition-colors">
                        <i class="fas fa-arrow-left text-slate-400 group-hover:text-slate-600 transition-transform group-hover:-translate-x-1"></i>
                        <div>
                            <span class="text-xs text-slate-500 block">前の章</span>
                            <span class="text-slate-700 font-medium">グラフのカスタマイズと見栄えの向上</span>
                        </div>
                    </a>
                    <a href="python-data-analysis-learning-material-16.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl bg-primary-500 hover:bg-primary-600 text-white transition-colors">
                        <div class="text-right">
                            <span class="text-xs text-primary-100 block">次の章</span>
                            <span class="font-medium">発展トピック - さらなるデータ分析スキルへ</span>
                        </div>
                        <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- フッター -->
    <footer class="bg-slate-800 text-slate-300">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <p class="text-sm text-center md:text-left">
                    &copy; 2026 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。
                </p>
                <div class="flex items-center gap-4">
                    <a href="https://github.com/fcircle-biz/tech_docs" class="hover:text-white transition-colors">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- スクロールトップボタン -->
    <button id="scroll-top-btn"
            class="fixed bottom-6 right-6 w-12 h-12 bg-primary-500 text-white rounded-full
                   shadow-lg hover:bg-primary-600 transition-all duration-300
                   opacity-0 invisible translate-y-4"
            onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- サイドバー生成 -->
    <script src="sidebar-content.js"></script>

    <!-- 共通JavaScript -->
    <script src="main.js"></script>

    <!-- 描画ツール -->
    <script src="drawing-tool.js"></script>
</body>
</html>
