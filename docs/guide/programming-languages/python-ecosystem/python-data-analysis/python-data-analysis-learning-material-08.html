<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" id="viewport-meta">
    <title>Pythonデータ分析入門 第8章 - データの前処理 - 欠損値と重複の処理</title>

    <!-- ダークモード早期適用（フラッシュ防止） -->
    <script>
        (function() {
            const saved = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === 'dark' || (saved === null && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Python - Blue
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts - Noto Sans JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="styles.css">
</head>
<body class="font-sans bg-slate-50 text-slate-800 antialiased">
    <!-- ヘッダー/ナビゲーションバー -->
    <header class="fixed top-0 left-0 right-0 z-50 text-white header-rich header-rich-shadow">
        <nav class="w-full px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="flex items-center justify-between py-3">
                <!-- 左側: ロゴとタイトルセクション -->
                <div class="flex items-center gap-4">
                    <!-- アイコン -->
                    <div class="relative group">
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-400/30 to-orange-400/30 rounded-2xl blur-lg group-hover:blur-xl transition-all"></div>
                        <div class="relative w-14 h-14 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                            <i class="fab fa-python text-3xl icon-rotate-hover drop-shadow-lg"></i>
                        </div>
                    </div>

                    <!-- タイトルとメタ情報 -->
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-bold tracking-wide drop-shadow-md">Pythonデータ分析入門</span>
                            <span class="hidden sm:inline-flex items-center gap-1 px-2 py-0.5 bg-white/20 rounded-md text-[10px] font-semibold uppercase tracking-wider">
                                <i class="fas fa-star text-yellow-300 text-[8px]"></i>
                                初級
                            </span>
                        </div>
                        <div class="flex items-center gap-3 text-[11px] text-white/90 font-medium">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-chart-bar text-[9px]"></i>
                                <span>データ分析</span>
                            </div>
                            <div class="hidden sm:flex items-center gap-1">
                                <i class="fas fa-clock text-[9px]"></i>
                                <span>所要時間 約23時間</span>
                            </div>
                            <div class="hidden lg:flex items-center gap-1">
                                <i class="fas fa-language text-[9px]"></i>
                                <span>日本語</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側: サイドバートグルボタン -->
                <button id="sidebar-toggle-btn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white/20 transition-all active:scale-95" title="サイドバーの表示/非表示">
                    <i class="fas fa-bars text-lg"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- メインレイアウト -->
    <div class="flex min-h-screen pt-20">
        <!-- サイドバーはsidebar-content.jsで動的に生成されます -->

        <!-- メインコンテンツ -->
        <main class="flex-1 min-w-0">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-10 py-6">
                <!-- パンくずリスト -->
                <nav class="flex items-center gap-2 text-sm text-slate-500 mb-6">
                    <a href="https://fcircle-biz.github.io/tech_docs/" class="hover:text-primary-600 transition-colors">ホーム</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <a href="https://fcircle-biz.github.io/tech_docs/guide/programming-languages/python-ecosystem/python-data-analysis/" class="hover:text-primary-600 transition-colors">Pythonデータ分析入門</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-slate-700">第8章</span>
                </nav>

                <!-- 章ヘッダー -->
                <header class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-700">
                            第8章
                        </span>
                        <span class="text-sm text-slate-500">
                            <i class="fas fa-clock mr-1"></i>所要時間: 約1.5時間
                        </span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">
                        データの前処理 - 欠損値と重複の処理
                    </h1>
                    <p class="text-slate-600">
                        実際のデータには欠損値（NaN）や重複が含まれていることがほとんどです。これらを適切に処理する方法を学び、分析可能なクリーンなデータを作る技術を習得します。データ分析の品質はこの前処理の丁寧さで大きく変わります。
                    </p>
                </header>

                <!-- 学習目標カード -->
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 rounded-xl p-5 mb-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-amber-400 rounded-lg flex items-center justify-center">
                            <i class="fas fa-lightbulb text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-amber-800 mb-3">この章で学ぶこと</h2>
                            <ul class="space-y-2">
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>欠損値（NaN）の検出と確認方法（isnull, isna, info）</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>欠損値の削除（dropna）と補完（fillna）の使い分け</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>重複データの検出（duplicated）と削除（drop_duplicates）</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>データ型の変換（astype）と異常値の検出・対処</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- セクション 8.1 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        8.1 なぜデータ前処理が必要か
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        現実のデータは「汚い」ことが多いです。アンケートへの未回答（欠損値）、同じ人物が二重登録される（重複）、数値が文字列として保存されている（型の不整合）など、さまざまな問題を抱えています。
                    </p>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        こうした問題を放置したまま分析を進めると、計算結果がおかしくなったり、エラーが発生したりします。前処理はデータ分析の品質を左右する、非常に重要なステップです。
                    </p>

                    <!-- 前処理の必要性の図 -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-sitemap text-primary-500"></i>
                            データ前処理の位置づけ
                        </h3>
                        <div class="mermaid">
flowchart LR
    A["生データ\n（欠損・重複・型不整合）"] --> B["前処理\n（第8-9章）"]
    B --> C["クリーンデータ"]
    C --> D["集計・分析\n（第10-11章）"]
    D --> E["可視化\n（第12-14章）"]

    style A fill:#fee2e2,stroke:#ef4444,color:#7f1d1d
    style B fill:#fef3c7,stroke:#f59e0b,color:#92400e
    style C fill:#d1fae5,stroke:#10b981,color:#064e3b
    style D fill:#dbeafe,stroke:#3b82f6,color:#1e40af
    style E fill:#ede9fe,stroke:#8b5cf6,color:#4c1d95
                        </div>
                    </div>

                    <!-- 前処理の3大問題 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-red-50 to-rose-50 border border-red-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-question-circle text-red-500"></i>
                                <h4 class="font-semibold text-red-800">欠損値（NaN）</h4>
                            </div>
                            <p class="text-red-900 text-sm leading-relaxed">
                                データが存在しない空のセル。アンケートの未回答やシステム障害が原因で発生する。計算時に無視される場合と、エラーになる場合がある。
                            </p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-copy text-orange-500"></i>
                                <h4 class="font-semibold text-orange-800">重複データ</h4>
                            </div>
                            <p class="text-orange-900 text-sm leading-relaxed">
                                同じ情報が複数回記録されている状態。システムの二重送信や手動入力のミスで発生する。集計値が実態より多くなる。
                            </p>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-amber-50 border border-yellow-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-exchange-alt text-yellow-600"></i>
                                <h4 class="font-semibold text-yellow-800">型の不整合</h4>
                            </div>
                            <p class="text-yellow-900 text-sm leading-relaxed">
                                数値なのに文字列として保存されている状態。CSVの読み込み時や、データの結合時に起こりやすい。演算ができずエラーになる。
                            </p>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                            <div>
                                <p class="text-blue-900 font-medium">データサイエンティストの時間の80%は前処理</p>
                                <p class="text-blue-800 text-sm mt-1">
                                    業界では「データサイエンティストの仕事の80%はデータクリーニングだ」と言われることがあります。それほど前処理は重要かつ手間のかかる作業です。pandasはこの作業を大幅に効率化してくれます。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 8.2 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        8.2 欠損値（NaN）とは何か
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>NaN</strong>（Not a Number）は「値が存在しない」ことを示す特別な値です。pandasではデータが不在の場所に自動的にNaNが入ります。
                    </p>

                    <!-- NaN の発生例 -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-table text-primary-500"></i>
                            NaNを含むデータの例
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse">
                                <thead>
                                    <tr class="bg-primary-50">
                                        <th class="border border-slate-200 px-4 py-2 text-left text-primary-800">名前</th>
                                        <th class="border border-slate-200 px-4 py-2 text-left text-primary-800">年齢</th>
                                        <th class="border border-slate-200 px-4 py-2 text-left text-primary-800">メール</th>
                                        <th class="border border-slate-200 px-4 py-2 text-left text-primary-800">スコア</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="hover:bg-slate-50">
                                        <td class="border border-slate-200 px-4 py-2">田中 太郎</td>
                                        <td class="border border-slate-200 px-4 py-2">28</td>
                                        <td class="border border-slate-200 px-4 py-2">tanaka@example.com</td>
                                        <td class="border border-slate-200 px-4 py-2">85</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50 bg-red-50">
                                        <td class="border border-slate-200 px-4 py-2">鈴木 花子</td>
                                        <td class="border border-red-200 px-4 py-2 text-red-600 font-medium">NaN</td>
                                        <td class="border border-slate-200 px-4 py-2">suzuki@example.com</td>
                                        <td class="border border-red-200 px-4 py-2 text-red-600 font-medium">NaN</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="border border-slate-200 px-4 py-2">佐藤 次郎</td>
                                        <td class="border border-slate-200 px-4 py-2">35</td>
                                        <td class="border border-red-200 px-4 py-2 text-red-600 font-medium">NaN</td>
                                        <td class="border border-slate-200 px-4 py-2">92</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="border border-slate-200 px-4 py-2">山田 三郎</td>
                                        <td class="border border-slate-200 px-4 py-2">22</td>
                                        <td class="border border-slate-200 px-4 py-2">yamada@example.com</td>
                                        <td class="border border-slate-200 px-4 py-2">78</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="text-slate-500 text-sm mt-3">
                            <i class="fas fa-info-circle mr-1"></i>赤いセルがNaN（欠損値）。このまま平均を計算するとどの値を使うべきかわからなくなる。
                        </p>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div>
                                <p class="text-emerald-900 font-medium">NaNの特徴：NaN != NaN</p>
                                <p class="text-emerald-800 text-sm mt-1">
                                    NaNは「値がわからない」という意味なので、NaN同士を比較しても等しくなりません（<code class="bg-emerald-100 px-1 rounded font-mono">float('nan') == float('nan')</code> は <code class="bg-emerald-100 px-1 rounded font-mono">False</code>）。そのため、欠損値の確認には <code class="bg-emerald-100 px-1 rounded font-mono">==</code> ではなく <code class="bg-emerald-100 px-1 rounded font-mono">isnull()</code> や <code class="bg-emerald-100 px-1 rounded font-mono">isna()</code> を使います。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 8.3 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        8.3 欠損値の検出と確認
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        まず、データにどこに・どれくらいの欠損値があるかを把握することが前処理の第一歩です。pandasには欠損値を確認するための便利なメソッドが揃っています。
                    </p>

                    <!-- コードブロック: 欠損値確認 -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">欠損値の検出</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd
import numpy as np

# サンプルデータ（欠損値入り）
df = pd.DataFrame({
    '名前': ['田中', '鈴木', '佐藤', '山田'],
    '年齢': [28, np.nan, 35, 22],
    'メール': ['t@ex.com', 's@ex.com', np.nan, 'y@ex.com'],
    'スコア': [85, np.nan, 92, 78]
})

# 欠損値の確認（True=欠損、False=値あり）
print(df.isnull())

# 列ごとの欠損数を集計
print(df.isnull().sum())

# 欠損率（%）を表示
print(df.isnull().mean() * 100)</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-2">出力例</p>
                        <pre class="text-slate-600 text-sm whitespace-pre">      名前     年齢    メール   スコア
0  False  False  False  False
1  False   True  False   True
2  False  False   True  False
3  False  False  False  False

名前      0
年齢      1
メール    1
スコア    1
dtype: int64

名前       0.0
年齢      25.0
メール    25.0
スコア    25.0
dtype: float64</pre>
                    </div>

                    <p class="text-slate-600 leading-relaxed mb-4">
                        <code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">info()</code> メソッドでも欠損値の状況を素早く把握できます。
                    </p>

                    <!-- コードブロック: info() -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">info() で全体確認</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># info() で欠損値の有無を一覧確認
df.info()

# 欠損値のある行だけを取り出す
df_missing = df[df.isnull().any(axis=1)]
print(df_missing)</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-4">
                        <p class="text-slate-700 text-sm font-medium mb-2">info() の出力例</p>
                        <pre class="text-slate-600 text-sm whitespace-pre">&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 4 entries, 0 to 3
Data columns (total 4 columns):
 #   Column  Non-Null Count  Dtype
---  ------  --------------  -----
 0   名前      4 non-null      object
 1   年齢      3 non-null      float64   ← 1件欠損
 2   メール    3 non-null      object    ← 1件欠損
 3   スコア    3 non-null      float64   ← 1件欠損
dtypes: float64(2), object(2)</pre>
                    </div>

                    <!-- 欠損値確認メソッドの対比表 -->
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-primary-50">
                                    <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">メソッド</th>
                                    <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">戻り値</th>
                                    <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">主な使い方</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">isnull() / isna()</td>
                                    <td class="border border-slate-200 px-4 py-2">同形状のTrue/FalseのDataFrame</td>
                                    <td class="border border-slate-200 px-4 py-2 text-slate-600">どのセルが欠損かを確認</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">isnull().sum()</td>
                                    <td class="border border-slate-200 px-4 py-2">列ごとの欠損数（Series）</td>
                                    <td class="border border-slate-200 px-4 py-2 text-slate-600">欠損の多い列を特定</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">isnull().mean()</td>
                                    <td class="border border-slate-200 px-4 py-2">列ごとの欠損率（0〜1）</td>
                                    <td class="border border-slate-200 px-4 py-2 text-slate-600">欠損率が高い列を判断</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">info()</td>
                                    <td class="border border-slate-200 px-4 py-2">データ型・非欠損数の一覧</td>
                                    <td class="border border-slate-200 px-4 py-2 text-slate-600">全体の状況を素早く把握</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">notnull() / notna()</td>
                                    <td class="border border-slate-200 px-4 py-2">同形状のTrue/FalseのDataFrame</td>
                                    <td class="border border-slate-200 px-4 py-2 text-slate-600">値があるセルを確認（逆）</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- セクション 8.4 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        8.4 欠損値の削除（dropna）
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        欠損値を含む行や列を削除するには <code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">dropna()</code> を使います。ただし、データが少なくなるので注意が必要です。
                    </p>

                    <!-- コードブロック: dropna -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">dropna() の使い方</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 欠損値を含む行をすべて削除
df_dropped = df.dropna()
print(df_dropped)

# 特定の列に欠損値がある行だけ削除
df_score_ok = df.dropna(subset=['スコア'])

# 欠損値が含まれる列を削除
df_col_dropped = df.dropna(axis=1)

# 全列がNaNの行だけ削除（1列でも値があれば残す）
df_all_na = df.dropna(how='all')

# 非欠損値が2個以上の行だけ残す
df_thresh = df.dropna(thresh=2)</code></pre>
                    </div>

                    <!-- dropna オプション表 -->
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-primary-50">
                                    <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">引数</th>
                                    <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">説明</th>
                                    <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">例</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">axis=0</td>
                                    <td class="border border-slate-200 px-4 py-2">欠損のある行を削除（デフォルト）</td>
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm text-slate-600">dropna(axis=0)</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">axis=1</td>
                                    <td class="border border-slate-200 px-4 py-2">欠損のある列を削除</td>
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm text-slate-600">dropna(axis=1)</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">how='any'</td>
                                    <td class="border border-slate-200 px-4 py-2">1つでも欠損があれば削除（デフォルト）</td>
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm text-slate-600">dropna(how='any')</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">how='all'</td>
                                    <td class="border border-slate-200 px-4 py-2">全部欠損のときだけ削除</td>
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm text-slate-600">dropna(how='all')</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">subset=[...]</td>
                                    <td class="border border-slate-200 px-4 py-2">指定列の欠損だけを対象にする</td>
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm text-slate-600">dropna(subset=['スコア'])</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">thresh=N</td>
                                    <td class="border border-slate-200 px-4 py-2">N個以上の非欠損値がある行・列を残す</td>
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm text-slate-600">dropna(thresh=3)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-red-50 border-l-4 border-red-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-red-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-red-900 font-medium break-words">dropna() はデータを減らすので慎重に</p>
                                <p class="text-red-800 text-sm mt-1 break-words">
                                    欠損値のある行を無条件で削除すると、分析に必要なデータまで消えてしまう可能性があります。欠損率が低い場合（5%未満など）は削除でもよいですが、欠損が多い場合は次のセクションで学ぶ「補完」を検討しましょう。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 8.5 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        8.5 欠損値の補完（fillna）
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        欠損値を削除する代わりに、適切な値で埋めることを「補完（imputation）」と呼びます。<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">fillna()</code> メソッドを使います。何で補完するかは、データの性質によって選びます。
                    </p>

                    <!-- 補完の戦略図 -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-project-diagram text-primary-500"></i>
                            補完方法の選び方
                        </h3>
                        <div class="mermaid">
flowchart TD
    A["欠損値を補完したい"] --> B{データの種類は?}
    B -->|数値データ| C{分布は?}
    B -->|カテゴリデータ| D["最頻値で補完\n（fillna(最頻値)）"]
    C -->|正規分布に近い| E["平均値で補完\n（fillna(mean())）"]
    C -->|偏りあり・外れ値あり| F["中央値で補完\n（fillna(median())）"]
    B -->|時系列データ| G["前後の値で補完\n（ffill / bfill）"]

    style E fill:#d1fae5,stroke:#10b981,color:#064e3b
    style F fill:#dbeafe,stroke:#3b82f6,color:#1e40af
    style D fill:#ede9fe,stroke:#8b5cf6,color:#4c1d95
    style G fill:#fef3c7,stroke:#f59e0b,color:#92400e
                        </div>
                    </div>

                    <!-- コードブロック: fillna -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">fillna() の使い方</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd
import numpy as np

df = pd.DataFrame({
    '名前': ['田中', '鈴木', '佐藤', '山田'],
    '年齢': [28, np.nan, 35, 22],
    'スコア': [85, np.nan, 92, 78]
})

# 固定値で補完（0や特定のデフォルト値）
df['年齢'].fillna(0)

# 平均値で補完（数値の欠損に有効）
mean_age = df['年齢'].mean()           # 平均を計算
df['年齢'] = df['年齢'].fillna(mean_age)

# 中央値で補完（外れ値がある場合に有効）
median_score = df['スコア'].median()
df['スコア'] = df['スコア'].fillna(median_score)

# 前の値で補完（時系列データに有効）
df['スコア'].fillna(method='ffill')    # forward fill

# 後の値で補完
df['スコア'].fillna(method='bfill')    # backward fill

print(df)</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-2">補完後の出力例</p>
                        <pre class="text-slate-600 text-sm whitespace-pre">   名前    年齢    スコア
0  田中  28.0  85.00
1  鈴木  28.33  85.00  ← 平均値で補完
2  佐藤  35.0  92.00
3  山田  22.0  78.00</pre>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                            <div>
                                <p class="text-blue-900 font-medium">inplace引数について</p>
                                <p class="text-blue-800 text-sm mt-1">
                                    <code class="bg-blue-100 px-1 rounded font-mono">fillna()</code>（および後述の<code class="bg-blue-100 px-1 rounded font-mono">dropna()</code>なども）はデフォルトで元のDataFrameを変更せず、新しいオブジェクトを返します。元を変更したい場合は <code class="bg-blue-100 px-1 rounded font-mono">inplace=True</code> を付けるか、変数に代入し直してください。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 8.6 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        8.6 重複データの検出と削除
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        同じ情報が複数回登録されているデータは、集計時に実態と乖離した結果を生みます。pandasでは <code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">duplicated()</code> で重複を確認し、<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">drop_duplicates()</code> で削除できます。
                    </p>

                    <!-- コードブロック: duplicated -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">重複の検出と削除</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd

df = pd.DataFrame({
    '注文ID': [1, 2, 2, 3, 4, 4],
    '商品': ['りんご', 'みかん', 'みかん', 'ぶどう', 'いちご', 'いちご'],
    '金額': [100, 200, 200, 300, 150, 150]
})

# 重複行の確認（True=重複、False=初回）
print(df.duplicated())

# 重複している行数
print(f"重複数: {df.duplicated().sum()}")

# 重複行を削除（初回のみ残す）
df_unique = df.drop_duplicates()

# 特定の列を基準に重複を判断
df_unique2 = df.drop_duplicates(subset=['注文ID'])

# 最後の行を残す（初回を削除）
df_last = df.drop_duplicates(keep='last')

print(df_unique)</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-2">出力例</p>
                        <pre class="text-slate-600 text-sm whitespace-pre">0    False
1    False
2     True   ← 重複
3    False
4    False
5     True   ← 重複
dtype: bool

重複数: 2

   注文ID  商品    金額
0      1  りんご  100
1      2  みかん  200
3      3  ぶどう  300
4      4  いちご  150</pre>
                    </div>

                    <!-- drop_duplicates の引数表 -->
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-primary-50">
                                    <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">引数</th>
                                    <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">説明</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">subset=[列名]</td>
                                    <td class="border border-slate-200 px-4 py-2 text-slate-600">指定した列のみを比較して重複を判断</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">keep='first'</td>
                                    <td class="border border-slate-200 px-4 py-2 text-slate-600">最初の出現を残す（デフォルト）</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">keep='last'</td>
                                    <td class="border border-slate-200 px-4 py-2 text-slate-600">最後の出現を残す（最新データが下にある場合に有用）</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="border border-slate-200 px-4 py-2 font-mono text-sm">keep=False</td>
                                    <td class="border border-slate-200 px-4 py-2 text-slate-600">重複する行をすべて削除</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- セクション 8.7 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        8.7 データ型の変換（astype）
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        CSVからデータを読み込むと、数値が文字列として読み込まれることがあります。このような場合は <code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">astype()</code> でデータ型を変換します。
                    </p>

                    <!-- コードブロック: astype -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">データ型の確認と変換</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd

# 文字列として読み込まれた数値データ
df = pd.DataFrame({
    '商品ID': ['1', '2', '3'],
    '価格': ['100', '250', '180'],      # 文字列
    '在庫': ['50', '0', '30'],          # 文字列
})

# 現在のデータ型を確認
print(df.dtypes)

# 整数型に変換
df['商品ID'] = df['商品ID'].astype(int)
df['価格']   = df['価格'].astype(int)

# または複数列をまとめて変換
df = df.astype({'在庫': int})

# 変換後のデータ型を確認
print(df.dtypes)

# 変換後は計算が可能
print(f"平均価格: {df['価格'].mean():.0f}円")</code></pre>
                    </div>

                    <!-- よく使うデータ型 -->
                    <div class="bg-white border border-slate-200 rounded-xl p-5 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-3 flex items-center gap-2">
                            <i class="fas fa-list text-primary-500"></i>
                            よく使うデータ型
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-sm font-medium text-slate-700 font-mono">int / int64</p>
                                <p class="text-sm text-slate-600 mt-1">整数型。個数や年など小数を持たない数値に使う。</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-sm font-medium text-slate-700 font-mono">float / float64</p>
                                <p class="text-sm text-slate-600 mt-1">浮動小数点型。金額や比率など小数を含む数値に使う。</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-sm font-medium text-slate-700 font-mono">str / object</p>
                                <p class="text-sm text-slate-600 mt-1">文字列型。名前やカテゴリなどのテキストデータ。</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-sm font-medium text-slate-700 font-mono">bool</p>
                                <p class="text-sm text-slate-600 mt-1">真偽値型（True/False）。フラグや条件の結果。</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-sm font-medium text-slate-700 font-mono">datetime64</p>
                                <p class="text-sm text-slate-600 mt-1">日時型。日付・時刻データ。pd.to_datetime()で変換。</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-sm font-medium text-slate-700 font-mono">category</p>
                                <p class="text-sm text-slate-600 mt-1">カテゴリ型。種類が限られた文字列に使うとメモリ節約。</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-circle text-orange-600 mt-1"></i>
                            <div>
                                <p class="text-orange-900 font-medium">変換できない場合は errors 引数を使う</p>
                                <p class="text-orange-800 text-sm mt-1">
                                    文字列「abc」をintに変換しようとするとエラーになります。そのような場合は <code class="bg-orange-100 px-1 rounded font-mono">pd.to_numeric(df['列'], errors='coerce')</code> を使うと、変換できない値をNaNに置き換えることができます。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 8.8 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        8.8 異常値の検出と対処
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>異常値（外れ値）</strong>とは、他のデータと比べて極端に大きい・小さい値のことです。入力ミスやシステムエラーが原因の場合もあれば、本物のレアケースの場合もあります。まず「なぜ異常値があるのか」を考えることが重要です。
                    </p>

                    <!-- コードブロック: 異常値検出 -->
                    <div class="code-block-wrapper my-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">異常値の検出方法</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd
import numpy as np

df = pd.DataFrame({
    '年齢': [25, 30, 28, 999, 22, 35, -5, 27]
})

# 方法1: 四分位範囲（IQR）を使う方法
Q1 = df['年齢'].quantile(0.25)   # 第1四分位数
Q3 = df['年齢'].quantile(0.75)   # 第3四分位数
IQR = Q3 - Q1                   # 四分位範囲

lower = Q1 - 1.5 * IQR          # 下限
upper = Q3 + 1.5 * IQR          # 上限

# 異常値の行を取り出す
outliers = df[(df['年齢'] < lower) | (df['年齢'] > upper)]
print(f"異常値:\n{outliers}")

# 方法2: 常識的な範囲でフィルタ（業務知識を使う）
df_clean = df[(df['年齢'] >= 0) & (df['年齢'] <= 120)]
print(f"\nクリーン後:\n{df_clean}")</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-2">出力例</p>
                        <pre class="text-slate-600 text-sm whitespace-pre">異常値:
   年齢
3  999
6   -5

クリーン後:
   年齢
0   25
1   30
2   28
4   22
5   35
7   27</pre>
                    </div>

                    <!-- 異常値の対処方法 -->
                    <div class="bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-200 rounded-xl p-5 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-3 flex items-center gap-2">
                            <i class="fas fa-tools text-primary-500"></i>
                            異常値の対処方法の選択肢
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-xs font-bold text-primary-700">1</span>
                                <div>
                                    <p class="font-medium text-slate-700">削除する</p>
                                    <p class="text-sm text-slate-600">明らかな入力ミスの場合。例：年齢が999歳、負の値</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-xs font-bold text-primary-700">2</span>
                                <div>
                                    <p class="font-medium text-slate-700">NaNに置き換える</p>
                                    <p class="text-sm text-slate-600">値が疑わしい場合。後で fillna() で補完できる</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-xs font-bold text-primary-700">3</span>
                                <div>
                                    <p class="font-medium text-slate-700">上限・下限でクリップする</p>
                                    <p class="text-sm text-slate-600">極端な値を閾値に丸める（df['列'].clip(lower=0, upper=100)）</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="flex-shrink-0 w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-xs font-bold text-primary-700">4</span>
                                <div>
                                    <p class="font-medium text-slate-700">そのまま残す</p>
                                    <p class="text-sm text-slate-600">本物のレアケースの場合。VIP顧客の高額購入など、削除すると分析が歪む</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div>
                                <p class="text-emerald-900 font-medium">前処理の判断は「業務知識」が重要</p>
                                <p class="text-emerald-800 text-sm mt-1">
                                    「年齢が999」は明らかなミスですが、「売上が100倍」は本物の大口取引かもしれません。前処理の判断は統計的な手法だけでなく、業務の文脈を理解した上で行うことが大切です。疑わしいデータは、削除前にデータ担当者に確認する習慣をつけましょう。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 実習カード -->
                <div class="bg-gradient-to-r from-purple-50 to-fuchsia-50 border border-purple-200 rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-code text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-purple-800 mb-3 break-words">
                                実習 8-1: 顧客データのクリーニング
                            </h3>
                            <p class="text-purple-900 mb-4 break-words">
                                欠損値・重複・型の問題を含む顧客データを作成し、本章で学んだ手法を使ってクリーンなデータに仕上げましょう。
                            </p>

                            <h4 class="font-medium text-purple-800 mb-2">手順</h4>
                            <ol class="space-y-3 mb-4">
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">1</span>
                                    <span class="flex-1 min-w-0 break-words">Jupyter Notebookを開き、欠損値・重複行・文字列型の年齢列を含むサンプルDataFrameを作成する</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">2</span>
                                    <span class="flex-1 min-w-0 break-words"><code class="bg-purple-100 px-1 rounded font-mono">isnull().sum()</code> で欠損値の数を確認し、<code class="bg-purple-100 px-1 rounded font-mono">fillna()</code> で中央値を使って補完する</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">3</span>
                                    <span class="flex-1 min-w-0 break-words"><code class="bg-purple-100 px-1 rounded font-mono">duplicated().sum()</code> で重複行数を確認し、<code class="bg-purple-100 px-1 rounded font-mono">drop_duplicates()</code> で削除する</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">4</span>
                                    <span class="flex-1 min-w-0 break-words">文字列の年齢列を <code class="bg-purple-100 px-1 rounded font-mono">astype(int)</code> で整数型に変換し、<code class="bg-purple-100 px-1 rounded font-mono">dtypes</code> で確認する</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">5</span>
                                    <span class="flex-1 min-w-0 break-words">処理前後の <code class="bg-purple-100 px-1 rounded font-mono">shape</code> を比較して、何行削減されたかを確認する</span>
                                </li>
                            </ol>

                            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-lg p-3 mt-2">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-check-circle text-emerald-600 mt-0.5"></i>
                                    <div>
                                        <p class="text-emerald-800 font-medium text-sm">成功の目印</p>
                                        <p class="text-emerald-700 text-sm mt-1">最終的に欠損値0件・重複0件・全列が適切な型になったDataFrameが完成する</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- セクション 8.9 まとめ -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        8.9 この章のまとめ
                    </h2>

                    <div class="bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-200 rounded-xl p-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-flag-checkered text-primary-500"></i>
                            学んだこと
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">isnull() / isna() で欠損値を検出し、sum() や mean() で欠損の規模を把握する</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">dropna() で欠損値のある行・列を削除できる。subset / how / thresh で細かく制御できる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">fillna() で欠損値を固定値・平均値・中央値・前後の値などで補完できる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">duplicated() で重複行を検出し、drop_duplicates() で削除できる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">astype() でデータ型を変換できる。変換失敗時は pd.to_numeric(errors='coerce') を使う</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">異常値はIQR法や業務知識で検出し、削除・補完・クリップのいずれかで対処する</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 理解度確認クイズ -->
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-question text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-blue-800 mb-4 break-words">理解度確認クイズ</h3>
                            <ol class="space-y-5">
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q1. 欠損値を削除するメソッドと補完するメソッドをそれぞれ答えてください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <div class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            <p class="text-sm"><strong>削除</strong>: <code class="bg-blue-200 px-1 rounded font-mono">dropna()</code> - 欠損値を含む行・列を削除します。</p>
                                            <p class="text-sm mt-1"><strong>補完</strong>: <code class="bg-blue-200 px-1 rounded font-mono">fillna()</code> - 欠損値を指定した値（平均値・中央値・固定値など）で埋めます。</p>
                                        </div>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q2. 数値データの欠損値補完に「平均値」よりも「中央値」が適している場合はどのような場合ですか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words text-sm">
                                            データに<strong>外れ値（異常値）がある場合</strong>や<strong>分布が偏っている場合</strong>に中央値が適しています。平均値は外れ値の影響を大きく受けますが（例：年収が1人だけ1億円のデータ）、中央値は影響を受けにくいため、より実態に近い補完ができます。
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q3. <code class="bg-blue-100 px-1 rounded font-mono">drop_duplicates(keep='last')</code> はどのような動作をしますか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words text-sm">
                                            重複した行のうち<strong>最後に出現した行を残し、それ以外の行を削除</strong>します。デフォルトの <code class="bg-blue-200 px-1 rounded font-mono">keep='first'</code> は最初の行を残します。データが時系列順に並んでいて「最新の情報を優先したい」場合に <code class="bg-blue-200 px-1 rounded font-mono">keep='last'</code> が役立ちます。
                                        </p>
                                    </details>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- トラブルシューティング -->
                <div class="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl overflow-hidden mb-8">
                    <div class="bg-orange-100 px-6 py-3 border-b border-orange-200">
                        <h3 class="font-semibold text-orange-800 flex items-center gap-2">
                            <i class="fas fa-tools"></i>
                            よくあるトラブルと解決方法
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <details class="group">
                            <summary class="flex items-center gap-3 cursor-pointer list-none p-3 rounded-lg bg-white border border-orange-200 hover:bg-orange-50 transition-colors">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="font-medium text-orange-800">fillna() で補完したはずなのに NaN が残っている</span>
                                <i class="fas fa-chevron-down ml-auto text-orange-400 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="mt-3 pl-10 text-orange-900 text-sm">
                                <p class="mb-2"><strong>原因:</strong> fillna() は元のDataFrameを変更しない（inplace=False がデフォルト）。返り値を変数に代入していない。</p>
                                <p><strong>解決方法:</strong> <code class="bg-orange-100 px-1 rounded font-mono">df['列'] = df['列'].fillna(値)</code> のように、返り値を変数に代入する。または <code class="bg-orange-100 px-1 rounded font-mono">inplace=True</code> を指定する。</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center gap-3 cursor-pointer list-none p-3 rounded-lg bg-white border border-orange-200 hover:bg-orange-50 transition-colors">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="font-medium text-orange-800">astype(int) でエラー「cannot convert float NaN to integer」</span>
                                <i class="fas fa-chevron-down ml-auto text-orange-400 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="mt-3 pl-10 text-orange-900 text-sm">
                                <p class="mb-2"><strong>原因:</strong> int型はNaNを格納できない。列に欠損値がある状態で astype(int) しようとしている。</p>
                                <p><strong>解決方法:</strong> 先に欠損値を処理（dropna や fillna）してから astype(int) する。または <code class="bg-orange-100 px-1 rounded font-mono">astype('Int64')</code>（大文字のI）を使うと欠損値を保持したまま整数型にできる。</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center gap-3 cursor-pointer list-none p-3 rounded-lg bg-white border border-orange-200 hover:bg-orange-50 transition-colors">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="font-medium text-orange-800">drop_duplicates() でデータが減らない</span>
                                <i class="fas fa-chevron-down ml-auto text-orange-400 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="mt-3 pl-10 text-orange-900 text-sm">
                                <p class="mb-2"><strong>原因:</strong> 目に見えない違い（スペースの有無、大文字/小文字、全角/半角）が含まれている。または返り値を変数に代入していない。</p>
                                <p><strong>解決方法:</strong> 文字列列は先に <code class="bg-orange-100 px-1 rounded font-mono">str.strip()</code> でスペースを除去し、<code class="bg-orange-100 px-1 rounded font-mono">str.lower()</code> で小文字に統一してから drop_duplicates() を実行する。</p>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- 章間ナビゲーション -->
                <nav class="flex items-center justify-between pt-6 mt-6 border-t border-slate-200">
                    <a href="python-data-analysis-learning-material-07.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 transition-colors">
                        <i class="fas fa-arrow-left text-slate-400 group-hover:text-slate-600 transition-transform group-hover:-translate-x-1"></i>
                        <div>
                            <span class="text-xs text-slate-500 block">前の章</span>
                            <span class="text-slate-700 font-medium">データの選択とフィルタリング</span>
                        </div>
                    </a>
                    <a href="python-data-analysis-learning-material-09.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl bg-primary-500 hover:bg-primary-600 text-white transition-colors">
                        <div class="text-right">
                            <span class="text-xs text-primary-100 block">次の章</span>
                            <span class="font-medium">データの変換と加工</span>
                        </div>
                        <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- フッター -->
    <footer class="bg-slate-800 text-slate-300">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <p class="text-sm text-center md:text-left">
                    &copy; 2026 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。
                </p>
                <div class="flex items-center gap-4">
                    <a href="https://github.com/fcircle-biz/tech_docs" class="hover:text-white transition-colors">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- スクロールトップボタン -->
    <button id="scroll-top-btn"
            class="fixed bottom-6 right-6 w-12 h-12 bg-primary-500 text-white rounded-full
                   shadow-lg hover:bg-primary-600 transition-all duration-300
                   opacity-0 invisible translate-y-4"
            onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- サイドバー生成 -->
    <script src="sidebar-content.js"></script>

    <!-- 共通JavaScript -->
    <script src="main.js"></script>

    <!-- 描画ツール -->
    <script src="drawing-tool.js"></script>
</body>
</html>
