<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" id="viewport-meta">
    <title>Pythonデータ分析入門 第9章 - データの変換と加工</title>

    <!-- ダークモード早期適用（フラッシュ防止） -->
    <script>
        (function() {
            const saved = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === 'dark' || (saved === null && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Python - Blue
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts - Noto Sans JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="styles.css">
</head>
<body class="font-sans bg-slate-50 text-slate-800 antialiased">
    <!-- ヘッダー/ナビゲーションバー -->
    <header class="fixed top-0 left-0 right-0 z-50 text-white header-rich header-rich-shadow">
        <nav class="w-full px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="flex items-center justify-between py-3">
                <!-- 左側: ロゴとタイトルセクション -->
                <div class="flex items-center gap-4">
                    <!-- アイコン -->
                    <div class="relative group">
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-400/30 to-orange-400/30 rounded-2xl blur-lg group-hover:blur-xl transition-all"></div>
                        <div class="relative w-14 h-14 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                            <i class="fab fa-python text-3xl icon-rotate-hover drop-shadow-lg"></i>
                        </div>
                    </div>

                    <!-- タイトルとメタ情報 -->
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-bold tracking-wide drop-shadow-md">Pythonデータ分析入門</span>
                            <span class="hidden sm:inline-flex items-center gap-1 px-2 py-0.5 bg-white/20 rounded-md text-[10px] font-semibold uppercase tracking-wider">
                                <i class="fas fa-star text-yellow-300 text-[8px]"></i>
                                初級
                            </span>
                        </div>
                        <div class="flex items-center gap-3 text-[11px] text-white/90 font-medium">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-chart-bar text-[9px]"></i>
                                <span>データ分析</span>
                            </div>
                            <div class="hidden sm:flex items-center gap-1">
                                <i class="fas fa-clock text-[9px]"></i>
                                <span>所要時間 約23時間</span>
                            </div>
                            <div class="hidden lg:flex items-center gap-1">
                                <i class="fas fa-language text-[9px]"></i>
                                <span>日本語</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側: サイドバートグルボタン -->
                <button id="sidebar-toggle-btn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white/20 transition-all active:scale-95" title="サイドバーの表示/非表示">
                    <i class="fas fa-bars text-lg"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- メインレイアウト -->
    <div class="flex min-h-screen pt-20">
        <!-- サイドバーはsidebar-content.jsで動的に生成されます -->

        <!-- メインコンテンツ -->
        <main class="flex-1 min-w-0">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-10 py-6">
                <!-- パンくずリスト -->
                <nav class="flex items-center gap-2 text-sm text-slate-500 mb-6">
                    <a href="https://fcircle-biz.github.io/tech_docs/" class="hover:text-primary-600 transition-colors">ホーム</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <a href="https://fcircle-biz.github.io/tech_docs/guide/programming-languages/python-ecosystem/python-data-analysis/" class="hover:text-primary-600 transition-colors">Pythonデータ分析入門</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-slate-700">第9章</span>
                </nav>

                <!-- 章ヘッダー -->
                <header class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-700">
                            第9章
                        </span>
                        <span class="text-sm text-slate-500">
                            <i class="fas fa-clock mr-1"></i>所要時間: 約1.5時間
                        </span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">
                        データの変換と加工 - 新しい列の作成と文字列操作
                    </h1>
                    <p class="text-slate-600">
                        既存のデータから新しい列を作成したり、文字列データを加工したりする方法を学びます。apply関数やmap関数を使った柔軟なデータ変換技術と、日付・時刻データの扱い方を習得します。
                    </p>
                </header>

                <!-- 学習目標カード -->
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 rounded-xl p-5 mb-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-amber-400 rounded-lg flex items-center justify-center">
                            <i class="fas fa-lightbulb text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-amber-800 mb-3">この章で学ぶこと</h2>
                            <ul class="space-y-2">
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>列の追加・削除・名前変更によるDataFrameの整形</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>apply / map / applymap を使った柔軟なデータ変換</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>str アクセサを使った文字列データの加工</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>to_datetime による日付・時刻データの取り扱い</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>カテゴリ型への変換とメモリ効率の改善</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- セクション 9.1 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        9.1 データ変換・加工とは
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        実際のデータ分析では、読み込んだデータをそのまま使うことはほとんどありません。「売上金額から消費税額を計算して新しい列に追加する」「氏名の列から姓と名を分割する」「文字列の日付を日付型に変換する」といった<strong>データ変換・加工</strong>が必ず必要になります。
                    </p>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        pandasには、こうしたデータ変換を効率よく行うための強力な機能が揃っています。この章では、列の操作から始まり、関数を使った変換、文字列処理、日付処理まで、実務で頻繁に使うテクニックを体系的に学びます。
                    </p>

                    <!-- データ変換の全体像 -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-sitemap text-primary-500"></i>
                            データ変換・加工の主な手法
                        </h3>
                        <div class="mermaid">
flowchart TB
    subgraph Input["元のDataFrame"]
        Raw["生データ（未加工）"]
    end

    subgraph Transform["変換・加工の手法"]
        ColOp["列の追加・削除・名前変更"]
        ApplyMap["apply / map による関数適用"]
        StrOp["str アクセサ（文字列処理）"]
        DateOp["to_datetime（日付処理）"]
        CatOp["カテゴリ型への変換"]
    end

    subgraph Output["加工後のDataFrame"]
        Clean["分析可能なデータ"]
    end

    Raw --> ColOp
    Raw --> ApplyMap
    Raw --> StrOp
    Raw --> DateOp
    Raw --> CatOp
    ColOp --> Clean
    ApplyMap --> Clean
    StrOp --> Clean
    DateOp --> Clean
    CatOp --> Clean

    style Raw fill:#fef3c7,stroke:#f59e0b,color:#92400e
    style Clean fill:#d1fae5,stroke:#10b981,color:#064e3b
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                            <div>
                                <p class="text-blue-900 font-medium">前章との関係</p>
                                <p class="text-blue-800 text-sm mt-1">
                                    第8章では「欠損値・重複の除去」というデータの<strong>削除・補完</strong>を学びました。この章では既存のデータを<strong>変形・拡張</strong>する技術を学びます。前処理と変換・加工を組み合わせることで、質の高い分析用データセットを作り上げることができます。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 9.2 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        9.2 列の追加・削除・名前変更
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        DataFrameの列を操作する基本的な方法から始めましょう。分析に必要な列を追加し、不要な列を削除し、列名をわかりやすく変更する操作は日常的に使います。
                    </p>

                    <h3 class="text-base font-semibold text-slate-700 mb-3">サンプルデータの準備</h3>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">サンプルDataFrame</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd
import numpy as np

# 売上データを作成
df = pd.DataFrame({
    'product':  ['apple', 'banana', 'cherry', 'apple', 'banana'],
    'price':    [150, 80, 200, 150, 80],   # 単価（円）
    'quantity': [10,  20,  5,  15,  30],   # 数量
    'category': ['fruit', 'fruit', 'fruit', 'fruit', 'fruit']
})

print(df)
print(f"\n列の一覧: {list(df.columns)}")</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例</p>
                        <pre class="text-slate-600 text-sm">  product  price  quantity category
0   apple    150        10    fruit
1  banana     80        20    fruit
2  cherry    200         5    fruit
3   apple    150        15    fruit
4  banana     80        30    fruit

列の一覧: ['product', 'price', 'quantity', 'category']</pre>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mb-3">列の追加</h3>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">列の追加</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 売上合計列を追加（price × quantity）
df['total'] = df['price'] * df['quantity']

# 消費税額列を追加（10%）
df['tax'] = df['total'] * 0.1

# 税込価格列を追加
df['total_with_tax'] = df['total'] + df['tax']

print(df)</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例</p>
                        <pre class="text-slate-600 text-sm">  product  price  quantity category  total    tax  total_with_tax
0   apple    150        10    fruit   1500  150.0          1650.0
1  banana     80        20    fruit   1600  160.0          1760.0
2  cherry    200         5    fruit   1000  100.0          1100.0
3   apple    150        15    fruit   2250  225.0          2475.0
4  banana     80        30    fruit   2400  240.0          2640.0</pre>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mb-3">列の削除（drop）</h3>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">列の削除</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 単一の列を削除（axis=1 は列方向）
df_dropped = df.drop('tax', axis=1)

# 複数の列を同時に削除
df_dropped2 = df.drop(['tax', 'category'], axis=1)

# inplace=True で元のDataFrameを直接変更（新変数不要）
df.drop('category', axis=1, inplace=True)

print(df.columns)
# Index(['product', 'price', 'quantity', 'total', 'tax', 'total_with_tax'])</code></pre>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mb-3">列名の変更（rename）</h3>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">列名の変更</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 辞書形式で変更前→変更後を指定
df = df.rename(columns={
    'product':        '商品名',
    'price':          '単価',
    'quantity':       '数量',
    'total':          '売上',
    'total_with_tax': '税込売上'
})

print(df.columns)
# Index(['商品名', '単価', '数量', '売上', 'tax', '税込売上'])</code></pre>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div>
                                <p class="text-emerald-900 font-medium">列名の一括変換</p>
                                <p class="text-emerald-800 text-sm mt-1">
                                    <code class="bg-emerald-100 px-1 rounded font-mono">df.columns = ['新名1', '新名2', ...]</code> のように列名リストを直接代入すると、全列名を一括変更できます。列数が多い場合や規則的な変換（例：全列名を小文字に統一）には <code class="bg-emerald-100 px-1 rounded font-mono">df.columns = [c.lower() for c in df.columns]</code> のようなリスト内包表記も便利です。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 9.3 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        9.3 apply / map による関数適用
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        単純な四則演算以外の複雑な変換には、<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">apply</code> と <code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">map</code> を使います。これらを使うと、自分で定義した関数をDataFrameの各要素や各行・列に適用できます。
                    </p>

                    <!-- apply vs map の比較 -->
                    <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-exchange-alt text-primary-500"></i>
                            apply と map の使い分け
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse">
                                <thead>
                                    <tr class="bg-primary-50">
                                        <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">メソッド</th>
                                        <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">対象</th>
                                        <th class="border border-slate-200 px-4 py-2 text-left text-primary-800 font-semibold">用途</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="hover:bg-slate-50">
                                        <td class="border border-slate-200 px-4 py-2 font-mono text-slate-700">Series.map()</td>
                                        <td class="border border-slate-200 px-4 py-2">Seriesの各要素</td>
                                        <td class="border border-slate-200 px-4 py-2 text-slate-600">値の置き換え・変換（辞書や関数）</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="border border-slate-200 px-4 py-2 font-mono text-slate-700">Series.apply()</td>
                                        <td class="border border-slate-200 px-4 py-2">Seriesの各要素</td>
                                        <td class="border border-slate-200 px-4 py-2 text-slate-600">関数を各要素に適用（複雑な処理向き）</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="border border-slate-200 px-4 py-2 font-mono text-slate-700">DataFrame.apply()</td>
                                        <td class="border border-slate-200 px-4 py-2">各行 または 各列</td>
                                        <td class="border border-slate-200 px-4 py-2 text-slate-600">行/列全体を受け取る複雑な変換</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mb-3">map の使い方</h3>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">Series.map の例</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd

df = pd.DataFrame({
    'product':  ['apple', 'banana', 'cherry'],
    'price':    [150, 80, 200],
    'quantity': [10,  20,  5]
})

# 辞書を使ったマッピング（値を別の値に置き換え）
name_map = {'apple': 'りんご', 'banana': 'バナナ', 'cherry': 'さくらんぼ'}
df['product_jp'] = df['product'].map(name_map)

print(df[['product', 'product_jp']])</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例</p>
                        <pre class="text-slate-600 text-sm">  product product_jp
0   apple      りんご
1  banana      バナナ
2  cherry  さくらんぼ</pre>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mb-3">apply の使い方（Series に適用）</h3>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">Series.apply の例</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 価格に応じてランク付けする関数を定義
def price_rank(price):
    if price >= 200:
        return '高級'
    elif price >= 100:
        return '普通'
    else:
        return '安価'

# apply で各要素に関数を適用
df['rank'] = df['price'].apply(price_rank)

# ラムダ式（lambda）でも書ける
df['rank2'] = df['price'].apply(lambda p: '高' if p >= 150 else '普')

print(df[['product', 'price', 'rank', 'rank2']])</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例</p>
                        <pre class="text-slate-600 text-sm">  product  price  rank rank2
0   apple    150    普通     高
1  banana     80    安価     普
2  cherry    200    高級     高</pre>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mb-3">apply の使い方（DataFrame 行全体に適用）</h3>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">DataFrame.apply（axis=1 で行単位）</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 行全体（複数列）を使って計算する場合は axis=1 を指定
def calc_discount_price(row):
    # 数量が10以上なら5%割引
    if row['quantity'] >= 10:
        return row['price'] * 0.95
    else:
        return row['price']

df['discount_price'] = df.apply(calc_discount_price, axis=1)
print(df[['product', 'price', 'quantity', 'discount_price']])</code></pre>
                    </div>

                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-circle text-orange-600 mt-1"></i>
                            <div>
                                <p class="text-orange-900 font-medium">apply のパフォーマンスに注意</p>
                                <p class="text-orange-800 text-sm mt-1">
                                    <code class="bg-orange-100 px-1 rounded font-mono">apply</code> はPythonのループに近い処理のため、大規模データでは速度が遅くなることがあります。可能であれば <code class="bg-orange-100 px-1 rounded font-mono">df['new'] = df['a'] * df['b']</code> のようなベクトル演算（列全体の計算）を優先しましょう。applyは複雑な条件分岐が必要な場合に使います。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 9.4 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        9.4 文字列操作 - str アクセサ
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        文字列型の列を操作するときは、<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">.str</code> アクセサを使います。Pythonの文字列メソッド（<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">upper()</code>、<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">split()</code> など）の多くがベクトル化された形で使えます。つまり、ループなしで列全体の文字列を一括処理できます。
                    </p>

                    <!-- str アクセサの主なメソッド -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-5">
                            <h4 class="font-bold text-blue-900 mb-3">大文字・小文字変換</h4>
                            <ul class="text-blue-800 text-sm space-y-1">
                                <li><code class="bg-blue-100 px-1 rounded font-mono">.str.upper()</code> - 全て大文字</li>
                                <li><code class="bg-blue-100 px-1 rounded font-mono">.str.lower()</code> - 全て小文字</li>
                                <li><code class="bg-blue-100 px-1 rounded font-mono">.str.title()</code> - 先頭大文字</li>
                            </ul>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-xl p-5">
                            <h4 class="font-bold text-emerald-900 mb-3">空白・整形</h4>
                            <ul class="text-emerald-800 text-sm space-y-1">
                                <li><code class="bg-emerald-100 px-1 rounded font-mono">.str.strip()</code> - 両端の空白除去</li>
                                <li><code class="bg-emerald-100 px-1 rounded font-mono">.str.lstrip()</code> - 左端の空白除去</li>
                                <li><code class="bg-emerald-100 px-1 rounded font-mono">.str.replace(a, b)</code> - 文字置換</li>
                            </ul>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-5">
                            <h4 class="font-bold text-purple-900 mb-3">分割・抽出</h4>
                            <ul class="text-purple-800 text-sm space-y-1">
                                <li><code class="bg-purple-100 px-1 rounded font-mono">.str.split(sep)</code> - 区切り文字で分割</li>
                                <li><code class="bg-purple-100 px-1 rounded font-mono">.str.slice(start, end)</code> - 位置で切り出し</li>
                                <li><code class="bg-purple-100 px-1 rounded font-mono">.str.extract(pattern)</code> - 正規表現で抽出</li>
                            </ul>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-xl p-5">
                            <h4 class="font-bold text-amber-900 mb-3">検索・判定</h4>
                            <ul class="text-amber-800 text-sm space-y-1">
                                <li><code class="bg-amber-100 px-1 rounded font-mono">.str.contains(pat)</code> - 含む？（True/False）</li>
                                <li><code class="bg-amber-100 px-1 rounded font-mono">.str.startswith(s)</code> - 指定文字列で始まる？</li>
                                <li><code class="bg-amber-100 px-1 rounded font-mono">.str.len()</code> - 文字列の長さ</li>
                            </ul>
                        </div>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mb-3">str アクセサの実践例</h3>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">文字列操作の実践例</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd

# 氏名と所属をまとめたデータ
df = pd.DataFrame({
    'name':  ['  Tanaka Taro', 'Suzuki Hanako  ', '  Sato Jiro  '],
    'email': ['tanaka@example.com', 'suzuki@sample.co.jp', 'sato@test.com'],
    'code':  ['A-001-Tokyo', 'B-002-Osaka', 'A-003-Nagoya']
})

# 空白除去と大文字化
df['name_clean'] = df['name'].str.strip().str.title()

# メールアドレスのドメイン部分を抽出
df['domain'] = df['email'].str.split('@').str[1]

# コードから種別（A or B）を取り出す
df['type'] = df['code'].str.slice(0, 1)

# コードから都市名を取り出す（3番目の区切り）
df['city'] = df['code'].str.split('-').str[2]

print(df[['name_clean', 'domain', 'type', 'city']])</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例</p>
                        <pre class="text-slate-600 text-sm">       name_clean               domain type      city
0   Tanaka Taro          example.com    A     Tokyo
1  Suzuki Hanako       sample.co.jp    B     Osaka
2      Sato Jiro           test.com    A   Nagoya</pre>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                            <div>
                                <p class="text-blue-900 font-medium">NaN への対応</p>
                                <p class="text-blue-800 text-sm mt-1">
                                    文字列列に <code class="bg-blue-100 px-1 rounded font-mono">NaN</code>（欠損値）が含まれる場合、<code class="bg-blue-100 px-1 rounded font-mono">.str</code> メソッドは <code class="bg-blue-100 px-1 rounded font-mono">NaN</code> をそのまま <code class="bg-blue-100 px-1 rounded font-mono">NaN</code> として返します（エラーにはなりません）。ただし、<code class="bg-blue-100 px-1 rounded font-mono">na=False</code> オプションを指定すると、欠損値の箇所を <code class="bg-blue-100 px-1 rounded font-mono">False</code> として扱うことができます（例：<code class="bg-blue-100 px-1 rounded font-mono">str.contains('A', na=False)</code>）。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 9.5 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        9.5 日付・時刻データの扱い（to_datetime）
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        CSVから読み込んだ日付は、最初は文字列として扱われます。日付として認識させることで、「月だけ取り出す」「2つの日付の差を計算する」「月ごとに集計する」といった日付特有の操作ができるようになります。
                    </p>

                    <div class="bg-white border border-slate-200 rounded-xl p-6 mb-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-primary-500"></i>
                            日付型変換の流れ
                        </h3>
                        <div class="mermaid">
flowchart LR
    A["文字列\n'2024-01-15'"] -->|"pd.to_datetime()"| B["datetime型\n2024-01-15 00:00:00"]
    B -->|".dt.year"| C["年: 2024"]
    B -->|".dt.month"| D["月: 1"]
    B -->|".dt.day"| E["日: 15"]
    B -->|".dt.day_name()"| F["曜日: Monday"]

    style A fill:#fef3c7,stroke:#f59e0b,color:#92400e
    style B fill:#dbeafe,stroke:#3b82f6,color:#1e40af
    style C fill:#d1fae5,stroke:#10b981,color:#064e3b
    style D fill:#d1fae5,stroke:#10b981,color:#064e3b
    style E fill:#d1fae5,stroke:#10b981,color:#064e3b
    style F fill:#d1fae5,stroke:#10b981,color:#064e3b
                        </div>
                    </div>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">日付変換の基本</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd

# 文字列の日付データ
df = pd.DataFrame({
    'date':    ['2024-01-15', '2024-02-20', '2024-03-05'],
    'sales':   [120, 85, 150]
})

print(f"変換前のデータ型: {df['date'].dtype}")  # object（文字列）

# to_datetime で日付型（datetime64）に変換
df['date'] = pd.to_datetime(df['date'])

print(f"変換後のデータ型: {df['date'].dtype}")  # datetime64[ns]

# dt アクセサで各種要素を取り出す
df['year']     = df['date'].dt.year     # 年
df['month']    = df['date'].dt.month    # 月
df['day']      = df['date'].dt.day      # 日
df['weekday']  = df['date'].dt.day_name()  # 曜日名（英語）

print(df)</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例</p>
                        <pre class="text-slate-600 text-sm">変換前のデータ型: object
変換後のデータ型: datetime64[ns]

        date  sales  year  month  day    weekday
0 2024-01-15    120  2024      1   15     Monday
1 2024-02-20     85  2024      2   20    Tuesday
2 2024-03-05    150  2024      3    5    Tuesday</pre>
                    </div>

                    <h3 class="text-base font-semibold text-slate-700 mb-3">日付の差分計算と書式の柔軟な対応</h3>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">日付の応用操作</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd

# 注文日と納品日のデータ
df = pd.DataFrame({
    'order_date':  ['2024/01/10', '2024/02/15', '2024/03/01'],
    'deliver_date': ['2024/01/17', '2024/02/18', '2024/03/10'],
})

# スラッシュ区切りの日付も自動解析（format指定も可能）
df['order_date']   = pd.to_datetime(df['order_date'])
df['deliver_date'] = pd.to_datetime(df['deliver_date'])

# 差分を計算（Timedelta型が返る）
df['lead_days'] = (df['deliver_date'] - df['order_date']).dt.days

print(df[['order_date', 'deliver_date', 'lead_days']])</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例</p>
                        <pre class="text-slate-600 text-sm">  order_date deliver_date  lead_days
0 2024-01-10   2024-01-17          7
1 2024-02-15   2024-02-18          3
2 2024-03-01   2024-03-10          9</pre>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div>
                                <p class="text-emerald-900 font-medium">read_csv 読み込み時に日付変換</p>
                                <p class="text-emerald-800 text-sm mt-1">
                                    CSVを読み込む際に <code class="bg-emerald-100 px-1 rounded font-mono">parse_dates=['date_column']</code> オプションを指定すると、読み込みと同時に日付変換を行えます。例：<code class="bg-emerald-100 px-1 rounded font-mono">pd.read_csv('data.csv', parse_dates=['date'])</code>
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 9.6 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        9.6 カテゴリ型への変換
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        「東京」「大阪」「名古屋」のような、決まった値の繰り返しで構成される文字列列は、<strong>カテゴリ型</strong>（<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm font-mono">category</code>）に変換することでメモリを大幅に節約できます。また、集計や比較の際に効率が上がります。
                    </p>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">カテゴリ型への変換</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd

df = pd.DataFrame({
    'region':   ['東京', '大阪', '東京', '名古屋', '大阪', '東京'] * 1000,
    'sales':    [100, 200, 150, 80, 120, 180] * 1000
})

# 変換前のメモリ使用量確認
before = df['region'].memory_usage(deep=True)
print(f"変換前: {before:,} bytes")

# astype('category') でカテゴリ型に変換
df['region'] = df['region'].astype('category')

# 変換後のメモリ使用量
after = df['region'].memory_usage(deep=True)
print(f"変換後: {after:,} bytes")
print(f"削減率: {(1 - after/before)*100:.1f}%")

# カテゴリの一覧を確認
print(f"\nカテゴリ: {df['region'].cat.categories.tolist()}")</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例（行数 6000 の場合）</p>
                        <pre class="text-slate-600 text-sm">変換前: 372,128 bytes
変換後:   6,368 bytes
削減率: 98.3%

カテゴリ: ['名古屋', '大阪', '東京']</pre>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                            <div>
                                <p class="text-blue-900 font-medium">カテゴリ型が有効な条件</p>
                                <p class="text-blue-800 text-sm mt-1">
                                    カテゴリ型は「ユニーク値の数が行数に比べて少ない」列に効果的です。たとえば、6000行の中に「東京」「大阪」「名古屋」の3種類しかない場合、文字列を直接保存するよりも整数コード（0, 1, 2）で管理するため、大幅にメモリを節約できます。反対に、ほぼすべての行が異なる値を持つ列（ID、メールアドレス等）には効果がありません。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 9.7 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        9.7 変換・加工の実践的な組み合わせ
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        実務では、これらの変換操作を組み合わせて使います。以下は、社員データを読み込んで複数の変換を順番に適用する実践的な例です。
                    </p>

                    <div class="code-block-wrapper my-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">実践的なデータ変換パイプライン</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd

# 架空の社員データ
raw = pd.DataFrame({
    'full_name':   ['  yamada taro ', 'SUZUKI HANAKO', '  sato jiro  '],
    'hire_date':   ['2020-04-01', '2019-10-15', '2022-07-01'],
    'department':  ['sales', 'engineering', 'sales'],
    'salary':      [350000, 480000, 320000]
})

# ステップ1: 氏名を整形（空白除去 → タイトルケース）
raw['full_name'] = raw['full_name'].str.strip().str.title()

# ステップ2: 入社日を日付型に変換
raw['hire_date'] = pd.to_datetime(raw['hire_date'])

# ステップ3: 勤続年数を計算
today = pd.Timestamp('2026-02-23')
raw['years_service'] = ((today - raw['hire_date']).dt.days / 365).astype(int)

# ステップ4: 部署をカテゴリ型に変換
raw['department'] = raw['department'].astype('category')

# ステップ5: 給与ランクを追加
raw['salary_rank'] = raw['salary'].apply(
    lambda s: '高' if s >= 450000 else ('中' if s >= 380000 else '低')
)

print(raw[['full_name', 'hire_date', 'years_service', 'department', 'salary_rank']])</code></pre>
                    </div>

                    <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-slate-700 text-sm font-medium mb-1">出力例</p>
                        <pre class="text-slate-600 text-sm">       full_name  hire_date  years_service   department salary_rank
0   Yamada Taro 2020-04-01              5        sales          低
1  Suzuki Hanako 2019-10-15             6  engineering          高
2      Sato Jiro 2022-07-01              3        sales          低</pre>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-6 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div>
                                <p class="text-emerald-900 font-medium">処理の順序と一貫性</p>
                                <p class="text-emerald-800 text-sm mt-1">
                                    データ変換は「整形 → 型変換 → 計算 → 分類」の順で行うと整理しやすいです。また、中間結果を<code class="bg-emerald-100 px-1 rounded font-mono">print()</code>で確認しながら進めると、どの段階でエラーが発生したかを特定しやすくなります。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 実習カード -->
                <div class="bg-gradient-to-r from-purple-50 to-fuchsia-50 border border-purple-200 rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-code text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-purple-800 mb-3 break-words">
                                実習 9-1: 商品データの変換と加工
                            </h3>
                            <p class="text-purple-900 mb-4 break-words">
                                以下のデータに対して、この章で学んだ変換操作を組み合わせて適用してみましょう。
                            </p>

                            <div class="code-block-wrapper mb-4">
                                <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                                    <span class="text-slate-400 text-sm">実習用データ</span>
                                    <button class="copy-btn text-slate-400 hover:text-white transition-colors" onclick="copyCode(this)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pandas as pd

df = pd.DataFrame({
    'product':     ['  apple  ', ' BANANA', 'Cherry '],
    'price':       [150, 80, 200],
    'stock':       [50, 120, 30],
    'expire_date': ['2024/03/31', '2024/04/15', '2024/02/28'],
    'category':    ['fruit', 'fruit', 'fruit']
})

# 課題1: product 列の空白を除去し、タイトルケースに変換せよ
# 課題2: expire_date を日付型に変換し、月（month）を取り出せ
# 課題3: price * stock の在庫金額列 total_value を追加せよ
# 課題4: 在庫金額が5000円以上なら「十分」、未満なら「少ない」の stock_status 列を追加せよ
# 課題5: category 列をカテゴリ型に変換せよ</code></pre>
                            </div>

                            <h4 class="font-medium text-purple-800 mb-2">手順</h4>
                            <ol class="space-y-3 mb-4">
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">1</span>
                                    <span class="flex-1 min-w-0 break-words">Jupyter Notebookで上記のデータを作成する</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">2</span>
                                    <span class="flex-1 min-w-0 break-words">各課題に取り組み、変換後のDataFrameを確認する</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">3</span>
                                    <span class="flex-1 min-w-0 break-words"><code class="bg-purple-100 px-1 rounded font-mono">df.dtypes</code> でデータ型が正しく変換されているか確認する</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-sm font-medium">4</span>
                                    <span class="flex-1 min-w-0 break-words">最終的な <code class="bg-purple-100 px-1 rounded font-mono">df</code> を出力して全列を確認する</span>
                                </li>
                            </ol>

                            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-lg p-3 mt-2">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-check-circle text-emerald-600 mt-0.5"></i>
                                    <div>
                                        <p class="text-emerald-800 font-medium text-sm">成功の目印</p>
                                        <p class="text-emerald-700 text-sm mt-1">product 列が「Apple」「Banana」「Cherry」になり、カテゴリ型の変換後に <code class="bg-emerald-100 px-1 rounded font-mono">df['category'].dtype</code> が <code class="bg-emerald-100 px-1 rounded font-mono">category</code> と表示される</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- セクション 9.8 まとめ -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800 border-l-4 border-primary-500 pl-4 mb-4">
                        9.8 この章のまとめ
                    </h2>

                    <div class="bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-200 rounded-xl p-6">
                        <h3 class="text-base font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-flag-checkered text-primary-500"></i>
                            学んだこと
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">新しい列は <code class="bg-slate-100 px-1 rounded font-mono">df['新列名'] = 値</code> で追加し、<code class="bg-slate-100 px-1 rounded font-mono">drop()</code> で削除、<code class="bg-slate-100 px-1 rounded font-mono">rename()</code> で名前変更できる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm"><code class="bg-slate-100 px-1 rounded font-mono">map()</code> は辞書による値の置き換えに、<code class="bg-slate-100 px-1 rounded font-mono">apply()</code> は関数を使った柔軟な変換に使う</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm"><code class="bg-slate-100 px-1 rounded font-mono">.str</code> アクセサで文字列列の空白除去・分割・置換・検索がループなしで行える</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm"><code class="bg-slate-100 px-1 rounded font-mono">pd.to_datetime()</code> で文字列の日付を変換し、<code class="bg-slate-100 px-1 rounded font-mono">.dt</code> アクセサで年・月・日・曜日を取り出せる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">日付型同士の引き算で差分（Timedelta）が求まり、<code class="bg-slate-100 px-1 rounded font-mono">.dt.days</code> で日数に変換できる</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                <span class="text-slate-700 text-sm">繰り返しの多い文字列列は <code class="bg-slate-100 px-1 rounded font-mono">astype('category')</code> でカテゴリ型に変換することでメモリを節約できる</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 理解度確認クイズ -->
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-question text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-blue-800 mb-4 break-words">理解度確認クイズ</h3>
                            <ol class="space-y-5">
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q1. <code class="bg-blue-100 px-1 rounded font-mono">map()</code> と <code class="bg-blue-100 px-1 rounded font-mono">apply()</code> の違いを説明してください。それぞれどのような場面で使いますか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <div class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            <p class="text-sm"><strong>map()</strong> は主に辞書を使った値の置き換えに使います（例：英語の商品名→日本語）。シンプルなマッピングに向いています。<strong>apply()</strong> は自分で定義した関数を各要素に適用するのに使います。if-else のような条件分岐が必要な複雑な変換に向いています。DataFrame に対して <code class="bg-blue-200 px-1 rounded font-mono">axis=1</code> を指定すると、行全体（複数列）を使った計算も可能です。</p>
                                        </div>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q2. 文字列列 <code class="bg-blue-100 px-1 rounded font-mono">df['email']</code> からドメイン部分（@より後ろ）を取り出す方法を書いてください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <div class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            <p class="text-sm"><code class="bg-blue-200 px-1 rounded font-mono">df['email'].str.split('@').str[1]</code> と書きます。<code class="bg-blue-200 px-1 rounded font-mono">str.split('@')</code> で各メールアドレスを @ で分割してリスト化し、<code class="bg-blue-200 px-1 rounded font-mono">str[1]</code> でリストの2番目（インデックス1）の要素を取り出します。</p>
                                        </div>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q3. <code class="bg-blue-100 px-1 rounded font-mono">pd.to_datetime()</code> を使う理由を説明してください。文字列のままではどのような操作ができませんか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words text-sm">
                                            文字列のままでは「月だけ取り出す」「2つの日付の差を計算する」「月別に集計する」などの日付特有の操作ができません。<code class="bg-blue-200 px-1 rounded font-mono">pd.to_datetime()</code> で datetime 型に変換することで、<code class="bg-blue-200 px-1 rounded font-mono">.dt.year</code>・<code class="bg-blue-200 px-1 rounded font-mono">.dt.month</code> などの <code class="bg-blue-200 px-1 rounded font-mono">dt</code> アクセサが使えるようになり、日付計算や集計が可能になります。
                                        </p>
                                    </details>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- トラブルシューティング -->
                <div class="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl overflow-hidden mb-8">
                    <div class="bg-orange-100 px-6 py-3 border-b border-orange-200">
                        <h3 class="font-semibold text-orange-800 flex items-center gap-2">
                            <i class="fas fa-tools"></i>
                            よくあるトラブルと解決方法
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <details class="group">
                            <summary class="flex items-center gap-3 cursor-pointer list-none p-3 rounded-lg bg-white border border-orange-200 hover:bg-orange-50 transition-colors">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="font-medium text-orange-800">AttributeError: Can only use .str accessor with string values!</span>
                                <i class="fas fa-chevron-down ml-auto text-orange-400 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="mt-3 pl-10 text-orange-900 text-sm">
                                <p class="mb-2"><strong>原因:</strong> 文字列型（object）以外の列に <code class="bg-orange-100 px-1 rounded font-mono">.str</code> アクセサを適用しようとしている。数値型（int, float）の列には使えない。</p>
                                <p><strong>解決方法:</strong> 先に <code class="bg-orange-100 px-1 rounded font-mono">df['col'].astype(str)</code> で文字列型に変換してから <code class="bg-orange-100 px-1 rounded font-mono">.str</code> アクセサを使う。または <code class="bg-orange-100 px-1 rounded font-mono">df['col'].dtype</code> でデータ型を確認する。</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center gap-3 cursor-pointer list-none p-3 rounded-lg bg-white border border-orange-200 hover:bg-orange-50 transition-colors">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="font-medium text-orange-800">to_datetime でエラー: "day is out of range for month"</span>
                                <i class="fas fa-chevron-down ml-auto text-orange-400 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="mt-3 pl-10 text-orange-900 text-sm">
                                <p class="mb-2"><strong>原因:</strong> 日付の形式がMM/DD/YYYYのように月日が逆順の場合、自動解析でエラーになることがある。</p>
                                <p><strong>解決方法:</strong> <code class="bg-orange-100 px-1 rounded font-mono">format</code> 引数で書式を明示する。例：<code class="bg-orange-100 px-1 rounded font-mono">pd.to_datetime(df['date'], format='%m/%d/%Y')</code>。エラーを無視したい場合は <code class="bg-orange-100 px-1 rounded font-mono">errors='coerce'</code> を追加すると、変換できない値を NaT にできる。</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center gap-3 cursor-pointer list-none p-3 rounded-lg bg-white border border-orange-200 hover:bg-orange-50 transition-colors">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="font-medium text-orange-800">apply が遅い / 処理に時間がかかる</span>
                                <i class="fas fa-chevron-down ml-auto text-orange-400 transition-transform group-open:rotate-180"></i>
                            </summary>
                            <div class="mt-3 pl-10 text-orange-900 text-sm">
                                <p class="mb-2"><strong>原因:</strong> <code class="bg-orange-100 px-1 rounded font-mono">apply</code> はPythonのループに近い処理のため、大規模データでは時間がかかる。</p>
                                <p><strong>解決方法:</strong> 可能であれば <code class="bg-orange-100 px-1 rounded font-mono">df['a'] + df['b']</code> のようなベクトル演算に書き換える。条件分岐は <code class="bg-orange-100 px-1 rounded font-mono">np.where(条件, 真の値, 偽の値)</code> で置き換えると大幅に高速化できる。</p>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- 章間ナビゲーション -->
                <nav class="flex items-center justify-between pt-6 mt-6 border-t border-slate-200">
                    <a href="python-data-analysis-learning-material-08.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 transition-colors">
                        <i class="fas fa-arrow-left text-slate-400 group-hover:text-slate-600 transition-transform group-hover:-translate-x-1"></i>
                        <div>
                            <span class="text-xs text-slate-500 block">前の章</span>
                            <span class="text-slate-700 font-medium">データの前処理 - 欠損値と重複の処理</span>
                        </div>
                    </a>
                    <a href="python-data-analysis-learning-material-10.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl bg-primary-500 hover:bg-primary-600 text-white transition-colors">
                        <div class="text-right">
                            <span class="text-xs text-primary-100 block">次の章</span>
                            <span class="font-medium">グループ化と集計 - データを要約する力</span>
                        </div>
                        <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- フッター -->
    <footer class="bg-slate-800 text-slate-300">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <p class="text-sm text-center md:text-left">
                    &copy; 2026 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。
                </p>
                <div class="flex items-center gap-4">
                    <a href="https://github.com/fcircle-biz/tech_docs" class="hover:text-white transition-colors">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- スクロールトップボタン -->
    <button id="scroll-top-btn"
            class="fixed bottom-6 right-6 w-12 h-12 bg-primary-500 text-white rounded-full
                   shadow-lg hover:bg-primary-600 transition-all duration-300
                   opacity-0 invisible translate-y-4"
            onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- サイドバー生成 -->
    <script src="sidebar-content.js"></script>

    <!-- 共通JavaScript -->
    <script src="main.js"></script>

    <!-- 描画ツール -->
    <script src="drawing-tool.js"></script>
</body>
</html>
