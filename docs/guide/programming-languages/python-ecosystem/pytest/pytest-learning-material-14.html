<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" id="viewport-meta">
    <title>pytest入門 第14章 - 実践パターン - 実務で使えるテスト設計</title>

    <!-- ダークモード早期適用（フラッシュ防止） -->
    <script>
        (function() {
            const saved = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === 'dark' || (saved === null && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Python - Blue
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts - Noto Sans JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- カスタムスタイル -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="font-sans bg-slate-50 text-slate-800 antialiased">
    <!-- ヘッダー/ナビゲーションバー -->
    <header class="fixed top-0 left-0 right-0 z-50 text-white header-rich header-rich-shadow">
        <nav class="w-full px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="flex items-center justify-between py-3">
                <!-- 左側: ロゴとタイトルセクション -->
                <div class="flex items-center gap-4">
                    <!-- アイコン -->
                    <div class="relative group">
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-400/30 to-orange-400/30 rounded-2xl blur-lg group-hover:blur-xl transition-all"></div>
                        <div class="relative w-14 h-14 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                            <i class="fab fa-python text-3xl icon-rotate-hover drop-shadow-lg"></i>
                        </div>
                    </div>

                    <!-- タイトルとメタ情報 -->
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-bold tracking-wide drop-shadow-md">pytest入門学習教材</span>
                            <span class="hidden sm:inline-flex items-center gap-1 px-2 py-0.5 bg-white/20 rounded-md text-[10px] font-semibold uppercase tracking-wider">
                                <i class="fas fa-star text-yellow-300 text-[8px]"></i>
                                初級
                            </span>
                        </div>
                        <div class="flex items-center gap-3 text-[11px] text-white/90 font-medium">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-vial text-[9px]"></i>
                                <span>プログラミング言語 / テスト</span>
                            </div>
                            <div class="hidden sm:flex items-center gap-1">
                                <i class="fas fa-clock text-[9px]"></i>
                                <span>所要時間 約20時間</span>
                            </div>
                            <div class="hidden lg:flex items-center gap-1">
                                <i class="fas fa-language text-[9px]"></i>
                                <span>日本語</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側: サイドバートグルボタン -->
                <button id="sidebar-toggle-btn" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white/20 transition-all active:scale-95" title="サイドバーの表示/非表示">
                    <i class="fas fa-bars text-lg"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- メインレイアウト -->
    <div class="flex min-h-screen pt-20">
        <!-- サイドバーはsidebar-content.jsで動的に生成されます -->

        <!-- メインコンテンツ -->
        <main class="flex-1 min-w-0">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-10 py-6">
                <!-- パンくずリスト -->
                <nav class="flex items-center gap-2 text-sm text-slate-500 mb-6">
                    <a href="https://fcircle-biz.github.io/tech_docs/" class="hover:text-primary-600 transition-colors">ホーム</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <a href="./README.md" class="hover:text-primary-600 transition-colors">pytest入門</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-slate-700">第14章</span>
                </nav>

                <!-- 章ヘッダー -->
                <header class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                                     bg-primary-100 text-primary-700">
                            第14章
                        </span>
                        <span class="text-sm text-slate-500">
                            <i class="fas fa-clock mr-1"></i>所要時間: 約1時間30分
                        </span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">実践パターン - 実務で使えるテスト設計</h1>
                    <p class="text-slate-600">Arrange-Act-Assert（AAA）パターン、Given-When-Thenパターン、テストの独立性の確保、テストデータの管理、エッジケースの洗い出し方法など、実務で品質の高いテストを書くための設計パターンとベストプラクティスを学びます。</p>
                </header>

                <!-- 学習目標カード -->
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200
                            rounded-xl p-5 mb-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-amber-400 rounded-lg
                                    flex items-center justify-center">
                            <i class="fas fa-lightbulb text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-amber-800 mb-3">この章で学ぶこと</h2>
                            <ul class="space-y-2">
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>Arrange-Act-Assert（AAA）パターンを理解し、読みやすいテストを構造化できる</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>Given-When-Thenパターンを使って、ビジネスロジックに対応したテストを記述できる</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>テストの独立性を保つ重要性を理解し、フィクスチャを活用してテストを分離できる</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>エッジケース・境界値分析の手法を使い、テスト漏れを減らすことができる</span>
                                </li>
                                <li class="flex items-start gap-2 text-amber-900">
                                    <i class="fas fa-check-circle text-amber-500 mt-1 flex-shrink-0"></i>
                                    <span>テスト命名規則、テストデータの管理、テストの保守性向上のベストプラクティスを実践できる</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- セクション 14.1 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.1 良いテストとはどういうテストか
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        ここまでの章でpytestの機能を一通り学んできました。この章では「どう書けばよいテストになるか」という設計の視点を中心に学びます。
                    </p>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        機能的に正しいテストを書いても、読みにくく保守困難なテストでは、チーム開発では意味をなしません。実務で通用するテストを書くためには、設計パターンとベストプラクティスを意識する必要があります。
                    </p>

                    <!-- 良いテストの特性 -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white border border-primary-200 rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 bg-primary-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-eye text-primary-600 text-sm"></i>
                                </div>
                                <h3 class="font-semibold text-slate-800 text-sm">読みやすい（Readable）</h3>
                            </div>
                            <p class="text-xs text-slate-600 leading-relaxed">
                                テストコードを読んだだけで、何をテストしているのかが一目でわかる。命名と構造が明確。
                            </p>
                        </div>
                        <div class="bg-white border border-emerald-200 rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-unlink text-emerald-600 text-sm"></i>
                                </div>
                                <h3 class="font-semibold text-slate-800 text-sm">独立している（Isolated）</h3>
                            </div>
                            <p class="text-xs text-slate-600 leading-relaxed">
                                他のテストの結果や実行順序に依存しない。1件のテストが失敗しても他のテストに影響を与えない。
                            </p>
                        </div>
                        <div class="bg-white border border-purple-200 rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-sync text-purple-600 text-sm"></i>
                                </div>
                                <h3 class="font-semibold text-slate-800 text-sm">繰り返し可能（Repeatable）</h3>
                            </div>
                            <p class="text-xs text-slate-600 leading-relaxed">
                                いつ実行しても同じ結果になる。乱数・現在時刻・ネットワーク等に依存しない安定したテスト。
                            </p>
                        </div>
                        <div class="bg-white border border-orange-200 rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-crosshairs text-orange-600 text-sm"></i>
                                </div>
                                <h3 class="font-semibold text-slate-800 text-sm">焦点が明確（Focused）</h3>
                            </div>
                            <p class="text-xs text-slate-600 leading-relaxed">
                                1つのテストで1つのことだけを検証する。複数の異なる動作を1テストで確認しない。
                            </p>
                        </div>
                        <div class="bg-white border border-cyan-200 rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-bolt text-cyan-600 text-sm"></i>
                                </div>
                                <h3 class="font-semibold text-slate-800 text-sm">高速（Fast）</h3>
                            </div>
                            <p class="text-xs text-slate-600 leading-relaxed">
                                可能な限り高速に実行できる。遅いテストは実行を怠るようになり、フィードバックループが損なわれる。
                            </p>
                        </div>
                        <div class="bg-white border border-rose-200 rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 bg-rose-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-tools text-rose-600 text-sm"></i>
                                </div>
                                <h3 class="font-semibold text-slate-800 text-sm">保守しやすい（Maintainable）</h3>
                            </div>
                            <p class="text-xs text-slate-600 leading-relaxed">
                                プロダクションコードの変更に追従しやすい。DRY原則を意識し、変更箇所を最小限に抑えた設計。
                            </p>
                        </div>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div>
                                <p class="text-emerald-900 font-medium">FIRST原則</p>
                                <p class="text-emerald-800 text-sm mt-1">
                                    良いテストの特性を覚えるための頭文字: <strong>F</strong>ast（高速）、<strong>I</strong>solated（独立）、<strong>R</strong>epeatable（繰り返し可能）、<strong>S</strong>elf-validating（自己検証）、<strong>T</strong>imely（適時）。この原則を意識してテストを設計しましょう。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 14.2 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.2 AAAパターン - テストの構造を統一する
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong class="text-slate-800">Arrange-Act-Assert（AAA）パターン</strong>は、テストを3つのフェーズに分けて構造化する最も広く使われるテスト設計パターンです。チームでの一貫性を保ち、テストの読みやすさを大きく向上させます。
                    </p>

                    <!-- AAAの説明 -->
                    <div class="my-6 p-4 bg-white border border-slate-200 rounded-xl">
                        <h3 class="text-sm font-semibold text-slate-600 mb-4 flex items-center gap-2">
                            <i class="fas fa-diagram-project text-primary-500"></i>
                            AAAパターンの3つのフェーズ
                        </h3>
                        <div class="mermaid">
flowchart LR
    A["Arrange（準備）<br/>テストデータ・前提条件の設定"] --> B["Act（実行）<br/>テスト対象コードの呼び出し"]
    B --> C["Assert（検証）<br/>結果が期待どおりか確認"]

    style A fill:#dbeafe,stroke:#3b82f6
    style B fill:#d1fae5,stroke:#10b981
    style C fill:#fef3c7,stroke:#f59e0b
                        </div>
                    </div>

                    <!-- 悪い例 vs 良い例 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-xs text-slate-500 mb-2 font-medium flex items-center gap-1">
                                <i class="fas fa-times-circle text-red-500"></i>
                                AAAパターンなし（読みにくい）
                            </p>
                            <div class="code-block-wrapper">
                                <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                                    <span class="text-slate-400 text-sm">test_bad_example.py</span>
                                    <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                            onclick="copyCode(this)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <pre class="!mt-0 !rounded-t-none"><code class="language-python">def test_user_can_purchase():
    cart = ShoppingCart()
    item = Product("本", 1500)
    user = User("Alice", balance=5000)
    cart.add(item)
    result = user.purchase(cart)
    assert result.success == True
    assert user.balance == 3500
    assert len(cart.items) == 0</code></pre>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 mb-2 font-medium flex items-center gap-1">
                                <i class="fas fa-check-circle text-emerald-500"></i>
                                AAAパターンあり（読みやすい）
                            </p>
                            <div class="code-block-wrapper">
                                <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                                    <span class="text-slate-400 text-sm">test_good_example.py</span>
                                    <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                            onclick="copyCode(this)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <pre class="!mt-0 !rounded-t-none"><code class="language-python">def test_user_can_purchase():
    # Arrange（準備）
    cart = ShoppingCart()
    item = Product("本", 1500)
    user = User("Alice", balance=5000)
    cart.add(item)

    # Act（実行）
    result = user.purchase(cart)

    # Assert（検証）
    assert result.success == True
    assert user.balance == 3500
    assert len(cart.items) == 0</code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                            <div>
                                <p class="text-blue-900 font-medium">コメントは必須ではない</p>
                                <p class="text-blue-800 text-sm mt-1">
                                    慣れてきたら、空行だけでフェーズを区切るスタイルもよく使われます。チームの規約に合わせて統一することが重要です。コメントは学習段階では「意識を明確にする」効果があります。
                                </p>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-6">Act が複数行になる場合</h3>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        Actフェーズは通常1行に収めることが理想です。複数の操作が必要な場合、それはセットアップ（Arrange）の一部である可能性があります。
                    </p>
                    <div class="code-block-wrapper mb-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">test_aaa_complex.py</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">def test_order_total_after_discount():
    # Arrange: 商品と割引ルールを準備
    items = [
        OrderItem("商品A", price=1000, qty=2),
        OrderItem("商品B", price=500, qty=1),
    ]
    discount_rule = PercentageDiscount(10)  # 10%割引
    order = Order(items, discount_rule)

    # Act: 合計金額を計算（1行に収める）
    total = order.calculate_total()

    # Assert: 期待値と比較（1000*2+500の10%引き = 2250）
    assert total == 2250</code></pre>
                    </div>
                </section>

                <!-- セクション 14.3 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.3 Given-When-Thenパターン - BDDスタイルのテスト
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong class="text-slate-800">Given-When-Then（GWT）パターン</strong>は、AAAパターンを自然言語に近い形で表現したもので、<strong class="text-slate-700">BDD（振る舞い駆動開発）</strong>で使われます。特にビジネスロジックのテストで、非エンジニアにも伝わりやすい記述スタイルです。
                    </p>

                    <!-- GWTとAAAの対応 -->
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-primary-50">
                                    <th class="text-left p-3 border border-primary-200 text-primary-800 font-semibold">AAAパターン</th>
                                    <th class="text-left p-3 border border-primary-200 text-primary-800 font-semibold">Given-When-Thenパターン</th>
                                    <th class="text-left p-3 border border-primary-200 text-primary-800 font-semibold">意味</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white">
                                    <td class="p-3 border border-slate-200 font-mono text-primary-700">Arrange</td>
                                    <td class="p-3 border border-slate-200 font-mono text-emerald-700">Given</td>
                                    <td class="p-3 border border-slate-200 text-slate-600">前提条件・初期状態（〜の状況において）</td>
                                </tr>
                                <tr class="bg-slate-50">
                                    <td class="p-3 border border-slate-200 font-mono text-primary-700">Act</td>
                                    <td class="p-3 border border-slate-200 font-mono text-blue-700">When</td>
                                    <td class="p-3 border border-slate-200 text-slate-600">操作・イベントの発生（〜したとき）</td>
                                </tr>
                                <tr class="bg-white">
                                    <td class="p-3 border border-slate-200 font-mono text-primary-700">Assert</td>
                                    <td class="p-3 border border-slate-200 font-mono text-amber-700">Then</td>
                                    <td class="p-3 border border-slate-200 text-slate-600">期待する結果（〜となること）</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="code-block-wrapper mb-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">test_gwt_example.py（Given-When-Thenの書き方）</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">def test_残高不足のユーザーは購入できない():
    # Given: 残高が足りないユーザーと商品がある
    user = User("Bob", balance=500)
    cart = ShoppingCart()
    cart.add(Product("高級商品", price=1000))

    # When: 購入を試みる
    result = user.purchase(cart)

    # Then: 購入は失敗し、残高は変わらない
    assert result.success == False
    assert result.error == "残高不足"
    assert user.balance == 500  # 変化なし</code></pre>
                    </div>

                    <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-6">テスト名にGWTを反映させる</h3>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        テスト関数名にシナリオを含めることで、テスト失敗時に問題の文脈が一目でわかります。
                    </p>
                    <div class="code-block-wrapper mb-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">命名スタイルの比較</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 悪い例: 何をテストするか不明
def test_purchase():
    ...

# 良い例1: 日本語で状況を説明
def test_残高不足の場合購入が失敗する():
    ...

# 良い例2: 英語でGWTスタイル
def test_given_insufficient_balance_when_purchase_then_fails():
    ...

# 良い例3: should構文（よく使われるスタイル）
def test_purchase_should_fail_when_balance_is_insufficient():
    ...</code></pre>
                    </div>
                </section>

                <!-- セクション 14.4 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.4 テストの独立性 - 他のテストに影響させない
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        テストの独立性は、信頼できるテストスイートを構築するうえで最も重要な原則の一つです。あるテストが別のテストの状態に依存している場合、実行順序によって結果が変わり、バグの特定が困難になります。
                    </p>

                    <h3 class="text-lg font-semibold text-slate-800 mb-3">独立性を損なうアンチパターン</h3>

                    <!-- アンチパターン1: グローバル状態 -->
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-red-600 mt-1"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-red-900 font-medium">アンチパターン: グローバル変数の共有</p>
                                <p class="text-red-800 text-sm mt-1 break-words">
                                    モジュールレベルの変数をテスト間で共有すると、実行順序依存の問題が発生します。
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-xs text-slate-500 mb-2 font-medium flex items-center gap-1">
                                <i class="fas fa-times-circle text-red-500"></i>
                                独立性なし（実行順序依存）
                            </p>
                            <div class="code-block-wrapper">
                                <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                                    <span class="text-slate-400 text-sm">test_not_isolated.py</span>
                                    <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                            onclick="copyCode(this)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <pre class="!mt-0 !rounded-t-none"><code class="language-python">shared_list = []  # グローバル状態

def test_add_item():
    shared_list.append("item1")
    assert len(shared_list) == 1

def test_list_has_two_items():
    # test_add_item が先に実行された場合のみ通過
    shared_list.append("item2")
    assert len(shared_list) == 2  # 危険!</code></pre>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 mb-2 font-medium flex items-center gap-1">
                                <i class="fas fa-check-circle text-emerald-500"></i>
                                フィクスチャで独立性を確保
                            </p>
                            <div class="code-block-wrapper">
                                <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                                    <span class="text-slate-400 text-sm">test_isolated.py</span>
                                    <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                            onclick="copyCode(this)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pytest

@pytest.fixture
def empty_list():
    return []  # 各テストで新しいリストを返す

def test_add_item(empty_list):
    empty_list.append("item1")
    assert len(empty_list) == 1

def test_add_two_items(empty_list):
    empty_list.append("item1")
    empty_list.append("item2")
    assert len(empty_list) == 2</code></pre>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-6">データベースを使うテストの独立性</h3>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        データベースを使うテストでは、各テスト後にデータをリセットすることが独立性の確保に不可欠です。
                    </p>
                    <div class="code-block-wrapper mb-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">conftest.py（DBリセットの例）</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pytest

@pytest.fixture
def db_session():
    """各テストで独立したDBセッションを提供する"""
    session = create_test_session()
    yield session
    # テスト終了後にロールバックしてリセット
    session.rollback()
    session.close()</code></pre>
                    </div>
                </section>

                <!-- セクション 14.5 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.5 テストデータの管理 - どこに何を置くか
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        テストデータの管理方法は、テストスイートが大きくなるにつれて重要になります。適切な管理ができていないと、データの重複や不整合、メンテナンスの困難さが生じます。
                    </p>

                    <!-- テストデータ管理の方法 -->
                    <div class="space-y-4 mb-6">
                        <!-- ファクトリ関数 -->
                        <div class="bg-white border border-slate-200 rounded-xl p-5">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 w-9 h-9 bg-primary-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-industry text-primary-600 text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-slate-800 mb-2">パターン1: ファクトリ関数</h3>
                                    <p class="text-slate-600 text-sm leading-relaxed mb-3">
                                        テストデータを生成するヘルパー関数を作成します。デフォルト値を持ち、必要なフィールドだけオーバーライドできるスタイルが便利です。
                                    </p>
                                    <div class="code-block-wrapper">
                                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                                            <span class="text-slate-400 text-sm">factories.py</span>
                                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                                    onclick="copyCode(this)">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">def make_user(**kwargs):
    """テスト用ユーザーを生成するファクトリ"""
    defaults = {
        "name": "テストユーザー",
        "email": "test@example.com",
        "balance": 10000,
        "is_active": True,
    }
    defaults.update(kwargs)
    return User(**defaults)

# 使い方: 必要な部分だけ変える
def test_inactive_user():
    user = make_user(is_active=False)
    assert user.can_login() == False</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- フィクスチャとファクトリの組み合わせ -->
                        <div class="bg-white border border-slate-200 rounded-xl p-5">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 w-9 h-9 bg-emerald-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-cubes text-emerald-600 text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-slate-800 mb-2">パターン2: ファクトリフィクスチャ</h3>
                                    <p class="text-slate-600 text-sm leading-relaxed mb-3">
                                        フィクスチャがファクトリ関数を返す「ファクトリフィクスチャ」パターンにより、テスト内で柔軟にデータを生成できます。
                                    </p>
                                    <div class="code-block-wrapper">
                                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                                            <span class="text-slate-400 text-sm">conftest.py（ファクトリフィクスチャ）</span>
                                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                                    onclick="copyCode(this)">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">@pytest.fixture
def create_user():
    """フィクスチャがファクトリ関数を返す"""
    def _create(name="Test", balance=1000):
        return User(name=name, balance=balance)
    return _create

# テストで複数のユーザーを柔軟に作れる
def test_transfer(create_user):
    sender = create_user(name="Alice", balance=5000)
    receiver = create_user(name="Bob", balance=1000)
    sender.transfer(2000, receiver)
    assert sender.balance == 3000
    assert receiver.balance == 3000</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-4">テストデータファイルの管理</h3>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        JSONやCSVなどのテストデータファイルを使う場合は、テストコードと同じ階層の専用フォルダに配置します。
                    </p>
                    <div class="bg-slate-100 border border-slate-200 rounded-xl p-6 mb-4">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-folder-tree text-slate-500"></i>
                            テストデータの推奨ディレクトリ構成
                        </h3>
                        <pre class="bg-slate-800 text-slate-100 rounded-lg p-4 text-sm overflow-x-auto"><code>tests/
├── conftest.py
├── fixtures/          ← フィクスチャ定義ファイル
│   └── factories.py
├── data/              ← テストデータファイル
│   ├── sample_users.json
│   └── import_test.csv
├── unit/
│   └── test_user.py
└── integration/
    └── test_purchase.py</code></pre>
                    </div>
                </section>

                <!-- セクション 14.6 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.6 エッジケースの洗い出し - テスト漏れをなくす
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        正常系のテストだけでは不十分です。実際のバグの多くは<strong class="text-slate-700">エッジケース（境界条件・異常入力）</strong>で発生します。体系的にテストケースを洗い出す手法を身につけましょう。
                    </p>

                    <!-- 境界値分析 -->
                    <div class="my-6 p-4 bg-white border border-slate-200 rounded-xl">
                        <h3 class="text-sm font-semibold text-slate-600 mb-3 flex items-center gap-2">
                            <i class="fas fa-diagram-project text-primary-500"></i>
                            境界値分析 - 数値の境界をテストする
                        </h3>
                        <div class="mermaid">
flowchart LR
    A["無効域<br/>（境界未満）"] --> B["境界値<br/>（最小値）"]
    B --> C["有効域<br/>（正常範囲）"]
    C --> D["境界値<br/>（最大値）"]
    D --> E["無効域<br/>（境界超過）"]

    style A fill:#fee2e2,stroke:#ef4444
    style B fill:#fef3c7,stroke:#f59e0b
    style C fill:#d1fae5,stroke:#10b981
    style D fill:#fef3c7,stroke:#f59e0b
    style E fill:#fee2e2,stroke:#ef4444
                        </div>
                        <p class="text-xs text-slate-500 mt-3">
                            <i class="fas fa-info-circle mr-1"></i>
                            境界値そのもの、境界値の1つ外側（境界値-1、境界値+1）を必ずテストします。
                        </p>
                    </div>

                    <div class="code-block-wrapper mb-6">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">test_age_validation.py（境界値分析の例）</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pytest

# 年齢が18以上65以下のときtrueを返す関数
def is_valid_age(age: int) -> bool:
    return 18 <= age <= 65

# --- 境界値テスト ---
@pytest.mark.parametrize("age, expected", [
    (17,  False),  # 最小値の1つ下（無効）
    (18,  True),   # 最小値（有効）
    (19,  True),   # 最小値+1（有効）
    (40,  True),   # 中央値（有効）
    (64,  True),   # 最大値-1（有効）
    (65,  True),   # 最大値（有効）
    (66,  False),  # 最大値の1つ上（無効）
    (0,   False),  # ゼロ（特殊値）
    (-1,  False),  # 負の値（異常値）
])
def test_is_valid_age(age, expected):
    assert is_valid_age(age) == expected</code></pre>
                    </div>

                    <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-6">テストケース洗い出しチェックリスト</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-primary-50 border border-primary-200 rounded-xl p-4">
                            <h4 class="font-semibold text-primary-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-list-check text-primary-600"></i>
                                数値・範囲のチェック項目
                            </h4>
                            <ul class="space-y-2 text-sm text-primary-900">
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                    <span>ゼロ（0）の場合</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                    <span>負の値（-1など）の場合</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                    <span>最小値ちょうど</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                    <span>最大値ちょうど</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                    <span>最小値-1、最大値+1</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-primary-500 mt-1 flex-shrink-0"></i>
                                    <span>非常に大きな値（オーバーフロー）</span>
                                </li>
                            </ul>
                        </div>
                        <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4">
                            <h4 class="font-semibold text-emerald-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-list-check text-emerald-600"></i>
                                文字列・コレクションのチェック項目
                            </h4>
                            <ul class="space-y-2 text-sm text-emerald-900">
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-emerald-500 mt-1 flex-shrink-0"></i>
                                    <span>空文字列 ""</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-emerald-500 mt-1 flex-shrink-0"></i>
                                    <span>None / null</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-emerald-500 mt-1 flex-shrink-0"></i>
                                    <span>空のリスト・空の辞書</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-emerald-500 mt-1 flex-shrink-0"></i>
                                    <span>要素が1件だけのリスト</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-emerald-500 mt-1 flex-shrink-0"></i>
                                    <span>スペースのみの文字列</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i class="fas fa-check text-emerald-500 mt-1 flex-shrink-0"></i>
                                    <span>特殊文字・日本語・絵文字</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- セクション 14.7 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.7 テスト命名のベストプラクティス
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        テスト関数名は、テストが失敗したときに「何が問題か」を即座に伝える最初の手がかりです。良い命名は、ドキュメントとしても機能します。
                    </p>

                    <!-- 命名パターンの比較 -->
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-primary-50">
                                    <th class="text-left p-3 border border-primary-200 text-primary-800 font-semibold">スタイル</th>
                                    <th class="text-left p-3 border border-primary-200 text-primary-800 font-semibold">例</th>
                                    <th class="text-left p-3 border border-primary-200 text-primary-800 font-semibold">特徴</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white">
                                    <td class="p-3 border border-slate-200 font-medium text-slate-700">日本語</td>
                                    <td class="p-3 border border-slate-200 font-mono text-xs text-primary-700">test_残高不足なら購入失敗する</td>
                                    <td class="p-3 border border-slate-200 text-slate-600">最も読みやすい。日本語チームに最適。</td>
                                </tr>
                                <tr class="bg-slate-50">
                                    <td class="p-3 border border-slate-200 font-medium text-slate-700">should構文</td>
                                    <td class="p-3 border border-slate-200 font-mono text-xs text-primary-700">test_should_fail_when_balance_is_low</td>
                                    <td class="p-3 border border-slate-200 text-slate-600">英語圏で広く使われる。期待動作を明確に表現。</td>
                                </tr>
                                <tr class="bg-white">
                                    <td class="p-3 border border-slate-200 font-medium text-slate-700">GWT構文</td>
                                    <td class="p-3 border border-slate-200 font-mono text-xs text-primary-700">test_given_low_balance_when_purchase_then_fails</td>
                                    <td class="p-3 border border-slate-200 text-slate-600">最も情報量が多い。やや長くなる。</td>
                                </tr>
                                <tr class="bg-slate-50">
                                    <td class="p-3 border border-slate-200 font-medium text-slate-700 text-red-700">NG: 何をするか</td>
                                    <td class="p-3 border border-slate-200 font-mono text-xs text-red-600">test_purchase / test_check_balance</td>
                                    <td class="p-3 border border-slate-200 text-red-600">何をテストするのか不明。失敗しても原因が分からない。</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-circle text-orange-600 mt-1"></i>
                            <div>
                                <p class="text-orange-900 font-medium">チーム内で統一することが最重要</p>
                                <p class="text-orange-800 text-sm mt-1">
                                    どの命名スタイルを選ぶかよりも、チーム全体で統一することのほうが重要です。プロジェクト開始時にテスト命名規則をドキュメントに残しておきましょう。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 14.8 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.8 1テスト1アサーション vs 複数アサーション
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        「1テスト1アサーション」原則は、1つのテストに対してassertを1つだけ書くことを推奨します。ただし、現実には柔軟な判断が必要です。
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-white border border-slate-200 rounded-xl p-5">
                            <h3 class="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-times-circle text-red-500"></i>
                                問題: 複数の関心が混在
                            </h3>
                            <div class="code-block-wrapper">
                                <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                                    <span class="text-slate-400 text-sm">複数の関心を1つにまとめた例</span>
                                    <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                            onclick="copyCode(this)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <pre class="!mt-0 !rounded-t-none"><code class="language-python"># 1テストで複数の「関心」を確認
def test_purchase():
    user = make_user(balance=5000)
    cart = make_cart(total=1500)
    result = user.purchase(cart)
    # 購入成功？残高更新？カート空？
    # 失敗時にどれが原因か不明
    assert result.success == True
    assert user.balance == 3500
    assert cart.is_empty() == True</code></pre>
                            </div>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-xl p-5">
                            <h3 class="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                                <i class="fas fa-check-circle text-emerald-500"></i>
                                関心事ごとにテストを分割
                            </h3>
                            <div class="code-block-wrapper">
                                <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                                    <span class="text-slate-400 text-sm">関心事ごとに分割した例</span>
                                    <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                            onclick="copyCode(this)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <pre class="!mt-0 !rounded-t-none"><code class="language-python">def test_purchase_succeeds_with_enough_balance():
    user = make_user(balance=5000)
    result = user.purchase(make_cart(total=1500))
    assert result.success == True

def test_balance_reduced_after_purchase():
    user = make_user(balance=5000)
    user.purchase(make_cart(total=1500))
    assert user.balance == 3500

def test_cart_cleared_after_purchase():
    cart = make_cart(total=1500)
    make_user(balance=5000).purchase(cart)
    assert cart.is_empty() == True</code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                            <div>
                                <p class="text-blue-900 font-medium">例外: 同一オブジェクトの複数属性確認</p>
                                <p class="text-blue-800 text-sm mt-1">
                                    1つのオブジェクトの複数属性を確認する場合は、まとめても問題ありません（例: ユーザーの名前とメールアドレスを一度に確認）。「1テスト1<strong>関心事</strong>」と理解するのが実践的です。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 14.9 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.9 テストの保守性を高めるDRY原則の適用
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        DRY原則（Don't Repeat Yourself）はテストコードにも適用できます。ただし、テストの<strong class="text-slate-700">読みやすさとのバランス</strong>が重要です。テストでは適度な重複が許容される場合があります。
                    </p>

                    <h3 class="text-lg font-semibold text-slate-800 mb-3">テストヘルパーによる共通化</h3>
                    <div class="code-block-wrapper mb-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">test_helpers.py（共通ロジックのヘルパー化）</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pytest

# ヘルパー関数: 購入フローを実行して結果を返す
def do_purchase(balance, price):
    user = User(balance=balance)
    cart = ShoppingCart()
    cart.add(Product("商品", price))
    return user, user.purchase(cart)

def test_purchase_succeeds():
    user, result = do_purchase(balance=5000, price=1500)
    assert result.success == True

def test_purchase_fails_with_low_balance():
    user, result = do_purchase(balance=500, price=1500)
    assert result.success == False

def test_balance_after_purchase():
    user, result = do_purchase(balance=5000, price=1500)
    assert user.balance == 3500</code></pre>
                    </div>

                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 my-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-star text-emerald-600 mt-1"></i>
                            <div>
                                <p class="text-emerald-900 font-medium">DAMP原則: Descriptive And Meaningful Phrases</p>
                                <p class="text-emerald-800 text-sm mt-1">
                                    テストコードではDRYよりも「DAMP（意味が明確で説明的）」を優先する考え方もあります。テストコードは「本番コードと異なり、将来修正するより読まれることが多い」ため、読みやすさのための多少の重複は許容されます。
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- セクション 14.10 -->
                <section class="mb-10">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800
                               border-l-4 border-primary-500 pl-4 mb-4">
                        14.10 実務でのテスト設計フロー
                    </h2>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        実際の開発でテストを設計するときの、実践的な思考プロセスをまとめます。
                    </p>

                    <!-- テスト設計のフロー -->
                    <div class="my-6 p-4 bg-white border border-slate-200 rounded-xl">
                        <h3 class="text-sm font-semibold text-slate-600 mb-3 flex items-center gap-2">
                            <i class="fas fa-diagram-project text-primary-500"></i>
                            テスト設計の思考フロー
                        </h3>
                        <div class="mermaid">
flowchart TD
    A["テスト対象の関数・クラスを選ぶ"] --> B["正常系のシナリオを列挙"]
    B --> C["異常系のシナリオを列挙<br/>（例外・不正入力・境界値）"]
    C --> D["エッジケースを追加<br/>（ゼロ・空・None等）"]
    D --> E["テストを優先度順に並べる<br/>（重要なものから書く）"]
    E --> F["AAAパターンでテストコードを書く"]
    F --> G["テストを実行して確認"]
    G --> H{"全テスト通過?"}
    H -->|"はい"| I["実装コードを検討・リファクタリング"]
    H -->|"いいえ"| J["実装の修正またはテストの見直し"]
    J --> G

    style A fill:#dbeafe,stroke:#3b82f6
    style I fill:#d1fae5,stroke:#10b981
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-6">実務例: 割引計算ロジックのテスト設計</h3>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        「会員ランクに応じて割引率が変わる計算関数」のテストを設計する例を見てみましょう。
                    </p>
                    <div class="code-block-wrapper mb-4">
                        <div class="flex items-center justify-between bg-slate-800 px-4 py-2 rounded-t-lg">
                            <span class="text-slate-400 text-sm">test_discount.py（実務的なテスト設計例）</span>
                            <button class="copy-btn text-slate-400 hover:text-white transition-colors"
                                    onclick="copyCode(this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <pre class="!mt-0 !rounded-t-none"><code class="language-python">import pytest

# テスト対象の仕様:
# - 通常会員: 割引なし
# - シルバー会員: 10%引き
# - ゴールド会員: 20%引き
# - 負の価格は ValueError を発生させる

@pytest.mark.parametrize("rank, price, expected", [
    # 正常系: 各ランクの割引が正しく適用される
    ("normal", 1000, 1000),   # 割引なし
    ("silver", 1000, 900),    # 10%引き
    ("gold",   1000, 800),    # 20%引き
    # エッジケース: ゼロ円
    ("gold", 0, 0),
    # エッジケース: 小数が出る場合（切り捨て）
    ("silver", 1001, 900),
])
def test_calculate_discounted_price(rank, price, expected):
    result = calculate_price(price, member_rank=rank)
    assert result == expected

def test_negative_price_raises_error():
    with pytest.raises(ValueError, match="価格は0以上"):
        calculate_price(-1, member_rank="normal")

def test_unknown_rank_raises_error():
    with pytest.raises(ValueError, match="不明な会員ランク"):
        calculate_price(1000, member_rank="platinum")</code></pre>
                    </div>
                </section>

                <!-- 実習カード -->
                <div class="bg-gradient-to-r from-purple-50 to-fuchsia-50 border border-purple-200
                            rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-purple-500 rounded-lg
                                    flex items-center justify-center">
                            <i class="fas fa-pen text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-purple-800 mb-3 break-words">
                                実習 14-1: AAAパターンでテストを書き直す
                            </h3>
                            <p class="text-purple-900 mb-4 break-words">
                                既存のテストコードをAAAパターンに従って書き直し、可読性を向上させる練習をします。
                            </p>

                            <h4 class="font-medium text-purple-800 mb-2">課題</h4>
                            <ol class="space-y-3 mb-4">
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full
                                                 flex items-center justify-center text-sm font-medium">1</span>
                                    <span class="flex-1 min-w-0 break-words">シンプルな計算クラス（加算・減算・乗算）を実装してください。</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full
                                                 flex items-center justify-center text-sm font-medium">2</span>
                                    <span class="flex-1 min-w-0 break-words">各メソッドに対して、AAAパターン（コメント付き）でテストを書いてください。正常系・異常系・エッジケースを最低2つずつ用意します。</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full
                                                 flex items-center justify-center text-sm font-medium">3</span>
                                    <span class="flex-1 min-w-0 break-words">テスト関数名を「日本語」または「should構文」で統一し、テストの意図が一目でわかるようにしてください。</span>
                                </li>
                                <li class="flex items-start gap-3 text-purple-900">
                                    <span class="flex-shrink-0 w-6 h-6 bg-purple-200 rounded-full
                                                 flex items-center justify-center text-sm font-medium">4</span>
                                    <span class="flex-1 min-w-0 break-words">重複するテストデータの準備はフィクスチャまたはファクトリ関数に抽出してください。</span>
                                </li>
                            </ol>

                            <div class="bg-purple-100 rounded-lg p-4 mt-4">
                                <p class="text-sm text-purple-900 font-medium mb-2">
                                    <i class="fas fa-lightbulb text-purple-600 mr-2"></i>ヒント
                                </p>
                                <ul class="text-sm text-purple-800 space-y-1">
                                    <li>• ゼロ除算、Noneの入力、非常に大きな数値もエッジケースとして考慮する</li>
                                    <li>• フィクスチャは conftest.py に置くとテストファイル全体で共有できる</li>
                                    <li>• <code class="bg-purple-200 px-1 rounded">pytest -v</code> でテスト名を確認しながら進めると良い</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 章まとめ -->
                <div class="bg-gradient-to-r from-slate-50 to-primary-50 border border-slate-200 rounded-xl p-6 my-8">
                    <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-flag-checkered text-primary-500"></i>
                        第14章のまとめ
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-sm font-semibold text-slate-700 mb-2">学んだこと</h3>
                            <ul class="space-y-2">
                                <li class="flex items-start gap-2 text-sm text-slate-600">
                                    <i class="fas fa-check-circle text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                    <span>良いテストの条件: FIRST原則（高速・独立・繰り返し可能・自己検証・適時）</span>
                                </li>
                                <li class="flex items-start gap-2 text-sm text-slate-600">
                                    <i class="fas fa-check-circle text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                    <span>AAAパターン: Arrange（準備）→ Act（実行）→ Assert（検証）でテストを構造化する</span>
                                </li>
                                <li class="flex items-start gap-2 text-sm text-slate-600">
                                    <i class="fas fa-check-circle text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                    <span>Given-When-Then: BDDスタイルで「シナリオ」として自然言語に近い表現</span>
                                </li>
                                <li class="flex items-start gap-2 text-sm text-slate-600">
                                    <i class="fas fa-check-circle text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                    <span>テストの独立性: フィクスチャで各テストが他のテストに依存しないよう設計する</span>
                                </li>
                                <li class="flex items-start gap-2 text-sm text-slate-600">
                                    <i class="fas fa-check-circle text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                    <span>エッジケース: 境界値・ゼロ・None・空文字列をチェックリストで体系的に洗い出す</span>
                                </li>
                                <li class="flex items-start gap-2 text-sm text-slate-600">
                                    <i class="fas fa-check-circle text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                    <span>テスト命名: 「何をテストするか」が伝わる関数名でドキュメントとして機能させる</span>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-slate-700 mb-2">次章の予告</h3>
                            <div class="bg-white border border-primary-200 rounded-lg p-4">
                                <p class="text-sm text-slate-600 leading-relaxed">
                                    第15章では、これまで学んだpytestの知識を実際のCI/CDパイプラインに組み込む方法を学びます。GitHub Actionsを使ったプッシュ時の自動テスト実行や、カバレッジレポートの自動生成を設定します。
                                </p>
                                <p class="text-xs text-primary-600 mt-2">
                                    <i class="fas fa-arrow-right mr-1"></i>第15章: CI/CDとの連携 - テスト自動化の仕組みを作る
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 理解度確認クイズ -->
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200
                            rounded-xl p-5 my-8 overflow-hidden">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-lg
                                    flex items-center justify-center">
                            <i class="fas fa-question text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold text-blue-800 mb-4 break-words">理解度確認クイズ</h3>
                            <ol class="space-y-6">
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q1. AAAパターンの3つのフェーズを日本語で答えてください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            <strong>Arrange（準備）</strong>: テストデータと前提条件の設定、<strong>Act（実行）</strong>: テスト対象コードの呼び出し、<strong>Assert（検証）</strong>: 実際の結果が期待値と一致するかの確認、の3つです。
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q2. テストの独立性とは何か、独立性がないとどのような問題が起きますか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            テストの独立性とは、各テストが他のテストの結果や実行順序に依存しないことです。独立性がないと、テストの実行順序によって結果が変わり（フラッキーテスト）、バグの原因特定が困難になります。また、並列実行も難しくなります。
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q3. 境界値分析において、「18以上65以下」を検証する関数のテストケースを最低5つ挙げてください。</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            代表的な5つ: <strong>17</strong>（最小値-1、無効）、<strong>18</strong>（最小値、有効）、<strong>40</strong>（中央値、有効）、<strong>65</strong>（最大値、有効）、<strong>66</strong>（最大値+1、無効）。追加で0（ゼロ）、-1（負の値）なども重要なエッジケースです。
                                        </p>
                                    </details>
                                </li>
                                <li class="text-blue-900">
                                    <p class="font-medium mb-2 break-words">Q4. AAAパターンとGiven-When-Thenパターンの違いは何ですか？</p>
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-blue-600 hover:text-blue-700 break-words">
                                            回答を表示
                                        </summary>
                                        <p class="mt-2 pl-4 text-blue-800 bg-blue-100 rounded-lg p-3 break-words">
                                            両者は本質的に同じ3フェーズ構造（準備・実行・検証）を持ちますが、表現スタイルが異なります。AAAは技術的・コード指向の表現、Given-When-Thenは自然言語に近い「シナリオ」スタイルで、BDD（振る舞い駆動開発）で使われます。GWTはビジネスロジックのテストに特に適しており、非エンジニアにも伝わりやすいのが特徴です。
                                        </p>
                                    </details>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 章間ナビゲーション -->
                <nav class="flex items-center justify-between pt-6 mt-6 border-t border-slate-200">
                    <a href="pytest-learning-material-13.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl
                              bg-slate-100 hover:bg-slate-200 transition-colors">
                        <i class="fas fa-arrow-left text-slate-400 group-hover:text-slate-600 transition-transform group-hover:-translate-x-1"></i>
                        <div>
                            <span class="text-xs text-slate-500 block">前の章</span>
                            <span class="text-slate-700 font-medium">設定ファイルとカスタマイズ</span>
                        </div>
                    </a>
                    <a href="pytest-learning-material-15.html"
                       class="group flex items-center gap-3 px-4 py-3 rounded-xl
                              bg-primary-500 hover:bg-primary-600 text-white transition-colors">
                        <div class="text-right">
                            <span class="text-xs text-primary-100 block">次の章</span>
                            <span class="font-medium">CI/CDとの連携</span>
                        </div>
                        <i class="fas fa-arrow-right transition-transform group-hover:translate-x-1"></i>
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- フッター -->
    <footer class="bg-slate-800 text-slate-300">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <p class="text-sm text-center md:text-left">
                    &copy; 2026 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。
                </p>
                <div class="flex items-center gap-4">
                    <a href="https://github.com/fcircle-biz/tech_docs" class="hover:text-white transition-colors">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- スクロールトップボタン -->
    <button id="scroll-top-btn"
            class="fixed bottom-6 right-6 w-12 h-12 bg-primary-500 text-white rounded-full
                   shadow-lg hover:bg-primary-600 transition-all duration-300
                   opacity-0 invisible translate-y-4"
            onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- サイドバー生成 -->
    <script src="sidebar-content.js"></script>

    <!-- 共通JavaScript -->
    <script src="main.js"></script>

    <!-- 描画ツール -->
    <script src="drawing-tool.js"></script>
</body>
</html>
