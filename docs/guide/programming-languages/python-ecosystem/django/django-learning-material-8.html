<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django学習教材 第8章 - テストとデバッグ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #2e7d32;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        /* タイトル */
        .chapter-title {
            color: #2e7d32;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d32;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #388e3c;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d32;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #2e7d32 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>Django学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-1.html">
                                第1章: Django入門と環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-2.html">
                                第2章: モデルとデータベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-3.html">
                                第3章: ビューとURLルーティング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-4.html">
                                第4章: テンプレートとフロントエンド統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-5.html">
                                第5章: フォームとユーザー入力処理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-6.html">
                                第6章: 認証とユーザー管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-7.html">
                                第7章: Django REST Framework入門
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="django-learning-material-8.html">
                                第8章: テストとデバッグ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-9.html">
                                第9章: デプロイメントと本番環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-10.html">
                                第10章: 高度な機能と最適化
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第8章: テストとデバッグ</h1>
                </div>

                <div id="chapter8">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">品質保証とデバッグによる堅牢なアプリケーション開発</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Django TestCaseクラスを使用したユニットテスト</li>
                            <li>モデル、ビュー、フォームの効果的なテスト手法</li>
                            <li>テストデータベースとFixtureの活用</li>
                            <li>Django Debug Toolbarによる開発効率向上</li>
                            <li>ログ設定とエラー処理のベストプラクティス</li>
                            <li>テストカバレッジ測定と品質向上</li>
                        </ul>
                    </div>

                    <!-- セクション1: テストの基礎概念 -->
                    <h3 class="section-title">8.1 Djangoテストフレームワークの基礎</h3>
                    
                    <p>テストは、アプリケーションの品質を保証し、バグを事前に発見するための重要な開発手法です。Djangoでは、Pythonの標準的なunittestモジュールを拡張したテストフレームワークが提供されており、Webアプリケーション特有のテストを効率的に実装できます。</p>

                    <h4>テストの種類と目的</h4>
                    <div class="mermaid">
                        graph TD
                            A[テストの種類] --> B[ユニットテスト]
                            A --> C[統合テスト]
                            A --> D[機能テスト]
                            A --> E[パフォーマンステスト]
                            
                            B --> B1[個別の機能・メソッドを検証<br/>高速実行、早期バグ発見]
                            C --> C1[複数コンポーネントの連携を検証<br/>システム全体の動作確認]
                            D --> D2[ユーザーの使用シナリオを検証<br/>実際の使用感の確認]
                            E --> E1[レスポンス時間・負荷耐性を検証<br/>本番環境での性能確認]
                    </div>

                    <h4>Djangoテストの実行環境</h4>
                    <p>Djangoテストは、本番環境と分離された専用のテストデータベースで実行されます。これにより、テスト実行時に本番データが影響を受けることはありません。</p>

                    <div class="mermaid">
                        sequenceDiagram
                            participant Test as テストランナー
                            participant DB as テストデータベース
                            participant App as Djangoアプリ
                            participant Model as モデル

                            Test->>DB: テストデータベース作成
                            Test->>DB: マイグレーション実行
                            loop 各テストケース
                                Test->>DB: トランザクション開始
                                Test->>App: テストケース実行
                                App->>Model: データ操作
                                Model->>DB: データ保存
                                Test->>DB: アサーション実行
                                Test->>DB: ロールバック（クリーンアップ）
                            end
                            Test->>DB: テストデータベース削除
                    </div>

                    <pre class="code-block"><code class="language-python"># テスト実行コマンドの基本
# 全テスト実行
python manage.py test

# 特定のアプリのテスト実行
python manage.py test myapp

# 特定のテストクラス実行
python manage.py test myapp.tests.ModelTestCase

# 特定のテストメソッド実行
python manage.py test myapp.tests.ModelTestCase.test_string_representation

# 詳細出力でテスト実行
python manage.py test --verbosity=2

# テストデータベース保持（デバッグ用）
python manage.py test --keepdb

# 並列テスト実行（高速化）
python manage.py test --parallel</code></pre>

                    <!-- セクション2: モデルテスト -->
                    <h3 class="section-title">8.2 モデルテストの実装</h3>
                    
                    <p>モデルテストは、データベースの制約、メソッドの動作、バリデーションルールが正しく機能することを確認します。ビジネスロジックの核心部分をテストするため、最も重要なテストの一つです。</p>

                    <pre class="code-block"><code class="language-python"># tests/test_models.py
from django.test import TestCase
from django.contrib.auth.models import User
from django.core.exceptions import ValidationError
from django.db import IntegrityError
from blog.models import Article, Category, Tag

class CategoryModelTest(TestCase):
    """カテゴリモデルのテスト"""
    
    def setUp(self):
        """各テストメソッド実行前に呼ばれる準備処理"""
        self.category = Category.objects.create(
            name='テクノロジー',
            description='技術系の記事カテゴリ'
        )
    
    def test_string_representation(self):
        """文字列表現のテスト"""
        self.assertEqual(str(self.category), 'テクノロジー')
    
    def test_verbose_name(self):
        """メタ情報のテスト"""
        self.assertEqual(Category._meta.verbose_name, 'カテゴリ')
        self.assertEqual(Category._meta.verbose_name_plural, 'カテゴリ一覧')
    
    def test_name_max_length(self):
        """フィールド制約のテスト"""
        max_length = Category._meta.get_field('name').max_length
        self.assertEqual(max_length, 100)
    
    def test_name_unique_constraint(self):
        """ユニーク制約のテスト"""
        with self.assertRaises(IntegrityError):
            Category.objects.create(name='テクノロジー')  # 重複作成

class ArticleModelTest(TestCase):
    """記事モデルのテスト"""
    
    @classmethod
    def setUpClass(cls):
        """テストクラス全体の前処理"""
        super().setUpClass()
        cls.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            password='testpass123'
        )
        cls.category = Category.objects.create(
            name='テスト',
            description='テスト用カテゴリ'
        )
    
    def setUp(self):
        """各テストメソッド前の準備"""
        self.article = Article.objects.create(
            title='テスト記事',
            content='これはテスト用の記事です。',
            author=self.user,
            category=self.category
        )
    
    def test_article_creation(self):
        """記事作成のテスト"""
        self.assertEqual(self.article.title, 'テスト記事')
        self.assertEqual(self.article.author, self.user)
        self.assertEqual(self.article.category, self.category)
        self.assertFalse(self.article.is_published)  # デフォルト値
    
    def test_slug_generation(self):
        """スラッグ自動生成のテスト"""
        article = Article.objects.create(
            title='Django Test Article',
            content='Test content',
            author=self.user,
            category=self.category
        )
        self.assertEqual(article.slug, 'django-test-article')
    
    def test_get_absolute_url(self):
        """URL生成メソッドのテスト"""
        expected_url = f'/articles/{self.article.slug}/'
        self.assertEqual(self.article.get_absolute_url(), expected_url)
    
    def test_article_ordering(self):
        """順序付けのテスト"""
        article2 = Article.objects.create(
            title='新しい記事',
            content='内容',
            author=self.user,
            category=self.category
        )
        articles = Article.objects.all()
        self.assertEqual(articles[0], article2)  # 新しい記事が最初
        self.assertEqual(articles[1], self.article)
    
    def test_published_manager(self):
        """カスタムマネージャーのテスト"""
        # 公開記事と非公開記事を作成
        published_article = Article.objects.create(
            title='公開記事',
            content='内容',
            author=self.user,
            category=self.category,
            is_published=True
        )
        
        # 公開記事のみ取得できることを確認
        published_articles = Article.published.all()
        self.assertIn(published_article, published_articles)
        self.assertNotIn(self.article, published_articles)  # 非公開記事は含まれない
    
    def test_title_validation(self):
        """カスタムバリデーションのテスト"""
        article = Article(
            title='短',  # 5文字未満
            content='内容',
            author=self.user,
            category=self.category
        )
        with self.assertRaises(ValidationError):
            article.full_clean()  # バリデーション実行
    
    def tearDown(self):
        """各テストメソッド後のクリーンアップ"""
        # TestCaseでは自動的にロールバックされるため、通常は不要
        pass</code></pre>

                    <!-- セクション3: ビューテスト -->
                    <h3 class="section-title">8.3 ビューテストの実装</h3>
                    
                    <p>ビューテストは、HTTPリクエスト・レスポンスの処理、認証・認可、テンプレートレンダリングが正しく動作することを確認します。Webアプリケーションの使用感を直接テストできる重要な手法です。</p>

                    <pre class="code-block"><code class="language-python"># tests/test_views.py
from django.test import TestCase, Client
from django.urls import reverse
from django.contrib.auth.models import User
from django.http import Http404
from blog.models import Article, Category

class ArticleViewTest(TestCase):
    """記事ビューのテスト"""
    
    def setUp(self):
        """テスト用データの準備"""
        self.client = Client()
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123',
            email='test@example.com'
        )
        self.category = Category.objects.create(
            name='テスト',
            description='テスト用'
        )
        self.article = Article.objects.create(
            title='テスト記事',
            content='テスト内容です。' * 20,  # 長めのコンテンツ
            author=self.user,
            category=self.category,
            is_published=True
        )
    
    def test_article_list_view(self):
        """記事一覧ビューのテスト"""
        url = reverse('article_list')
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, self.article.title)
        self.assertContains(response, self.user.username)
        self.assertEqual(len(response.context['articles']), 1)
    
    def test_article_list_view_only_published(self):
        """公開記事のみ表示されることを確認"""
        # 非公開記事を作成
        unpublished = Article.objects.create(
            title='非公開記事',
            content='内容',
            author=self.user,
            category=self.category,
            is_published=False
        )
        
        url = reverse('article_list')
        response = self.client.get(url)
        
        self.assertContains(response, self.article.title)
        self.assertNotContains(response, unpublished.title)
    
    def test_article_detail_view(self):
        """記事詳細ビューのテスト"""
        url = reverse('article_detail', kwargs={'slug': self.article.slug})
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.context['article'], self.article)
        self.assertContains(response, self.article.title)
        self.assertContains(response, self.article.content)
    
    def test_article_detail_view_404(self):
        """存在しない記事への404レスポンステスト"""
        url = reverse('article_detail', kwargs={'slug': 'nonexistent'})
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 404)
    
    def test_article_create_view_anonymous(self):
        """未認証ユーザーの記事作成テスト"""
        url = reverse('article_create')
        response = self.client.get(url)
        
        # ログインページにリダイレクトされることを確認
        self.assertEqual(response.status_code, 302)
        self.assertRedirects(response, '/accounts/login/?next=' + url)
    
    def test_article_create_view_authenticated(self):
        """認証済みユーザーの記事作成テスト"""
        self.client.login(username='testuser', password='testpass123')
        
        url = reverse('article_create')
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'form')
    
    def test_article_create_post(self):
        """記事作成POSTリクエストのテスト"""
        self.client.login(username='testuser', password='testpass123')
        
        url = reverse('article_create')
        data = {
            'title': '新しい記事',
            'content': '新しい記事の内容です。',
            'category': self.category.id,
        }
        response = self.client.post(url, data)
        
        # 記事が作成されたことを確認
        self.assertTrue(Article.objects.filter(title='新しい記事').exists())
        article = Article.objects.get(title='新しい記事')
        
        # 作成者が正しく設定されていることを確認
        self.assertEqual(article.author, self.user)
        
        # 成功後のリダイレクトを確認
        self.assertRedirects(response, article.get_absolute_url())
    
    def test_article_create_post_invalid_data(self):
        """無効なデータでの記事作成テスト"""
        self.client.login(username='testuser', password='testpass123')
        
        url = reverse('article_create')
        data = {
            'title': '',  # 必須フィールドが空
            'content': '内容',
            'category': self.category.id,
        }
        response = self.client.post(url, data)
        
        # フォームエラーが表示されることを確認
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'このフィールドは必須です')
        
        # 記事が作成されていないことを確認
        self.assertFalse(Article.objects.filter(content='内容').exists())

class ArticlePermissionTest(TestCase):
    """記事の権限テスト"""
    
    def setUp(self):
        self.user1 = User.objects.create_user('user1', 'user1@test.com', 'pass')
        self.user2 = User.objects.create_user('user2', 'user2@test.com', 'pass')
        self.category = Category.objects.create(name='テスト')
        self.article = Article.objects.create(
            title='User1の記事',
            content='内容',
            author=self.user1,
            category=self.category
        )
    
    def test_author_can_edit(self):
        """作成者は編集可能"""
        self.client.login(username='user1', password='pass')
        url = reverse('article_edit', kwargs={'slug': self.article.slug})
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 200)
    
    def test_non_author_cannot_edit(self):
        """作成者以外は編集不可"""
        self.client.login(username='user2', password='pass')
        url = reverse('article_edit', kwargs={'slug': self.article.slug})
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 403)  # Forbidden</code></pre>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 8-1: 包括的なテストスイートの作成</h5>
                        <p>この実習では、ブログアプリケーションの主要機能に対する包括的なテストスイートを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>モデルテスト：全モデルの基本機能とバリデーションをテストする</li>
                            <li>ビューテスト：全ビューの認証・認可・レスポンスをテストする</li>
                            <li>フォームテスト：フォームバリデーションとデータ処理をテストする</li>
                            <li>テストデータ作成：ファクトリーパターンを使用してテストデータを効率化する</li>
                            <li>テストカバレッジ測定：カバレッジツールを使用してテスト網羅率を確認する</li>
                        </ol>

                        <h6>フォームテストの実装例</h6>
                        <pre class="code-block"><code class="language-python"># tests/test_forms.py
from django.test import TestCase
from django.contrib.auth.models import User
from blog.forms import ArticleForm, CommentForm
from blog.models import Category

class ArticleFormTest(TestCase):
    """記事フォームのテスト"""
    
    def setUp(self):
        self.user = User.objects.create_user('testuser', 'test@test.com', 'pass')
        self.category = Category.objects.create(name='テスト')
    
    def test_valid_form(self):
        """有効なフォームデータのテスト"""
        form_data = {
            'title': '有効なタイトル',
            'content': '有効なコンテンツです。',
            'category': self.category.id,
        }
        form = ArticleForm(data=form_data)
        
        self.assertTrue(form.is_valid())
    
    def test_form_save(self):
        """フォーム保存のテスト"""
        form_data = {
            'title': '保存テスト',
            'content': 'コンテンツ',
            'category': self.category.id,
        }
        form = ArticleForm(data=form_data)
        
        if form.is_valid():
            article = form.save(commit=False)
            article.author = self.user
            article.save()
            
            self.assertEqual(article.title, '保存テスト')
            self.assertEqual(article.author, self.user)
    
    def test_invalid_title_length(self):
        """タイトル長さバリデーションテスト"""
        form_data = {
            'title': '短',  # 5文字未満
            'content': 'コンテンツ',
            'category': self.category.id,
        }
        form = ArticleForm(data=form_data)
        
        self.assertFalse(form.is_valid())
        self.assertIn('title', form.errors)</code></pre>

                        <h6>期待される結果</h6>
                        <p>全テストが成功し、アプリケーションの主要機能が正しく動作することが確認できること。</p>
                    </div>

                    <!-- セクション4: Django Debug Toolbar -->
                    <h3 class="section-title">8.4 Django Debug Toolbarによる開発効率向上</h3>
                    
                    <p>Django Debug Toolbarは、開発時のデバッグとパフォーマンス分析を支援する強力なツールです。SQLクエリ、テンプレート処理時間、キャッシュ使用状況等を可視化し、ボトルネックの特定を容易にします。</p>

                    <pre class="code-block"><code class="language-python"># Django Debug Toolbarのインストールと設定
# pip install django-debug-toolbar

# settings.py
INSTALLED_APPS = [
    # ...
    'debug_toolbar',
]

MIDDLEWARE = [
    'debug_toolbar.middleware.DebugToolbarMiddleware',
    # 他のミドルウェア...
]

# デバッグツールバーを表示するIPアドレス
INTERNAL_IPS = [
    '127.0.0.1',
    'localhost',
]

# デバッグツールバーの設定
DEBUG_TOOLBAR_CONFIG = {
    'SHOW_TOOLBAR_CALLBACK': lambda request: DEBUG,
    'SHOW_TEMPLATE_CONTEXT': True,
    'ENABLE_STACKTRACES': True,
}

# パフォーマンス分析パネルの追加
DEBUG_TOOLBAR_PANELS = [
    'debug_toolbar.panels.versions.VersionsPanel',
    'debug_toolbar.panels.timer.TimerPanel',
    'debug_toolbar.panels.settings.SettingsPanel',
    'debug_toolbar.panels.headers.HeadersPanel',
    'debug_toolbar.panels.request.RequestPanel',
    'debug_toolbar.panels.sql.SQLPanel',
    'debug_toolbar.panels.staticfiles.StaticFilesPanel',
    'debug_toolbar.panels.templates.TemplatesPanel',
    'debug_toolbar.panels.cache.CachePanel',
    'debug_toolbar.panels.signals.SignalsPanel',
    'debug_toolbar.panels.logging.LoggingPanel',
    'debug_toolbar.panels.redirects.RedirectsPanel',
    'debug_toolbar.panels.profiling.ProfilingPanel',
]

# urls.py (開発環境のみ)
from django.conf import settings
from django.conf.urls import include

if settings.DEBUG:
    import debug_toolbar
    urlpatterns = [
        path('__debug__/', include(debug_toolbar.urls)),
    ] + urlpatterns</code></pre>

                    <h4>Debug Toolbarの主要パネル</h4>
                    <div class="mermaid">
                        graph TD
                            A[Debug Toolbar] --> B[SQLPanel]
                            A --> C[TimerPanel]
                            A --> D[TemplatesPanel]
                            A --> E[CachePanel]
                            A --> F[ProfilingPanel]
                            
                            B --> B1[SQLクエリ数と実行時間<br/>N+1問題の発見]
                            C --> C1[ページ生成時間<br/>レスポンス時間の分析]
                            D --> D1[使用テンプレート<br/>コンテキスト変数の確認]
                            E --> E1[キャッシュヒット率<br/>キャッシュ効率の監視]
                            F --> F1[関数別実行時間<br/>ボトルネック箇所の特定]
                    </div>

                    <!-- セクション5: ログ設定とエラー処理 -->
                    <h3 class="section-title">8.5 ログ設定とエラー処理</h3>
                    
                    <p>適切なログ設定は、アプリケーションの動作状況を把握し、問題の早期発見・解決に不可欠です。Djangoでは、Pythonの標準loggingモジュールを使用した柔軟なログ設定が可能です。</p>

                    <pre class="code-block"><code class="language-python"># settings.py - 本格的なログ設定
import os

# ログディレクトリの作成
LOG_DIR = os.path.join(BASE_DIR, 'logs')
os.makedirs(LOG_DIR, exist_ok=True)

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    
    # フォーマッターの定義
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {asctime} {message}',
            'style': '{',
        },
        'json': {
            'format': '{"level": "%(levelname)s", "time": "%(asctime)s", '
                     '"module": "%(module)s", "message": "%(message)s"}',
        },
    },
    
    # ハンドラーの定義
    'handlers': {
        'console': {
            'level': 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'simple',
        },
        'file_debug': {
            'level': 'DEBUG',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': os.path.join(LOG_DIR, 'debug.log'),
            'maxBytes': 1024*1024*10,  # 10MB
            'backupCount': 5,
            'formatter': 'verbose',
        },
        'file_error': {
            'level': 'ERROR',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': os.path.join(LOG_DIR, 'error.log'),
            'maxBytes': 1024*1024*10,
            'backupCount': 5,
            'formatter': 'verbose',
        },
        'mail_admins': {
            'level': 'ERROR',
            'class': 'django.utils.log.AdminEmailHandler',
            'formatter': 'verbose',
        },
    },
    
    # ログレベルとハンドラーの設定
    'loggers': {
        'django': {
            'handlers': ['console', 'file_debug'],
            'level': 'INFO',
            'propagate': False,
        },
        'django.request': {
            'handlers': ['file_error', 'mail_admins'],
            'level': 'ERROR',
            'propagate': False,
        },
        'blog': {  # アプリケーション固有のログ
            'handlers': ['console', 'file_debug'],
            'level': 'DEBUG',
            'propagate': False,
        },
    },
    
    # ルートロガーの設定
    'root': {
        'level': 'WARNING',
        'handlers': ['console'],
    },
}

# ログの使用例
# views.py
import logging

logger = logging.getLogger('blog')

def article_detail(request, slug):
    logger.info(f'記事詳細ページへのアクセス: {slug}')
    
    try:
        article = Article.objects.get(slug=slug, is_published=True)
        logger.debug(f'記事が見つかりました: {article.title}')
    except Article.DoesNotExist:
        logger.warning(f'記事が見つかりません: {slug}')
        raise Http404('記事が見つかりません')
    except Exception as e:
        logger.error(f'予期しないエラーが発生: {str(e)}', exc_info=True)
        raise
    
    return render(request, 'blog/article_detail.html', {'article': article})</code></pre>

                    <!-- セクション6: テストカバレッジ -->
                    <h3 class="section-title">8.6 テストカバレッジの測定と品質向上</h3>
                    
                    <p>テストカバレッジは、テストがどの程度のコードをカバーしているかを測定する指標です。高いカバレッジ率は、コードの品質と信頼性の向上につながります。</p>

                    <pre class="code-block"><code class="language-bash"># coverage.pyのインストール
pip install coverage

# テストカバレッジの測定
coverage run --source='.' manage.py test

# カバレッジレポートの表示
coverage report

# HTMLレポートの生成
coverage html

# 特定のディレクトリを除外
coverage run --source='.' --omit='venv/*,*/migrations/*' manage.py test

# .coveragercファイルでの設定
[run]
source = .
omit = 
    venv/*
    */migrations/*
    */tests/*
    manage.py
    */settings/*
    */venv/*

[report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError</code></pre>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 8-2: デバッグツールとログシステムの構築</h5>
                        <p>この実習では、開発効率を向上させるデバッグ環境とログシステムを構築します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>Django Debug Toolbarをインストール・設定する</li>
                            <li>包括的なログ設定を実装する</li>
                            <li>エラー処理とログ出力を各ビューに追加する</li>
                            <li>テストカバレッジを測定して品質を確認する</li>
                            <li>パフォーマンス問題を特定・改善する</li>
                        </ol>

                        <h6>カスタム管理コマンドの実装例</h6>
                        <pre class="code-block"><code class="language-python"># management/commands/generate_test_data.py
from django.core.management.base import BaseCommand
from django.contrib.auth.models import User
from blog.models import Article, Category
from faker import Faker
import logging

logger = logging.getLogger('blog')

class Command(BaseCommand):
    help = 'テスト用データの生成'
    
    def add_arguments(self, parser):
        parser.add_argument('--users', type=int, default=10)
        parser.add_argument('--articles', type=int, default=50)
    
    def handle(self, *args, **options):
        fake = Faker('ja_JP')
        
        try:
            # カテゴリ作成
            categories = []
            category_names = ['テクノロジー', 'ライフスタイル', '旅行', '料理', 'スポーツ']
            for name in category_names:
                category, created = Category.objects.get_or_create(
                    name=name,
                    defaults={'description': fake.text(max_nb_chars=200)}
                )
                categories.append(category)
            
            # ユーザー作成
            users = []
            for i in range(options['users']):
                user = User.objects.create_user(
                    username=fake.user_name(),
                    email=fake.email(),
                    password='testpass123',
                    first_name=fake.first_name(),
                    last_name=fake.last_name()
                )
                users.append(user)
            
            # 記事作成
            for i in range(options['articles']):
                Article.objects.create(
                    title=fake.sentence(),
                    content=fake.text(max_nb_chars=2000),
                    author=fake.random_element(users),
                    category=fake.random_element(categories),
                    is_published=fake.boolean(chance_of_getting_true=80)
                )
            
            logger.info(f'テストデータ生成完了: ユーザー{len(users)}人、記事{options["articles"]}件')
            self.stdout.write(
                self.style.SUCCESS(f'テストデータを生成しました。')
            )
            
        except Exception as e:
            logger.error(f'テストデータ生成エラー: {str(e)}', exc_info=True)
            self.stdout.write(
                self.style.ERROR(f'エラーが発生しました: {str(e)}')
            )</code></pre>

                        <h6>期待される結果</h6>
                        <p>デバッグツールが正常に動作し、ログが適切に出力され、テストカバレッジが80%以上であることを確認してください。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>Djangoテストフレームワークでテストデータベースが使用される理由を説明してください。</li>
                            <li>ユニットテスト、統合テスト、機能テストの違いと、それぞれの適用場面を説明してください。</li>
                            <li>Django Debug Toolbarで特定できるパフォーマンス問題の種類を5つ挙げてください。</li>
                            <li>ログレベル（DEBUG、INFO、WARNING、ERROR、CRITICAL）の使い分けについて説明してください。</li>
                            <li>テストカバレッジが100%でもバグが発生する可能性がある理由を説明してください。</li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="django-learning-material-7.html" class="btn btn-secondary">← 前の章</a>
                        <a href="django-learning-material-9.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>