<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django学習教材 第9章 - デプロイメントと本番環境設定</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #2e7d32;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        /* タイトル */
        .chapter-title {
            color: #2e7d32;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d32;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #388e3c;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d32;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #2e7d32 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>Django学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-1.html">
                                第1章: Django入門と環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-2.html">
                                第2章: モデルとデータベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-3.html">
                                第3章: ビューとURLルーティング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-4.html">
                                第4章: テンプレートとフロントエンド統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-5.html">
                                第5章: フォームとユーザー入力処理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-6.html">
                                第6章: 認証とユーザー管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-7.html">
                                第7章: Django REST Framework入門
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-8.html">
                                第8章: テストとデバッグ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="django-learning-material-9.html">
                                第9章: デプロイメントと本番環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="django-learning-material-10.html">
                                第10章: 高度な機能と最適化
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第9章: デプロイメントと本番環境設定</h1>
                </div>

                <div id="chapter9">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">本番環境へのセキュアなデプロイメント</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>開発環境と本番環境の設定分離</li>
                            <li>静的ファイルとメディアファイルの本番配信</li>
                            <li>WSGI/ASGIサーバーの選択と設定</li>
                            <li>PostgreSQL/MySQLとの統合</li>
                            <li>環境変数による設定管理</li>
                            <li>セキュリティベストプラクティスの実装</li>
                        </ul>
                    </div>

                    <!-- セクション1: 本番環境設定の基礎 -->
                    <h3 class="section-title">9.1 本番環境設定の基礎概念</h3>
                    
                    <p>本番環境でのDjangoアプリケーション運用では、開発環境とは異なる要件とセキュリティ考慮事項があります。パフォーマンス、セキュリティ、可用性、保守性を全て満たす設定が必要です。</p>

                    <h4>開発環境と本番環境の違い</h4>
                    <div class="mermaid">
                        graph TD
                            A[環境の違い] --> B[開発環境]
                            A --> C[本番環境]
                            
                            B --> B1[DEBUG = True<br/>開発サーバー使用<br/>SQLiteデータベース<br/>詳細なエラー表示]
                            
                            C --> C1[DEBUG = False<br/>本番サーバー使用<br/>PostgreSQL/MySQL<br/>エラー情報の制限]
                            C --> C2[HTTPS必須<br/>セキュリティヘッダー<br/>静的ファイル最適化<br/>監視・ログ設定]
                    </div>

                    <h4>設定ファイルの分離戦略</h4>
                    <pre class="code-block"><code class="language-python"># settings/base.py - 共通設定
import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent.parent

# 基本アプリケーション設定
DJANGO_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

THIRD_PARTY_APPS = [
    'rest_framework',
    'corsheaders',
]

LOCAL_APPS = [
    'blog',
    'accounts',
]

INSTALLED_APPS = DJANGO_APPS + THIRD_PARTY_APPS + LOCAL_APPS

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'myproject.urls'
WSGI_APPLICATION = 'myproject.wsgi.application'

# 国際化
LANGUAGE_CODE = 'ja'
TIME_ZONE = 'Asia/Tokyo'
USE_I18N = True
USE_TZ = True

# settings/development.py - 開発環境設定
from .base import *

DEBUG = True

ALLOWED_HOSTS = ['localhost', '127.0.0.1']

# 開発用データベース
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# 開発用静的ファイル設定
STATIC_URL = '/static/'
STATICFILES_DIRS = [BASE_DIR / 'static']

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

# 開発用メール設定
EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'

# settings/production.py - 本番環境設定
from .base import *
import os

DEBUG = False

ALLOWED_HOSTS = [
    'yourdomain.com',
    'www.yourdomain.com',
    'your-server-ip',
]

# セキュリティ設定
SECURE_SSL_REDIRECT = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
SECURE_HSTS_SECONDS = 31536000  # 1年
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_BROWSER_XSS_FILTER = True
X_FRAME_OPTIONS = 'DENY'
CSRF_COOKIE_SECURE = True
SESSION_COOKIE_SECURE = True

# 本番データベース設定
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.environ.get('DB_NAME'),
        'USER': os.environ.get('DB_USER'),
        'PASSWORD': os.environ.get('DB_PASSWORD'),
        'HOST': os.environ.get('DB_HOST', 'localhost'),
        'PORT': os.environ.get('DB_PORT', '5432'),
        'OPTIONS': {
            'sslmode': 'require',
        },
    }
}</code></pre>

                    <!-- セクション2: 環境変数管理 -->
                    <h3 class="section-title">9.2 環境変数による設定管理</h3>
                    
                    <p>機密情報や環境固有の設定値は、環境変数として管理することでセキュリティを向上させ、複数環境での運用を容易にします。</p>

                    <pre class="code-block"><code class="language-python"># python-decouple を使用した環境変数管理
# pip install python-decouple

# settings/base.py
from decouple import config, Csv
import dj_database_url

# 秘密鍵とデバッグ設定
SECRET_KEY = config('SECRET_KEY')
DEBUG = config('DEBUG', default=False, cast=bool)

# データベース設定
DATABASE_URL = config('DATABASE_URL', default='sqlite:///db.sqlite3')
DATABASES = {
    'default': dj_database_url.parse(DATABASE_URL)
}

# 許可ホスト
ALLOWED_HOSTS = config('ALLOWED_HOSTS', cast=Csv())

# メール設定
EMAIL_HOST = config('EMAIL_HOST', default='localhost')
EMAIL_PORT = config('EMAIL_PORT', default=587, cast=int)
EMAIL_HOST_USER = config('EMAIL_HOST_USER', default='')
EMAIL_HOST_PASSWORD = config('EMAIL_HOST_PASSWORD', default='')
EMAIL_USE_TLS = config('EMAIL_USE_TLS', default=True, cast=bool)

# AWS S3設定（静的ファイル用）
USE_S3 = config('USE_S3', default=False, cast=bool)

if USE_S3:
    AWS_ACCESS_KEY_ID = config('AWS_ACCESS_KEY_ID')
    AWS_SECRET_ACCESS_KEY = config('AWS_SECRET_ACCESS_KEY')
    AWS_STORAGE_BUCKET_NAME = config('AWS_STORAGE_BUCKET_NAME')
    AWS_S3_REGION_NAME = config('AWS_S3_REGION_NAME', default='ap-northeast-1')
    AWS_S3_CUSTOM_DOMAIN = f'{AWS_STORAGE_BUCKET_NAME}.s3.amazonaws.com'
    
    # 静的ファイル設定
    STATICFILES_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
    STATIC_URL = f'https://{AWS_S3_CUSTOM_DOMAIN}/static/'
    
    # メディアファイル設定
    DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
    MEDIA_URL = f'https://{AWS_S3_CUSTOM_DOMAIN}/media/'</code></pre>

                    <pre class="code-block"><code class="language-ini"># .env ファイルの例
# 基本設定
SECRET_KEY=your-secret-key-here
DEBUG=False
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com

# データベース設定
DATABASE_URL=postgres://user:password@localhost:5432/myproject_prod

# メール設定
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
EMAIL_USE_TLS=True

# AWS設定（オプション）
USE_S3=True
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_STORAGE_BUCKET_NAME=your-bucket-name
AWS_S3_REGION_NAME=ap-northeast-1

# Redis設定（キャッシュ用）
REDIS_URL=redis://localhost:6379/1</code></pre>

                    <!-- セクション3: 静的ファイル配信 -->
                    <h3 class="section-title">9.3 静的ファイルとメディアファイル配信</h3>
                    
                    <p>本番環境では、静的ファイル（CSS、JavaScript、画像）の効率的な配信が重要です。CDNやクラウドストレージとの統合により、高速で安定したファイル配信を実現できます。</p>

                    <pre class="code-block"><code class="language-python"># 静的ファイル収集とWhiteNoiseの設定
# pip install whitenoise

# settings/production.py
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',  # WhiteNoise追加
    # 他のミドルウェア...
]

# 静的ファイル設定
STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'

# WhiteNoise設定
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

# 静的ファイル圧縮
WHITENOISE_USE_FINDERS = True
WHITENOISE_AUTOREFRESH = True

# 追加の静的ファイルディレクトリ
STATICFILES_DIRS = [
    BASE_DIR / 'static',
]

# ファイルタイプ別の設定
STATICFILES_FINDERS = [
    'django.contrib.staticfiles.finders.FileSystemFinder',
    'django.contrib.staticfiles.finders.AppDirectoriesFinder',
]</code></pre>

                    <h4>Nginxを使用した静的ファイル配信</h4>
                    <pre class="code-block"><code class="language-bash"># Nginx設定ファイル例
# /etc/nginx/sites-available/myproject

server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    ssl_certificate /path/to/ssl/certificate.crt;
    ssl_certificate_key /path/to/ssl/private.key;
    
    # セキュリティヘッダー
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";

    # 静的ファイル配信
    location /static/ {
        alias /path/to/your/project/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # メディアファイル配信
    location /media/ {
        alias /path/to/your/project/media/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Djangoアプリケーション
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Gzip圧縮
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/javascript application/xml+rss 
               application/json;
}</code></pre>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 9-1: 本番環境設定の構築</h5>
                        <p>この実習では、本番環境でのDjango配備に必要な設定を段階的に構築します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>設定ファイルを開発・本番で分離する</li>
                            <li>環境変数管理システムを導入する</li>
                            <li>PostgreSQLデータベースとの接続を設定する</li>
                            <li>静的ファイル配信システムを構築する</li>
                            <li>セキュリティ設定を実装する</li>
                        </ol>

                        <h6>Docker を使用した本番環境構築</h6>
                        <pre class="code-block"><code class="language-bash"># Dockerfile
FROM python:3.11-slim

# 作業ディレクトリ設定
WORKDIR /app

# システムの依存関係をインストール
RUN apt-get update && apt-get install -y \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Python依存関係をインストール
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# アプリケーションコードをコピー
COPY . .

# 静的ファイルを収集
RUN python manage.py collectstatic --noinput --settings=myproject.settings.production

# ポート公開
EXPOSE 8000

# Gunicornでアプリケーション起動
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "3", "myproject.wsgi:application"]</code></pre>

                        <h6>期待される結果</h6>
                        <p>本番環境でアプリケーションが安全に動作し、静的ファイルが適切に配信されることを確認してください。</p>
                    </div>

                    <!-- セクション4: WSGIサーバー設定 -->
                    <h3 class="section-title">9.4 WSGI/ASGIサーバーの設定</h3>
                    
                    <p>本番環境では、Djangoの開発サーバーではなく、本格的なWSGI（Web Server Gateway Interface）サーバーが必要です。Gunicorn、uWSGI、Uvicorn等の選択肢があります。</p>

                    <h4>WSGIサーバーの比較</h4>
                    <div class="mermaid">
                        graph TD
                            A[WSGIサーバー選択] --> B[Gunicorn]
                            A --> C[uWSGI]
                            A --> D[Uvicorn]
                            A --> E[Waitress]
                            
                            B --> B1[Python製<br/>設定簡単<br/>Unix系OS推奨]
                            C --> C1[C製<br/>高性能<br/>豊富な機能]
                            D --> D1[ASGI対応<br/>非同期処理<br/>高速]
                            E --> E1[Pure Python<br/>Windows対応<br/>軽量]
                    </div>

                    <pre class="code-block"><code class="language-python"># Gunicorn設定ファイル (gunicorn.conf.py)
import multiprocessing
import os

# サーバー設定
bind = "127.0.0.1:8000"
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "sync"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 100

# ログ設定
loglevel = "info"
accesslog = "/var/log/gunicorn/access.log"
errorlog = "/var/log/gunicorn/error.log"
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'

# プロセス設定
preload_app = True
daemon = False
pidfile = "/var/run/gunicorn/gunicorn.pid"
user = "www-data"
group = "www-data"
tmp_upload_dir = None

# セキュリティ設定
limit_request_line = 4094
limit_request_fields = 100
limit_request_field_size = 8190

# Gunicorn起動コマンド
# gunicorn --config gunicorn.conf.py myproject.wsgi:application</code></pre>

                    <pre class="code-block"><code class="language-bash"># systemdサービス設定 (/etc/systemd/system/gunicorn.service)
[Unit]
Description=Gunicorn instance to serve MyProject
Requires=gunicorn.socket
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
RuntimeDirectory=gunicorn
WorkingDirectory=/path/to/your/project
ExecStart=/path/to/venv/bin/gunicorn --config gunicorn.conf.py myproject.wsgi:application
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true

[Install]
WantedBy=multi-user.target

# ソケット設定 (/etc/systemd/system/gunicorn.socket)
[Unit]
Description=gunicorn socket

[Socket]
ListenStream=/run/gunicorn.sock
SocketUser=www-data

[Install]
WantedBy=sockets.target</code></pre>

                    <!-- セクション5: データベース統合 -->
                    <h3 class="section-title">9.5 本番データベースとの統合</h3>
                    
                    <p>本番環境では、SQLiteではなくPostgreSQLやMySQLなどの本格的なデータベースシステムを使用します。適切な接続設定、パフォーマンスチューニング、バックアップ戦略が重要です。</p>

                    <pre class="code-block"><code class="language-python"># PostgreSQL統合設定
# pip install psycopg2-binary

# settings/production.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': config('DB_NAME'),
        'USER': config('DB_USER'),
        'PASSWORD': config('DB_PASSWORD'),
        'HOST': config('DB_HOST', default='localhost'),
        'PORT': config('DB_PORT', default='5432'),
        'OPTIONS': {
            'sslmode': 'require',
            'connect_timeout': 10,
            'options': '-c default_transaction_isolation=serializable'
        },
        'CONN_MAX_AGE': 600,  # 接続プール
        'TEST': {
            'NAME': 'test_' + config('DB_NAME'),
        }
    },
    
    # 読み取り専用データベース（レプリケーション）
    'replica': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': config('DB_NAME'),
        'USER': config('DB_REPLICA_USER'),
        'PASSWORD': config('DB_REPLICA_PASSWORD'),
        'HOST': config('DB_REPLICA_HOST'),
        'PORT': config('DB_PORT', default='5432'),
        'OPTIONS': {
            'sslmode': 'require',
        },
    }
}

# データベースルーター
DATABASE_ROUTERS = ['myproject.routers.DatabaseRouter']

# キャッシュ設定（Redis）
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': config('REDIS_URL'),
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'CONNECTION_POOL_KWARGS': {
                'max_connections': 100,
                'retry_on_timeout': True,
            }
        }
    }
}</code></pre>

                    <pre class="code-block"><code class="language-python"># データベースルーターの実装
# routers.py
class DatabaseRouter:
    """
    読み書き分離のためのデータベースルーター
    """
    
    def db_for_read(self, model, **hints):
        """読み取りクエリをレプリカDBに振り分け"""
        if model._meta.app_label in ['blog', 'accounts']:
            return 'replica'
        return 'default'
    
    def db_for_write(self, model, **hints):
        """書き込みクエリはメインDBに振り分け"""
        return 'default'
    
    def allow_relation(self, obj1, obj2, **hints):
        """同じデータベース内でのみリレーションを許可"""
        db_set = {'default', 'replica'}
        if obj1._state.db in db_set and obj2._state.db in db_set:
            return True
        return None
    
    def allow_migrate(self, db, app_label, model_name=None, **hints):
        """メインDBでのみマイグレーションを実行"""
        return db == 'default'</code></pre>

                    <!-- セクション6: セキュリティ対策 -->
                    <h3 class="section-title">9.6 本番環境セキュリティ対策</h3>
                    
                    <p>本番環境では、Webアプリケーションを様々な攻撃から保護するための包括的なセキュリティ対策が必要です。Django のセキュリティ機能と外部ツールを組み合わせて堅牢なシステムを構築します。</p>

                    <pre class="code-block"><code class="language-python"># settings/production.py - セキュリティ設定
import os

# HTTPS関連設定
SECURE_SSL_REDIRECT = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
SECURE_HSTS_SECONDS = 31536000  # 1年間
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# Cookie設定
SESSION_COOKIE_SECURE = True
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_AGE = 3600  # 1時間
SESSION_COOKIE_SAMESITE = 'Lax'

CSRF_COOKIE_SECURE = True
CSRF_COOKIE_HTTPONLY = True
CSRF_COOKIE_SAMESITE = 'Lax'

# セキュリティヘッダー
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_BROWSER_XSS_FILTER = True
X_FRAME_OPTIONS = 'DENY'

# CSP (Content Security Policy)
CSP_DEFAULT_SRC = ("'self'",)
CSP_SCRIPT_SRC = ("'self'", "'unsafe-inline'", "https://cdnjs.cloudflare.com")
CSP_STYLE_SRC = ("'self'", "'unsafe-inline'", "https://fonts.googleapis.com")
CSP_FONT_SRC = ("'self'", "https://fonts.gstatic.com")
CSP_IMG_SRC = ("'self'", "data:", "https:")

# パスワード検証
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
        'OPTIONS': {'max_similarity': 0.7}
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
        'OPTIONS': {'min_length': 12}
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# ログイン試行制限
LOGIN_ATTEMPT_LIMIT = 5
LOGIN_ATTEMPT_TIMEOUT = 300  # 5分

# ファイルアップロード制限
FILE_UPLOAD_MAX_MEMORY_SIZE = 5242880  # 5MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 5242880  # 5MB
FILE_UPLOAD_PERMISSIONS = 0o644

# 管理者通知
ADMINS = [
    ('Admin', 'admin@yourdomain.com'),
]
MANAGERS = ADMINS

# ログ設定（セキュリティ監査用）
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'security': {
            'format': '{asctime} {levelname} {name} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'security_file': {
            'level': 'WARNING',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': '/var/log/django/security.log',
            'maxBytes': 1024*1024*10,  # 10MB
            'backupCount': 5,
            'formatter': 'security',
        },
    },
    'loggers': {
        'django.security': {
            'handlers': ['security_file'],
            'level': 'WARNING',
            'propagate': False,
        },
    },
}</code></pre>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 9-2: 完全なデプロイメント環境の構築</h5>
                        <p>この実習では、本番環境での完全なデプロイメント環境を構築し、セキュリティ対策も含めて実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>Gunicorn + Nginx構成を設定する</li>
                            <li>PostgreSQLデータベースを統合する</li>
                            <li>SSL証明書を設定する</li>
                            <li>セキュリティヘッダーを実装する</li>
                            <li>ログ監視システムを構築する</li>
                        </ol>

                        <h6>デプロイメントスクリプトの例</h6>
                        <pre class="code-block"><code class="language-bash">#!/bin/bash
# deploy.sh - デプロイメント自動化スクリプト

set -e  # エラー時に停止

# 環境変数の読み込み
source /path/to/.env

# アプリケーションディレクトリに移動
cd /path/to/your/project

# Gitリポジトリを更新
git pull origin main

# 仮想環境をアクティベート
source venv/bin/activate

# 依存関係を更新
pip install -r requirements.txt

# データベースマイグレーション
python manage.py migrate --settings=myproject.settings.production

# 静的ファイル収集
python manage.py collectstatic --noinput --settings=myproject.settings.production

# テスト実行
python manage.py test --settings=myproject.settings.production

# Gunicornサービスを再起動
sudo systemctl reload gunicorn

# Nginxを再起動
sudo systemctl reload nginx

echo "デプロイメント完了"</code></pre>

                        <h6>期待される結果</h6>
                        <p>本番環境でアプリケーションがセキュアに動作し、適切なパフォーマンスとログ出力が得られることを確認してください。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>開発環境と本番環境で異なる設定が必要な理由を、セキュリティとパフォーマンスの観点から説明してください。</li>
                            <li>環境変数を使用した設定管理の利点を3つ挙げ、具体例を示してください。</li>
                            <li>本番環境でNginxを前面に配置する理由と、その役割を説明してください。</li>
                            <li>HTTPS必須化に必要なDjango設定項目を5つ挙げて、それぞれの役割を説明してください。</li>
                            <li>データベース接続プールとレプリケーション設定が本番環境で重要な理由を説明してください。</li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="django-learning-material-8.html" class="btn btn-secondary">← 前の章</a>
                        <a href="django-learning-material-10.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>