<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next.js学習教材 第8章 - 認証とミドルウェア</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #667eea; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #667eea; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; }
        .section-title { color: #764ba2; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container { background-color: rgba(102, 126, 234, 0.1); border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #667eea; }
        .exercise-container { background-color: #f3e5f5; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #764ba2; }
        .highlight { background-color: #ffecb3; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #667eea; }
        .warning { background-color: #ffebee; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #f44336; }
        .code-block { background-color: #1e1e1e; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #667eea !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid"><a class="navbar-brand"><strong>Next.js学習教材</strong></a></div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="nextjs-learning-material-01.html">第1章: Next.js入門と環境構築</a></li>
<li class="nav-item"><a class="nav-link" href="nextjs-learning-material-02.html">第2章: Reactの基礎とコンポーネント設計</a></li>
<li class="nav-item"><a class="nav-link" href="nextjs-learning-material-03.html">第3章: ページとルーティング（App Router）</a></li>
<li class="nav-item"><a class="nav-link" href="nextjs-learning-material-04.html">第4章: サーバーコンポーネントとクライアントコンポーネント</a></li>
<li class="nav-item"><a class="nav-link" href="nextjs-learning-material-05.html">第5章: データフェッチングとレンダリング戦略</a></li>
<li class="nav-item"><a class="nav-link" href="nextjs-learning-material-06.html">第6章: APIルートとサーバーアクション</a></li>
<li class="nav-item"><a class="nav-link" href="nextjs-learning-material-07.html">第7章: スタイリングと画像最適化</a></li>
<li class="nav-item"><a class="nav-linkactive" href="nextjs-learning-material-08.html">第8章: 認証とミドルウェア</a></li>
<li class="nav-item"><a class="nav-link" href="nextjs-learning-material-09.html">第9章: パフォーマンス最適化とベストプラクティス</a></li>
<li class="nav-item"><a class="nav-link" href="nextjs-learning-material-10.html">第10章: デプロイメントと本番環境設定</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第8章: 認証とミドルウェア</h1>
                </div>

                <div id="chapter8">
    <h2 class="chapter-title">セキュアな認証システムの構築</h2>
    
    <div class="highlight">
        <h5>この章で学ぶこと</h5>
        <ul>
            <li>Next.jsミドルウェアの基本と活用方法を理解する</li>
            <li>NextAuth.jsによる認証システムの構築を習得する</li>
            <li>ルート保護とアクセス制御の実装を学ぶ</li>
            <li>セッション管理とJWTの仕組みを理解する</li>
            <li>セキュリティベストプラクティスを習得する</li>
        </ul>
    </div>

    <h3 class="section-title">8.1 Next.jsミドルウェアの基本</h3>
    
    <h4>8.1.1 ミドルウェアとは</h4>
    <p>
        ミドルウェアは、<strong>リクエストが処理される前に実行されるコード</strong>です。認証チェック、リダイレクト、ヘッダー操作などに使用します。
    </p>

    <pre class="code-block"><code class="language-javascript">// middleware.js（プロジェクトルートに配置）
import { NextResponse } from 'next/server';

export function middleware(request) {
  // リクエスト処理前に実行される
  console.log('ミドルウェア実行:', request.url);
  
  return NextResponse.next();
}

// 特定のパスにのみ適用
export const config = {
  matcher: '/dashboard/:path*',
};</code></pre>

    <h3 class="section-title">8.2 NextAuth.jsによる認証</h3>
    
    <h4>8.2.1 NextAuth.jsのインストール</h4>
    <pre class="code-block"><code class="language-bash">npm install next-auth</code></pre>

    <h4>8.2.2 基本的な認証設定</h4>
    <pre class="code-block"><code class="language-javascript">// app/api/auth/[...nextauth]/route.js
import NextAuth from 'next-auth';
import GithubProvider from 'next-auth/providers/github';

export const authOptions = {
  providers: [
    GithubProvider({
      clientId: process.env.GITHUB_ID,
      clientSecret: process.env.GITHUB_SECRET,
    }),
  ],
  pages: {
    signIn: '/auth/signin',
  },
};

const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };</code></pre>

    <div class="exercise-container">
        <h5>実習 8-1: 認証付きダッシュボード</h5>
        
        <pre class="code-block"><code class="language-javascript">// app/dashboard/page.js
import { getServerSession } from 'next-auth';
import { authOptions } from '../api/auth/[...nextauth]/route';
import { redirect } from 'next/navigation';

export default async function DashboardPage() {
  const session = await getServerSession(authOptions);

  if (!session) {
    redirect('/auth/signin');
  }

  return (
    &lt;div&gt;
      &lt;h1&gt;ダッシュボード&lt;/h1&gt;
      &lt;p&gt;ようこそ、{session.user.name}さん！&lt;/p&gt;
    &lt;/div&gt;
  );
}</code></pre>
    </div>

    <h3 class="section-title">8.3 ミドルウェアによるルート保護</h3>

    <pre class="code-block"><code class="language-javascript">// middleware.js
import { getToken } from 'next-auth/jwt';
import { NextResponse } from 'next/server';

export async function middleware(request) {
  const token = await getToken({ req: request });

  // 未認証ユーザーをログインページにリダイレクト
  if (!token) {
    return NextResponse.redirect(new URL('/auth/signin', request.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: ['/dashboard/:path*', '/profile/:path*'],
};</code></pre>

    <div class="quiz-container">
        <h5>理解度確認クイズ</h5>
        <ol>
            <li>
                <strong>ミドルウェアファイルはプロジェクトのどこに配置しますか？</strong>
                <div style="margin-top: 10px; padding: 10px; background-color: white; border-radius: 5px;">
                    回答：プロジェクトルート（middleware.js）
                </div>
            </li>
            <li>
                <strong>NextAuth.jsで認証状態を取得する関数は何ですか？</strong>
                <div style="margin-top: 10px; padding: 10px; background-color: white; border-radius: 5px;">
                    回答：getServerSession()（サーバーコンポーネント）、useSession()（クライアントコンポーネント）
                </div>
            </li>
        </ol>
    </div>

    <h3 class="section-title">8.4 まとめ</h3>
    <p>この章では、認証とセキュリティについて学びました：</p>
    <ul>
        <li>Next.jsミドルウェアによるリクエスト前処理</li>
        <li>NextAuth.jsを使った認証システム構築</li>
        <li>ルート保護とアクセス制御</li>
        <li>セッション管理の基本</li>
    </ul>

    <div class="highlight">
        <h6>次の章の予告</h6>
        <p>
            第9章では、<strong>パフォーマンス最適化</strong>について学びます。コード分割、メモ化、Core Web Vitalsの改善手法を習得します。
        </p>
    </div>

    <div class="d-flex justify-content-between mt-4">
        <a href="nextjs-learning-material-07.html" class="btn btn-secondary">← 前の章</a>
        <a href="nextjs-learning-material-09.html" class="btn btn-primary">次の章 →</a>
    </div>
</div>
            </main>
        </div>
    </div>

    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'default' });</script>
</body>
</html>
