<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET Core (VB.NET)学習教材 第8章 - 認証と認可</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #663399;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #663399;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #663399;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #8e44ad;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #f8f4fc;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #663399;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #663399 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>ASP.NET Core (VB.NET)学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-1.html">第1章: ASP.NET Core入門と開発環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-2.html">第2章: MVCアーキテクチャの基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-3.html">第3章: Razorビューとレイアウト</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-4.html">第4章: モデルバインディングとバリデーション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-5.html">第5章: 依存性注入とミドルウェア</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-6.html">第6章: Entity Framework Coreとデータアクセス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-7.html">第7章: Web APIの開発</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aspnetcore-vb-learning-material-8.html">第8章: 認証と認可</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-9.html">第9章: 状態管理とキャッシング</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-10.html">第10章: 実践的なWebアプリケーション開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第8章: 認証と認可</h1>
                </div>

                <div id="chapter8">
                    <h2 class="chapter-title">セキュアなWebアプリケーションの構築</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>認証（Authentication）と認可（Authorization）の違いと重要性</li>
                            <li>ASP.NET Core Identityの設定と基本的な使用方法</li>
                            <li>Cookie認証の実装とセッション管理</li>
                            <li>JWT（JSON Web Token）を使用したAPIの認証</li>
                            <li>ロールベース認可とクレームベース認可の実装</li>
                            <li>外部認証プロバイダー（Google、Microsoft）の統合</li>
                        </ul>
                    </div>

                    <h3 class="section-title">8.1 認証と認可の基本概念</h3>
                    <p>
                        Webアプリケーションのセキュリティには、<strong>認証（Authentication）</strong>と<strong>認可（Authorization）</strong>の2つの重要な概念があります。
                    </p>

                    <ul>
                        <li><strong>認証（Authentication）:</strong> 「あなたは誰ですか？」- ユーザーの身元を確認するプロセス</li>
                        <li><strong>認可（Authorization）:</strong> 「あなたは何ができますか？」- 認証されたユーザーが特定のリソースにアクセスする権限があるかを判断するプロセス</li>
                    </ul>

                    <div class="mermaid">
                        sequenceDiagram
                            participant U as "ユーザー"
                            participant A as "認証システム"
                            participant S as "アプリケーション"
                            participant R as "リソース"

                            U->>A: ログイン試行（ID/パスワード）
                            A->>A: 身元確認
                            A->>S: 認証成功通知
                            S->>U: 認証トークン発行

                            U->>S: リソースへのアクセス要求
                            S->>S: 認可チェック（権限確認）
                            alt 権限あり
                                S->>R: アクセス許可
                                R->>U: リソース提供
                            else 権限なし
                                S->>U: アクセス拒否
                            end
                    </div>

                    <h3 class="section-title">8.2 ASP.NET Core Identityの設定</h3>
                    <p>
                        ASP.NET Core Identityは、Microsoftが提供する包括的な認証・認可システムです。
                        ユーザー管理、パスワードハッシュ、ロール管理、外部ログインプロバイダー連携などの機能を提供します。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 8-1: ASP.NET Core Identityの基本設定</h5>
                        <p>ユーザー登録とログイン機能を持つWebアプリケーションを作成します。</p>
                        
                        <h6>手順1: 必要なパッケージの追加</h6>
                        <pre class="code-block"><code class="language-bash"># プロジェクトファイル（.vbproj）に以下を追加
&lt;PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="8.0.0" /&gt;
&lt;PackageReference Include="Microsoft.AspNetCore.Identity.UI" Version="8.0.0" /&gt;</code></pre>

                        <h6>手順2: ApplicationUserモデルの作成</h6>
                        <pre class="code-block"><code class="language-vbnet">' Models/ApplicationUser.vb
Imports Microsoft.AspNetCore.Identity

Public Class ApplicationUser
    Inherits IdentityUser

    ' カスタムプロパティを追加可能
    Public Property FirstName As String
    Public Property LastName As String
    Public Property CreatedAt As DateTime = DateTime.UtcNow
End Class</code></pre>

                        <h6>手順3: DbContextの設定</h6>
                        <pre class="code-block"><code class="language-vbnet">' Data/ApplicationDbContext.vb
Imports Microsoft.AspNetCore.Identity.EntityFrameworkCore
Imports Microsoft.EntityFrameworkCore

Public Class ApplicationDbContext
    Inherits IdentityDbContext(Of ApplicationUser)

    Public Sub New(options As DbContextOptions(Of ApplicationDbContext))
        MyBase.New(options)
    End Sub

    Protected Overrides Sub OnModelCreating(modelBuilder As ModelBuilder)
        MyBase.OnModelCreating(modelBuilder)
        
        ' カスタム設定をここに追加
    End Sub
End Class</code></pre>

                        <h6>手順4: Startup.vbでIdentityサービスを設定</h6>
                        <pre class="code-block"><code class="language-vbnet">Public Sub ConfigureServices(services As IServiceCollection)
    services.AddControllersWithViews()
    
    ' データベース接続の設定
    services.AddDbContext(Of ApplicationDbContext)(Sub(options)
        options.UseSqlServer(Configuration.GetConnectionString("DefaultConnection"))
    End Sub)
    
    ' ASP.NET Core Identityの設定
    services.AddIdentity(Of ApplicationUser, IdentityRole)(Sub(options)
        ' パスワード要件の設定
        options.Password.RequiredLength = 6
        options.Password.RequireDigit = True
        options.Password.RequireLowercase = True
        options.Password.RequireUppercase = True
        options.Password.RequireNonAlphanumeric = False
        
        ' ロックアウト設定
        options.Lockout.DefaultLockoutTimeSpan = TimeSpan.FromMinutes(5)
        options.Lockout.MaxFailedAccessAttempts = 5
        
        ' ユーザー設定
        options.User.RequireUniqueEmail = True
    End Sub).AddEntityFrameworkStores(Of ApplicationDbContext)().AddDefaultTokenProviders()
End Sub

Public Sub Configure(app As IApplicationBuilder, env As IWebHostEnvironment)
    ' 認証・認可の有効化
    app.UseAuthentication()
    app.UseAuthorization()
    
    app.UseRouting()
    app.UseEndpoints(Sub(endpoints)
        endpoints.MapControllerRoute("default", "{controller=Home}/{action=Index}/{id?}")
    End Sub)
End Sub</code></pre>
                    </div>

                    <h3 class="section-title">8.3 Cookie認証の実装</h3>
                    <p>
                        Cookie認証は、Webブラウザのクッキーを使用してユーザーの認証状態を維持する方式です。
                        従来のWebアプリケーションでは最も一般的な認証方式です。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 8-2: ログイン・ログアウト機能の実装</h5>
                        <p>Cookie認証を使用したログインシステムを実装します。</p>

                        <h6>アカウントコントローラーの作成</h6>
                        <pre class="code-block"><code class="language-vbnet">' Controllers/AccountController.vb
Imports Microsoft.AspNetCore.Identity
Imports Microsoft.AspNetCore.Mvc

Public Class AccountController
    Inherits Controller

    Private ReadOnly _userManager As UserManager(Of ApplicationUser)
    Private ReadOnly _signInManager As SignInManager(Of ApplicationUser)

    Public Sub New(userManager As UserManager(Of ApplicationUser), signInManager As SignInManager(Of ApplicationUser))
        _userManager = userManager
        _signInManager = signInManager
    End Sub

    ' GET: /Account/Register
    Public Function Register() As IActionResult
        Return View()
    End Function

    ' POST: /Account/Register
    &lt;HttpPost&gt;
    Public Async Function Register(model As RegisterViewModel) As Task(Of IActionResult)
        If ModelState.IsValid Then
            Dim user = New ApplicationUser With {
                .UserName = model.Email,
                .Email = model.Email,
                .FirstName = model.FirstName,
                .LastName = model.LastName
            }

            Dim result = Await _userManager.CreateAsync(user, model.Password)

            If result.Succeeded Then
                Await _signInManager.SignInAsync(user, isPersistent:=False)
                Return RedirectToAction("Index", "Home")
            End If

            For Each [error] In result.Errors
                ModelState.AddModelError(String.Empty, [error].Description)
            Next
        End If

        Return View(model)
    End Function

    ' GET: /Account/Login
    Public Function Login(returnUrl As String) As IActionResult
        ViewData("ReturnUrl") = returnUrl
        Return View()
    End Function

    ' POST: /Account/Login
    &lt;HttpPost&gt;
    Public Async Function Login(model As LoginViewModel, returnUrl As String) As Task(Of IActionResult)
        If ModelState.IsValid Then
            Dim result = Await _signInManager.PasswordSignInAsync(model.Email, model.Password, model.RememberMe, lockoutOnFailure:=False)

            If result.Succeeded Then
                If Not String.IsNullOrEmpty(returnUrl) AndAlso Url.IsLocalUrl(returnUrl) Then
                    Return Redirect(returnUrl)
                Else
                    Return RedirectToAction("Index", "Home")
                End If
            End If

            ModelState.AddModelError(String.Empty, "無効なログイン試行です。")
        End If

        Return View(model)
    End Function

    ' POST: /Account/Logout
    &lt;HttpPost&gt;
    Public Async Function Logout() As Task(Of IActionResult)
        Await _signInManager.SignOutAsync()
        Return RedirectToAction("Index", "Home")
    End Function
End Class</code></pre>

                        <h6>ViewModelの作成</h6>
                        <pre class="code-block"><code class="language-vbnet">' ViewModels/RegisterViewModel.vb
Imports System.ComponentModel.DataAnnotations

Public Class RegisterViewModel
    &lt;Required(ErrorMessage:="名前は必須です")&gt;
    &lt;Display(Name:="名")&gt;
    Public Property FirstName As String

    &lt;Required(ErrorMessage:="苗字は必須です")&gt;
    &lt;Display(Name:="苗字")&gt;
    Public Property LastName As String

    &lt;Required(ErrorMessage:="メールアドレスは必須です")&gt;
    &lt;EmailAddress(ErrorMessage:="有効なメールアドレスを入力してください")&gt;
    &lt;Display(Name:="メールアドレス")&gt;
    Public Property Email As String

    &lt;Required(ErrorMessage:="パスワードは必須です")&gt;
    &lt;StringLength(100, ErrorMessage:="パスワードは{2}文字以上{1}文字以下で入力してください。", MinimumLength:=6)&gt;
    &lt;DataType(DataType.Password)&gt;
    &lt;Display(Name:="パスワード")&gt;
    Public Property Password As String

    &lt;DataType(DataType.Password)&gt;
    &lt;Display(Name:="パスワード確認")&gt;
    &lt;Compare("Password", ErrorMessage:="パスワードと確認パスワードが一致しません。")&gt;
    Public Property ConfirmPassword As String
End Class

' ViewModels/LoginViewModel.vb
Public Class LoginViewModel
    &lt;Required(ErrorMessage:="メールアドレスは必須です")&gt;
    &lt;EmailAddress&gt;
    &lt;Display(Name:="メールアドレス")&gt;
    Public Property Email As String

    &lt;Required(ErrorMessage:="パスワードは必須です")&gt;
    &lt;DataType(DataType.Password)&gt;
    &lt;Display(Name:="パスワード")&gt;
    Public Property Password As String

    &lt;Display(Name:="ログイン状態を保持する")&gt;
    Public Property RememberMe As Boolean
End Class</code></pre>
                    </div>

                    <h3 class="section-title">8.4 JWT認証の実装</h3>
                    <p>
                        JWT（JSON Web Token）は、Web APIでよく使用される認証方式です。
                        トークンベースの認証により、ステートレスな認証が実現できるため、スケーラブルなアプリケーションに適しています。
                    </p>

                    <div class="warning">
                        <h6>JWTのセキュリティ注意事項</h6>
                        <ul>
                            <li>JWTトークンには機密情報を含めないでください</li>
                            <li>適切な有効期限を設定してください</li>
                            <li>HTTPS通信を必須としてください</li>
                            <li>秘密鍵は安全に管理してください</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 8-3: JWT認証APIの実装</h5>
                        <p>Web API用のJWT認証システムを実装します。</p>

                        <h6>JWT設定クラス</h6>
                        <pre class="code-block"><code class="language-vbnet">' Models/JwtSettings.vb
Public Class JwtSettings
    Public Property Secret As String
    Public Property Issuer As String
    Public Property Audience As String
    Public Property ExpiryInHours As Integer = 24
End Class</code></pre>

                        <h6>JWT認証サービス</h6>
                        <pre class="code-block"><code class="language-vbnet">' Services/JwtService.vb
Imports Microsoft.IdentityModel.Tokens
Imports System.IdentityModel.Tokens.Jwt
Imports System.Security.Claims
Imports System.Text

Public Class JwtService
    Private ReadOnly _jwtSettings As JwtSettings

    Public Sub New(jwtSettings As JwtSettings)
        _jwtSettings = jwtSettings
    End Sub

    Public Function GenerateToken(user As ApplicationUser, roles As IList(Of String)) As String
        Dim tokenHandler = New JwtSecurityTokenHandler()
        Dim key = Encoding.ASCII.GetBytes(_jwtSettings.Secret)

        ' クレームの作成
        Dim claims = New List(Of Claim) From {
            New Claim(ClaimTypes.NameIdentifier, user.Id),
            New Claim(ClaimTypes.Name, user.UserName),
            New Claim(ClaimTypes.Email, user.Email)
        }

        ' ロールクレームの追加
        For Each role In roles
            claims.Add(New Claim(ClaimTypes.Role, role))
        Next

        Dim tokenDescriptor = New SecurityTokenDescriptor() With {
            .Subject = New ClaimsIdentity(claims),
            .Expires = DateTime.UtcNow.AddHours(_jwtSettings.ExpiryInHours),
            .Issuer = _jwtSettings.Issuer,
            .Audience = _jwtSettings.Audience,
            .SigningCredentials = New SigningCredentials(New SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
        }

        Dim token = tokenHandler.CreateToken(tokenDescriptor)
        Return tokenHandler.WriteToken(token)
    End Function

    Public Function ValidateToken(token As String) As ClaimsPrincipal
        Dim tokenHandler = New JwtSecurityTokenHandler()
        Dim key = Encoding.ASCII.GetBytes(_jwtSettings.Secret)

        Try
            Dim validationParameters = New TokenValidationParameters() With {
                .ValidateIssuerSigningKey = True,
                .IssuerSigningKey = New SymmetricSecurityKey(key),
                .ValidateIssuer = True,
                .ValidIssuer = _jwtSettings.Issuer,
                .ValidateAudience = True,
                .ValidAudience = _jwtSettings.Audience,
                .ValidateLifetime = True,
                .ClockSkew = TimeSpan.Zero
            }

            Dim principal = tokenHandler.ValidateToken(token, validationParameters, Nothing)
            Return principal
        Catch
            Return Nothing
        End Try
    End Function
End Class</code></pre>

                        <h6>JWT認証APIコントローラー</h6>
                        <pre class="code-block"><code class="language-vbnet">' Controllers/AuthController.vb
&lt;ApiController&gt;
&lt;Route("api/[controller]")&gt;
Public Class AuthController
    Inherits ControllerBase

    Private ReadOnly _userManager As UserManager(Of ApplicationUser)
    Private ReadOnly _jwtService As JwtService

    Public Sub New(userManager As UserManager(Of ApplicationUser), jwtService As JwtService)
        _userManager = userManager
        _jwtService = jwtService
    End Sub

    &lt;HttpPost("login")&gt;
    Public Async Function Login(model As LoginApiModel) As Task(Of IActionResult)
        Dim user = Await _userManager.FindByEmailAsync(model.Email)
        If user IsNot Nothing AndAlso Await _userManager.CheckPasswordAsync(user, model.Password) Then
            Dim roles = Await _userManager.GetRolesAsync(user)
            Dim token = _jwtService.GenerateToken(user, roles)

            Return Ok(New With {
                .token = token,
                .user = New With {
                    .id = user.Id,
                    .email = user.Email,
                    .firstName = user.FirstName,
                    .lastName = user.LastName
                }
            })
        End If

        Return Unauthorized("無効な認証情報です")
    End Function
End Class</code></pre>
                    </div>

                    <h3 class="section-title">8.5 認可（Authorization）の実装</h3>
                    <p>
                        認可は、認証されたユーザーが特定のリソースやアクションにアクセスする権限があるかを制御します。
                        ASP.NET Coreでは、属性ベース、ロールベース、クレームベース、ポリシーベースの認可方式をサポートしています。
                    </p>

                    <div class="mermaid">
                        graph TD
                            A["認証済みユーザー"] --> B{"認可チェック"}
                            B --> C["ロールベース認可"]
                            B --> D["クレームベース認可"]
                            B --> E["ポリシーベース認可"]
                            C --> F{"権限確認"}
                            D --> F
                            E --> F
                            F -->|権限あり| G["リソースアクセス許可"]
                            F -->|権限なし| H["アクセス拒否（403 Forbidden）"]
                    </div>

                    <div class="exercise-container">
                        <h5>実習 8-4: ロールベース認可の実装</h5>
                        <p>管理者とユーザーの権限を分けたロールベース認可システムを実装します。</p>

                        <h6>ロールの初期化</h6>
                        <pre class="code-block"><code class="language-vbnet">' Data/DbInitializer.vb
Imports Microsoft.AspNetCore.Identity

Public Class DbInitializer
    Public Shared Async Function SeedAsync(serviceProvider As IServiceProvider) As Task
        Dim roleManager = serviceProvider.GetRequiredService(Of RoleManager(Of IdentityRole))()
        Dim userManager = serviceProvider.GetRequiredService(Of UserManager(Of ApplicationUser))()

        ' ロールの作成
        Dim roles = {"Admin", "User", "Manager"}
        For Each role In roles
            If Not Await roleManager.RoleExistsAsync(role) Then
                Await roleManager.CreateAsync(New IdentityRole(role))
            End If
        Next

        ' 管理者ユーザーの作成
        Dim adminEmail = "admin@example.com"
        Dim adminUser = Await userManager.FindByEmailAsync(adminEmail)
        
        If adminUser Is Nothing Then
            adminUser = New ApplicationUser With {
                .UserName = adminEmail,
                .Email = adminEmail,
                .FirstName = "管理者",
                .LastName = "システム",
                .EmailConfirmed = True
            }
            
            Await userManager.CreateAsync(adminUser, "Admin123!")
            Await userManager.AddToRoleAsync(adminUser, "Admin")
        End If
    End Function
End Class</code></pre>

                        <h6>認可属性の使用</h6>
                        <pre class="code-block"><code class="language-vbnet">' Controllers/AdminController.vb
Imports Microsoft.AspNetCore.Authorization

&lt;Authorize(Roles:="Admin")&gt;
Public Class AdminController
    Inherits Controller

    Public Function Index() As IActionResult
        Return View()
    End Function

    &lt;Authorize(Roles:="Admin,Manager")&gt;
    Public Function Reports() As IActionResult
        Return View()
    End Function
End Class

' Web APIでの使用例
&lt;ApiController&gt;
&lt;Route("api/[controller]")&gt;
&lt;Authorize&gt;
Public Class UsersController
    Inherits ControllerBase

    ' 認証が必要（すべてのロール）
    &lt;HttpGet&gt;
    Public Function GetUsers() As IActionResult
        Return Ok("ユーザー一覧")
    End Function

    ' 管理者のみアクセス可能
    &lt;HttpDelete("{id}")&gt;
    &lt;Authorize(Roles:="Admin")&gt;
    Public Function DeleteUser(id As String) As IActionResult
        Return NoContent()
    End Function
End Class</code></pre>
                    </div>

                    <h3 class="section-title">8.6 クレームベース認可とポリシー</h3>
                    <p>
                        クレームベース認可は、ユーザーのクレーム（属性情報）に基づいてアクセス制御を行います。
                        より柔軟で細かい権限制御が可能になります。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 8-5: カスタム認可ポリシーの実装</h5>
                        <p>クレームベースの認可ポリシーを作成します。</p>

                        <h6>認可ポリシーの定義</h6>
                        <pre class="code-block"><code class="language-vbnet">' Startup.vb のConfigureServicesメソッド
services.AddAuthorization(Sub(options)
    ' 年齢ベースのポリシー
    options.AddPolicy("Adult", Sub(policy)
        policy.RequireClaim("Age", Function(age) Integer.Parse(age) >= 18)
    End Sub)
    
    ' 部署ベースのポリシー
    options.AddPolicy("ITDepartment", Sub(policy)
        policy.RequireClaim("Department", "IT")
    End Sub)
    
    ' 複合ポリシー
    options.AddPolicy("ITManager", Sub(policy)
        policy.RequireRole("Manager")
        policy.RequireClaim("Department", "IT")
    End Sub)
End Sub)</code></pre>

                        <h6>カスタム認可ハンドラー</h6>
                        <pre class="code-block"><code class="language-vbnet">' Authorization/MinimumAgeRequirement.vb
Imports Microsoft.AspNetCore.Authorization

Public Class MinimumAgeRequirement
    Implements IAuthorizationRequirement

    Public ReadOnly Property MinimumAge As Integer

    Public Sub New(minimumAge As Integer)
        Me.MinimumAge = minimumAge
    End Sub
End Class

Public Class MinimumAgeHandler
    Inherits AuthorizationHandler(Of MinimumAgeRequirement)

    Protected Overrides Function HandleRequirementAsync(context As AuthorizationHandlerContext, requirement As MinimumAgeRequirement) As Task
        If Not context.User.HasClaim(Function(c) c.Type = "DateOfBirth") Then
            Return Task.CompletedTask
        End If

        Dim dateOfBirthClaim = context.User.FindFirst("DateOfBirth")
        Dim dateOfBirth = DateTime.Parse(dateOfBirthClaim.Value)
        Dim calculatedAge = DateTime.Today.Year - dateOfBirth.Year

        If dateOfBirth > DateTime.Today.AddYears(-calculatedAge) Then
            calculatedAge -= 1
        End If

        If calculatedAge >= requirement.MinimumAge Then
            context.Succeed(requirement)
        End If

        Return Task.CompletedTask
    End Function
End Class</code></pre>

                        <h6>ポリシーの使用</h6>
                        <pre class="code-block"><code class="language-vbnet">&lt;Authorize(Policy:="Adult")&gt;
Public Class AdultOnlyController
    Inherits Controller

    Public Function Index() As IActionResult
        Return View()
    End Function
End Class</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>認証（Authentication）と認可（Authorization）の違いを説明してください。</li>
                            <li>Cookie認証とJWT認証のそれぞれの利点と欠点を比較してください。</li>
                            <li>ASP.NET Core Identityが提供する主要な機能を3つ挙げてください。</li>
                            <li>ロールベース認可とクレームベース認可の違いは何ですか？</li>
                            <li>JWTトークンを使用する際のセキュリティ上の注意点を3つ挙げてください。</li>
                        </ol>
                        
                        <div class="mt-3">
                            <strong>解答例：</strong>
                            <ol>
                                <li>認証はユーザーの身元確認（「誰か」）、認可は権限確認（「何ができるか」）を行います。</li>
                                <li>Cookie認証：サーバー側でセッション管理、ブラウザ向け。JWT：ステートレス、API向け、スケーラブル。</li>
                                <li>ユーザー管理、パスワードハッシュ、ロール管理、外部認証プロバイダー連携など。</li>
                                <li>ロールベースは事前定義されたロール、クレームベースはより柔軟な属性情報による制御。</li>
                                <li>機密情報を含めない、適切な有効期限設定、HTTPS必須、秘密鍵の安全管理。</li>
                            </ol>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnetcore-vb-learning-material-7.html" class="btn btn-secondary">← 第7章: Web APIの開発</a>
                        <a href="aspnetcore-vb-learning-material-9.html" class="btn btn-primary">第9章: 状態管理とキャッシング →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>