<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET Core (VB.NET)学習教材 第6章 - Entity Framework Coreとデータアクセス</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #663399;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #663399;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #663399;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #8e44ad;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #f8f4fc;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #663399;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #663399 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>ASP.NET Core (VB.NET)学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-01.html">
                                第1章: ASP.NET Core入門と開発環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-02.html">
                                第2章: MVCアーキテクチャの基礎
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-03.html">
                                第3章: Razorビューとレイアウト
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-04.html">
                                第4章: モデルバインディングとバリデーション
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-05.html">
                                第5章: 依存性注入とミドルウェア
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aspnetcore-vb-learning-material-06.html">
                                第6章: Entity Framework Coreとデータアクセス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-07.html">
                                第7章: Web APIの開発
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-08.html">
                                第8章: 認証と認可
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-09.html">
                                第9章: 状態管理とキャッシング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-10.html">
                                第10章: 実践的なWebアプリケーション開発
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: Entity Framework Coreとデータアクセス</h1>
                </div>

                <div id="chapter6">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">Entity Framework Coreとデータアクセス</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Entity Framework Core（EF Core）の基本概念と重要性</li>
                            <li>Code Firstアプローチによるデータベース設計の方法</li>
                            <li>DbContextの役割と設定方法</li>
                            <li>エンティティクラスの定義とデータアノテーション</li>
                            <li>マイグレーションによるデータベース管理</li>
                            <li>LINQ to Entitiesを使用したデータクエリ</li>
                            <li>リポジトリパターンによる設計手法</li>
                            <li>VB.NETでのEntity Framework Core実装</li>
                        </ul>
                    </div>

                    <!-- セクション 6.1: Entity Framework Coreとは -->
                    <h3 class="section-title">6.1 Entity Framework Coreとは</h3>
                    <p>Entity Framework Core（EF Core）は、.NETアプリケーションでデータベースアクセスを行うためのオブジェクト・リレーショナル・マッピング（ORM）フレームワークです。従来のADO.NETやDataSetと比較して、より直感的で保守性の高いデータアクセス層を構築できます。</p>

                    <h4>ORMとは何か</h4>
                    <p>ORM（Object-Relational Mapping）は、オブジェクト指向プログラミングとリレーショナルデータベースの間を橋渡しする技術です。これにより、開発者はSQLを直接書かずに、慣れ親しんだプログラミング言語の構文でデータベース操作を行えます。</p>

                    <div class="mermaid">
                        classDiagram
                            class アプリケーション {
                                +VB.NETオブジェクト
                                +ビジネスロジック
                            }
                            class EF Core {
                                +ORM機能
                                +LINQ翻訳
                                +変更追跡
                            }
                            class データベース {
                                +SQL Server
                                +テーブル
                                +リレーション
                            }
                            アプリケーション --> EF Core : VB.NETオブジェクトで操作
                            EF Core --> データベース : SQLに変換して実行
                    </div>

                    <h4>EF CoreとADO.NETの比較</h4>
                    <p>従来のADO.NETでは、SQL文を文字列で記述し、DataReaderやDataSetを使用してデータを操作していました。一方、EF CoreではLINQクエリを使用し、強い型付けによる安全なデータアクセスが可能です。</p>

                    <div class="warning">
                        <h6>従来のADO.NETの課題</h6>
                        <ul>
                            <li>SQL文を文字列で書くため、コンパイル時にエラーを発見できない</li>
                            <li>データベーススキーマ変更時の影響が広範囲に及ぶ</li>
                            <li>テスタビリティが低い</li>
                            <li>コードの重複が多くなりがち</li>
                        </ul>
                    </div>

                    <!-- セクション 6.2: Code Firstアプローチ -->
                    <h3 class="section-title">6.2 Code Firstアプローチ</h3>
                    <p>Code Firstは、まずVB.NETのクラス（エンティティ）を定義し、そこからデータベースのテーブル構造を生成するアプローチです。これにより、オブジェクト指向設計を中心としたデータモデル構築が可能になります。</p>

                    <h4>Code Firstの利点</h4>
                    <ul>
                        <li><strong>設計の一元化</strong>: データ構造をVB.NETクラスで統一管理</li>
                        <li><strong>バージョン管理</strong>: エンティティクラスをソースコード管理に含められる</li>
                        <li><strong>チーム開発</strong>: 開発者間でのデータモデル共有が容易</li>
                        <li><strong>テスト容易性</strong>: インメモリデータベースでのテストが簡単</li>
                    </ul>

                    <div class="mermaid">
                        sequenceDiagram
                            participant D as 開発者
                            participant E as エンティティクラス
                            participant M as マイグレーション
                            participant DB as データベース
                            
                            D->>E: クラス定義・更新
                            E->>M: Add-Migration実行
                            M->>M: 変更内容を解析
                            M->>DB: Update-Database実行
                            DB->>DB: テーブル作成・更新
                    </div>

                    <!-- 実習 6-1 -->
                    <div class="exercise-container">
                        <h5>実習 6-1: 基本的なエンティティクラスの作成</h5>
                        <p>書籍管理システムのBookエンティティを作成して、Code Firstアプローチの基本を理解しましょう。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>Models フォルダに新しいクラスファイル「Book.vb」を作成</li>
                            <li>Bookエンティティクラスを定義</li>
                            <li>基本的なプロパティを追加</li>
                        </ol>
                        
                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-vbnet">Imports System.ComponentModel.DataAnnotations

Public Class Book
    ' 主キー（プライマリキー）
    Public Property Id As Integer
    
    ' 書籍タイトル（必須項目、最大200文字）
    &lt;Required&gt;
    &lt;MaxLength(200)&gt;
    Public Property Title As String
    
    ' 著者名（必須項目、最大100文字）
    &lt;Required&gt;
    &lt;MaxLength(100)&gt;
    Public Property Author As String
    
    ' ISBN番号（一意制約）
    &lt;MaxLength(20)&gt;
    Public Property Isbn As String
    
    ' 出版年
    Public Property PublishedYear As Integer?
    
    ' 価格
    &lt;Range(0, 999999)&gt;
    Public Property Price As Decimal
    
    ' 作成日時
    Public Property CreatedDate As DateTime
End Class</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>Bookクラスが正常に作成され、各プロパティにデータアノテーションが適切に設定されます。これらの設定は後でデータベースのテーブル定義に反映されます。</p>
                    </div>

                    <!-- セクション 6.3: DbContextの設定 -->
                    <h3 class="section-title">6.3 DbContextの設定</h3>
                    <p>DbContextは、Entity Framework Coreにおいてデータベースとの通信を担う中心的なクラスです。セッション管理、変更追跡、クエリ実行などの重要な機能を提供します。</p>

                    <h4>DbContextの役割</h4>
                    <ul>
                        <li><strong>データベース接続管理</strong>: 接続文字列の管理と接続の開閉</li>
                        <li><strong>変更追跡</strong>: エンティティの変更状態を監視</li>
                        <li><strong>クエリ生成</strong>: LINQクエリをSQLに変換</li>
                        <li><strong>トランザクション管理</strong>: データベーストランザクションの制御</li>
                    </ul>

                    <div class="mermaid">
                        graph TD
                            A[VB.NETアプリケーション] --> B[DbContext]
                            B --> C[DbSet&lt;Book&gt;]
                            B --> D[DbSet&lt;Author&gt;]
                            B --> E[データベース接続]
                            E --> F[SQL Server]
                            C --> G[Booksテーブル]
                            D --> H[Authorsテーブル]
                    </div>

                    <!-- 実習 6-2 -->
                    <div class="exercise-container">
                        <h5>実習 6-2: DbContextクラスの作成と設定</h5>
                        <p>書籍管理システム用のDbContextを作成し、依存性注入で設定します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>Data フォルダを作成</li>
                            <li>BookStoreContextクラスを作成</li>
                            <li>Program.vbでDbContextを依存性注入に登録</li>
                            <li>接続文字列を設定</li>
                        </ol>
                        
                        <h6>BookStoreContext.vbの実装</h6>
                        <pre class="code-block"><code class="language-vbnet">Imports Microsoft.EntityFrameworkCore

Public Class BookStoreContext
    Inherits DbContext
    
    ' コンストラクタ
    Public Sub New(options As DbContextOptions(Of BookStoreContext))
        MyBase.New(options)
    End Sub
    
    ' DbSetプロパティ（各テーブルを表現）
    Public Property Books As DbSet(Of Book)
    
    ' モデル作成時の設定（オプション）
    Protected Overrides Sub OnModelCreating(modelBuilder As ModelBuilder)
        MyBase.OnModelCreating(modelBuilder)
        
        ' Bookエンティティの詳細設定
        modelBuilder.Entity(Of Book)(
            Sub(entity)
                ' テーブル名を明示的に指定
                entity.ToTable("Books")
                
                ' 主キーの設定
                entity.HasKey(Function(b) b.Id)
                
                ' ISBN列にユニーク制約を追加
                entity.HasIndex(Function(b) b.Isbn).IsUnique()
                
                ' プロパティの詳細設定
                entity.Property(Function(b) b.Title).IsRequired().HasMaxLength(200)
                entity.Property(Function(b) b.Author).IsRequired().HasMaxLength(100)
                entity.Property(Function(b) b.Price).HasPrecision(10, 2)
            End Sub
        )
    End Sub
End Class</code></pre>
                        
                        <h6>Program.vbでの設定</h6>
                        <pre class="code-block"><code class="language-vbnet">Imports Microsoft.EntityFrameworkCore

Module Program
    Sub Main(args As String())
        Dim builder = WebApplication.CreateBuilder(args)
        
        ' サービスの登録
        builder.Services.AddControllersWithViews()
        
        ' Entity Framework Coreの設定
        builder.Services.AddDbContext(Of BookStoreContext)(
            Sub(options)
                options.UseSqlServer(
                    builder.Configuration.GetConnectionString("DefaultConnection")
                )
            End Sub
        )
        
        Dim app = builder.Build()
        
        ' 残りの設定...
        app.Run()
    End Sub
End Module</code></pre>
                        
                        <h6>appsettings.jsonの接続文字列設定</h6>
                        <pre class="code-block"><code class="language-json">{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqlLocaldb;Database=BookStoreDb;Trusted_Connection=true;MultipleActiveResultSets=true"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Information"
    }
  }
}</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>DbContextが正常に設定され、依存性注入コンテナに登録されます。アプリケーション起動時にデータベース接続が確立されます。</p>
                    </div>

                    <!-- セクション 6.4: マイグレーション -->
                    <h3 class="section-title">6.4 マイグレーション</h3>
                    <p>マイグレーションは、エンティティクラスの変更をデータベーススキーマに反映するためのメカニズムです。開発環境から本番環境まで、データベース構造のバージョン管理を可能にします。</p>

                    <h4>マイグレーションのワークフロー</h4>
                    <p>マイグレーションは以下の段階的なプロセスで実行されます：</p>

                    <div class="mermaid">
                        graph LR
                            A[エンティティ変更] --> B[Add-Migration]
                            B --> C[マイグレーションファイル生成]
                            C --> D[Update-Database]
                            D --> E[データベース更新]
                            E --> F[__EFMigrationsHistory更新]
                    </div>

                    <h4>マイグレーションコマンド</h4>
                    <ul>
                        <li><strong>Add-Migration</strong>: 新しいマイグレーションファイルを作成</li>
                        <li><strong>Update-Database</strong>: 保留中のマイグレーションをデータベースに適用</li>
                        <li><strong>Remove-Migration</strong>: 最後のマイグレーションを削除（未適用の場合のみ）</li>
                        <li><strong>Script-Migration</strong>: マイグレーションのSQLスクリプトを生成</li>
                    </ul>

                    <!-- 実習 6-3 -->
                    <div class="exercise-container">
                        <h5>実習 6-3: 初回マイグレーションの実行</h5>
                        <p>作成したBookエンティティとDbContextを使用して、初回マイグレーションを実行します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>Package Manager Consoleを開く（Visual Studio）</li>
                            <li>初回マイグレーションを作成</li>
                            <li>データベースを更新</li>
                            <li>生成されたマイグレーションファイルを確認</li>
                        </ol>
                        
                        <h6>コマンド実行例</h6>
                        <pre class="code-block"><code class="language-bash"># Package Manager Consoleで実行
Add-Migration InitialCreate

# データベースに適用
Update-Database</code></pre>
                        
                        <h6>生成されるマイグレーションファイル例</h6>
                        <pre class="code-block"><code class="language-vbnet">Imports Microsoft.EntityFrameworkCore.Migrations

Partial Public Class InitialCreate
    Inherits Migration
    
    Protected Overrides Sub Up(migrationBuilder As MigrationBuilder)
        migrationBuilder.CreateTable(
            name:="Books",
            columns:=Function(table) New With {
                .Id = table.Column(Of Integer)(nullable:=False).
                    Annotation("SqlServer:Identity", "1, 1"),
                .Title = table.Column(Of String)(maxLength:=200, nullable:=False),
                .Author = table.Column(Of String)(maxLength:=100, nullable:=False),
                .Isbn = table.Column(Of String)(maxLength:=20, nullable:=True),
                .PublishedYear = table.Column(Of Integer)(nullable:=True),
                .Price = table.Column(Of Decimal)(precision:=10, scale:=2, nullable:=False),
                .CreatedDate = table.Column(Of DateTime)(nullable:=False)
            },
            constraints:=Sub(table)
                table.PrimaryKey("PK_Books", Function(x) x.Id)
            End Sub)
            
        migrationBuilder.CreateIndex(
            name:="IX_Books_Isbn",
            table:="Books",
            column:="Isbn",
            unique:=True)
    End Sub
    
    Protected Overrides Sub Down(migrationBuilder As MigrationBuilder)
        migrationBuilder.DropTable(name:="Books")
    End Sub
End Class</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>データベースにBooksテーブルが作成され、指定した制約とインデックスが適用されます。__EFMigrationsHistoryテーブルでマイグレーション履歴が管理されます。</p>
                    </div>

                    <!-- セクション 6.5: LINQ to Entities -->
                    <h3 class="section-title">6.5 LINQ to Entities</h3>
                    <p>LINQ to Entitiesは、LINQクエリ構文を使用してデータベースからデータを取得・操作するためのテクノロジーです。VB.NETの自然な構文でデータベースクエリを記述できます。</p>

                    <h4>基本的なクエリパターン</h4>
                    <p>LINQ to Entitiesでは、以下のような基本的なクエリパターンを使用します：</p>

                    <ul>
                        <li><strong>Select</strong>: データの取得と射影</li>
                        <li><strong>Where</strong>: 条件による絞り込み</li>
                        <li><strong>OrderBy/OrderByDescending</strong>: 並び替え</li>
                        <li><strong>GroupBy</strong>: グループ化</li>
                        <li><strong>Join</strong>: テーブル結合</li>
                    </ul>

                    <!-- 実習 6-4 -->
                    <div class="exercise-container">
                        <h5>実習 6-4: LINQ to Entitiesによるデータクエリ</h5>
                        <p>様々なLINQクエリを実装して、データベースからの情報取得方法を学習します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>コントローラーでDbContextを注入</li>
                            <li>基本的なSELECTクエリを実装</li>
                            <li>条件付きクエリを実装</li>
                            <li>集計クエリを実装</li>
                        </ol>
                        
                        <h6>BooksController.vbの実装例</h6>
                        <pre class="code-block"><code class="language-vbnet">Imports Microsoft.AspNetCore.Mvc
Imports Microsoft.EntityFrameworkCore

Public Class BooksController
    Inherits Controller
    
    Private ReadOnly _context As BookStoreContext
    
    ' コンストラクタでDbContextを注入
    Public Sub New(context As BookStoreContext)
        _context = context
    End Sub
    
    ' 全書籍の一覧表示
    Public Async Function Index() As Task(Of IActionResult)
        ' 基本的なSELECTクエリ
        Dim books = Await _context.Books.
            OrderByDescending(Function(b) b.CreatedDate).
            ToListAsync()
            
        Return View(books)
    End Function
    
    ' 価格帯による検索
    Public Async Function SearchByPrice(minPrice As Decimal?, maxPrice As Decimal?) As Task(Of IActionResult)
        ' 条件付きクエリ
        Dim query = _context.Books.AsQueryable()
        
        If minPrice.HasValue Then
            query = query.Where(Function(b) b.Price >= minPrice.Value)
        End If
        
        If maxPrice.HasValue Then
            query = query.Where(Function(b) b.Price <= maxPrice.Value)
        End If
        
        Dim books = Await query.
            OrderBy(Function(b) b.Price).
            ToListAsync()
            
        Return View("Index", books)
    End Function
    
    ' 著者別の書籍数統計
    Public Async Function AuthorStatistics() As Task(Of IActionResult)
        ' グループ化と集計クエリ
        Dim statistics = Await _context.Books.
            GroupBy(Function(b) b.Author).
            Select(Function(g) New With {
                .Author = g.Key,
                .BookCount = g.Count(),
                .AveragePrice = g.Average(Function(b) b.Price),
                .TotalValue = g.Sum(Function(b) b.Price)
            }).
            OrderByDescending(Function(s) s.BookCount).
            ToListAsync()
            
        Return View(statistics)
    End Function
    
    ' 特定の書籍詳細表示
    Public Async Function Details(id As Integer) As Task(Of IActionResult)
        ' 単一エンティティの取得
        Dim book = Await _context.Books.
            FirstOrDefaultAsync(Function(b) b.Id = id)
            
        If book Is Nothing Then
            Return NotFound()
        End If
        
        Return View(book)
    End Function
End Class</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>各メソッドが適切なLINQクエリを実行し、データベースから必要なデータを取得します。Entity Framework Coreが自動的にSQLクエリに変換して実行します。</p>
                    </div>

                    <!-- セクション 6.6: リポジトリパターン -->
                    <h3 class="section-title">6.6 リポジトリパターン</h3>
                    <p>リポジトリパターンは、データアクセスロジックを抽象化し、ビジネスロジックから分離するためのデザインパターンです。テスタビリティの向上と、データアクセス層の変更に対する柔軟性を提供します。</p>

                    <h4>リポジトリパターンの利点</h4>
                    <ul>
                        <li><strong>関心の分離</strong>: ビジネスロジックとデータアクセスロジックの分離</li>
                        <li><strong>テスタビリティ</strong>: モックオブジェクトを使用した単体テストが容易</li>
                        <li><strong>保守性</strong>: データアクセス層の変更がビジネスロジックに影響しない</li>
                        <li><strong>再利用性</strong>: 共通的なCRUD操作の再利用</li>
                    </ul>

                    <div class="mermaid">
                        classDiagram
                            class IBookRepository {
                                &lt;&lt;interface&gt;&gt;
                                +GetAllAsync() Task&lt;Book[]&gt;
                                +GetByIdAsync(id) Task&lt;Book&gt;
                                +AddAsync(book) Task
                                +UpdateAsync(book) Task
                                +DeleteAsync(id) Task
                            }
                            
                            class BookRepository {
                                -_context BookStoreContext
                                +GetAllAsync() Task&lt;Book[]&gt;
                                +GetByIdAsync(id) Task&lt;Book&gt;
                                +AddAsync(book) Task
                                +UpdateAsync(book) Task
                                +DeleteAsync(id) Task
                            }
                            
                            class BooksController {
                                -_repository IBookRepository
                                +Index() IActionResult
                                +Create() IActionResult
                                +Edit(id) IActionResult
                            }
                            
                            IBookRepository <|-- BookRepository
                            BooksController --> IBookRepository
                    </div>

                    <!-- 実習 6-5 -->
                    <div class="exercise-container">
                        <h5>実習 6-5: リポジトリパターンの実装</h5>
                        <p>書籍管理システムにリポジトリパターンを導入し、データアクセスロジックを分離します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>IBookRepositoryインターフェースを定義</li>
                            <li>BookRepositoryクラスを実装</li>
                            <li>依存性注入に登録</li>
                            <li>コントローラーでリポジトリを使用</li>
                        </ol>
                        
                        <h6>IBookRepository.vbインターフェース定義</h6>
                        <pre class="code-block"><code class="language-vbnet">Public Interface IBookRepository
    ' 全書籍取得
    Function GetAllAsync() As Task(Of IEnumerable(Of Book))
    
    ' ID指定で書籍取得
    Function GetByIdAsync(id As Integer) As Task(Of Book)
    
    ' 条件検索
    Function SearchAsync(searchTerm As String) As Task(Of IEnumerable(Of Book))
    
    ' 新規追加
    Function AddAsync(book As Book) As Task
    
    ' 更新
    Function UpdateAsync(book As Book) As Task
    
    ' 削除
    Function DeleteAsync(id As Integer) As Task(Of Boolean)
    
    ' 存在確認
    Function ExistsAsync(id As Integer) As Task(Of Boolean)
End Interface</code></pre>
                        
                        <h6>BookRepository.vb実装</h6>
                        <pre class="code-block"><code class="language-vbnet">Imports Microsoft.EntityFrameworkCore

Public Class BookRepository
    Implements IBookRepository
    
    Private ReadOnly _context As BookStoreContext
    
    Public Sub New(context As BookStoreContext)
        _context = context
    End Sub
    
    Public Async Function GetAllAsync() As Task(Of IEnumerable(Of Book)) Implements IBookRepository.GetAllAsync
        Return Await _context.Books.
            OrderByDescending(Function(b) b.CreatedDate).
            ToListAsync()
    End Function
    
    Public Async Function GetByIdAsync(id As Integer) As Task(Of Book) Implements IBookRepository.GetByIdAsync
        Return Await _context.Books.FindAsync(id)
    End Function
    
    Public Async Function SearchAsync(searchTerm As String) As Task(Of IEnumerable(Of Book)) Implements IBookRepository.SearchAsync
        If String.IsNullOrWhiteSpace(searchTerm) Then
            Return Await GetAllAsync()
        End If
        
        Return Await _context.Books.
            Where(Function(b) b.Title.Contains(searchTerm) OrElse 
                             b.Author.Contains(searchTerm) OrElse
                             b.Isbn.Contains(searchTerm)).
            OrderByDescending(Function(b) b.CreatedDate).
            ToListAsync()
    End Function
    
    Public Async Function AddAsync(book As Book) As Task Implements IBookRepository.AddAsync
        book.CreatedDate = DateTime.Now
        _context.Books.Add(book)
        Await _context.SaveChangesAsync()
    End Function
    
    Public Async Function UpdateAsync(book As Book) As Task Implements IBookRepository.UpdateAsync
        _context.Entry(book).State = EntityState.Modified
        Await _context.SaveChangesAsync()
    End Function
    
    Public Async Function DeleteAsync(id As Integer) As Task(Of Boolean) Implements IBookRepository.DeleteAsync
        Dim book = Await _context.Books.FindAsync(id)
        If book Is Nothing Then
            Return False
        End If
        
        _context.Books.Remove(book)
        Await _context.SaveChangesAsync()
        Return True
    End Function
    
    Public Async Function ExistsAsync(id As Integer) As Task(Of Boolean) Implements IBookRepository.ExistsAsync
        Return Await _context.Books.AnyAsync(Function(b) b.Id = id)
    End Function
End Class</code></pre>
                        
                        <h6>Program.vbでの依存性注入登録</h6>
                        <pre class="code-block"><code class="language-vbnet">' サービスの登録
builder.Services.AddControllersWithViews()

' Entity Framework Coreの設定
builder.Services.AddDbContext(Of BookStoreContext)(
    Sub(options)
        options.UseSqlServer(
            builder.Configuration.GetConnectionString("DefaultConnection")
        )
    End Sub
)

' リポジトリの依存性注入登録
builder.Services.AddScoped(Of IBookRepository, BookRepository)</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>リポジトリパターンが実装され、データアクセスロジックがビジネスロジックから分離されます。これにより、テストの実装が容易になり、将来のデータアクセス技術変更に対する柔軟性が向上します。</p>
                    </div>

                    <!-- セクション 6.7: エラーハンドリングとトランザクション -->
                    <h3 class="section-title">6.7 エラーハンドリングとトランザクション</h3>
                    <p>データベース操作では、常にエラーの可能性を考慮し、データの整合性を保つためのトランザクション制御が重要です。Entity Framework Coreは、これらの機能を簡潔に実装する方法を提供します。</p>

                    <h4>一般的なデータベースエラー</h4>
                    <ul>
                        <li><strong>接続エラー</strong>: データベースサーバーへの接続失敗</li>
                        <li><strong>制約違反</strong>: 一意制約、外部キー制約の違反</li>
                        <li><strong>タイムアウト</strong>: クエリ実行時間の超過</li>
                        <li><strong>同時実行の競合</strong>: 複数のユーザーが同じデータを更新</li>
                    </ul>

                    <div class="warning">
                        <h6>トランザクション管理の重要性</h6>
                        <p>複数のデータベース操作を一つの処理単位として扱う場合、すべてが成功するか、すべてが失敗するかのいずれかの状態を保証する必要があります。これをACID特性（原子性、一貫性、独立性、永続性）と呼びます。</p>
                    </div>

                    <!-- 実習 6-6 -->
                    <div class="exercise-container">
                        <h5>実習 6-6: エラーハンドリングとトランザクションの実装</h5>
                        <p>書籍の注文処理を例に、エラーハンドリングとトランザクション制御を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>注文エンティティクラスを作成</li>
                            <li>トランザクション処理を含む注文サービスを実装</li>
                            <li>適切なエラーハンドリングを追加</li>
                            <li>ロールバック機能を実装</li>
                        </ol>
                        
                        <h6>Order.vbエンティティ</h6>
                        <pre class="code-block"><code class="language-vbnet">Imports System.ComponentModel.DataAnnotations

Public Class Order
    Public Property Id As Integer
    
    &lt;Required&gt;
    &lt;MaxLength(100)&gt;
    Public Property CustomerName As String
    
    &lt;Required&gt;
    &lt;EmailAddress&gt;
    Public Property CustomerEmail As String
    
    Public Property BookId As Integer
    Public Property Book As Book  ' ナビゲーションプロパティ
    
    &lt;Range(1, Integer.MaxValue)&gt;
    Public Property Quantity As Integer
    
    Public Property UnitPrice As Decimal
    Public Property TotalAmount As Decimal
    
    Public Property OrderDate As DateTime
    Public Property Status As String
End Class</code></pre>
                        
                        <h6>OrderService.vbの実装</h6>
                        <pre class="code-block"><code class="language-vbnet">Imports Microsoft.EntityFrameworkCore
Imports Microsoft.EntityFrameworkCore.Storage

Public Class OrderService
    Private ReadOnly _context As BookStoreContext
    Private ReadOnly _logger As ILogger(Of OrderService)
    
    Public Sub New(context As BookStoreContext, logger As ILogger(Of OrderService))
        _context = context
        _logger = logger
    End Sub
    
    Public Async Function CreateOrderAsync(customerName As String, customerEmail As String, 
                                         bookId As Integer, quantity As Integer) As Task(Of Boolean)
        ' トランザクション開始
        Using transaction = Await _context.Database.BeginTransactionAsync()
            Try
                ' 1. 書籍の存在確認と価格取得
                Dim book = Await _context.Books.FindAsync(bookId)
                If book Is Nothing Then
                    _logger.LogWarning($"書籍ID {bookId} が見つかりません")
                    Return False
                End If
                
                ' 2. 注文の作成
                Dim order As New Order With {
                    .CustomerName = customerName,
                    .CustomerEmail = customerEmail,
                    .BookId = bookId,
                    .Quantity = quantity,
                    .UnitPrice = book.Price,
                    .TotalAmount = book.Price * quantity,
                    .OrderDate = DateTime.Now,
                    .Status = "処理中"
                }
                
                ' 3. 注文をデータベースに追加
                _context.Orders.Add(order)
                Await _context.SaveChangesAsync()
                
                ' 4. 在庫確認（仮想的な処理）
                If Not Await CheckStockAsync(bookId, quantity) Then
                    Throw New InvalidOperationException("在庫が不足しています")
                End If
                
                ' 5. 在庫更新（仮想的な処理）
                Await UpdateStockAsync(bookId, quantity)
                
                ' 6. 注文ステータス更新
                order.Status = "確定"
                Await _context.SaveChangesAsync()
                
                ' トランザクション確定
                Await transaction.CommitAsync()
                
                _logger.LogInformation($"注文が正常に作成されました。注文ID: {order.Id}")
                Return True
                
            Catch ex As DbUpdateException
                ' データベース更新エラー
                Await transaction.RollbackAsync()
                _logger.LogError(ex, "データベース更新中にエラーが発生しました")
                Return False
                
            Catch ex As InvalidOperationException
                ' ビジネスルール違反
                Await transaction.RollbackAsync()
                _logger.LogError(ex, "注文処理中にビジネスルール違反が発生しました")
                Return False
                
            Catch ex As Exception
                ' その他の予期しないエラー
                Await transaction.RollbackAsync()
                _logger.LogError(ex, "予期しないエラーが発生しました")
                Return False
            End Try
        End Using
    End Function
    
    Private Async Function CheckStockAsync(bookId As Integer, quantity As Integer) As Task(Of Boolean)
        ' 在庫確認のシミュレーション
        ' 実際のシステムでは在庫テーブルから確認
        Await Task.Delay(100)  ' 非同期処理のシミュレーション
        Return quantity <= 10  ' 10冊以下なら在庫ありとする
    End Function
    
    Private Async Function UpdateStockAsync(bookId As Integer, quantity As Integer) As Task
        ' 在庫更新のシミュレーション
        ' 実際のシステムでは在庫テーブルを更新
        Await Task.Delay(50)
    End Function
End Class</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>トランザクション制御により、すべての処理が成功した場合のみデータベースに変更が確定されます。エラーが発生した場合は、自動的にロールバックされ、データの整合性が保たれます。</p>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>Entity Framework Coreの主な利点を3つ説明してください。</strong>
                                <p class="text-muted mt-2">ヒント: ADO.NETとの比較、開発効率、保守性の観点から考えてみましょう。</p>
                            </li>
                            
                            <li>
                                <strong>Code Firstアプローチとは何か、そのメリットを説明してください。</strong>
                                <p class="text-muted mt-2">ヒント: 設計の中心、バージョン管理、チーム開発の観点から考えてみましょう。</p>
                            </li>
                            
                            <li>
                                <strong>DbContextの主要な責任を4つ挙げてください。</strong>
                                <p class="text-muted mt-2">ヒント: データベース接続、エンティティ管理、クエリ処理の観点から考えてみましょう。</p>
                            </li>
                            
                            <li>
                                <strong>マイグレーションが必要な理由と、基本的なワークフローを説明してください。</strong>
                                <p class="text-muted mt-2">ヒント: データベーススキーマの変更管理と本番環境への適用について考えてみましょう。</p>
                            </li>
                            
                            <li>
                                <strong>リポジトリパターンを使用する利点を具体例と共に説明してください。</strong>
                                <p class="text-muted mt-2">ヒント: テスタビリティ、関心の分離、保守性の向上について考えてみましょう。</p>
                            </li>
                            
                            <li>
                                <strong>以下のLINQクエリが生成するSQLの概要を説明してください：</strong>
                                <pre class="code-block"><code class="language-vbnet">Dim result = Await _context.Books.
    Where(Function(b) b.Price > 1000).
    OrderBy(Function(b) b.Title).
    Select(Function(b) New With {
        .Title = b.Title,
        .Author = b.Author
    }).
    ToListAsync()</code></pre>
                                <p class="text-muted mt-2">ヒント: SELECT、WHERE、ORDER BY句を使用したSQLクエリが生成されます。</p>
                            </li>
                        </ol>
                        
                        <div class="mt-4">
                            <h6>実践課題</h6>
                            <p>以下の要件を満たす書籍管理システムの一部を実装してみてください：</p>
                            <ul>
                                <li>著者エンティティ（Author）を追加し、書籍との1対多の関係を設定</li>
                                <li>カテゴリエンティティ（Category）を追加し、書籍との多対多の関係を設定</li>
                                <li>複雑な検索機能（著者名、カテゴリ、価格帯での絞り込み）を実装</li>
                                <li>適切なエラーハンドリングとログ記録を含む</li>
                            </ul>
                        </div>
                    </div>

                    <!-- まとめ -->
                    <div class="highlight">
                        <h5>第6章のまとめ</h5>
                        <p>この章では、Entity Framework Coreを使用したデータアクセスの基本から応用まで学習しました。</p>
                        <ul>
                            <li><strong>EF Coreの基礎</strong>: ORMの概念とADO.NETとの違いを理解</li>
                            <li><strong>Code Firstアプローチ</strong>: エンティティクラスからデータベースを生成する手法</li>
                            <li><strong>DbContextの活用</strong>: データベースとの中心的なインターフェース</li>
                            <li><strong>マイグレーション管理</strong>: データベーススキーマのバージョン管理</li>
                            <li><strong>LINQ to Entities</strong>: 型安全なクエリの記述方法</li>
                            <li><strong>リポジトリパターン</strong>: データアクセスロジックの抽象化</li>
                            <li><strong>エラーハンドリング</strong>: 堅牢なアプリケーションの構築</li>
                        </ul>
                        <p>次章では、これらの知識を活用してWeb APIを開発し、フロントエンドとの連携方法を学習します。</p>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnetcore-vb-learning-material-05.html" class="btn btn-secondary">← 第5章: 依存性注入とミドルウェア</a>
                        <a href="aspnetcore-vb-learning-material-07.html" class="btn btn-primary">第7章: Web APIの開発 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>