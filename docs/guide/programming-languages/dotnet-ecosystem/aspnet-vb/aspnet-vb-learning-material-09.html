<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET（VB.NET）学習教材 第9章 - セキュリティとメンバーシップ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #512da8;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .chapter-title {
            color: #512da8;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #512da8;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #673ab7;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .quiz-container {
            background-color: #ede7f6;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #512da8;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .nav-link.active {
            background-color: #512da8 !important;
            color: white !important;
        }

        .security-alert {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f39c12;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>ASP.NET（VB.NET）学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-01.html">
                                第1章: ASP.NET Web Forms入門と開発環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-02.html">
                                第2章: Web FormsとWebコントロール
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-03.html">
                                第3章: イベント処理とPostBack
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-04.html">
                                第4章: データ検証とエラーハンドリング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-05.html">
                                第5章: 状態管理（Session、ViewState、Cache）
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-06.html">
                                第6章: データベース連携（ADO.NET）
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-07.html">
                                第7章: データバインドとGridView
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-08.html">
                                第8章: マスターページとナビゲーション
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aspnet-vb-learning-material-09.html">
                                第9章: セキュリティとメンバーシップ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-10.html">
                                第10章: 実践的なWebアプリケーション開発
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第9章: セキュリティとメンバーシップ</h1>
                </div>

                <div id="chapter9">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">安全で信頼性の高いWebアプリケーションの構築</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Webアプリケーションセキュリティの基本概念と脅威を理解する</li>
                            <li>ASP.NETメンバーシップシステムによる認証・認可機能を習得する</li>
                            <li>ログインコントロールとロールベースアクセス制御の実装方法を学ぶ</li>
                            <li>パスワードハッシュ化とセキュアなデータ保存方法を理解する</li>
                            <li>XSS、CSRF、SQLインジェクション等の主要攻撃への対策を習得する</li>
                            <li>セッション管理とセキュリティベストプラクティスを実装する</li>
                        </ul>
                    </div>

                    <!-- セクション1: Webセキュリティの基本概念 -->
                    <h3 class="section-title">9.1 Webセキュリティの基本概念</h3>
                    
                    <p><strong>Webアプリケーションセキュリティ</strong>は、現代のIT社会において最も重要な技術領域の一つです。インターネットに公開されるWebアプリケーションは、世界中からの様々な攻撃に晒される可能性があり、適切なセキュリティ対策なしには安全な運用は不可能です。</p>
                    
                    <div class="warning">
                        <h6>なぜWebセキュリティが重要なのか？</h6>
                        <p><strong>現実的な脅威の例：</strong></p>
                        <ul>
                            <li><strong>情報漏洩</strong>：顧客情報、個人情報、企業機密の流出</li>
                            <li><strong>金銭的被害</strong>：不正取引、システム復旧費用、信頼失墜による売上減少</li>
                            <li><strong>法的責任</strong>：個人情報保護法違反、GDPR違反による高額制裁金</li>
                            <li><strong>業務停止</strong>：サイバー攻撃によるサービス停止、復旧までの機会損失</li>
                            <li><strong>信用失墜</strong>：ブランドイメージの悪化、顧客離れ</li>
                        </ul>
                    </div>

                    <div class="highlight">
                        <h6>セキュリティの三要素（CIA Triad）</h6>
                        <ul>
                            <li><strong>機密性（Confidentiality）</strong>：権限のない者がデータにアクセスできないようにする</li>
                            <li><strong>完全性（Integrity）</strong>：データが改ざんされないことを保証する</li>
                            <li><strong>可用性（Availability）</strong>：必要な時にシステムが利用可能であることを保証する</li>
                        </ul>
                    </div>

                    <!-- Web脅威の分類図 -->
                    <div class="mermaid">
                        graph TD
                            A[Webアプリケーション脅威] --> B[インジェクション攻撃]
                            A --> C[認証・認可の脆弱性]
                            A --> D[機密データの露出]
                            A --> E[セッション管理の欠陥]
                            
                            B --> B1[SQLインジェクション]
                            B --> B2[XSS攻撃]
                            B --> B3[コマンドインジェクション]
                            
                            C --> C1[弱いパスワード]
                            C --> C2[セッション固定化]
                            C --> C3[権限昇格]
                            
                            D --> D1[暗号化不備]
                            D --> D2[機密情報の露出]
                            D --> D3[通信の盗聴]
                            
                            E --> E1[CSRF攻撃]
                            E --> E2[セッションハイジャック]
                            E --> E3[セッションタイムアウト不備]
                    </div>

                    <!-- セクション2: 認証と認可の理論 -->
                    <h3 class="section-title">9.2 認証と認可の理論</h3>
                    
                    <p>セキュリティシステムの基盤となるのが<strong>認証（Authentication）</strong>と<strong>認可（Authorization）</strong>です。これらは似た言葉ですが、全く異なる概念であり、両方が適切に実装されて初めて安全なシステムが構築されます。</p>

                    <div class="highlight">
                        <h6>認証 vs 認可</h6>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>概念</th>
                                    <th>英語</th>
                                    <th>目的</th>
                                    <th>確認内容</th>
                                    <th>実装例</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>認証</strong></td>
                                    <td>Authentication</td>
                                    <td>本人確認</td>
                                    <td>「誰なのか？」</td>
                                    <td>ID/パスワード、生体認証</td>
                                </tr>
                                <tr>
                                    <td><strong>認可</strong></td>
                                    <td>Authorization</td>
                                    <td>アクセス制御</td>
                                    <td>「何ができるか？」</td>
                                    <td>ロールベース制御、ACL</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p><strong>具体例で理解する認証と認可：</strong></p>
                    <p>オフィスビルへの入館を例に考えてみましょう：</p>
                    <ul>
                        <li><strong>認証</strong>：入口で社員証をスキャンして「あなたは田中さんですね」と本人確認</li>
                        <li><strong>認可</strong>：田中さんの権限を確認して「田中さんは3階の開発部フロアにアクセス可能です」</li>
                    </ul>

                    <!-- 認証・認可フロー図 -->
                    <div class="mermaid">
                        sequenceDiagram
                            participant User as ユーザー
                            participant Auth as 認証システム
                            participant Authz as 認可システム
                            participant Resource as リソース
                            
                            User->>Auth: ログイン情報送信
                            Auth->>Auth: 認証情報検証
                            Auth-->>User: 認証成功 (認証トークン発行)
                            
                            User->>Authz: リソースアクセス要求
                            Authz->>Authz: ユーザー権限チェック
                            Authz-->>User: 認可成功
                            
                            User->>Resource: リソースアクセス
                            Resource-->>User: リソース提供
                    </div>

                    <!-- セクション3: ASP.NETメンバーシップシステム -->
                    <h3 class="section-title">9.3 ASP.NETメンバーシップシステム</h3>
                    
                    <p><strong>ASP.NETメンバーシップシステム</strong>は、Webアプリケーションでユーザー管理、認証、認可を簡単に実装するためのフレームワークです。開発者がセキュリティの詳細な実装に悩まされることなく、堅牢な認証システムを構築できます。</p>

                    <div class="highlight">
                        <h6>メンバーシップシステムの提供機能</h6>
                        <ul>
                            <li><strong>ユーザー管理</strong>：ユーザー登録、削除、プロファイル管理</li>
                            <li><strong>パスワード管理</strong>：安全なハッシュ化、パスワードリセット、複雑性検証</li>
                            <li><strong>ロール管理</strong>：ユーザーグループ、権限の階層管理</li>
                            <li><strong>ログインコントロール</strong>：ログインUI、ログアウト、認証状態表示</li>
                            <li><strong>セッション管理</strong>：認証状態の維持、タイムアウト処理</li>
                        </ul>
                    </div>

                    <!-- 実習1: メンバーシップシステムの設定 -->
                    <div class="exercise-container">
                        <h5>実習 9-1: メンバーシップシステムの基本設定</h5>
                        <p>ASP.NETメンバーシップシステムを設定し、基本的なユーザー管理機能を実装してみましょう。</p>
                        
                        <h6>手順1: web.config でのメンバーシップ設定</h6>
                        <pre class="code-block"><code class="language-xml">&lt;configuration&gt;
  &lt;connectionStrings&gt;
    &lt;add name="ApplicationServices" 
         connectionString="Server=(localdb)\MSSQLLocalDB;Database=MembershipDB;Integrated Security=true" 
         providerName="System.Data.SqlClient" /&gt;
  &lt;/connectionStrings&gt;

  &lt;system.web&gt;
    &lt;!-- 認証モードの設定 --&gt;
    &lt;authentication mode="Forms"&gt;
      &lt;forms loginUrl="~/Account/Login.aspx" 
             timeout="30" 
             name=".ASPXAUTH" 
             protection="All" 
             requireSSL="false" 
             cookieless="false" /&gt;
    &lt;/authentication&gt;

    &lt;!-- メンバーシッププロバイダーの設定 --&gt;
    &lt;membership defaultProvider="AspNetSqlMembershipProvider"&gt;
      &lt;providers&gt;
        &lt;clear /&gt;
        &lt;add name="AspNetSqlMembershipProvider" 
             type="System.Web.Security.SqlMembershipProvider" 
             connectionStringName="ApplicationServices" 
             enablePasswordRetrieval="false" 
             enablePasswordReset="true" 
             requiresQuestionAndAnswer="false" 
             requiresUniqueEmail="true" 
             maxInvalidPasswordAttempts="5" 
             minRequiredPasswordLength="6" 
             minRequiredNonalphanumericCharacters="0" 
             passwordAttemptWindow="10" 
             applicationName="/" /&gt;
      &lt;/providers&gt;
    &lt;/membership&gt;

    &lt;!-- ロールプロバイダーの設定 --&gt;
    &lt;roleManager enabled="true" defaultProvider="AspNetSqlRoleProvider"&gt;
      &lt;providers&gt;
        &lt;clear /&gt;
        &lt;add name="AspNetSqlRoleProvider" 
             type="System.Web.Security.SqlRoleProvider" 
             connectionStringName="ApplicationServices" 
             applicationName="/" /&gt;
      &lt;/providers&gt;
    &lt;/roleManager&gt;

    &lt;!-- プロファイルの設定 --&gt;
    &lt;profile defaultProvider="AspNetSqlProfileProvider"&gt;
      &lt;providers&gt;
        &lt;clear /&gt;
        &lt;add name="AspNetSqlProfileProvider" 
             type="System.Web.Profile.SqlProfileProvider" 
             connectionStringName="ApplicationServices" 
             applicationName="/" /&gt;
      &lt;/providers&gt;
      &lt;properties&gt;
        &lt;add name="FirstName" type="System.String" /&gt;
        &lt;add name="LastName" type="System.String" /&gt;
        &lt;add name="CompanyName" type="System.String" /&gt;
        &lt;add name="PhoneNumber" type="System.String" /&gt;
      &lt;/properties&gt;
    &lt;/profile&gt;

    &lt;!-- 認証が必要なディレクトリの設定例 --&gt;
    &lt;authorization&gt;
      &lt;allow users="*" /&gt; &lt;!-- すべてのユーザーにアクセス許可（パブリックページ） --&gt;
    &lt;/authorization&gt;

  &lt;/system.web&gt;

  &lt;!-- 管理者専用ディレクトリ --&gt;
  &lt;location path="Admin"&gt;
    &lt;system.web&gt;
      &lt;authorization&gt;
        &lt;allow roles="Administrator" /&gt;
        &lt;deny users="*" /&gt;
      &lt;/authorization&gt;
    &lt;/system.web&gt;
  &lt;/location&gt;

  &lt;!-- メンバー専用ディレクトリ --&gt;
  &lt;location path="Members"&gt;
    &lt;system.web&gt;
      &lt;authorization&gt;
        &lt;allow roles="Administrator,Member" /&gt;
        &lt;deny users="?" /&gt; &lt;!-- 匿名ユーザーを拒否 --&gt;
      &lt;/authorization&gt;
    &lt;/system.web&gt;
  &lt;/location&gt;
&lt;/configuration&gt;</code></pre>

                        <h6>手順2: データベースの準備</h6>
                        <p>Visual StudioのServer Explorerまたはaspnet_regsql.exeツールを使用してメンバーシップデータベースを作成します。</p>

                        <pre class="code-block"><code class="language-bash"># コマンドプロンプトで実行（Visual Studio Developer Command Prompt）
aspnet_regsql -S (localdb)\MSSQLLocalDB -E -A all -d MembershipDB</code></pre>

                        <h6>手順3: 初期ロールとユーザーの作成</h6>
                        <pre class="code-block"><code class="language-vbnet">
' Global.asax.vb の Application_Start イベントで初期データ作成
Protected Sub Application_Start()
    CreateInitialRolesAndUsers()
End Sub

Private Sub CreateInitialRolesAndUsers()
    ' ロールが存在しない場合は作成
    If Not Roles.RoleExists("Administrator") Then
        Roles.CreateRole("Administrator")
    End If
    
    If Not Roles.RoleExists("Member") Then
        Roles.CreateRole("Member")
    End If
    
    If Not Roles.RoleExists("Guest") Then
        Roles.CreateRole("Guest")
    End If
    
    ' 管理者ユーザーが存在しない場合は作成
    If Membership.GetUser("admin") Is Nothing Then
        Dim user As MembershipUser = Membership.CreateUser("admin", "Password123!", "admin@company.com")
        If user IsNot Nothing Then
            Roles.AddUserToRole("admin", "Administrator")
        End If
    End If
End Sub</code></pre>

                        <h6>重要な設定項目の説明</h6>
                        <ul>
                            <li><strong>minRequiredPasswordLength</strong>：パスワードの最小文字数</li>
                            <li><strong>maxInvalidPasswordAttempts</strong>：アカウントロックまでの失敗回数</li>
                            <li><strong>requiresUniqueEmail</strong>：メールアドレスの重複を許可しない</li>
                            <li><strong>passwordAttemptWindow</strong>：パスワード試行のリセット時間（分）</li>
                        </ul>
                    </div>

                    <!-- セクション4: ログインシステムの実装 -->
                    <h3 class="section-title">9.4 ログインシステムの実装</h3>
                    
                    <p>メンバーシップシステムの設定が完了したら、実際のログイン機能を実装します。ASP.NETには便利な<strong>Loginコントロール</strong>が用意されており、複雑なコードを書かずに堅牢なログイン機能を実装できます。</p>

                    <!-- 実習2: ログイン画面の実装 -->
                    <div class="exercise-container">
                        <h5>実習 9-2: 包括的なログインシステムの実装</h5>
                        <p>ユーザーフレンドリーで安全なログイン画面を作成し、認証後の処理まで実装してみましょう。</p>
                        
                        <h6>Account/Login.aspx</h6>
                        <pre class="code-block"><code class="language-html">&lt;%@ Page Language="VB" MasterPageFile="~/Site.master" AutoEventWireup="false" CodeBehind="Login.aspx.vb" Inherits="CompanySite.Login" %&gt;

&lt;asp:Content ID="Content1" ContentPlaceHolderID="TitleContent" Runat="Server"&gt;
    ログイン
&lt;/asp:Content&gt;

&lt;asp:Content ID="Content2" ContentPlaceHolderID="HeadContent" Runat="Server"&gt;
    &lt;style&gt;
        .login-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
            color: #512da8;
        }
        .remember-me {
            margin: 1rem 0;
        }
        .login-links {
            text-align: center;
            margin-top: 1rem;
        }
        .login-links a {
            margin: 0 0.5rem;
            text-decoration: none;
        }
    &lt;/style&gt;
&lt;/asp:Content&gt;

&lt;asp:Content ID="Content3" ContentPlaceHolderID="MainContent" Runat="Server"&gt;
    &lt;div class="login-container"&gt;
        &lt;div class="login-header"&gt;
            &lt;h2&gt;&lt;i class="fas fa-user-lock"&gt;&lt;/i&gt; ログイン&lt;/h2&gt;
            &lt;p class="text-muted"&gt;アカウントにログインしてください&lt;/p&gt;
        &lt;/div&gt;

        &lt;asp:Login ID="LoginUser" runat="server" 
                   EnableViewState="false" 
                   RenderOuterTable="false"
                   OnAuthenticate="LoginUser_Authenticate"
                   OnLoggedIn="LoginUser_LoggedIn"
                   OnLoginError="LoginUser_LoginError"&gt;
            
            &lt;LayoutTemplate&gt;
                &lt;div class="form-group mb-3"&gt;
                    &lt;label for="&lt;%=LoginUser.FindControl("UserName").ClientID%&gt;" class="form-label"&gt;
                        &lt;i class="fas fa-user"&gt;&lt;/i&gt; ユーザー名またはメールアドレス
                    &lt;/label&gt;
                    &lt;asp:TextBox ID="UserName" runat="server" CssClass="form-control" 
                                 placeholder="ユーザー名を入力" TabIndex="1" /&gt;
                    &lt;asp:RequiredFieldValidator ID="UserNameRequired" runat="server" 
                                                ControlToValidate="UserName" 
                                                ErrorMessage="ユーザー名は必須です。" 
                                                CssClass="text-danger small" /&gt;
                &lt;/div&gt;

                &lt;div class="form-group mb-3"&gt;
                    &lt;label for="&lt;%=LoginUser.FindControl("Password").ClientID%&gt;" class="form-label"&gt;
                        &lt;i class="fas fa-lock"&gt;&lt;/i&gt; パスワード
                    &lt;/label&gt;
                    &lt;asp:TextBox ID="Password" runat="server" TextMode="Password" 
                                 CssClass="form-control" placeholder="パスワードを入力" TabIndex="2" /&gt;
                    &lt;asp:RequiredFieldValidator ID="PasswordRequired" runat="server" 
                                                ControlToValidate="Password" 
                                                ErrorMessage="パスワードは必須です。" 
                                                CssClass="text-danger small" /&gt;
                &lt;/div&gt;

                &lt;div class="remember-me"&gt;
                    &lt;div class="form-check"&gt;
                        &lt;asp:CheckBox ID="RememberMe" runat="server" CssClass="form-check-input" TabIndex="3" /&gt;
                        &lt;label class="form-check-label" for="&lt;%=LoginUser.FindControl("RememberMe").ClientID%&gt;"&gt;
                            ログイン状態を記憶する
                        &lt;/label&gt;
                    &lt;/div&gt;
                &lt;/div&gt;

                &lt;div class="d-grid"&gt;
                    &lt;asp:Button ID="LoginButton" runat="server" CommandName="Login" 
                                Text="ログイン" CssClass="btn btn-primary" TabIndex="4" /&gt;
                &lt;/div&gt;

                &lt;asp:Literal ID="FailureText" runat="server" EnableViewState="False"&gt;&lt;/asp:Literal&gt;
            &lt;/LayoutTemplate&gt;
        &lt;/asp:Login&gt;

        &lt;div class="login-links"&gt;
            &lt;a href="Register.aspx" class="btn btn-outline-secondary btn-sm"&gt;新規登録&lt;/a&gt;
            &lt;a href="ForgotPassword.aspx" class="btn btn-link btn-sm"&gt;パスワードを忘れた方&lt;/a&gt;
        &lt;/div&gt;
        
        &lt;!-- セキュリティ情報表示 --&gt;
        &lt;div class="alert alert-info mt-3 small"&gt;
            &lt;i class="fas fa-info-circle"&gt;&lt;/i&gt; 
            セキュリティのため、&lt;asp:Label ID="lblMaxAttempts" runat="server"&gt;&lt;/asp:Label&gt;回間違えるとアカウントがロックされます。
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/asp:Content&gt;</code></pre>

                        <h6>Login.aspx.vb（コードビハインド）</h6>
                        <pre class="code-block"><code class="language-vbnet">
Partial Class Login
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        ' セキュリティ設定情報を表示
        lblMaxAttempts.Text = Membership.MaxInvalidPasswordAttempts.ToString()
        
        ' 既にログイン済みの場合はリダイレクト
        If User.Identity.IsAuthenticated Then
            RedirectToReturnUrl()
        End If
    End Sub

    Protected Sub LoginUser_Authenticate(sender As Object, e As AuthenticateEventArgs) Handles LoginUser.Authenticate
        Dim username As String = LoginUser.UserName.Trim()
        Dim password As String = LoginUser.Password
        
        ' カスタム認証ロジック（必要に応じて）
        If ValidateUser(username, password) Then
            e.Authenticated = True
        Else
            e.Authenticated = False
            LogFailedLoginAttempt(username)
        End If
    End Sub

    Protected Sub LoginUser_LoggedIn(sender As Object, e As EventArgs) Handles LoginUser.LoggedIn
        ' ログイン成功時の処理
        LogSuccessfulLogin(LoginUser.UserName)
        
        ' ユーザープロファイル情報を取得
        Dim user As MembershipUser = Membership.GetUser(LoginUser.UserName)
        If user IsNot Nothing Then
            ' 最終ログイン日時を更新
            user.LastLoginDate = DateTime.Now
            Membership.UpdateUser(user)
            
            ' セッションに基本情報を保存
            Session("UserID") = user.ProviderUserKey
            Session("UserName") = user.UserName
            Session("Email") = user.Email
            Session("LastLogin") = user.LastLoginDate
            
            ' ユーザーロールを取得してセッションに保存
            Dim roles() As String = Roles.GetRolesForUser(user.UserName)
            Session("UserRoles") = roles
        End If
        
        RedirectToReturnUrl()
    End Sub

    Protected Sub LoginUser_LoginError(sender As Object, e As EventArgs) Handles LoginUser.LoginError
        ' ログインエラー時のカスタムメッセージ
        Dim failureText As Literal = CType(LoginUser.FindControl("FailureText"), Literal)
        
        ' ユーザーの状態を確認
        Dim user As MembershipUser = Membership.GetUser(LoginUser.UserName)
        If user IsNot Nothing Then
            If user.IsLockedOut Then
                failureText.Text = "&lt;div class='alert alert-warning mt-3'&gt;&lt;i class='fas fa-exclamation-triangle'&gt;&lt;/i&gt; アカウントがロックされています。管理者にお問い合わせください。&lt;/div&gt;"
            ElseIf Not user.IsApproved Then
                failureText.Text = "&lt;div class='alert alert-warning mt-3'&gt;&lt;i class='fas fa-exclamation-triangle'&gt;&lt;/i&gt; アカウントが承認されていません。&lt;/div&gt;"
            Else
                failureText.Text = "&lt;div class='alert alert-danger mt-3'&gt;&lt;i class='fas fa-times-circle'&gt;&lt;/i&gt; ユーザー名またはパスワードが正しくありません。&lt;/div&gt;"
            End If
        Else
            failureText.Text = "&lt;div class='alert alert-danger mt-3'&gt;&lt;i class='fas fa-times-circle'&gt;&lt;/i&gt; ユーザー名またはパスワードが正しくありません。&lt;/div&gt;"
        End If
    End Sub

    Private Function ValidateUser(username As String, password As String) As Boolean
        Try
            ' ASP.NETメンバーシップによる認証
            Return Membership.ValidateUser(username, password)
        Catch ex As Exception
            ' ログエラーを記録
            LogError("Login validation error", ex)
            Return False
        End Try
    End Function

    Private Sub RedirectToReturnUrl()
        Dim returnUrl As String = Request.QueryString("ReturnUrl")
        
        If Not String.IsNullOrEmpty(returnUrl) AndAlso IsLocalUrl(returnUrl) Then
            Response.Redirect(returnUrl)
        Else
            ' デフォルトのリダイレクト先をロールに応じて決定
            Dim roles() As String = Roles.GetRolesForUser(User.Identity.Name)
            If roles.Contains("Administrator") Then
                Response.Redirect("~/Admin/Dashboard.aspx")
            ElseIf roles.Contains("Member") Then
                Response.Redirect("~/Members/Dashboard.aspx")
            Else
                Response.Redirect("~/Default.aspx")
            End If
        End If
    End Sub

    Private Function IsLocalUrl(url As String) As Boolean
        ' セキュリティ：オープンリダイレクト攻撃を防ぐ
        Return Not String.IsNullOrEmpty(url) AndAlso 
               ((url.StartsWith("/") AndAlso Not url.StartsWith("//")) OrElse 
                (url.StartsWith("~/") AndAlso Not url.Contains("../")))
    End Function

    Private Sub LogSuccessfulLogin(username As String)
        ' ログイン成功をログに記録（実装例）
        Dim logEntry As String = String.Format("Successful login: User={0}, IP={1}, Time={2}", 
                                               username, 
                                               Request.UserHostAddress, 
                                               DateTime.Now)
        ' 実際のログ実装（ファイル、データベース、EventLogなど）
    End Sub

    Private Sub LogFailedLoginAttempt(username As String)
        ' ログイン失敗をログに記録
        Dim logEntry As String = String.Format("Failed login attempt: User={0}, IP={1}, Time={2}", 
                                               username, 
                                               Request.UserHostAddress, 
                                               DateTime.Now)
        ' 実際のログ実装
    End Sub

    Private Sub LogError(message As String, ex As Exception)
        ' エラーログの記録
        ' 実装例：データベース、ファイル、Application EventLogへの記録
    End Sub
End Class</code></pre>

                        <h6>セキュリティ機能のポイント</h6>
                        <ul>
                            <li><strong>アカウントロックアウト</strong>：規定回数失敗でアカウント無効化</li>
                            <li><strong>オープンリダイレクト対策</strong>：不正なURLへのリダイレクトを防止</li>
                            <li><strong>ログイン履歴記録</strong>：セキュリティ監査のための記録</li>
                            <li><strong>ロール別リダイレクト</strong>：権限に応じた適切なページへの誘導</li>
                        </ul>
                    </div>

                    <!-- セクション5: ロールベースアクセス制御 -->
                    <h3 class="section-title">9.5 ロールベースアクセス制御（RBAC）</h3>
                    
                    <p><strong>ロールベースアクセス制御（Role-Based Access Control: RBAC）</strong>は、ユーザーの役割（ロール）に基づいてシステムリソースへのアクセスを制御するセキュリティモデルです。個々のユーザーに権限を付与するのではなく、ロールに権限を付与し、ユーザーをロールに割り当てることで、効率的で保守しやすいアクセス制御を実現します。</p>

                    <div class="highlight">
                        <h6>RBAC の利点</h6>
                        <ul>
                            <li><strong>管理の簡素化</strong>：個別ユーザーではなくロール単位での権限管理</li>
                            <li><strong>最小権限の原則</strong>：必要最小限の権限のみ付与</li>
                            <li><strong>職務分離</strong>：異なるロール間での責任の明確化</li>
                            <li><strong>スケーラビリティ</strong>：大規模組織での権限管理が容易</li>
                            <li><strong>コンプライアンス</strong>：監査要件への対応</li>
                        </ul>
                    </div>

                    <!-- RBAC構造図 -->
                    <div class="mermaid">
                        graph TD
                            A[ユーザー] --> B[ロール]
                            B --> C[権限]
                            C --> D[リソース]
                            
                            A1[田中さん] --> B1[管理者]
                            A2[佐藤さん] --> B1[管理者]
                            A3[鈴木さん] --> B2[一般ユーザー]
                            A4[高橋さん] --> B2[一般ユーザー]
                            A5[山田さん] --> B3[ゲスト]
                            
                            B1 --> C1[全機能アクセス]
                            B2 --> C2[読み書き権限]
                            B3 --> C3[読み取り専用]
                            
                            C1 --> D1[管理画面]
                            C1 --> D2[ユーザー管理]
                            C1 --> D3[システム設定]
                            C2 --> D4[データ入力]
                            C2 --> D5[レポート表示]
                            C3 --> D6[公開情報]
                    </div>

                    <!-- 実習3: ロールベースアクセス制御の実装 -->
                    <div class="exercise-container">
                        <h5>実習 9-3: 包括的なロールベースアクセス制御の実装</h5>
                        <p>管理者、メンバー、ゲストの3段階のロールを実装し、各ロールに応じたアクセス制御を実現してみましょう。</p>
                        
                        <h6>手順1: マスターページでのロール表示</h6>
                        <pre class="code-block"><code class="language-html">&lt;!-- Site.master のナビゲーション部分を更新 --&gt;
&lt;div class="collapse navbar-collapse" id="navbarNav"&gt;
    &lt;ul class="navbar-nav ms-auto"&gt;
        &lt;li class="nav-item"&gt;
            &lt;a class="nav-link" href="Default.aspx"&gt;ホーム&lt;/a&gt;
        &lt;/li&gt;
        
        &lt;!-- 認証済みユーザーのみ表示 --&gt;
        &lt;asp:LoginView ID="LoginView1" runat="server"&gt;
            &lt;LoggedInTemplate&gt;
                &lt;li class="nav-item"&gt;
                    &lt;a class="nav-link" href="~/Members/Dashboard.aspx"&gt;マイページ&lt;/a&gt;
                &lt;/li&gt;
            &lt;/LoggedInTemplate&gt;
        &lt;/asp:LoginView&gt;
        
        &lt;!-- 管理者専用メニュー --&gt;
        &lt;asp:LoginView ID="AdminLoginView" runat="server"&gt;
            &lt;RoleGroups&gt;
                &lt;asp:RoleGroup Roles="Administrator"&gt;
                    &lt;ContentTemplate&gt;
                        &lt;li class="nav-item dropdown"&gt;
                            &lt;a class="nav-link dropdown-toggle" href="#" id="adminDropdown" 
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"&gt;
                                &lt;i class="fas fa-cog"&gt;&lt;/i&gt; 管理
                            &lt;/a&gt;
                            &lt;ul class="dropdown-menu" aria-labelledby="adminDropdown"&gt;
                                &lt;li&gt;&lt;a class="dropdown-item" href="~/Admin/UserManagement.aspx"&gt;ユーザー管理&lt;/a&gt;&lt;/li&gt;
                                &lt;li&gt;&lt;a class="dropdown-item" href="~/Admin/RoleManagement.aspx"&gt;ロール管理&lt;/a&gt;&lt;/li&gt;
                                &lt;li&gt;&lt;a class="dropdown-item" href="~/Admin/SystemSettings.aspx"&gt;システム設定&lt;/a&gt;&lt;/li&gt;
                                &lt;li&gt;&lt;hr class="dropdown-divider"&gt;&lt;/li&gt;
                                &lt;li&gt;&lt;a class="dropdown-item" href="~/Admin/Logs.aspx"&gt;ログ確認&lt;/a&gt;&lt;/li&gt;
                            &lt;/ul&gt;
                        &lt;/li&gt;
                    &lt;/ContentTemplate&gt;
                &lt;/asp:RoleGroup&gt;
            &lt;/RoleGroups&gt;
        &lt;/asp:LoginView&gt;
        
        &lt;!-- ログイン状態表示 --&gt;
        &lt;asp:LoginView ID="LoginStatusView" runat="server"&gt;
            &lt;AnonymousTemplate&gt;
                &lt;li class="nav-item"&gt;
                    &lt;a class="nav-link" href="~/Account/Login.aspx"&gt;ログイン&lt;/a&gt;
                &lt;/li&gt;
                &lt;li class="nav-item"&gt;
                    &lt;a class="nav-link" href="~/Account/Register.aspx"&gt;新規登録&lt;/a&gt;
                &lt;/li&gt;
            &lt;/AnonymousTemplate&gt;
            &lt;LoggedInTemplate&gt;
                &lt;li class="nav-item dropdown"&gt;
                    &lt;a class="nav-link dropdown-toggle" href="#" id="userDropdown" 
                       role="button" data-bs-toggle="dropdown" aria-expanded="false"&gt;
                        &lt;i class="fas fa-user"&gt;&lt;/i&gt; &lt;asp:LoginName ID="LoginName1" runat="server" /&gt;
                    &lt;/a&gt;
                    &lt;ul class="dropdown-menu" aria-labelledby="userDropdown"&gt;
                        &lt;li&gt;&lt;a class="dropdown-item" href="~/Account/Profile.aspx"&gt;プロファイル&lt;/a&gt;&lt;/li&gt;
                        &lt;li&gt;&lt;a class="dropdown-item" href="~/Account/ChangePassword.aspx"&gt;パスワード変更&lt;/a&gt;&lt;/li&gt;
                        &lt;li&gt;&lt;hr class="dropdown-divider"&gt;&lt;/li&gt;
                        &lt;li&gt;&lt;asp:LoginStatus ID="LoginStatus1" runat="server" CssClass="dropdown-item" 
                                            LogoutText="ログアウト" LogoutAction="Redirect" 
                                            LogoutPageUrl="~/Default.aspx" /&gt;&lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/li&gt;
            &lt;/LoggedInTemplate&gt;
        &lt;/asp:LoginView&gt;
    &lt;/ul&gt;
&lt;/div&gt;</code></pre>

                        <h6>手順2: カスタム認可属性の実装</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/SecurityHelper.vb
Public Class SecurityHelper
    ' ロール権限チェック
    Public Shared Function IsInRole(roleName As String) As Boolean
        Return HttpContext.Current.User.IsInRole(roleName)
    End Function
    
    ' 複数ロールチェック
    Public Shared Function IsInAnyRole(ParamArray roles() As String) As Boolean
        For Each role As String In roles
            If IsInRole(role) Then
                Return True
            End If
        Next
        Return False
    End Function
    
    ' 管理者権限チェック
    Public Shared Function IsAdministrator() As Boolean
        Return IsInRole("Administrator")
    End Function
    
    ' ページアクセス権限チェック
    Public Shared Sub CheckPageAccess(requiredRole As String)
        If Not HttpContext.Current.User.Identity.IsAuthenticated Then
            HttpContext.Current.Response.Redirect("~/Account/Login.aspx?ReturnUrl=" & HttpContext.Current.Server.UrlEncode(HttpContext.Current.Request.Url.ToString()))
        ElseIf Not IsInRole(requiredRole) Then
            HttpContext.Current.Response.Redirect("~/AccessDenied.aspx")
        End If
    End Sub
    
    ' ログイン必須チェック
    Public Shared Sub RequireAuthentication()
        If Not HttpContext.Current.User.Identity.IsAuthenticated Then
            HttpContext.Current.Response.Redirect("~/Account/Login.aspx?ReturnUrl=" & HttpContext.Current.Server.UrlEncode(HttpContext.Current.Request.Url.ToString()))
        End If
    End Sub
End Class</code></pre>

                        <h6>手順3: 管理者専用ページの実装</h6>
                        <pre class="code-block"><code class="language-vbnet">
' Admin/UserManagement.aspx.vb
Partial Class Admin_UserManagement
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        ' 管理者権限チェック
        SecurityHelper.CheckPageAccess("Administrator")
        
        If Not IsPostBack Then
            LoadUsers()
            LoadRoles()
        End If
    End Sub

    Private Sub LoadUsers()
        ' 全ユーザーの取得
        Dim users As MembershipUserCollection = Membership.GetAllUsers()
        
        Dim userList As New List(Of Object)()
        For Each user As MembershipUser In users
            Dim userRoles() As String = Roles.GetRolesForUser(user.UserName)
            userList.Add(New With {
                .UserName = user.UserName,
                .Email = user.Email,
                .IsApproved = user.IsApproved,
                .IsLockedOut = user.IsLockedOut,
                .CreationDate = user.CreationDate,
                .LastLoginDate = user.LastLoginDate,
                .Roles = String.Join(", ", userRoles)
            })
        Next
        
        gvUsers.DataSource = userList
        gvUsers.DataBind()
    End Sub
    
    Private Sub LoadRoles()
        ddlRoles.DataSource = Roles.GetAllRoles()
        ddlRoles.DataBind()
        ddlRoles.Items.Insert(0, New ListItem("-- ロールを選択 --", ""))
    End Sub

    Protected Sub gvUsers_RowCommand(sender As Object, e As GridViewCommandEventArgs) Handles gvUsers.RowCommand
        Dim userName As String = e.CommandArgument.ToString()
        
        Select Case e.CommandName
            Case "ToggleApproval"
                ToggleUserApproval(userName)
            Case "UnlockUser"
                UnlockUser(userName)
            Case "DeleteUser"
                DeleteUser(userName)
        End Select
        
        LoadUsers()
    End Sub

    Private Sub ToggleUserApproval(userName As String)
        Dim user As MembershipUser = Membership.GetUser(userName)
        If user IsNot Nothing Then
            user.IsApproved = Not user.IsApproved
            Membership.UpdateUser(user)
            
            Dim status As String = If(user.IsApproved, "承認", "承認取消")
            ShowMessage($"ユーザー '{userName}' を{status}しました。", "success")
        End If
    End Sub

    Private Sub UnlockUser(userName As String)
        Dim user As MembershipUser = Membership.GetUser(userName)
        If user IsNot Nothing AndAlso user.IsLockedOut Then
            user.UnlockUser()
            ShowMessage($"ユーザー '{userName}' のロックを解除しました。", "success")
        End If
    End Sub

    Private Sub DeleteUser(userName As String)
        Try
            ' ユーザーを全ロールから削除
            Dim userRoles() As String = Roles.GetRolesForUser(userName)
            If userRoles.Length > 0 Then
                Roles.RemoveUserFromRoles(userName, userRoles)
            End If
            
            ' ユーザー削除
            Membership.DeleteUser(userName, True)
            ShowMessage($"ユーザー '{userName}' を削除しました。", "success")
        Catch ex As Exception
            ShowMessage($"ユーザー削除でエラーが発生しました: {ex.Message}", "danger")
        End Try
    End Sub

    Protected Sub btnAddToRole_Click(sender As Object, e As EventArgs) Handles btnAddToRole.Click
        If Not String.IsNullOrEmpty(txtUserName.Text) AndAlso Not String.IsNullOrEmpty(ddlRoles.SelectedValue) Then
            Try
                Roles.AddUserToRole(txtUserName.Text, ddlRoles.SelectedValue)
                ShowMessage($"ユーザー '{txtUserName.Text}' をロール '{ddlRoles.SelectedValue}' に追加しました。", "success")
                LoadUsers()
            Catch ex As Exception
                ShowMessage($"ロール追加でエラーが発生しました: {ex.Message}", "danger")
            End Try
        End If
    End Sub

    Private Sub ShowMessage(message As String, alertType As String)
        lblMessage.Text = $"<div class='alert alert-{alertType} alert-dismissible fade show' role='alert'>{message}<button type='button' class='btn-close' data-bs-dismiss='alert'></button></div>"
    End Sub
End Class</code></pre>

                        <h6>実装のメリット</h6>
                        <ul>
                            <li><strong>セキュリティの一元化</strong>：SecurityHelperクラスで権限チェック統一</li>
                            <li><strong>ユーザビリティ</strong>：ロールに応じたメニュー表示</li>
                            <li><strong>管理効率</strong>：Web UIでのユーザー・ロール管理</li>
                            <li><strong>監査対応</strong>：権限変更の履歴記録</li>
                        </ul>
                    </div>

                    <!-- セクション6: セキュリティベストプラクティス -->
                    <h3 class="section-title">9.6 セキュリティベストプラクティス</h3>
                    
                    <p>堅牢なWebアプリケーションを構築するためには、認証・認可以外にも多くのセキュリティ脅威に対する対策が必要です。ここでは、ASP.NETアプリケーションで実装すべき主要なセキュリティ対策を学習します。</p>

                    <div class="security-alert">
                        <h6><i class="fas fa-shield-alt"></i> 主要なセキュリティ脅威とその対策</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>脅威</th>
                                    <th>説明</th>
                                    <th>ASP.NET対策</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>XSS</strong></td>
                                    <td>悪意あるスクリプトの埋め込み</td>
                                    <td>自動HTMLエンコーディング、ValidateInput</td>
                                </tr>
                                <tr>
                                    <td><strong>CSRF</strong></td>
                                    <td>不正なフォーム送信</td>
                                    <td>ViewStateUserKey、AntiForgeryToken</td>
                                </tr>
                                <tr>
                                    <td><strong>SQLインジェクション</strong></td>
                                    <td>不正なSQL実行</td>
                                    <td>パラメータ化クエリ、ストアドプロシージャ</td>
                                </tr>
                                <tr>
                                    <td><strong>セッションハイジャック</strong></td>
                                    <td>セッションIDの盗取</td>
                                    <td>HTTPS、CookieSecure、HttpOnly</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- セキュリティ実装の実習 -->
                    <div class="exercise-container">
                        <h5>実習 9-4: 包括的なセキュリティ対策の実装</h5>
                        <p>XSS、CSRF、セッション管理などの主要なセキュリティ対策を実装してみましょう。</p>
                        
                        <h6>手順1: web.config でのセキュリティ設定</h6>
                        <pre class="code-block"><code class="language-xml">&lt;system.web&gt;
  &lt;!-- リクエスト検証を有効化（XSS対策） --&gt;
  &lt;pages validateRequest="true" enableViewStateMac="true" viewStateEncryptionMode="Always" /&gt;
  
  &lt;!-- HTTP Cookiesのセキュリティ設定 --&gt;
  &lt;httpCookies httpOnlyCookies="true" requireSSL="true" lockItem="true" /&gt;
  
  &lt;!-- セッション設定 --&gt;
  &lt;sessionState 
    mode="InProc" 
    cookieless="false" 
    cookieTimeout="30" 
    cookieName="ASP.NET_SessionId" 
    cookieHttpOnlyCookies="true" 
    cookieRequireSSL="true" 
    regenerateExpiredSessionId="true" /&gt;
    
  &lt;!-- トレース情報を無効化（本番環境） --&gt;
  &lt;trace enabled="false" localOnly="true" pageOutput="false" /&gt;
  
  &lt;!-- デバッグ情報を無効化（本番環境） --&gt;
  &lt;compilation debug="false" targetFramework="4.8" /&gt;
  
  &lt;!-- カスタムエラーページ --&gt;
  &lt;customErrors mode="On" defaultRedirect="~/Error.aspx"&gt;
    &lt;error statusCode="403" redirect="~/AccessDenied.aspx" /&gt;
    &lt;error statusCode="404" redirect="~/NotFound.aspx" /&gt;
  &lt;/customErrors&gt;
  
  &lt;!-- HTTPモジュール設定 --&gt;
  &lt;httpModules&gt;
    &lt;add name="SecurityModule" type="CompanySite.SecurityModule" /&gt;
  &lt;/httpModules&gt;
&lt;/system.web&gt;

&lt;!-- HTTPセキュリティヘッダー --&gt;
&lt;system.webServer&gt;
  &lt;httpProtocol&gt;
    &lt;customHeaders&gt;
      &lt;add name="X-Frame-Options" value="SAMEORIGIN" /&gt;
      &lt;add name="X-Content-Type-Options" value="nosniff" /&gt;
      &lt;add name="X-XSS-Protection" value="1; mode=block" /&gt;
      &lt;add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains" /&gt;
      &lt;add name="Content-Security-Policy" value="default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net fonts.googleapis.com; font-src 'self' fonts.gstatic.com; img-src 'self' data:; frame-ancestors 'self';" /&gt;
    &lt;/customHeaders&gt;
  &lt;/httpProtocol&gt;
  
  &lt;!-- サーバー情報を隠す --&gt;
  &lt;security&gt;
    &lt;requestFiltering removeServerHeader="true"&gt;
      &lt;verbs&gt;
        &lt;add verb="TRACE" allowed="false" /&gt;
        &lt;add verb="TRACK" allowed="false" /&gt;
      &lt;/verbs&gt;
    &lt;/requestFiltering&gt;
  &lt;/security&gt;
&lt;/system.webServer&gt;</code></pre>

                        <h6>手順2: カスタムセキュリティモジュール</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/SecurityModule.vb
Public Class SecurityModule
    Implements IHttpModule

    Public Sub Init(context As HttpApplication) Implements IHttpModule.Init
        AddHandler context.BeginRequest, AddressOf OnBeginRequest
        AddHandler context.PreExecuteRequestHandler, AddressOf OnPreExecuteRequestHandler
        AddHandler context.Error, AddressOf OnError
    End Sub

    Private Sub OnBeginRequest(sender As Object, e As EventArgs)
        Dim context As HttpContext = HttpContext.Current
        
        ' HTTPS リダイレクト（本番環境）
        If Not context.Request.IsSecureConnection AndAlso Not context.Request.IsLocal Then
            Dim secureUrl As String = context.Request.Url.ToString().Replace("http://", "https://")
            context.Response.Redirect(secureUrl, True)
        End If
        
        ' セキュリティヘッダーの追加
        context.Response.Headers.Remove("Server")
        context.Response.Headers.Add("X-Powered-By", "")
        
        ' リファラーチェック（CSRF対策の一部）
        If IsPostBack(context) Then
            ValidateReferrer(context)
        End If
    End Sub

    Private Sub OnPreExecuteRequestHandler(sender As Object, e As EventArgs)
        Dim context As HttpContext = HttpContext.Current
        
        ' ViewStateUserKey設定（CSRF対策）
        If context.Handler IsNot Nothing AndAlso TypeOf context.Handler Is Page Then
            Dim page As Page = DirectCast(context.Handler, Page)
            If context.User.Identity.IsAuthenticated Then
                page.ViewStateUserKey = context.User.Identity.Name
            End If
        End If
    End Sub

    Private Sub OnError(sender As Object, e As EventArgs)
        Dim context As HttpContext = HttpContext.Current
        Dim error As Exception = context.Server.GetLastError()
        
        ' セキュリティ関連エラーのログ記録
        LogSecurityEvent("Application Error", error, context)
        
        ' 詳細なエラー情報の露出を防ぐ
        If Not context.Request.IsLocal Then
            context.Response.Clear()
            context.Response.StatusCode = 500
            context.Server.Transfer("~/Error.aspx")
        End If
    End Sub

    Private Function IsPostBack(context As HttpContext) As Boolean
        Return String.Equals(context.Request.HttpMethod, "POST", StringComparison.OrdinalIgnoreCase)
    End Function

    Private Sub ValidateReferrer(context As HttpContext)
        Dim referrer As Uri = context.Request.UrlReferrer
        Dim requestUri As Uri = context.Request.Url
        
        If referrer Is Nothing OrElse Not String.Equals(referrer.Host, requestUri.Host, StringComparison.OrdinalIgnoreCase) Then
            ' 不正なリファラーの場合はリクエストを拒否
            LogSecurityEvent("Invalid Referrer", New Exception($"Referrer: {referrer?.ToString()}, Request: {requestUri}"), context)
            context.Response.StatusCode = 403
            context.Response.End()
        End If
    End Sub

    Private Sub LogSecurityEvent(eventType As String, ex As Exception, context As HttpContext)
        ' セキュリティイベントのログ記録
        Dim logMessage As String = $"Security Event: {eventType}, URL: {context.Request.Url}, IP: {context.Request.UserHostAddress}, User: {context.User.Identity.Name}, Error: {ex.Message}"
        
        ' 実装：データベース、ファイル、Windows EventLogへの記録
        Try
            ' EventLog記録例
            Dim eventLog As New EventLog("Application")
            eventLog.Source = "CompanySite Security"
            eventLog.WriteEntry(logMessage, EventLogEntryType.Warning)
        Catch
            ' ログ記録エラーは無視（メインアプリケーションに影響させない）
        End Try
    End Sub

    Public Sub Dispose() Implements IHttpModule.Dispose
        ' リソースの解放
    End Sub
End Class</code></pre>

                        <h6>手順3: セキュアなデータ処理クラス</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/SecureDataHelper.vb
Imports System.Security.Cryptography
Imports System.Text

Public Class SecureDataHelper
    ' 暗号化キー（実際は設定ファイルから取得）
    Private Shared ReadOnly EncryptionKey As String = ConfigurationManager.AppSettings("EncryptionKey")
    
    ' 文字列の暗号化
    Public Shared Function EncryptString(plainText As String) As String
        If String.IsNullOrEmpty(plainText) Then Return String.Empty
        
        Using aes As Aes = Aes.Create()
            aes.Key = Encoding.UTF8.GetBytes(EncryptionKey.PadRight(32).Substring(0, 32))
            aes.GenerateIV()
            
            Using encryptor As ICryptoTransform = aes.CreateEncryptor(aes.Key, aes.IV)
                Using msEncrypt As New MemoryStream()
                    msEncrypt.Write(aes.IV, 0, aes.IV.Length)
                    Using csEncrypt As New CryptoStream(msEncrypt, encryptor, CryptoStreamMode.Write)
                        Using swEncrypt As New StreamWriter(csEncrypt)
                            swEncrypt.Write(plainText)
                        End Using
                    End Using
                    Return Convert.ToBase64String(msEncrypt.ToArray())
                End Using
            End Using
        End Using
    End Function
    
    ' 文字列の復号化
    Public Shared Function DecryptString(cipherText As String) As String
        If String.IsNullOrEmpty(cipherText) Then Return String.Empty
        
        Try
            Dim fullCipher() As Byte = Convert.FromBase64String(cipherText)
            
            Using aes As Aes = Aes.Create()
                aes.Key = Encoding.UTF8.GetBytes(EncryptionKey.PadRight(32).Substring(0, 32))
                
                Dim iv(15) As Byte
                Array.Copy(fullCipher, 0, iv, 0, iv.Length)
                aes.IV = iv
                
                Using decryptor As ICryptoTransform = aes.CreateDecryptor(aes.Key, aes.IV)
                    Using msDecrypt As New MemoryStream(fullCipher, iv.Length, fullCipher.Length - iv.Length)
                        Using csDecrypt As New CryptoStream(msDecrypt, decryptor, CryptoStreamMode.Read)
                            Using srDecrypt As New StreamReader(csDecrypt)
                                Return srDecrypt.ReadToEnd()
                            End Using
                        End Using
                    End Using
                End Using
            End Using
        Catch
            Return String.Empty
        End Try
    End Function
    
    ' パスワードハッシュ化（Salt付き）
    Public Shared Function HashPassword(password As String) As String
        Using sha256 As SHA256 = SHA256.Create()
            Dim salt As String = GenerateSalt()
            Dim saltedPassword As String = password + salt
            Dim hashedBytes() As Byte = sha256.ComputeHash(Encoding.UTF8.GetBytes(saltedPassword))
            Return salt + Convert.ToBase64String(hashedBytes)
        End Using
    End Function
    
    ' パスワード検証
    Public Shared Function VerifyPassword(password As String, hashedPassword As String) As Boolean
        If String.IsNullOrEmpty(hashedPassword) OrElse hashedPassword.Length < 24 Then Return False
        
        Dim salt As String = hashedPassword.Substring(0, 24)
        Dim hash As String = hashedPassword.Substring(24)
        
        Using sha256 As SHA256 = SHA256.Create()
            Dim saltedPassword As String = password + salt
            Dim hashedBytes() As Byte = sha256.ComputeHash(Encoding.UTF8.GetBytes(saltedPassword))
            Dim computedHash As String = Convert.ToBase64String(hashedBytes)
            Return String.Equals(hash, computedHash)
        End Using
    End Function
    
    Private Shared Function GenerateSalt() As String
        Using rng As RandomNumberGenerator = RandomNumberGenerator.Create()
            Dim saltBytes(15) As Byte
            rng.GetBytes(saltBytes)
            Return Convert.ToBase64String(saltBytes)
        End Using
    End Function
    
    ' XSS対策：HTMLエンコーディング
    Public Shared Function HtmlEncode(text As String) As String
        Return HttpUtility.HtmlEncode(text)
    End Function
    
    ' SQL文のエスケープ処理チェック
    Public Shared Function IsSqlInjectionAttempt(input As String) As Boolean
        If String.IsNullOrEmpty(input) Then Return False
        
        Dim suspiciousPatterns() As String = {
            "'", """", ";", "--", "/*", "*/", "xp_", "sp_", 
            "exec", "execute", "select", "insert", "update", "delete", "drop", "create"
        }
        
        Dim lowerInput As String = input.ToLower()
        For Each pattern As String In suspiciousPatterns
            If lowerInput.Contains(pattern.ToLower()) Then
                Return True
            End If
        Next
        
        Return False
    End Function
End Class</code></pre>

                        <h6>セキュリティ実装のポイント</h6>
                        <ul>
                            <li><strong>多層防御</strong>：複数のセキュリティ対策を組み合わせ</li>
                            <li><strong>設定ベース</strong>：web.configでの一元的なセキュリティ設定</li>
                            <li><strong>ログ記録</strong>：セキュリティイベントの詳細な記録</li>
                            <li><strong>暗号化</strong>：機密データの保護</li>
                            <li><strong>入力検証</strong>：すべてのユーザー入力の検証</li>
                        </ul>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>認証と認可の違い</strong>：認証（Authentication）と認可（Authorization）の違いを、具体的な実世界の例を使って詳しく説明してください。また、両方が重要な理由も説明してください。</li>
                            
                            <li><strong>メンバーシップシステムの利点</strong>：ASP.NETメンバーシップシステムを使用することで得られる利点を5つ挙げ、それぞれがセキュリティ向上にどのように貢献するかを説明してください。</li>
                            
                            <li><strong>ロールベースアクセス制御</strong>：RBAC（Role-Based Access Control）システムを設計する際の重要な考慮事項を4つ説明し、なぜそれらが重要なのかを述べてください。</li>
                            
                            <li><strong>主要脅威への対策</strong>：以下のセキュリティ脅威について、それぞれの攻撃方法とASP.NETでの対策方法を説明してください：
                                <ul>
                                    <li>XSS（Cross-Site Scripting）</li>
                                    <li>CSRF（Cross-Site Request Forgery）</li>
                                    <li>SQLインジェクション</li>
                                    <li>セッションハイジャック</li>
                                </ul>
                            </li>
                            
                            <li><strong>セキュリティベストプラクティス</strong>：Webアプリケーションのセキュリティを確保するために実装すべきベストプラクティスを7つ挙げ、それぞれの実装方法と重要性を説明してください。</li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-08.html" class="btn btn-secondary">← 第8章: マスターページとナビゲーション</a>
                        <a href="aspnet-vb-learning-material-10.html" class="btn btn-primary">第10章: 実践的なWebアプリケーション開発 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>