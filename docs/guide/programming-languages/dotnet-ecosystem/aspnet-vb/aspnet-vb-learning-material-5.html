<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET（VB.NET）学習教材 第5章 - 状態管理（Session、ViewState、Cache）</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #512da8;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .chapter-title {
            color: #512da8;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #512da8;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #673ab7;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .quiz-container {
            background-color: #ede7f6;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #512da8;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .nav-link.active {
            background-color: #512da8 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>ASP.NET（VB.NET）学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">
                                第1章: ASP.NET Web Forms入門と開発環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">
                                第2章: Web FormsとWebコントロール
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">
                                第3章: イベント処理とPostBack
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">
                                第4章: データ検証とエラーハンドリング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aspnet-vb-learning-material-5.html">
                                第5章: 状態管理（Session、ViewState、Cache）
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">
                                第6章: データベース連携（ADO.NET）
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">
                                第7章: データバインドとGridView
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">
                                第8章: マスターページとナビゲーション
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-9.html">
                                第9章: セキュリティとメンバーシップ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-10.html">
                                第10章: 実践的なWebアプリケーション開発
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第5章: 状態管理（Session、ViewState、Cache）</h1>
                </div>

                <div id="chapter5">
                    <h2 class="chapter-title">Webアプリケーションにおける状態管理の理解</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>HTTPプロトコルのステートレス特性とWeb開発への影響</li>
                            <li>ViewStateの仕組みと適切な使用方法・制限事項</li>
                            <li>Sessionオブジェクトによるユーザー固有データの管理</li>
                            <li>Applicationオブジェクトとキャッシュ機能の活用</li>
                            <li>各状態管理手法の特徴と使い分けのベストプラクティス</li>
                        </ul>
                    </div>

                    <h3 class="section-title">5.1 Webアプリケーションの状態管理とは</h3>
                    
                    <p>Webアプリケーションの開発において、状態管理は極めて重要な概念です。HTTPプロトコルは本質的に「ステートレス」（状態を保持しない）であるため、リクエストごとに前回の情報は失われます。ASP.NET Web Formsは、この問題を解決するために様々な状態管理メカニズムを提供しています。</p>

                    <h4>HTTPのステートレス特性</h4>
                    <p>HTTPプロトコルでは、各リクエストは独立しており、前のリクエストの情報を自動的には保持しません。これは以下のような問題を引き起こします：</p>
                    
                    <ul>
                        <li>ユーザーがログインしても、次のページではその情報が失われる</li>
                        <li>フォームに入力したデータが、エラー後に消える</li>
                        <li>ショッピングカートの内容が保持されない</li>
                        <li>ユーザーの設定や選択が次のページに引き継がれない</li>
                    </ul>

                    <div class="mermaid">
                        graph TD
                            A["クライアント要求1<br/>ログイン情報"] --> B["サーバー処理1"]
                            B --> C["レスポンス1<br/>ログイン成功"]
                            C --> D["接続終了<br/>状態消失"]
                            
                            E["クライアント要求2<br/>別ページ要求"] --> F["サーバー処理2"]
                            F --> G["前回のログイン情報<br/>は不明"]
                    </div>

                    <h4>ASP.NET Web Formsの状態管理ソリューション</h4>
                    <p>ASP.NET Web Formsは、この問題を解決するために以下の状態管理手法を提供します：</p>
                    
                    <div class="highlight">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>手法</th>
                                    <th>保存場所</th>
                                    <th>寿命</th>
                                    <th>適用範囲</th>
                                    <th>主な用途</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ViewState</td>
                                    <td>ページ内（隠しフィールド）</td>
                                    <td>ページの間</td>
                                    <td>単一ページ</td>
                                    <td>コントロール状態保持</td>
                                </tr>
                                <tr>
                                    <td>Session</td>
                                    <td>サーバーメモリ</td>
                                    <td>セッション中</td>
                                    <td>ユーザー固有</td>
                                    <td>ログイン情報、ユーザー設定</td>
                                </tr>
                                <tr>
                                    <td>Application</td>
                                    <td>サーバーメモリ</td>
                                    <td>アプリ実行中</td>
                                    <td>全ユーザー共通</td>
                                    <td>設定情報、共通データ</td>
                                </tr>
                                <tr>
                                    <td>Cache</td>
                                    <td>サーバーメモリ</td>
                                    <td>設定可能</td>
                                    <td>全ユーザー共通</td>
                                    <td>頻繁にアクセスするデータ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 class="section-title">5.2 ViewState - ページレベルの状態管理</h3>
                    
                    <p>ViewStateは、ASP.NET Web Formsの最も特徴的な機能の一つです。コントロールの状態を自動的に保持し、PostBack後に復元します。</p>

                    <h4>ViewStateの動作メカニズム</h4>
                    <div class="mermaid">
                        sequenceDiagram
                            participant Browser as ブラウザ
                            participant Page as ページ
                            participant ViewState as ViewState
                            
                            Browser->>Page: 1. 初回ページ要求
                            Page->>ViewState: 2. コントロール状態を記録
                            ViewState->>Page: 3. Base64エンコード
                            Page->>Browser: 4. HTML + __VIEWSTATE送信
                            
                            Browser->>Page: 5. PostBack（__VIEWSTATE含む）
                            Page->>ViewState: 6. ViewState解析
                            ViewState->>Page: 7. コントロール状態復元
                            Page->>Browser: 8. 更新されたHTML送信
                    </div>

                    <h4>ViewStateの実装例</h4>
                    <pre class="code-block"><code class="language-vbnet">' ViewStateを使用したカウンター実装
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    If Not Page.IsPostBack Then
        ' 初回読み込み時の初期化
        ViewState("Counter") = 0
        ViewState("LastClickTime") = DateTime.Now
        ViewState("UserPreferences") = New Dictionary(Of String, String)
    End If
    
    UpdateCounterDisplay()
End Sub

Protected Sub btnIncrement_Click(sender As Object, e As EventArgs) Handles btnIncrement.Click
    ' ViewStateからカウンター値を取得・更新
    Dim counter As Integer = CInt(ViewState("Counter"))
    counter += 1
    ViewState("Counter") = counter
    ViewState("LastClickTime") = DateTime.Now
    
    UpdateCounterDisplay()
End Sub

Private Sub UpdateCounterDisplay()
    Dim counter As Integer = CInt(ViewState("Counter"))
    Dim lastClick As DateTime = CDate(ViewState("LastClickTime"))
    
    lblCounter.Text = $"カウンター: {counter}"
    lblLastClick.Text = $"最終更新: {lastClick:yyyy/MM/dd HH:mm:ss}"
End Sub

' 複雑なオブジェクトの保存例
Private Sub SaveUserPreference(key As String, value As String)
    Dim prefs As Dictionary(Of String, String) = 
        CType(ViewState("UserPreferences"), Dictionary(Of String, String))
    
    prefs(key) = value
    ViewState("UserPreferences") = prefs
End Sub</code></pre>

                    <div class="warning">
                        <h5>ViewStateの制限事項と注意点</h5>
                        <ul>
                            <li><strong>サイズ制限</strong>：大きなデータはページサイズを増加させる</li>
                            <li><strong>セキュリティ</strong>：クライアントサイドに保存されるため改ざんリスク</li>
                            <li><strong>パフォーマンス</strong>：毎回ブラウザとの間で送受信される</li>
                            <li><strong>スコープ</strong>：単一ページ内でのみ有効</li>
                        </ul>
                    </div>

                    <h4>ViewStateの制御</h4>
                    <pre class="code-block"><code class="language-vbnet">' ページレベルでViewStateを無効化
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    ' ページ全体のViewStateを無効化
    Page.EnableViewState = False
    
    ' 特定のコントロールのみViewState無効化
    lblStaticLabel.EnableViewState = False
    
    ' ViewStateのサイズを確認（デバッグ用）
    If Page.IsPostBack Then
        Dim viewStateSize As Integer = Request.Form("__VIEWSTATE").Length
        System.Diagnostics.Debug.WriteLine($"ViewState Size: {viewStateSize} bytes")
    End If
End Sub

' ViewStateの暗号化設定（Web.config）
' &lt;system.web&gt;
'   &lt;pages enableViewStateMac="true" viewStateEncryptionMode="Always" /&gt;
' &lt;/system.web&gt;</code></pre>

                    <h3 class="section-title">5.3 Session - ユーザー固有の状態管理</h3>
                    
                    <p>Sessionオブジェクトは、特定のユーザーに固有のデータを、そのユーザーのセッション期間中保持します。ログイン情報やユーザー設定の保存に最適です。</p>

                    <h4>Sessionの基本的な使用方法</h4>
                    <pre class="code-block"><code class="language-vbnet">' ログイン処理でセッション設定
Protected Sub btnLogin_Click(sender As Object, e As EventArgs) Handles btnLogin.Click
    If ValidateUser(txtUserName.Text, txtPassword.Text) Then
        ' ユーザー情報をセッションに保存
        Session("UserName") = txtUserName.Text
        Session("UserID") = GetUserID(txtUserName.Text)
        Session("LoginTime") = DateTime.Now
        Session("UserRole") = GetUserRole(txtUserName.Text)
        
        ' 複雑なオブジェクトも保存可能
        Dim userProfile As New UserProfile With {
            .Name = txtUserName.Text,
            .Email = GetUserEmail(txtUserName.Text),
            .Preferences = GetUserPreferences(txtUserName.Text)
        }
        Session("UserProfile") = userProfile
        
        Response.Redirect("Dashboard.aspx")
    Else
        lblError.Text = "ログインに失敗しました"
    End If
End Sub

' セッション情報の取得と使用
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    ' ログイン状態チェック
    If Session("UserName") Is Nothing Then
        Response.Redirect("Login.aspx")
        Return
    End If
    
    ' セッション情報の表示
    Dim userName As String = Session("UserName").ToString()
    Dim loginTime As DateTime = CDate(Session("LoginTime"))
    
    lblWelcome.Text = $"ようこそ、{userName}さん"
    lblLoginTime.Text = $"ログイン時刻: {loginTime:yyyy/MM/dd HH:mm:ss}"
    
    ' セッションタイムアウトまでの残り時間
    Dim timeoutMinutes As Integer = Session.Timeout
    lblSessionInfo.Text = $"セッションタイムアウト: {timeoutMinutes}分"
End Sub

' ログアウト処理
Protected Sub btnLogout_Click(sender As Object, e As EventArgs) Handles btnLogout.Click
    ' セッション情報をクリア
    Session.Clear()     ' セッション変数をすべて削除
    Session.Abandon()   ' セッション自体を破棄
    
    Response.Redirect("Login.aspx")
End Sub</code></pre>

                    <div class="exercise-container">
                        <h5>実習 5-1: ショッピングカート機能の実装</h5>
                        <p>Sessionを使用してショッピングカート機能を実装し、商品の追加・削除・数量変更を行います。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいページ「ShoppingCart.aspx」を作成</li>
                            <li>商品クラス（Product）を定義</li>
                            <li>Session("ShoppingCart")にList(Of Product)を保存</li>
                            <li>商品追加、数量変更、商品削除機能を実装</li>
                            <li>カート内容表示機能を実装</li>
                            <li>合計金額計算機能を実装</li>
                        </ol>
                        
                        <h6>商品クラスの定義例</h6>
                        <pre class="code-block"><code class="language-vbnet">Public Class Product
    Public Property ID As Integer
    Public Property Name As String
    Public Property Price As Decimal
    Public Property Quantity As Integer
    
    Public ReadOnly Property TotalPrice As Decimal
        Get
            Return Price * Quantity
        End Get
    End Property
End Class

' カート管理クラス
Public Class ShoppingCartManager
    Public Shared Function GetCartItems() As List(Of Product)
        If HttpContext.Current.Session("ShoppingCart") Is Nothing Then
            HttpContext.Current.Session("ShoppingCart") = New List(Of Product)()
        End If
        
        Return CType(HttpContext.Current.Session("ShoppingCart"), List(Of Product))
    End Function
    
    Public Shared Sub AddItem(product As Product)
        Dim cartItems As List(Of Product) = GetCartItems()
        
        Dim existingItem = cartItems.FirstOrDefault(Function(p) p.ID = product.ID)
        If existingItem IsNot Nothing Then
            existingItem.Quantity += product.Quantity
        Else
            cartItems.Add(product)
        End If
    End Sub
    
    Public Shared Function GetTotalAmount() As Decimal
        Return GetCartItems().Sum(Function(p) p.TotalPrice)
    End Function
End Class</code></pre>
                    </div>

                    <h3 class="section-title">5.4 Application - アプリケーション全体の状態管理</h3>
                    
                    <p>Applicationオブジェクトは、Webアプリケーション全体で共有されるグローバルな状態を管理します。すべてのユーザーが同じデータにアクセスできます。</p>

                    <h4>Applicationの使用例</h4>
                    <pre class="code-block"><code class="language-vbnet">' Global.asax.vb - アプリケーション起動時の初期化
Public Class Global_asax
    Inherits System.Web.HttpApplication

    Sub Application_Start(sender As Object, e As EventArgs)
        ' アプリケーション起動時に実行される
        Application("StartTime") = DateTime.Now
        Application("TotalVisitors") = 0
        Application("OnlineUsers") = 0
        Application("AppVersion") = "1.0.0"
        
        ' 設定情報の読み込み
        LoadApplicationSettings()
    End Sub
    
    Sub Session_Start(sender As Object, e As EventArgs)
        ' 新しいセッション開始時
        Application.Lock()
        Application("TotalVisitors") = CInt(Application("TotalVisitors")) + 1
        Application("OnlineUsers") = CInt(Application("OnlineUsers")) + 1
        Application.UnLock()
    End Sub
    
    Sub Session_End(sender As Object, e As EventArgs)
        ' セッション終了時
        Application.Lock()
        Application("OnlineUsers") = CInt(Application("OnlineUsers")) - 1
        Application.UnLock()
    End Sub
    
    Private Sub LoadApplicationSettings()
        ' データベースから設定を読み込み（例）
        Application("MaintenanceMode") = False
        Application("MaxUploadSize") = 10485760 ' 10MB
        Application("SupportedFileTypes") = New String() {".jpg", ".png", ".pdf", ".doc"}
    End Sub
End Class</code></pre>

                    <h4>Applicationデータの使用</h4>
                    <pre class="code-block"><code class="language-vbnet">' 統計情報の表示
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    If Application("StartTime") IsNot Nothing Then
        Dim startTime As DateTime = CDate(Application("StartTime"))
        Dim uptime As TimeSpan = DateTime.Now - startTime
        
        lblUptime.Text = $"アプリケーション稼働時間: {uptime.Days}日 {uptime.Hours}時間 {uptime.Minutes}分"
        lblTotalVisitors.Text = $"総訪問者数: {Application("TotalVisitors")}"
        lblOnlineUsers.Text = $"現在のオンラインユーザー: {Application("OnlineUsers")}"
    End If
End Sub

' 設定情報の取得
Private Function GetMaxUploadSize() As Integer
    If Application("MaxUploadSize") IsNot Nothing Then
        Return CInt(Application("MaxUploadSize"))
    End If
    Return 1048576 ' デフォルト 1MB
End Function

' メンテナンスモードのチェック
Protected Sub Page_PreInit(sender As Object, e As EventArgs) Handles Me.PreInit
    If Application("MaintenanceMode") IsNot Nothing AndAlso
       CBool(Application("MaintenanceMode")) = True Then
        Response.Redirect("Maintenance.aspx")
    End If
End Sub</code></pre>

                    <div class="warning">
                        <h5>Application使用時の注意点</h5>
                        <ul>
                            <li><strong>排他制御</strong>：複数ユーザーが同時にアクセスする場合はApplication.Lock()とUnLock()を使用</li>
                            <li><strong>メモリ使用量</strong>：大きなデータは避け、必要に応じて削除する</li>
                            <li><strong>アプリケーション再起動</strong>：サーバー再起動やアプリケーション更新でデータが消失</li>
                        </ul>
                    </div>

                    <h3 class="section-title">5.5 Cache - 高パフォーマンスなデータ管理</h3>
                    
                    <p>Cacheオブジェクトは、頻繁にアクセスされるデータを効率的に管理するためのメカニズムです。有効期限や依存関係を設定できる高度な機能を提供します。</p>

                    <h4>基本的なキャッシュ使用法</h4>
                    <pre class="code-block"><code class="language-vbnet">' データベースから取得したデータのキャッシュ
Private Function GetProductList() As List(Of Product)
    Const CacheKey As String = "ProductList"
    
    ' キャッシュからデータを取得を試行
    Dim productList As List(Of Product) = TryCast(Cache(CacheKey), List(Of Product))
    
    If productList Is Nothing Then
        ' キャッシュにない場合はデータベースから取得
        productList = LoadProductsFromDatabase()
        
        ' 30分間キャッシュに保存
        Cache.Insert(CacheKey, productList, Nothing, 
                    DateTime.Now.AddMinutes(30), 
                    TimeSpan.Zero)
        
        System.Diagnostics.Debug.WriteLine("データベースからデータを取得")
    Else
        System.Diagnostics.Debug.WriteLine("キャッシュからデータを取得")
    End If
    
    Return productList
End Function

' ファイル依存キャッシュの例
Private Function GetConfiguration() As Dictionary(Of String, String)
    Const CacheKey As String = "AppConfiguration"
    
    Dim config As Dictionary(Of String, String) = 
        TryCast(Cache(CacheKey), Dictionary(Of String, String))
    
    If config Is Nothing Then
        Dim configFile As String = Server.MapPath("~/App_Data/config.xml")
        config = LoadConfigurationFromFile(configFile)
        
        ' ファイルが更新されたらキャッシュを無効化
        Dim dependency As New System.Web.Caching.CacheDependency(configFile)
        Cache.Insert(CacheKey, config, dependency)
    End If
    
    Return config
End Function

' スライディング有効期限の例
Private Sub CacheUserPreferences(userID As Integer, preferences As UserPreferences)
    Dim cacheKey As String = $"UserPreferences_{userID}"
    
    ' 最後のアクセスから20分間保持（スライディング有効期限）
    Cache.Insert(cacheKey, preferences, Nothing, 
                System.Web.Caching.Cache.NoAbsoluteExpiration, 
                TimeSpan.FromMinutes(20))
End Sub</code></pre>

                    <h4>高度なキャッシュ機能</h4>
                    <pre class="code-block"><code class="language-vbnet">' 優先度設定付きキャッシュ
Private Sub CacheWithPriority(key As String, data As Object, priority As CacheItemPriority)
    Cache.Insert(key, data, Nothing, 
                DateTime.Now.AddHours(1), 
                TimeSpan.Zero, 
                priority, 
                Nothing) ' コールバック関数
End Sub

' キャッシュ削除コールバック関数付き
Private Sub CacheWithCallback(key As String, data As Object)
    Cache.Insert(key, data, Nothing, 
                DateTime.Now.AddMinutes(30), 
                TimeSpan.Zero, 
                CacheItemPriority.Normal, 
                AddressOf CacheItemRemovedCallback)
End Sub

Private Sub CacheItemRemovedCallback(key As String, value As Object, reason As CacheItemRemovedReason)
    ' キャッシュアイテムが削除された時の処理
    System.Diagnostics.Debug.WriteLine($"キャッシュ削除: {key}, 理由: {reason}")
    
    ' 必要に応じて再キャッシュやログ記録
    If reason = CacheItemRemovedReason.Expired Then
        ' 期限切れの場合の処理
        RefreshCacheData(key)
    End If
End Sub

' キャッシュの手動制御
Private Sub ManageCacheManually()
    ' 特定のキャッシュアイテムを削除
    Cache.Remove("ProductList")
    
    ' パターンマッチでキャッシュクリア
    Dim keysToRemove As New List(Of String)()
    For Each item As DictionaryEntry In Cache
        If item.Key.ToString().StartsWith("User_") Then
            keysToRemove.Add(item.Key.ToString())
        End If
    Next
    
    For Each key As String In keysToRemove
        Cache.Remove(key)
    Next
End Sub</code></pre>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>HTTPプロトコルがステートレスである理由と、それがWebアプリケーション開発に与える影響を説明してください。</strong></li>
                            <li><strong>ViewState、Session、Application、Cacheの違いを表にまとめてください。</strong></li>
                            <li><strong>ViewStateのセキュリティ上の注意点と対策を説明してください。</strong></li>
                            <li><strong>Sessionオブジェクトでユーザーのログイン状態を管理する際の実装方法を説明してください。</strong></li>
                            <li><strong>Application.Lock()とApplication.UnLock()が必要な理由を説明してください。</strong></li>
                            <li><strong>キャッシュに有効期限を設定する方法として、絶対有効期限とスライディング有効期限の違いを説明してください。</strong></li>
                        </ol>
                        
                        <div class="mt-3">
                            <strong>解答例：</strong>
                            <ol>
                                <li>HTTPは各リクエストが独立し状態を保持しないため、前回の情報（ログイン状態等）が引き継がれない問題が発生する</li>
                                <li>[表形式での回答] スコープ、保存場所、寿命、用途の違い</li>
                                <li>クライアントサイドに保存されるため改ざんリスクあり。対策：暗号化（enableViewStateMac、viewStateEncryptionMode）</li>
                                <li>ログイン成功時にSession("UserName")等に情報保存、各ページでSession確認、ログアウト時にSession.Clear()</li>
                                <li>複数ユーザーが同時にApplication変数を変更する際の競合状態を防ぐため</li>
                                <li>絶対有効期限：設定時点から固定期間、スライディング有効期限：最終アクセスから指定期間</li>
                            </ol>
                        </div>
                    </div>

                    <h3 class="section-title">5.6 まとめ</h3>
                    
                    <p>この章では、ASP.NET Web Formsにおける状態管理の各手法について学習しました。重要なポイントを再確認しましょう：</p>
                    
                    <ul>
                        <li>HTTPのステートレス特性を理解し、適切な状態管理手法を選択する</li>
                        <li>ViewStateは単一ページ内でのコントロール状態保持に最適</li>
                        <li>Sessionはユーザー固有のデータ（ログイン情報等）の管理に使用</li>
                        <li>Applicationはアプリケーション全体で共有されるグローバルデータに使用</li>
                        <li>Cacheは頻繁にアクセスされるデータの高速化に活用</li>
                        <li>各手法の特性を理解し、セキュリティとパフォーマンスを考慮した実装</li>
                    </ul>
                    
                    <p>次章では、これらの状態管理技術を活用してデータベースとの連携について詳しく学習していきます。</p>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-4.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-6.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>