<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSP学習教材 第3章 - スクリプトレットと式</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            color: white;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>JSP学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-01.html">
                                第1章: 事前準備
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-02.html">
                                第2章: JSPの基本理解
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="jsp-learning-material-03.html">
                                第3章: スクリプトレットと式
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-04.html">
                                第4章: ディレクティブとインポート
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-05.html">
                                第5章: リクエストとレスポンス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-06.html">
                                第6章: JSPとJavaBeans
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-07.html">
                                第7章: セッションとスコープ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-08.html">
                                第8章: ELとJSTL入門
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-09.html">
                                第9章: 簡易Webアプリ開発
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jsp-learning-material-10.html">
                                第10章: 次のステップへ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第3章: スクリプトレットと式</h1>
                </div>

                <div id="chapter3">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">JSPスクリプト要素の詳細理解</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>スクリプトレット（&lt;% %&gt;）の詳細な使用方法と適用場面を理解する</li>
                            <li>式（&lt;%= %&gt;）による動的コンテンツ出力の効果的な活用法を学ぶ</li>
                            <li>宣言（&lt;%! %&gt;）によるクラスレベル要素の定義方法を修得する</li>
                            <li>JSPページ内でのJavaコード記述のベストプラクティスを理解する</li>
                            <li>制御構造（条件分岐・繰り返し）をJSPで実装する方法を学ぶ</li>
                            <li>動的コンテンツ生成の実践的な応用例を通じて理解を深める</li>
                        </ul>
                    </div>

                    <!-- セクション1: スクリプトレットの基本 -->
                    <h3 class="section-title">3.1 スクリプトレット（&lt;% %&gt;）の基本理解</h3>
                    <p>スクリプトレットは、JSPページ内でJavaコードを直接記述するための最も基本的な構文要素です。条件分岐、繰り返し処理、変数操作など、様々なプログラムロジックを実装できます。</p>
                    
                    <h4>3.1.1 スクリプトレットの特徴と用途</h4>
                    <p>スクリプトレットの主な特徴：</p>
                    <ul>
                        <li><strong>Javaコード実行</strong>：標準的なJava構文をそのまま記述可能</li>
                        <li><strong>変数スコープ</strong>：メソッドレベルのローカル変数として機能</li>
                        <li><strong>制御構造</strong>：if文、for文、while文など全ての制御構造が使用可能</li>
                        <li><strong>オブジェクト操作</strong>：Javaオブジェクトの生成・操作が自由に実行可能</li>
                    </ul>

                    <div class="exercise-container">
                        <h5>実習 3-1: スクリプトレットの基本操作</h5>
                        <p>各種データ型の変数宣言と基本的な操作を行うJSPページを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>以下のJSPファイルをscriptlet-basics.jspとして作成</li>
                            <li>各種データ型の変数宣言と操作を確認</li>
                            <li>ブラウザで実行して結果を観察</li>
                        </ol>
                        <h6>scriptlet-basics.jsp</h6>
                        <pre class="code-block"><code class="language-html">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;スクリプトレット基本操作&lt;/title&gt;
    &lt;style&gt;
        body { font-family: 'Noto Sans JP', sans-serif; margin: 20px; }
        .result { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #0d6efd; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;スクリプトレット基本操作デモ&lt;/h1&gt;
    
    &lt;%
        // 基本データ型の変数宣言
        int integerValue = 42;
        double doubleValue = 3.14159;
        boolean booleanValue = true;
        String stringValue = "Hello, JSP!";
        
        // 配列の宣言と初期化
        int[] numbers = {1, 2, 3, 4, 5};
        String[] colors = {"赤", "青", "緑", "黄", "紫"};
        
        // 日付と時刻の取得
        java.util.Date currentDate = new java.util.Date();
        java.util.Calendar cal = java.util.Calendar.getInstance();
        
        // 数学的計算
        double circleArea = Math.PI * Math.pow(5, 2);
        int randomNumber = (int)(Math.random() * 100) + 1;
    %&gt;
    
    &lt;h2&gt;基本変数の表示&lt;/h2&gt;
    &lt;div class="result"&gt;
        &lt;p&gt;整数値: &lt;%= integerValue %&gt;&lt;/p&gt;
        &lt;p&gt;浮動小数点数: &lt;%= doubleValue %&gt;&lt;/p&gt;
        &lt;p&gt;論理値: &lt;%= booleanValue %&gt;&lt;/p&gt;
        &lt;p&gt;文字列: &lt;%= stringValue %&gt;&lt;/p&gt;
        &lt;p&gt;現在日時: &lt;%= currentDate %&gt;&lt;/p&gt;
        &lt;p&gt;円の面積（半径5）: &lt;%= String.format("%.2f", circleArea) %&gt;&lt;/p&gt;
        &lt;p&gt;ランダム数値: &lt;%= randomNumber %&gt;&lt;/p&gt;
    &lt;/div&gt;
    
    &lt;h2&gt;配列要素の表示&lt;/h2&gt;
    &lt;div class="result"&gt;
        &lt;p&gt;数値配列:&lt;/p&gt;
        &lt;ul&gt;
            &lt;% for (int i = 0; i &lt; numbers.length; i++) { %&gt;
                &lt;li&gt;numbers[&lt;%= i %&gt;] = &lt;%= numbers[i] %&gt;&lt;/li&gt;
            &lt;% } %&gt;
        &lt;/ul&gt;
        
        &lt;p&gt;色名配列:&lt;/p&gt;
        &lt;ul&gt;
            &lt;% for (String color : colors) { %&gt;
                &lt;li&gt;&lt;%= color %&gt;&lt;/li&gt;
            &lt;% } %&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
    
    &lt;h2&gt;条件分岐の例&lt;/h2&gt;
    &lt;div class="result"&gt;
        &lt;% if (randomNumber &lt; 30) { %&gt;
            &lt;p style="color: red;"&gt;低い値です（&lt;%= randomNumber %&gt;）&lt;/p&gt;
        &lt;% } else if (randomNumber &lt; 70) { %&gt;
            &lt;p style="color: orange;"&gt;中程度の値です（&lt;%= randomNumber %&gt;）&lt;/p&gt;
        &lt;% } else { %&gt;
            &lt;p style="color: green;"&gt;高い値です（&lt;%= randomNumber %&gt;）&lt;/p&gt;
        &lt;% } %&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <h6>期待される結果</h6>
                        <p>様々なデータ型の変数が表示され、配列の繰り返し処理、条件分岐による動的な表示が確認できます。ページを更新するたびにランダム値と条件分岐の結果が変化します。</p>
                    </div>

                    <!-- セクション2: 式の詳細活用 -->
                    <h3 class="section-title">3.2 式（&lt;%= %&gt;）による動的出力</h3>
                    <p>式は、Javaの式や変数の値を直接HTML出力に埋め込むための構文です。スクリプトレットで処理したデータを表示する際に最も頻繁に使用されます。</p>

                    <h4>3.2.1 式の活用パターン</h4>
                    <p>式の一般的な使用パターン：</p>

                    <div class="mermaid">
                        flowchart TD
                            A["式（&lt;%= %&gt;）の用途"] --> B["変数値の出力"]
                            A --> C["メソッド戻り値の出力"]
                            A --> D["計算結果の出力"]
                            A --> E["オブジェクト情報の出力"]
                            
                            B --> B1["&lt;%= userName %&gt;"]
                            C --> C1["&lt;%= getName() %&gt;"]
                            D --> D1["&lt;%= total * 1.08 %&gt;"]
                            E --> E1["&lt;%= product.toString() %&gt;"]
                    </div>

                    <div class="exercise-container">
                        <h5>実習 3-2: 式を活用した動的コンテンツ生成</h5>
                        <p>様々な式の活用パターンを使用して、実用的な動的コンテンツを生成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>以下のJSPファイルをexpression-demo.jspとして作成</li>
                            <li>各種式の使用方法を確認</li>
                            <li>動的に生成される内容の変化を観察</li>
                        </ol>
                        <h6>expression-demo.jsp</h6>
                        <pre class="code-block"><code class="language-html">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%@ page import="java.text.*, java.util.*" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;式による動的コンテンツ生成&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;%
        // データ準備
        String companyName = "テックソリューション株式会社";
        String[] departments = {"営業部", "開発部", "総務部", "人事部"};
        double[] sales = {1250.5, 2100.8, 890.3, 670.2};
        
        // フォーマッター設定
        DecimalFormat currencyFormat = new DecimalFormat("#,##0.0");
        SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy年MM月dd日（E）");
        
        // 集計計算
        double totalSales = 0;
        for (double sale : sales) {
            totalSales += sale;
        }
        
        // 現在時刻情報
        Calendar now = Calendar.getInstance();
        int hour = now.get(Calendar.HOUR_OF_DAY);
        String timeGreeting = (hour &lt; 12) ? "おはようございます" : (hour &lt; 18) ? "こんにちは" : "こんばんは";
    %&gt;
    
    &lt;div class="container my-5"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-12"&gt;
                &lt;div class="alert alert-primary" role="alert"&gt;
                    &lt;h4 class="alert-heading"&gt;&lt;%= timeGreeting %&gt;！&lt;/h4&gt;
                    &lt;p class="mb-0"&gt;&lt;%= companyName %&gt;の売上レポート（&lt;%= dateFormat.format(new Date()) %&gt;）&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div class="row"&gt;
            &lt;div class="col-md-8"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h5&gt;部門別売上実績&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;table class="table table-striped"&gt;
                            &lt;thead&gt;
                                &lt;tr&gt;
                                    &lt;th&gt;部門名&lt;/th&gt;
                                    &lt;th class="text-end"&gt;売上金額（万円）&lt;/th&gt;
                                    &lt;th class="text-end"&gt;構成比（%）&lt;/th&gt;
                                    &lt;th&gt;評価&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/thead&gt;
                            &lt;tbody&gt;
                                &lt;% for (int i = 0; i &lt; departments.length; i++) { %&gt;
                                &lt;tr&gt;
                                    &lt;td&gt;&lt;%= departments[i] %&gt;&lt;/td&gt;
                                    &lt;td class="text-end"&gt;&lt;%= currencyFormat.format(sales[i]) %&gt;&lt;/td&gt;
                                    &lt;td class="text-end"&gt;&lt;%= String.format("%.1f", (sales[i] / totalSales) * 100) %&gt;&lt;/td&gt;
                                    &lt;td&gt;
                                        &lt;% if (sales[i] &gt;= 1500) { %&gt;
                                            &lt;span class="badge bg-success"&gt;優秀&lt;/span&gt;
                                        &lt;% } else if (sales[i] &gt;= 1000) { %&gt;
                                            &lt;span class="badge bg-warning"&gt;普通&lt;/span&gt;
                                        &lt;% } else { %&gt;
                                            &lt;span class="badge bg-danger"&gt;要改善&lt;/span&gt;
                                        &lt;% } %&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                                &lt;% } %&gt;
                            &lt;/tbody&gt;
                            &lt;tfoot&gt;
                                &lt;tr class="table-dark"&gt;
                                    &lt;th&gt;合計&lt;/th&gt;
                                    &lt;th class="text-end"&gt;&lt;%= currencyFormat.format(totalSales) %&gt;&lt;/th&gt;
                                    &lt;th class="text-end"&gt;100.0&lt;/th&gt;
                                    &lt;th&gt;-&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/tfoot&gt;
                        &lt;/table&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="col-md-4"&gt;
                &lt;div class="card mb-3"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h5&gt;サマリー情報&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;h6&gt;総売上金額&lt;/h6&gt;
                        &lt;p class="h3 text-primary"&gt;&lt;%= currencyFormat.format(totalSales) %&gt;万円&lt;/p&gt;
                        
                        &lt;h6&gt;平均売上&lt;/h6&gt;
                        &lt;p class="h4 text-info"&gt;&lt;%= currencyFormat.format(totalSales / departments.length) %&gt;万円&lt;/p&gt;
                        
                        &lt;h6&gt;最高売上部門&lt;/h6&gt;
                        &lt;%
                            int maxIndex = 0;
                            for (int i = 1; i &lt; sales.length; i++) {
                                if (sales[i] &gt; sales[maxIndex]) {
                                    maxIndex = i;
                                }
                            }
                        %&gt;
                        &lt;p class="h5 text-success"&gt;&lt;%= departments[maxIndex] %&gt;&lt;/p&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="card"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h5&gt;システム情報&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;small class="text-muted"&gt;
                            レポート生成時刻: &lt;%= new SimpleDateFormat("HH:mm:ss").format(new Date()) %&gt;&lt;br&gt;
                            処理時間: &lt;%= System.currentTimeMillis() % 1000 %&gt;ms&lt;br&gt;
                            Javaバージョン: &lt;%= System.getProperty("java.version") %&gt;
                        &lt;/small&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <h6>期待される結果</h6>
                        <p>部門別売上レポートが動的に生成され、時刻に応じた挨拶、フォーマットされた数値、計算結果、条件に応じたバッジ表示などが確認できます。</p>
                    </div>

                    <!-- セクション3: 宣言の活用 -->
                    <h3 class="section-title">3.3 宣言（&lt;%! %&gt;）によるクラスレベル要素</h3>
                    <p>宣言は、JSPページのクラスレベルでメソッドや変数を定義するための構文です。スクリプトレットや式から呼び出せる共通的な機能を実装する際に使用します。</p>

                    <h4>3.3.1 宣言とスクリプトレットの違い</h4>
                    <p>宣言とスクリプトレットの主な違い：</p>

                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>項目</th>
                                <th>宣言（&lt;%! %&gt;）</th>
                                <th>スクリプトレット（&lt;% %&gt;）</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>スコープ</td>
                                <td>クラスレベル（全リクエスト共通）</td>
                                <td>メソッドレベル（リクエスト毎）</td>
                            </tr>
                            <tr>
                                <td>使用目的</td>
                                <td>メソッド・インスタンス変数定義</td>
                                <td>処理ロジック実装</td>
                            </tr>
                            <tr>
                                <td>生存期間</td>
                                <td>サーブレットの生存期間中</td>
                                <td>リクエスト処理中のみ</td>
                            </tr>
                            <tr>
                                <td>初期化</td>
                                <td>クラスロード時に1回</td>
                                <td>リクエスト毎に実行</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="exercise-container">
                        <h5>実習 3-3: 宣言を使用したユーティリティ機能実装</h5>
                        <p>宣言を活用して再利用可能なメソッドを作成し、スクリプトレットから呼び出します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>以下のJSPファイルをdeclaration-demo.jspとして作成</li>
                            <li>宣言で定義したメソッドの呼び出しを確認</li>
                            <li>アクセス毎にカウンターが増加することを確認</li>
                        </ol>
                        <h6>declaration-demo.jsp</h6>
                        <pre class="code-block"><code class="language-html">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%!
    // クラスレベルの変数宣言（全リクエストで共有）
    private int visitCounter = 0;
    private java.util.Date serverStartTime = new java.util.Date();
    
    // ユーティリティメソッドの宣言
    public String formatCurrency(double amount) {
        java.text.DecimalFormat df = new java.text.DecimalFormat("#,##0円");
        return df.format(amount);
    }
    
    public String getGradeByScore(int score) {
        if (score &gt;= 90) return "A";
        if (score &gt;= 80) return "B"; 
        if (score &gt;= 70) return "C";
        if (score &gt;= 60) return "D";
        return "F";
    }
    
    public String getBadgeClass(String grade) {
        switch(grade) {
            case "A": return "bg-success";
            case "B": return "bg-primary";
            case "C": return "bg-warning";
            case "D": return "bg-secondary";
            default: return "bg-danger";
        }
    }
    
    public boolean isPrime(int number) {
        if (number &lt; 2) return false;
        for (int i = 2; i &lt;= Math.sqrt(number); i++) {
            if (number % i == 0) return false;
        }
        return true;
    }
    
    // アクセス記録用メソッド
    public synchronized int incrementVisitCounter() {
        return ++visitCounter;
    }
%&gt;

&lt;%
    // 現在のアクセス番号を取得
    int currentVisit = incrementVisitCounter();
    
    // サンプルデータ
    String[] studentNames = {"田中太郎", "佐藤花子", "鈴木次郎", "高橋美咲", "渡辺健太"};
    int[] scores = {95, 82, 76, 68, 45};
    double[] prices = {1980.0, 5280.0, 12800.0, 980.0, 25600.0};
    
    // サーバー稼働時間計算
    long uptimeMillis = System.currentTimeMillis() - serverStartTime.getTime();
    long uptimeMinutes = uptimeMillis / (1000 * 60);
%&gt;

&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;宣言によるユーティリティ機能デモ&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container my-5"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-12"&gt;
                &lt;div class="alert alert-info"&gt;
                    &lt;h4&gt;サーバー情報&lt;/h4&gt;
                    &lt;p&gt;あなたは&lt;strong&gt;&lt;%= currentVisit %&gt;&lt;/strong&gt;番目の訪問者です&lt;/p&gt;
                    &lt;p&gt;サーバー開始時刻: &lt;%= serverStartTime %&gt;&lt;/p&gt;
                    &lt;p&gt;稼働時間: &lt;%= uptimeMinutes %&gt;分&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div class="row"&gt;
            &lt;div class="col-md-6"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h5&gt;成績管理システム&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;table class="table"&gt;
                            &lt;thead&gt;
                                &lt;tr&gt;
                                    &lt;th&gt;学生名&lt;/th&gt;
                                    &lt;th&gt;点数&lt;/th&gt;
                                    &lt;th&gt;評価&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/thead&gt;
                            &lt;tbody&gt;
                                &lt;% for (int i = 0; i &lt; studentNames.length; i++) { %&gt;
                                &lt;%
                                    String grade = getGradeByScore(scores[i]);
                                    String badgeClass = getBadgeClass(grade);
                                %&gt;
                                &lt;tr&gt;
                                    &lt;td&gt;&lt;%= studentNames[i] %&gt;&lt;/td&gt;
                                    &lt;td&gt;&lt;%= scores[i] %&gt;点&lt;/td&gt;
                                    &lt;td&gt;&lt;span class="badge &lt;%= badgeClass %&gt;"&gt;&lt;%= grade %&gt;&lt;/span&gt;&lt;/td&gt;
                                &lt;/tr&gt;
                                &lt;% } %&gt;
                            &lt;/tbody&gt;
                        &lt;/table&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="col-md-6"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h5&gt;商品価格一覧&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;table class="table"&gt;
                            &lt;thead&gt;
                                &lt;tr&gt;
                                    &lt;th&gt;商品ID&lt;/th&gt;
                                    &lt;th&gt;価格&lt;/th&gt;
                                    &lt;th&gt;税込価格&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/thead&gt;
                            &lt;tbody&gt;
                                &lt;% for (int i = 0; i &lt; prices.length; i++) { %&gt;
                                &lt;tr&gt;
                                    &lt;td&gt;PROD-&lt;%= String.format("%03d", i + 1) %&gt;&lt;/td&gt;
                                    &lt;td&gt;&lt;%= formatCurrency(prices[i]) %&gt;&lt;/td&gt;
                                    &lt;td&gt;&lt;%= formatCurrency(prices[i] * 1.10) %&gt;&lt;/td&gt;
                                &lt;/tr&gt;
                                &lt;% } %&gt;
                            &lt;/tbody&gt;
                        &lt;/table&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div class="row mt-4"&gt;
            &lt;div class="col-12"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h5&gt;数学関数デモ&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;p&gt;1から20までの数値における素数判定：&lt;/p&gt;
                        &lt;div&gt;
                            &lt;% for (int i = 1; i &lt;= 20; i++) { %&gt;
                                &lt;% if (isPrime(i)) { %&gt;
                                    &lt;span class="badge bg-success me-1"&gt;&lt;%= i %&gt;&lt;/span&gt;
                                &lt;% } else { %&gt;
                                    &lt;span class="badge bg-light text-dark me-1"&gt;&lt;%= i %&gt;&lt;/span&gt;
                                &lt;% } %&gt;
                            &lt;% } %&gt;
                        &lt;/div&gt;
                        &lt;small class="text-muted"&gt;緑色のバッジが素数です&lt;/small&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <h6>期待される結果</h6>
                        <p>訪問者カウンター、成績評価、価格フォーマット、素数判定など、宣言で定義したメソッドが各機能で活用され、アクセスするたびにカウンターが増加することが確認できます。</p>
                    </div>

                    <!-- セクション4: 制御構造の活用 -->
                    <h3 class="section-title">3.4 制御構造を活用した動的コンテンツ生成</h3>
                    <p>JSPでは、Javaの全ての制御構造（条件分岐・繰り返し処理）を使用できます。これらを効果的に活用することで、複雑な動的コンテンツを生成できます。</p>

                    <h4>3.4.1 主要な制御構造パターン</h4>
                    <p>JSPでよく使用される制御構造：</p>

                    <div class="mermaid">
                        flowchart TD
                            A["制御構造"] --> B["条件分岐"]
                            A --> C["繰り返し処理"]
                            A --> D["例外処理"]
                            
                            B --> B1["if-else文"]
                            B --> B2["switch文"]
                            B --> B3["三項演算子"]
                            
                            C --> C1["for文"]
                            C --> C2["拡張for文"]
                            C --> C3["while文"]
                            
                            D --> D1["try-catch文"]
                            D --> D2["カスタム例外"]
                    </div>

                    <div class="exercise-container">
                        <h5>実習 3-4: 制御構造を活用した実用的なWebページ</h5>
                        <p>複雑な制御構造を組み合わせて、実用的なWebアプリケーションページを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>以下のJSPファイルをcontrol-structures.jspとして作成</li>
                            <li>各種制御構造の動作を確認</li>
                            <li>動的に生成される様々なパターンを観察</li>
                        </ol>
                        <h6>control-structures.jsp</h6>
                        <pre class="code-block"><code class="language-html">&lt;%@ page contentType="text/html; charset=UTF-8" %&gt;
&lt;%@ page import="java.util.*, java.text.*" %&gt;
&lt;%!
    // 天気情報を取得する模擬メソッド
    public String getWeatherInfo(String city) {
        String[] weathers = {"晴れ", "曇り", "雨", "雪"};
        Random rand = new Random();
        return weathers[rand.nextInt(weathers.length)];
    }
    
    // 温度に基づく服装アドバイス
    public String getClothingAdvice(int temperature) {
        if (temperature &gt;= 25) return "半袖・薄着がおすすめです";
        if (temperature &gt;= 20) return "軽い上着があると良いでしょう";
        if (temperature &gt;= 15) return "長袖・軽いジャケットを";
        if (temperature &gt;= 10) return "コートが必要です";
        return "厚手のコート・防寒具を";
    }
%&gt;

&lt;%
    // サンプルデータの生成
    String[] cities = {"東京", "大阪", "名古屋", "福岡", "札幌"};
    int[] temperatures = {22, 18, 25, 28, 5};
    String[] prefectures = {"東京都", "大阪府", "愛知県", "福岡県", "北海道"};
    
    // 現在時刻に基づく処理
    Calendar cal = Calendar.getInstance();
    int currentHour = cal.get(Calendar.HOUR_OF_DAY);
    String timeOfDay = (currentHour &lt; 6) ? "深夜" : 
                      (currentHour &lt; 12) ? "午前" :
                      (currentHour &lt; 18) ? "午後" : "夜";
    
    // 統計計算
    double avgTemp = 0;
    int maxTemp = Integer.MIN_VALUE;
    int minTemp = Integer.MAX_VALUE;
    String hottestCity = "", coldestCity = "";
    
    for (int i = 0; i &lt; temperatures.length; i++) {
        avgTemp += temperatures[i];
        if (temperatures[i] &gt; maxTemp) {
            maxTemp = temperatures[i];
            hottestCity = cities[i];
        }
        if (temperatures[i] &lt; minTemp) {
            minTemp = temperatures[i];
            coldestCity = cities[i];
        }
    }
    avgTemp /= temperatures.length;
%&gt;

&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;全国天気情報システム&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
    &lt;style&gt;
        .weather-card { transition: all 0.3s ease; }
        .weather-card:hover { transform: translateY(-5px); }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container my-5"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-12 text-center"&gt;
                &lt;h1 class="mb-4"&gt;全国天気情報システム&lt;/h1&gt;
                &lt;div class="alert alert-primary"&gt;
                    &lt;strong&gt;&lt;%= timeOfDay %&gt;&lt;/strong&gt;の天気情報をお届けします
                    （&lt;%= new SimpleDateFormat("yyyy年MM月dd日 HH:mm").format(new Date()) %&gt;現在）
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div class="row"&gt;
            &lt;% for (int i = 0; i &lt; cities.length; i++) { %&gt;
            &lt;div class="col-md-4 mb-4"&gt;
                &lt;div class="card weather-card h-100"&gt;
                    &lt;div class="card-header text-center 
                        &lt;% if (temperatures[i] &gt;= 25) { %&gt;bg-danger text-white
                        &lt;% } else if (temperatures[i] &gt;= 15) { %&gt;bg-warning
                        &lt;% } else { %&gt;bg-info text-white&lt;% } %&gt;"&gt;
                        &lt;h5 class="mb-0"&gt;&lt;%= cities[i] %&gt;（&lt;%= prefectures[i] %&gt;）&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body text-center"&gt;
                        &lt;h2 class="card-title 
                            &lt;% if (temperatures[i] &gt;= 25) { %&gt;text-danger
                            &lt;% } else if (temperatures[i] &lt;= 5) { %&gt;text-primary
                            &lt;% } else { %&gt;text-success&lt;% } %&gt;"&gt;
                            &lt;%= temperatures[i] %&gt;°C
                        &lt;/h2&gt;
                        
                        &lt;p class="card-text"&gt;
                            &lt;strong&gt;天気:&lt;/strong&gt; &lt;%= getWeatherInfo(cities[i]) %&gt;&lt;br&gt;
                            &lt;strong&gt;服装:&lt;/strong&gt; &lt;%= getClothingAdvice(temperatures[i]) %&gt;
                        &lt;/p&gt;
                        
                        &lt;% // 特別な注意事項 %&gt;
                        &lt;% if (temperatures[i] &gt;= 30) { %&gt;
                            &lt;div class="alert alert-danger alert-sm"&gt;
                                &lt;strong&gt;熱中症注意！&lt;/strong&gt; 水分補給を忘れずに
                            &lt;/div&gt;
                        &lt;% } else if (temperatures[i] &lt;= 0) { %&gt;
                            &lt;div class="alert alert-warning alert-sm"&gt;
                                &lt;strong&gt;凍結注意！&lt;/strong&gt; 路面状況にご注意ください
                            &lt;/div&gt;
                        &lt;% } %&gt;
                    &lt;/div&gt;
                    &lt;div class="card-footer text-muted text-center"&gt;
                        &lt;small&gt;観測地点: &lt;%= i + 1 %&gt;番&lt;/small&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;% } %&gt;
        &lt;/div&gt;
        
        &lt;div class="row mt-4"&gt;
            &lt;div class="col-12"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h5&gt;統計情報&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;div class="row text-center"&gt;
                            &lt;div class="col-md-3"&gt;
                                &lt;h6&gt;平均気温&lt;/h6&gt;
                                &lt;p class="h4 text-primary"&gt;&lt;%= String.format("%.1f", avgTemp) %&gt;°C&lt;/p&gt;
                            &lt;/div&gt;
                            &lt;div class="col-md-3"&gt;
                                &lt;h6&gt;最高気温&lt;/h6&gt;
                                &lt;p class="h4 text-danger"&gt;&lt;%= maxTemp %&gt;°C&lt;/p&gt;
                                &lt;small class="text-muted"&gt;（&lt;%= hottestCity %&gt;）&lt;/small&gt;
                            &lt;/div&gt;
                            &lt;div class="col-md-3"&gt;
                                &lt;h6&gt;最低気温&lt;/h6&gt;
                                &lt;p class="h4 text-info"&gt;&lt;%= minTemp %&gt;°C&lt;/p&gt;
                                &lt;small class="text-muted"&gt;（&lt;%= coldestCity %&gt;）&lt;/small&gt;
                            &lt;/div&gt;
                            &lt;div class="col-md-3"&gt;
                                &lt;h6&gt;観測地点数&lt;/h6&gt;
                                &lt;p class="h4 text-success"&gt;&lt;%= cities.length %&gt;地点&lt;/p&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                        
                        &lt;hr&gt;
                        
                        &lt;h6&gt;温度帯別地点数&lt;/h6&gt;
                        &lt;div class="row"&gt;
                            &lt;% 
                                int hot = 0, warm = 0, cool = 0, cold = 0;
                                for (int temp : temperatures) {
                                    if (temp &gt;= 25) hot++;
                                    else if (temp &gt;= 15) warm++;
                                    else if (temp &gt;= 5) cool++;
                                    else cold++;
                                }
                            %&gt;
                            &lt;div class="col-3 text-center"&gt;
                                &lt;span class="badge bg-danger"&gt;暑い（25°C以上）&lt;/span&gt;
                                &lt;p class="h5 mt-2"&gt;&lt;%= hot %&gt;地点&lt;/p&gt;
                            &lt;/div&gt;
                            &lt;div class="col-3 text-center"&gt;
                                &lt;span class="badge bg-warning"&gt;温暖（15-24°C）&lt;/span&gt;
                                &lt;p class="h5 mt-2"&gt;&lt;%= warm %&gt;地点&lt;/p&gt;
                            &lt;/div&gt;
                            &lt;div class="col-3 text-center"&gt;
                                &lt;span class="badge bg-info"&gt;涼しい（5-14°C）&lt;/span&gt;
                                &lt;p class="h5 mt-2"&gt;&lt;%= cool %&gt;地点&lt;/p&gt;
                            &lt;/div&gt;
                            &lt;div class="col-3 text-center"&gt;
                                &lt;span class="badge bg-primary"&gt;寒い（5°C未満）&lt;/span&gt;
                                &lt;p class="h5 mt-2"&gt;&lt;%= cold %&gt;地点&lt;/p&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <h6>期待される結果</h6>
                        <p>全国の天気情報システムが表示され、温度に応じた色分け、条件に応じた警告メッセージ、統計計算結果などが動的に生成されます。リロードするたびに天気情報が変化します。</p>
                    </div>

                    <!-- セクション5: ベストプラクティス -->
                    <h3 class="section-title">3.5 スクリプト要素使用のベストプラクティス</h3>
                    <p>保守性が高く、読みやすいJSPコードを記述するための重要な原則を学習します。</p>

                    <div class="warning">
                        <h5>避けるべき書き方</h5>
                        <ul>
                            <li><strong>長大なスクリプトレット</strong>：100行を超えるようなJavaコードをJSP内に記述</li>
                            <li><strong>複雑なビジネスロジック</strong>：JSP内でデータベース処理や複雑な計算を実行</li>
                            <li><strong>HTMLとJavaの混在</strong>：可読性を著しく損なう構造</li>
                            <li><strong>エラーハンドリングの欠如</strong>：例外処理を考慮しないコード</li>
                        </ul>
                    </div>

                    <h4>3.5.1 推奨される開発パターン</h4>
                    <ul>
                        <li><strong>関心の分離</strong>：プレゼンテーション層とビジネスロジック層の明確な分離</li>
                        <li><strong>短いスクリプトブロック</strong>：1つのスクリプトレットは10行程度に抑制</li>
                        <li><strong>意味のある変数名</strong>：コードの可読性向上</li>
                        <li><strong>適切なコメント</strong>：複雑な処理には日本語コメントを追加</li>
                        <li><strong>エラーハンドリング</strong>：例外発生に対する適切な対応</li>
                    </ul>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>スクリプトレット、式、宣言の使い分けについて、それぞれの特徴と適用場面を具体例とともに説明してください。</li>
                            <li>宣言（&lt;%! %&gt;）で定義した変数が「全リクエストで共有される」ことの意味と、それによって生じる可能性のある問題について説明してください。</li>
                            <li>JSP内でfor文を使用して動的にHTMLテーブルを生成する際の基本的な記述パターンを説明してください。</li>
                            <li>JSPのスクリプト要素を使用する際に「関心の分離」が重要な理由を、保守性の観点から説明してください。</li>
                            <li>式（&lt;%= %&gt;）でnullの可能性がある変数を出力する際に考慮すべき点と対策方法を説明してください。</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>スクリプトレット（&lt;% %&gt;）は変数宣言や制御構造などの処理ロジックに使用、式（&lt;%= %&gt;）は値をHTML出力に直接埋め込む際に使用、宣言（&lt;%! %&gt;）はクラスレベルのメソッドやインスタンス変数を定義する際に使用します。</li>
                                <li>宣言で定義した変数はサーブレットのインスタンス変数となり、異なるユーザーリクエスト間で共有されるため、マルチスレッド環境でのデータ競合や意図しない値の変更が発生する可能性があります。</li>
                                <li>&lt;% for (データ型 変数 : コレクション) { %&gt; &lt;tr&gt;&lt;td&gt;&lt;%= 変数 %&gt;&lt;/td&gt;&lt;/tr&gt; &lt;% } %&gt; のように、繰り返し処理の開始と終了でHTMLタグを適切に配置します。</li>
                                <li>関心の分離により、デザイン（HTML）、データ処理（Java）、スタイリング（CSS）を独立して管理でき、各専門分野での保守・拡張が容易になり、チーム開発の効率性が向上します。</li>
                                <li>NullPointerExceptionを避けるため、三項演算子（&lt;%= value != null ? value : "デフォルト値" %&gt;）や事前のnullチェックを行い、安全にデータを出力する必要があります。</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章のまとめ -->
                    <h3 class="section-title">3.6 まとめ</h3>
                    <p>この章では、JSPの核となるスクリプト要素について詳しく学習しました。</p>
                    <ul>
                        <li><strong>スクリプトレット活用</strong>：処理ロジックと制御構造の実装方法</li>
                        <li><strong>式による動的出力</strong>：データを効果的にHTML出力に埋め込む技法</li>
                        <li><strong>宣言の効果的利用</strong>：再利用可能なメソッドとクラスレベル要素の定義</li>
                        <li><strong>制御構造の組み合わせ</strong>：複雑な動的コンテンツ生成の実践</li>
                        <li><strong>開発ベストプラクティス</strong>：保守性の高いJSPコードの記述原則</li>
                    </ul>
                    <p>次章では、JSPのディレクティブとインポート機能について学習し、より構造化されたJSPアプリケーション開発方法を修得していきます。</p>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="jsp-learning-material-02.html" class="btn btn-secondary">← 前の章</a>
                        <a href="jsp-learning-material-04.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>