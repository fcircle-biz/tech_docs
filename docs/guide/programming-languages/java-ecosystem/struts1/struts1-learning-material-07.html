<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struts 1.x学習教材 第7章 - セッション管理とセキュリティ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- カスタムCSS -->
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .security {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        /* ボタンスタイル */
        .btn-orange {
            background-color: #f57c00;
            border-color: #f57c00;
            color: white;
        }

        .btn-orange:hover {
            background-color: #e65100;
            border-color: #e65100;
            color: white;
        }

        /* セキュリティ関連のスタイル */
        .security-card {
            border: 2px solid #d32f2f;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .security-card .card-header {
            background-color: #ffebee;
            border-bottom: 1px solid #d32f2f;
            font-weight: bold;
            color: #d32f2f;
        }

        /* アニメーション */
        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand text-white fw-bold" href="#main-content">🔐 Struts 1.x 学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="../README.md">📚 Strutsガイド</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="struts1-learning-material-06.html">⬅️ 第6章</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="struts1-learning-material-08.html">➡️ 第8章</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-01.html">
                                第1章: Struts 1.xの基本概念とMVCアーキテクチャ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-02.html">
                                第2章: 環境構築とプロジェクト作成
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-03.html">
                                第3章: ActionクラスとActionForm
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-04.html">
                                第4章: struts-config.xmlの設定と管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-05.html">
                                第5章: JSPとの連携とTagライブラリ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-06.html">
                                第6章: バリデーション機能とエラーハンドリング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="struts1-learning-material-07.html">
                                第7章: セッション管理とセキュリティ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-08.html">
                                第8章: 国際化（i18n）とプロパティファイル
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-09.html">
                                第9章: データベース連携と実践的開発
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="struts1-learning-material-10.html">
                                第10章: デバッグ・テスト・デプロイメント
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツエリア -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" id="main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="chapter-title">第7章 - セッション管理とセキュリティ</h1>
                </div>

                <!-- 学習目標 -->
                <div class="highlight">
                    <h3>🎯 この章の学習目標</h3>
                    <ul>
                        <li>HTTPセッションの概念と仕組みを理解する</li>
                        <li>ユーザー認証とセッション管理の実装方法を習得する</li>
                        <li>Webアプリケーションの主要なセキュリティ脅威と対策を学ぶ</li>
                        <li>CSRF攻撃とXSS攻撃の防御方法を実装する</li>
                        <li>セキュアなWebアプリケーション開発のベストプラクティスを身につける</li>
                    </ul>
                </div>

                <!-- はじめに -->
                <section id="intro">
                    <h2 class="section-title">🔐 はじめに</h2>
                    
                    <p>Webアプリケーションにおいて、<strong>セッション管理</strong>と<strong>セキュリティ対策</strong>は極めて重要な要素です。ユーザーの状態を適切に管理し、悪意のある攻撃から保護することで、安全で信頼性の高いアプリケーションを構築できます。</p>

                    <div class="highlight">
                        <h4>💡 なぜセッション管理とセキュリティが重要なのか？</h4>
                        <p>Webアプリケーションは、インターネット上で多くの不特定ユーザーからアクセスされます：</p>
                        
                        <ul>
                            <li><strong>状態の保持</strong>：HTTPの無状態性を補完し、ユーザーの状態を追跡</li>
                            <li><strong>個人情報保護</strong>：ユーザーのプライベートな情報を適切に管理</li>
                            <li><strong>不正アクセス防止</strong>：権限のないユーザーからのアクセスをブロック</li>
                            <li><strong>攻撃対策</strong>：様々なサイバー攻撃から システムを保護</li>
                        </ul>
                        
                        <p><strong>例え：</strong> セッション管理は「入場券システム」のようなものです。映画館で入場券をもらい、その券で自分の席を特定し、上映中は席を確保します。セキュリティは「警備システム」で、不正な入場者を防ぎ、安全な環境を維持します。</p>
                    </div>

                    <div class="mermaid">
                        graph LR
                            A[ユーザー] --> B[認証]
                            B --> C{認証OK?}
                            C -->|成功| D[セッション作成]
                            C -->|失敗| E[アクセス拒否]
                            D --> F[セッション管理]
                            F --> G[セキュリティチェック]
                            G --> H[リソースアクセス]
                            
                            style A fill:#e3f2fd
                            style B fill:#fff3e0
                            style D fill:#e8f5e8
                            style E fill:#ffebee
                            style F fill:#e8f5e8
                            style G fill:#e8f5e8
                            style H fill:#e8f5e8
                    </div>
                </section>

                <!-- セッション管理の基礎 -->
                <section id="session-basics">
                    <h2 class="section-title">📝 HTTPセッション管理の基礎</h2>
                    
                    <p>HTTPプロトコルは<strong>ステートレス（無状態）</strong>であるため、サーバーは前回のリクエストを記憶していません。セッション管理により、複数のリクエストにまたがってユーザーの状態を保持できます。</p>

                    <h3>🔍 セッションの仕組み</h3>
                    
                    <div class="mermaid">
                        sequenceDiagram
                            participant C as クライアント
                            participant S as サーバー
                            participant M as メモリ
                            
                            C->>S: 初回アクセス
                            S->>M: セッション作成
                            M-->>S: セッションID生成
                            S->>C: レスポンス + セッションID（Cookie）
                            
                            C->>S: 2回目アクセス + セッションID
                            S->>M: セッションID でデータ取得
                            M-->>S: セッションデータ
                            S->>C: レスポンス（状態を保持）
                    </div>

                    <h3>💻 Strutsでのセッション操作</h3>
                    
                    <pre class="code-block"><code class="language-java">public class LoginAction extends Action {
    
    public ActionForward execute(ActionMapping mapping, ActionForm form,
                                HttpServletRequest request, 
                                HttpServletResponse response) throws Exception {
        
        LoginForm loginForm = (LoginForm) form;
        
        // ユーザー認証処理
        UserService userService = new UserService();
        User user = userService.authenticate(
            loginForm.getUsername(), 
            loginForm.getPassword()
        );
        
        if (user != null) {
            // 認証成功：セッションにユーザー情報を保存
            HttpSession session = request.getSession();
            session.setAttribute("loginUser", user);
            session.setAttribute("loginTime", new Date());
            
            // セッションタイムアウトを30分に設定
            session.setMaxInactiveInterval(30 * 60);
            
            return mapping.findForward("success");
        } else {
            // 認証失敗
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, 
                      new ActionMessage("error.login.invalid"));
            saveErrors(request, errors);
            return mapping.getInputForward();
        }
    }
}

// ログアウト処理
public class LogoutAction extends Action {
    
    public ActionForward execute(ActionMapping mapping, ActionForm form,
                                HttpServletRequest request, 
                                HttpServletResponse response) throws Exception {
        
        HttpSession session = request.getSession(false);
        if (session != null) {
            // セッション無効化
            session.invalidate();
        }
        
        return mapping.findForward("login");
    }
}</code></pre>

                    <div class="highlight">
                        <h4>🔧 セッション操作の主要メソッド</h4>
                        
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>メソッド</th>
                                    <th>説明</th>
                                    <th>使用場面</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>request.getSession()</code></td>
                                    <td>セッションを取得（なければ作成）</td>
                                    <td>ログイン時、初回アクセス</td>
                                </tr>
                                <tr>
                                    <td><code>request.getSession(false)</code></td>
                                    <td>セッションを取得（なければnull）</td>
                                    <td>ログイン状態の確認</td>
                                </tr>
                                <tr>
                                    <td><code>session.setAttribute()</code></td>
                                    <td>セッションに値を保存</td>
                                    <td>ユーザー情報の保存</td>
                                </tr>
                                <tr>
                                    <td><code>session.getAttribute()</code></td>
                                    <td>セッションから値を取得</td>
                                    <td>ログインユーザー情報の取得</td>
                                </tr>
                                <tr>
                                    <td><code>session.invalidate()</code></td>
                                    <td>セッションを無効化</td>
                                    <td>ログアウト処理</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- ログイン認証の実装 -->
                <section id="login-implementation">
                    <h2 class="section-title">👤 ログイン認証システムの実装</h2>
                    
                    <p>セキュアなログイン認証システムを実装するには、パスワードの適切な処理、セッション管理、セキュリティ対策が必要です。</p>

                    <h3>🔒 セキュアなパスワード処理</h3>
                    
                    <pre class="code-block"><code class="language-java">import java.security.MessageDigest;
import java.security.SecureRandom;
import java.util.Base64;

public class PasswordUtil {
    
    /**
     * パスワードをソルト付きハッシュ化
     */
    public static String hashPassword(String password, String salt) {
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            md.update(salt.getBytes());
            byte[] hashedPassword = md.digest(password.getBytes());
            return Base64.getEncoder().encodeToString(hashedPassword);
        } catch (Exception e) {
            throw new RuntimeException("パスワードのハッシュ化に失敗しました", e);
        }
    }
    
    /**
     * ランダムソルト生成
     */
    public static String generateSalt() {
        SecureRandom random = new SecureRandom();
        byte[] salt = new byte[16];
        random.nextBytes(salt);
        return Base64.getEncoder().encodeToString(salt);
    }
    
    /**
     * パスワード検証
     */
    public static boolean verifyPassword(String inputPassword, 
                                       String storedHash, 
                                       String salt) {
        String hashedInput = hashPassword(inputPassword, salt);
        return hashedInput.equals(storedHash);
    }
}</code></pre>

                    <div class="security">
                        <h4>🛡️ パスワードセキュリティのベストプラクティス</h4>
                        <ul>
                            <li><strong>ハッシュ化</strong>：平文での保存は絶対に避ける</li>
                            <li><strong>ソルト使用</strong>：レインボーテーブル攻撃を防ぐ</li>
                            <li><strong>強力なアルゴリズム</strong>：SHA-256以上を使用</li>
                            <li><strong>パスワードポリシー</strong>：最小文字数、文字種類の制限</li>
                            <li><strong>ログイン試行制限</strong>：ブルートフォース攻撃対策</li>
                        </ul>
                    </div>

                    <h3>🔐 ログイン状態の確認</h3>
                    
                    <pre class="code-block"><code class="language-java">// ベースActionクラス
public abstract class SecureAction extends Action {
    
    protected User getLoginUser(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            return (User) session.getAttribute("loginUser");
        }
        return null;
    }
    
    protected boolean isLoggedIn(HttpServletRequest request) {
        return getLoginUser(request) != null;
    }
    
    protected ActionForward checkLogin(ActionMapping mapping, 
                                     HttpServletRequest request) {
        if (!isLoggedIn(request)) {
            return mapping.findForward("login");
        }
        return null;
    }
}

// 継承したActionクラス
public class UserListAction extends SecureAction {
    
    public ActionForward execute(ActionMapping mapping, ActionForm form,
                                HttpServletRequest request, 
                                HttpServletResponse response) throws Exception {
        
        // ログイン状態チェック
        ActionForward loginCheck = checkLogin(mapping, request);
        if (loginCheck != null) {
            return loginCheck;
        }
        
        // 通常の処理
        User loginUser = getLoginUser(request);
        // ... ユーザー一覧取得処理 ...
        
        return mapping.findForward("success");
    }
}</code></pre>
                </section>

                <!-- アクセス制御 -->
                <section id="access-control">
                    <h2 class="section-title">🛡️ アクセス制御とロール管理</h2>
                    
                    <p>認証だけでなく、ユーザーの権限に応じたアクセス制御（認可）も重要です。</p>

                    <h3>👥 ロールベースアクセス制御の実装</h3>
                    
                    <pre class="code-block"><code class="language-java">// Userクラスにロール情報を追加
public class User {
    private String username;
    private String email;
    private Set&lt;String&gt; roles; // ユーザーの権限
    
    public boolean hasRole(String role) {
        return roles != null && roles.contains(role);
    }
    
    public boolean hasAnyRole(String... roles) {
        if (this.roles == null) return false;
        for (String role : roles) {
            if (this.roles.contains(role)) {
                return true;
            }
        }
        return false;
    }
}

// アクセス制御用のActionクラス
public class AdminAction extends SecureAction {
    
    public ActionForward execute(ActionMapping mapping, ActionForm form,
                                HttpServletRequest request, 
                                HttpServletResponse response) throws Exception {
        
        // ログイン状態チェック
        ActionForward loginCheck = checkLogin(mapping, request);
        if (loginCheck != null) {
            return loginCheck;
        }
        
        // 管理者権限チェック
        User loginUser = getLoginUser(request);
        if (!loginUser.hasRole("ADMIN")) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, 
                      new ActionMessage("error.access.denied"));
            saveErrors(request, errors);
            return mapping.findForward("accessDenied");
        }
        
        // 管理者機能の処理
        // ...
        
        return mapping.findForward("success");
    }
}</code></pre>

                    <h3>🔧 Filterを使ったアクセス制御</h3>
                    
                    <pre class="code-block"><code class="language-java">public class AuthenticationFilter implements Filter {
    
    private Set&lt;String&gt; publicPaths;
    
    public void init(FilterConfig config) throws ServletException {
        // 認証不要なパスを設定
        publicPaths = new HashSet&lt;&gt;();
        publicPaths.add("/login.do");
        publicPaths.add("/register.do");
        publicPaths.add("/index.jsp");
    }
    
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        String path = httpRequest.getServletPath();
        
        // 公開パスはスルー
        if (publicPaths.contains(path)) {
            chain.doFilter(request, response);
            return;
        }
        
        // ログイン状態チェック
        HttpSession session = httpRequest.getSession(false);
        User loginUser = null;
        if (session != null) {
            loginUser = (User) session.getAttribute("loginUser");
        }
        
        if (loginUser == null) {
            // 未ログインの場合はログインページへリダイレクト
            httpResponse.sendRedirect("/login.jsp");
            return;
        }
        
        chain.doFilter(request, response);
    }
}</code></pre>
                </section>

                <!-- CSRF対策 -->
                <section id="csrf-protection">
                    <h2 class="section-title">🔒 CSRF攻撃対策</h2>
                    
                    <p><strong>CSRF（Cross-Site Request Forgery）</strong>は、ユーザーの意図しない操作を悪意のあるサイトから実行させる攻撃です。</p>

                    <div class="warning">
                        <h4>⚠️ CSRF攻撃の仕組み</h4>
                        <ol>
                            <li>ユーザーが正規サイトにログイン（セッション確立）</li>
                            <li>ユーザーが悪意のあるサイトを訪問</li>
                            <li>悪意のあるサイトが正規サイトへの不正リクエストを送信</li>
                            <li>ブラウザは自動的にセッション情報を送信</li>
                            <li>正規サイトは正当なリクエストと判断して処理実行</li>
                        </ol>
                    </div>

                    <h3>🛡️ CSRFトークンによる対策</h3>
                    
                    <pre class="code-block"><code class="language-java">// CSRFトークン生成・検証クラス
public class CSRFTokenUtil {
    private static final String CSRF_TOKEN_KEY = "csrfToken";
    
    public static String generateToken(HttpServletRequest request) {
        // セキュアランダム文字列を生成
        SecureRandom random = new SecureRandom();
        byte[] tokenBytes = new byte[32];
        random.nextBytes(tokenBytes);
        String token = Base64.getEncoder().encodeToString(tokenBytes);
        
        // セッションに保存
        HttpSession session = request.getSession();
        session.setAttribute(CSRF_TOKEN_KEY, token);
        
        return token;
    }
    
    public static boolean validateToken(HttpServletRequest request, String token) {
        HttpSession session = request.getSession(false);
        if (session == null) {
            return false;
        }
        
        String storedToken = (String) session.getAttribute(CSRF_TOKEN_KEY);
        return storedToken != null && storedToken.equals(token);
    }
}</code></pre>

                    <h3>📝 フォームでのCSRFトークン実装</h3>
                    
                    <pre class="code-block"><code class="language-jsp">&lt;%-- JSPページでのトークン生成 --%&gt;
&lt;%
String csrfToken = CSRFTokenUtil.generateToken(request);
%&gt;

&lt;html:form action="/userRegister"&gt;
    &lt;!-- 隠しフィールドでCSRFトークンを送信 --&gt;
    &lt;html:hidden property="csrfToken" value="&lt;%= csrfToken %&gt;"/&gt;
    
    &lt;table&gt;
        &lt;tr&gt;
            &lt;td&gt;ユーザー名:&lt;/td&gt;
            &lt;td&gt;&lt;html:text property="username"/&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;!-- 他のフィールド --&gt;
        &lt;tr&gt;
            &lt;td colspan="2"&gt;
                &lt;html:submit value="登録"/&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
&lt;/html:form&gt;</code></pre>

                    <pre class="code-block"><code class="language-java">// ActionクラスでのCSRF検証
public class UserRegisterAction extends SecureAction {
    
    public ActionForward execute(ActionMapping mapping, ActionForm form,
                                HttpServletRequest request, 
                                HttpServletResponse response) throws Exception {
        
        UserForm userForm = (UserForm) form;
        
        // CSRFトークン検証
        if (!CSRFTokenUtil.validateToken(request, userForm.getCsrfToken())) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE, 
                      new ActionMessage("error.csrf.invalid"));
            saveErrors(request, errors);
            return mapping.getInputForward();
        }
        
        // 通常の登録処理
        // ...
        
        return mapping.findForward("success");
    }
}</code></pre>
                </section>

                <!-- XSS対策 -->
                <section id="xss-protection">
                    <h2 class="section-title">⚡ XSS攻撃対策</h2>
                    
                    <p><strong>XSS（Cross-Site Scripting）</strong>は、アプリケーションに悪意のあるスクリプトを注入し、他のユーザーのブラウザで実行させる攻撃です。</p>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card security-card h-100">
                                <div class="card-header">
                                    🔴 反射型XSS
                                </div>
                                <div class="card-body">
                                    <p>ユーザーの入力をそのまま画面に表示</p>
                                    <p><strong>例:</strong> 検索結果ページでの検索キーワード表示</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card security-card h-100">
                                <div class="card-header">
                                    🔴 格納型XSS
                                </div>
                                <div class="card-body">
                                    <p>悪意のあるスクリプトをデータベースに保存</p>
                                    <p><strong>例:</strong> 掲示板の投稿内容、コメント機能</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>🛡️ XSS対策の実装</h3>
                    
                    <pre class="code-block"><code class="language-java">// HTMLエスケープユーティリティ
public class HtmlEscapeUtil {
    
    public static String escapeHtml(String input) {
        if (input == null) return null;
        
        return input.replace("&", "&amp;amp;")
                   .replace("&lt;", "&amp;lt;")
                   .replace("&gt;", "&amp;gt;")
                   .replace("\"", "&amp;quot;")
                   .replace("'", "&amp;#39;");
    }
    
    // より高度なエスケープ（OWASP Java Encoderの使用を推奨）
    public static String escapeHtmlAdvanced(String input) {
        // OWASP Java Encoder を使用した例
        // return Encode.forHtml(input);
        return escapeHtml(input); // 簡易版
    }
}</code></pre>

                    <h3>📝 JSPでのXSS対策</h3>
                    
                    <pre class="code-block"><code class="language-jsp">&lt;%-- Strutsタグによる自動エスケープ（推奨） --%&gt;
&lt;bean:write name="userForm" property="username"/&gt;

&lt;%-- filter属性でエスケープを制御 --%&gt;
&lt;bean:write name="userForm" property="username" filter="true"/&gt;

&lt;%-- HTMLを許可する場合（注意して使用） --%&gt;
&lt;bean:write name="userForm" property="description" filter="false"/&gt;

&lt;%-- 条件付き表示でのXSS対策 --%&gt;
&lt;logic:present name="searchKeyword"&gt;
    検索結果: &lt;bean:write name="searchKeyword"/&gt;
&lt;/logic:present&gt;</code></pre>

                    <div class="security">
                        <h4>✅ XSS対策のチェックポイント</h4>
                        <ul>
                            <li><strong>入力検証</strong>：許可する文字種類を明確に定義</li>
                            <li><strong>出力エスケープ</strong>：HTMLに出力する際は必ずエスケープ</li>
                            <li><strong>Content Security Policy</strong>：HTTPヘッダーでスクリプト実行を制限</li>
                            <li><strong>HTTPOnly Cookie</strong>：JavaScriptからのCookieアクセスを防止</li>
                        </ul>
                    </div>
                </section>

                <!-- セキュリティベストプラクティス -->
                <section id="security-best">
                    <h2 class="section-title">💡 セキュリティベストプラクティス</h2>

                    <div class="highlight">
                        <h4>🔐 認証・認可のベストプラクティス</h4>
                        <ul>
                            <li><strong>強力なパスワードポリシー</strong>：最小8文字、英数記号混在</li>
                            <li><strong>セッションタイムアウト</strong>：適切なタイムアウト時間設定</li>
                            <li><strong>アカウントロックアウト</strong>：ログイン試行回数制限</li>
                            <li><strong>セッション固定攻撃対策</strong>：ログイン後にセッションIDを再生成</li>
                        </ul>
                    </div>

                    <div class="security">
                        <h4>🛡️ インフラ・設定レベルの対策</h4>
                        <ul>
                            <li><strong>HTTPS通信</strong>：機密情報は必ず暗号化通信</li>
                            <li><strong>セキュリティヘッダー</strong>：X-Frame-Options、X-XSS-Protectionの設定</li>
                            <li><strong>エラーページ</strong>：技術的詳細を隠した汎用エラーページ</li>
                            <li><strong>ログ監視</strong>：不審なアクセスパターンの検出</li>
                        </ul>
                    </div>

                    <h3>📊 セキュリティチェックリスト</h3>
                    
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>カテゴリ</th>
                                <th>チェック項目</th>
                                <th>重要度</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>認証</td>
                                <td>パスワードのハッシュ化</td>
                                <td>⭐⭐⭐</td>
                            </tr>
                            <tr>
                                <td>セッション</td>
                                <td>適切なタイムアウト設定</td>
                                <td>⭐⭐⭐</td>
                            </tr>
                            <tr>
                                <td>入力検証</td>
                                <td>すべての入力データの検証</td>
                                <td>⭐⭐⭐</td>
                            </tr>
                            <tr>
                                <td>出力</td>
                                <td>HTMLエスケープ処理</td>
                                <td>⭐⭐⭐</td>
                            </tr>
                            <tr>
                                <td>CSRF</td>
                                <td>トークンベース防御</td>
                                <td>⭐⭐</td>
                            </tr>
                            <tr>
                                <td>通信</td>
                                <td>HTTPS通信の使用</td>
                                <td>⭐⭐⭐</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- 実習課題 -->
                <section id="exercise">
                    <div class="exercise-container">
                        <h2>💻 実習課題</h2>
                        
                        <h3>📋 課題: セキュアなログインシステム実装</h3>
                        <p>以下の要件を満たすログインシステムを実装してください。</p>
                        
                        <div class="highlight">
                            <h4>🎯 実装要件</h4>
                            <ul>
                                <li><strong>ユーザー認証</strong>：ユーザー名・パスワードによるログイン</li>
                                <li><strong>セッション管理</strong>：ログイン状態の保持と確認</li>
                                <li><strong>アクセス制御</strong>：ログイン必須ページの保護</li>
                                <li><strong>CSRF対策</strong>：重要な操作にトークン検証</li>
                                <li><strong>XSS対策</strong>：ユーザー入力の適切なエスケープ</li>
                                <li><strong>セキュリティ強化</strong>：ログイン試行回数制限</li>
                            </ul>
                        </div>

                        <h4>💡 実装のポイント</h4>
                        <ul>
                            <li>SecureActionクラスを作成して共通処理を実装</li>
                            <li>CSRFTokenUtilクラスでトークン管理</li>
                            <li>適切なエラーメッセージ表示</li>
                            <li>セッションタイムアウト対応</li>
                        </ul>
                    </div>
                </section>

                <!-- 理解度確認クイズ -->
                <section id="quiz">
                    <div class="quiz-container">
                        <h2>📝 理解度確認クイズ</h2>

                        <div class="quiz-item">
                            <h4>❓ 問題1</h4>
                            <p><strong>CSRF攻撃</strong>を防ぐ最も効果的な方法はどれですか？</p>
                            
                            <div class="quiz-options">
                                <label><input type="radio" name="q1" value="a"> a) セッションタイムアウトを短くする</label><br>
                                <label><input type="radio" name="q1" value="b"> b) CSRFトークンを使用する</label><br>
                                <label><input type="radio" name="q1" value="c"> c) HTTPSを使用する</label><br>
                                <label><input type="radio" name="q1" value="d"> d) パスワードを強力にする</label>
                            </div>
                            
                            <div class="quiz-answer" style="display: none;">
                                <strong>正解: b) CSRFトークンを使用する</strong><br>
                                CSRFトークンにより、正規のサイトからのリクエストと悪意のあるサイトからのリクエストを区別できます。
                            </div>
                        </div>

                        <div class="quiz-item">
                            <h4>❓ 問題2</h4>
                            <p><strong>XSS攻撃</strong>を防ぐために、JSPで文字列を表示する際に推奨される方法は？</p>
                            
                            <div class="quiz-options">
                                <label><input type="radio" name="q2" value="a"> a) &lt;%= variable %&gt; を使用する</label><br>
                                <label><input type="radio" name="q2" value="b"> b) &lt;bean:write name="variable" filter="false"/&gt; を使用する</label><br>
                                <label><input type="radio" name="q2" value="c"> b) &lt;bean:write name="variable"/&gt; を使用する</label><br>
                                <label><input type="radio" name="q2" value="d"> d) JavaScript で表示する</label>
                            </div>
                            
                            <div class="quiz-answer" style="display: none;">
                                <strong>正解: c) &lt;bean:write name="variable"/&gt; を使用する</strong><br>
                                bean:writeタグはデフォルトでHTMLエスケープを行うため、XSS攻撃を自動的に防げます。
                            </div>
                        </div>

                        <div class="quiz-item">
                            <h4>❓ 問題3</h4>
                            <p>セキュアなパスワード管理において、<strong>最も重要</strong>な要素はどれですか？</p>
                            
                            <div class="quiz-options">
                                <label><input type="radio" name="q3" value="a"> a) パスワードを平文で保存する</label><br>
                                <label><input type="radio" name="q3" value="b"> b) パスワードをBase64でエンコードして保存する</label><br>
                                <label><input type="radio" name="q3" value="c"> c) パスワードをソルト付きハッシュで保存する</label><br>
                                <label><input type="radio" name="q3" value="d"> d) パスワードを暗号化して保存する</label>
                            </div>
                            
                            <div class="quiz-answer" style="display: none;">
                                <strong>正解: c) パスワードをソルト付きハッシュで保存する</strong><br>
                                ソルト付きハッシュ化により、レインボーテーブル攻撃を防ぎ、パスワードを安全に保存できます。
                            </div>
                        </div>

                        <button type="button" class="btn btn-orange mt-3" onclick="showAllAnswers()">解答を表示</button>
                    </div>
                </section>

                <!-- ナビゲーション -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="struts1-learning-material-06.html" class="btn btn-outline-secondary">⬅️ 第6章に戻る</a>
                    <a href="struts1-learning-material-08.html" class="btn btn-orange">第8章に進む ➡️</a>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap 5 JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // Highlight.js初期化
            hljs.highlightAll();
            
            // Mermaid.js初期化
            mermaid.initialize({
                startOnLoad: true,
                theme: 'default'
            });
            
            // スムーズスクロール
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // サイドバーのアクティブリンク更新
            const observerOptions = {
                root: null,
                rootMargin: '0px 0px -80% 0px',
                threshold: 0.1
            };
            
            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        document.querySelectorAll('.nav-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        const activeLink = document.querySelector(`a[href="#${id}"]`);
                        if (activeLink) {
                            activeLink.classList.add('active');
                        }
                    }
                });
            }, observerOptions);
            
            // セクション要素を監視対象に追加
            document.querySelectorAll('section[id]').forEach(section => {
                observer.observe(section);
            });
        });
        
        // クイズ解答表示機能
        function showAllAnswers() {
            document.querySelectorAll('.quiz-answer').forEach(answer => {
                answer.style.display = 'block';
            });
        }
    </script>
</body>
</html>