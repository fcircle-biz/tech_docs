<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDBC学習教材 第3章 - 基本的なCRUD操作</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>JDBC学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-01.html">第1章: JDBCの基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-02.html">第2章: データベース接続</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="jdbc-learning-material-03.html">第3章: 基本的なCRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-04.html">第4章: 例外処理とリソース管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-05.html">第5章: 高度なJDBC機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-06.html">第6章: JDBCとオブジェクト指向設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-07.html">第7章: パフォーマンスとセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-08.html">第8章: 総合プロジェクト - 図書館管理システム</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-09.html">第9章: JDBCリファレンス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-10.html">第10章: データベース固有の設定</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第3章: 基本的なCRUD操作</h1>
                </div>

                <div id="chapter3">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">データの生命周期を管理する</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>CRUD操作（Create、Read、Update、Delete）の基本概念</li>
                            <li>SELECT文による安全なデータ取得方法</li>
                            <li>PreparedStatementを使用したパラメータ化クエリ</li>
                            <li>INSERT、UPDATE、DELETE文によるデータ操作</li>
                            <li>実践的な住所録管理システムの作成</li>
                        </ul>
                    </div>

                    <!-- セクション1: CRUD操作とは -->
                    <h3 class="section-title">3.1 CRUD操作の基本概念</h3>
                    <p>CRUDは、データベースアプリケーションにおける基本的な4つの操作を表す略語です。ほとんどのビジネスアプリケーションは、これらの操作を組み合わせて構築されています。</p>

                    <div class="mermaid">
                        flowchart LR
                            A["Create<br/>(作成)"] --> B["Read<br/>(読取)"]
                            B --> C["Update<br/>(更新)"]
                            C --> D["Delete<br/>(削除)"]
                            D --> A
                            
                            A1["INSERT文<br/>新しいデータを追加"] -.-> A
                            B1["SELECT文<br/>データを検索・取得"] -.-> B
                            C1["UPDATE文<br/>既存データを変更"] -.-> C
                            D1["DELETE文<br/>データを削除"] -.-> D
                            
                            style A fill:#e8f5e8
                            style B fill:#e1f5fe
                            style C fill:#fff3e0
                            style D fill:#ffebee
                    </div>

                    <div class="highlight">
                        <h6>各操作の実世界での例</h6>
                        <ul>
                            <li><strong>Create（作成）</strong>：新しい顧客アカウント作成、商品登録、注文作成など</li>
                            <li><strong>Read（読取）</strong>：顧客情報検索、商品一覧表示、売上レポート作成など</li>
                            <li><strong>Update（更新）</strong>：顧客情報変更、在庫数量更新、価格改定など</li>
                            <li><strong>Delete（削除）</strong>：不要データ削除、期限切れ情報除去、退会処理など</li>
                        </ul>
                    </div>

                    <!-- セクション2: PreparedStatementの優位性 -->
                    <h3 class="section-title">3.2 PreparedStatementが推奨される理由</h3>
                    <p>JDBCでは、SQL文を実行するために3つのStatementクラスが用意されていますが、PreparedStatementが最も推奨されます。その理由を理解することで、安全で効率的なプログラムを作成できます。</p>

                    <div class="mermaid">
                        flowchart TD
                            A["Statement"] --> A1["・文字列結合でSQL構築<br/>・SQLインジェクション脆弱性<br/>・毎回構文解析が必要"]
                            B["PreparedStatement"] --> B1["・パラメータ化クエリ<br/>・SQLインジェクション対策<br/>・構文解析の再利用"]
                            C["CallableStatement"] --> C1["・ストアドプロシージャ専用<br/>・複雑なビジネスロジック<br/>・データベース依存"]
                            
                            style B fill:#e8f5e8
                            style B1 fill:#e8f5e8
                            style A fill:#ffebee
                            style A1 fill:#ffebee
                    </div>

                    <h4>PreparedStatementの利点</h4>
                    <ul>
                        <li><strong>セキュリティ</strong>：SQLインジェクション攻撃を自動的に防止</li>
                        <li><strong>パフォーマンス</strong>：SQL文の構文解析結果を再利用</li>
                        <li><strong>可読性</strong>：パラメータが明確で、SQLが読みやすい</li>
                        <li><strong>型安全性</strong>：データ型の自動変換と検証</li>
                    </ul>

                    <!-- セクション3: データ取得（READ操作） -->
                    <h3 class="section-title">3.3 SELECT文によるデータ取得</h3>
                    <p>データベースからのデータ取得は、最も頻繁に行われる操作です。効率的で安全な取得方法を理解することで、パフォーマンスの良いアプリケーションを作成できます。</p>

                    <!-- 実習セクション1 -->
                    <div class="exercise-container">
                        <h5>実習 3-1: 基本的なSELECT操作</h5>
                        <p>住所録テーブルからデータを取得する基本的なプログラムを作成します。</p>
                        
                        <h6>事前準備：テーブル作成</h6>
                        <pre class="code-block"><code class="language-sql">CREATE TABLE contacts (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(200),
    phone VARCHAR(20),
    address VARCHAR(300),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- サンプルデータの挿入
INSERT INTO contacts (name, email, phone, address) VALUES
('田中太郎', 'tanaka@example.com', '090-1234-5678', '東京都渋谷区'),
('佐藤花子', 'sato@example.com', '090-9876-5432', '大阪府大阪市'),
('鈴木一郎', 'suzuki@example.com', '090-5555-7777', '名古屋市中区');</code></pre>

                        <h6>基本的なデータ取得プログラム</h6>
                        <pre class="code-block"><code class="language-java">import java.sql.*;

public class ContactReader {
    private static final String DB_URL = "jdbc:postgresql://localhost:5432/testdb";
    private static final String DB_USER = "postgres";
    private static final String DB_PASSWORD = "password";
    
    public static void main(String[] args) {
        // 全件取得
        getAllContacts();
        
        // 条件付き検索
        searchContactsByName("田中");
    }
    
    // 全件取得メソッド
    public static void getAllContacts() {
        String sql = "SELECT id, name, email, phone, address, created_at FROM contacts ORDER BY id";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql);
             ResultSet rs = pstmt.executeQuery()) {
            
            System.out.println("=== 全ての連絡先 ===");
            while (rs.next()) {
                int id = rs.getInt("id");
                String name = rs.getString("name");
                String email = rs.getString("email");
                String phone = rs.getString("phone");
                String address = rs.getString("address");
                Timestamp createdAt = rs.getTimestamp("created_at");
                
                System.out.printf("ID: %d, 名前: %s, Email: %s, 電話: %s, 住所: %s, 作成日: %s%n",
                    id, name, email, phone, address, createdAt);
            }
            
        } catch (SQLException e) {
            System.err.println("データ取得エラー: " + e.getMessage());
        }
    }
    
    // 名前で検索するメソッド
    public static void searchContactsByName(String searchName) {
        String sql = "SELECT id, name, email, phone, address FROM contacts WHERE name LIKE ?";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            // パラメータを設定（部分一致検索）
            pstmt.setString(1, "%" + searchName + "%");
            
            try (ResultSet rs = pstmt.executeQuery()) {
                System.out.println("=== 検索結果（名前: " + searchName + "）===");
                boolean found = false;
                
                while (rs.next()) {
                    found = true;
                    System.out.printf("ID: %d, 名前: %s, Email: %s%n",
                        rs.getInt("id"), rs.getString("name"), rs.getString("email"));
                }
                
                if (!found) {
                    System.out.println("該当する連絡先が見つかりませんでした。");
                }
            }
            
        } catch (SQLException e) {
            System.err.println("検索エラー: " + e.getMessage());
        }
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash">=== 全ての連絡先 ===
ID: 1, 名前: 田中太郎, Email: tanaka@example.com, 電話: 090-1234-5678, 住所: 東京都渋谷区, 作成日: 2024-01-01 10:00:00
ID: 2, 名前: 佐藤花子, Email: sato@example.com, 電話: 090-9876-5432, 住所: 大阪府大阪市, 作成日: 2024-01-01 10:01:00
ID: 3, 名前: 鈴木一郎, Email: suzuki@example.com, 電話: 090-5555-7777, 住所: 名古屋市中区, 作成日: 2024-01-01 10:02:00

=== 検索結果（名前: 田中）===
ID: 1, 名前: 田中太郎, Email: tanaka@example.com</code></pre>
                    </div>

                    <!-- セクション4: データ挿入（CREATE操作） -->
                    <h3 class="section-title">3.4 INSERT文によるデータ作成</h3>
                    <p>新しいデータをデータベースに挿入する操作です。ビジネスアプリケーションでは、顧客登録、商品追加、注文作成などで頻繁に使用されます。</p>

                    <div class="highlight">
                        <h6>INSERT操作のベストプラクティス</h6>
                        <ul>
                            <li><strong>必須項目の確認</strong>：NOT NULL制約のある列には必ず値を設定</li>
                            <li><strong>データ型の一致</strong>：列のデータ型に適した値を設定</li>
                            <li><strong>一意性制約</strong>：UNIQUEキーの重複を事前にチェック</li>
                            <li><strong>自動生成キー</strong>：自動採番されるIDの取得方法を理解</li>
                        </ul>
                    </div>

                    <!-- 実習セクション2 -->
                    <div class="exercise-container">
                        <h5>実習 3-2: データの挿入操作</h5>
                        <p>新しい連絡先をデータベースに登録するプログラムを作成します。</p>
                        
                        <h6>データ挿入プログラム</h6>
                        <pre class="code-block"><code class="language-java">import java.sql.*;

public class ContactCreator {
    private static final String DB_URL = "jdbc:postgresql://localhost:5432/testdb";
    private static final String DB_USER = "postgres";
    private static final String DB_PASSWORD = "password";
    
    public static void main(String[] args) {
        // 新しい連絡先を追加
        int newContactId = createContact("山田次郎", "yamada@example.com", "090-1111-2222", "福岡県福岡市");
        
        if (newContactId > 0) {
            System.out.println("連絡先が正常に作成されました。ID: " + newContactId);
            
            // 作成された連絡先を表示
            displayContact(newContactId);
        } else {
            System.out.println("連絡先の作成に失敗しました。");
        }
    }
    
    // 連絡先作成メソッド（生成されたIDを返す）
    public static int createContact(String name, String email, String phone, String address) {
        String sql = "INSERT INTO contacts (name, email, phone, address) VALUES (?, ?, ?, ?) RETURNING id";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            // パラメータを設定
            pstmt.setString(1, name);
            pstmt.setString(2, email);
            pstmt.setString(3, phone);
            pstmt.setString(4, address);
            
            // INSERT文を実行して結果を取得
            try (ResultSet rs = pstmt.executeQuery()) {
                if (rs.next()) {
                    return rs.getInt("id");
                }
            }
            
        } catch (SQLException e) {
            System.err.println("データ挿入エラー: " + e.getMessage());
        }
        
        return -1; // 失敗時は-1を返す
    }
    
    // 生成されたキーを取得する別の方法
    public static int createContactWithGeneratedKeys(String name, String email, String phone, String address) {
        String sql = "INSERT INTO contacts (name, email, phone, address) VALUES (?, ?, ?, ?)";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
            
            // パラメータを設定
            pstmt.setString(1, name);
            pstmt.setString(2, email);
            pstmt.setString(3, phone);
            pstmt.setString(4, address);
            
            // INSERT文を実行
            int affectedRows = pstmt.executeUpdate();
            
            if (affectedRows > 0) {
                // 生成されたキーを取得
                try (ResultSet generatedKeys = pstmt.getGeneratedKeys()) {
                    if (generatedKeys.next()) {
                        return generatedKeys.getInt(1);
                    }
                }
            }
            
        } catch (SQLException e) {
            System.err.println("データ挿入エラー: " + e.getMessage());
        }
        
        return -1;
    }
    
    // 連絡先表示メソッド
    public static void displayContact(int contactId) {
        String sql = "SELECT id, name, email, phone, address, created_at FROM contacts WHERE id = ?";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            pstmt.setInt(1, contactId);
            
            try (ResultSet rs = pstmt.executeQuery()) {
                if (rs.next()) {
                    System.out.println("=== 作成された連絡先情報 ===");
                    System.out.printf("ID: %d%n", rs.getInt("id"));
                    System.out.printf("名前: %s%n", rs.getString("name"));
                    System.out.printf("Email: %s%n", rs.getString("email"));
                    System.out.printf("電話: %s%n", rs.getString("phone"));
                    System.out.printf("住所: %s%n", rs.getString("address"));
                    System.out.printf("作成日: %s%n", rs.getTimestamp("created_at"));
                }
            }
            
        } catch (SQLException e) {
            System.err.println("データ表示エラー: " + e.getMessage());
        }
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash">連絡先が正常に作成されました。ID: 4
=== 作成された連絡先情報 ===
ID: 4
名前: 山田次郎
Email: yamada@example.com
電話: 090-1111-2222
住所: 福岡県福岡市
作成日: 2024-01-01 15:30:45</code></pre>
                    </div>

                    <!-- セクション5: データ更新（UPDATE操作） -->
                    <h3 class="section-title">3.5 UPDATE文によるデータ更新</h3>
                    <p>既存のデータを変更する操作です。顧客情報の更新、在庫数の調整、設定変更などで使用されます。安全な更新のために、WHERE句の適切な使用が重要です。</p>

                    <div class="warning">
                        <h6>UPDATE操作の注意点</h6>
                        <ul>
                            <li><strong>WHERE句の必須性</strong>：WHERE句を忘れると全行が更新される</li>
                            <li><strong>更新前の確認</strong>：まずSELECTで対象データを確認</li>
                            <li><strong>楽観的ロック</strong>：バージョン番号やタイムスタンプでの競合制御</li>
                            <li><strong>履歴保持</strong>：重要データは更新前の値をバックアップ</li>
                        </ul>
                    </div>

                    <!-- 実習セクション3 -->
                    <div class="exercise-container">
                        <h5>実習 3-3: データの更新操作</h5>
                        <p>既存の連絡先情報を更新するプログラムを作成します。</p>
                        
                        <h6>データ更新プログラム</h6>
                        <pre class="code-block"><code class="language-java">import java.sql.*;

public class ContactUpdater {
    private static final String DB_URL = "jdbc:postgresql://localhost:5432/testdb";
    private static final String DB_USER = "postgres";
    private static final String DB_PASSWORD = "password";
    
    public static void main(String[] args) {
        int contactId = 1; // 更新対象のID
        
        // 更新前の状態を表示
        System.out.println("=== 更新前の情報 ===");
        displayContact(contactId);
        
        // 連絡先情報を更新
        boolean updateResult = updateContact(contactId, "田中太郎（更新版）", "tanaka.new@example.com", "090-1234-9999", "東京都新宿区");
        
        if (updateResult) {
            System.out.println("\n連絡先が正常に更新されました。");
            
            // 更新後の状態を表示
            System.out.println("\n=== 更新後の情報 ===");
            displayContact(contactId);
        } else {
            System.out.println("連絡先の更新に失敗しました。");
        }
        
        // 部分更新（電話番号のみ）
        System.out.println("\n=== 部分更新テスト（電話番号のみ）===");
        updateContactPhone(2, "090-9876-1111");
        displayContact(2);
    }
    
    // 連絡先の全項目更新
    public static boolean updateContact(int id, String name, String email, String phone, String address) {
        String sql = "UPDATE contacts SET name = ?, email = ?, phone = ?, address = ? WHERE id = ?";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            // パラメータを設定
            pstmt.setString(1, name);
            pstmt.setString(2, email);
            pstmt.setString(3, phone);
            pstmt.setString(4, address);
            pstmt.setInt(5, id);
            
            // UPDATE文を実行
            int affectedRows = pstmt.executeUpdate();
            
            // 更新された行数をチェック
            if (affectedRows == 0) {
                System.out.println("指定されたIDの連絡先が見つかりません。ID: " + id);
                return false;
            } else if (affectedRows == 1) {
                System.out.println("1件の連絡先が更新されました。");
                return true;
            } else {
                System.out.println("警告: 複数の行が更新されました。件数: " + affectedRows);
                return true;
            }
            
        } catch (SQLException e) {
            System.err.println("更新エラー: " + e.getMessage());
            return false;
        }
    }
    
    // 電話番号のみ更新（部分更新の例）
    public static boolean updateContactPhone(int id, String phone) {
        String sql = "UPDATE contacts SET phone = ? WHERE id = ?";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            pstmt.setString(1, phone);
            pstmt.setInt(2, id);
            
            int affectedRows = pstmt.executeUpdate();
            
            if (affectedRows > 0) {
                System.out.println("電話番号が更新されました。");
                return true;
            } else {
                System.out.println("指定されたIDの連絡先が見つかりません。");
                return false;
            }
            
        } catch (SQLException e) {
            System.err.println("電話番号更新エラー: " + e.getMessage());
            return false;
        }
    }
    
    // 連絡先表示メソッド
    public static void displayContact(int contactId) {
        String sql = "SELECT id, name, email, phone, address, created_at FROM contacts WHERE id = ?";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            pstmt.setInt(1, contactId);
            
            try (ResultSet rs = pstmt.executeQuery()) {
                if (rs.next()) {
                    System.out.printf("ID: %d, 名前: %s, Email: %s, 電話: %s, 住所: %s%n",
                        rs.getInt("id"), rs.getString("name"), rs.getString("email"),
                        rs.getString("phone"), rs.getString("address"));
                } else {
                    System.out.println("指定されたIDの連絡先が見つかりません。");
                }
            }
            
        } catch (SQLException e) {
            System.err.println("表示エラー: " + e.getMessage());
        }
    }
}</code></pre>
                    </div>

                    <!-- セクション6: データ削除（DELETE操作） -->
                    <h3 class="section-title">3.6 DELETE文によるデータ削除</h3>
                    <p>不要なデータを削除する操作です。削除は元に戻すことができないため、特に慎重な実装が必要です。論理削除と物理削除の使い分けも重要な概念です。</p>

                    <div class="mermaid">
                        flowchart TD
                            A["削除方式の選択"] --> B["論理削除"]
                            A --> C["物理削除"]
                            
                            B --> B1["・フラグで削除状態を管理<br/>・データは実際には残る<br/>・復元が可能<br/>・履歴参照が可能"]
                            C --> C1["・データを完全に除去<br/>・ディスク容量の節約<br/>・復元不可能<br/>・関連データの整合性注意"]
                            
                            style B fill:#e8f5e8
                            style B1 fill:#e8f5e8
                            style C fill:#ffebee
                            style C1 fill:#ffebee
                    </div>

                    <!-- 実習セクション4 -->
                    <div class="exercise-container">
                        <h5>実習 3-4: データの削除操作</h5>
                        <p>連絡先の削除機能を実装します。物理削除と論理削除の両方を学習します。</p>
                        
                        <h6>論理削除のためのテーブル変更</h6>
                        <pre class="code-block"><code class="language-sql">-- deleted_at列を追加（論理削除用）
ALTER TABLE contacts ADD COLUMN deleted_at TIMESTAMP;</code></pre>

                        <h6>削除操作プログラム</h6>
                        <pre class="code-block"><code class="language-java">import java.sql.*;

public class ContactDeleter {
    private static final String DB_URL = "jdbc:postgresql://localhost:5432/testdb";
    private static final String DB_USER = "postgres";
    private static final String DB_PASSWORD = "password";
    
    public static void main(String[] args) {
        // テスト用データを作成
        int testId = createTestContact();
        
        // 論理削除のテスト
        System.out.println("=== 論理削除テスト ===");
        logicalDelete(testId);
        
        // 削除済みデータの確認
        displayAllContacts();
        
        // アクティブなデータのみ表示
        displayActiveContacts();
        
        // 物理削除のテスト
        System.out.println("\n=== 物理削除テスト ===");
        physicalDelete(testId);
        displayAllContacts();
    }
    
    // テスト用連絡先作成
    public static int createTestContact() {
        String sql = "INSERT INTO contacts (name, email, phone, address) VALUES (?, ?, ?, ?) RETURNING id";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            pstmt.setString(1, "削除テスト用");
            pstmt.setString(2, "test@example.com");
            pstmt.setString(3, "090-0000-0000");
            pstmt.setString(4, "テスト住所");
            
            try (ResultSet rs = pstmt.executeQuery()) {
                if (rs.next()) {
                    int id = rs.getInt("id");
                    System.out.println("テスト用連絡先を作成しました。ID: " + id);
                    return id;
                }
            }
            
        } catch (SQLException e) {
            System.err.println("テストデータ作成エラー: " + e.getMessage());
        }
        
        return -1;
    }
    
    // 論理削除（deleted_atに現在時刻を設定）
    public static boolean logicalDelete(int id) {
        String sql = "UPDATE contacts SET deleted_at = CURRENT_TIMESTAMP WHERE id = ? AND deleted_at IS NULL";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            pstmt.setInt(1, id);
            
            int affectedRows = pstmt.executeUpdate();
            
            if (affectedRows > 0) {
                System.out.println("連絡先を論理削除しました。ID: " + id);
                return true;
            } else {
                System.out.println("指定されたIDの連絡先が見つからないか、既に削除されています。");
                return false;
            }
            
        } catch (SQLException e) {
            System.err.println("論理削除エラー: " + e.getMessage());
            return false;
        }
    }
    
    // 物理削除（データを完全に削除）
    public static boolean physicalDelete(int id) {
        String sql = "DELETE FROM contacts WHERE id = ?";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            pstmt.setInt(1, id);
            
            int affectedRows = pstmt.executeUpdate();
            
            if (affectedRows > 0) {
                System.out.println("連絡先を物理削除しました。ID: " + id);
                return true;
            } else {
                System.out.println("指定されたIDの連絡先が見つかりません。");
                return false;
            }
            
        } catch (SQLException e) {
            System.err.println("物理削除エラー: " + e.getMessage());
            return false;
        }
    }
    
    // 全ての連絡先表示（削除済みも含む）
    public static void displayAllContacts() {
        String sql = "SELECT id, name, email, deleted_at FROM contacts ORDER BY id";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql);
             ResultSet rs = pstmt.executeQuery()) {
            
            System.out.println("\n=== 全ての連絡先（削除済み含む）===");
            while (rs.next()) {
                int id = rs.getInt("id");
                String name = rs.getString("name");
                String email = rs.getString("email");
                Timestamp deletedAt = rs.getTimestamp("deleted_at");
                
                String status = (deletedAt != null) ? "（削除済み: " + deletedAt + "）" : "（アクティブ）";
                System.out.printf("ID: %d, 名前: %s, Email: %s %s%n", id, name, email, status);
            }
            
        } catch (SQLException e) {
            System.err.println("データ表示エラー: " + e.getMessage());
        }
    }
    
    // アクティブな連絡先のみ表示
    public static void displayActiveContacts() {
        String sql = "SELECT id, name, email FROM contacts WHERE deleted_at IS NULL ORDER BY id";
        
        try (Connection conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement pstmt = conn.prepareStatement(sql);
             ResultSet rs = pstmt.executeQuery()) {
            
            System.out.println("\n=== アクティブな連絡先のみ ===");
            boolean hasActive = false;
            
            while (rs.next()) {
                hasActive = true;
                System.out.printf("ID: %d, 名前: %s, Email: %s%n",
                    rs.getInt("id"), rs.getString("name"), rs.getString("email"));
            }
            
            if (!hasActive) {
                System.out.println("アクティブな連絡先がありません。");
            }
            
        } catch (SQLException e) {
            System.err.println("アクティブデータ表示エラー: " + e.getMessage());
        }
    }
}</code></pre>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>CRUD操作の4つのオペレーションとそれぞれに対応するSQL文を説明してください。</li>
                            <li>PreparedStatementが通常のStatementより推奨される3つの理由を挙げてください。</li>
                            <li>INSERT文で自動生成されたキー（ID）を取得する2つの方法を説明してください。</li>
                            <li>UPDATE文を安全に実行するための注意点を3つ説明してください。</li>
                            <li>論理削除と物理削除の違いとそれぞれの利点・欠点を説明してください。</li>
                        </ol>
                        
                        <details>
                            <summary>解答例を見る</summary>
                            <ol>
                                <li>Create（INSERT文）：新規データ作成、Read（SELECT文）：データ読取、Update（UPDATE文）：データ更新、Delete（DELETE文）：データ削除</li>
                                <li>PreparedStatementの利点：(1)SQLインジェクション対策、(2)パフォーマンス向上（構文解析再利用）、(3)型安全性とコードの可読性</li>
                                <li>自動キー取得方法：(1)RETURNING句を使用してクエリ結果から取得、(2)Statement.RETURN_GENERATED_KEYSフラグとgetGeneratedKeys()メソッド</li>
                                <li>UPDATE安全実行のポイント：(1)WHERE句の必須指定、(2)更新前のデータ確認、(3)影響行数のチェック</li>
                                <li>論理削除：フラグで管理、復元可能、履歴保持、容量増加。物理削除：完全除去、容量節約、復元不可、関連整合性注意</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="jdbc-learning-material-02.html" class="btn btn-secondary">← 前の章：データベース接続</a>
                        <a href="jdbc-learning-material-04.html" class="btn btn-primary">次の章：例外処理とリソース管理 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>