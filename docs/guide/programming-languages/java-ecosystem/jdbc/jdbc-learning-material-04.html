<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDBC学習教材 第4章 - 例外処理とリソース管理</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>JDBC学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-1.html">第1章: JDBCの基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-2.html">第2章: データベース接続</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-3.html">第3章: 基本的なCRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="jdbc-learning-material-4.html">第4章: 例外処理とリソース管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-5.html">第5章: 高度なJDBC機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-6.html">第6章: JDBCとオブジェクト指向設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-7.html">第7章: パフォーマンスとセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-8.html">第8章: 総合プロジェクト - 図書館管理システム</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-9.html">第9章: JDBCリファレンス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-10.html">第10章: データベース固有の設定</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第4章: 例外処理とリソース管理</h1>
                </div>

                <div id="chapter4">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">安全で効率的なJDBCプログラム</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>JDBCにおける例外の種類と処理方法</li>
                            <li>try-with-resources構文による効率的なリソース管理</li>
                            <li>コネクションプールの基本概念と重要性</li>
                            <li>実践的な例外処理を実装したJDBCプログラムの作成</li>
                            <li>メモリリークを防ぐためのベストプラクティス</li>
                        </ul>
                    </div>

                    <!-- セクション1: JDBCの例外処理の基本 -->
                    <h3 class="section-title">4.1 JDBCにおける例外処理の重要性</h3>
                    <p>JDBCプログラムでは、データベース操作において様々なエラーが発生する可能性があります。これらのエラーを適切に処理することは、堅牢なアプリケーションを作成する上で非常に重要です。</p>

                    <div class="mermaid">
                        flowchart TD
                            A[JDBC操作開始] --> B{接続可能？}
                            B -->|Yes| C{SQL実行可能？}
                            B -->|No| D["SQLException<br/>接続エラー"]
                            C -->|Yes| E[処理成功]
                            C -->|No| F["SQLException<br/>SQL実行エラー"]
                            D --> G[例外処理]
                            F --> G
                            G --> H[適切なリソース解放]
                            H --> I[エラー通知・ログ出力]
                    </div>

                    <h4 class="mt-4">JDBCで発生する主な例外</h4>
                    <p><strong>SQLException</strong>は、JDBCでデータベース操作を行う際に発生する最も一般的な例外です。この例外には以下のような種類があります：</p>

                    <ul>
                        <li><strong>接続エラー</strong>：データベースサーバーへの接続に失敗した場合</li>
                        <li><strong>SQL構文エラー</strong>：SQL文に誤りがある場合</li>
                        <li><strong>権限エラー</strong>：テーブルへのアクセス権限が不足している場合</li>
                        <li><strong>制約違反エラー</strong>：一意制約やNOT NULL制約に違反した場合</li>
                        <li><strong>タイムアウトエラー</strong>：処理が時間制限を超えた場合</li>
                    </ul>

                    <!-- セクション2: try-with-resources構文 -->
                    <h3 class="section-title">4.2 try-with-resources構文による自動リソース管理</h3>
                    <p>Java 7で導入されたtry-with-resources構文は、JDBCプログラミングにおいて革命的な改善をもたらしました。この構文を使用することで、リソースの解放を自動化でき、メモリリークを防ぐことができます。</p>

                    <div class="warning">
                        <h5>従来の問題点</h5>
                        <p>従来のtry-catch-finallyブロックでは、finallyブロックでリソースを手動で解放する必要があり、コードが複雑になりがちでした。また、finally部分でも例外が発生する可能性があり、適切な処理が困難でした。</p>
                    </div>

                    <h4>try-with-resourcesの仕組み</h4>
                    <p>try-with-resources構文では、tryブロックの括弧内でリソースを宣言します。これらのリソースは、tryブロックの実行が完了すると自動的に<code>close()</code>メソッドが呼ばれます。</p>

                    <div class="mermaid">
                        flowchart LR
                            A[try-with-resources開始] --> B["リソース作成<br/>(Connection, Statement等)"]
                            B --> C[tryブロック実行]
                            C --> D{例外発生？}
                            D -->|No| E[正常終了]
                            D -->|Yes| F[catch処理]
                            E --> G["自動close()呼出"]
                            F --> G
                            G --> H[処理完了]
                    </div>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 4-1: try-with-resources構文の基本</h5>
                        <p>従来のtry-catch-finallyとtry-with-resourcesの比較を通して、自動リソース管理の利点を学習しましょう。</p>

                        <h6>従来の方法（推奨されない）</h6>
                        <pre class="code-block"><code class="language-java">// 従来のtry-catch-finally方式
Connection connection = null;
PreparedStatement statement = null;
ResultSet resultSet = null;

try {
    connection = DriverManager.getConnection(
        "jdbc:postgresql://localhost:5432/testdb", 
        "user", "password"
    );
    
    statement = connection.prepareStatement("SELECT * FROM users WHERE id = ?");
    statement.setInt(1, 1);
    resultSet = statement.executeQuery();
    
    if (resultSet.next()) {
        System.out.println("名前: " + resultSet.getString("name"));
    }
    
} catch (SQLException e) {
    System.err.println("データベースエラー: " + e.getMessage());
} finally {
    // 手動でのリソース解放（複雑で例外処理が困難）
    try {
        if (resultSet != null) resultSet.close();
    } catch (SQLException e) {
        System.err.println("ResultSet解放エラー: " + e.getMessage());
    }
    
    try {
        if (statement != null) statement.close();
    } catch (SQLException e) {
        System.err.println("Statement解放エラー: " + e.getMessage());
    }
    
    try {
        if (connection != null) connection.close();
    } catch (SQLException e) {
        System.err.println("Connection解放エラー: " + e.getMessage());
    }
}</code></pre>

                        <h6>try-with-resources方式（推奨）</h6>
                        <pre class="code-block"><code class="language-java">// try-with-resources方式
try (Connection connection = DriverManager.getConnection(
        "jdbc:postgresql://localhost:5432/testdb", "user", "password");
     PreparedStatement statement = connection.prepareStatement("SELECT * FROM users WHERE id = ?");
     ResultSet resultSet = statement.executeQuery()) {
    
    statement.setInt(1, 1);
    
    if (resultSet.next()) {
        System.out.println("名前: " + resultSet.getString("name"));
    }
    
} catch (SQLException e) {
    System.err.println("データベースエラー: " + e.getMessage());
    // 具体的なエラー情報を出力
    System.err.println("SQLState: " + e.getSQLState());
    System.err.println("ErrorCode: " + e.getErrorCode());
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>try-with-resources方式では、tryブロック終了時に自動的にリソースが解放されるため、コードがシンプルになり、リソースリークのリスクが大幅に軽減されます。</p>
                    </div>

                    <!-- セクション3: SQLException の詳細処理 -->
                    <h3 class="section-title">4.3 SQLExceptionの詳細情報活用</h3>
                    <p>SQLExceptionには、エラーの詳細を理解するための有用な情報が含まれています。これらの情報を適切に活用することで、より効果的なデバッグとエラー対応が可能になります。</p>

                    <h4>SQLExceptionの主要メソッド</h4>
                    <ul>
                        <li><strong>getMessage()</strong>：エラーメッセージを取得</li>
                        <li><strong>getSQLState()</strong>：SQL標準のエラーコードを取得</li>
                        <li><strong>getErrorCode()</strong>：データベース固有のエラーコードを取得</li>
                        <li><strong>getNextException()</strong>：連鎖した次の例外を取得</li>
                    </ul>

                    <!-- セクション4: コネクションプールの概念 -->
                    <h3 class="section-title">4.4 コネクションプールの基本概念</h3>
                    <p>コネクションプールは、データベース接続を効率的に管理するための重要な技術です。特に多数のユーザーが同時にアクセスするWebアプリケーションでは不可欠です。</p>

                    <div class="mermaid">
                        flowchart TB
                            subgraph "従来の方式"
                                A1[リクエスト1] --> B1[接続作成]
                                A2[リクエスト2] --> B2[接続作成]
                                A3[リクエスト3] --> B3[接続作成]
                                B1 --> C1[SQL実行]
                                B2 --> C2[SQL実行]
                                B3 --> C3[SQL実行]
                                C1 --> D1[接続破棄]
                                C2 --> D2[接続破棄]
                                C3 --> D3[接続破棄]
                            end
                            
                            subgraph "コネクションプール方式"
                                E[コネクションプール]
                                F1[リクエスト1] --> E
                                F2[リクエスト2] --> E
                                F3[リクエスト3] --> E
                                E --> G1[SQL実行1]
                                E --> G2[SQL実行2]
                                E --> G3[SQL実行3]
                                G1 --> E
                                G2 --> E
                                G3 --> E
                            end
                    </div>

                    <h4>コネクションプールの利点</h4>
                    <ul>
                        <li><strong>パフォーマンス向上</strong>：接続の作成・破棄コストを削減</li>
                        <li><strong>リソース制御</strong>：同時接続数を制限しデータベースを保護</li>
                        <li><strong>接続再利用</strong>：既存の接続を効率的に再活用</li>
                        <li><strong>メモリ最適化</strong>：不要な接続オブジェクトの削減</li>
                    </ul>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 4-2: 堅牢な例外処理を持つデータアクセス</h5>
                        <p>実際のアプリケーションで使用される、包括的な例外処理を実装したデータアクセスプログラムを作成してみましょう。</p>

                        <h6>手順</h6>
                        <ol>
                            <li>データベース接続設定クラスを作成</li>
                            <li>例外処理を含むユーザー検索メソッドを実装</li>
                            <li>リソースの適切な管理を確認</li>
                        </ol>

                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-java">public class UserRepository {
    private static final String DB_URL = "jdbc:postgresql://localhost:5432/testdb";
    private static final String DB_USER = "user";
    private static final String DB_PASSWORD = "password";
    
    /**
     * IDによるユーザー検索メソッド
     * @param userId 検索するユーザーID
     * @return ユーザー名、見つからない場合はnull
     */
    public String findUserNameById(int userId) {
        String sql = "SELECT name FROM users WHERE id = ?";
        
        try (Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            statement.setInt(1, userId);
            
            try (ResultSet resultSet = statement.executeQuery()) {
                if (resultSet.next()) {
                    return resultSet.getString("name");
                } else {
                    System.out.println("ユーザーID " + userId + " は見つかりませんでした");
                    return null;
                }
            }
            
        } catch (SQLException e) {
            // 詳細なエラー情報をログ出力
            System.err.println("=== データベースエラー詳細 ===");
            System.err.println("メッセージ: " + e.getMessage());
            System.err.println("SQLState: " + e.getSQLState());
            System.err.println("エラーコード: " + e.getErrorCode());
            
            // エラー種別による分岐処理
            String sqlState = e.getSQLState();
            if (sqlState != null) {
                if (sqlState.startsWith("08")) {
                    System.err.println("接続関連のエラーです");
                } else if (sqlState.startsWith("42")) {
                    System.err.println("SQL構文エラーです");
                } else if (sqlState.startsWith("23")) {
                    System.err.println("制約違反エラーです");
                }
            }
            
            // 本番環境では適切なロガーを使用
            // logger.error("Database error occurred", e);
            
            return null;
        }
    }
    
    /**
     * データベース接続テストメソッド
     * @return 接続可能な場合true
     */
    public boolean testConnection() {
        try (Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD)) {
            return connection.isValid(5); // 5秒以内に応答があるかテスト
        } catch (SQLException e) {
            System.err.println("データベース接続テストに失敗しました: " + e.getMessage());
            return false;
        }
    }
}</code></pre>

                        <h6>使用例</h6>
                        <pre class="code-block"><code class="language-java">public class Main {
    public static void main(String[] args) {
        UserRepository userRepository = new UserRepository();
        
        // 接続テスト
        if (!userRepository.testConnection()) {
            System.err.println("データベースに接続できません。設定を確認してください。");
            return;
        }
        
        // ユーザー検索テスト
        String userName = userRepository.findUserNameById(1);
        if (userName != null) {
            System.out.println("ユーザー名: " + userName);
        } else {
            System.out.println("ユーザーが見つからないかエラーが発生しました");
        }
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>このプログラムは、データベース接続エラー、SQL実行エラー、データが見つからない場合などを適切に処理し、リソースが確実に解放されます。</p>
                    </div>

                    <!-- セクション5: ベストプラクティス -->
                    <h3 class="section-title">4.5 JDBCリソース管理のベストプラクティス</h3>
                    <p>実際のアプリケーション開発で役立つ、JDBCリソース管理のベストプラクティスを紹介します。</p>

                    <div class="highlight">
                        <h5>重要なポイント</h5>
                        <ul>
                            <li><strong>必ずtry-with-resourcesを使用</strong>：自動リソース管理で確実な解放を保証</li>
                            <li><strong>接続の長期保持を避ける</strong>：必要な時だけ接続し、すぐに解放する</li>
                            <li><strong>PreparedStatementを再利用</strong>：同じSQL文を複数回実行する場合</li>
                            <li><strong>適切なタイムアウト設定</strong>：無限待機を防ぐための時間制限</li>
                            <li><strong>例外情報の活用</strong>：SQLStateやエラーコードによる適切な分岐処理</li>
                        </ul>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <p><strong>try-with-resources構文の利点は何ですか？最も適切なものを選択してください。</strong></p>
                                <ol type="a">
                                    <li>コードの実行速度が向上する</li>
                                    <li>リソースが自動的に解放されメモリリークを防ぐ</li>
                                    <li>例外が発生しなくなる</li>
                                    <li>データベース接続が高速化される</li>
                                </ol>
                            </li>
                            
                            <li>
                                <p><strong>SQLExceptionで取得できる情報として正しくないものはどれですか？</strong></p>
                                <ol type="a">
                                    <li>getMessage() - エラーメッセージ</li>
                                    <li>getSQLState() - SQL標準エラーコード</li>
                                    <li>getErrorCode() - データベース固有エラーコード</li>
                                    <li>getConnectionCount() - 現在の接続数</li>
                                </ol>
                            </li>
                            
                            <li>
                                <p><strong>コネクションプールの主な利点を3つ説明してください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>以下のコードの問題点を指摘し、try-with-resourcesを使用した改良版を書いてください。</strong></p>
                                <pre class="code-block"><code class="language-java">Connection conn = DriverManager.getConnection(url, user, pass);
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery("SELECT * FROM users");
// 処理...</code></pre>
                            </li>
                            
                            <li>
                                <p><strong>実際のWebアプリケーションで、なぜコネクションプールが必要なのか、具体例を挙げて説明してください。</strong></p>
                            </li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="jdbc-learning-material-3.html" class="btn btn-secondary">← 前の章</a>
                        <a href="jdbc-learning-material-5.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>