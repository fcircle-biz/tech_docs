<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JDBC学習教材 第7章 - パフォーマンスとセキュリティ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #f57c00;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>JDBC学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-01.html">第1章: JDBCの基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-02.html">第2章: データベース接続</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-03.html">第3章: 基本的なCRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-04.html">第4章: 例外処理とリソース管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-05.html">第5章: 高度なJDBC機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-06.html">第6章: JDBCとオブジェクト指向設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="jdbc-learning-material-07.html">第7章: パフォーマンスとセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-08.html">第8章: 総合プロジェクト - 図書館管理システム</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-09.html">第9章: JDBCリファレンス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="jdbc-learning-material-10.html">第10章: データベース固有の設定</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: パフォーマンスとセキュリティ</h1>
                </div>

                <div id="chapter7">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">本番運用に対応した安全で高速なJDBCアプリケーション</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>SQLインジェクション攻撃とその危険性</li>
                            <li>PreparedStatementによる安全なSQL実行</li>
                            <li>入力検証とエスケープ処理のベストプラクティス</li>
                            <li>JDBCアプリケーションのパフォーマンスチューニング手法</li>
                            <li>コネクションプールの効果的な利用方法</li>
                        </ul>
                    </div>

                    <!-- セクション1: SQLインジェクション脆弱性 -->
                    <h3 class="section-title">7.1 SQLインジェクション攻撃の理解</h3>
                    <p>SQLインジェクションは、Webアプリケーションにおいて最も深刻なセキュリティ脅威の一つです。攻撃者が悪意のあるSQL文を注入することで、データベースの不正操作が可能となります。</p>

                    <div class="warning">
                        <h5>SQLインジェクション攻撃の危険性</h5>
                        <ul>
                            <li><strong>データ漏洩</strong>：顧客情報や機密データの不正取得</li>
                            <li><strong>データ改ざん</strong>：重要なデータの削除や変更</li>
                            <li><strong>認証回避</strong>：管理者権限の不正取得</li>
                            <li><strong>システム破綻</strong>：データベースサーバーのダウン</li>
                        </ul>
                    </div>

                    <div class="mermaid">
                        flowchart TD
                            A[ユーザー入力] --> B{入力検証}
                            B -->|検証なし| C[直接SQL連結]
                            B -->|適切な検証| D[PreparedStatement]
                            C --> E[SQLインジェクション脆弱性]
                            D --> F[安全なSQL実行]
                            E --> G[データベース攻撃]
                            F --> H[正常なデータアクセス]
                    </div>

                    <!-- 実習1: SQLインジェクション脆弱性の例 -->
                    <div class="exercise-container">
                        <h5>実習 7-1: SQLインジェクション脆弱性の実例と対策</h5>
                        <p>SQLインジェクションがどのように発生し、どう防ぐのかを実際のコード例で学習します。</p>

                        <h6>危険な例（SQLインジェクション脆弱性あり）</h6>
                        <pre class="code-block"><code class="language-java">/**
 * 危険なコード例：SQLインジェクション脆弱性あり
 * 絶対に本番環境で使用してはいけません！
 */
public class VulnerableUserDAO {
    
    // 危険：ユーザー入力を直接SQL文に連結
    public User findByUsernameAndPassword(String username, String password) {
        // 攻撃例: username = "admin' OR '1'='1' --", password = "anything"
        // 結果のSQL: SELECT * FROM users WHERE username = 'admin' OR '1'='1' --' AND password = 'anything'
        // この場合、常に真となる条件により全ユーザーが返される
        
        String sql = "SELECT * FROM users WHERE username = '" + username + 
                    "' AND password = '" + password + "'";
        
        System.out.println("実行されるSQL: " + sql);
        
        try (Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             Statement statement = connection.createStatement();
             ResultSet resultSet = statement.executeQuery(sql)) {
            
            if (resultSet.next()) {
                return new User(
                    resultSet.getInt("id"),
                    resultSet.getString("username"),
                    resultSet.getString("email")
                );
            }
            
        } catch (SQLException e) {
            System.err.println("SQL実行エラー: " + e.getMessage());
        }
        
        return null;
    }
}</code></pre>

                        <h6>安全な例（PreparedStatement使用）</h6>
                        <pre class="code-block"><code class="language-java">/**
 * 安全なコード例：PreparedStatementによるSQLインジェクション対策
 */
public class SecureUserDAO {
    
    public User findByUsernameAndPassword(String username, String password) {
        String sql = "SELECT * FROM users WHERE username = ? AND password = ?";
        
        try (Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            // パラメータは自動的にエスケープされるため安全
            statement.setString(1, username);
            statement.setString(2, password); // 本番環境ではハッシュ化されたパスワードを使用
            
            try (ResultSet resultSet = statement.executeQuery()) {
                if (resultSet.next()) {
                    return new User(
                        resultSet.getInt("id"),
                        resultSet.getString("username"),
                        resultSet.getString("email")
                    );
                }
            }
            
        } catch (SQLException e) {
            System.err.println("SQL実行エラー: " + e.getMessage());
        }
        
        return null;
    }
    
    /**
     * より堅牢な検索メソッド（入力検証付き）
     */
    public User findByUsernameAndPasswordSecure(String username, String password) {
        // 入力検証
        if (username == null || username.trim().isEmpty()) {
            throw new IllegalArgumentException("ユーザー名が指定されていません");
        }
        
        if (password == null || password.trim().isEmpty()) {
            throw new IllegalArgumentException("パスワードが指定されていません");
        }
        
        // 長さ制限（DoS攻撃の防止）
        if (username.length() > 50) {
            throw new IllegalArgumentException("ユーザー名が長すぎます");
        }
        
        if (password.length() > 100) {
            throw new IllegalArgumentException("パスワードが長すぎます");
        }
        
        // 不正文字のチェック
        if (containsSqlKeywords(username)) {
            throw new IllegalArgumentException("ユーザー名に不正な文字が含まれています");
        }
        
        return findByUsernameAndPassword(username, password);
    }
    
    private boolean containsSqlKeywords(String input) {
        String[] sqlKeywords = {"'", "\"", ";", "--", "/*", "*/", "xp_", "sp_", 
                               "SELECT", "INSERT", "UPDATE", "DELETE", "DROP", "CREATE"};
        
        String upperInput = input.toUpperCase();
        for (String keyword : sqlKeywords) {
            if (upperInput.contains(keyword.toUpperCase())) {
                return true;
            }
        }
        return false;
    }
}</code></pre>

                        <h6>攻撃例の実演</h6>
                        <pre class="code-block"><code class="language-java">public class SqlInjectionDemo {
    public static void main(String[] args) {
        VulnerableUserDAO vulnerableDAO = new VulnerableUserDAO();
        SecureUserDAO secureDAO = new SecureUserDAO();
        
        // 通常の利用
        System.out.println("=== 通常の利用 ===");
        User normalUser = secureDAO.findByUsernameAndPassword("alice", "password123");
        System.out.println("結果: " + normalUser);
        
        // SQLインジェクション攻撃の試行
        System.out.println("\n=== SQLインジェクション攻撃の試行 ===");
        String maliciousUsername = "admin' OR '1'='1' --";
        String dummyPassword = "anything";
        
        // 脆弱なコードでは攻撃が成功する可能性
        System.out.println("脆弱なDAO:");
        User attackedUser = vulnerableDAO.findByUsernameAndPassword(maliciousUsername, dummyPassword);
        
        // 安全なコードでは攻撃が失敗
        System.out.println("安全なDAO:");
        User secureUser = secureDAO.findByUsernameAndPassword(maliciousUsername, dummyPassword);
        System.out.println("結果: " + secureUser); // null が返される
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>脆弱なコードでは不正なSQL文が生成され、攻撃が成功する可能性があります。一方、PreparedStatementを使用した安全なコードでは、攻撃は失敗し、期待通りnullが返されます。</p>
                    </div>

                    <!-- セクション2: 入力検証とサニタイゼーション -->
                    <h3 class="section-title">7.2 包括的な入力検証とサニタイゼーション</h3>
                    <p>PreparedStatementだけでなく、アプリケーション層での適切な入力検証も重要です。多層防御の考え方で、複数の防御ラインを構築します。</p>

                    <div class="highlight">
                        <h5>入力検証のベストプラクティス</h5>
                        <ul>
                            <li><strong>ホワイトリスト方式</strong>：許可する文字のみを定義</li>
                            <li><strong>長さ制限</strong>：DoS攻撃やバッファオーバーフローを防止</li>
                            <li><strong>型検証</strong>：期待するデータ型との一致確認</li>
                            <li><strong>範囲検証</strong>：数値や日付の有効範囲チェック</li>
                            <li><strong>正規表現活用</strong>：パターンマッチングによる形式検証</li>
                        </ul>
                    </div>

                    <!-- 実習2: 包括的な入力検証 -->
                    <div class="exercise-container">
                        <h5>実習 7-2: 堅牢な入力検証クラスの実装</h5>
                        <p>さまざまなタイプの入力に対する包括的な検証機能を実装します。</p>

                        <h6>入力検証ユーティリティクラス</h6>
                        <pre class="code-block"><code class="language-java">import java.util.regex.Pattern;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;

/**
 * 入力検証用ユーティリティクラス
 */
public class InputValidator {
    
    // 正規表現パターン
    private static final Pattern EMAIL_PATTERN = 
        Pattern.compile("^[A-Za-z0-9+_.-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})$");
    
    private static final Pattern PHONE_PATTERN = 
        Pattern.compile("^\\d{2,4}-\\d{2,4}-\\d{4}$");
    
    private static final Pattern ALPHANUMERIC_PATTERN = 
        Pattern.compile("^[A-Za-z0-9]+$");
    
    private static final Pattern SAFE_STRING_PATTERN = 
        Pattern.compile("^[A-Za-z0-9\\s\\-_.,!?()]+$");
    
    // 危険なSQL文字列
    private static final String[] SQL_KEYWORDS = {
        "SELECT", "INSERT", "UPDATE", "DELETE", "DROP", "CREATE", "ALTER",
        "EXEC", "EXECUTE", "UNION", "SCRIPT", "--", "/*", "*/"
    };
    
    /**
     * 文字列の基本検証
     */
    public static ValidationResult validateString(String input, String fieldName, 
                                                 int minLength, int maxLength, boolean required) {
        ValidationResult result = new ValidationResult();
        
        if (input == null || input.trim().isEmpty()) {
            if (required) {
                result.addError(fieldName + "は必須項目です");
            }
            return result;
        }
        
        String trimmed = input.trim();
        
        if (trimmed.length() < minLength) {
            result.addError(fieldName + "は" + minLength + "文字以上で入力してください");
        }
        
        if (trimmed.length() > maxLength) {
            result.addError(fieldName + "は" + maxLength + "文字以下で入力してください");
        }
        
        // SQLインジェクション検出
        if (containsSqlKeywords(trimmed)) {
            result.addError(fieldName + "に不正な文字列が含まれています");
        }
        
        return result;
    }
    
    /**
     * メールアドレス検証
     */
    public static ValidationResult validateEmail(String email) {
        ValidationResult result = validateString(email, "メールアドレス", 5, 100, true);
        
        if (result.isValid() && !EMAIL_PATTERN.matcher(email.trim()).matches()) {
            result.addError("正しいメールアドレス形式で入力してください");
        }
        
        return result;
    }
    
    /**
     * 電話番号検証
     */
    public static ValidationResult validatePhoneNumber(String phone) {
        ValidationResult result = validateString(phone, "電話番号", 10, 15, true);
        
        if (result.isValid() && !PHONE_PATTERN.matcher(phone.trim()).matches()) {
            result.addError("電話番号はXX-XXXX-XXXX形式で入力してください");
        }
        
        return result;
    }
    
    /**
     * 数値検証
     */
    public static ValidationResult validateInteger(String input, String fieldName, 
                                                  Integer min, Integer max, boolean required) {
        ValidationResult result = new ValidationResult();
        
        if (input == null || input.trim().isEmpty()) {
            if (required) {
                result.addError(fieldName + "は必須項目です");
            }
            return result;
        }
        
        try {
            int value = Integer.parseInt(input.trim());
            
            if (min != null && value < min) {
                result.addError(fieldName + "は" + min + "以上で入力してください");
            }
            
            if (max != null && value > max) {
                result.addError(fieldName + "は" + max + "以下で入力してください");
            }
            
        } catch (NumberFormatException e) {
            result.addError(fieldName + "は正しい数値で入力してください");
        }
        
        return result;
    }
    
    /**
     * 価格検証（BigDecimal）
     */
    public static ValidationResult validatePrice(String input, String fieldName) {
        ValidationResult result = new ValidationResult();
        
        if (input == null || input.trim().isEmpty()) {
            result.addError(fieldName + "は必須項目です");
            return result;
        }
        
        try {
            BigDecimal price = new BigDecimal(input.trim());
            
            if (price.compareTo(BigDecimal.ZERO) <= 0) {
                result.addError(fieldName + "は正の値で入力してください");
            }
            
            if (price.compareTo(new BigDecimal("9999999.99")) > 0) {
                result.addError(fieldName + "は9,999,999.99以下で入力してください");
            }
            
            // 小数点以下2桁チェック
            if (price.scale() > 2) {
                result.addError(fieldName + "は小数点以下2桁以内で入力してください");
            }
            
        } catch (NumberFormatException e) {
            result.addError(fieldName + "は正しい金額形式で入力してください");
        }
        
        return result;
    }
    
    /**
     * 日付検証
     */
    public static ValidationResult validateDate(String input, String fieldName, boolean required) {
        ValidationResult result = new ValidationResult();
        
        if (input == null || input.trim().isEmpty()) {
            if (required) {
                result.addError(fieldName + "は必須項目です");
            }
            return result;
        }
        
        try {
            LocalDate date = LocalDate.parse(input.trim(), DateTimeFormatter.ofPattern("yyyy-MM-dd"));
            
            // 未来日チェック（必要に応じて）
            if (date.isAfter(LocalDate.now())) {
                result.addError(fieldName + "は本日以前の日付で入力してください");
            }
            
        } catch (DateTimeParseException e) {
            result.addError(fieldName + "はyyyy-MM-dd形式で入力してください");
        }
        
        return result;
    }
    
    /**
     * SQLキーワード検出
     */
    private static boolean containsSqlKeywords(String input) {
        String upperInput = input.toUpperCase();
        for (String keyword : SQL_KEYWORDS) {
            if (upperInput.contains(keyword)) {
                return true;
            }
        }
        return false;
    }
}</code></pre>

                        <h6>検証結果クラス</h6>
                        <pre class="code-block"><code class="language-java">import java.util.ArrayList;
import java.util.List;

/**
 * 検証結果を格納するクラス
 */
public class ValidationResult {
    private List&lt;String&gt; errors;
    
    public ValidationResult() {
        this.errors = new ArrayList&lt;&gt;();
    }
    
    public void addError(String error) {
        errors.add(error);
    }
    
    public boolean isValid() {
        return errors.isEmpty();
    }
    
    public List&lt;String&gt; getErrors() {
        return new ArrayList&lt;&gt;(errors);
    }
    
    public String getAllErrorsAsString() {
        return String.join(", ", errors);
    }
    
    @Override
    public String toString() {
        if (isValid()) {
            return "検証成功";
        } else {
            return "検証エラー: " + getAllErrorsAsString();
        }
    }
}</code></pre>

                        <h6>使用例</h6>
                        <pre class="code-block"><code class="language-java">public class ValidationDemo {
    public static void main(String[] args) {
        // 正常なケース
        System.out.println("=== 正常な入力の検証 ===");
        ValidationResult emailResult = InputValidator.validateEmail("user@example.com");
        System.out.println("メール: " + emailResult);
        
        ValidationResult priceResult = InputValidator.validatePrice("1299.99", "商品価格");
        System.out.println("価格: " + priceResult);
        
        // 異常なケース
        System.out.println("\n=== 異常な入力の検証 ===");
        ValidationResult badEmail = InputValidator.validateEmail("invalid-email");
        System.out.println("不正メール: " + badEmail);
        
        ValidationResult sqlInjection = InputValidator.validateString("admin'; DROP TABLE users; --", 
                                                                     "ユーザー名", 3, 50, true);
        System.out.println("SQLインジェクション試行: " + sqlInjection);
        
        ValidationResult negativePrice = InputValidator.validatePrice("-100", "商品価格");
        System.out.println("負の価格: " + negativePrice);
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>正常な入力は検証を通過し、不正な入力（SQLインジェクション試行、不正な形式、範囲外の値など）は適切にエラーメッセージと共に拒否されます。</p>
                    </div>

                    <!-- セクション3: パフォーマンス最適化 -->
                    <h3 class="section-title">7.3 JDBCパフォーマンス最適化技法</h3>
                    <p>大量のデータを効率的に処理し、応答時間を短縮するためのパフォーマンス最適化手法を学習します。</p>

                    <div class="mermaid">
                        flowchart TB
                            A[パフォーマンス最適化] --> B[接続最適化]
                            A --> C[SQL最適化]
                            A --> D[データ転送最適化]
                            A --> E[キャッシング]
                            
                            B --> B1[コネクションプール]
                            B --> B2[接続設定調整]
                            
                            C --> C1[インデックス活用]
                            C --> C2[クエリ最適化]
                            C --> C3[バッチ処理]
                            
                            D --> D1[フェッチサイズ調整]
                            D --> D2[必要最小限の列選択]
                            
                            E --> E1[結果セットキャッシュ]
                            E --> E2[PreparedStatementキャッシュ]
                    </div>

                    <!-- 実習3: パフォーマンス最適化 -->
                    <div class="exercise-container">
                        <h5>実習 7-3: パフォーマンス最適化の実装</h5>
                        <p>実際のパフォーマンス最適化技法を適用し、処理速度の改善を確認します。</p>

                        <h6>最適化前のコード（基準）</h6>
                        <pre class="code-block"><code class="language-java">public class UnoptimizedDAO {
    private static final String DB_URL = "jdbc:postgresql://localhost:5432/testdb";
    private static final String DB_USER = "user";
    private static final String DB_PASSWORD = "password";
    
    /**
     * 非効率な大量データ処理（最適化前）
     */
    public List&lt;Product&gt; getAllProductsUnoptimized() {
        List&lt;Product&gt; products = new ArrayList&lt;&gt;();
        String sql = "SELECT * FROM products";
        
        try (Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             Statement statement = connection.createStatement();
             ResultSet resultSet = statement.executeQuery(sql)) {
            
            // デフォルトのフェッチサイズ（通常10程度）
            while (resultSet.next()) {
                Product product = new Product();
                product.setId(resultSet.getInt("id"));
                product.setName(resultSet.getString("name"));
                product.setDescription(resultSet.getString("description"));
                product.setPrice(resultSet.getBigDecimal("price"));
                product.setStock(resultSet.getInt("stock"));
                product.setCategoryId(resultSet.getInt("category_id"));
                products.add(product);
            }
            
        } catch (SQLException e) {
            System.err.println("データ取得エラー: " + e.getMessage());
        }
        
        return products;
    }
}</code></pre>

                        <h6>最適化後のコード</h6>
                        <pre class="code-block"><code class="language-java">public class OptimizedDAO {
    private static final String DB_URL = "jdbc:postgresql://localhost:5432/testdb";
    private static final String DB_USER = "user"; 
    private static final String DB_PASSWORD = "password";
    
    // PreparedStatementのキャッシュ
    private final Map&lt;String, PreparedStatement&gt; statementCache = new ConcurrentHashMap&lt;&gt;();
    
    /**
     * 最適化された大量データ処理
     */
    public List&lt;Product&gt; getAllProductsOptimized() {
        List&lt;Product&gt; products = new ArrayList&lt;&gt;();
        String sql = "SELECT id, name, price, stock, category_id FROM products"; // 必要な列のみ選択
        
        try (Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            // フェッチサイズを大きく設定（ネットワーク往復回数を削減）
            statement.setFetchSize(1000);
            
            try (ResultSet resultSet = statement.executeQuery()) {
                while (resultSet.next()) {
                    // 必要最小限の処理
                    Product product = new Product();
                    product.setId(resultSet.getInt("id"));
                    product.setName(resultSet.getString("name"));
                    product.setPrice(resultSet.getBigDecimal("price"));
                    product.setStock(resultSet.getInt("stock"));
                    product.setCategoryId(resultSet.getInt("category_id"));
                    products.add(product);
                }
            }
            
        } catch (SQLException e) {
            System.err.println("データ取得エラー: " + e.getMessage());
        }
        
        return products;
    }
    
    /**
     * ページング機能付きデータ取得
     */
    public List&lt;Product&gt; getProductsWithPaging(int page, int pageSize) {
        List&lt;Product&gt; products = new ArrayList&lt;&gt;();
        int offset = page * pageSize;
        
        String sql = "SELECT id, name, price, stock, category_id FROM products " +
                    "ORDER BY id LIMIT ? OFFSET ?";
        
        try (Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            statement.setInt(1, pageSize);
            statement.setInt(2, offset);
            
            try (ResultSet resultSet = statement.executeQuery()) {
                while (resultSet.next()) {
                    Product product = new Product();
                    product.setId(resultSet.getInt("id"));
                    product.setName(resultSet.getString("name"));
                    product.setPrice(resultSet.getBigDecimal("price"));
                    product.setStock(resultSet.getInt("stock"));
                    product.setCategoryId(resultSet.getInt("category_id"));
                    products.add(product);
                }
            }
            
        } catch (SQLException e) {
            System.err.println("ページングデータ取得エラー: " + e.getMessage());
        }
        
        return products;
    }
    
    /**
     * 接続設定を最適化
     */
    private Connection getOptimizedConnection() throws SQLException {
        Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
        
        // 自動コミットを無効化（バッチ処理の場合）
        connection.setAutoCommit(false);
        
        // トランザクション分離レベルを調整
        connection.setTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);
        
        return connection;
    }
    
    /**
     * バッチ処理の最適化
     */
    public int insertProductsBatchOptimized(List&lt;Product&gt; products) {
        String sql = "INSERT INTO products (name, price, stock, category_id) VALUES (?, ?, ?, ?)";
        int insertedCount = 0;
        
        try (Connection connection = getOptimizedConnection();
             PreparedStatement statement = connection.prepareStatement(sql)) {
            
            final int BATCH_SIZE = 1000;
            int count = 0;
            
            for (Product product : products) {
                statement.setString(1, product.getName());
                statement.setBigDecimal(2, product.getPrice());
                statement.setInt(3, product.getStock());
                statement.setInt(4, product.getCategoryId());
                statement.addBatch();
                count++;
                
                // バッチサイズに達したら実行
                if (count % BATCH_SIZE == 0) {
                    int[] results = statement.executeBatch();
                    insertedCount += results.length;
                    connection.commit(); // 中間コミット
                    System.out.println(insertedCount + "件処理完了");
                }
            }
            
            // 残りのバッチを実行
            if (count % BATCH_SIZE != 0) {
                int[] results = statement.executeBatch();
                insertedCount += results.length;
                connection.commit();
            }
            
        } catch (SQLException e) {
            System.err.println("バッチ挿入エラー: " + e.getMessage());
        }
        
        return insertedCount;
    }
}</code></pre>

                        <h6>パフォーマンステスト</h6>
                        <pre class="code-block"><code class="language-java">public class PerformanceTest {
    public static void main(String[] args) {
        UnoptimizedDAO unoptimizedDAO = new UnoptimizedDAO();
        OptimizedDAO optimizedDAO = new OptimizedDAO();
        
        // 最適化前のテスト
        long startTime = System.currentTimeMillis();
        List&lt;Product&gt; products1 = unoptimizedDAO.getAllProductsUnoptimized();
        long endTime = System.currentTimeMillis();
        System.out.println("最適化前: " + (endTime - startTime) + "ms で " + products1.size() + "件取得");
        
        // 最適化後のテスト
        startTime = System.currentTimeMillis();
        List&lt;Product&gt; products2 = optimizedDAO.getAllProductsOptimized();
        endTime = System.currentTimeMillis();
        System.out.println("最適化後: " + (endTime - startTime) + "ms で " + products2.size() + "件取得");
        
        // ページングテスト
        startTime = System.currentTimeMillis();
        List&lt;Product&gt; pagedProducts = optimizedDAO.getProductsWithPaging(0, 100);
        endTime = System.currentTimeMillis();
        System.out.println("ページング: " + (endTime - startTime) + "ms で " + pagedProducts.size() + "件取得");
    }
}</code></pre>

                        <h6>期待される結果</h6>
                        <p>最適化後のコードは、フェッチサイズの調整、必要最小限の列選択、ページング機能により、大幅な性能向上を示します。特に大量データ処理において顕著な改善が確認できます。</p>
                    </div>

                    <!-- セクション4: セキュリティベストプラクティス -->
                    <h3 class="section-title">7.4 本番環境でのセキュリティベストプラクティス</h3>
                    <p>本番運用において重要なセキュリティ対策を包括的に学習します。</p>

                    <div class="highlight">
                        <h5>重要なセキュリティ対策</h5>
                        <ul>
                            <li><strong>接続暗号化</strong>：SSL/TLS通信の有効化</li>
                            <li><strong>認証強化</strong>：強固なパスワードポリシーとアクセス制御</li>
                            <li><strong>ログ監視</strong>：不正アクセスの検出と記録</li>
                            <li><strong>権限最小化</strong>：データベースユーザーの権限を必要最小限に限定</li>
                            <li><strong>機密情報保護</strong>：パスワードや個人情報の適切な暗号化</li>
                        </ul>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <p><strong>SQLインジェクション攻撃の危険性を3つ挙げ、それぞれ具体例と共に説明してください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>以下のコードの問題点を指摘し、安全な改良版を記述してください：</strong></p>
                                <pre class="code-block"><code class="language-java">String sql = "SELECT * FROM users WHERE id = " + userId;
Statement stmt = connection.createStatement();
ResultSet rs = stmt.executeQuery(sql);</code></pre>
                            </li>
                            
                            <li>
                                <p><strong>PreparedStatementがSQLインジェクションを防ぐ仕組みを説明してください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>JDBCアプリケーションのパフォーマンスを向上させる手法を5つ挙げ、それぞれの効果を説明してください。</strong></p>
                            </li>
                            
                            <li>
                                <p><strong>多層防御の観点から、JDBCアプリケーションで実装すべきセキュリティ対策を整理してください。</strong></p>
                                <ul>
                                    <li>アプリケーション層での対策</li>
                                    <li>データベース層での対策</li>
                                    <li>インフラ層での対策</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="jdbc-learning-material-06.html" class="btn btn-secondary">← 前の章</a>
                        <a href="jdbc-learning-material-08.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>