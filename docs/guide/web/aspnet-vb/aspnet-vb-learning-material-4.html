<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET(VB.NET)学習教材 第4章 - サーバーコントロールとイベント処理</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #1976d2;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #1976d2;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #42a5f5;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #1976d2;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #1976d2 !important;
            color: white !important;
        }

        /* プリフォーマット */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ASP.NET(VB.NET)学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../README.md">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.md">ASP.NET VBガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: ASP.NET基礎とセットアップ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: VB.NET言語基礎復習</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">第3章: Web Forms基本</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter4">第4章: サーバーコントロールとイベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">第5章: データベース連携（ADO.NET）</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">第6章: セッション管理と状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">第7章: 認証とセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: エラーハンドリングとデバッグ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第4章: サーバーコントロールとイベント処理</h1>
                </div>

                <div id="chapter4">
                    <h2 class="chapter-title">ASP.NETサーバーコントロールとイベント駆動プログラミング</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>ASP.NETサーバーコントロールの種類と特徴</li>
                            <li>ポストバックメカニズムとイベント駆動モデル</li>
                            <li>基本コントロール（Label、TextBox、Button等）の使用方法</li>
                            <li>選択コントロール（DropDownList、CheckBox等）の実装</li>
                            <li>検証コントロールによる入力チェック</li>
                            <li>複合コントロール（GridView、Repeater等）の基本</li>
                            <li>カスタムイベントハンドラーの作成と活用</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.1 ASP.NETサーバーコントロールの概要</h3>
                    <p>ASP.NETサーバーコントロールは、サーバーサイドで処理されるプログラマブルなUI要素です。HTMLコントロールとは異なり、オブジェクト指向の機能を提供します。</p>
                    
                    <h4>サーバーコントロールの特徴</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>特徴</th>
                                <th>説明</th>
                                <th>利点</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>オブジェクト指向</td>
                                <td>プロパティ、メソッド、イベントを持つ</td>
                                <td>プログラムで動的に制御可能</td>
                            </tr>
                            <tr>
                                <td>自動HTML生成</td>
                                <td>ブラウザに応じた最適なHTMLを出力</td>
                                <td>クロスブラウザ対応</td>
                            </tr>
                            <tr>
                                <td>ViewState</td>
                                <td>ポストバック間での状態保持</td>
                                <td>Windowsアプリのような動作</td>
                            </tr>
                            <tr>
                                <td>イベント処理</td>
                                <td>サーバーサイドでのイベント処理</td>
                                <td>直感的なプログラミング</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 4-1: 基本的なサーバーコントロールの使用</h5>
                        <p>様々なサーバーコントロールを使用した従業員情報管理フォームを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいWebフォーム「EmployeeForm.aspx」を作成</li>
                            <li>基本的なサーバーコントロールを配置</li>
                            <li>各コントロールのイベント処理を実装</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>EmployeeForm.aspx</strong></p>
                        <pre><code>&lt;%@ Page Language="VB" AutoEventWireup="false" CodeBehind="EmployeeForm.aspx.vb" 
    Inherits="WebApplication1.EmployeeForm" %&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head runat="server"&gt;
    &lt;title&gt;従業員情報管理&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" /&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id="form1" runat="server"&gt;
        &lt;div class="container mt-4"&gt;
            &lt;h2&gt;従業員情報管理システム&lt;/h2&gt;
            
            &lt;div class="row"&gt;
                &lt;div class="col-md-8"&gt;
                    &lt;div class="card"&gt;
                        &lt;div class="card-header"&gt;
                            &lt;h4&gt;基本情報&lt;/h4&gt;
                        &lt;/div&gt;
                        &lt;div class="card-body"&gt;
                            &lt;!-- 従業員ID --&gt;
                            &lt;div class="mb-3 row"&gt;
                                &lt;asp:Label ID="lblEmployeeId" runat="server" Text="従業員ID:" 
                                    CssClass="col-sm-3 col-form-label"&gt;&lt;/asp:Label&gt;
                                &lt;div class="col-sm-9"&gt;
                                    &lt;asp:TextBox ID="txtEmployeeId" runat="server" CssClass="form-control" 
                                        placeholder="EMP001" MaxLength="10"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:RequiredFieldValidator ID="rfvEmployeeId" runat="server" 
                                        ControlToValidate="txtEmployeeId" ErrorMessage="従業員IDは必須です"
                                        CssClass="text-danger" Display="Dynamic"&gt;&lt;/asp:RequiredFieldValidator&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;

                            &lt;!-- 氏名 --&gt;
                            &lt;div class="mb-3 row"&gt;
                                &lt;asp:Label ID="lblName" runat="server" Text="氏名:" 
                                    CssClass="col-sm-3 col-form-label"&gt;&lt;/asp:Label&gt;
                                &lt;div class="col-sm-9"&gt;
                                    &lt;asp:TextBox ID="txtName" runat="server" CssClass="form-control" 
                                        placeholder="山田太郎"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:RequiredFieldValidator ID="rfvName" runat="server" 
                                        ControlToValidate="txtName" ErrorMessage="氏名は必須です"
                                        CssClass="text-danger" Display="Dynamic"&gt;&lt;/asp:RequiredFieldValidator&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;

                            &lt;!-- 部署 --&gt;
                            &lt;div class="mb-3 row"&gt;
                                &lt;asp:Label ID="lblDepartment" runat="server" Text="部署:" 
                                    CssClass="col-sm-3 col-form-label"&gt;&lt;/asp:Label&gt;
                                &lt;div class="col-sm-9"&gt;
                                    &lt;asp:DropDownList ID="ddlDepartment" runat="server" CssClass="form-select" AutoPostBack="True"&gt;
                                        &lt;asp:ListItem Value=""&gt;-- 選択してください --&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="HR"&gt;人事部&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="IT"&gt;IT部&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="SALES"&gt;営業部&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="FINANCE"&gt;経理部&lt;/asp:ListItem&gt;
                                    &lt;/asp:DropDownList&gt;
                                    &lt;asp:RequiredFieldValidator ID="rfvDepartment" runat="server" 
                                        ControlToValidate="ddlDepartment" ErrorMessage="部署を選択してください"
                                        CssClass="text-danger" Display="Dynamic" InitialValue=""&gt;&lt;/asp:RequiredFieldValidator&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;

                            &lt;!-- 役職 --&gt;
                            &lt;div class="mb-3 row"&gt;
                                &lt;asp:Label ID="lblPosition" runat="server" Text="役職:" 
                                    CssClass="col-sm-3 col-form-label"&gt;&lt;/asp:Label&gt;
                                &lt;div class="col-sm-9"&gt;
                                    &lt;asp:RadioButtonList ID="rblPosition" runat="server" RepeatDirection="Horizontal" CssClass="form-check"&gt;
                                        &lt;asp:ListItem Value="STAFF"&gt;一般&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="SUPERVISOR"&gt;主任&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="MANAGER"&gt;課長&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="DIRECTOR"&gt;部長&lt;/asp:ListItem&gt;
                                    &lt;/asp:RadioButtonList&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;

                            &lt;!-- 給与 --&gt;
                            &lt;div class="mb-3 row"&gt;
                                &lt;asp:Label ID="lblSalary" runat="server" Text="月給:" 
                                    CssClass="col-sm-3 col-form-label"&gt;&lt;/asp:Label&gt;
                                &lt;div class="col-sm-9"&gt;
                                    &lt;div class="input-group"&gt;
                                        &lt;span class="input-group-text"&gt;¥&lt;/span&gt;
                                        &lt;asp:TextBox ID="txtSalary" runat="server" CssClass="form-control" 
                                            TextMode="Number" placeholder="300000"&gt;&lt;/asp:TextBox&gt;
                                    &lt;/div&gt;
                                    &lt;asp:RangeValidator ID="rvSalary" runat="server" 
                                        ControlToValidate="txtSalary" ErrorMessage="給与は150,000円から1,000,000円の間で入力してください"
                                        MinimumValue="150000" MaximumValue="1000000" Type="Integer"
                                        CssClass="text-danger" Display="Dynamic"&gt;&lt;/asp:RangeValidator&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;

                            &lt;!-- スキル --&gt;
                            &lt;div class="mb-3 row"&gt;
                                &lt;asp:Label ID="lblSkills" runat="server" Text="保有スキル:" 
                                    CssClass="col-sm-3 col-form-label"&gt;&lt;/asp:Label&gt;
                                &lt;div class="col-sm-9"&gt;
                                    &lt;asp:CheckBoxList ID="cblSkills" runat="server"&gt;
                                        &lt;asp:ListItem Value="VB.NET"&gt;VB.NET&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="C#"&gt;C#&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="ASP.NET"&gt;ASP.NET&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="SQL Server"&gt;SQL Server&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="JavaScript"&gt;JavaScript&lt;/asp:ListItem&gt;
                                        &lt;asp:ListItem Value="HTML/CSS"&gt;HTML/CSS&lt;/asp:ListItem&gt;
                                    &lt;/asp:CheckBoxList&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;

                            &lt;!-- コメント --&gt;
                            &lt;div class="mb-3 row"&gt;
                                &lt;asp:Label ID="lblComments" runat="server" Text="備考:" 
                                    CssClass="col-sm-3 col-form-label"&gt;&lt;/asp:Label&gt;
                                &lt;div class="col-sm-9"&gt;
                                    &lt;asp:TextBox ID="txtComments" runat="server" CssClass="form-control" 
                                        TextMode="MultiLine" Rows="3" placeholder="特記事項があれば記入してください"&gt;&lt;/asp:TextBox&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;

                            &lt;!-- ボタン --&gt;
                            &lt;div class="mb-3 row"&gt;
                                &lt;div class="col-sm-9 offset-sm-3"&gt;
                                    &lt;asp:Button ID="btnSave" runat="server" Text="保存" CssClass="btn btn-primary me-2" /&gt;
                                    &lt;asp:Button ID="btnUpdate" runat="server" Text="更新" CssClass="btn btn-warning me-2" /&gt;
                                    &lt;asp:Button ID="btnDelete" runat="server" Text="削除" CssClass="btn btn-danger me-2" 
                                        OnClientClick="return confirm('本当に削除しますか？');" CausesValidation="False" /&gt;
                                    &lt;asp:Button ID="btnClear" runat="server" Text="クリア" CssClass="btn btn-secondary" 
                                        CausesValidation="False" /&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="col-md-4"&gt;
                    &lt;div class="card"&gt;
                        &lt;div class="card-header"&gt;
                            &lt;h4&gt;操作状況&lt;/h4&gt;
                        &lt;/div&gt;
                        &lt;div class="card-body"&gt;
                            &lt;asp:Label ID="lblStatus" runat="server" CssClass="alert alert-info d-block"&gt;&lt;/asp:Label&gt;
                            
                            &lt;h6 class="mt-3"&gt;選択された情報&lt;/h6&gt;
                            &lt;asp:Label ID="lblSelectedInfo" runat="server"&gt;&lt;/asp:Label&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <p><strong>EmployeeForm.aspx.vb</strong></p>
                        <pre><code>Public Class EmployeeForm
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        If Not IsPostBack Then
            InitializeForm()
        End If
        UpdateStatus("フォーム読み込み完了")
    End Sub

    Private Sub InitializeForm()
        ' 初期値の設定
        txtEmployeeId.Text = GenerateNextEmployeeId()
        rblPosition.SelectedIndex = 0 ' 一般を選択
        lblStatus.Text = "新規従業員の登録準備ができました"
        lblStatus.CssClass = "alert alert-info d-block"
    End Sub

    Private Function GenerateNextEmployeeId() As String
        ' 実際の実装ではデータベースから最大値を取得
        Dim random As New Random()
        Return "EMP" & random.Next(1000, 9999).ToString()
    End Function

    Protected Sub ddlDepartment_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlDepartment.SelectedIndexChanged
        ' 部署選択時の処理
        If ddlDepartment.SelectedValue <> "" Then
            UpdateSelectedInfo()
            UpdateSalaryRange()
            UpdateStatus($"部署が選択されました: {ddlDepartment.SelectedItem.Text}")
        End If
    End Sub

    Private Sub UpdateSalaryRange()
        ' 部署に応じた給与範囲の調整
        Select Case ddlDepartment.SelectedValue
            Case "IT"
                rvSalary.MinimumValue = "200000"
                rvSalary.MaximumValue = "1200000"
                txtSalary.Text = "350000"
            Case "SALES"
                rvSalary.MinimumValue = "180000"
                rvSalary.MaximumValue = "1000000"
                txtSalary.Text = "300000"
            Case "HR", "FINANCE"
                rvSalary.MinimumValue = "200000"
                rvSalary.MaximumValue = "900000"
                txtSalary.Text = "320000"
            Case Else
                rvSalary.MinimumValue = "150000"
                rvSalary.MaximumValue = "800000"
                txtSalary.Text = "250000"
        End Select
        
        rvSalary.ErrorMessage = $"給与は{rvSalary.MinimumValue:N0}円から{rvSalary.MaximumValue:N0}円の間で入力してください"
    End Sub

    Protected Sub btnSave_Click(sender As Object, e As EventArgs) Handles btnSave.Click
        If Page.IsValid Then
            Dim employee = CollectEmployeeData()
            ' 実際の実装ではデータベースに保存
            SaveEmployee(employee)
            UpdateStatus("従業員情報を保存しました", "success")
            ClearForm()
        Else
            UpdateStatus("入力エラーがあります。確認してください", "danger")
        End If
    End Sub

    Protected Sub btnUpdate_Click(sender As Object, e As EventArgs) Handles btnUpdate.Click
        If Page.IsValid Then
            Dim employee = CollectEmployeeData()
            ' 実際の実装ではデータベースを更新
            UpdateEmployee(employee)
            UpdateStatus("従業員情報を更新しました", "warning")
        Else
            UpdateStatus("入力エラーがあります。確認してください", "danger")
        End If
    End Sub

    Protected Sub btnDelete_Click(sender As Object, e As EventArgs) Handles btnDelete.Click
        ' 削除処理（実際の実装ではデータベースから削除）
        DeleteEmployee(txtEmployeeId.Text)
        UpdateStatus("従業員情報を削除しました", "danger")
        ClearForm()
    End Sub

    Protected Sub btnClear_Click(sender As Object, e As EventArgs) Handles btnClear.Click
        ClearForm()
        UpdateStatus("フォームをクリアしました", "info")
    End Sub

    Private Function CollectEmployeeData() As Dictionary(Of String, Object)
        Dim employee As New Dictionary(Of String, Object)()
        
        employee("EmployeeId") = txtEmployeeId.Text
        employee("Name") = txtName.Text
        employee("Department") = ddlDepartment.SelectedValue
        employee("DepartmentName") = ddlDepartment.SelectedItem?.Text
        employee("Position") = rblPosition.SelectedValue
        employee("Salary") = If(IsNumeric(txtSalary.Text), CInt(txtSalary.Text), 0)
        employee("Comments") = txtComments.Text
        
        ' 選択されたスキルを収集
        Dim skills As New List(Of String)()
        For Each item As ListItem In cblSkills.Items
            If item.Selected Then
                skills.Add(item.Value)
            End If
        Next
        employee("Skills") = skills
        
        Return employee
    End Function

    Private Sub SaveEmployee(employee As Dictionary(Of String, Object))
        ' データベース保存処理をシミュレート
        System.Threading.Thread.Sleep(100)
        
        ' ログ出力（実際の実装ではログライブラリを使用）
        System.Diagnostics.Debug.WriteLine($"従業員保存: {employee("EmployeeId")} - {employee("Name")}")
    End Sub

    Private Sub UpdateEmployee(employee As Dictionary(Of String, Object))
        ' データベース更新処理をシミュレート
        System.Threading.Thread.Sleep(100)
        System.Diagnostics.Debug.WriteLine($"従業員更新: {employee("EmployeeId")} - {employee("Name")}")
    End Sub

    Private Sub DeleteEmployee(employeeId As String)
        ' データベース削除処理をシミュレート
        System.Threading.Thread.Sleep(100)
        System.Diagnostics.Debug.WriteLine($"従業員削除: {employeeId}")
    End Sub

    Private Sub ClearForm()
        txtEmployeeId.Text = GenerateNextEmployeeId()
        txtName.Text = ""
        ddlDepartment.ClearSelection()
        rblPosition.ClearSelection()
        txtSalary.Text = ""
        cblSkills.ClearSelection()
        txtComments.Text = ""
        lblSelectedInfo.Text = ""
    End Sub

    Private Sub UpdateSelectedInfo()
        Dim info As New System.Text.StringBuilder()
        
        If ddlDepartment.SelectedValue <> "" Then
            info.AppendLine($"部署: {ddlDepartment.SelectedItem.Text}<br/>")
        End If
        
        If rblPosition.SelectedValue <> "" Then
            info.AppendLine($"役職: {rblPosition.SelectedItem.Text}<br/>")
        End If
        
        Dim selectedSkills As New List(Of String)()
        For Each item As ListItem In cblSkills.Items
            If item.Selected Then
                selectedSkills.Add(item.Text)
            End If
        Next
        
        If selectedSkills.Count > 0 Then
            info.AppendLine($"スキル: {String.Join(", ", selectedSkills)}<br/>")
        End If
        
        lblSelectedInfo.Text = info.ToString()
    End Sub

    Private Sub UpdateStatus(message As String, Optional statusType As String = "info")
        lblStatus.Text = $"{DateTime.Now:HH:mm:ss} - {message}"
        lblStatus.CssClass = $"alert alert-{statusType} d-block"
    End Sub

    ' チェックボックスリストの選択変更イベント
    Protected Sub cblSkills_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cblSkills.SelectedIndexChanged
        UpdateSelectedInfo()
        
        Dim selectedCount As Integer = cblSkills.Items.Cast(Of ListItem)().Count(Function(item) item.Selected)
        UpdateStatus($"スキル選択数: {selectedCount}")
    End Sub

    ' ラジオボタンリストの選択変更イベント
    Protected Sub rblPosition_SelectedIndexChanged(sender As Object, e As EventArgs) Handles rblPosition.SelectedIndexChanged
        UpdateSelectedInfo()
        UpdateStatus($"役職が選択されました: {rblPosition.SelectedItem?.Text}")
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>従業員情報管理フォームが正常に動作し、各サーバーコントロールのイベント処理とバリデーションが適切に機能します。</p>
                    </div>

                    <h3 class="section-title">4.2 検証コントロール（Validation Controls）</h3>
                    <p>ASP.NETの検証コントロールを使用して、クライアントサイドとサーバーサイドの両方で入力検証を実装します。</p>

                    <h4>検証コントロールの種類</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>コントロール</th>
                                <th>用途</th>
                                <th>主要プロパティ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>RequiredFieldValidator</td>
                                <td>必須入力チェック</td>
                                <td>ControlToValidate, ErrorMessage</td>
                            </tr>
                            <tr>
                                <td>RangeValidator</td>
                                <td>範囲チェック</td>
                                <td>MinimumValue, MaximumValue, Type</td>
                            </tr>
                            <tr>
                                <td>RegularExpressionValidator</td>
                                <td>正規表現パターンチェック</td>
                                <td>ValidationExpression</td>
                            </tr>
                            <tr>
                                <td>CompareValidator</td>
                                <td>値の比較チェック</td>
                                <td>ControlToCompare, Operator, ValueToCompare</td>
                            </tr>
                            <tr>
                                <td>CustomValidator</td>
                                <td>カスタム検証ロジック</td>
                                <td>ClientValidationFunction, OnServerValidate</td>
                            </tr>
                            <tr>
                                <td>ValidationSummary</td>
                                <td>エラーメッセージ一覧表示</td>
                                <td>DisplayMode, ShowSummary</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 4-2: 高度な検証システムの実装</h5>
                        <p>複雑な業務ルールを持つユーザー登録フォームで、様々な検証コントロールを実装します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいWebフォーム「AdvancedValidation.aspx」を作成</li>
                            <li>各種検証コントロールを配置</li>
                            <li>カスタム検証ロジックを実装</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>AdvancedValidation.aspx</strong></p>
                        <pre><code>&lt;%@ Page Language="VB" AutoEventWireup="false" CodeBehind="AdvancedValidation.aspx.vb" 
    Inherits="WebApplication1.AdvancedValidation" %&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head runat="server"&gt;
    &lt;title&gt;高度な検証システム&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" /&gt;
    
    &lt;script type="text/javascript"&gt;
        // クライアントサイド検証関数
        function ValidateUserName(sender, args) {
            var value = args.Value.toLowerCase();
            var forbiddenWords = ['admin', 'root', 'system', 'test'];
            
            for (var i = 0; i &lt; forbiddenWords.length; i++) {
                if (value.indexOf(forbiddenWords[i]) !== -1) {
                    args.IsValid = false;
                    return;
                }
            }
            args.IsValid = true;
        }
        
        function ValidatePhoneNumber(sender, args) {
            var phonePattern = /^(\d{2,4}-\d{2,4}-\d{4}|\d{10,11})$/;
            args.IsValid = phonePattern.test(args.Value);
        }
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id="form1" runat="server"&gt;
        &lt;div class="container mt-4"&gt;
            &lt;h2&gt;ユーザー登録フォーム（高度な検証付き）&lt;/h2&gt;
            
            &lt;!-- エラーサマリー --&gt;
            &lt;asp:ValidationSummary ID="ValidationSummary1" runat="server" 
                CssClass="alert alert-danger" DisplayMode="BulletList" 
                HeaderText="以下のエラーを修正してください：" /&gt;
            
            &lt;div class="row"&gt;
                &lt;div class="col-md-8"&gt;
                    &lt;div class="card"&gt;
                        &lt;div class="card-body"&gt;
                            &lt;!-- ユーザー名 --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Label ID="lblUserName" runat="server" Text="ユーザー名:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                                &lt;asp:TextBox ID="txtUserName" runat="server" CssClass="form-control" 
                                    placeholder="半角英数字で入力"&gt;&lt;/asp:TextBox&gt;
                                
                                &lt;asp:RequiredFieldValidator ID="rfvUserName" runat="server" 
                                    ControlToValidate="txtUserName" ErrorMessage="ユーザー名は必須です"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:RequiredFieldValidator&gt;
                                
                                &lt;asp:RegularExpressionValidator ID="revUserName" runat="server" 
                                    ControlToValidate="txtUserName" ErrorMessage="ユーザー名は半角英数字3-20文字で入力してください"
                                    ValidationExpression="^[a-zA-Z0-9]{3,20}$" CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:RegularExpressionValidator&gt;
                                
                                &lt;asp:CustomValidator ID="cvUserName" runat="server" 
                                    ControlToValidate="txtUserName" ErrorMessage="使用できない文字列が含まれています"
                                    ClientValidationFunction="ValidateUserName" OnServerValidate="cvUserName_ServerValidate"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:CustomValidator&gt;
                            &lt;/div&gt;

                            &lt;!-- パスワード --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Label ID="lblPassword" runat="server" Text="パスワード:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                                &lt;asp:TextBox ID="txtPassword" runat="server" CssClass="form-control" 
                                    TextMode="Password" placeholder="8文字以上の英数字"&gt;&lt;/asp:TextBox&gt;
                                
                                &lt;asp:RequiredFieldValidator ID="rfvPassword" runat="server" 
                                    ControlToValidate="txtPassword" ErrorMessage="パスワードは必須です"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:RequiredFieldValidator&gt;
                                
                                &lt;asp:RegularExpressionValidator ID="revPassword" runat="server" 
                                    ControlToValidate="txtPassword" ErrorMessage="パスワードは8文字以上で、英字と数字を含む必要があります"
                                    ValidationExpression="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&amp;]{8,}$"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:RegularExpressionValidator&gt;
                            &lt;/div&gt;

                            &lt;!-- パスワード確認 --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Label ID="lblConfirmPassword" runat="server" Text="パスワード確認:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                                &lt;asp:TextBox ID="txtConfirmPassword" runat="server" CssClass="form-control" 
                                    TextMode="Password" placeholder="パスワードを再入力"&gt;&lt;/asp:TextBox&gt;
                                
                                &lt;asp:RequiredFieldValidator ID="rfvConfirmPassword" runat="server" 
                                    ControlToValidate="txtConfirmPassword" ErrorMessage="パスワード確認は必須です"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:RequiredFieldValidator&gt;
                                
                                &lt;asp:CompareValidator ID="cvPassword" runat="server" 
                                    ControlToValidate="txtConfirmPassword" ControlToCompare="txtPassword"
                                    ErrorMessage="パスワードが一致しません" Operator="Equal"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:CompareValidator&gt;
                            &lt;/div&gt;

                            &lt;!-- メールアドレス --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Label ID="lblEmail" runat="server" Text="メールアドレス:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                                &lt;asp:TextBox ID="txtEmail" runat="server" CssClass="form-control" 
                                    TextMode="Email" placeholder="user@example.com"&gt;&lt;/asp:TextBox&gt;
                                
                                &lt;asp:RequiredFieldValidator ID="rfvEmail" runat="server" 
                                    ControlToValidate="txtEmail" ErrorMessage="メールアドレスは必須です"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:RequiredFieldValidator&gt;
                                
                                &lt;asp:RegularExpressionValidator ID="revEmail" runat="server" 
                                    ControlToValidate="txtEmail" ErrorMessage="有効なメールアドレスを入力してください"
                                    ValidationExpression="\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:RegularExpressionValidator&gt;
                                
                                &lt;asp:CustomValidator ID="cvEmail" runat="server" 
                                    ControlToValidate="txtEmail" ErrorMessage="このメールアドレスは既に登録されています"
                                    OnServerValidate="cvEmail_ServerValidate" CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:CustomValidator&gt;
                            &lt;/div&gt;

                            &lt;!-- 年齢 --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Label ID="lblAge" runat="server" Text="年齢:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                                &lt;asp:TextBox ID="txtAge" runat="server" CssClass="form-control" 
                                    TextMode="Number" placeholder="18"&gt;&lt;/asp:TextBox&gt;
                                
                                &lt;asp:RequiredFieldValidator ID="rfvAge" runat="server" 
                                    ControlToValidate="txtAge" ErrorMessage="年齢は必須です"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:RequiredFieldValidator&gt;
                                
                                &lt;asp:RangeValidator ID="rvAge" runat="server" 
                                    ControlToValidate="txtAge" ErrorMessage="年齢は18歳から100歳の間で入力してください"
                                    MinimumValue="18" MaximumValue="100" Type="Integer"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:RangeValidator&gt;
                            &lt;/div&gt;

                            &lt;!-- 電話番号 --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Label ID="lblPhone" runat="server" Text="電話番号:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                                &lt;asp:TextBox ID="txtPhone" runat="server" CssClass="form-control" 
                                    placeholder="090-1234-5678 または 09012345678"&gt;&lt;/asp:TextBox&gt;
                                
                                &lt;asp:CustomValidator ID="cvPhone" runat="server" 
                                    ControlToValidate="txtPhone" ErrorMessage="有効な電話番号を入力してください"
                                    ClientValidationFunction="ValidatePhoneNumber" OnServerValidate="cvPhone_ServerValidate"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:CustomValidator&gt;
                            &lt;/div&gt;

                            &lt;!-- 利用規約同意 --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:CheckBox ID="chkAgreement" runat="server" Text="利用規約に同意します" CssClass="form-check-input" /&gt;
                                &lt;asp:CustomValidator ID="cvAgreement" runat="server" 
                                    ErrorMessage="利用規約への同意が必要です" OnServerValidate="cvAgreement_ServerValidate"
                                    CssClass="text-danger" Display="Dynamic" Text="*"&gt;&lt;/asp:CustomValidator&gt;
                            &lt;/div&gt;

                            &lt;!-- ボタン --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Button ID="btnRegister" runat="server" Text="登録" CssClass="btn btn-primary me-2" /&gt;
                                &lt;asp:Button ID="btnValidateOnly" runat="server" Text="検証のみ" CssClass="btn btn-info me-2" /&gt;
                                &lt;asp:Button ID="btnClear" runat="server" Text="クリア" CssClass="btn btn-secondary" 
                                    CausesValidation="False" /&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="col-md-4"&gt;
                    &lt;div class="card"&gt;
                        &lt;div class="card-header"&gt;
                            &lt;h5&gt;検証状況&lt;/h5&gt;
                        &lt;/div&gt;
                        &lt;div class="card-body"&gt;
                            &lt;asp:Label ID="lblValidationStatus" runat="server"&gt;&lt;/asp:Label&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <p><strong>AdvancedValidation.aspx.vb</strong></p>
                        <pre><code>Public Class AdvancedValidation
    Inherits System.Web.UI.Page

    ' 既存ユーザー名のシミュレーション（実際はデータベースから取得）
    Private ReadOnly ExistingUserNames As String() = {"admin", "user123", "testuser", "sample"}
    Private ReadOnly ExistingEmails As String() = {"admin@test.com", "user@example.com", "test@sample.org"}

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        If Not IsPostBack Then
            UpdateValidationStatus("フォーム初期化完了")
        End If
    End Sub

    Protected Sub cvUserName_ServerValidate(source As Object, args As ServerValidateEventArgs)
        Dim userName As String = args.Value.ToLower()
        Dim forbiddenWords() As String = {"admin", "root", "system", "test", "guest"}
        
        ' 禁止文字列チェック
        For Each word In forbiddenWords
            If userName.Contains(word) Then
                args.IsValid = False
                Return
            End If
        Next
        
        ' 既存ユーザー名チェック
        If ExistingUserNames.Contains(userName) Then
            args.IsValid = False
            DirectCast(source, CustomValidator).ErrorMessage = "このユーザー名は既に使用されています"
            Return
        End If
        
        args.IsValid = True
    End Sub

    Protected Sub cvEmail_ServerValidate(source As Object, args As ServerValidateEventArgs)
        Dim email As String = args.Value.ToLower()
        
        ' 既存メールアドレスチェック（実際はデータベースクエリ）
        If ExistingEmails.Contains(email) Then
            args.IsValid = False
        Else
            args.IsValid = True
        End If
    End Sub

    Protected Sub cvPhone_ServerValidate(source As Object, args As ServerValidateEventArgs)
        Dim phone As String = args.Value
        
        If String.IsNullOrWhiteSpace(phone) Then
            args.IsValid = True ' 必須でない場合
            Return
        End If
        
        ' 電話番号の形式チェック
        Dim cleanPhone As String = phone.Replace("-", "").Replace("(", "").Replace(")", "").Replace(" ", "")
        
        ' 日本の電話番号形式をチェック
        If cleanPhone.Length >= 10 AndAlso cleanPhone.Length <= 11 AndAlso IsNumeric(cleanPhone) Then
            args.IsValid = True
        Else
            args.IsValid = False
        End If
    End Sub

    Protected Sub cvAgreement_ServerValidate(source As Object, args As ServerValidateEventArgs)
        args.IsValid = chkAgreement.Checked
    End Sub

    Protected Sub btnRegister_Click(sender As Object, e As EventArgs) Handles btnRegister.Click
        If Page.IsValid Then
            ' 登録処理を実行
            Dim userData = CollectUserData()
            RegisterUser(userData)
            UpdateValidationStatus("ユーザー登録が完了しました！", "success")
            ClearForm()
        Else
            UpdateValidationStatus("入力エラーがあります。確認してください", "danger")
            LogValidationErrors()
        End If
    End Sub

    Protected Sub btnValidateOnly_Click(sender As Object, e As EventArgs) Handles btnValidateOnly.Click
        Page.Validate()
        
        If Page.IsValid Then
            UpdateValidationStatus("すべての検証に合格しました", "success")
        Else
            UpdateValidationStatus("検証エラーがあります", "warning")
            LogValidationErrors()
        End If
    End Sub

    Protected Sub btnClear_Click(sender As Object, e As EventArgs) Handles btnClear.Click
        ClearForm()
        UpdateValidationStatus("フォームをクリアしました", "info")
    End Sub

    Private Function CollectUserData() As Dictionary(Of String, Object)
        Dim userData As New Dictionary(Of String, Object)()
        
        userData("UserName") = txtUserName.Text
        userData("Email") = txtEmail.Text
        userData("Age") = If(IsNumeric(txtAge.Text), CInt(txtAge.Text), 0)
        userData("Phone") = txtPhone.Text
        userData("RegistrationDate") = DateTime.Now
        
        Return userData
    End Function

    Private Sub RegisterUser(userData As Dictionary(Of String, Object))
        ' ユーザー登録処理をシミュレート
        System.Threading.Thread.Sleep(200)
        
        ' ログ出力
        System.Diagnostics.Debug.WriteLine($"新規ユーザー登録: {userData("UserName")} ({userData("Email")})")
    End Sub

    Private Sub ClearForm()
        txtUserName.Text = ""
        txtPassword.Text = ""
        txtConfirmPassword.Text = ""
        txtEmail.Text = ""
        txtAge.Text = ""
        txtPhone.Text = ""
        chkAgreement.Checked = False
    End Sub

    Private Sub UpdateValidationStatus(message As String, Optional statusType As String = "info")
        Dim timestamp As String = DateTime.Now.ToString("HH:mm:ss")
        lblValidationStatus.Text = $"<div class='alert alert-{statusType}'>" &
                                  $"<small>{timestamp}</small><br/>{message}</div>"
    End Sub

    Private Sub LogValidationErrors()
        Dim errorInfo As New System.Text.StringBuilder()
        errorInfo.AppendLine("<h6>検証エラー詳細:</h6><ul>")
        
        ' 各バリデーターの状態をチェック
        For Each validator As IValidator In Page.Validators
            If Not validator.IsValid Then
                errorInfo.AppendLine($"<li>{validator.ErrorMessage}</li>")
            End If
        Next
        
        errorInfo.AppendLine("</ul>")
        
        ' ログ出力と画面表示の更新
        System.Diagnostics.Debug.WriteLine("検証エラー: " & errorInfo.ToString())
        lblValidationStatus.Text += errorInfo.ToString()
    End Sub

    ' リアルタイム検証のためのイベント（TextChangedイベント）
    Protected Sub txtUserName_TextChanged(sender As Object, e As EventArgs) Handles txtUserName.TextChanged
        If txtUserName.Text.Length >= 3 Then
            cvUserName.Validate()
            If cvUserName.IsValid Then
                UpdateValidationStatus("ユーザー名は利用可能です", "success")
            End If
        End If
    End Sub

    Protected Sub txtEmail_TextChanged(sender As Object, e As EventArgs) Handles txtEmail.TextChanged
        If txtEmail.Text.Contains("@") Then
            revEmail.Validate()
            cvEmail.Validate()
            
            If revEmail.IsValid AndAlso cvEmail.IsValid Then
                UpdateValidationStatus("メールアドレスは利用可能です", "success")
            End If
        End If
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>高度な検証システムが正常に動作し、クライアントサイドとサーバーサイドの両方で入力検証が実行されます。</p>
                    </div>

                    <h3 class="section-title">4.3 複合コントロールとデータバインディング</h3>
                    <p>GridView、Repeater、DataListなどの複合コントロールを使用してデータを表示・操作する方法を学習します。</p>

                    <div class="warning">
                        <h6>複合コントロール使用時の注意点</h6>
                        <ul>
                            <li>ViewStateサイズの増加に注意</li>
                            <li>大量データ表示時のパフォーマンス考慮</li>
                            <li>適切なページングの実装</li>
                            <li>セキュリティ面でのSQLインジェクション対策</li>
                        </ul>
                    </div>

                    <!-- 実習3 -->
                    <div class="exercise-container">
                        <h5>実習 4-3: GridViewとRepeaterコントロールの活用</h5>
                        <p>商品管理システムでGridViewとRepeaterコントロールを使用したデータ表示・操作機能を実装します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいWebフォーム「DataControls.aspx」を作成</li>
                            <li>GridViewとRepeaterコントロールを配置</li>
                            <li>データバインディングとイベント処理を実装</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>DataControls.aspx.vb（抜粋）</strong></p>
                        <pre><code>Public Class DataControls
    Inherits System.Web.UI.Page

    ' サンプルデータ（実際の実装ではデータベースから取得）
    Private Function GetProductData() As DataTable
        Dim dt As New DataTable()
        dt.Columns.Add("ProductId", GetType(Integer))
        dt.Columns.Add("ProductName", GetType(String))
        dt.Columns.Add("Category", GetType(String))
        dt.Columns.Add("Price", GetType(Decimal))
        dt.Columns.Add("Stock", GetType(Integer))
        dt.Columns.Add("IsActive", GetType(Boolean))
        dt.Columns.Add("LastUpdated", GetType(DateTime))

        ' サンプルデータの追加
        dt.Rows.Add(1, "ノートパソコン", "電子機器", 89800, 15, True, DateTime.Now.AddDays(-5))
        dt.Rows.Add(2, "マウス", "周辺機器", 2980, 50, True, DateTime.Now.AddDays(-2))
        dt.Rows.Add(3, "キーボード", "周辺機器", 5800, 30, True, DateTime.Now.AddDays(-1))
        dt.Rows.Add(4, "モニター", "電子機器", 24800, 8, False, DateTime.Now.AddDays(-7))
        dt.Rows.Add(5, "プリンター", "周辺機器", 12800, 12, True, DateTime.Now.AddDays(-3))

        Return dt
    End Function

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        If Not IsPostBack Then
            BindGridView()
            BindRepeater()
        End If
    End Sub

    Private Sub BindGridView()
        GridView1.DataSource = GetProductData()
        GridView1.DataBind()
    End Sub

    Private Sub BindRepeater()
        Repeater1.DataSource = GetProductData()
        Repeater1.DataBind()
    End Sub

    ' GridViewのイベント処理
    Protected Sub GridView1_RowCommand(sender As Object, e As GridViewCommandEventArgs) Handles GridView1.RowCommand
        Dim productId As Integer = Convert.ToInt32(e.CommandArgument)
        
        Select Case e.CommandName
            Case "EditProduct"
                ' 編集処理
                lblMessage.Text = $"商品ID {productId} の編集モードに切り替えました"
                lblMessage.CssClass = "alert alert-info"
                
            Case "DeleteProduct"
                ' 削除処理
                DeleteProduct(productId)
                lblMessage.Text = $"商品ID {productId} を削除しました"
                lblMessage.CssClass = "alert alert-warning"
                BindGridView() ' データを再バインド
                
            Case "ToggleActive"
                ' 有効/無効切り替え
                ToggleProductStatus(productId)
                lblMessage.Text = $"商品ID {productId} のステータスを変更しました"
                lblMessage.CssClass = "alert alert-success"
                BindGridView()
        End Select
    End Sub

    Protected Sub GridView1_RowDataBound(sender As Object, e As GridViewRowEventArgs) Handles GridView1.RowDataBound
        If e.Row.RowType = DataControlRowType.DataRow Then
            ' データ行の場合の処理
            Dim isActive As Boolean = Convert.ToBoolean(DataBinder.Eval(e.Row.DataItem, "IsActive"))
            
            ' 非アクティブな商品の行をグレーアウト
            If Not isActive Then
                e.Row.CssClass = "table-secondary"
                e.Row.Cells(1).Style("text-decoration") = "line-through"
            End If
            
            ' 在庫数に応じた色分け
            Dim stock As Integer = Convert.ToInt32(DataBinder.Eval(e.Row.DataItem, "Stock"))
            If stock <= 10 Then
                e.Row.Cells(4).CssClass = "text-danger fw-bold" ' 在庫少
            ElseIf stock <= 20 Then
                e.Row.Cells(4).CssClass = "text-warning fw-bold" ' 在庫注意
            End If
        End If
    End Sub

    ' Repeaterのイベント処理
    Protected Sub Repeater1_ItemCommand(source As Object, e As RepeaterCommandEventArgs) Handles Repeater1.ItemCommand
        Dim productId As Integer = Convert.ToInt32(e.CommandArgument)
        
        Select Case e.CommandName
            Case "QuickEdit"
                Response.Redirect($"ProductEdit.aspx?id={productId}")
                
            Case "AddToCart"
                ' カート追加処理をシミュレート
                Session("CartCount") = If(Session("CartCount"), 0) + 1
                lblMessage.Text = $"商品ID {productId} をカートに追加しました (合計: {Session("CartCount")}個)"
                lblMessage.CssClass = "alert alert-success"
        End Select
    End Sub

    Protected Sub Repeater1_ItemDataBound(sender As Object, e As RepeaterItemEventArgs) Handles Repeater1.ItemDataBound
        If e.Item.ItemType = ListItemType.Item OrElse e.Item.ItemType = ListItemType.AlternatingItem Then
            ' 商品カードのカスタマイズ
            Dim price As Decimal = Convert.ToDecimal(DataBinder.Eval(e.Item.DataItem, "Price"))
            Dim priceLabel As Label = CType(e.Item.FindControl("lblPrice"), Label)
            
            If price >= 50000 Then
                priceLabel.CssClass = "text-danger fw-bold" ' 高額商品
            ElseIf price >= 10000 Then
                priceLabel.CssClass = "text-warning fw-bold" ' 中額商品
            Else
                priceLabel.CssClass = "text-success" ' 低額商品
            End If
        End If
    End Sub

    Private Sub DeleteProduct(productId As Integer)
        ' 実際の実装ではデータベースから削除
        System.Diagnostics.Debug.WriteLine($"商品削除: ID {productId}")
    End Sub

    Private Sub ToggleProductStatus(productId As Integer)
        ' 実際の実装ではデータベースの状態を更新
        System.Diagnostics.Debug.WriteLine($"商品ステータス切り替え: ID {productId}")
    End Sub

    ' 検索・フィルタリング機能
    Protected Sub btnSearch_Click(sender As Object, e As EventArgs) Handles btnSearch.Click
        Dim searchTerm As String = txtSearch.Text.Trim().ToLower()
        Dim categoryFilter As String = ddlCategoryFilter.SelectedValue
        
        Dim dt As DataTable = GetProductData()
        Dim filteredView As DataView = dt.DefaultView
        
        Dim filterExpression As New System.Text.StringBuilder()
        
        If Not String.IsNullOrEmpty(searchTerm) Then
            filterExpression.Append($"ProductName LIKE '%{searchTerm}%'")
        End If
        
        If Not String.IsNullOrEmpty(categoryFilter) Then
            If filterExpression.Length > 0 Then
                filterExpression.Append(" AND ")
            End If
            filterExpression.Append($"Category = '{categoryFilter}'")
        End If
        
        filteredView.RowFilter = filterExpression.ToString()
        
        GridView1.DataSource = filteredView
        GridView1.DataBind()
        
        Repeater1.DataSource = filteredView
        Repeater1.DataBind()
        
        lblMessage.Text = $"検索結果: {filteredView.Count}件"
        lblMessage.CssClass = "alert alert-info"
    End Sub

    Protected Sub btnReset_Click(sender As Object, e As EventArgs) Handles btnReset.Click
        txtSearch.Text = ""
        ddlCategoryFilter.ClearSelection()
        BindGridView()
        BindRepeater()
        lblMessage.Text = "検索条件をリセットしました"
        lblMessage.CssClass = "alert alert-secondary"
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>GridViewとRepeaterコントロールが正常に動作し、データの表示・検索・操作機能が適切に実装されます。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>サーバーコントロールとHTMLコントロールの主な違いを3つ挙げてください。</li>
                            <li>AutoPostBack="True"の動作と使用場面を説明してください。</li>
                            <li>ValidationSummaryコントロールの役割と設定方法を説明してください。</li>
                            <li>GridViewのRowDataBoundイベントの用途と実装例を説明してください。</li>
                            <li>CustomValidatorでクライアントサイド検証とサーバーサイド検証を両方実装する理由は何ですか？</li>
                            <li>CausesValidation="False"を設定する場面とその理由を説明してください。</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>1)サーバーサイドでプログラム制御可能、2)ViewStateによる状態保持、3)自動HTML生成とクロスブラウザ対応</li>
                                <li>コントロール値変更時に自動的にフォーム送信。DropDownListの選択変更で他コントロールを更新する場合など</li>
                                <li>ページ内の全検証エラーを一箇所に表示。DisplayMode、HeaderTextプロパティで表示形式を制御</li>
                                <li>データ行レンダリング時のカスタマイズ。条件に応じた色分け、フォーマット変更、コントロール動的設定など</li>
                                <li>クライアント：即座のフィードバック、サーバー：セキュリティとJavaScript無効環境への対応</li>
                                <li>クリアボタン、キャンセルボタンなど、検証をスキップして処理を実行したい場合</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-3.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-5.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>