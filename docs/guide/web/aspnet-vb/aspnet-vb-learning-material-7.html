<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET(VB.NET)学習教材 第7章 - 認証とセキュリティ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #1976d2;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #1976d2;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #42a5f5;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #1976d2;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #1976d2 !important;
            color: white !important;
        }

        /* プリフォーマット */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ASP.NET(VB.NET)学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../README.md">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.md">ASP.NET VBガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: ASP.NET基礎とセットアップ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: VB.NET言語基礎復習</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">第3章: Web Forms基本</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">第4章: サーバーコントロールとイベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">第5章: データベース連携（ADO.NET）</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">第6章: セッション管理と状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter7">第7章: 認証とセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: エラーハンドリングとデバッグ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: 認証とセキュリティ</h1>
                </div>

                <div id="chapter7">
                    <h2 class="chapter-title">ASP.NET認証システムとセキュリティ対策</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>ASP.NET認証メカニズムの種類と特徴</li>
                            <li>フォーム認証の実装と設定</li>
                            <li>ロールベースセキュリティとアクセス制御</li>
                            <li>パスワードハッシュ化とソルト処理</li>
                            <li>入力検証とSQLインジェクション対策</li>
                            <li>XSS（クロスサイトスクリプティング）対策</li>
                            <li>CSRF（クロスサイトリクエストフォージェリ）対策</li>
                            <li>セキュアな認証システムの設計と実装</li>
                        </ul>
                    </div>

                    <h3 class="section-title">7.1 ASP.NET認証メカニズム</h3>
                    <p>ASP.NETは複数の認証方式を提供しており、アプリケーションの要件に応じて適切な方式を選択できます。</p>
                    
                    <h4>認証方式の比較</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>認証方式</th>
                                <th>説明</th>
                                <th>適用場面</th>
                                <th>メリット</th>
                                <th>デメリット</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Forms認証</td>
                                <td>カスタムログインフォーム</td>
                                <td>Webアプリケーション</td>
                                <td>柔軟性、カスタマイズ性</td>
                                <td>実装コスト</td>
                            </tr>
                            <tr>
                                <td>Windows認証</td>
                                <td>Windows資格情報</td>
                                <td>イントラネット</td>
                                <td>シームレス認証</td>
                                <td>Windows環境限定</td>
                            </tr>
                            <tr>
                                <td>ASP.NET Identity</td>
                                <td>モダン認証フレームワーク</td>
                                <td>新規プロジェクト</td>
                                <td>多機能、拡張性</td>
                                <td>学習コスト</td>
                            </tr>
                            <tr>
                                <td>OAuth/OpenID</td>
                                <td>第三者認証</td>
                                <td>外部連携</td>
                                <td>ユーザビリティ</td>
                                <td>外部依存</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 7-1: Forms認証システムの基本実装</h5>
                        <p>カスタムログインフォームとセキュアなパスワード管理を含む認証システムを実装します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>Web.configでForms認証を設定</li>
                            <li>ログインページとユーザー管理の実装</li>
                            <li>セキュアなパスワードハッシュ化の実装</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>Web.config（認証設定）</strong></p>
                        <pre><code>&lt;configuration&gt;
  &lt;system.web&gt;
    &lt;!-- Forms認証の設定 --&gt;
    &lt;authentication mode="Forms"&gt;
      &lt;forms name="AuthCookie" 
             loginUrl="~/Account/Login.aspx" 
             defaultUrl="~/Default.aspx"
             timeout="60"
             slidingExpiration="true"
             cookieless="false"
             requireSSL="true"
             protection="All"&gt;
      &lt;/forms&gt;
    &lt;/authentication&gt;
    
    &lt;!-- 匿名アクセスの拒否 --&gt;
    &lt;authorization&gt;
      &lt;deny users="?" /&gt;
      &lt;allow users="*" /&gt;
    &lt;/authorization&gt;
    
    &lt;!-- セキュリティ設定 --&gt;
    &lt;httpCookies httpOnlyCookies="true" requireSSL="true" lockItem="true" /&gt;
    &lt;sessionState cookieTimeout="60" regenerateExpiredSessionId="true" cookieless="false" /&gt;
  &lt;/system.web&gt;
  
  &lt;!-- ログインページは匿名アクセス許可 --&gt;
  &lt;location path="Account"&gt;
    &lt;system.web&gt;
      &lt;authorization&gt;
        &lt;allow users="*" /&gt;
      &lt;/authorization&gt;
    &lt;/system.web&gt;
  &lt;/location&gt;
  
  &lt;!-- 管理者ページのアクセス制御 --&gt;
  &lt;location path="Admin"&gt;
    &lt;system.web&gt;
      &lt;authorization&gt;
        &lt;allow roles="Administrator" /&gt;
        &lt;deny users="*" /&gt;
      &lt;/authorization&gt;
    &lt;/system.web&gt;
  &lt;/location&gt;
&lt;/configuration&gt;</code></pre>
                        <p><strong>Login.aspx.vb</strong></p>
                        <pre><code>Imports System.Security.Cryptography
Imports System.Text
Imports System.Data.SqlClient
Imports System.Configuration
Imports System.Web.Security

Public Class Login
    Inherits System.Web.UI.Page

    Private ReadOnly connectionString As String = ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        If Not IsPostBack Then
            ' 既にログインしている場合はリダイレクト
            If User.Identity.IsAuthenticated Then
                Response.Redirect("~/Default.aspx")
            End If
            
            CreateUsersTableIfNotExists()
            CreateDefaultAdminUser()
        End If
    End Sub

    Protected Sub btnLogin_Click(sender As Object, e As EventArgs) Handles btnLogin.Click
        Dim userName As String = txtUserName.Text.Trim()
        Dim password As String = txtPassword.Text
        
        If ValidateLogin(userName, password) Then
            Try
                Dim userInfo = GetUserInfo(userName)
                If userInfo IsNot Nothing Then
                    ' ログイン成功の処理
                    ProcessSuccessfulLogin(userInfo)
                Else
                    ShowMessage("ユーザー情報の取得に失敗しました", "danger")
                End If
            Catch ex As Exception
                LogSecurityEvent($"ログイン処理エラー: {ex.Message}", userName)
                ShowMessage("ログイン処理中にエラーが発生しました", "danger")
            End Try
        Else
            ' ログイン失敗の処理
            ProcessFailedLogin(userName)
        End If
    End Sub

    Private Function ValidateLogin(userName As String, password As String) As Boolean
        If String.IsNullOrWhiteSpace(userName) OrElse String.IsNullOrWhiteSpace(password) Then
            ShowMessage("ユーザー名とパスワードを入力してください", "warning")
            Return False
        End If
        
        Try
            Using connection As New SqlConnection(connectionString)
                connection.Open()
                
                Dim sql As String = "
                    SELECT UserId, UserName, PasswordHash, Salt, IsActive, FailedLoginAttempts, 
                           LastFailedLogin, IsLocked, LockoutEnd
                    FROM Users 
                    WHERE UserName = @UserName"
                
                Using command As New SqlCommand(sql, connection)
                    command.Parameters.AddWithValue("@UserName", userName)
                    
                    Using reader As SqlDataReader = command.ExecuteReader()
                        If reader.Read() Then
                            ' アカウントロック確認
                            If reader.GetBoolean("IsLocked") Then
                                Dim lockoutEnd As DateTime = reader.GetDateTime("LockoutEnd")
                                If DateTime.Now < lockoutEnd Then
                                    ShowMessage($"アカウントがロックされています。解除時刻: {lockoutEnd:yyyy/MM/dd HH:mm}", "danger")
                                    Return False
                                Else
                                    ' ロック期間終了、ロック解除
                                    UnlockAccount(userName)
                                End If
                            End If
                            
                            If Not reader.GetBoolean("IsActive") Then
                                ShowMessage("このアカウントは無効化されています", "danger")
                                Return False
                            End If
                            
                            ' パスワード検証
                            Dim storedHash As String = reader.GetString("PasswordHash")
                            Dim salt As String = reader.GetString("Salt")
                            
                            If VerifyPassword(password, storedHash, salt) Then
                                ' ログイン成功、失敗回数をリセット
                                ResetFailedLoginAttempts(userName)
                                Return True
                            Else
                                ' パスワード不一致、失敗回数を記録
                                RecordFailedLogin(userName)
                                ShowMessage("ユーザー名またはパスワードが正しくありません", "danger")
                                Return False
                            End If
                        Else
                            ShowMessage("ユーザー名またはパスワードが正しくありません", "danger")
                            LogSecurityEvent($"存在しないユーザーでのログイン試行", userName)
                            Return False
                        End If
                    End Using
                End Using
            End Using
            
        Catch ex As Exception
            LogSecurityEvent($"ログイン検証エラー: {ex.Message}", userName)
            ShowMessage("認証処理中にエラーが発生しました", "danger")
            Return False
        End Try
    End Function

    Private Function GetUserInfo(userName As String) As Dictionary(Of String, Object)
        Try
            Using connection As New SqlConnection(connectionString)
                connection.Open()
                
                Dim sql As String = "
                    SELECT u.UserId, u.UserName, u.Email, u.FullName, u.LastLoginDate,
                           STRING_AGG(r.RoleName, ',') as Roles
                    FROM Users u
                    LEFT JOIN UserRoles ur ON u.UserId = ur.UserId
                    LEFT JOIN Roles r ON ur.RoleId = r.RoleId
                    WHERE u.UserName = @UserName AND u.IsActive = 1
                    GROUP BY u.UserId, u.UserName, u.Email, u.FullName, u.LastLoginDate"
                
                Using command As New SqlCommand(sql, connection)
                    command.Parameters.AddWithValue("@UserName", userName)
                    
                    Using reader As SqlDataReader = command.ExecuteReader()
                        If reader.Read() Then
                            Return New Dictionary(Of String, Object) From {
                                {"UserId", reader("UserId")},
                                {"UserName", reader("UserName").ToString()},
                                {"Email", If(reader.IsDBNull("Email"), "", reader("Email").ToString())},
                                {"FullName", If(reader.IsDBNull("FullName"), "", reader("FullName").ToString())},
                                {"Roles", If(reader.IsDBNull("Roles"), "", reader("Roles").ToString())},
                                {"LastLoginDate", If(reader.IsDBNull("LastLoginDate"), Nothing, reader("LastLoginDate"))}
                            }
                        End If
                    End Using
                End Using
            End Using
        Catch ex As Exception
            LogSecurityEvent($"ユーザー情報取得エラー: {ex.Message}", userName)
        End Try
        
        Return Nothing
    End Function

    Private Sub ProcessSuccessfulLogin(userInfo As Dictionary(Of String, Object))
        Dim userName As String = userInfo("UserName").ToString()
        Dim roles As String = userInfo("Roles").ToString()
        
        ' 最終ログイン日時を更新
        UpdateLastLoginDate(userName)
        
        ' 認証チケットの作成
        Dim authTicket As New FormsAuthenticationTicket(
            1,                                          ' version
            userName,                                   ' name
            DateTime.Now,                              ' issue time
            DateTime.Now.AddMinutes(60),               ' expiration
            chkRememberMe.Checked,                     ' persistent
            roles,                                     ' user data (roles)
            FormsAuthentication.FormsCookiePath        ' cookie path
        )
        
        ' チケットを暗号化
        Dim encryptedTicket As String = FormsAuthentication.Encrypt(authTicket)
        
        ' 認証Cookieを作成
        Dim authCookie As New HttpCookie(FormsAuthentication.FormsCookieName, encryptedTicket)
        authCookie.HttpOnly = True
        authCookie.Secure = Request.IsSecureConnection
        
        If chkRememberMe.Checked Then
            authCookie.Expires = authTicket.Expiration
        End If
        
        Response.Cookies.Add(authCookie)
        
        ' セッションに追加情報を保存
        Session("UserId") = userInfo("UserId")
        Session("FullName") = userInfo("FullName")
        Session("Email") = userInfo("Email")
        Session("LoginTime") = DateTime.Now
        
        ' ログ記録
        LogSecurityEvent($"ログイン成功", userName)
        
        ' リダイレクト
        Dim returnUrl As String = Request.QueryString("ReturnUrl")
        If Not String.IsNullOrEmpty(returnUrl) AndAlso FormsAuthentication.IsValidReturnUrl(returnUrl) Then
            Response.Redirect(returnUrl)
        Else
            Response.Redirect("~/Default.aspx")
        End If
    End Sub

    Private Sub ProcessFailedLogin(userName As String)
        LogSecurityEvent($"ログイン失敗", userName)
        
        ' セキュリティのため、少し待機
        System.Threading.Thread.Sleep(1000)
    End Sub

    Private Sub RecordFailedLogin(userName As String)
        Try
            Using connection As New SqlConnection(connectionString)
                connection.Open()
                
                Dim sql As String = "
                    UPDATE Users 
                    SET FailedLoginAttempts = FailedLoginAttempts + 1,
                        LastFailedLogin = @Now
                    WHERE UserName = @UserName
                    
                    -- 5回失敗でアカウントロック
                    UPDATE Users 
                    SET IsLocked = 1, LockoutEnd = DATEADD(MINUTE, 30, @Now)
                    WHERE UserName = @UserName AND FailedLoginAttempts >= 5"
                
                Using command As New SqlCommand(sql, connection)
                    command.Parameters.AddWithValue("@UserName", userName)
                    command.Parameters.AddWithValue("@Now", DateTime.Now)
                    command.ExecuteNonQuery()
                End Using
            End Using
        Catch ex As Exception
            LogSecurityEvent($"失敗ログイン記録エラー: {ex.Message}", userName)
        End Try
    End Sub

    Private Sub ResetFailedLoginAttempts(userName As String)
        Try
            Using connection As New SqlConnection(connectionString)
                connection.Open()
                
                Dim sql As String = "
                    UPDATE Users 
                    SET FailedLoginAttempts = 0, LastFailedLogin = NULL, IsLocked = 0, LockoutEnd = NULL
                    WHERE UserName = @UserName"
                
                Using command As New SqlCommand(sql, connection)
                    command.Parameters.AddWithValue("@UserName", userName)
                    command.ExecuteNonQuery()
                End Using
            End Using
        Catch ex As Exception
            LogSecurityEvent($"失敗回数リセットエラー: {ex.Message}", userName)
        End Try
    End Sub

    Private Sub UnlockAccount(userName As String)
        Try
            Using connection As New SqlConnection(connectionString)
                connection.Open()
                
                Dim sql As String = "
                    UPDATE Users 
                    SET IsLocked = 0, LockoutEnd = NULL, FailedLoginAttempts = 0
                    WHERE UserName = @UserName"
                
                Using command As New SqlCommand(sql, connection)
                    command.Parameters.AddWithValue("@UserName", userName)
                    command.ExecuteNonQuery()
                End Using
            End Using
        Catch ex As Exception
            LogSecurityEvent($"アカウントロック解除エラー: {ex.Message}", userName)
        End Try
    End Sub

    Private Sub UpdateLastLoginDate(userName As String)
        Try
            Using connection As New SqlConnection(connectionString)
                connection.Open()
                
                Dim sql As String = "UPDATE Users SET LastLoginDate = @Now WHERE UserName = @UserName"
                
                Using command As New SqlCommand(sql, connection)
                    command.Parameters.AddWithValue("@UserName", userName)
                    command.Parameters.AddWithValue("@Now", DateTime.Now)
                    command.ExecuteNonQuery()
                End Using
            End Using
        Catch ex As Exception
            LogSecurityEvent($"最終ログイン日時更新エラー: {ex.Message}", userName)
        End Try
    End Sub

    Private Function VerifyPassword(password As String, storedHash As String, salt As String) As Boolean
        Try
            Dim computedHash As String = HashPassword(password, salt)
            Return computedHash.Equals(storedHash, StringComparison.Ordinal)
        Catch ex As Exception
            LogSecurityEvent($"パスワード検証エラー: {ex.Message}", "")
            Return False
        End Try
    End Function

    Private Function HashPassword(password As String, salt As String) As String
        Using sha256 As SHA256 = SHA256.Create()
            Dim saltedPassword As String = password + salt
            Dim hashBytes As Byte() = sha256.ComputeHash(Encoding.UTF8.GetBytes(saltedPassword))
            Return Convert.ToBase64String(hashBytes)
        End Using
    End Function

    Private Function GenerateSalt() As String
        Using rng As New RNGCryptoServiceProvider()
            Dim saltBytes(31) As Byte
            rng.GetBytes(saltBytes)
            Return Convert.ToBase64String(saltBytes)
        End Using
    End Function

    Private Sub CreateUsersTableIfNotExists()
        Try
            Using connection As New SqlConnection(connectionString)
                connection.Open()
                
                Dim sql As String = "
                    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='Users' AND xtype='U')
                    CREATE TABLE Users (
                        UserId int IDENTITY(1,1) PRIMARY KEY,
                        UserName nvarchar(50) UNIQUE NOT NULL,
                        PasswordHash nvarchar(255) NOT NULL,
                        Salt nvarchar(255) NOT NULL,
                        Email nvarchar(100),
                        FullName nvarchar(100),
                        IsActive bit DEFAULT 1,
                        CreatedDate datetime DEFAULT GETDATE(),
                        LastLoginDate datetime,
                        FailedLoginAttempts int DEFAULT 0,
                        LastFailedLogin datetime,
                        IsLocked bit DEFAULT 0,
                        LockoutEnd datetime
                    )
                    
                    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='Roles' AND xtype='U')
                    CREATE TABLE Roles (
                        RoleId int IDENTITY(1,1) PRIMARY KEY,
                        RoleName nvarchar(50) UNIQUE NOT NULL,
                        Description nvarchar(200)
                    )
                    
                    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='UserRoles' AND xtype='U')
                    CREATE TABLE UserRoles (
                        UserId int FOREIGN KEY REFERENCES Users(UserId),
                        RoleId int FOREIGN KEY REFERENCES Roles(RoleId),
                        PRIMARY KEY (UserId, RoleId)
                    )"
                
                Using command As New SqlCommand(sql, connection)
                    command.ExecuteNonQuery()
                End Using
            End Using
        Catch ex As Exception
            System.Diagnostics.Debug.WriteLine($"テーブル作成エラー: {ex.Message}")
        End Try
    End Sub

    Private Sub CreateDefaultAdminUser()
        Try
            Using connection As New SqlConnection(connectionString)
                connection.Open()
                
                ' デフォルト管理者ユーザーの存在確認
                Dim checkSql As String = "SELECT COUNT(*) FROM Users WHERE UserName = 'admin'"
                Using checkCommand As New SqlCommand(checkSql, connection)
                    Dim userCount As Integer = Convert.ToInt32(checkCommand.ExecuteScalar())
                    
                    If userCount = 0 Then
                        ' デフォルトロールの作成
                        Dim roleSql As String = "
                            IF NOT EXISTS (SELECT * FROM Roles WHERE RoleName = 'Administrator')
                            INSERT INTO Roles (RoleName, Description) VALUES ('Administrator', '管理者')
                            
                            IF NOT EXISTS (SELECT * FROM Roles WHERE RoleName = 'User')
                            INSERT INTO Roles (RoleName, Description) VALUES ('User', '一般ユーザー')"
                        
                        Using roleCommand As New SqlCommand(roleSql, connection)
                            roleCommand.ExecuteNonQuery()
                        End Using
                        
                        ' デフォルト管理者ユーザーの作成
                        Dim salt As String = GenerateSalt()
                        Dim passwordHash As String = HashPassword("admin123", salt)
                        
                        Dim userSql As String = "
                            INSERT INTO Users (UserName, PasswordHash, Salt, Email, FullName) 
                            VALUES ('admin', @PasswordHash, @Salt, 'admin@example.com', '管理者')
                            
                            DECLARE @UserId int = SCOPE_IDENTITY()
                            DECLARE @RoleId int = (SELECT RoleId FROM Roles WHERE RoleName = 'Administrator')
                            INSERT INTO UserRoles (UserId, RoleId) VALUES (@UserId, @RoleId)"
                        
                        Using userCommand As New SqlCommand(userSql, connection)
                            userCommand.Parameters.AddWithValue("@PasswordHash", passwordHash)
                            userCommand.Parameters.AddWithValue("@Salt", salt)
                            userCommand.ExecuteNonQuery()
                        End Using
                    End If
                End Using
            End Using
        Catch ex As Exception
            System.Diagnostics.Debug.WriteLine($"デフォルトユーザー作成エラー: {ex.Message}")
        End Try
    End Sub

    Private Sub LogSecurityEvent(eventDescription As String, userName As String)
        Try
            System.Diagnostics.Debug.WriteLine($"Security Event: {DateTime.Now:yyyy-MM-dd HH:mm:ss} - {eventDescription} - User: {userName} - IP: {Request.UserHostAddress}")
            
            ' 実際の実装では、セキュリティログファイルやデータベースに記録
        Catch ex As Exception
            System.Diagnostics.Debug.WriteLine($"ログ記録エラー: {ex.Message}")
        End Try
    End Sub

    Private Sub ShowMessage(message As String, type As String)
        lblMessage.Text = message
        lblMessage.CssClass = $"alert alert-{type}"
        lblMessage.Visible = True
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>セキュアなForms認証システムが実装され、パスワードハッシュ化、アカウントロック、ログイン試行制限が適切に動作します。</p>
                    </div>

                    <h3 class="section-title">7.2 入力検証とセキュリティ対策</h3>
                    <p>Webアプリケーションの主要な脅威に対する具体的な対策を実装します。</p>

                    <div class="warning">
                        <h6>主要なWebアプリケーション脅威</h6>
                        <ul>
                            <li><strong>SQLインジェクション</strong>: パラメータ化クエリの使用</li>
                            <li><strong>XSS（クロスサイトスクリプティング）</strong>: 入力値のエスケープ処理</li>
                            <li><strong>CSRF（クロスサイトリクエストフォージェリ）</strong>: トークン検証</li>
                            <li><strong>セッションハイジャック</strong>: HTTPS使用、セキュアなCookie設定</li>
                        </ul>
                    </div>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 7-2: 包括的なセキュリティ対策の実装</h5>
                        <p>XSS、CSRF、SQLインジェクション対策を含む総合的なセキュリティシステムを構築します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいWebフォーム「SecurityDemo.aspx」を作成</li>
                            <li>入力検証とサニタイゼーションの実装</li>
                            <li>CSRF対策トークンシステムの実装</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>SecurityDemo.aspx.vb（抜粋）</strong></p>
                        <pre><code>Imports System.Security.Cryptography
Imports System.Text.RegularExpressions
Imports System.Web.Security

Public Class SecurityDemo
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        If Not IsPostBack Then
            GenerateCSRFToken()
        End If
        
        ' セキュリティヘッダーの設定
        SetSecurityHeaders()
    End Sub

    Private Sub SetSecurityHeaders()
        ' XSS保護
        Response.Headers.Add("X-XSS-Protection", "1; mode=block")
        Response.Headers.Add("X-Content-Type-Options", "nosniff")
        Response.Headers.Add("X-Frame-Options", "SAMEORIGIN")
        
        ' HTTPS強制（プロダクション環境）
        If Request.IsSecureConnection Then
            Response.Headers.Add("Strict-Transport-Security", "max-age=31536000; includeSubDomains")
        End If
        
        ' Content Security Policy
        Response.Headers.Add("Content-Security-Policy", 
            "default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net fonts.googleapis.com; font-src fonts.gstatic.com")
    End Sub

    Private Sub GenerateCSRFToken()
        ' CSRF対策トークンの生成
        Using rng As New RNGCryptoServiceProvider()
            Dim tokenBytes(31) As Byte
            rng.GetBytes(tokenBytes)
            Dim token As String = Convert.ToBase64String(tokenBytes)
            
            Session("CSRFToken") = token
            hfCSRFToken.Value = token
        End Using
    End Sub

    Private Function ValidateCSRFToken() As Boolean
        Dim sessionToken As String = TryCast(Session("CSRFToken"), String)
        Dim formToken As String = hfCSRFToken.Value
        
        If String.IsNullOrEmpty(sessionToken) OrElse String.IsNullOrEmpty(formToken) Then
            Return False
        End If
        
        Return sessionToken.Equals(formToken, StringComparison.Ordinal)
    End Function

    Protected Sub btnSubmitComment_Click(sender As Object, e As EventArgs) Handles btnSubmitComment.Click
        ' CSRF トークン検証
        If Not ValidateCSRFToken() Then
            ShowMessage("不正なリクエストが検出されました", "danger")
            LogSecurityEvent("CSRF attack detected", Request.UserHostAddress)
            Return
        End If
        
        ' 入力検証
        Dim validationResult = ValidateCommentInput()
        If Not validationResult.IsValid Then
            ShowMessage($"入力エラー: {validationResult.ErrorMessage}", "warning")
            Return
        End If
        
        ' XSS対策：入力値のサニタイゼーション
        Dim sanitizedComment As String = SanitizeInput(txtComment.Text)
        
        ' SQLインジェクション対策：パラメータ化クエリでデータベース保存
        SaveComment(txtUserName.Text, sanitizedComment)
        
        ShowMessage("コメントを投稿しました", "success")
        
        ' 新しいCSRFトークンを生成
        GenerateCSRFToken()
        
        ' フォームをクリア
        txtComment.Text = ""
        LoadComments()
    End Sub

    Private Function ValidateCommentInput() As (IsValid As Boolean, ErrorMessage As String)
        Dim errors As New List(Of String)()
        
        ' ユーザー名の検証
        If String.IsNullOrWhiteSpace(txtUserName.Text) Then
            errors.Add("ユーザー名は必須です")
        ElseIf txtUserName.Text.Trim().Length < 2 Then
            errors.Add("ユーザー名は2文字以上で入力してください")
        ElseIf txtUserName.Text.Trim().Length > 50 Then
            errors.Add("ユーザー名は50文字以下で入力してください")
        ElseIf Not Regex.IsMatch(txtUserName.Text.Trim(), "^[a-zA-Z0-9あ-ん亜-龠ひらがなカタカナー]+$") Then
            errors.Add("ユーザー名に不正な文字が含まれています")
        End If
        
        ' コメントの検証
        If String.IsNullOrWhiteSpace(txtComment.Text) Then
            errors.Add("コメントは必須です")
        ElseIf txtComment.Text.Trim().Length > 1000 Then
            errors.Add("コメントは1000文字以下で入力してください")
        End If
        
        ' 悪意のあるパターンの検出
        If ContainsMaliciousPatterns(txtComment.Text) Then
            errors.Add("不適切な内容が含まれています")
            LogSecurityEvent($"Malicious input detected: {txtComment.Text.Substring(0, Math.Min(100, txtComment.Text.Length))}", Request.UserHostAddress)
        End If
        
        If errors.Count > 0 Then
            Return (False, String.Join(", ", errors))
        End If
        
        Return (True, "")
    End Function

    Private Function ContainsMaliciousPatterns(input As String) As Boolean
        If String.IsNullOrEmpty(input) Then Return False
        
        ' XSS攻撃パターンの検出
        Dim maliciousPatterns() As String = {
            "<script",
            "javascript:",
            "vbscript:",
            "onload=",
            "onerror=",
            "onclick=",
            "onmouseover=",
            "eval(",
            "expression(",
            "document.cookie",
            "document.write"
        }
        
        Dim lowerInput As String = input.ToLower()
        For Each pattern In maliciousPatterns
            If lowerInput.Contains(pattern) Then
                Return True
            End If
        Next
        
        ' SQLインジェクション攻撃パターンの検出
        Dim sqlPatterns() As String = {
            "union select",
            "drop table",
            "delete from",
            "insert into",
            "update set",
            "exec(",
            "execute(",
            "sp_",
            "xp_"
        }
        
        For Each pattern In sqlPatterns
            If lowerInput.Contains(pattern) Then
                Return True
            End If
        Next
        
        Return False
    End Function

    Private Function SanitizeInput(input As String) As String
        If String.IsNullOrEmpty(input) Then Return String.Empty
        
        ' HTMLエンコード
        Dim sanitized As String = HttpUtility.HtmlEncode(input.Trim())
        
        ' 追加のサニタイゼーション
        sanitized = sanitized.Replace("&lt;script", "&amp;lt;script")
        sanitized = sanitized.Replace("javascript:", "javascript_")
        sanitized = sanitized.Replace("vbscript:", "vbscript_")
        
        Return sanitized
    End Function

    Private Sub SaveComment(userName As String, comment As String)
        Try
            Using connection As New SqlConnection(ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString)
                connection.Open()
                
                ' テーブル作成（存在しない場合）
                Dim createTableSql As String = "
                    IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='Comments' AND xtype='U')
                    CREATE TABLE Comments (
                        CommentId int IDENTITY(1,1) PRIMARY KEY,
                        UserName nvarchar(50) NOT NULL,
                        Comment nvarchar(1000) NOT NULL,
                        CreatedDate datetime DEFAULT GETDATE(),
                        IPAddress nvarchar(45),
                        UserAgent nvarchar(500)
                    )"
                
                Using createCommand As New SqlCommand(createTableSql, connection)
                    createCommand.ExecuteNonQuery()
                End Using
                
                ' パラメータ化クエリでコメント保存
                Dim insertSql As String = "
                    INSERT INTO Comments (UserName, Comment, IPAddress, UserAgent) 
                    VALUES (@UserName, @Comment, @IPAddress, @UserAgent)"
                
                Using command As New SqlCommand(insertSql, connection)
                    command.Parameters.AddWithValue("@UserName", userName.Trim())
                    command.Parameters.AddWithValue("@Comment", comment)
                    command.Parameters.AddWithValue("@IPAddress", Request.UserHostAddress)
                    command.Parameters.AddWithValue("@UserAgent", Request.UserAgent)
                    command.ExecuteNonQuery()
                End Using
            End Using
            
        Catch ex As Exception
            LogSecurityEvent($"コメント保存エラー: {ex.Message}", Request.UserHostAddress)
            Throw New Exception("コメントの保存に失敗しました")
        End Try
    End Sub

    Private Sub LoadComments()
        Try
            Using connection As New SqlConnection(ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString)
                connection.Open()
                
                Dim sql As String = "
                    SELECT TOP 10 UserName, Comment, CreatedDate 
                    FROM Comments 
                    ORDER BY CreatedDate DESC"
                
                Using command As New SqlCommand(sql, connection)
                    Using reader As SqlDataReader = command.ExecuteReader()
                        Dim commentsHtml As New StringBuilder()
                        commentsHtml.AppendLine("<div class='list-group'>")
                        
                        While reader.Read()
                            Dim userName As String = reader.GetString("UserName")
                            Dim comment As String = reader.GetString("Comment")
                            Dim createdDate As DateTime = reader.GetDateTime("CreatedDate")
                            
                            commentsHtml.AppendLine("<div class='list-group-item'>")
                            commentsHtml.AppendLine($"<div class='d-flex w-100 justify-content-between'>")
                            commentsHtml.AppendLine($"<h6 class='mb-1'>{HttpUtility.HtmlEncode(userName)}</h6>")
                            commentsHtml.AppendLine($"<small>{createdDate:yyyy/MM/dd HH:mm}</small>")
                            commentsHtml.AppendLine("</div>")
                            commentsHtml.AppendLine($"<p class='mb-1'>{comment}</p>")
                            commentsHtml.AppendLine("</div>")
                        End While
                        
                        commentsHtml.AppendLine("</div>")
                        
                        If commentsHtml.Length > 50 Then
                            lblComments.Text = commentsHtml.ToString()
                        Else
                            lblComments.Text = "<p class='text-muted'>まだコメントはありません</p>"
                        End If
                    End Using
                End Using
            End Using
            
        Catch ex As Exception
            lblComments.Text = "<p class='text-danger'>コメントの読み込みに失敗しました</p>"
            LogSecurityEvent($"コメント読み込みエラー: {ex.Message}", Request.UserHostAddress)
        End Try
    End Sub

    Private Sub LogSecurityEvent(eventDescription As String, ipAddress As String)
        Try
            System.Diagnostics.Debug.WriteLine($"Security Event: {DateTime.Now:yyyy-MM-dd HH:mm:ss} - {eventDescription} - IP: {ipAddress}")
            
            ' 実際の実装では、セキュリティログファイルやSIEMシステムに送信
        Catch ex As Exception
            System.Diagnostics.Debug.WriteLine($"ログ記録エラー: {ex.Message}")
        End Try
    End Sub

    Private Sub ShowMessage(message As String, type As String)
        Dim script As String = $"
            setTimeout(function() {{
                var alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-{type} alert-dismissible fade show';
                alertDiv.innerHTML = '{HttpUtility.JavaScriptStringEncode(message)}<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>';
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
                setTimeout(function() {{ alertDiv.remove(); }}, 5000);
            }}, 100);"
        
        ClientScript.RegisterStartupScript(Me.GetType(), "ShowMessage", script, True)
    End Sub

    Protected Sub Page_PreRender(sender As Object, e As EventArgs) Handles Me.PreRender
        LoadComments()
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>包括的なセキュリティ対策が実装され、XSS、CSRF、SQLインジェクション攻撃に対する防御機能が適切に動作します。</p>
                    </div>

                    <h3 class="section-title">7.3 ロールベースアクセス制御</h3>
                    <p>ユーザーの権限に応じたアクセス制御システムを実装し、機能レベルでのセキュリティを確保します。</p>

                    <h4>アクセス制御の実装レベル</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>レベル</th>
                                <th>実装方法</th>
                                <th>粒度</th>
                                <th>用途</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>URL レベル</td>
                                <td>Web.config の &lt;authorization&gt;</td>
                                <td>粗い</td>
                                <td>ページ単位のアクセス制御</td>
                            </tr>
                            <tr>
                                <td>コードレベル</td>
                                <td>PrincipalPermission 属性</td>
                                <td>中</td>
                                <td>メソッド単位のアクセス制御</td>
                            </tr>
                            <tr>
                                <td>UI レベル</td>
                                <td>LoginView, ロール条件分岐</td>
                                <td>細かい</td>
                                <td>コントロール表示制御</td>
                            </tr>
                            <tr>
                                <td>データレベル</td>
                                <td>データフィルタリング</td>
                                <td>最細</td>
                                <td>行レベルのアクセス制御</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>Forms認証でセキュアな認証チケットを作成するための重要な設定を3つ挙げてください。</li>
                            <li>パスワードハッシュ化でソルトを使用する理由を説明してください。</li>
                            <li>XSS攻撃を防ぐための入力値処理方法を具体的に説明してください。</li>
                            <li>CSRF攻撃の仕組みと対策方法を説明してください。</li>
                            <li>アカウントロック機能を実装する理由と注意点を説明してください。</li>
                            <li>セキュリティヘッダーの役割と主要なヘッダーを3つ挙げてください。</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>HttpOnly=true、Secure=true（HTTPS）、適切な有効期限設定</li>
                                <li>レインボーテーブル攻撃対策。同じパスワードでも異なるハッシュ値となり、辞書攻撃を困難にする</li>
                                <li>HttpUtility.HtmlEncode()でHTMLエスケープ、悪意のあるスクリプトタグ等の検出・除去</li>
                                <li>攻撃者が被害者のブラウザを使って不正リクエスト送信。対策：CSRFトークンによるリクエスト検証</li>
                                <li>ブルートフォース攻撃対策。注意：正当ユーザーの誤ロック、DoS攻撃の可能性</li>
                                <li>XSS保護、盗聴対策、フレーム埋め込み防止。例：X-XSS-Protection、Strict-Transport-Security、X-Frame-Options</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-6.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-8.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>