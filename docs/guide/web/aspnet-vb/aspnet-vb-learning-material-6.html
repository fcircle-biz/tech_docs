<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET(VB.NET)学習教材 第6章 - セッション管理と状態管理</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #1976d2;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #1976d2;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #42a5f5;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #1976d2;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #1976d2 !important;
            color: white !important;
        }

        /* プリフォーマット */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ASP.NET(VB.NET)学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../README.md">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.md">ASP.NET VBガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: ASP.NET基礎とセットアップ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: VB.NET言語基礎復習</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">第3章: Web Forms基本</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">第4章: サーバーコントロールとイベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">第5章: データベース連携（ADO.NET）</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter6">第6章: セッション管理と状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">第7章: 認証とセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: エラーハンドリングとデバッグ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: セッション管理と状態管理</h1>
                </div>

                <div id="chapter6">
                    <h2 class="chapter-title">HTTP無状態性とASP.NETの状態管理機能</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>HTTP無状態プロトコルの問題と解決策</li>
                            <li>ASP.NETの状態管理オプションの種類と特徴</li>
                            <li>Session状態の使用方法と管理</li>
                            <li>ViewStateの仕組みと制御方法</li>
                            <li>Application状態とグローバル変数の活用</li>
                            <li>Cookieの作成と管理</li>
                            <li>QueryStringとHiddenFieldの適切な使用</li>
                            <li>各状態管理手法の使い分けとベストプラクティス</li>
                        </ul>
                    </div>

                    <h3 class="section-title">6.1 HTTP無状態プロトコルと状態管理の必要性</h3>
                    <p>HTTPプロトコルはステートレス（無状態）であり、各リクエストは独立しています。Webアプリケーションでユーザーエクスペリエンスを向上させるには、適切な状態管理が必要です。</p>
                    
                    <h4>状態管理の手法比較</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>手法</th>
                                <th>スコープ</th>
                                <th>場所</th>
                                <th>パフォーマンス</th>
                                <th>適用場面</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ViewState</td>
                                <td>ページ内</td>
                                <td>クライアント</td>
                                <td>中</td>
                                <td>コントロール状態保持</td>
                            </tr>
                            <tr>
                                <td>Session</td>
                                <td>ユーザーセッション</td>
                                <td>サーバー</td>
                                <td>中</td>
                                <td>ユーザー固有データ</td>
                            </tr>
                            <tr>
                                <td>Application</td>
                                <td>アプリケーション全体</td>
                                <td>サーバー</td>
                                <td>高</td>
                                <td>グローバル設定・キャッシュ</td>
                            </tr>
                            <tr>
                                <td>Cookie</td>
                                <td>ブラウザ</td>
                                <td>クライアント</td>
                                <td>高</td>
                                <td>永続的なユーザー設定</td>
                            </tr>
                            <tr>
                                <td>QueryString</td>
                                <td>単一リクエスト</td>
                                <td>URL</td>
                                <td>高</td>
                                <td>ページ間データ受け渡し</td>
                            </tr>
                            <tr>
                                <td>HiddenField</td>
                                <td>ポストバック間</td>
                                <td>クライアント</td>
                                <td>高</td>
                                <td>一時的なページデータ</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 6-1: 基本的な状態管理手法の実装と比較</h5>
                        <p>ショッピングカート機能を通じて、各種状態管理手法を実装し、特徴を比較します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいWebフォーム「StateManagement.aspx」を作成</li>
                            <li>複数の状態管理手法を同時に使用</li>
                            <li>各手法のデータ保持の動作を確認</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>StateManagement.aspx</strong></p>
                        <pre><code>&lt;%@ Page Language="VB" AutoEventWireup="false" CodeBehind="StateManagement.aspx.vb" 
    Inherits="WebApplication1.StateManagement" EnableViewState="true" %&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head runat="server"&gt;
    &lt;title&gt;状態管理デモンストレーション&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" /&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id="form1" runat="server"&gt;
        &lt;div class="container mt-4"&gt;
            &lt;h2&gt;状態管理デモンストレーション&lt;/h2&gt;
            
            &lt;!-- Hidden Fields --&gt;
            &lt;asp:HiddenField ID="hfPageVisitCount" runat="server" Value="0" /&gt;
            &lt;asp:HiddenField ID="hfTemporaryData" runat="server" /&gt;
            
            &lt;div class="row"&gt;
                &lt;div class="col-md-6"&gt;
                    &lt;div class="card"&gt;
                        &lt;div class="card-header"&gt;
                            &lt;h4&gt;商品選択&lt;/h4&gt;
                        &lt;/div&gt;
                        &lt;div class="card-body"&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Label ID="lblProduct" runat="server" Text="商品:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                                &lt;asp:DropDownList ID="ddlProducts" runat="server" CssClass="form-select"&gt;
                                    &lt;asp:ListItem Value="1" Text="ノートパソコン - ¥89,800"&gt;&lt;/asp:ListItem&gt;
                                    &lt;asp:ListItem Value="2" Text="マウス - ¥2,980"&gt;&lt;/asp:ListItem&gt;
                                    &lt;asp:ListItem Value="3" Text="キーボード - ¥5,800"&gt;&lt;/asp:ListItem&gt;
                                    &lt;asp:ListItem Value="4" Text="モニター - ¥24,800"&gt;&lt;/asp:ListItem&gt;
                                &lt;/asp:DropDownList&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Label ID="lblQuantity" runat="server" Text="数量:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                                &lt;asp:TextBox ID="txtQuantity" runat="server" CssClass="form-control" 
                                    TextMode="Number" Text="1" Min="1" Max="10"&gt;&lt;/asp:TextBox&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Button ID="btnAddToCart" runat="server" Text="カートに追加" CssClass="btn btn-primary me-2" /&gt;
                                &lt;asp:Button ID="btnClearCart" runat="server" Text="カートクリア" CssClass="btn btn-warning" /&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="card mt-3"&gt;
                        &lt;div class="card-header"&gt;
                            &lt;h4&gt;ユーザー設定&lt;/h4&gt;
                        &lt;/div&gt;
                        &lt;div class="card-body"&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Label ID="lblTheme" runat="server" Text="テーマ:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                                &lt;asp:RadioButtonList ID="rblTheme" runat="server" RepeatDirection="Horizontal" AutoPostBack="True"&gt;
                                    &lt;asp:ListItem Value="light" Text="ライト" Selected="True"&gt;&lt;/asp:ListItem&gt;
                                    &lt;asp:ListItem Value="dark" Text="ダーク"&gt;&lt;/asp:ListItem&gt;
                                &lt;/asp:RadioButtonList&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="mb-3"&gt;
                                &lt;asp:CheckBox ID="chkRememberMe" runat="server" Text="設定を記憶する" AutoPostBack="True" /&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="mb-3"&gt;
                                &lt;asp:Button ID="btnSavePreferences" runat="server" Text="設定保存" CssClass="btn btn-success" /&gt;
                                &lt;asp:Button ID="btnResetPreferences" runat="server" Text="設定リセット" CssClass="btn btn-secondary" /&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="col-md-6"&gt;
                    &lt;div class="card"&gt;
                        &lt;div class="card-header"&gt;
                            &lt;h4&gt;状態情報表示&lt;/h4&gt;
                        &lt;/div&gt;
                        &lt;div class="card-body"&gt;
                            &lt;h6&gt;Session状態&lt;/h6&gt;
                            &lt;asp:Label ID="lblSessionInfo" runat="server" CssClass="text-info"&gt;&lt;/asp:Label&gt;
                            
                            &lt;h6 class="mt-3"&gt;ViewState状態&lt;/h6&gt;
                            &lt;asp:Label ID="lblViewStateInfo" runat="server" CssClass="text-primary"&gt;&lt;/asp:Label&gt;
                            
                            &lt;h6 class="mt-3"&gt;Application状態&lt;/h6&gt;
                            &lt;asp:Label ID="lblApplicationInfo" runat="server" CssClass="text-success"&gt;&lt;/asp:Label&gt;
                            
                            &lt;h6 class="mt-3"&gt;Cookie情報&lt;/h6&gt;
                            &lt;asp:Label ID="lblCookieInfo" runat="server" CssClass="text-warning"&gt;&lt;/asp:Label&gt;
                            
                            &lt;h6 class="mt-3"&gt;HiddenField状態&lt;/h6&gt;
                            &lt;asp:Label ID="lblHiddenFieldInfo" runat="server" CssClass="text-secondary"&gt;&lt;/asp:Label&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="card mt-3"&gt;
                        &lt;div class="card-header"&gt;
                            &lt;h4&gt;ショッピングカート&lt;/h4&gt;
                        &lt;/div&gt;
                        &lt;div class="card-body"&gt;
                            &lt;asp:Label ID="lblCartContents" runat="server"&gt;&lt;/asp:Label&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="row mt-3"&gt;
                &lt;div class="col-12"&gt;
                    &lt;div class="card"&gt;
                        &lt;div class="card-header"&gt;
                            &lt;h4&gt;デバッグ情報&lt;/h4&gt;
                        &lt;/div&gt;
                        &lt;div class="card-body"&gt;
                            &lt;asp:Label ID="lblDebugInfo" runat="server"&gt;&lt;/asp:Label&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <p><strong>StateManagement.aspx.vb</strong></p>
                        <pre><code>Public Class StateManagement
    Inherits System.Web.UI.Page

    ' 商品情報（実際の実装ではデータベースから取得）
    Private ReadOnly Products As New Dictionary(Of String, Object()) From {
        {"1", {"ノートパソコン", 89800}},
        {"2", {"マウス", 2980}},
        {"3", {"キーボード", 5800}},
        {"4", {"モニター", 24800}}
    }

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        ' ページ訪問回数の管理（HiddenField使用）
        UpdatePageVisitCount()
        
        ' Application状態の初期化
        InitializeApplicationState()
        
        If Not IsPostBack Then
            InitializePage()
            LoadUserPreferences()
        End If
        
        ' 状態情報の表示更新
        DisplayStateInformation()
        DisplayCartContents()
        DisplayDebugInformation()
    End Sub

    Private Sub InitializePage()
        ' Sessionの初期化
        If Session("CartItems") Is Nothing Then
            Session("CartItems") = New List(Of Dictionary(Of String, Object))()
        End If
        
        If Session("SessionStartTime") Is Nothing Then
            Session("SessionStartTime") = DateTime.Now
        End If
        
        ' ViewStateにページ固有データを保存
        ViewState("PageLoadTime") = DateTime.Now
        ViewState("RandomNumber") = New Random().Next(1000, 9999)
    End Sub

    Private Sub UpdatePageVisitCount()
        ' HiddenFieldを使用したページ内状態管理
        Dim visitCount As Integer = 0
        If Integer.TryParse(hfPageVisitCount.Value, visitCount) Then
            visitCount += 1
        Else
            visitCount = 1
        End If
        hfPageVisitCount.Value = visitCount.ToString()
        
        ' 一時データの保存
        hfTemporaryData.Value = $"Last visit: {DateTime.Now:HH:mm:ss}"
    End Sub

    Private Sub InitializeApplicationState()
        ' Application状態でグローバルカウンターを管理
        Application.Lock()
        Try
            If Application("TotalPageViews") Is Nothing Then
                Application("TotalPageViews") = 0
            End If
            Application("TotalPageViews") = CInt(Application("TotalPageViews")) + 1
            
            If Application("AppStartTime") Is Nothing Then
                Application("AppStartTime") = DateTime.Now
            End If
        Finally
            Application.UnLock()
        End Try
    End Sub

    Protected Sub btnAddToCart_Click(sender As Object, e As EventArgs) Handles btnAddToCart.Click
        Try
            Dim productId As String = ddlProducts.SelectedValue
            Dim quantity As Integer = Integer.Parse(txtQuantity.Text)
            
            ' Sessionを使用したカート管理
            Dim cartItems As List(Of Dictionary(Of String, Object)) = 
                DirectCast(Session("CartItems"), List(Of Dictionary(Of String, Object)))
            
            Dim productInfo = Products(productId)
            Dim cartItem As New Dictionary(Of String, Object) From {
                {"ProductId", productId},
                {"ProductName", productInfo(0)},
                {"Price", productInfo(1)},
                {"Quantity", quantity},
                {"AddedTime", DateTime.Now}
            }
            
            cartItems.Add(cartItem)
            Session("CartItems") = cartItems
            
            ' ViewStateにも最後に追加した商品情報を保存
            ViewState("LastAddedProduct") = cartItem
            
            ShowMessage($"{productInfo(0)} x {quantity} をカートに追加しました", "success")
            
        Catch ex As Exception
            ShowMessage($"カート追加エラー: {ex.Message}", "danger")
        End Try
    End Sub

    Protected Sub btnClearCart_Click(sender As Object, e As EventArgs) Handles btnClearCart.Click
        Session("CartItems") = New List(Of Dictionary(Of String, Object))()
        ViewState("LastAddedProduct") = Nothing
        ShowMessage("カートをクリアしました", "info")
    End Sub

    Protected Sub btnSavePreferences_Click(sender As Object, e As EventArgs) Handles btnSavePreferences.Click
        SaveUserPreferences()
        ShowMessage("ユーザー設定を保存しました", "success")
    End Sub

    Protected Sub btnResetPreferences_Click(sender As Object, e As EventArgs) Handles btnResetPreferences.Click
        ResetUserPreferences()
        ShowMessage("ユーザー設定をリセットしました", "info")
    End Sub

    Protected Sub rblTheme_SelectedIndexChanged(sender As Object, e As EventArgs) Handles rblTheme.SelectedIndexChanged
        ApplyTheme(rblTheme.SelectedValue)
        
        If chkRememberMe.Checked Then
            SaveUserPreferences()
        End If
    End Sub

    Protected Sub chkRememberMe_CheckedChanged(sender As Object, e As EventArgs) Handles chkRememberMe.CheckedChanged
        If chkRememberMe.Checked Then
            SaveUserPreferences()
        Else
            ' Cookieを削除
            Dim cookie As New HttpCookie("UserPreferences")
            cookie.Expires = DateTime.Now.AddDays(-1)
            Response.Cookies.Add(cookie)
        End If
    End Sub

    Private Sub SaveUserPreferences()
        If chkRememberMe.Checked Then
            ' Cookieに設定を保存
            Dim cookie As New HttpCookie("UserPreferences")
            cookie.Values("Theme") = rblTheme.SelectedValue
            cookie.Values("RememberMe") = chkRememberMe.Checked.ToString()
            cookie.Values("SavedTime") = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")
            cookie.Expires = DateTime.Now.AddDays(30) ' 30日間有効
            cookie.HttpOnly = True ' XSS対策
            Response.Cookies.Add(cookie)
        End If
        
        ' Sessionにも保存
        Session("UserTheme") = rblTheme.SelectedValue
        Session("RememberPreferences") = chkRememberMe.Checked
    End Sub

    Private Sub LoadUserPreferences()
        ' Cookieから設定を読み込み
        Dim cookie As HttpCookie = Request.Cookies("UserPreferences")
        If cookie IsNot Nothing Then
            Dim theme As String = cookie.Values("Theme")
            Dim rememberMe As String = cookie.Values("RememberMe")
            
            If Not String.IsNullOrEmpty(theme) Then
                rblTheme.SelectedValue = theme
                ApplyTheme(theme)
            End If
            
            If Not String.IsNullOrEmpty(rememberMe) Then
                chkRememberMe.Checked = Boolean.Parse(rememberMe)
            End If
        End If
        
        ' Sessionからも読み込み
        If Session("UserTheme") IsNot Nothing Then
            rblTheme.SelectedValue = Session("UserTheme").ToString()
            ApplyTheme(Session("UserTheme").ToString())
        End If
    End Sub

    Private Sub ResetUserPreferences()
        ' Cookie削除
        Dim cookie As New HttpCookie("UserPreferences")
        cookie.Expires = DateTime.Now.AddDays(-1)
        Response.Cookies.Add(cookie)
        
        ' Session削除
        Session.Remove("UserTheme")
        Session.Remove("RememberPreferences")
        
        ' デフォルト値に戻す
        rblTheme.SelectedValue = "light"
        chkRememberMe.Checked = False
        ApplyTheme("light")
    End Sub

    Private Sub ApplyTheme(theme As String)
        Select Case theme
            Case "dark"
                Page.Header.Controls.Add(New LiteralControl(
                    "<style>body { background-color: #343a40; color: #fff; } .card { background-color: #495057; border-color: #6c757d; } .form-control, .form-select { background-color: #495057; color: #fff; border-color: #6c757d; }</style>"))
            Case "light"
                ' デフォルトテーマ（何もしない）
        End Select
    End Sub

    Private Sub DisplayStateInformation()
        ' Session情報
        Dim sessionInfo As New System.Text.StringBuilder()
        sessionInfo.AppendLine($"セッションID: {Session.SessionID}<br/>")
        sessionInfo.AppendLine($"開始時刻: {Session("SessionStartTime"):HH:mm:ss}<br/>")
        sessionInfo.AppendLine($"タイムアウト: {Session.Timeout}分<br/>")
        sessionInfo.AppendLine($"カート商品数: {DirectCast(Session("CartItems"), List(Of Dictionary(Of String, Object))).Count}個")
        lblSessionInfo.Text = sessionInfo.ToString()
        
        ' ViewState情報
        Dim viewStateInfo As New System.Text.StringBuilder()
        viewStateInfo.AppendLine($"ページ読み込み時刻: {ViewState("PageLoadTime"):HH:mm:ss}<br/>")
        viewStateInfo.AppendLine($"ランダム番号: {ViewState("RandomNumber")}<br/>")
        If ViewState("LastAddedProduct") IsNot Nothing Then
            Dim lastProduct = DirectCast(ViewState("LastAddedProduct"), Dictionary(Of String, Object))
            viewStateInfo.AppendLine($"最後に追加した商品: {lastProduct("ProductName")}")
        Else
            viewStateInfo.AppendLine("最後に追加した商品: なし")
        End If
        lblViewStateInfo.Text = viewStateInfo.ToString()
        
        ' Application情報
        Dim appInfo As New System.Text.StringBuilder()
        appInfo.AppendLine($"アプリケーション開始時刻: {Application("AppStartTime"):yyyy/MM/dd HH:mm:ss}<br/>")
        appInfo.AppendLine($"総ページビュー数: {Application("TotalPageViews")}<br/>")
        appInfo.AppendLine($"現在のユーザー数: {Application.Contents.Count}")
        lblApplicationInfo.Text = appInfo.ToString()
        
        ' Cookie情報
        Dim cookieInfo As New System.Text.StringBuilder()
        Dim userPrefCookie As HttpCookie = Request.Cookies("UserPreferences")
        If userPrefCookie IsNot Nothing Then
            cookieInfo.AppendLine($"テーマ設定: {userPrefCookie.Values("Theme")}<br/>")
            cookieInfo.AppendLine($"保存時刻: {userPrefCookie.Values("SavedTime")}<br/>")
            cookieInfo.AppendLine($"有効期限: {userPrefCookie.Expires:yyyy/MM/dd}")
        Else
            cookieInfo.AppendLine("保存された設定はありません")
        End If
        lblCookieInfo.Text = cookieInfo.ToString()
        
        ' HiddenField情報
        Dim hiddenInfo As New System.Text.StringBuilder()
        hiddenInfo.AppendLine($"ページ訪問回数: {hfPageVisitCount.Value}<br/>")
        hiddenInfo.AppendLine($"一時データ: {hfTemporaryData.Value}")
        lblHiddenFieldInfo.Text = hiddenInfo.ToString()
    End Sub

    Private Sub DisplayCartContents()
        Dim cartItems As List(Of Dictionary(Of String, Object)) = 
            DirectCast(Session("CartItems"), List(Of Dictionary(Of String, Object)))
        
        If cartItems.Count = 0 Then
            lblCartContents.Text = "<p class='text-muted'>カートは空です</p>"
            Return
        End If
        
        Dim cartHtml As New System.Text.StringBuilder()
        cartHtml.AppendLine("<div class='table-responsive'>")
        cartHtml.AppendLine("<table class='table table-sm'>")
        cartHtml.AppendLine("<thead><tr><th>商品名</th><th>数量</th><th>単価</th><th>小計</th></tr></thead>")
        cartHtml.AppendLine("<tbody>")
        
        Dim total As Decimal = 0
        For Each item In cartItems
            Dim subtotal As Decimal = Convert.ToDecimal(item("Price")) * Convert.ToInt32(item("Quantity"))
            total += subtotal
            
            cartHtml.AppendLine("<tr>")
            cartHtml.AppendLine($"<td>{item("ProductName")}</td>")
            cartHtml.AppendLine($"<td>{item("Quantity")}</td>")
            cartHtml.AppendLine($"<td>{Convert.ToDecimal(item("Price")):C}</td>")
            cartHtml.AppendLine($"<td>{subtotal:C}</td>")
            cartHtml.AppendLine("</tr>")
        Next
        
        cartHtml.AppendLine("</tbody>")
        cartHtml.AppendLine($"<tfoot><tr><th colspan='3'>合計</th><th>{total:C}</th></tr></tfoot>")
        cartHtml.AppendLine("</table></div>")
        
        lblCartContents.Text = cartHtml.ToString()
    End Sub

    Private Sub DisplayDebugInformation()
        Dim debugInfo As New System.Text.StringBuilder()
        debugInfo.AppendLine($"<strong>リクエスト情報:</strong><br/>")
        debugInfo.AppendLine($"URL: {Request.Url}<br/>")
        debugInfo.AppendLine($"メソッド: {Request.HttpMethod}<br/>")
        debugInfo.AppendLine($"ユーザーエージェント: {Request.UserAgent}<br/>")
        debugInfo.AppendLine($"IsPostBack: {IsPostBack}<br/>")
        debugInfo.AppendLine($"ViewState有効: {EnableViewState}<br/>")
        debugInfo.AppendLine($"現在時刻: {DateTime.Now:yyyy/MM/dd HH:mm:ss}<br/>")
        
        ' ViewStateサイズの概算
        If IsPostBack Then
            Dim viewStateSize As Integer = Request.Form("__VIEWSTATE")?.Length
            debugInfo.AppendLine($"ViewStateサイズ（概算）: {viewStateSize:N0} 文字")
        End If
        
        lblDebugInfo.Text = debugInfo.ToString()
    End Sub

    Private Sub ShowMessage(message As String, type As String)
        ' JavaScriptアラートでメッセージを表示
        Dim script As String = $"
            setTimeout(function() {{
                var alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-{type} alert-dismissible fade show';
                alertDiv.innerHTML = '{HttpUtility.JavaScriptStringEncode(message)}<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>';
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
                setTimeout(function() {{ alertDiv.remove(); }}, 5000);
            }}, 100);"
        
        ClientScript.RegisterStartupScript(Me.GetType(), "ShowMessage", script, True)
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>各状態管理手法が正常に動作し、Session、ViewState、Application、Cookie、HiddenFieldの特徴と違いが明確に確認できます。</p>
                    </div>

                    <h3 class="section-title">6.2 Session状態の詳細管理</h3>
                    <p>Session状態は、ユーザーごとに一意のセッションIDで管理される状態情報です。適切な管理とセキュリティ対策が重要です。</p>

                    <div class="warning">
                        <h6>Session管理での注意点</h6>
                        <ul>
                            <li>メモリ使用量の増加に注意</li>
                            <li>セッションタイムアウトの適切な設定</li>
                            <li>スケールアウト環境での状態共有</li>
                            <li>セッションハイジャック対策</li>
                        </ul>
                    </div>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 6-2: 高度なSession管理とセキュリティの実装</h5>
                        <p>セキュアなセッション管理システムを構築し、セッション固定攻撃対策を実装します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいWebフォーム「SecureSession.aspx」を作成</li>
                            <li>セッション状態の詳細監視機能を実装</li>
                            <li>セキュリティ対策とベストプラクティスを適用</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>SecureSession.aspx.vb</strong></p>
                        <pre><code>Imports System.Security.Cryptography
Imports System.Text

Public Class SecureSession
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        If Not IsPostBack Then
            InitializeSecureSession()
        End If
        
        DisplaySessionInformation()
        LogSessionActivity()
    End Sub

    Private Sub InitializeSecureSession()
        ' セッション開始時の初期化
        If Session("SessionInitialized") Is Nothing Then
            ' セッション開始時刻の記録
            Session("SessionStartTime") = DateTime.Now
            Session("SessionInitialized") = True
            
            ' セッションIDの記録（セッション固定攻撃対策用）
            Session("OriginalSessionID") = Session.SessionID
            
            ' セキュリティトークンの生成
            Session("SecurityToken") = GenerateSecurityToken()
            
            ' ユーザーエージェントの記録（セッションハイジャック対策）
            Session("UserAgent") = Request.UserAgent
            Session("RemoteAddress") = Request.UserHostAddress
            
            ' セッションメタデータの初期化
            InitializeSessionMetadata()
        End If
        
        ' セキュリティチェック
        ValidateSessionSecurity()
    End Sub

    Private Sub InitializeSessionMetadata()
        ' セッションメタデータの管理
        Dim metadata As New Dictionary(Of String, Object) From {
            {"CreatedTime", DateTime.Now},
            {"LastAccessTime", DateTime.Now},
            {"AccessCount", 1},
            {"IsSecure", Request.IsSecureConnection},
            {"Browser", Request.Browser.Browser},
            {"Platform", Request.Browser.Platform}
        }
        
        Session("SessionMetadata") = metadata
    End Sub

    Private Function GenerateSecurityToken() As String
        ' セキュリティトークンの生成
        Using rng As New RNGCryptoServiceProvider()
            Dim tokenBytes(31) As Byte
            rng.GetBytes(tokenBytes)
            Return Convert.ToBase64String(tokenBytes)
        End Using
    End Function

    Private Sub ValidateSessionSecurity()
        Try
            ' ユーザーエージェントの検証
            If Session("UserAgent") IsNot Nothing AndAlso 
               Session("UserAgent").ToString() <> Request.UserAgent Then
                HandleSecurityViolation("User-Agent不一致検出")
                Return
            End If
            
            ' IPアドレスの変更チェック（厳密にしすぎると正常なユーザーも弾く可能性）
            If Session("RemoteAddress") IsNot Nothing AndAlso 
               Session("RemoteAddress").ToString() <> Request.UserHostAddress Then
                LogSecurityEvent($"IPアドレス変更: {Session("RemoteAddress")} → {Request.UserHostAddress}")
                ' 警告レベルとして記録（強制終了はしない）
            End If
            
            ' セッションタイムアウトチェック
            If Session("SessionStartTime") IsNot Nothing Then
                Dim sessionAge As TimeSpan = DateTime.Now - DirectCast(Session("SessionStartTime"), DateTime)
                If sessionAge.TotalHours > 8 Then ' 8時間でタイムアウト
                    HandleSessionTimeout()
                    Return
                End If
            End If
            
            ' メタデータの更新
            UpdateSessionMetadata()
            
        Catch ex As Exception
            LogSecurityEvent($"セキュリティ検証エラー: {ex.Message}")
        End Try
    End Sub

    Private Sub UpdateSessionMetadata()
        If Session("SessionMetadata") IsNot Nothing Then
            Dim metadata = DirectCast(Session("SessionMetadata"), Dictionary(Of String, Object))
            metadata("LastAccessTime") = DateTime.Now
            metadata("AccessCount") = CInt(metadata("AccessCount")) + 1
            Session("SessionMetadata") = metadata
        End If
    End Sub

    Private Sub HandleSecurityViolation(reason As String)
        LogSecurityEvent($"セキュリティ違反: {reason}")
        
        ' セッションの無効化
        Session.Clear()
        Session.Abandon()
        
        ' 新しいセッションを開始
        Response.Redirect(Request.Url.ToString(), True)
    End Sub

    Private Sub HandleSessionTimeout()
        LogSecurityEvent("セッションタイムアウト")
        
        ' タイムアウトメッセージを表示してセッションクリア
        Session.Clear()
        Session.Abandon()
        
        ShowMessage("セッションがタイムアウトしました。新しいセッションを開始します。", "warning")
        Response.Redirect(Request.Url.ToString(), True)
    End Sub

    Private Sub LogSecurityEvent(eventDescription As String)
        ' セキュリティイベントのログ記録
        Dim logEntry As String = $"{DateTime.Now:yyyy-MM-dd HH:mm:ss} - {eventDescription} - SessionID: {Session.SessionID} - IP: {Request.UserHostAddress}"
        System.Diagnostics.Debug.WriteLine($"Security Event: {logEntry}")
        
        ' 実際の実装では、セキュリティログファイルやデータベースに記録
    End Sub

    Private Sub LogSessionActivity()
        ' セッションアクティビティの記録
        If Application("SessionActivities") Is Nothing Then
            Application.Lock()
            Application("SessionActivities") = New List(Of Dictionary(Of String, Object))()
            Application.UnLock()
        End If
        
        Application.Lock()
        Try
            Dim activities = DirectCast(Application("SessionActivities"), List(Of Dictionary(Of String, Object)))
            
            ' 現在のアクティビティを追加
            Dim activity As New Dictionary(Of String, Object) From {
                {"SessionID", Session.SessionID},
                {"Timestamp", DateTime.Now},
                {"Page", Request.Url.ToString()},
                {"UserAgent", Request.UserAgent},
                {"RemoteAddress", Request.UserHostAddress}
            }
            
            activities.Add(activity)
            
            ' 古いアクティビティを削除（最新100件のみ保持）
            If activities.Count > 100 Then
                activities.RemoveRange(0, activities.Count - 100)
            End If
            
            Application("SessionActivities") = activities
        Finally
            Application.UnLock()
        End Try
    End Sub

    Protected Sub btnRegenerateSession_Click(sender As Object, e As EventArgs) Handles btnRegenerateSession.Click
        ' セッションIDの再生成（セッション固定攻撃対策）
        Dim currentData As New Dictionary(Of String, Object)()
        
        ' 現在のセッションデータを保存
        For Each key As String In Session.Keys
            currentData(key) = Session(key)
        Next
        
        ' セッションを破棄
        Session.Abandon()
        
        ' 新しいセッションでデータを復元
        For Each kvp In currentData
            Session(kvp.Key) = kvp.Value
        Next
        
        ' 新しいセッションIDを記録
        Session("RegeneratedSessionID") = Session.SessionID
        Session("RegenerationTime") = DateTime.Now
        
        ShowMessage($"セッションIDを再生成しました: {Session.SessionID}", "success")
    End Sub

    Protected Sub btnClearSession_Click(sender As Object, e As EventArgs) Handles btnClearSession.Click
        LogSecurityEvent("手動セッションクリア")
        Session.Clear()
        ShowMessage("セッションデータをクリアしました", "info")
    End Sub

    Protected Sub btnSetSessionData_Click(sender As Object, e As EventArgs) Handles btnSetSessionData.Click
        ' サンプルデータの設定
        Session("UserName") = txtUserName.Text
        Session("UserRole") = ddlUserRole.SelectedValue
        Session("LoginTime") = DateTime.Now
        Session("Preferences") = New Dictionary(Of String, String) From {
            {"Language", "ja-JP"},
            {"TimeZone", "Asia/Tokyo"},
            {"Theme", "Default"}
        }
        
        ShowMessage("セッションデータを設定しました", "success")
    End Sub

    Private Sub DisplaySessionInformation()
        Try
            Dim sessionInfo As New StringBuilder()
            sessionInfo.AppendLine("<div class='row'>")
            
            ' 基本セッション情報
            sessionInfo.AppendLine("<div class='col-md-6'>")
            sessionInfo.AppendLine("<h6>基本情報</h6>")
            sessionInfo.AppendLine($"<p><strong>セッションID:</strong> {Session.SessionID}</p>")
            sessionInfo.AppendLine($"<p><strong>開始時刻:</strong> {Session("SessionStartTime"):yyyy-MM-dd HH:mm:ss}</p>")
            sessionInfo.AppendLine($"<p><strong>タイムアウト:</strong> {Session.Timeout}分</p>")
            sessionInfo.AppendLine($"<p><strong>セキュリティトークン:</strong> {Session("SecurityToken")?.ToString().Substring(0, 10)}...</p>")
            sessionInfo.AppendLine("</div>")
            
            ' セッションメタデータ
            sessionInfo.AppendLine("<div class='col-md-6'>")
            sessionInfo.AppendLine("<h6>メタデータ</h6>")
            If Session("SessionMetadata") IsNot Nothing Then
                Dim metadata = DirectCast(Session("SessionMetadata"), Dictionary(Of String, Object))
                For Each kvp In metadata
                    sessionInfo.AppendLine($"<p><strong>{kvp.Key}:</strong> {kvp.Value}</p>")
                Next
            End If
            sessionInfo.AppendLine("</div>")
            
            sessionInfo.AppendLine("</div>")
            
            ' セッションデータ一覧
            sessionInfo.AppendLine("<h6 class='mt-3'>セッションデータ</h6>")
            sessionInfo.AppendLine("<div class='table-responsive'>")
            sessionInfo.AppendLine("<table class='table table-sm table-striped'>")
            sessionInfo.AppendLine("<thead><tr><th>キー</th><th>型</th><th>値</th></tr></thead>")
            sessionInfo.AppendLine("<tbody>")
            
            For Each key As String In Session.Keys
                Dim value = Session(key)
                Dim valueType As String = If(value IsNot Nothing, value.GetType().Name, "null")
                Dim displayValue As String = If(value IsNot Nothing, value.ToString(), "null")
                
                ' 長い値は省略
                If displayValue.Length > 50 Then
                    displayValue = displayValue.Substring(0, 50) + "..."
                End If
                
                sessionInfo.AppendLine("<tr>")
                sessionInfo.AppendLine($"<td><code>{key}</code></td>")
                sessionInfo.AppendLine($"<td><small>{valueType}</small></td>")
                sessionInfo.AppendLine($"<td>{HttpUtility.HtmlEncode(displayValue)}</td>")
                sessionInfo.AppendLine("</tr>")
            Next
            
            sessionInfo.AppendLine("</tbody></table>")
            sessionInfo.AppendLine("</div>")
            
            lblSessionInfo.Text = sessionInfo.ToString()
            
        Catch ex As Exception
            lblSessionInfo.Text = $"<p class='text-danger'>エラー: {ex.Message}</p>"
        End Try
    End Sub

    Private Sub ShowMessage(message As String, type As String)
        Dim script As String = $"
            setTimeout(function() {{
                var alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-{type} alert-dismissible fade show';
                alertDiv.innerHTML = '{HttpUtility.JavaScriptStringEncode(message)}<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>';
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
                setTimeout(function() {{ alertDiv.remove(); }}, 5000);
            }}, 100);"
        
        ClientScript.RegisterStartupScript(Me.GetType(), "ShowMessage", script, True)
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>セキュアなセッション管理システムが実装され、セッション固定攻撃やハイジャック攻撃への対策が適切に動作します。</p>
                    </div>

                    <h3 class="section-title">6.3 Cookieの実装とセキュリティ</h3>
                    <p>Cookieは永続的なクライアントサイド状態管理の手法です。適切なセキュリティ設定が重要です。</p>

                    <h4>Cookieのセキュリティ属性</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>属性</th>
                                <th>説明</th>
                                <th>セキュリティ効果</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>HttpOnly</td>
                                <td>JavaScript からのアクセスを禁止</td>
                                <td>XSS攻撃対策</td>
                            </tr>
                            <tr>
                                <td>Secure</td>
                                <td>HTTPS接続でのみ送信</td>
                                <td>盗聴対策</td>
                            </tr>
                            <tr>
                                <td>SameSite</td>
                                <td>CSRF攻撃を軽減</td>
                                <td>CSRF攻撃対策</td>
                            </tr>
                            <tr>
                                <td>Domain</td>
                                <td>Cookieの送信先ドメインを制限</td>
                                <td>スコープ制限</td>
                            </tr>
                            <tr>
                                <td>Path</td>
                                <td>特定のパスでのみ有効</td>
                                <td>スコープ制限</td>
                            </tr>
                            <tr>
                                <td>Expires/Max-Age</td>
                                <td>有効期限の設定</td>
                                <td>データ保持期間制御</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>HTTP無状態プロトコルの問題を3つ挙げ、ASP.NETでの解決方法を説明してください。</li>
                            <li>SessionとViewStateの使い分けの基準を説明してください。</li>
                            <li>Cookieのセキュリティ設定で重要な属性を3つ挙げ、その効果を説明してください。</li>
                            <li>Application状態を使用する適切な場面と注意点を説明してください。</li>
                            <li>セッション固定攻撃とは何か、その対策方法を説明してください。</li>
                            <li>大量のデータを状態管理する場合の最適な手法と理由を説明してください。</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>1)ユーザー識別不可→Session、2)フォーム値消失→ViewState、3)設定保持不可→Cookie</li>
                                <li>Session: ユーザー固有データ、複数ページ間。ViewState: ページ内コントロール状態、単一ページ</li>
                                <li>HttpOnly(XSS対策)、Secure(盗聴対策)、SameSite(CSRF対策)</li>
                                <li>適切: グローバル設定、キャッシュ。注意: メモリ消費、スケーラビリティ、排他制御</li>
                                <li>攻撃者が既知セッションIDを強制する攻撃。対策: ログイン時のセッションID再生成</li>
                                <li>データベース使用。理由: メモリ効率、永続性、スケーラビリティ、セキュリティ</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-5.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-7.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>