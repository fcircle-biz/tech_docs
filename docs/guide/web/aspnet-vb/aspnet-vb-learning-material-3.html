<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET(VB.NET)学習教材 第3章 - Web Forms基本</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #1976d2;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #1976d2;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #42a5f5;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #1976d2;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #1976d2 !important;
            color: white !important;
        }

        /* プリフォーマット */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ASP.NET(VB.NET)学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../README.md">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.md">ASP.NET VBガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: ASP.NET基礎とセットアップ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: VB.NET言語基礎復習</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter3">第3章: Web Forms基本</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">第4章: サーバーコントロールとイベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">第5章: データベース連携（ADO.NET）</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">第6章: セッション管理と状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">第7章: 認証とセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: エラーハンドリングとデバッグ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第3章: Web Forms基本</h1>
                </div>

                <div id="chapter3">
                    <h2 class="chapter-title">Web Formsページの構造と基本概念</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Web Formsページの基本構造と仕組み</li>
                            <li>.aspxファイルと.aspx.vbファイルの分離コードアーキテクチャ</li>
                            <li>ASP.NETページライフサイクルの詳細</li>
                            <li>基本的なHTMLコントロールの使用方法</li>
                            <li>サーバーコントロールとHTMLコントロールの違い</li>
                            <li>ポストバックの仕組みとViewStateの理解</li>
                            <li>マスターページとコンテンツページの概念</li>
                        </ul>
                    </div>

                    <h3 class="section-title">3.1 Web Formsページの基本構造</h3>
                    <p>ASP.NET Web Formsページは、デザイン部分（.aspx）とコードビハインド（.aspx.vb）に分離されたアーキテクチャを採用しています。</p>
                    
                    <h4>ページファイルの構成</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ファイル</th>
                                <th>拡張子</th>
                                <th>役割</th>
                                <th>内容</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ASPXファイル</td>
                                <td>.aspx</td>
                                <td>デザイン・マークアップ</td>
                                <td>HTML、サーバーコントロール</td>
                            </tr>
                            <tr>
                                <td>コードビハインド</td>
                                <td>.aspx.vb</td>
                                <td>サーバーサイドロジック</td>
                                <td>VB.NETコード、イベント処理</td>
                            </tr>
                            <tr>
                                <td>デザイナーファイル</td>
                                <td>.aspx.designer.vb</td>
                                <td>コントロール定義</td>
                                <td>自動生成されるコントロール宣言</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 3-1: 基本的なWeb Formsページの作成</h5>
                        <p>分離コードアーキテクチャを理解するため、シンプルな顧客登録フォームを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいWebフォーム「CustomerRegistration.aspx」を作成</li>
                            <li>HTMLとサーバーコントロールを配置</li>
                            <li>コードビハインドでイベント処理を実装</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>CustomerRegistration.aspx</strong></p>
                        <pre><code>&lt;%@ Page Language="VB" AutoEventWireup="false" CodeBehind="CustomerRegistration.aspx.vb" 
    Inherits="WebApplication1.CustomerRegistration" %&gt;

&lt;!DOCTYPE html&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
&lt;head runat="server"&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;
    &lt;title&gt;顧客登録&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" /&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id="form1" runat="server"&gt;
        &lt;div class="container mt-4"&gt;
            &lt;div class="row justify-content-center"&gt;
                &lt;div class="col-md-6"&gt;
                    &lt;h2 class="mb-4"&gt;顧客登録フォーム&lt;/h2&gt;
                    
                    &lt;!-- サーバーコントロール --&gt;
                    &lt;div class="mb-3"&gt;
                        &lt;asp:Label ID="lblName" runat="server" Text="お名前:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                        &lt;asp:TextBox ID="txtName" runat="server" CssClass="form-control" placeholder="山田太郎"&gt;&lt;/asp:TextBox&gt;
                        &lt;asp:RequiredFieldValidator ID="rfvName" runat="server" 
                            ControlToValidate="txtName" ErrorMessage="お名前は必須です" 
                            CssClass="text-danger" Display="Dynamic"&gt;&lt;/asp:RequiredFieldValidator&gt;
                    &lt;/div&gt;

                    &lt;div class="mb-3"&gt;
                        &lt;asp:Label ID="lblEmail" runat="server" Text="メールアドレス:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                        &lt;asp:TextBox ID="txtEmail" runat="server" CssClass="form-control" 
                            TextMode="Email" placeholder="yamada@example.com"&gt;&lt;/asp:TextBox&gt;
                        &lt;asp:RequiredFieldValidator ID="rfvEmail" runat="server" 
                            ControlToValidate="txtEmail" ErrorMessage="メールアドレスは必須です" 
                            CssClass="text-danger" Display="Dynamic"&gt;&lt;/asp:RequiredFieldValidator&gt;
                        &lt;asp:RegularExpressionValidator ID="revEmail" runat="server" 
                            ControlToValidate="txtEmail" ErrorMessage="有効なメールアドレスを入力してください"
                            ValidationExpression="\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"
                            CssClass="text-danger" Display="Dynamic"&gt;&lt;/asp:RegularExpressionValidator&gt;
                    &lt;/div&gt;

                    &lt;div class="mb-3"&gt;
                        &lt;asp:Label ID="lblAge" runat="server" Text="年齢:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                        &lt;asp:TextBox ID="txtAge" runat="server" CssClass="form-control" TextMode="Number"&gt;&lt;/asp:TextBox&gt;
                        &lt;asp:RangeValidator ID="rvAge" runat="server" 
                            ControlToValidate="txtAge" ErrorMessage="年齢は18歳から100歳の間で入力してください"
                            MinimumValue="18" MaximumValue="100" Type="Integer"
                            CssClass="text-danger" Display="Dynamic"&gt;&lt;/asp:RangeValidator&gt;
                    &lt;/div&gt;

                    &lt;div class="mb-3"&gt;
                        &lt;asp:Label ID="lblGender" runat="server" Text="性別:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                        &lt;asp:RadioButtonList ID="rblGender" runat="server" RepeatDirection="Horizontal" CssClass="form-check"&gt;
                            &lt;asp:ListItem Value="Male" Text="男性"&gt;&lt;/asp:ListItem&gt;
                            &lt;asp:ListItem Value="Female" Text="女性"&gt;&lt;/asp:ListItem&gt;
                            &lt;asp:ListItem Value="Other" Text="その他"&gt;&lt;/asp:ListItem&gt;
                        &lt;/asp:RadioButtonList&gt;
                    &lt;/div&gt;

                    &lt;div class="mb-3"&gt;
                        &lt;asp:Label ID="lblInterests" runat="server" Text="興味のある分野:" CssClass="form-label"&gt;&lt;/asp:Label&gt;
                        &lt;asp:CheckBoxList ID="cblInterests" runat="server"&gt;
                            &lt;asp:ListItem Value="Technology" Text="テクノロジー"&gt;&lt;/asp:ListItem&gt;
                            &lt;asp:ListItem Value="Sports" Text="スポーツ"&gt;&lt;/asp:ListItem&gt;
                            &lt;asp:ListItem Value="Music" Text="音楽"&gt;&lt;/asp:ListItem&gt;
                            &lt;asp:ListItem Value="Travel" Text="旅行"&gt;&lt;/asp:ListItem&gt;
                            &lt;asp:ListItem Value="Food" Text="グルメ"&gt;&lt;/asp:ListItem&gt;
                        &lt;/asp:CheckBoxList&gt;
                    &lt;/div&gt;

                    &lt;div class="mb-3"&gt;
                        &lt;asp:Button ID="btnRegister" runat="server" Text="登録" CssClass="btn btn-primary me-2" /&gt;
                        &lt;asp:Button ID="btnClear" runat="server" Text="クリア" CssClass="btn btn-secondary" 
                            CausesValidation="False" /&gt;
                    &lt;/div&gt;

                    &lt;asp:Panel ID="pnlResult" runat="server" Visible="False" CssClass="alert alert-success"&gt;
                        &lt;h5&gt;登録情報&lt;/h5&gt;
                        &lt;asp:Label ID="lblResult" runat="server"&gt;&lt;/asp:Label&gt;
                    &lt;/asp:Panel&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <p><strong>CustomerRegistration.aspx.vb</strong></p>
                        <pre><code>Public Class CustomerRegistration
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        If Not IsPostBack Then
            ' 初回読み込み時の処理
            Page.Title = "顧客登録 - " & DateTime.Now.ToString("yyyy/MM/dd")
            
            ' デフォルト値の設定
            txtAge.Text = "25"
            rblGender.SelectedIndex = 0
        End If
    End Sub

    Protected Sub btnRegister_Click(sender As Object, e As EventArgs) Handles btnRegister.Click
        If Page.IsValid Then
            ' 入力データの取得
            Dim customerName As String = txtName.Text.Trim()
            Dim email As String = txtEmail.Text.Trim()
            Dim age As Integer = Integer.Parse(txtAge.Text)
            Dim gender As String = rblGender.SelectedValue
            
            ' 選択された興味分野の取得
            Dim interests As New List(Of String)()
            For Each item As ListItem In cblInterests.Items
                If item.Selected Then
                    interests.Add(item.Text)
                End If
            Next

            ' 登録処理（実際の実装ではデータベースに保存）
            Dim result As String = ProcessRegistration(customerName, email, age, gender, interests)
            
            ' 結果の表示
            lblResult.Text = result
            pnlResult.Visible = True
            
            ' フォームのクリア
            ClearForm()
        End If
    End Sub

    Protected Sub btnClear_Click(sender As Object, e As EventArgs) Handles btnClear.Click
        ClearForm()
        pnlResult.Visible = False
    End Sub

    Private Function ProcessRegistration(name As String, email As String, age As Integer, 
                                       gender As String, interests As List(Of String)) As String
        ' 実際の登録処理をシミュレート
        Dim result As New System.Text.StringBuilder()
        
        result.AppendLine("以下の内容で登録いたしました：<br/>")
        result.AppendLine($"<strong>お名前:</strong> {Server.HtmlEncode(name)}<br/>")
        result.AppendLine($"<strong>メールアドレス:</strong> {Server.HtmlEncode(email)}<br/>")
        result.AppendLine($"<strong>年齢:</strong> {age}歳<br/>")
        
        Dim genderText As String = ""
        Select Case gender
            Case "Male"
                genderText = "男性"
            Case "Female"
                genderText = "女性"
            Case "Other"
                genderText = "その他"
        End Select
        result.AppendLine($"<strong>性別:</strong> {genderText}<br/>")
        
        If interests.Count > 0 Then
            result.AppendLine($"<strong>興味分野:</strong> {String.Join(", ", interests)}<br/>")
        Else
            result.AppendLine("<strong>興味分野:</strong> 未選択<br/>")
        End If
        
        result.AppendLine($"<strong>登録日時:</strong> {DateTime.Now:yyyy年MM月dd日 HH:mm:ss}")
        
        Return result.ToString()
    End Function

    Private Sub ClearForm()
        txtName.Text = ""
        txtEmail.Text = ""
        txtAge.Text = ""
        rblGender.ClearSelection()
        cblInterests.ClearSelection()
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>顧客登録フォームが正常に動作し、バリデーション機能付きの入力フォームとして機能します。</p>
                    </div>

                    <h3 class="section-title">3.2 ASP.NETページライフサイクルの詳細</h3>
                    <p>ASP.NETページの処理フローを詳しく理解し、各段階での適切な処理を学習します。</p>

                    <h4>詳細なページライフサイクル</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>段階</th>
                                <th>イベント</th>
                                <th>説明</th>
                                <th>主な用途</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>初期化</td>
                                <td>Page_PreInit</td>
                                <td>テーマ、マスターページの設定前</td>
                                <td>動的なマスターページ選択</td>
                            </tr>
                            <tr>
                                <td>初期化</td>
                                <td>Page_Init</td>
                                <td>コントロールの初期化</td>
                                <td>動的コントロールの作成</td>
                            </tr>
                            <tr>
                                <td>初期化完了</td>
                                <td>Page_InitComplete</td>
                                <td>ViewStateの復元前</td>
                                <td>コントロール初期化後の処理</td>
                            </tr>
                            <tr>
                                <td>読み込み</td>
                                <td>Page_PreLoad</td>
                                <td>Page_Load前の処理</td>
                                <td>共通前処理</td>
                            </tr>
                            <tr>
                                <td>読み込み</td>
                                <td>Page_Load</td>
                                <td>メインの読み込み処理</td>
                                <td>データ取得、表示設定</td>
                            </tr>
                            <tr>
                                <td>コントロールイベント</td>
                                <td>Control Events</td>
                                <td>ユーザーアクション処理</td>
                                <td>ボタンクリック等の処理</td>
                            </tr>
                            <tr>
                                <td>読み込み完了</td>
                                <td>Page_LoadComplete</td>
                                <td>すべての読み込み完了後</td>
                                <td>最終的なデータ処理</td>
                            </tr>
                            <tr>
                                <td>レンダリング前</td>
                                <td>Page_PreRender</td>
                                <td>HTML出力直前</td>
                                <td>最終的な表示調整</td>
                            </tr>
                            <tr>
                                <td>状態保存</td>
                                <td>Page_SaveStateComplete</td>
                                <td>ViewState保存完了後</td>
                                <td>状態保存後の処理</td>
                            </tr>
                            <tr>
                                <td>レンダリング</td>
                                <td>Page_Render</td>
                                <td>HTML出力</td>
                                <td>カスタムHTML出力</td>
                            </tr>
                            <tr>
                                <td>アンロード</td>
                                <td>Page_Unload</td>
                                <td>ページ処理完了</td>
                                <td>リソース解放</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 3-2: ページライフサイクルの詳細観察</h5>
                        <p>各ライフサイクルイベントの実行順序と内容を詳細に確認します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいWebフォーム「LifecycleDetails.aspx」を作成</li>
                            <li>すべてのライフサイクルイベントにログ処理を追加</li>
                            <li>動的コントロールとイベント処理を実装</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>LifecycleDetails.aspx.vb</strong></p>
                        <pre><code>Public Class LifecycleDetails
    Inherits System.Web.UI.Page

    Private Sub LogEvent(eventName As String, Optional details As String = "")
        Dim timestamp As String = DateTime.Now.ToString("HH:mm:ss.fff")
        Dim logEntry As String = $"{timestamp} - {eventName}"
        
        If Not String.IsNullOrEmpty(details) Then
            logEntry += $" ({details})"
        End If
        
        ' ログをhiddenフィールドに蓄積（Sessionでも可）
        If ViewState("LogEntries") Is Nothing Then
            ViewState("LogEntries") = New List(Of String)()
        End If
        
        Dim logEntries As List(Of String) = CType(ViewState("LogEntries"), List(Of String))
        logEntries.Add(logEntry)
        ViewState("LogEntries") = logEntries
    End Sub

    Protected Sub Page_PreInit(sender As Object, e As EventArgs) Handles Me.PreInit
        LogEvent("Page_PreInit", "IsPostBack: " & IsPostBack.ToString())
        
        ' 動的マスターページの選択例
        If Request.QueryString("theme") = "mobile" Then
            ' MasterPageFile = "~/Mobile.Master"
        End If
    End Sub

    Protected Sub Page_Init(sender As Object, e As EventArgs) Handles Me.Init
        LogEvent("Page_Init", "Controls Count: " & Controls.Count.ToString())
        
        ' 動的コントロールの作成
        CreateDynamicControls()
    End Sub

    Protected Sub Page_InitComplete(sender As Object, e As EventArgs) Handles Me.InitComplete
        LogEvent("Page_InitComplete", "ViewState: " & If(EnableViewState, "Enabled", "Disabled"))
    End Sub

    Protected Sub Page_PreLoad(sender As Object, e As EventArgs) Handles Me.PreLoad
        LogEvent("Page_PreLoad", "Request Method: " & Request.HttpMethod)
    End Sub

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        LogEvent("Page_Load", "IsPostBack: " & IsPostBack.ToString())
        
        If Not IsPostBack Then
            LogEvent("Page_Load", "First Load - Initializing data")
            LoadInitialData()
        Else
            LogEvent("Page_Load", "PostBack - Restoring state")
        End If
        
        DisplayLog()
    End Sub

    Protected Sub Page_LoadComplete(sender As Object, e As EventArgs) Handles Me.LoadComplete
        LogEvent("Page_LoadComplete", "All controls loaded")
    End Sub

    Protected Sub Page_PreRender(sender As Object, e As EventArgs) Handles Me.PreRender
        LogEvent("Page_PreRender", "About to render HTML")
        
        ' 最終的な表示調整
        AdjustControlsForRender()
    End Sub

    Protected Sub Page_PreRenderComplete(sender As Object, e As EventArgs) Handles Me.PreRenderComplete
        LogEvent("Page_PreRenderComplete", "PreRender phase complete")
    End Sub

    Protected Sub Page_SaveStateComplete(sender As Object, e As EventArgs) Handles Me.SaveStateComplete
        LogEvent("Page_SaveStateComplete", "ViewState saved")
    End Sub

    Protected Sub Page_Unload(sender As Object, e As EventArgs) Handles Me.Unload
        ' Unloadでは画面に出力できないため、デバッグ出力のみ
        System.Diagnostics.Debug.WriteLine("Page_Unload: " & DateTime.Now.ToString("HH:mm:ss.fff"))
    End Sub

    Private Sub CreateDynamicControls()
        ' 動的にボタンを作成
        Dim dynamicButton As New Button()
        dynamicButton.ID = "btnDynamic"
        dynamicButton.Text = "動的ボタン"
        dynamicButton.CssClass = "btn btn-info"
        AddHandler dynamicButton.Click, AddressOf DynamicButton_Click
        
        ' プレースホルダーに追加
        If plhDynamic IsNot Nothing Then
            plhDynamic.Controls.Add(dynamicButton)
            LogEvent("CreateDynamicControls", "Dynamic button created with ID: " & dynamicButton.ID)
        End If
    End Sub

    Private Sub LoadInitialData()
        ' 初期データの読み込みをシミュレート
        System.Threading.Thread.Sleep(50) ' 処理時間をシミュレート
        lblServerTime.Text = "サーバー時刻: " & DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss")
    End Sub

    Private Sub AdjustControlsForRender()
        ' レンダリング前の最終調整
        If IsPostBack Then
            lblPostbackCount.Text = "ポストバック回数: " & (CInt(ViewState("PostbackCount")) + 1).ToString()
            ViewState("PostbackCount") = CInt(ViewState("PostbackCount")) + 1
        Else
            lblPostbackCount.Text = "ポストバック回数: 0"
            ViewState("PostbackCount") = 0
        End If
    End Sub

    Protected Sub btnTest_Click(sender As Object, e As EventArgs) Handles btnTest.Click
        LogEvent("btnTest_Click", "Regular button clicked")
        lblMessage.Text = "通常ボタンがクリックされました: " & DateTime.Now.ToString("HH:mm:ss")
    End Sub

    Protected Sub DynamicButton_Click(sender As Object, e As EventArgs)
        LogEvent("DynamicButton_Click", "Dynamic button clicked")
        lblMessage.Text = "動的ボタンがクリックされました: " & DateTime.Now.ToString("HH:mm:ss")
    End Sub

    Private Sub DisplayLog()
        If ViewState("LogEntries") IsNot Nothing Then
            Dim logEntries As List(Of String) = CType(ViewState("LogEntries"), List(Of String))
            lblLog.Text = String.Join("<br/>", logEntries)
        End If
    End Sub

    Protected Sub btnClearLog_Click(sender As Object, e As EventArgs) Handles btnClearLog.Click
        ViewState("LogEntries") = New List(Of String)()
        lblLog.Text = ""
        lblMessage.Text = ""
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>各ライフサイクルイベントの実行順序が時系列で表示され、ポストバック時とそうでない時の違いが明確に分かります。</p>
                    </div>

                    <h3 class="section-title">3.3 ViewStateとポストバックの仕組み</h3>
                    <p>ASP.NET Web Formsの状態管理の中核であるViewStateとポストバック機能について詳しく学習します。</p>

                    <h4>ViewStateの役割</h4>
                    <ul>
                        <li><strong>状態保持</strong>: HTTP無状態プロトコルでのサーバーコントロールの状態維持</li>
                        <li><strong>自動処理</strong>: コントロールのプロパティ値を自動的に保持・復元</li>
                        <li><strong>セキュリティ</strong>: MACハッシュによる改竄検知</li>
                        <li><strong>パフォーマンス影響</strong>: ページサイズの増加要因</li>
                    </ul>

                    <div class="warning">
                        <h6>ViewState使用時の注意点</h6>
                        <ul>
                            <li>大量のデータを保持するとページサイズが肥大化</li>
                            <li>必要に応じてEnableViewState="False"を設定</li>
                            <li>機密情報は保存しない（暗号化されていない）</li>
                            <li>ロードバランサー環境では適切な設定が必要</li>
                        </ul>
                    </div>

                    <!-- 実習3 -->
                    <div class="exercise-container">
                        <h5>実習 3-3: ViewStateとポストバックの詳細分析</h5>
                        <p>ViewStateの動作を詳しく分析し、パフォーマンスへの影響を確認します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>ViewStateの内容を表示する機能を実装</li>
                            <li>ViewState有効/無効の比較</li>
                            <li>ポストバックデータの分析</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>ViewStateAnalysis.aspx.vb</strong></p>
                        <pre><code>Public Class ViewStateAnalysis
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        If Not IsPostBack Then
            InitializeData()
        End If
        
        AnalyzeViewState()
        DisplayPostBackData()
    End Sub

    Private Sub InitializeData()
        ' データリストに大量のデータを設定
        Dim data As New List(Of String)()
        For i As Integer = 1 To 100
            data.Add($"アイテム {i:000} - データ内容 {DateTime.Now.Millisecond}")
        Next
        
        lstData.DataSource = data
        lstData.DataBind()
        
        ' テキストボックスに初期値設定
        txtSample.Text = "初期値: " & DateTime.Now.ToString("HH:mm:ss")
        
        ' ドロップダウンリストの設定
        ddlOptions.Items.Add(New ListItem("オプション1", "1"))
        ddlOptions.Items.Add(New ListItem("オプション2", "2"))
        ddlOptions.Items.Add(New ListItem("オプション3", "3"))
    End Sub

    Private Sub AnalyzeViewState()
        ' ViewStateのサイズを分析
        If Page.ViewState IsNot Nothing Then
            Dim viewStateString As String = ""
            
            Try
                ' ViewStateの内容を取得（実際の実装では System.Web.UI.LosFormatter を使用）
                Dim formatter As New System.Web.UI.LosFormatter()
                Dim writer As New System.IO.StringWriter()
                formatter.Serialize(writer, Page.ViewState)
                viewStateString = writer.ToString()
            Catch ex As Exception
                viewStateString = "ViewState取得エラー: " & ex.Message
            End Try
            
            lblViewStateSize.Text = $"ViewStateサイズ: {viewStateString.Length:N0} 文字"
            
            ' ViewStateの大まかな内容を表示（セキュリティ上、実際の値は表示しない）
            lblViewStateInfo.Text = "ViewState構成要素数: " & GetViewStateElementCount().ToString()
        Else
            lblViewStateSize.Text = "ViewState: 無効"
            lblViewStateInfo.Text = "ViewState分析不可"
        End If
    End Sub

    Private Function GetViewStateElementCount() As Integer
        ' ViewState内のコントロール数を推定
        Dim count As Integer = 0
        CountControlsRecursive(Page, count)
        Return count
    End Function

    Private Sub CountControlsRecursive(parent As Control, ByRef count As Integer)
        For Each ctrl As Control In parent.Controls
            If ctrl.EnableViewState Then
                count += 1
            End If
            If ctrl.HasControls() Then
                CountControlsRecursive(ctrl, count)
            End If
        Next
    End Sub

    Private Sub DisplayPostBackData()
        If IsPostBack Then
            ' ポストバックデータの分析
            lblPostBackInfo.Text = "ポストバック情報:<br/>" &
                $"• 発生時刻: {DateTime.Now:HH:mm:ss.fff}<br/>" &
                $"• イベントターゲット: {Request.Form("__EVENTTARGET")}<br/>" &
                $"• イベント引数: {Request.Form("__EVENTARGUMENT")}<br/>" &
                $"• ViewState存在: {If(Request.Form("__VIEWSTATE") IsNot Nothing, "はい", "いいえ")}<br/>" &
                $"• フォームデータ項目数: {Request.Form.Count}"
        Else
            lblPostBackInfo.Text = "初回読み込み（ポストバックなし）"
        End If
    End Sub

    Protected Sub btnAnalyze_Click(sender As Object, e As EventArgs) Handles btnAnalyze.Click
        ' 現在の状態を分析
        Dim analysis As New System.Text.StringBuilder()
        analysis.AppendLine("コントロール状態分析:<br/>")
        analysis.AppendLine($"• テキストボックス値: {Server.HtmlEncode(txtSample.Text)}<br/>")
        analysis.AppendLine($"• 選択されたオプション: {ddlOptions.SelectedValue} ({ddlOptions.SelectedItem?.Text})<br/>")
        analysis.AppendLine($"• リストアイテム数: {lstData.Items.Count}<br/>")
        analysis.AppendLine($"• ページロード回数: {GetPageLoadCount()}<br/>")
        
        lblAnalysisResult.Text = analysis.ToString()
    End Sub

    Private Function GetPageLoadCount() As Integer
        If ViewState("LoadCount") Is Nothing Then
            ViewState("LoadCount") = 1
        Else
            ViewState("LoadCount") = CInt(ViewState("LoadCount")) + 1
        End If
        Return CInt(ViewState("LoadCount"))
    End Function

    Protected Sub btnToggleViewState_Click(sender As Object, e As EventArgs) Handles btnToggleViewState.Click
        ' ViewStateを動的に切り替え（注意：一部制限あり）
        EnableViewState = Not EnableViewState
        lblViewStateStatus.Text = $"ViewState: {If(EnableViewState, "有効", "無効")}"
        
        ' 子コントロールのViewStateも切り替え
        SetViewStateRecursive(Page, EnableViewState)
    End Sub

    Private Sub SetViewStateRecursive(parent As Control, enabled As Boolean)
        For Each ctrl As Control In parent.Controls
            ctrl.EnableViewState = enabled
            If ctrl.HasControls() Then
                SetViewStateRecursive(ctrl, enabled)
            End If
        Next
    End Sub

    Protected Sub btnAddData_Click(sender As Object, e As EventArgs) Handles btnAddData.Click
        ' 動的にリストアイテムを追加
        Dim newItem As String = $"追加アイテム {DateTime.Now:HH:mm:ss.fff}"
        lstData.Items.Add(newItem)
        
        lblMessage.Text = $"アイテムを追加しました: {newItem}"
    End Sub

    Protected Sub btnClearData_Click(sender As Object, e As EventArgs) Handles btnClearData.Click
        lstData.Items.Clear()
        txtSample.Text = ""
        ddlOptions.ClearSelection()
        lblMessage.Text = "データをクリアしました"
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>ViewStateのサイズと内容が可視化され、ポストバック時のデータ転送量とパフォーマンスへの影響を理解できます。</p>
                    </div>

                    <h3 class="section-title">3.4 マスターページとコンテンツページ</h3>
                    <p>Webサイト全体の統一されたレイアウトを提供するマスターページの概念と実装方法を学習します。</p>

                    <h4>マスターページの利点</h4>
                    <ul>
                        <li><strong>レイアウト統一</strong>: サイト全体の一貫したデザイン</li>
                        <li><strong>メンテナンス性</strong>: 共通部分の一元管理</li>
                        <li><strong>開発効率</strong>: ページ固有の内容に集中可能</li>
                        <li><strong>拡張性</strong>: ネストしたマスターページも可能</li>
                    </ul>

                    <!-- 実習4 -->
                    <div class="exercise-container">
                        <h5>実習 3-4: マスターページとコンテンツページの作成</h5>
                        <p>企業サイト風のマスターページとそれを使用するコンテンツページを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>マスターページ「Site.Master」を作成</li>
                            <li>コンテンツページでマスターページを使用</li>
                            <li>マスターページとコンテンツページ間の通信を実装</li>
                        </ol>
                        <h6>実行例</h6>
                        <p><strong>Site.Master</strong></p>
                        <pre><code>&lt;%@ Master Language="VB" AutoEventWireup="false" CodeBehind="Site.master.vb" Inherits="WebApplication1.SiteMaster" %&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head runat="server"&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;
    &lt;title&gt;&lt;%: Page.Title %&gt; - マイ企業サイト&lt;/title&gt;
    
    &lt;asp:PlaceHolder runat="server"&gt;
        &lt;%: Scripts.Render("~/bundles/modernizr") %&gt;
    &lt;/asp:PlaceHolder&gt;
    &lt;webopt:bundleReference runat="server" path="~/Content/css" /&gt;
    &lt;link href="~/favicon.ico" rel="shortcut icon" type="image/x-icon" /&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" /&gt;
    
    &lt;asp:ContentPlaceHolder ID="HeadContent" runat="server"&gt;
    &lt;/asp:ContentPlaceHolder&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;form runat="server"&gt;
        &lt;asp:ScriptManager runat="server"&gt;
            &lt;Scripts&gt;
                &lt;asp:ScriptReference Name="MsAjaxBundle" /&gt;
                &lt;asp:ScriptReference Name="jquery" /&gt;
                &lt;asp:ScriptReference Name="bootstrap" /&gt;
                &lt;asp:ScriptReference Name="respond" /&gt;
                &lt;asp:ScriptReference Name="WebForms.js" Assembly="System.Web" Path="~/Scripts/WebForms/WebForms.js" /&gt;
                &lt;asp:ScriptReference Name="WebUIValidation.js" Assembly="System.Web" Path="~/Scripts/WebForms/WebUIValidation.js" /&gt;
            &lt;/Scripts&gt;
        &lt;/asp:ScriptManager&gt;

        &lt;!-- ヘッダー --&gt;
        &lt;header class="navbar navbar-expand-lg navbar-dark bg-primary"&gt;
            &lt;div class="container"&gt;
                &lt;a class="navbar-brand" href="~/"&gt;
                    &lt;asp:Label ID="lblSiteName" runat="server" Text="マイ企業サイト"&gt;&lt;/asp:Label&gt;
                &lt;/a&gt;
                
                &lt;button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"&gt;
                    &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;
                &lt;/button&gt;
                
                &lt;div class="collapse navbar-collapse" id="navbarNav"&gt;
                    &lt;ul class="navbar-nav me-auto"&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;a class="nav-link" href="~/Default.aspx"&gt;ホーム&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;a class="nav-link" href="~/About.aspx"&gt;会社概要&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;a class="nav-link" href="~/Products.aspx"&gt;製品情報&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;a class="nav-link" href="~/Contact.aspx"&gt;お問い合わせ&lt;/a&gt;
                        &lt;/li&gt;
                    &lt;/ul&gt;
                    
                    &lt;ul class="navbar-nav"&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;asp:Label ID="lblCurrentUser" runat="server" CssClass="navbar-text"&gt;&lt;/asp:Label&gt;
                        &lt;/li&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;asp:Label ID="lblCurrentTime" runat="server" CssClass="navbar-text small"&gt;&lt;/asp:Label&gt;
                        &lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/header&gt;

        &lt;!-- パンくずリスト --&gt;
        &lt;nav aria-label="breadcrumb" class="bg-light py-2"&gt;
            &lt;div class="container"&gt;
                &lt;asp:SiteMapPath ID="SiteMapPath1" runat="server" CssClass="breadcrumb"
                    CurrentNodeStyle-CssClass="breadcrumb-item active"
                    NodeStyle-CssClass="breadcrumb-item"
                    PathSeparator=""&gt;
                &lt;/asp:SiteMapPath&gt;
            &lt;/div&gt;
        &lt;/nav&gt;

        &lt;!-- メインコンテンツ --&gt;
        &lt;main class="container my-4"&gt;
            &lt;asp:ContentPlaceHolder ID="MainContent" runat="server"&gt;
            &lt;/asp:ContentPlaceHolder&gt;
        &lt;/main&gt;

        &lt;!-- サイドバー（オプション） --&gt;
        &lt;aside class="container"&gt;
            &lt;div class="row"&gt;
                &lt;div class="col-md-4"&gt;
                    &lt;asp:ContentPlaceHolder ID="SidebarContent" runat="server"&gt;
                        &lt;div class="card"&gt;
                            &lt;div class="card-header"&gt;
                                &lt;h5&gt;お知らせ&lt;/h5&gt;
                            &lt;/div&gt;
                            &lt;div class="card-body"&gt;
                                &lt;asp:Label ID="lblAnnouncement" runat="server"&gt;&lt;/asp:Label&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/asp:ContentPlaceHolder&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/aside&gt;

        &lt;!-- フッター --&gt;
        &lt;footer class="bg-dark text-light py-4 mt-5"&gt;
            &lt;div class="container"&gt;
                &lt;div class="row"&gt;
                    &lt;div class="col-md-6"&gt;
                        &lt;h5&gt;マイ企業サイト&lt;/h5&gt;
                        &lt;p&gt;〒123-4567 東京都サンプル区テスト町1-2-3&lt;/p&gt;
                        &lt;p&gt;TEL: 03-1234-5678 | FAX: 03-1234-5679&lt;/p&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-6"&gt;
                        &lt;h6&gt;サイトマップ&lt;/h6&gt;
                        &lt;ul class="list-unstyled"&gt;
                            &lt;li&gt;&lt;a href="~/Default.aspx" class="text-light"&gt;ホーム&lt;/a&gt;&lt;/li&gt;
                            &lt;li&gt;&lt;a href="~/About.aspx" class="text-light"&gt;会社概要&lt;/a&gt;&lt;/li&gt;
                            &lt;li&gt;&lt;a href="~/Privacy.aspx" class="text-light"&gt;プライバシーポリシー&lt;/a&gt;&lt;/li&gt;
                        &lt;/ul&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;hr class="my-3"&gt;
                &lt;div class="text-center"&gt;
                    &lt;p&gt;&amp;copy; &lt;%: DateTime.Now.Year %&gt; マイ企業サイト. All rights reserved.&lt;/p&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/footer&gt;
    &lt;/form&gt;
    
    &lt;script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <p><strong>Site.Master.vb</strong></p>
                        <pre><code>Public Class SiteMaster
    Inherits MasterPage

    Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
        ' 現在時刻の表示
        lblCurrentTime.Text = DateTime.Now.ToString("yyyy/MM/dd HH:mm")
        
        ' ユーザー情報の表示（実際の認証システムと連携）
        If Session("UserName") IsNot Nothing Then
            lblCurrentUser.Text = "ようこそ " & Session("UserName").ToString() & " さん"
        Else
            lblCurrentUser.Text = "ゲストユーザー"
        End If
        
        ' お知らせの設定
        SetAnnouncement()
    End Sub

    Private Sub SetAnnouncement()
        ' 実際の実装ではデータベースから取得
        Dim announcements() As String = {
            "システムメンテナンスのお知らせ（月末予定）",
            "新製品の発表について",
            "セキュリティアップデートを実施しました"
        }
        
        Dim random As New Random()
        Dim selectedAnnouncement As String = announcements(random.Next(announcements.Length))
        lblAnnouncement.Text = selectedAnnouncement
    End Sub

    ' コンテンツページから呼び出し可能な公開メソッド
    Public Sub SetPageTitle(title As String)
        Page.Title = title
    End Sub

    Public Sub SetUserInfo(userName As String)
        lblCurrentUser.Text = "ようこそ " & userName & " さん"
        Session("UserName") = userName
    End Sub

    Public Sub ShowMessage(message As String)
        ' JavaScriptアラートでメッセージを表示
        Dim script As String = $"alert('{HttpUtility.JavaScriptStringEncode(message)}');"
        ClientScript.RegisterStartupScript(Me.GetType(), "ShowMessage",script, True)
    End Sub
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>統一されたレイアウトのWebサイトが作成され、マスターページによる効率的なサイト管理が実現されます。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>ASP.NETの分離コードアーキテクチャの利点を3つ挙げてください。</li>
                            <li>Page_InitとPage_Loadイベントの違いと使い分けを説明してください。</li>
                            <li>ViewStateが無効になる問題と対策を説明してください。</li>
                            <li>マスターページのContentPlaceHolderの役割を説明してください。</li>
                            <li>IsPostBackプロパティを使用する理由と使用場面を説明してください。</li>
                            <li>動的コントロールの作成時にPage_Initイベントを使用する理由は何ですか？</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>1)コードの分離によるメンテナンス性向上、2)デザイナーとプログラマーの分業、3)IntelliSenseによる開発効率向上</li>
                                <li>Page_Init: コントロール初期化、動的コントロール作成用。Page_Load: データ取得・表示設定用</li>
                                <li>問題：ページサイズ肥大化、パフォーマンス低下。対策：不要なコントロールでViewState無効化、セッション使用</li>
                                <li>コンテンツページが独自の内容を配置できる領域を定義し、マスターページのレイアウト内に統合</li>
                                <li>初回読み込みとポストバック処理を区別し、不要な処理を回避してパフォーマンスを向上</li>
                                <li>ViewState復元前にコントロールが存在する必要があり、Page_Loadでは遅すぎるため</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-2.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-4.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>