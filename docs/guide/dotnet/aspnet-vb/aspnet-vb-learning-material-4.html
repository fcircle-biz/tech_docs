<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET VB.NET学習教材 第4章 - データ検証とエラーハンドリング</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0078d4;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0078d4;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #2196F3;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0078d4;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0078d4 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        .validation-table {
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../README.md">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">ASP.NET VB.NET学習ガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: Web Forms入門</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: Webコントロール</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">第3章: イベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter4">第4章: データ検証</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">第5章: 状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">第6章: データベース連携</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">第7章: データバインド</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: マスターページ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-9.html">第9章: セキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-10.html">第10章: 実践開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第4章: データ検証とエラーハンドリング</h1>
                </div>

                <div id="chapter4">
                    <h2 class="chapter-title">データ検証とエラーハンドリング</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>ASP.NET検証コントロールの種類と使用方法を習得する</li>
                            <li>クライアントサイドとサーバーサイド検証の違いを理解する</li>
                            <li>カスタム検証の実装方法を学習する</li>
                            <li>Web Formsでの例外処理とエラーハンドリングを実践する</li>
                            <li>ユーザビリティを向上させる検証手法を体験する</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.1 ASP.NET検証コントロール概要</h3>
                    <p>ASP.NET Web Formsには、ユーザー入力の検証を自動化する専用のコントロールが用意されています。</p>

                    <h4>検証コントロールの種類</h4>
                    <div class="table-responsive validation-table">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>検証コントロール</th>
                                    <th>用途</th>
                                    <th>VB.NET コンソールでの類似処理</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>RequiredFieldValidator</code></td>
                                    <td>必須入力チェック</td>
                                    <td><code>If String.IsNullOrEmpty(input)</code></td>
                                </tr>
                                <tr>
                                    <td><code>RangeValidator</code></td>
                                    <td>値の範囲チェック</td>
                                    <td><code>If value >= min AndAlso value <= max</code></td>
                                </tr>
                                <tr>
                                    <td><code>CompareValidator</code></td>
                                    <td>値の比較・データ型チェック</td>
                                    <td><code>If password1 = password2</code></td>
                                </tr>
                                <tr>
                                    <td><code>RegularExpressionValidator</code></td>
                                    <td>正規表現パターンマッチ</td>
                                    <td><code>Regex.IsMatch(input, pattern)</code></td>
                                </tr>
                                <tr>
                                    <td><code>CustomValidator</code></td>
                                    <td>独自の検証ロジック</td>
                                    <td>カスタム検証関数</td>
                                </tr>
                                <tr>
                                    <td><code>ValidationSummary</code></td>
                                    <td>エラーメッセージの一括表示</td>
                                    <td>エラーリストの表示</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 class="section-title">4.2 基本的な検証コントロール</h3>
                    <p>最も一般的な検証コントロールの使用方法を学習しましょう。</p>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 4-1: ユーザー登録フォームの検証システム</h5>
                        <p>様々な検証コントロールを組み合わせた実用的な登録フォームを作成します。</p>

                        <h6>UserValidation.aspx（マークアップ）</h6>
                        <pre><code>&lt;%@ Page Title="ユーザー登録（検証付き）" Language="VB" MasterPageFile="~/Site.Master" AutoEventWireup="true" CodeBehind="UserValidation.aspx.vb" Inherits="HelloWorldWebApp.UserValidation" %&gt;

&lt;asp:Content ID="BodyContent" ContentPlaceHolderID="MainContent" runat="server"&gt;
    &lt;div class="container mt-4"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-8"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-danger text-white"&gt;
                        &lt;h3 class="card-title mb-0"&gt;ユーザー登録（入力検証機能付き）&lt;/h3&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;!-- エラーサマリー --&gt;
                        &lt;asp:ValidationSummary ID="ValidationSummary1" runat="server" 
                            CssClass="alert alert-danger" 
                            HeaderText="入力エラーがあります:"
                            DisplayMode="BulletList" /&gt;
                        
                        &lt;div class="row"&gt;
                            &lt;div class="col-md-6"&gt;
                                &lt;!-- ユーザー名（必須） --&gt;
                                &lt;div class="mb-3"&gt;
                                    &lt;asp:Label ID="lblUserName" runat="server" Text="ユーザー名 *:" CssClass="form-label" AssociatedControlID="txtUserName"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:TextBox ID="txtUserName" runat="server" CssClass="form-control" placeholder="3-20文字で入力"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:RequiredFieldValidator ID="rfvUserName" runat="server" 
                                        ControlToValidate="txtUserName"
                                        ErrorMessage="ユーザー名は必須です"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*必須&lt;/asp:RequiredFieldValidator&gt;
                                    &lt;asp:RegularExpressionValidator ID="revUserName" runat="server"
                                        ControlToValidate="txtUserName"
                                        ValidationExpression="^[a-zA-Z0-9_]{3,20}$"
                                        ErrorMessage="ユーザー名は3-20文字の英数字とアンダースコアのみ使用可能です"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*形式が正しくありません&lt;/asp:RegularExpressionValidator&gt;
                                &lt;/div&gt;
                                
                                &lt;!-- メールアドレス（必須・形式チェック） --&gt;
                                &lt;div class="mb-3"&gt;
                                    &lt;asp:Label ID="lblEmail" runat="server" Text="メールアドレス *:" CssClass="form-label" AssociatedControlID="txtEmail"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:TextBox ID="txtEmail" runat="server" CssClass="form-control" TextMode="Email" placeholder="example@domain.com"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:RequiredFieldValidator ID="rfvEmail" runat="server" 
                                        ControlToValidate="txtEmail"
                                        ErrorMessage="メールアドレスは必須です"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*必須&lt;/asp:RequiredFieldValidator&gt;
                                    &lt;asp:RegularExpressionValidator ID="revEmail" runat="server"
                                        ControlToValidate="txtEmail"
                                        ValidationExpression="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                                        ErrorMessage="有効なメールアドレスを入力してください"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*形式が正しくありません&lt;/asp:RegularExpressionValidator&gt;
                                &lt;/div&gt;
                                
                                &lt;!-- 年齢（範囲チェック） --&gt;
                                &lt;div class="mb-3"&gt;
                                    &lt;asp:Label ID="lblAge" runat="server" Text="年齢:" CssClass="form-label" AssociatedControlID="txtAge"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:TextBox ID="txtAge" runat="server" CssClass="form-control" TextMode="Number" placeholder="18-100"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:CompareValidator ID="cvAge" runat="server"
                                        ControlToValidate="txtAge"
                                        Type="Integer"
                                        Operator="DataTypeCheck"
                                        ErrorMessage="年齢は数値で入力してください"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*数値のみ&lt;/asp:CompareValidator&gt;
                                    &lt;asp:RangeValidator ID="rvAge" runat="server"
                                        ControlToValidate="txtAge"
                                        Type="Integer"
                                        MinimumValue="18"
                                        MaximumValue="100"
                                        ErrorMessage="年齢は18歳以上100歳以下で入力してください"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*18-100歳&lt;/asp:RangeValidator&gt;
                                &lt;/div&gt;
                                
                                &lt;!-- 電話番号（正規表現チェック） --&gt;
                                &lt;div class="mb-3"&gt;
                                    &lt;asp:Label ID="lblPhone" runat="server" Text="電話番号:" CssClass="form-label" AssociatedControlID="txtPhone"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:TextBox ID="txtPhone" runat="server" CssClass="form-control" placeholder="090-1234-5678"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:RegularExpressionValidator ID="revPhone" runat="server"
                                        ControlToValidate="txtPhone"
                                        ValidationExpression="^0\d{1,4}-\d{1,4}-\d{4}$"
                                        ErrorMessage="電話番号の形式が正しくありません（例：090-1234-5678）"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*形式が正しくありません&lt;/asp:RegularExpressionValidator&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                            
                            &lt;div class="col-md-6"&gt;
                                &lt;!-- パスワード（必須） --&gt;
                                &lt;div class="mb-3"&gt;
                                    &lt;asp:Label ID="lblPassword" runat="server" Text="パスワード *:" CssClass="form-label" AssociatedControlID="txtPassword"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:TextBox ID="txtPassword" runat="server" CssClass="form-control" TextMode="Password" placeholder="8文字以上"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:RequiredFieldValidator ID="rfvPassword" runat="server" 
                                        ControlToValidate="txtPassword"
                                        ErrorMessage="パスワードは必須です"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*必須&lt;/asp:RequiredFieldValidator&gt;
                                    &lt;asp:RegularExpressionValidator ID="revPassword" runat="server"
                                        ControlToValidate="txtPassword"
                                        ValidationExpression="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$"
                                        ErrorMessage="パスワードは8文字以上で、大文字・小文字・数字を含む必要があります"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*複雑さが不足&lt;/asp:RegularExpressionValidator&gt;
                                &lt;/div&gt;
                                
                                &lt;!-- パスワード確認（比較チェック） --&gt;
                                &lt;div class="mb-3"&gt;
                                    &lt;asp:Label ID="lblPasswordConfirm" runat="server" Text="パスワード確認 *:" CssClass="form-label" AssociatedControlID="txtPasswordConfirm"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:TextBox ID="txtPasswordConfirm" runat="server" CssClass="form-control" TextMode="Password" placeholder="パスワードを再入力"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:RequiredFieldValidator ID="rfvPasswordConfirm" runat="server" 
                                        ControlToValidate="txtPasswordConfirm"
                                        ErrorMessage="パスワード確認は必須です"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*必須&lt;/asp:RequiredFieldValidator&gt;
                                    &lt;asp:CompareValidator ID="cvPasswordConfirm" runat="server"
                                        ControlToValidate="txtPasswordConfirm"
                                        ControlToCompare="txtPassword"
                                        ErrorMessage="パスワードが一致しません"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*パスワードが一致しません&lt;/asp:CompareValidator&gt;
                                &lt;/div&gt;
                                
                                &lt;!-- 誕生日（日付チェック・カスタム検証） --&gt;
                                &lt;div class="mb-3"&gt;
                                    &lt;asp:Label ID="lblBirthDate" runat="server" Text="誕生日:" CssClass="form-label" AssociatedControlID="txtBirthDate"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:TextBox ID="txtBirthDate" runat="server" CssClass="form-control" TextMode="Date"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:CompareValidator ID="cvBirthDate" runat="server"
                                        ControlToValidate="txtBirthDate"
                                        Type="Date"
                                        Operator="DataTypeCheck"
                                        ErrorMessage="正しい日付を入力してください"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*日付形式&lt;/asp:CompareValidator&gt;
                                    &lt;asp:CustomValidator ID="customBirthDate" runat="server"
                                        ControlToValidate="txtBirthDate"
                                        ErrorMessage="誕生日は現在より過去の日付である必要があります"
                                        Display="Dynamic"
                                        CssClass="text-danger"
                                        OnServerValidate="customBirthDate_ServerValidate"&gt;*未来の日付です&lt;/asp:CustomValidator&gt;
                                &lt;/div&gt;
                                
                                &lt;!-- ウェブサイト（URL形式チェック） --&gt;
                                &lt;div class="mb-3"&gt;
                                    &lt;asp:Label ID="lblWebsite" runat="server" Text="ウェブサイト:" CssClass="form-label" AssociatedControlID="txtWebsite"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:TextBox ID="txtWebsite" runat="server" CssClass="form-control" placeholder="https://example.com"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:RegularExpressionValidator ID="revWebsite" runat="server"
                                        ControlToValidate="txtWebsite"
                                        ValidationExpression="^https?://.+"
                                        ErrorMessage="ウェブサイトのURLが正しくありません（http://またはhttps://で始める）"
                                        Display="Dynamic"
                                        CssClass="text-danger"&gt;*URL形式&lt;/asp:RegularExpressionValidator&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- 利用規約同意（カスタム検証） --&gt;
                        &lt;div class="mb-3"&gt;
                            &lt;asp:CheckBox ID="chkAgreeTerms" runat="server" CssClass="form-check-input me-1" /&gt;
                            &lt;asp:Label runat="server" AssociatedControlID="chkAgreeTerms" CssClass="form-check-label"&gt;利用規約に同意します *&lt;/asp:Label&gt;
                            &lt;asp:CustomValidator ID="customAgreeTerms" runat="server"
                                ErrorMessage="利用規約への同意が必要です"
                                Display="Dynamic"
                                CssClass="text-danger d-block"
                                OnServerValidate="customAgreeTerms_ServerValidate"&gt;*利用規約への同意が必要です&lt;/asp:CustomValidator&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- ボタン群 --&gt;
                        &lt;div class="text-center mt-4"&gt;
                            &lt;asp:Button ID="btnRegister" runat="server" Text="登録" CssClass="btn btn-danger btn-lg me-2" /&gt;
                            &lt;asp:Button ID="btnValidateOnly" runat="server" Text="検証のみ" CssClass="btn btn-outline-danger btn-lg me-2" /&gt;
                            &lt;asp:Button ID="btnClear" runat="server" Text="クリア" CssClass="btn btn-secondary btn-lg" CausesValidation="false" /&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- 結果表示 --&gt;
                        &lt;div class="mt-4"&gt;
                            &lt;asp:Label ID="lblResult" runat="server" Text=""&gt;&lt;/asp:Label&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- 登録情報表示 --&gt;
                        &lt;div class="mt-4"&gt;
                            &lt;asp:Panel ID="pnlRegistrationResult" runat="server" Visible="false" CssClass="card"&gt;
                                &lt;div class="card-header bg-success text-white"&gt;
                                    &lt;h5 class="card-title mb-0"&gt;登録完了&lt;/h5&gt;
                                &lt;/div&gt;
                                &lt;div class="card-body"&gt;
                                    &lt;asp:Literal ID="litRegistrationResult" runat="server"&gt;&lt;/asp:Literal&gt;
                                &lt;/div&gt;
                            &lt;/asp:Panel&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/asp:Content&gt;</code></pre>

                        <h6>UserValidation.aspx.vb（コードビハインド）</h6>
                        <pre><code>Public Class UserValidation
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not IsPostBack Then
            txtUserName.Focus()
        End If
    End Sub

    Protected Sub btnRegister_Click(sender As Object, e As EventArgs) Handles btnRegister.Click
        If Page.IsValid Then
            Try
                ProcessRegistration()
            Catch ex As Exception
                HandleException(ex, "登録処理中にエラーが発生しました")
            End Try
        Else
            lblResult.Text = "入力エラーがあります。上記のエラーメッセージを確認してください。"
            lblResult.CssClass = "alert alert-warning"
            pnlRegistrationResult.Visible = False
        End If
    End Sub

    Protected Sub btnValidateOnly_Click(sender As Object, e As EventArgs) Handles btnValidateOnly.Click
        If Page.IsValid Then
            lblResult.Text = "✅ すべての入力項目の検証に成功しました。"
            lblResult.CssClass = "alert alert-success"
        Else
            lblResult.Text = "❌ 入力検証でエラーが見つかりました。"
            lblResult.CssClass = "alert alert-warning"
        End If
        pnlRegistrationResult.Visible = False
    End Sub

    Protected Sub btnClear_Click(sender As Object, e As EventArgs) Handles btnClear.Click
        ClearForm()
        lblResult.Text = "フォームをクリアしました。"
        lblResult.CssClass = "alert alert-info"
        pnlRegistrationResult.Visible = False
    End Sub

    ' カスタム検証: 誕生日チェック
    Protected Sub customBirthDate_ServerValidate(source As Object, args As ServerValidateEventArgs)
        Dim birthDate As DateTime
        If DateTime.TryParse(args.Value, birthDate) Then
            ' 誕生日が現在より未来でないかチェック
            args.IsValid = birthDate <= DateTime.Today
        Else
            args.IsValid = True ' 日付形式チェックは CompareValidator が行う
        End If
    End Sub

    ' カスタム検証: 利用規約同意チェック
    Protected Sub customAgreeTerms_ServerValidate(source As Object, args As ServerValidateEventArgs)
        args.IsValid = chkAgreeTerms.Checked
    End Sub

    Private Sub ProcessRegistration()
        ' 実際のシステムでは、ここでデータベースへの保存処理などを行う
        Dim result As New System.Text.StringBuilder()
        
        result.AppendLine($"<strong>ユーザー名:</strong> {Server.HtmlEncode(txtUserName.Text)}<br/>")
        result.AppendLine($"<strong>メールアドレス:</strong> {Server.HtmlEncode(txtEmail.Text)}<br/>")
        
        If Not String.IsNullOrWhiteSpace(txtAge.Text) Then
            result.AppendLine($"<strong>年齢:</strong> {Server.HtmlEncode(txtAge.Text)}歳<br/>")
        End If
        
        If Not String.IsNullOrWhiteSpace(txtPhone.Text) Then
            result.AppendLine($"<strong>電話番号:</strong> {Server.HtmlEncode(txtPhone.Text)}<br/>")
        End If
        
        If Not String.IsNullOrWhiteSpace(txtBirthDate.Text) Then
            result.AppendLine($"<strong>誕生日:</strong> {Server.HtmlEncode(txtBirthDate.Text)}<br/>")
        End If
        
        If Not String.IsNullOrWhiteSpace(txtWebsite.Text) Then
            result.AppendLine($"<strong>ウェブサイト:</strong> <a href='{Server.HtmlEncode(txtWebsite.Text)}' target='_blank'>{Server.HtmlEncode(txtWebsite.Text)}</a><br/>")
        End If
        
        result.AppendLine($"<strong>登録日時:</strong> {DateTime.Now:yyyy-MM-dd HH:mm:ss}<br/>")
        
        litRegistrationResult.Text = result.ToString()
        pnlRegistrationResult.Visible = True
        
        lblResult.Text = "ユーザー登録が正常に完了しました。"
        lblResult.CssClass = "alert alert-success"
        
        ' パスワードフィールドをクリア（セキュリティ上の理由）
        txtPassword.Text = ""
        txtPasswordConfirm.Text = ""
    End Sub

    Private Sub ClearForm()
        txtUserName.Text = ""
        txtEmail.Text = ""
        txtAge.Text = ""
        txtPhone.Text = ""
        txtPassword.Text = ""
        txtPasswordConfirm.Text = ""
        txtBirthDate.Text = ""
        txtWebsite.Text = ""
        chkAgreeTerms.Checked = False
        txtUserName.Focus()
    End Sub

    Private Sub HandleException(ex As Exception, userMessage As String)
        ' 実際のシステムでは、ログファイルやデータベースにエラー情報を記録
        System.Diagnostics.Debug.WriteLine($"Error: {ex.Message}")
        System.Diagnostics.Debug.WriteLine($"Stack Trace: {ex.StackTrace}")
        
        lblResult.Text = $"{userMessage} システム管理者にお問い合わせください。"
        lblResult.CssClass = "alert alert-danger"
        pnlRegistrationResult.Visible = False
    End Sub
End Class</code></pre>
                    </div>

                    <h3 class="section-title">4.3 クライアントサイドvsサーバーサイド検証</h3>
                    <p>ASP.NET検証コントロールは、クライアントサイドとサーバーサイドの両方で動作します。</p>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>検証タイプ</th>
                                    <th>実行場所</th>
                                    <th>利点</th>
                                    <th>欠点</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>クライアントサイド</strong></td>
                                    <td>ブラウザ（JavaScript）</td>
                                    <td>高速・リアルタイム・サーバー負荷軽減</td>
                                    <td>JavaScript無効時動作しない・改ざん可能</td>
                                </tr>
                                <tr>
                                    <td><strong>サーバーサイド</strong></td>
                                    <td>Webサーバー（VB.NET）</td>
                                    <td>確実・セキュア・JavaScript無効でも動作</td>
                                    <td>PostBack必要・レスポンス時間</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4>検証の無効化</h4>
                    <pre><code>' 特定のボタンで検証を無効化
&lt;asp:Button ID="btnCancelWithoutValidation" 
    runat="server" 
    Text="キャンセル" 
    CausesValidation="false" /&gt;

' コードビハインドで検証状態をチェック
Protected Sub btnSubmit_Click(sender As Object, e As EventArgs)
    If Page.IsValid Then
        ' 検証成功時の処理
        ProcessForm()
    Else
        ' 検証エラー時の処理
        ShowValidationErrors()
    End If
End Sub</code></pre>

                    <h3 class="section-title">4.4 例外処理とエラーハンドリング</h3>
                    <p>Web Formsアプリケーションでの適切な例外処理方法を学習しましょう。</p>

                    <pre><code>' VB.NETで学習した例外処理をWeb Formsで適用
Protected Sub btnProcessData_Click(sender As Object, e As EventArgs)
    Try
        ' 危険な処理（データベースアクセス、ファイル操作等）
        ProcessUserData()
        
        lblResult.Text = "処理が正常に完了しました。"
        lblResult.CssClass = "alert alert-success"
        
    Catch ex As ArgumentException
        ' 引数エラーの場合
        lblResult.Text = $"入力データに問題があります: {ex.Message}"
        lblResult.CssClass = "alert alert-warning"
        
    Catch ex As UnauthorizedAccessException
        ' アクセス権限エラーの場合
        lblResult.Text = "アクセス権限がありません。システム管理者にお問い合わせください。"
        lblResult.CssClass = "alert alert-danger"
        
    Catch ex As System.IO.IOException
        ' ファイルI/Oエラーの場合
        lblResult.Text = "ファイル処理でエラーが発生しました。しばらく待ってから再試行してください。"
        lblResult.CssClass = "alert alert-warning"
        
    Catch ex As Exception
        ' その他のエラー
        LogError(ex) ' エラーログ出力
        lblResult.Text = "予期しないエラーが発生しました。システム管理者にお問い合わせください。"
        lblResult.CssClass = "alert alert-danger"
        
    Finally
        ' クリーンアップ処理
        CleanupResources()
    End Try
End Sub

Private Sub LogError(ex As Exception)
    ' 実際のシステムでは、ログファイルやデータベースに記録
    Dim errorInfo As String = $"Error: {ex.Message}, StackTrace: {ex.StackTrace}, Time: {DateTime.Now}"
    System.Diagnostics.Debug.WriteLine(errorInfo)
    
    ' Application_Errorイベントでグローバルエラーハンドリングも可能
End Sub</code></pre>

                    <h3 class="section-title">4.5 ユーザビリティ向上のための検証技術</h3>
                    <p>ユーザーフレンドリーな検証システムを構築するためのテクニックです。</p>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 4-2: リアルタイム検証システム</h5>
                        <p>JavaScriptと組み合わせたリアルタイム検証を実装します。</p>

                        <h6>JavaScript連携検証の例</h6>
                        <pre><code>' Page_Loadでクライアントサイドスクリプトを登録
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    If Not IsPostBack Then
        RegisterClientScripts()
    End If
End Sub

Private Sub RegisterClientScripts()
    Dim script As String = "
    function showPasswordStrength(password) {
        var strength = 0;
        var strengthText = '';
        var strengthClass = '';
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        switch(strength) {
            case 0:
            case 1:
                strengthText = '弱い';
                strengthClass = 'text-danger';
                break;
            case 2:
            case 3:
                strengthText = '普通';
                strengthClass = 'text-warning';
                break;
            case 4:
            case 5:
                strengthText = '強い';
                strengthClass = 'text-success';
                break;
        }
        
        var strengthIndicator = document.getElementById('passwordStrength');
        if (strengthIndicator) {
            strengthIndicator.innerHTML = '強度: ' + strengthText;
            strengthIndicator.className = strengthClass;
        }
    }
    
    function validateEmailFormat(email) {
        var emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        var isValid = emailPattern.test(email);
        var indicator = document.getElementById('emailValidation');
        
        if (indicator) {
            if (email === '') {
                indicator.innerHTML = '';
            } else if (isValid) {
                indicator.innerHTML = '✓ 有効なメールアドレス';
                indicator.className = 'text-success';
            } else {
                indicator.innerHTML = '✗ 無効なメールアドレス';
                indicator.className = 'text-danger';
            }
        }
    }
    
    function checkUsernameAvailability(username) {
        if (username.length >= 3) {
            // 実際のシステムでは、AJAXでサーバーに問い合わせ
            var indicator = document.getElementById('usernameAvailability');
            if (indicator) {
                // シミュレーション: 'admin', 'test' は使用不可とする
                if (username.toLowerCase() === 'admin' || username.toLowerCase() === 'test') {
                    indicator.innerHTML = '✗ このユーザー名は使用できません';
                    indicator.className = 'text-danger';
                } else {
                    indicator.innerHTML = '✓ このユーザー名は使用可能です';
                    indicator.className = 'text-success';
                }
            }
        }
    }"
    
    ClientScript.RegisterClientScriptBlock(Me.GetType(), "ValidationScripts", script, True)
    
    ' コントロールにイベントを設定
    txtPassword.Attributes.Add("onkeyup", "showPasswordStrength(this.value);")
    txtEmail.Attributes.Add("onkeyup", "validateEmailFormat(this.value);")
    txtUserName.Attributes.Add("onkeyup", "checkUsernameAvailability(this.value);")
End Sub</code></pre>

                        <h6>対応するHTML追加</h6>
                        <pre><code>' 各入力フィールドの下に状態表示用の要素を追加
&lt;asp:TextBox ID="txtPassword" runat="server" CssClass="form-control" TextMode="Password"&gt;&lt;/asp:TextBox&gt;
&lt;div id="passwordStrength" class="small mt-1"&gt;&lt;/div&gt;

&lt;asp:TextBox ID="txtEmail" runat="server" CssClass="form-control" TextMode="Email"&gt;&lt;/asp:TextBox&gt;
&lt;div id="emailValidation" class="small mt-1"&gt;&lt;/div&gt;

&lt;asp:TextBox ID="txtUserName" runat="server" CssClass="form-control"&gt;&lt;/asp:TextBox&gt;
&lt;div id="usernameAvailability" class="small mt-1"&gt;&lt;/div&gt;</code></pre>
                    </div>

                    <div class="warning">
                        <h6>⚠️ セキュリティ上の注意点</h6>
                        <ul>
                            <li><strong>クライアントサイド検証のみに依存してはいけない</strong> - 必ずサーバーサイドでも検証する</li>
                            <li><strong>入力値のサニタイゼーション</strong> - Server.HtmlEncode()を使用してXSS攻撃を防ぐ</li>
                            <li><strong>SQLインジェクション対策</strong> - パラメータ化クエリを使用する</li>
                            <li><strong>機密情報の扱い</strong> - パスワード等はログに出力しない</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.6 エラー情報の適切な表示</h3>
                    <p>ユーザーにとって理解しやすいエラーメッセージの表示方法を学習します。</p>

                    <pre><code>' エラーメッセージの段階的表示
Private Sub ShowUserFriendlyError(errorType As String, technicalDetails As String)
    Select Case errorType
        Case "ValidationError"
            lblResult.Text = "入力内容を確認してください。"
            lblResult.CssClass = "alert alert-warning"
            
        Case "DatabaseError"
            lblResult.Text = "一時的にサービスが利用できません。しばらく後に再試行してください。"
            lblResult.CssClass = "alert alert-danger"
            ' 技術的詳細はログに記録（ユーザーには表示しない）
            LogError($"Database Error: {technicalDetails}")
            
        Case "NetworkError"
            lblResult.Text = "ネットワーク接続に問題があります。接続状況を確認してください。"
            lblResult.CssClass = "alert alert-warning"
            
        Case "PermissionError"
            lblResult.Text = "この操作を実行する権限がありません。"
            lblResult.CssClass = "alert alert-danger"
            
        Case Else
            lblResult.Text = "予期しないエラーが発生しました。システム管理者にお問い合わせください。"
            lblResult.CssClass = "alert alert-danger"
    End Select
End Sub</code></pre>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>必須入力チェックを行う検証コントロールは何ですか？</li>
                            <li>値の範囲をチェックする検証コントロールは何ですか？</li>
                            <li>正規表現パターンでチェックする検証コントロールは何ですか？</li>
                            <li>独自の検証ロジックを実装する検証コントロールは何ですか？</li>
                            <li>エラーメッセージを一括表示するコントロールは何ですか？</li>
                            <li>検証を実行しないボタンを作成するためのプロパティは何ですか？</li>
                            <li>ページの検証状態を確認するプロパティは何ですか？</li>
                            <li>VB.NETで学習した例外処理で使用する3つのキーワードは何ですか？</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>RequiredFieldValidator</li>
                                <li>RangeValidator</li>
                                <li>RegularExpressionValidator</li>
                                <li>CustomValidator</li>
                                <li>ValidationSummary</li>
                                <li>CausesValidation</li>
                                <li>Page.IsValid</li>
                                <li>Try, Catch, Finally</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-3.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-5.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>