<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET VB.NET学習教材 第6章 - データベース連携（ADO.NET）</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0078d4;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0078d4;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #2196F3;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0078d4;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0078d4 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        .architecture-diagram {
            background-color: #f8f9fa;
            border: 2px solid #0078d4;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../README.md">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">ASP.NET VB.NET学習ガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: Web Forms入門</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: Webコントロール</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">第3章: イベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">第4章: データ検証</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">第5章: 状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter6">第6章: データベース連携</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">第7章: データバインド</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: マスターページ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-9.html">第9章: セキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-10.html">第10章: 実践開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: データベース連携（ADO.NET）</h1>
                </div>

                <div id="chapter6">
                    <h2 class="chapter-title">データベース連携（ADO.NET）</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Web FormsでのADO.NETの基本的な使用方法を習得する</li>
                            <li>データベース接続文字列の設定と管理方法を学習する</li>
                            <li>DataSet、DataReader、SqlCommandの使い分けを理解する</li>
                            <li>VB.NETで学習したデータベース処理をWeb環境で応用する</li>
                            <li>CRUD操作（作成・読取・更新・削除）を実装する</li>
                        </ul>
                    </div>

                    <h3 class="section-title">6.1 ADO.NETアーキテクチャ</h3>
                    <p>VB.NETで学習したADO.NETの知識をWeb Formsアプリケーションで活用しましょう。</p>

                    <div class="architecture-diagram">
                        <h5>📊 ADO.NETアーキテクチャ</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>接続型アクセス</h6>
                                <ul class="list-unstyled">
                                    <li>🔗 <strong>SqlConnection</strong> - データベース接続</li>
                                    <li>📋 <strong>SqlCommand</strong> - SQL実行</li>
                                    <li>📖 <strong>SqlDataReader</strong> - データ読み取り</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>非接続型アクセス</h6>
                                <ul class="list-unstyled">
                                    <li>🔗 <strong>SqlDataAdapter</strong> - データアダプタ</li>
                                    <li>📊 <strong>DataSet</strong> - メモリ内データベース</li>
                                    <li>📋 <strong>DataTable</strong> - テーブルデータ</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <h3 class="section-title">6.2 Web.configでの接続文字列設定</h3>
                    <p>Webアプリケーションでは、接続文字列をweb.configファイルで管理します。</p>

                    <pre><code>' web.config での接続文字列設定
&lt;configuration&gt;
  &lt;connectionStrings&gt;
    &lt;!-- SQL Server Express LocalDB --&gt;
    &lt;add name="DefaultConnection" 
         connectionString="Data Source=(LocalDB)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\Database.mdf;Integrated Security=True" 
         providerName="System.Data.SqlClient" /&gt;
    
    &lt;!-- SQL Server --&gt;
    &lt;add name="SqlServerConnection" 
         connectionString="Data Source=ServerName;Initial Catalog=DatabaseName;Integrated Security=True" 
         providerName="System.Data.SqlClient" /&gt;
  &lt;/connectionStrings&gt;
&lt;/configuration&gt;

' VB.NETコードでの接続文字列取得
Imports System.Configuration

Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    ' web.configから接続文字列を取得
    Dim connectionString As String = ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString
    
    ' VB.NETで学習した方法と同じ
    Using connection As New SqlConnection(connectionString)
        ' データベース処理
    End Using
End Sub</code></pre>

                    <h3 class="section-title">6.3 SqlDataReaderを使用したデータ読み取り</h3>
                    <p>高パフォーマンスなデータ読み取りにはSqlDataReaderを使用します。</p>

                    <pre><code>' SqlDataReaderの基本使用法（VB.NET知識の応用）
Imports System.Data.SqlClient

Private Function GetCustomers() As List(Of Customer)
    Dim customers As New List(Of Customer)()
    Dim connectionString As String = ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString
    
    Using connection As New SqlConnection(connectionString)
        Dim sql As String = "SELECT CustomerId, CustomerName, Email, City FROM Customers ORDER BY CustomerName"
        
        Using command As New SqlCommand(sql, connection)
            Try
                connection.Open()
                
                Using reader As SqlDataReader = command.ExecuteReader()
                    While reader.Read()
                        Dim customer As New Customer() With {
                            .CustomerId = reader.GetInt32("CustomerId"),
                            .CustomerName = reader.GetString("CustomerName"),
                            .Email = If(reader.IsDBNull("Email"), String.Empty, reader.GetString("Email")),
                            .City = If(reader.IsDBNull("City"), String.Empty, reader.GetString("City"))
                        }
                        customers.Add(customer)
                    End While
                End Using
                
            Catch ex As SqlException
                ' データベースエラーの処理
                LogError($"Database Error: {ex.Message}")
                Throw New ApplicationException("データベースアクセスエラーが発生しました")
            Catch ex As Exception
                ' その他のエラー
                LogError($"Unexpected Error: {ex.Message}")
                Throw
            End Try
        End Using
    End Using
    
    Return customers
End Function

' パラメータ化クエリの使用（SQLインジェクション対策）
Private Function GetCustomersByCity(city As String) As List(Of Customer)
    Dim customers As New List(Of Customer)()
    Dim connectionString As String = ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString
    
    Using connection As New SqlConnection(connectionString)
        Dim sql As String = "SELECT CustomerId, CustomerName, Email, City FROM Customers WHERE City = @City ORDER BY CustomerName"
        
        Using command As New SqlCommand(sql, connection)
            ' パラメータの設定（SQLインジェクション対策）
            command.Parameters.AddWithValue("@City", city)
            
            connection.Open()
            
            Using reader As SqlDataReader = command.ExecuteReader()
                While reader.Read()
                    customers.Add(New Customer() With {
                        .CustomerId = reader.GetInt32("CustomerId"),
                        .CustomerName = reader.GetString("CustomerName"),
                        .Email = If(reader.IsDBNull("Email"), String.Empty, reader.GetString("Email")),
                        .City = reader.GetString("City")
                    })
                End While
            End Using
        End Using
    End Using
    
    Return customers
End Function</code></pre>

                    <h3 class="section-title">6.4 CRUD操作の実装</h3>
                    <p>VB.NETで学習したCRUD操作をWeb Formsで実装しましょう。</p>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 6-1: 顧客管理システム</h5>
                        <p>ADO.NETを使用した完全なCRUD操作システムを作成します。</p>

                        <h6>CustomerManager.aspx（マークアップ）</h6>
                        <pre><code>&lt;%@ Page Title="顧客管理システム" Language="VB" MasterPageFile="~/Site.Master" AutoEventWireup="true" CodeBehind="CustomerManager.aspx.vb" Inherits="HelloWorldWebApp.CustomerManager" %&gt;

&lt;asp:Content ID="BodyContent" ContentPlaceHolderID="MainContent" runat="server"&gt;
    &lt;div class="container mt-4"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-md-4"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-primary text-white"&gt;
                        &lt;h4 class="card-title mb-0"&gt;顧客情報の登録・編集&lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;asp:HiddenField ID="hidCustomerId" runat="server" Value="0" /&gt;
                        
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Label ID="lblCustomerName" runat="server" Text="顧客名 *:" CssClass="form-label" AssociatedControlID="txtCustomerName"&gt;&lt;/asp:Label&gt;
                            &lt;asp:TextBox ID="txtCustomerName" runat="server" CssClass="form-control" placeholder="株式会社○○"&gt;&lt;/asp:TextBox&gt;
                            &lt;asp:RequiredFieldValidator ID="rfvCustomerName" runat="server" 
                                ControlToValidate="txtCustomerName"
                                ErrorMessage="顧客名は必須です"
                                Display="Dynamic"
                                CssClass="text-danger"&gt;*必須&lt;/asp:RequiredFieldValidator&gt;
                        &lt;/div&gt;
                        
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Label ID="lblEmail" runat="server" Text="メールアドレス:" CssClass="form-label" AssociatedControlID="txtEmail"&gt;&lt;/asp:Label&gt;
                            &lt;asp:TextBox ID="txtEmail" runat="server" CssClass="form-control" TextMode="Email" placeholder="contact@example.com"&gt;&lt;/asp:TextBox&gt;
                            &lt;asp:RegularExpressionValidator ID="revEmail" runat="server"
                                ControlToValidate="txtEmail"
                                ValidationExpression="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                                ErrorMessage="有効なメールアドレスを入力してください"
                                Display="Dynamic"
                                CssClass="text-danger"&gt;*形式エラー&lt;/asp:RegularExpressionValidator&gt;
                        &lt;/div&gt;
                        
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Label ID="lblPhone" runat="server" Text="電話番号:" CssClass="form-label" AssociatedControlID="txtPhone"&gt;&lt;/asp:Label&gt;
                            &lt;asp:TextBox ID="txtPhone" runat="server" CssClass="form-control" placeholder="03-1234-5678"&gt;&lt;/asp:TextBox&gt;
                        &lt;/div&gt;
                        
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Label ID="lblCity" runat="server" Text="都市:" CssClass="form-label" AssociatedControlID="txtCity"&gt;&lt;/asp:Label&gt;
                            &lt;asp:TextBox ID="txtCity" runat="server" CssClass="form-control" placeholder="東京"&gt;&lt;/asp:TextBox&gt;
                        &lt;/div&gt;
                        
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Label ID="lblAddress" runat="server" Text="住所:" CssClass="form-label" AssociatedControlID="txtAddress"&gt;&lt;/asp:Label&gt;
                            &lt;asp:TextBox ID="txtAddress" runat="server" CssClass="form-control" TextMode="MultiLine" Rows="3" placeholder="詳細住所"&gt;&lt;/asp:TextBox&gt;
                        &lt;/div&gt;
                        
                        &lt;div class="d-grid gap-2"&gt;
                            &lt;asp:Button ID="btnSave" runat="server" Text="保存" CssClass="btn btn-success" /&gt;
                            &lt;asp:Button ID="btnClear" runat="server" Text="クリア" CssClass="btn btn-secondary" CausesValidation="false" /&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;!-- 検索フォーム --&gt;
                &lt;div class="card mt-3"&gt;
                    &lt;div class="card-header bg-info text-white"&gt;
                        &lt;h6 class="card-title mb-0"&gt;検索&lt;/h6&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;div class="mb-2"&gt;
                            &lt;asp:TextBox ID="txtSearch" runat="server" CssClass="form-control" placeholder="顧客名や都市で検索"&gt;&lt;/asp:TextBox&gt;
                        &lt;/div&gt;
                        &lt;div class="d-grid"&gt;
                            &lt;asp:Button ID="btnSearch" runat="server" Text="検索" CssClass="btn btn-info" CausesValidation="false" /&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="col-md-8"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-secondary text-white"&gt;
                        &lt;h4 class="card-title mb-0"&gt;顧客一覧&lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;asp:GridView ID="gvCustomers" runat="server" CssClass="table table-striped table-hover" 
                            AutoGenerateColumns="false" EmptyDataText="顧客データがありません"&gt;
                            &lt;Columns&gt;
                                &lt;asp:BoundField DataField="CustomerId" HeaderText="ID" ItemStyle-Width="50px" /&gt;
                                &lt;asp:BoundField DataField="CustomerName" HeaderText="顧客名" /&gt;
                                &lt;asp:BoundField DataField="Email" HeaderText="メール" /&gt;
                                &lt;asp:BoundField DataField="Phone" HeaderText="電話" /&gt;
                                &lt;asp:BoundField DataField="City" HeaderText="都市" /&gt;
                                &lt;asp:BoundField DataField="CreatedDate" HeaderText="登録日" DataFormatString="{0:yyyy-MM-dd}" /&gt;
                                &lt;asp:TemplateField HeaderText="操作" ItemStyle-Width="120px"&gt;
                                    &lt;ItemTemplate&gt;
                                        &lt;asp:Button ID="btnEdit" runat="server" Text="編集" CssClass="btn btn-sm btn-warning"
                                            CommandName="EditCustomer" CommandArgument='&lt;%# Eval("CustomerId") %&gt;' CausesValidation="false" /&gt;
                                        &lt;asp:Button ID="btnDelete" runat="server" Text="削除" CssClass="btn btn-sm btn-danger"
                                            CommandName="DeleteCustomer" CommandArgument='&lt;%# Eval("CustomerId") %&gt;' CausesValidation="false"
                                            OnClientClick="return confirm('本当に削除しますか？');" /&gt;
                                    &lt;/ItemTemplate&gt;
                                &lt;/asp:TemplateField&gt;
                            &lt;/Columns&gt;
                        &lt;/asp:GridView&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;!-- メッセージ表示 --&gt;
        &lt;div class="row mt-3"&gt;
            &lt;div class="col-12"&gt;
                &lt;asp:Label ID="lblMessage" runat="server" Text=""&gt;&lt;/asp:Label&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/asp:Content&gt;</code></pre>

                        <h6>CustomerManager.aspx.vb（コードビハインド）</h6>
                        <pre><code>Imports System.Data.SqlClient
Imports System.Configuration

Public Class CustomerManager
    Inherits System.Web.UI.Page

    ' データクラス
    Public Class Customer
        Public Property CustomerId As Integer
        Public Property CustomerName As String
        Public Property Email As String
        Public Property Phone As String
        Public Property City As String
        Public Property Address As String
        Public Property CreatedDate As DateTime
    End Class

    Private ReadOnly Property ConnectionString As String
        Get
            Return ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString
        End Get
    End Property

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not IsPostBack Then
            LoadCustomers()
        End If
    End Sub

    Protected Sub btnSave_Click(sender As Object, e As EventArgs) Handles btnSave.Click
        If Page.IsValid Then
            Try
                If hidCustomerId.Value = "0" Then
                    InsertCustomer()
                Else
                    UpdateCustomer()
                End If
                
                LoadCustomers()
                ClearForm()
                
            Catch ex As Exception
                ShowMessage($"保存エラー: {ex.Message}", "alert alert-danger")
            End Try
        End If
    End Sub

    Protected Sub btnClear_Click(sender As Object, e As EventArgs) Handles btnClear.Click
        ClearForm()
        ShowMessage("フォームをクリアしました", "alert alert-info")
    End Sub

    Protected Sub btnSearch_Click(sender As Object, e As EventArgs) Handles btnSearch.Click
        LoadCustomers(txtSearch.Text.Trim())
    End Sub

    Protected Sub gvCustomers_RowCommand(sender As Object, e As GridViewCommandEventArgs) Handles gvCustomers.RowCommand
        Try
            Dim customerId As Integer = Integer.Parse(e.CommandArgument.ToString())
            
            Select Case e.CommandName
                Case "EditCustomer"
                    EditCustomer(customerId)
                Case "DeleteCustomer"
                    DeleteCustomer(customerId)
                    LoadCustomers()
            End Select
            
        Catch ex As Exception
            ShowMessage($"操作エラー: {ex.Message}", "alert alert-danger")
        End Try
    End Sub

    ' CREATE - 顧客の新規登録
    Private Sub InsertCustomer()
        Using connection As New SqlConnection(ConnectionString)
            Dim sql As String = "INSERT INTO Customers (CustomerName, Email, Phone, City, Address, CreatedDate) " &
                               "VALUES (@CustomerName, @Email, @Phone, @City, @Address, @CreatedDate)"
            
            Using command As New SqlCommand(sql, connection)
                AddCustomerParameters(command)
                command.Parameters.AddWithValue("@CreatedDate", DateTime.Now)
                
                connection.Open()
                Dim rowsAffected As Integer = command.ExecuteNonQuery()
                
                If rowsAffected > 0 Then
                    ShowMessage("顧客情報を登録しました", "alert alert-success")
                Else
                    ShowMessage("登録に失敗しました", "alert alert-warning")
                End If
            End Using
        End Using
    End Sub

    ' READ - 顧客データの読み込み
    Private Sub LoadCustomers(Optional searchKeyword As String = "")
        Try
            Dim customers As List(Of Customer) = GetCustomers(searchKeyword)
            gvCustomers.DataSource = customers
            gvCustomers.DataBind()
            
            If searchKeyword <> "" Then
                ShowMessage($"検索結果: {customers.Count}件", "alert alert-info")
            End If
            
        Catch ex As Exception
            ShowMessage($"データ読み込みエラー: {ex.Message}", "alert alert-danger")
        End Try
    End Sub

    Private Function GetCustomers(Optional searchKeyword As String = "") As List(Of Customer)
        Dim customers As New List(Of Customer)()
        
        Using connection As New SqlConnection(ConnectionString)
            Dim sql As String
            
            If String.IsNullOrWhiteSpace(searchKeyword) Then
                sql = "SELECT CustomerId, CustomerName, Email, Phone, City, Address, CreatedDate " &
                     "FROM Customers ORDER BY CustomerName"
            Else
                sql = "SELECT CustomerId, CustomerName, Email, Phone, City, Address, CreatedDate " &
                     "FROM Customers WHERE CustomerName LIKE @Search OR City LIKE @Search " &
                     "ORDER BY CustomerName"
            End If
            
            Using command As New SqlCommand(sql, connection)
                If Not String.IsNullOrWhiteSpace(searchKeyword) Then
                    command.Parameters.AddWithValue("@Search", $"%{searchKeyword}%")
                End If
                
                connection.Open()
                
                Using reader As SqlDataReader = command.ExecuteReader()
                    While reader.Read()
                        customers.Add(New Customer() With {
                            .CustomerId = reader.GetInt32("CustomerId"),
                            .CustomerName = reader.GetString("CustomerName"),
                            .Email = If(reader.IsDBNull("Email"), String.Empty, reader.GetString("Email")),
                            .Phone = If(reader.IsDBNull("Phone"), String.Empty, reader.GetString("Phone")),
                            .City = If(reader.IsDBNull("City"), String.Empty, reader.GetString("City")),
                            .Address = If(reader.IsDBNull("Address"), String.Empty, reader.GetString("Address")),
                            .CreatedDate = reader.GetDateTime("CreatedDate")
                        })
                    End While
                End Using
            End Using
        End Using
        
        Return customers
    End Function

    ' UPDATE - 顧客情報の更新
    Private Sub UpdateCustomer()
        Using connection As New SqlConnection(ConnectionString)
            Dim sql As String = "UPDATE Customers SET CustomerName = @CustomerName, Email = @Email, " &
                               "Phone = @Phone, City = @City, Address = @Address WHERE CustomerId = @CustomerId"
            
            Using command As New SqlCommand(sql, connection)
                AddCustomerParameters(command)
                command.Parameters.AddWithValue("@CustomerId", Integer.Parse(hidCustomerId.Value))
                
                connection.Open()
                Dim rowsAffected As Integer = command.ExecuteNonQuery()
                
                If rowsAffected > 0 Then
                    ShowMessage("顧客情報を更新しました", "alert alert-success")
                Else
                    ShowMessage("更新に失敗しました", "alert alert-warning")
                End If
            End Using
        End Using
    End Sub

    ' DELETE - 顧客の削除
    Private Sub DeleteCustomer(customerId As Integer)
        Using connection As New SqlConnection(ConnectionString)
            Dim sql As String = "DELETE FROM Customers WHERE CustomerId = @CustomerId"
            
            Using command As New SqlCommand(sql, connection)
                command.Parameters.AddWithValue("@CustomerId", customerId)
                
                connection.Open()
                Dim rowsAffected As Integer = command.ExecuteNonQuery()
                
                If rowsAffected > 0 Then
                    ShowMessage("顧客を削除しました", "alert alert-success")
                Else
                    ShowMessage("削除に失敗しました", "alert alert-warning")
                End If
            End Using
        End Using
    End Sub

    ' 編集のためのデータ読み込み
    Private Sub EditCustomer(customerId As Integer)
        Using connection As New SqlConnection(ConnectionString)
            Dim sql As String = "SELECT CustomerId, CustomerName, Email, Phone, City, Address " &
                               "FROM Customers WHERE CustomerId = @CustomerId"
            
            Using command As New SqlCommand(sql, connection)
                command.Parameters.AddWithValue("@CustomerId", customerId)
                
                connection.Open()
                
                Using reader As SqlDataReader = command.ExecuteReader()
                    If reader.Read() Then
                        hidCustomerId.Value = reader.GetInt32("CustomerId").ToString()
                        txtCustomerName.Text = reader.GetString("CustomerName")
                        txtEmail.Text = If(reader.IsDBNull("Email"), String.Empty, reader.GetString("Email"))
                        txtPhone.Text = If(reader.IsDBNull("Phone"), String.Empty, reader.GetString("Phone"))
                        txtCity.Text = If(reader.IsDBNull("City"), String.Empty, reader.GetString("City"))
                        txtAddress.Text = If(reader.IsDBNull("Address"), String.Empty, reader.GetString("Address"))
                        
                        btnSave.Text = "更新"
                        ShowMessage("編集モードです", "alert alert-info")
                    End If
                End Using
            End Using
        End Using
    End Sub

    ' パラメータ設定の共通化
    Private Sub AddCustomerParameters(command As SqlCommand)
        command.Parameters.AddWithValue("@CustomerName", txtCustomerName.Text.Trim())
        command.Parameters.AddWithValue("@Email", If(String.IsNullOrWhiteSpace(txtEmail.Text), DBNull.Value, txtEmail.Text.Trim()))
        command.Parameters.AddWithValue("@Phone", If(String.IsNullOrWhiteSpace(txtPhone.Text), DBNull.Value, txtPhone.Text.Trim()))
        command.Parameters.AddWithValue("@City", If(String.IsNullOrWhiteSpace(txtCity.Text), DBNull.Value, txtCity.Text.Trim()))
        command.Parameters.AddWithValue("@Address", If(String.IsNullOrWhiteSpace(txtAddress.Text), DBNull.Value, txtAddress.Text.Trim()))
    End Sub

    Private Sub ClearForm()
        hidCustomerId.Value = "0"
        txtCustomerName.Text = ""
        txtEmail.Text = ""
        txtPhone.Text = ""
        txtCity.Text = ""
        txtAddress.Text = ""
        btnSave.Text = "保存"
        txtCustomerName.Focus()
    End Sub

    Private Sub ShowMessage(message As String, cssClass As String)
        lblMessage.Text = message
        lblMessage.CssClass = cssClass
    End Sub
End Class</code></pre>

                        <h6>データベーステーブル作成SQL</h6>
                        <pre><code>-- Customersテーブルの作成
CREATE TABLE Customers (
    CustomerId INT IDENTITY(1,1) PRIMARY KEY,
    CustomerName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(255) NULL,
    Phone NVARCHAR(20) NULL,
    City NVARCHAR(50) NULL,
    Address NVARCHAR(500) NULL,
    CreatedDate DATETIME NOT NULL DEFAULT GETDATE()
);

-- サンプルデータの挿入
INSERT INTO Customers (CustomerName, Email, Phone, City, Address) VALUES
('株式会社サンプル', 'info@sample.co.jp', '03-1234-5678', '東京', '東京都渋谷区○○1-2-3'),
('テスト商事', 'contact@test.com', '06-9876-5432', '大阪', '大阪府大阪市○○区○○2-3-4'),
('例示株式会社', 'example@company.jp', '052-111-2222', '名古屋', '愛知県名古屋市○○区○○3-4-5');</code></pre>
                    </div>

                    <h3 class="section-title">6.5 DataSetとDataTableの活用</h3>
                    <p>非接続型アプローチでのデータ操作を学習しましょう。</p>

                    <pre><code>' DataSetを使用した非接続型データアクセス
Private Function GetCustomersWithDataSet() As DataSet
    Dim dataSet As New DataSet()
    Dim connectionString As String = ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString
    
    Using connection As New SqlConnection(connectionString)
        Dim sql As String = "SELECT CustomerId, CustomerName, Email, City FROM Customers ORDER BY CustomerName"
        
        Using adapter As New SqlDataAdapter(sql, connection)
            Try
                ' DataSetにデータを填充
                adapter.Fill(dataSet, "Customers")
                
                ' DataSetに複数のテーブルを追加することも可能
                Dim orderSql As String = "SELECT OrderId, CustomerId, OrderDate, TotalAmount FROM Orders"
                Using orderAdapter As New SqlDataAdapter(orderSql, connection)
                    orderAdapter.Fill(dataSet, "Orders")
                End Using
                
                ' テーブル間の関係を定義
                If dataSet.Tables.Contains("Customers") AndAlso dataSet.Tables.Contains("Orders") Then
                    Dim relation As New DataRelation("CustomerOrders",
                        dataSet.Tables("Customers").Columns("CustomerId"),
                        dataSet.Tables("Orders").Columns("CustomerId"))
                    dataSet.Relations.Add(relation)
                End If
                
            Catch ex As Exception
                ShowMessage($"DataSet読み込みエラー: {ex.Message}", "alert alert-danger")
            End Try
        End Using
    End Using
    
    Return dataSet
End Function

' DataTableの操作
Private Sub ProcessDataTable()
    Dim dataSet As DataSet = GetCustomersWithDataSet()
    
    If dataSet.Tables.Contains("Customers") Then
        Dim customersTable As DataTable = dataSet.Tables("Customers")
        
        ' データの検索とフィルタリング
        Dim filteredRows() As DataRow = customersTable.Select("City = '東京'", "CustomerName ASC")
        
        ' DataTableからGridViewにバインド
        Dim filteredTable As DataTable = customersTable.Clone() ' 構造をコピー
        For Each row As DataRow In filteredRows
            filteredTable.ImportRow(row)
        Next
        
        gvCustomers.DataSource = filteredTable
        gvCustomers.DataBind()
    End If
End Sub

' DataTableの変更をデータベースに反映
Private Sub UpdateDataSetChanges(dataSet As DataSet)
    Dim connectionString As String = ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString
    
    Using connection As New SqlConnection(connectionString)
        Dim adapter As New SqlDataAdapter("SELECT * FROM Customers", connection)
        
        ' CommandBuilderで自動的にINSERT, UPDATE, DELETEコマンドを生成
        Dim commandBuilder As New SqlCommandBuilder(adapter)
        
        Try
            ' 変更をデータベースに反映
            adapter.Update(dataSet, "Customers")
            ShowMessage("データが正常に更新されました", "alert alert-success")
            
        Catch ex As Exception
            ShowMessage($"更新エラー: {ex.Message}", "alert alert-danger")
        End Try
    End Using
End Sub</code></pre>

                    <h3 class="section-title">6.6 パフォーマンスとセキュリティの考慮事項</h3>
                    <p>本格的なWebアプリケーションでの重要な考慮点を学習します。</p>

                    <div class="warning">
                        <h6>⚠️ セキュリティ対策</h6>
                        <ul>
                            <li><strong>SQLインジェクション対策</strong>: 必ずパラメータ化クエリを使用</li>
                            <li><strong>接続文字列の保護</strong>: web.configの暗号化</li>
                            <li><strong>最小権限の原則</strong>: データベースユーザーの権限を制限</li>
                            <li><strong>入力値検証</strong>: サーバーサイドでの厳密な検証</li>
                        </ul>
                    </div>

                    <pre><code>' セキュアなデータアクセスパターン
Private Function GetCustomerSecurely(customerId As Integer) As Customer
    ' 入力値の検証
    If customerId <= 0 Then
        Throw New ArgumentException("Invalid customer ID")
    End If
    
    Using connection As New SqlConnection(ConnectionString)
        ' パラメータ化クエリ（SQLインジェクション対策）
        Dim sql As String = "SELECT CustomerId, CustomerName, Email FROM Customers WHERE CustomerId = @CustomerId"
        
        Using command As New SqlCommand(sql, connection)
            ' 型指定パラメータ（より安全）
            command.Parameters.Add("@CustomerId", SqlDbType.Int).Value = customerId
            
            connection.Open()
            
            Using reader As SqlDataReader = command.ExecuteReader()
                If reader.Read() Then
                    Return New Customer() With {
                        .CustomerId = reader.GetInt32("CustomerId"),
                        .CustomerName = reader.GetString("CustomerName"),
                        .Email = If(reader.IsDBNull("Email"), String.Empty, reader.GetString("Email"))
                    }
                End If
            End Using
        End Using
    End Using
    
    Return Nothing
End Function

' 接続プールの最適化
Private Shared Function GetOptimizedConnection() As SqlConnection
    ' 接続文字列でプール設定を最適化
    Dim connectionString As String = ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString
    
    ' 接続プールサイズの調整
    If Not connectionString.ToLower().Contains("max pool size") Then
        connectionString += ";Max Pool Size=100;Min Pool Size=5"
    End If
    
    Return New SqlConnection(connectionString)
End Function</code></pre>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>Web.configファイルで接続文字列を定義するセクションは何ですか？</li>
                            <li>高パフォーマンスな読み取り専用データアクセスに適したクラスは何ですか？</li>
                            <li>非接続型でデータを操作するためのメインクラスは何ですか？</li>
                            <li>SQLインジェクション攻撃を防ぐために使用する仕組みは何ですか？</li>
                            <li>VB.NETコードから接続文字列を取得するクラスは何ですか？</li>
                            <li>DataSetで複数テーブル間の関係を定義するクラスは何ですか？</li>
                            <li>CRUD操作の4つの基本操作を英語で答えてください。</li>
                            <li>データベース接続リソースを適切に解放するためのVB.NET構文は何ですか？</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>connectionStrings</li>
                                <li>SqlDataReader</li>
                                <li>DataSet</li>
                                <li>パラメータ化クエリ</li>
                                <li>ConfigurationManager</li>
                                <li>DataRelation</li>
                                <li>Create, Read, Update, Delete</li>
                                <li>Using文</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-5.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-7.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>