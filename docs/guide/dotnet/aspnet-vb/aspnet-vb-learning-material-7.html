<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET VB.NET学習教材 第7章 - データバインドとGridView</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0078d4;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0078d4;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #2196F3;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0078d4;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0078d4 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        .control-comparison {
            background-color: #f8f9fa;
            border: 2px solid #0078d4;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../README.md">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">ASP.NET VB.NET学習ガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: Web Forms入門</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: Webコントロール</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">第3章: イベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">第4章: データ検証</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">第5章: 状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">第6章: データベース連携</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter7">第7章: データバインド</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: マスターページ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-9.html">第9章: セキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-10.html">第10章: 実践開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: データバインドとGridView</h1>
                </div>

                <div id="chapter7">
                    <h2 class="chapter-title">データバインドとGridView</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>データバインディングの概念と実装方法を習得する</li>
                            <li>GridView、DataList、Repeaterコントロールの使い分けを学習する</li>
                            <li>ページング、ソート、フィルタリング機能を実装する</li>
                            <li>テンプレートを使用したカスタムデータ表示を作成する</li>
                            <li>VB.NETのコレクション操作をWeb Formsで応用する</li>
                        </ul>
                    </div>

                    <h3 class="section-title">7.1 データバインディング概要</h3>
                    <p>データバインディングは、データソースとコントロールを自動的に連携させる仕組みです。</p>

                    <div class="control-comparison">
                        <h5>📊 データ表示コントロールの比較</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>コントロール</th>
                                        <th>用途</th>
                                        <th>柔軟性</th>
                                        <th>VB.NETでの類似概念</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>GridView</strong></td>
                                        <td>表形式データ表示</td>
                                        <td>中程度</td>
                                        <td>DataGridView</td>
                                    </tr>
                                    <tr>
                                        <td><strong>DataList</strong></td>
                                        <td>カード形式データ表示</td>
                                        <td>高い</td>
                                        <td>ListView</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Repeater</strong></td>
                                        <td>完全カスタム表示</td>
                                        <td>最高</td>
                                        <td>For Each ループ</td>
                                    </tr>
                                    <tr>
                                        <td><strong>DropDownList</strong></td>
                                        <td>選択リスト</td>
                                        <td>低い</td>
                                        <td>ComboBox</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <h3 class="section-title">7.2 基本的なデータバインディング</h3>
                    <p>コントロールとデータソースを接続する基本的な方法を学習しましょう。</p>

                    <pre><code>' 基本的なデータバインディング（VB.NETの List を活用）
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    If Not IsPostBack Then
        BindCustomerData()
        BindCategoryDropDown()
    End If
End Sub

Private Sub BindCustomerData()
    ' VB.NETで学習したコレクション操作の応用
    Dim customers As List(Of Customer) = GetCustomersFromDatabase()
    
    ' GridViewにデータをバインド
    gvCustomers.DataSource = customers
    gvCustomers.DataBind()
End Sub

Private Sub BindCategoryDropDown()
    ' DropDownListの基本バインディング
    Dim categories As New List(Of String) From {"すべて", "プログラミング", "データベース", "ネットワーク"}
    
    ddlCategory.DataSource = categories
    ddlCategory.DataBind()
    
    ' または、辞書を使った値と表示名の分離
    Dim categoryDict As New Dictionary(Of String, String) From {
        {"", "すべて"},
        {"prog", "プログラミング"},
        {"db", "データベース"},
        {"net", "ネットワーク"}
    }
    
    ddlCategory.DataSource = categoryDict
    ddlCategory.DataTextField = "Value"  ' 表示される文字
    ddlCategory.DataValueField = "Key"   ' 実際の値
    ddlCategory.DataBind()
End Sub

' カスタムクラスのプロパティ表示
Public Class Customer
    Public Property CustomerId As Integer
    Public Property CustomerName As String
    Public Property Email As String
    Public Property City As String
    Public Property TotalOrders As Integer
    
    ' 計算プロパティ（VB.NETの ReadOnly Property）
    Public ReadOnly Property DisplayName As String
        Get
            Return $"{CustomerName} ({City})"
        End Get
    End Property
    
    Public ReadOnly Property OrderStatus As String
        Get
            If TotalOrders = 0 Then
                Return "新規顧客"
            ElseIf TotalOrders < 5 Then
                Return "通常顧客"
            Else
                Return "優良顧客"
            End If
        End Get
    End Property
End Class</code></pre>

                    <h3 class="section-title">7.3 GridViewの高度な機能</h3>
                    <p>GridViewのページング、ソート、編集機能を実装しましょう。</p>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 7-1: 高機能データグリッドシステム</h5>
                        <p>ページング、ソート、インライン編集機能を持つ本格的なデータグリッドを作成します。</p>

                        <h6>AdvancedGridView.aspx（マークアップ）</h6>
                        <pre><code>&lt;%@ Page Title="高機能データグリッド" Language="VB" MasterPageFile="~/Site.Master" AutoEventWireup="true" CodeBehind="AdvancedGridView.aspx.vb" Inherits="HelloWorldWebApp.AdvancedGridView" %&gt;

&lt;asp:Content ID="BodyContent" ContentPlaceHolderID="MainContent" runat="server"&gt;
    &lt;div class="container mt-4"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-12"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-primary text-white"&gt;
                        &lt;h3 class="card-title mb-0"&gt;製品管理システム&lt;/h3&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;!-- 検索・フィルタリング --&gt;
                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-md-3"&gt;
                                &lt;asp:Label ID="lblSearch" runat="server" Text="検索:" CssClass="form-label" AssociatedControlID="txtSearch"&gt;&lt;/asp:Label&gt;
                                &lt;asp:TextBox ID="txtSearch" runat="server" CssClass="form-control" placeholder="製品名で検索"&gt;&lt;/asp:TextBox&gt;
                            &lt;/div&gt;
                            &lt;div class="col-md-3"&gt;
                                &lt;asp:Label ID="lblCategoryFilter" runat="server" Text="カテゴリ:" CssClass="form-label" AssociatedControlID="ddlCategoryFilter"&gt;&lt;/asp:Label&gt;
                                &lt;asp:DropDownList ID="ddlCategoryFilter" runat="server" CssClass="form-select"&gt;&lt;/asp:DropDownList&gt;
                            &lt;/div&gt;
                            &lt;div class="col-md-3"&gt;
                                &lt;asp:Label ID="lblPriceRange" runat="server" Text="価格帯:" CssClass="form-label" AssociatedControlID="ddlPriceRange"&gt;&lt;/asp:Label&gt;
                                &lt;asp:DropDownList ID="ddlPriceRange" runat="server" CssClass="form-select"&gt;
                                    &lt;asp:ListItem Value="" Text="すべて"&gt;&lt;/asp:ListItem&gt;
                                    &lt;asp:ListItem Value="0-1000" Text="¥1,000未満"&gt;&lt;/asp:ListItem&gt;
                                    &lt;asp:ListItem Value="1000-5000" Text="¥1,000-¥5,000"&gt;&lt;/asp:ListItem&gt;
                                    &lt;asp:ListItem Value="5000-10000" Text="¥5,000-¥10,000"&gt;&lt;/asp:ListItem&gt;
                                    &lt;asp:ListItem Value="10000-" Text="¥10,000以上"&gt;&lt;/asp:ListItem&gt;
                                &lt;/asp:DropDownList&gt;
                            &lt;/div&gt;
                            &lt;div class="col-md-3 d-flex align-items-end"&gt;
                                &lt;asp:Button ID="btnFilter" runat="server" Text="フィルタ適用" CssClass="btn btn-info me-2" /&gt;
                                &lt;asp:Button ID="btnClearFilter" runat="server" Text="クリア" CssClass="btn btn-outline-secondary" /&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- データ件数表示 --&gt;
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Label ID="lblRecordCount" runat="server" Text="" CssClass="text-muted"&gt;&lt;/asp:Label&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- GridView --&gt;
                        &lt;asp:GridView ID="gvProducts" runat="server" 
                            CssClass="table table-striped table-hover"
                            AutoGenerateColumns="false"
                            AllowPaging="true" PageSize="10"
                            AllowSorting="true"
                            EmptyDataText="データがありません"
                            DataKeyNames="ProductId"&gt;
                            
                            &lt;PagerSettings Mode="NumericFirstLast" FirstPageText="最初" LastPageText="最後" 
                                NextPageText="次へ" PreviousPageText="前へ" PageButtonCount="5" /&gt;
                            &lt;PagerStyle CssClass="pagination justify-content-center" /&gt;
                            
                            &lt;Columns&gt;
                                &lt;!-- 編集・削除ボタン --&gt;
                                &lt;asp:TemplateField HeaderText="操作" ItemStyle-Width="120px"&gt;
                                    &lt;ItemTemplate&gt;
                                        &lt;asp:Button ID="btnEdit" runat="server" Text="編集" CssClass="btn btn-sm btn-warning me-1"
                                            CommandName="Edit" /&gt;
                                        &lt;asp:Button ID="btnDelete" runat="server" Text="削除" CssClass="btn btn-sm btn-danger"
                                            CommandName="Delete" 
                                            OnClientClick="return confirm('この製品を削除しますか？');" /&gt;
                                    &lt;/ItemTemplate&gt;
                                    &lt;EditItemTemplate&gt;
                                        &lt;asp:Button ID="btnUpdate" runat="server" Text="更新" CssClass="btn btn-sm btn-success me-1"
                                            CommandName="Update" /&gt;
                                        &lt;asp:Button ID="btnCancel" runat="server" Text="取消" CssClass="btn btn-sm btn-secondary"
                                            CommandName="Cancel" /&gt;
                                    &lt;/EditItemTemplate&gt;
                                &lt;/asp:TemplateField&gt;
                                
                                &lt;!-- 製品ID --&gt;
                                &lt;asp:BoundField DataField="ProductId" HeaderText="ID" 
                                    SortExpression="ProductId" ItemStyle-Width="60px" ReadOnly="true" /&gt;
                                
                                &lt;!-- 製品名 --&gt;
                                &lt;asp:TemplateField HeaderText="製品名" SortExpression="ProductName"&gt;
                                    &lt;ItemTemplate&gt;
                                        &lt;strong&gt;&lt;%# Eval("ProductName") %&gt;&lt;/strong&gt;
                                    &lt;/ItemTemplate&gt;
                                    &lt;EditItemTemplate&gt;
                                        &lt;asp:TextBox ID="txtProductName" runat="server" Text='&lt;%# Bind("ProductName") %&gt;' 
                                            CssClass="form-control form-control-sm" /&gt;
                                        &lt;asp:RequiredFieldValidator ID="rfvProductName" runat="server" 
                                            ControlToValidate="txtProductName" ErrorMessage="*" Display="Dynamic" 
                                            CssClass="text-danger" /&gt;
                                    &lt;/EditItemTemplate&gt;
                                &lt;/asp:TemplateField&gt;
                                
                                &lt;!-- カテゴリ --&gt;
                                &lt;asp:TemplateField HeaderText="カテゴリ" SortExpression="Category"&gt;
                                    &lt;ItemTemplate&gt;
                                        &lt;span class="badge bg-secondary"&gt;&lt;%# Eval("Category") %&gt;&lt;/span&gt;
                                    &lt;/ItemTemplate&gt;
                                    &lt;EditItemTemplate&gt;
                                        &lt;asp:DropDownList ID="ddlCategory" runat="server" CssClass="form-select form-select-sm"
                                            SelectedValue='&lt;%# Bind("Category") %&gt;'&gt;
                                            &lt;asp:ListItem Value="プログラミング" Text="プログラミング"&gt;&lt;/asp:ListItem&gt;
                                            &lt;asp:ListItem Value="データベース" Text="データベース"&gt;&lt;/asp:ListItem&gt;
                                            &lt;asp:ListItem Value="ネットワーク" Text="ネットワーク"&gt;&lt;/asp:ListItem&gt;
                                            &lt;asp:ListItem Value="その他" Text="その他"&gt;&lt;/asp:ListItem&gt;
                                        &lt;/asp:DropDownList&gt;
                                    &lt;/EditItemTemplate&gt;
                                &lt;/asp:TemplateField&gt;
                                
                                &lt;!-- 価格 --&gt;
                                &lt;asp:TemplateField HeaderText="価格" SortExpression="Price"&gt;
                                    &lt;ItemTemplate&gt;
                                        ¥&lt;%# Eval("Price", "{0:N0}") %&gt;
                                    &lt;/ItemTemplate&gt;
                                    &lt;EditItemTemplate&gt;
                                        &lt;asp:TextBox ID="txtPrice" runat="server" Text='&lt;%# Bind("Price") %&gt;' 
                                            CssClass="form-control form-control-sm" TextMode="Number" /&gt;
                                        &lt;asp:RangeValidator ID="rvPrice" runat="server" 
                                            ControlToValidate="txtPrice" Type="Integer" MinimumValue="0" MaximumValue="1000000"
                                            ErrorMessage="*" Display="Dynamic" CssClass="text-danger" /&gt;
                                    &lt;/EditItemTemplate&gt;
                                &lt;/asp:TemplateField&gt;
                                
                                &lt;!-- 在庫 --&gt;
                                &lt;asp:TemplateField HeaderText="在庫" SortExpression="Stock"&gt;
                                    &lt;ItemTemplate&gt;
                                        &lt;%# GetStockDisplay(Eval("Stock")) %&gt;
                                    &lt;/ItemTemplate&gt;
                                    &lt;EditItemTemplate&gt;
                                        &lt;asp:TextBox ID="txtStock" runat="server" Text='&lt;%# Bind("Stock") %&gt;' 
                                            CssClass="form-control form-control-sm" TextMode="Number" /&gt;
                                    &lt;/EditItemTemplate&gt;
                                &lt;/asp:TemplateField&gt;
                                
                                &lt;!-- 登録日 --&gt;
                                &lt;asp:BoundField DataField="CreatedDate" HeaderText="登録日" 
                                    SortExpression="CreatedDate" DataFormatString="{0:yyyy-MM-dd}" ReadOnly="true" /&gt;
                                
                                &lt;!-- アクティブ状態 --&gt;
                                &lt;asp:TemplateField HeaderText="状態" SortExpression="IsActive"&gt;
                                    &lt;ItemTemplate&gt;
                                        &lt;%# GetActiveStatusDisplay(Eval("IsActive")) %&gt;
                                    &lt;/ItemTemplate&gt;
                                    &lt;EditItemTemplate&gt;
                                        &lt;asp:CheckBox ID="chkIsActive" runat="server" Checked='&lt;%# Bind("IsActive") %&gt;' /&gt;
                                    &lt;/EditItemTemplate&gt;
                                &lt;/asp:TemplateField&gt;
                            &lt;/Columns&gt;
                        &lt;/asp:GridView&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;!-- メッセージ表示 --&gt;
        &lt;div class="row mt-3"&gt;
            &lt;div class="col-12"&gt;
                &lt;asp:Label ID="lblMessage" runat="server" Text=""&gt;&lt;/asp:Label&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/asp:Content&gt;</code></pre>

                        <h6>AdvancedGridView.aspx.vb（コードビハインド）</h6>
                        <pre><code>Imports System.Data.SqlClient
Imports System.Configuration

Public Class AdvancedGridView
    Inherits System.Web.UI.Page

    ' 製品データクラス
    Public Class Product
        Public Property ProductId As Integer
        Public Property ProductName As String
        Public Property Category As String
        Public Property Price As Decimal
        Public Property Stock As Integer
        Public Property IsActive As Boolean
        Public Property CreatedDate As DateTime
    End Class

    Private ReadOnly Property ConnectionString As String
        Get
            Return ConfigurationManager.ConnectionStrings("DefaultConnection").ConnectionString
        End Get
    End Property

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not IsPostBack Then
            LoadCategoryFilter()
            BindProductData()
        End If
    End Sub

    ' フィルタ用カテゴリの読み込み
    Private Sub LoadCategoryFilter()
        ddlCategoryFilter.Items.Clear()
        ddlCategoryFilter.Items.Add(New ListItem("すべて", ""))
        ddlCategoryFilter.Items.Add(New ListItem("プログラミング", "プログラミング"))
        ddlCategoryFilter.Items.Add(New ListItem("データベース", "データベース"))
        ddlCategoryFilter.Items.Add(New ListItem("ネットワーク", "ネットワーク"))
        ddlCategoryFilter.Items.Add(New ListItem("その他", "その他"))
    End Sub

    ' 製品データのバインディング
    Private Sub BindProductData()
        Try
            Dim products As List(Of Product) = GetProducts()
            
            ' 検索・フィルタリングの適用
            products = ApplyFilters(products)
            
            ' ソートの適用
            If Not String.IsNullOrEmpty(ViewState("SortExpression")) Then
                products = ApplySort(products, ViewState("SortExpression"), ViewState("SortDirection"))
            End If
            
            gvProducts.DataSource = products
            gvProducts.DataBind()
            
            lblRecordCount.Text = $"表示件数: {products.Count}件"
            
        Catch ex As Exception
            ShowMessage($"データ読み込みエラー: {ex.Message}", "alert alert-danger")
        End Try
    End Sub

    ' データベースから製品データを取得
    Private Function GetProducts() As List(Of Product)
        Dim products As New List(Of Product)()
        
        Using connection As New SqlConnection(ConnectionString)
            Dim sql As String = "SELECT ProductId, ProductName, Category, Price, Stock, IsActive, CreatedDate " &
                               "FROM Products ORDER BY ProductId"
            
            Using command As New SqlCommand(sql, connection)
                connection.Open()
                
                Using reader As SqlDataReader = command.ExecuteReader()
                    While reader.Read()
                        products.Add(New Product() With {
                            .ProductId = reader.GetInt32("ProductId"),
                            .ProductName = reader.GetString("ProductName"),
                            .Category = If(reader.IsDBNull("Category"), String.Empty, reader.GetString("Category")),
                            .Price = reader.GetDecimal("Price"),
                            .Stock = reader.GetInt32("Stock"),
                            .IsActive = reader.GetBoolean("IsActive"),
                            .CreatedDate = reader.GetDateTime("CreatedDate")
                        })
                    End While
                End Using
            End Using
        End Using
        
        Return products
    End Function

    ' フィルタリングの適用（VB.NET LINQ の活用）
    Private Function ApplyFilters(products As List(Of Product)) As List(Of Product)
        Dim filteredProducts = products.AsEnumerable()
        
        ' テキスト検索
        If Not String.IsNullOrWhiteSpace(txtSearch.Text) Then
            Dim searchText As String = txtSearch.Text.Trim().ToLower()
            filteredProducts = filteredProducts.Where(Function(p) p.ProductName.ToLower().Contains(searchText))
        End If
        
        ' カテゴリフィルタ
        If Not String.IsNullOrEmpty(ddlCategoryFilter.SelectedValue) Then
            Dim selectedCategory As String = ddlCategoryFilter.SelectedValue
            filteredProducts = filteredProducts.Where(Function(p) p.Category = selectedCategory)
        End If
        
        ' 価格帯フィルタ
        If Not String.IsNullOrEmpty(ddlPriceRange.SelectedValue) Then
            Dim priceRange As String = ddlPriceRange.SelectedValue
            
            Select Case priceRange
                Case "0-1000"
                    filteredProducts = filteredProducts.Where(Function(p) p.Price < 1000)
                Case "1000-5000"
                    filteredProducts = filteredProducts.Where(Function(p) p.Price >= 1000 AndAlso p.Price < 5000)
                Case "5000-10000"
                    filteredProducts = filteredProducts.Where(Function(p) p.Price >= 5000 AndAlso p.Price < 10000)
                Case "10000-"
                    filteredProducts = filteredProducts.Where(Function(p) p.Price >= 10000)
            End Select
        End If
        
        Return filteredProducts.ToList()
    End Function

    ' ソートの適用（VB.NET OrderBy の活用）
    Private Function ApplySort(products As List(Of Product), sortExpression As String, sortDirection As String) As List(Of Product)
        Select Case sortExpression.ToLower()
            Case "productid"
                If sortDirection = "ASC" Then
                    Return products.OrderBy(Function(p) p.ProductId).ToList()
                Else
                    Return products.OrderByDescending(Function(p) p.ProductId).ToList()
                End If
            Case "productname"
                If sortDirection = "ASC" Then
                    Return products.OrderBy(Function(p) p.ProductName).ToList()
                Else
                    Return products.OrderByDescending(Function(p) p.ProductName).ToList()
                End If
            Case "category"
                If sortDirection = "ASC" Then
                    Return products.OrderBy(Function(p) p.Category).ToList()
                Else
                    Return products.OrderByDescending(Function(p) p.Category).ToList()
                End If
            Case "price"
                If sortDirection = "ASC" Then
                    Return products.OrderBy(Function(p) p.Price).ToList()
                Else
                    Return products.OrderByDescending(Function(p) p.Price).ToList()
                End If
            Case "stock"
                If sortDirection = "ASC" Then
                    Return products.OrderBy(Function(p) p.Stock).ToList()
                Else
                    Return products.OrderByDescending(Function(p) p.Stock).ToList()
                End If
            Case "createddate"
                If sortDirection = "ASC" Then
                    Return products.OrderBy(Function(p) p.CreatedDate).ToList()
                Else
                    Return products.OrderByDescending(Function(p) p.CreatedDate).ToList()
                End If
            Case "isactive"
                If sortDirection = "ASC" Then
                    Return products.OrderBy(Function(p) p.IsActive).ToList()
                Else
                    Return products.OrderByDescending(Function(p) p.IsActive).ToList()
                End If
            Case Else
                Return products
        End Select
    End Function

    ' GridViewイベントハンドラ
    Protected Sub gvProducts_PageIndexChanging(sender As Object, e As GridViewPageEventArgs) Handles gvProducts.PageIndexChanging
        gvProducts.PageIndex = e.NewPageIndex
        BindProductData()
    End Sub

    Protected Sub gvProducts_Sorting(sender As Object, e As GridViewSortEventArgs) Handles gvProducts.Sorting
        Dim sortExpression As String = e.SortExpression
        Dim sortDirection As String = "ASC"
        
        ' 現在のソート方向を取得・反転
        If ViewState("SortExpression") IsNot Nothing AndAlso ViewState("SortExpression").ToString() = sortExpression Then
            sortDirection = If(ViewState("SortDirection").ToString() = "ASC", "DESC", "ASC")
        End If
        
        ViewState("SortExpression") = sortExpression
        ViewState("SortDirection") = sortDirection
        
        gvProducts.PageIndex = 0 ' ソート時は最初のページに戻る
        BindProductData()
    End Sub

    Protected Sub gvProducts_RowEditing(sender As Object, e As GridViewEditEventArgs) Handles gvProducts.RowEditing
        gvProducts.EditIndex = e.NewEditIndex
        BindProductData()
    End Sub

    Protected Sub gvProducts_RowCancelingEdit(sender As Object, e As GridViewCancelEditEventArgs) Handles gvProducts.RowCancelingEdit
        gvProducts.EditIndex = -1
        BindProductData()
    End Sub

    Protected Sub gvProducts_RowUpdating(sender As Object, e As GridViewUpdateEventArgs) Handles gvProducts.RowUpdating
        Try
            Dim productId As Integer = CInt(gvProducts.DataKeys(e.RowIndex).Value)
            
            ' 編集コントロールから値を取得
            Dim txtProductName As TextBox = DirectCast(gvProducts.Rows(e.RowIndex).FindControl("txtProductName"), TextBox)
            Dim ddlCategory As DropDownList = DirectCast(gvProducts.Rows(e.RowIndex).FindControl("ddlCategory"), DropDownList)
            Dim txtPrice As TextBox = DirectCast(gvProducts.Rows(e.RowIndex).FindControl("txtPrice"), TextBox)
            Dim txtStock As TextBox = DirectCast(gvProducts.Rows(e.RowIndex).FindControl("txtStock"), TextBox)
            Dim chkIsActive As CheckBox = DirectCast(gvProducts.Rows(e.RowIndex).FindControl("chkIsActive"), CheckBox)
            
            ' データベース更新
            UpdateProduct(productId, txtProductName.Text, ddlCategory.SelectedValue, 
                         Decimal.Parse(txtPrice.Text), Integer.Parse(txtStock.Text), chkIsActive.Checked)
            
            gvProducts.EditIndex = -1
            BindProductData()
            ShowMessage("製品情報を更新しました", "alert alert-success")
            
        Catch ex As Exception
            ShowMessage($"更新エラー: {ex.Message}", "alert alert-danger")
        End Try
    End Sub

    Protected Sub gvProducts_RowDeleting(sender As Object, e As GridViewDeleteEventArgs) Handles gvProducts.RowDeleting
        Try
            Dim productId As Integer = CInt(gvProducts.DataKeys(e.RowIndex).Value)
            
            DeleteProduct(productId)
            BindProductData()
            ShowMessage("製品を削除しました", "alert alert-success")
            
        Catch ex As Exception
            ShowMessage($"削除エラー: {ex.Message}", "alert alert-danger")
        End Try
    End Sub

    ' フィルタ関連イベント
    Protected Sub btnFilter_Click(sender As Object, e As EventArgs) Handles btnFilter.Click
        gvProducts.PageIndex = 0 ' フィルタ時は最初のページに戻る
        BindProductData()
    End Sub

    Protected Sub btnClearFilter_Click(sender As Object, e As EventArgs) Handles btnClearFilter.Click
        txtSearch.Text = ""
        ddlCategoryFilter.SelectedIndex = 0
        ddlPriceRange.SelectedIndex = 0
        BindProductData()
    End Sub

    ' データベース更新・削除メソッド
    Private Sub UpdateProduct(productId As Integer, productName As String, category As String, 
                             price As Decimal, stock As Integer, isActive As Boolean)
        Using connection As New SqlConnection(ConnectionString)
            Dim sql As String = "UPDATE Products SET ProductName = @ProductName, Category = @Category, " &
                               "Price = @Price, Stock = @Stock, IsActive = @IsActive WHERE ProductId = @ProductId"
            
            Using command As New SqlCommand(sql, connection)
                command.Parameters.AddWithValue("@ProductId", productId)
                command.Parameters.AddWithValue("@ProductName", productName)
                command.Parameters.AddWithValue("@Category", category)
                command.Parameters.AddWithValue("@Price", price)
                command.Parameters.AddWithValue("@Stock", stock)
                command.Parameters.AddWithValue("@IsActive", isActive)
                
                connection.Open()
                command.ExecuteNonQuery()
            End Using
        End Using
    End Sub

    Private Sub DeleteProduct(productId As Integer)
        Using connection As New SqlConnection(ConnectionString)
            Dim sql As String = "DELETE FROM Products WHERE ProductId = @ProductId"
            
            Using command As New SqlCommand(sql, connection)
                command.Parameters.AddWithValue("@ProductId", productId)
                
                connection.Open()
                command.ExecuteNonQuery()
            End Using
        End Using
    End Sub

    ' 表示用ヘルパーメソッド
    Protected Function GetStockDisplay(stock As Object) As String
        Dim stockValue As Integer = CInt(stock)
        
        If stockValue = 0 Then
            Return "<span class='badge bg-danger'>在庫切れ</span>"
        ElseIf stockValue < 10 Then
            Return $"<span class='badge bg-warning text-dark'>{stockValue}個</span>"
        Else
            Return $"<span class='badge bg-success'>{stockValue}個</span>"
        End If
    End Function

    Protected Function GetActiveStatusDisplay(isActive As Object) As String
        If CBool(isActive) Then
            Return "<span class='badge bg-success'>有効</span>"
        Else
            Return "<span class='badge bg-secondary'>無効</span>"
        End If
    End Function

    Private Sub ShowMessage(message As String, cssClass As String)
        lblMessage.Text = message
        lblMessage.CssClass = cssClass
    End Sub
End Class</code></pre>
                    </div>

                    <h3 class="section-title">7.4 DataListとRepeaterコントロール</h3>
                    <p>より柔軟なデータ表示のためのコントロールを学習しましょう。</p>

                    <pre><code>' DataList の使用例
&lt;asp:DataList ID="dlProducts" runat="server" RepeatColumns="3" CssClass="row"&gt;
    &lt;ItemTemplate&gt;
        &lt;div class="col-md-4 mb-3"&gt;
            &lt;div class="card h-100"&gt;
                &lt;div class="card-body"&gt;
                    &lt;h5 class="card-title"&gt;&lt;%# Eval("ProductName") %&gt;&lt;/h5&gt;
                    &lt;p class="card-text"&gt;&lt;%# Eval("Category") %&gt;&lt;/p&gt;
                    &lt;p class="card-text"&gt;&lt;strong&gt;価格: ¥&lt;%# Eval("Price", "{0:N0}") %&gt;&lt;/strong&gt;&lt;/p&gt;
                    &lt;p class="card-text"&gt;&lt;small class="text-muted"&gt;在庫: &lt;%# Eval("Stock") %&gt;個&lt;/small&gt;&lt;/p&gt;
                &lt;/div&gt;
                &lt;div class="card-footer"&gt;
                    &lt;asp:Button ID="btnAddToCart" runat="server" Text="カートに追加" CssClass="btn btn-primary"
                        CommandArgument='&lt;%# Eval("ProductId") %&gt;' OnCommand="btnAddToCart_Command" /&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/ItemTemplate&gt;
&lt;/asp:DataList&gt;

' Repeater の使用例（最も柔軟）
&lt;asp:Repeater ID="rptProducts" runat="server"&gt;
    &lt;HeaderTemplate&gt;
        &lt;div class="row"&gt;
    &lt;/HeaderTemplate&gt;
    &lt;ItemTemplate&gt;
        &lt;div class="col-lg-3 col-md-4 col-sm-6 mb-4"&gt;
            &lt;div class="card product-card h-100"&gt;
                &lt;div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;"&gt;
                    &lt;i class="fas fa-box fa-3x text-muted"&gt;&lt;/i&gt;
                &lt;/div&gt;
                &lt;div class="card-body d-flex flex-column"&gt;
                    &lt;h6 class="card-title"&gt;&lt;%# Eval("ProductName") %&gt;&lt;/h6&gt;
                    &lt;p class="card-text flex-grow-1"&gt;
                        &lt;small class="text-muted"&gt;&lt;%# Eval("Category") %&gt;&lt;/small&gt;
                    &lt;/p&gt;
                    &lt;div class="d-flex justify-content-between align-items-center"&gt;
                        &lt;strong class="text-primary"&gt;¥&lt;%# Eval("Price", "{0:N0}") %&gt;&lt;/strong&gt;
                        &lt;small class="text-muted"&gt;在庫: &lt;%# Eval("Stock") %&gt;&lt;/small&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class="card-footer p-2"&gt;
                    &lt;div class="btn-group w-100" role="group"&gt;
                        &lt;button type="button" class="btn btn-outline-primary btn-sm" 
                            onclick="viewProduct(&lt;%# Eval("ProductId") %&gt;)"&gt;詳細&lt;/button&gt;
                        &lt;asp:Button ID="btnQuickAdd" runat="server" Text="追加" CssClass="btn btn-primary btn-sm"
                            CommandName="AddToCart" CommandArgument='&lt;%# Eval("ProductId") %&gt;' /&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/ItemTemplate&gt;
    &lt;AlternatingItemTemplate&gt;
        &lt;div class="col-lg-3 col-md-4 col-sm-6 mb-4"&gt;
            &lt;div class="card product-card h-100 border-info"&gt;
                &lt;!-- AlternatingItemTemplate の内容 --&gt;
                &lt;div class="card-img-top bg-info-light d-flex align-items-center justify-content-center" style="height: 200px;"&gt;
                    &lt;i class="fas fa-star fa-3x text-info"&gt;&lt;/i&gt;
                &lt;/div&gt;
                &lt;div class="card-body d-flex flex-column"&gt;
                    &lt;h6 class="card-title text-info"&gt;⭐ &lt;%# Eval("ProductName") %&gt;&lt;/h6&gt;
                    &lt;p class="card-text flex-grow-1"&gt;
                        &lt;small class="text-muted"&gt;&lt;%# Eval("Category") %&gt;&lt;/small&gt;
                    &lt;/p&gt;
                    &lt;div class="d-flex justify-content-between align-items-center"&gt;
                        &lt;strong class="text-info"&gt;¥&lt;%# Eval("Price", "{0:N0}") %&gt;&lt;/strong&gt;
                        &lt;small class="text-muted"&gt;在庫: &lt;%# Eval("Stock") %&gt;&lt;/small&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class="card-footer p-2"&gt;
                    &lt;div class="btn-group w-100" role="group"&gt;
                        &lt;button type="button" class="btn btn-outline-info btn-sm" 
                            onclick="viewProduct(&lt;%# Eval("ProductId") %&gt;)"&gt;詳細&lt;/button&gt;
                        &lt;asp:Button ID="btnQuickAddAlt" runat="server" Text="追加" CssClass="btn btn-info btn-sm"
                            CommandName="AddToCart" CommandArgument='&lt;%# Eval("ProductId") %&gt;' /&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/AlternatingItemTemplate&gt;
    &lt;FooterTemplate&gt;
        &lt;/div&gt;
    &lt;/FooterTemplate&gt;
&lt;/asp:Repeater&gt;

' VB.NET コードでのイベント処理
Protected Sub rptProducts_ItemCommand(source As Object, e As RepeaterCommandEventArgs) Handles rptProducts.ItemCommand
    If e.CommandName = "AddToCart" Then
        Dim productId As Integer = Integer.Parse(e.CommandArgument.ToString())
        AddToShoppingCart(productId)
    End If
End Sub

Private Sub AddToShoppingCart(productId As Integer)
    ' VB.NET Session 状態管理の活用
    Dim cart As List(Of Integer) = TryCast(Session("ShoppingCart"), List(Of Integer))
    
    If cart Is Nothing Then
        cart = New List(Of Integer)()
    End If
    
    cart.Add(productId)
    Session("ShoppingCart") = cart
    
    ShowMessage($"商品をカートに追加しました。カート内商品数: {cart.Count}", "alert alert-success")
End Sub</code></pre>

                    <h3 class="section-title">7.5 データ表示の最適化</h3>
                    <p>大量データを効率的に表示するためのテクニックを学習します。</p>

                    <div class="warning">
                        <h6>⚠️ パフォーマンス考慮事項</h6>
                        <ul>
                            <li><strong>大量データ</strong>: 適切なページングサイズの設定</li>
                            <li><strong>ViewState</strong>: 不要な場合は EnableViewState="false" に設定</li>
                            <li><strong>データソース</strong>: 必要な列のみを取得</li>
                            <li><strong>キャッシュ活用</strong>: 頻繁に使用されるデータはキャッシュ</li>
                        </ul>
                    </div>

                    <pre><code>' パフォーマンス最適化の例
Protected Sub BindProductsOptimized()
    ' キャッシュからデータを取得、なければデータベースから読み込み
    Dim cacheKey As String = $"Products_{txtSearch.Text}_{ddlCategoryFilter.SelectedValue}"
    Dim products As List(Of Product) = TryCast(Cache(cacheKey), List(Of Product))
    
    If products Is Nothing Then
        products = GetProductsFromDatabase()
        
        ' 5分間キャッシュ
        Cache.Insert(cacheKey, products, Nothing, 
                    DateTime.Now.AddMinutes(5), 
                    TimeSpan.Zero)
    End If
    
    ' クライアントサイドでのソート・フィルタリングのためのJavaScript
    RegisterClientScriptForSorting()
    
    gvProducts.DataSource = products
    gvProducts.DataBind()
End Sub

' クライアントサイド機能の追加
Private Sub RegisterClientScriptForSorting()
    Dim script As String = "
    function sortTable(columnIndex, dataType) {
        // JavaScript でのテーブルソート実装
        var table = document.querySelector('#gvProducts');
        var rows = Array.from(table.querySelectorAll('tbody tr'));
        
        rows.sort(function(a, b) {
            var aVal = a.cells[columnIndex].textContent.trim();
            var bVal = b.cells[columnIndex].textContent.trim();
            
            if (dataType === 'number') {
                return parseFloat(aVal) - parseFloat(bVal);
            } else {
                return aVal.localeCompare(bVal);
            }
        });
        
        var tbody = table.querySelector('tbody');
        rows.forEach(function(row) {
            tbody.appendChild(row);
        });
    }
    
    function filterTable() {
        var searchText = document.getElementById('txtSearch').value.toLowerCase();
        var table = document.querySelector('#gvProducts');
        var rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(function(row) {
            var text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchText) ? '' : 'none';
        });
    }"
    
    ClientScript.RegisterClientScriptBlock(Me.GetType(), "TableUtils", script, True)
End Sub</code></pre>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>データとコントロールを自動的に連携させる仕組みを何と呼びますか？</li>
                            <li>表形式でデータを表示する最も一般的なコントロールは何ですか？</li>
                            <li>完全にカスタマイズ可能なデータ表示コントロールは何ですか？</li>
                            <li>GridViewでページング機能を有効にするプロパティは何ですか？</li>
                            <li>GridViewでソート機能を有効にするプロパティは何ですか？</li>
                            <li>GridViewで編集モードに入るためのCommandNameは何ですか？</li>
                            <li>VB.NETでコレクションをフィルタリングするLINQメソッドは何ですか？</li>
                            <li>大量データ表示時のパフォーマンス向上のために使用する仕組みは何ですか？</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>データバインディング</li>
                                <li>GridView</li>
                                <li>Repeater</li>
                                <li>AllowPaging</li>
                                <li>AllowSorting</li>
                                <li>Edit</li>
                                <li>Where</li>
                                <li>キャッシュ</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-6.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-8.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>