<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET VB.NET学習教材 第5章 - 状態管理（Session、ViewState、Cache）</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0078d4;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0078d4;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #2196F3;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0078d4;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0078d4 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        .state-diagram {
            background-color: #f8f9fa;
            border: 2px solid #0078d4;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../README.md">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">ASP.NET VB.NET学習ガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: Web Forms入門</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: Webコントロール</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">第3章: イベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">第4章: データ検証</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter5">第5章: 状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">第6章: データベース連携</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">第7章: データバインド</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: マスターページ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-9.html">第9章: セキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-10.html">第10章: 実践開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第5章: 状態管理（Session、ViewState、Cache）</h1>
                </div>

                <div id="chapter5">
                    <h2 class="chapter-title">状態管理（Session、ViewState、Cache）</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Webアプリケーションの「状態なし」の特性と状態管理の必要性を理解する</li>
                            <li>ViewState、Session、Application状態の違いと使い分けを習得する</li>
                            <li>Cacheオブジェクトを使用したパフォーマンス向上手法を学習する</li>
                            <li>VB.NETの変数スコープとWeb Forms状態管理の違いを体験する</li>
                            <li>実用的なショッピングカート機能を実装する</li>
                        </ul>
                    </div>

                    <h3 class="section-title">5.1 Webアプリケーションの状態管理とは</h3>
                    <p>HTTPプロトコルは「状態なし（ステートレス）」のため、リクエスト間で情報を保持するための仕組みが必要です。</p>

                    <div class="state-diagram">
                        <h5>📊 状態管理の比較</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>状態管理方法</th>
                                        <th>スコープ</th>
                                        <th>生存期間</th>
                                        <th>VB.NETとの類似点</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>ViewState</strong></td>
                                        <td>ページ内のコントロール</td>
                                        <td>そのページのみ</td>
                                        <td>ローカル変数</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Session</strong></td>
                                        <td>ユーザーセッション</td>
                                        <td>セッション終了まで</td>
                                        <td>インスタンス変数</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Application</strong></td>
                                        <td>アプリケーション全体</td>
                                        <td>アプリケーション終了まで</td>
                                        <td>Shared変数</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Cache</strong></td>
                                        <td>アプリケーション全体</td>
                                        <td>設定可能（期限、依存関係）</td>
                                        <td>Static変数 + 期限管理</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <h3 class="section-title">5.2 ViewState</h3>
                    <p>ViewStateは、コントロールの状態をPostBack間で保持する仕組みです。</p>

                    <pre class="code-block"><code class="language-vbnet">' ViewStateの基本的な使用
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    If Not IsPostBack Then
        ' 初期データの設定
        ViewState("VisitCount") = 0
        ViewState("StartTime") = DateTime.Now
    End If
End Sub

Protected Sub btnIncrement_Click(sender As Object, e As EventArgs)
    ' ViewStateから値を取得して更新
    Dim count As Integer = CInt(ViewState("VisitCount"))
    count += 1
    ViewState("VisitCount") = count
    
    lblCount.Text = $"クリック回数: {count}"
    
    ' 複雑なオブジェクトも保存可能
    Dim userData As New Dictionary(Of String, String)()
    userData.Add("LastAction", "Increment")
    userData.Add("Timestamp", DateTime.Now.ToString())
    ViewState("UserData") = userData
End Sub

' ViewStateサイズの確認
Protected Sub btnCheckViewStateSize_Click(sender As Object, e As EventArgs)
    Dim viewStateSize As Integer = Page.ViewState.ToString().Length
    lblViewStateInfo.Text = $"ViewStateサイズ: {viewStateSize} 文字"
End Sub</code></pre>

                    <h3 class="section-title">5.3 Session状態</h3>
                    <p>Sessionは、特定のユーザーのセッション期間中にデータを保持します。</p>

                    <pre class="code-block"><code class="language-vbnet">' Session状態の管理
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    ' セッション情報の初期化
    If Session("UserName") Is Nothing Then
        Session("UserName") = "ゲスト"
        Session("LoginTime") = DateTime.Now
        Session("PageViews") = 0
    End If
    
    ' ページビュー数のカウント
    Dim pageViews As Integer = CInt(Session("PageViews"))
    pageViews += 1
    Session("PageViews") = pageViews
    
    UpdateSessionInfo()
End Sub

Private Sub UpdateSessionInfo()
    lblUserName.Text = Session("UserName").ToString()
    lblLoginTime.Text = $"ログイン時刻: {Session("LoginTime")}"
    lblPageViews.Text = $"ページビュー: {Session("PageViews")}"
    lblSessionId.Text = $"セッションID: {Session.SessionID}"
End Sub

Protected Sub btnSetUserName_Click(sender As Object, e As EventArgs)
    If Not String.IsNullOrWhiteSpace(txtUserName.Text) Then
        Session("UserName") = txtUserName.Text.Trim()
        UpdateSessionInfo()
        lblMessage.Text = "ユーザー名が設定されました"
    End If
End Sub

Protected Sub btnClearSession_Click(sender As Object, e As EventArgs)
    Session.Clear() ' すべてのセッション変数をクリア
    ' または Session.Abandon() ' セッションを完全に破棄
    lblMessage.Text = "セッションがクリアされました"
End Sub

' セッションタイムアウトの設定（web.configまたはコード）
Protected Sub btnSetTimeout_Click(sender As Object, e As EventArgs)
    Session.Timeout = 30 ' 30分でタイムアウト
    lblMessage.Text = $"セッションタイムアウトを{Session.Timeout}分に設定しました"
End Sub</code></pre>

                    <h3 class="section-title">5.4 Application状態</h3>
                    <p>Application状態は、全ユーザー間で共有されるアプリケーション レベルのデータです。</p>

                    <pre class="code-block"><code class="language-vbnet">' Application状態の管理
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    ' アプリケーション レベルのカウンター
    Application.Lock() ' 同時アクセスを制御
    Try
        If Application("TotalVisitors") Is Nothing Then
            Application("TotalVisitors") = 0
        End If
        
        Dim totalVisitors As Integer = CInt(Application("TotalVisitors"))
        totalVisitors += 1
        Application("TotalVisitors") = totalVisitors
        
        lblTotalVisitors.Text = $"総訪問者数: {totalVisitors}"
    Finally
        Application.UnLock()
    End Try
    
    ' アプリケーション開始時刻の表示
    If Application("StartTime") IsNot Nothing Then
        lblAppStartTime.Text = $"アプリケーション開始時刻: {Application("StartTime")}"
    End If
End Sub

' Global.asax.vbでのアプリケーション レベルイベント
Sub Application_Start(ByVal sender As Object, ByVal e As EventArgs)
    ' アプリケーション開始時に実行
    Application("StartTime") = DateTime.Now
    Application("TotalVisitors") = 0
    
    ' アプリケーション レベルの設定
    Application("Version") = "1.0.0"
    Application("SiteName") = "VB.NET Web Forms学習サイト"
End Sub

Protected Sub btnShowAppInfo_Click(sender As Object, e As EventArgs)
    Dim appInfo As New System.Text.StringBuilder()
    appInfo.AppendLine($"アプリケーション名: {Application("SiteName")}")
    appInfo.AppendLine($"バージョン: {Application("Version")}")
    appInfo.AppendLine($"開始時刻: {Application("StartTime")}")
    appInfo.AppendLine($"総訪問者数: {Application("TotalVisitors")}")
    
    lblAppInfo.Text = appInfo.ToString().Replace(Environment.NewLine, "<br/>")
End Sub</code></pre>

                    <h3 class="section-title">5.5 Cacheオブジェクト</h3>
                    <p>Cacheは、高パフォーマンスなデータストレージを提供し、期限やファイル依存関係を設定できます。</p>

                    <pre class="code-block"><code class="language-vbnet">' Cacheオブジェクトの基本使用
Protected Sub btnCacheData_Click(sender As Object, e As EventArgs)
    Dim expensiveData As String = GenerateExpensiveData()
    
    ' 絶対期限でキャッシュ（10分後に期限切れ）
    Cache.Insert("ExpensiveData", expensiveData, Nothing, 
                DateTime.Now.AddMinutes(10), 
                TimeSpan.Zero)
    
    lblMessage.Text = "データがキャッシュに保存されました（10分間有効）"
End Sub

Protected Sub btnGetCachedData_Click(sender As Object, e As EventArgs)
    Dim cachedData As String = TryCast(Cache("ExpensiveData"), String)
    
    If cachedData IsNot Nothing Then
        lblCachedData.Text = $"キャッシュからのデータ: {cachedData}"
        lblMessage.Text = "キャッシュからデータを取得しました"
    Else
        ' キャッシュにない場合は再生成
        Dim newData As String = GenerateExpensiveData()
        Cache.Insert("ExpensiveData", newData, Nothing, 
                    DateTime.Now.AddMinutes(10), 
                    TimeSpan.Zero)
        
        lblCachedData.Text = $"新規生成データ: {newData}"
        lblMessage.Text = "データを再生成してキャッシュに保存しました"
    End If
End Sub

Private Function GenerateExpensiveData() As String
    ' 重い処理のシミュレーション
    System.Threading.Thread.Sleep(1000) ' 1秒待機
    Return $"処理済みデータ - 生成時刻: {DateTime.Now:HH:mm:ss}"
End Function

' ファイル依存関係のあるキャッシュ
Protected Sub btnCacheWithFileDependency_Click(sender As Object, e As EventArgs)
    Dim configFilePath As String = Server.MapPath("~/App_Data/config.txt")
    
    ' ファイルが変更されたらキャッシュを無効化
    Dim fileDependency As New System.Web.Caching.CacheDependency(configFilePath)
    
    Dim configData As String = File.ReadAllText(configFilePath)
    Cache.Insert("ConfigData", configData, fileDependency)
    
    lblMessage.Text = "設定ファイルの内容がキャッシュされました（ファイル変更で自動更新）"
End Sub

' スライディング期限（最後のアクセスから指定時間でキャッシュ期限切れ）
Protected Sub btnSlidingCache_Click(sender As Object, e As EventArgs)
    Dim userData As String = "ユーザーデータ"
    
    ' 最後のアクセスから5分後に期限切れ
    Cache.Insert("UserData", userData, Nothing, 
                Cache.NoAbsoluteExpiration,
                TimeSpan.FromMinutes(5))
    
    lblMessage.Text = "スライディング期限キャッシュを設定しました（最終アクセスから5分）"
End Sub</code></pre>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 5-1: ショッピングカートシステム</h5>
                        <p>Session状態を活用して、本格的なショッピングカート機能を実装しましょう。</p>

                        <h6>ShoppingCart.aspx（マークアップ）</h6>
                        <pre class="code-block"><code class="language-html">&lt;%@ Page Title="ショッピングカート" Language="VB" MasterPageFile="~/Site.Master" AutoEventWireup="true" CodeBehind="ShoppingCart.aspx.vb" Inherits="HelloWorldWebApp.ShoppingCart" %&gt;

&lt;asp:Content ID="BodyContent" ContentPlaceHolderID="MainContent" runat="server"&gt;
    &lt;div class="container mt-4"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-md-8"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-success text-white"&gt;
                        &lt;h3 class="card-title mb-0"&gt;商品一覧&lt;/h3&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;div class="row" id="productList"&gt;
                            &lt;asp:Repeater ID="rptProducts" runat="server"&gt;
                                &lt;ItemTemplate&gt;
                                    &lt;div class="col-md-6 mb-3"&gt;
                                        &lt;div class="card h-100"&gt;
                                            &lt;div class="card-body"&gt;
                                                &lt;h5 class="card-title"&gt;&lt;%# Eval("Name") %&gt;&lt;/h5&gt;
                                                &lt;p class="card-text"&gt;&lt;%# Eval("Description") %&gt;&lt;/p&gt;
                                                &lt;p class="card-text"&gt;&lt;strong&gt;価格: ¥&lt;%# Eval("Price", "{0:N0}") %&gt;&lt;/strong&gt;&lt;/p&gt;
                                                &lt;p class="card-text"&gt;&lt;small class="text-muted"&gt;在庫: &lt;%# Eval("Stock") %&gt;個&lt;/small&gt;&lt;/p&gt;
                                                &lt;div class="d-flex align-items-center"&gt;
                                                    &lt;asp:TextBox ID="txtQuantity" runat="server" Text="1" CssClass="form-control me-2" style="width: 80px;" TextMode="Number" min="1"&gt;&lt;/asp:TextBox&gt;
                                                    &lt;asp:Button ID="btnAddToCart" runat="server" Text="カートに追加" CssClass="btn btn-primary" 
                                                        CommandName="AddToCart" CommandArgument='&lt;%# Eval("Id") %&gt;' /&gt;
                                                &lt;/div&gt;
                                            &lt;/div&gt;
                                        &lt;/div&gt;
                                    &lt;/div&gt;
                                &lt;/ItemTemplate&gt;
                            &lt;/asp:Repeater&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="col-md-4"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-info text-white"&gt;
                        &lt;h4 class="card-title mb-0"&gt;ショッピングカート&lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;asp:UpdatePanel ID="UpdatePanel1" runat="server"&gt;
                            &lt;ContentTemplate&gt;
                                &lt;asp:GridView ID="gvCart" runat="server" CssClass="table table-sm" AutoGenerateColumns="false" EmptyDataText="カートは空です"&gt;
                                    &lt;Columns&gt;
                                        &lt;asp:BoundField DataField="Name" HeaderText="商品名" /&gt;
                                        &lt;asp:BoundField DataField="Quantity" HeaderText="数量" /&gt;
                                        &lt;asp:BoundField DataField="Price" HeaderText="単価" DataFormatString="{0:C}" /&gt;
                                        &lt;asp:BoundField DataField="Total" HeaderText="小計" DataFormatString="{0:C}" /&gt;
                                        &lt;asp:TemplateField&gt;
                                            &lt;ItemTemplate&gt;
                                                &lt;asp:Button ID="btnRemove" runat="server" Text="削除" CssClass="btn btn-sm btn-outline-danger"
                                                    CommandName="Remove" CommandArgument='&lt;%# Eval("Id") %&gt;' /&gt;
                                            &lt;/ItemTemplate&gt;
                                        &lt;/asp:TemplateField&gt;
                                    &lt;/Columns&gt;
                                &lt;/asp:GridView&gt;
                                
                                &lt;hr&gt;
                                &lt;div class="d-flex justify-content-between"&gt;
                                    &lt;strong&gt;合計: &lt;/strong&gt;
                                    &lt;strong&gt;&lt;asp:Label ID="lblTotal" runat="server" Text="¥0"&gt;&lt;/asp:Label&gt;&lt;/strong&gt;
                                &lt;/div&gt;
                                
                                &lt;div class="mt-3"&gt;
                                    &lt;asp:Button ID="btnClearCart" runat="server" Text="カートをクリア" CssClass="btn btn-outline-secondary w-100 mb-2" /&gt;
                                    &lt;asp:Button ID="btnCheckout" runat="server" Text="購入手続きへ" CssClass="btn btn-success w-100" /&gt;
                                &lt;/div&gt;
                            &lt;/ContentTemplate&gt;
                        &lt;/asp:UpdatePanel&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;!-- セッション情報 --&gt;
                &lt;div class="card mt-3"&gt;
                    &lt;div class="card-header bg-secondary text-white"&gt;
                        &lt;h6 class="card-title mb-0"&gt;セッション情報&lt;/h6&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;small&gt;
                            &lt;asp:Label ID="lblSessionInfo" runat="server"&gt;&lt;/asp:Label&gt;
                        &lt;/small&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;!-- メッセージ表示 --&gt;
        &lt;div class="row mt-3"&gt;
            &lt;div class="col-12"&gt;
                &lt;asp:Label ID="lblMessage" runat="server" Text=""&gt;&lt;/asp:Label&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/asp:Content&gt;</code></pre>

                        <h6>ShoppingCart.aspx.vb（コードビハインド）</h6>
                        <pre class="code-block"><code class="language-vbnet">Public Class ShoppingCart
    Inherits System.Web.UI.Page

    ' 商品データクラス
    Public Class Product
        Public Property Id As Integer
        Public Property Name As String
        Public Property Description As String
        Public Property Price As Decimal
        Public Property Stock As Integer
    End Class

    ' カートアイテムクラス
    Public Class CartItem
        Public Property Id As Integer
        Public Property Name As String
        Public Property Price As Decimal
        Public Property Quantity As Integer
        Public ReadOnly Property Total As Decimal
            Get
                Return Price * Quantity
            End Get
        End Property
    End Class

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not IsPostBack Then
            LoadProducts()
            InitializeSession()
        End If
        
        UpdateCartDisplay()
        UpdateSessionInfo()
    End Sub

    Private Sub LoadProducts()
        ' サンプル商品データ（実際のシステムではデータベースから取得）
        Dim products As New List(Of Product) From {
            New Product With {.Id = 1, .Name = "VB.NET入門書", .Description = "初心者向けVB.NETプログラミング本", .Price = 3500, .Stock = 10},
            New Product With {.Id = 2, .Name = "ASP.NET完全ガイド", .Description = "Web開発の決定版", .Price = 4200, .Stock = 8},
            New Product With {.Id = 3, .Name = "データベース設計本", .Description = "実践的なDB設計手法", .Price = 3800, .Stock = 15},
            New Product With {.Id = 4, .Name = "プログラミング マウス", .Description = "プログラマー専用マウス", .Price = 2800, .Stock = 20}
        }
        
        rptProducts.DataSource = products
        rptProducts.DataBind()
        
        ' 商品データをCacheに保存（実際のアプリケーションでは有効期限を設定）
        Cache("Products") = products
    End Sub

    Private Sub InitializeSession()
        If Session("Cart") Is Nothing Then
            Session("Cart") = New List(Of CartItem)()
        End If
        
        If Session("SessionStartTime") Is Nothing Then
            Session("SessionStartTime") = DateTime.Now
        End If
    End Sub

    Protected Sub rptProducts_ItemCommand(source As Object, e As RepeaterCommandEventArgs) Handles rptProducts.ItemCommand
        If e.CommandName = "AddToCart" Then
            Dim productId As Integer = Integer.Parse(e.CommandArgument.ToString())
            Dim quantityTextBox As TextBox = DirectCast(e.Item.FindControl("txtQuantity"), TextBox)
            Dim quantity As Integer = Integer.Parse(quantityTextBox.Text)
            
            AddToCart(productId, quantity)
        End If
    End Sub

    Protected Sub gvCart_RowCommand(sender As Object, e As GridViewCommandEventArgs) Handles gvCart.RowCommand
        If e.CommandName = "Remove" Then
            Dim productId As Integer = Integer.Parse(e.CommandArgument.ToString())
            RemoveFromCart(productId)
        End If
    End Sub

    Protected Sub btnClearCart_Click(sender As Object, e As EventArgs) Handles btnClearCart.Click
        Session("Cart") = New List(Of CartItem)()
        UpdateCartDisplay()
        ShowMessage("カートをクリアしました", "alert alert-info")
    End Sub

    Protected Sub btnCheckout_Click(sender As Object, e As EventArgs) Handles btnCheckout.Click
        Dim cart As List(Of CartItem) = GetCartFromSession()
        
        If cart.Count = 0 Then
            ShowMessage("カートが空です", "alert alert-warning")
            Return
        End If
        
        ' 購入処理のシミュレーション
        ProcessCheckout(cart)
    End Sub

    Private Sub AddToCart(productId As Integer, quantity As Integer)
        Try
            Dim products As List(Of Product) = GetProductsFromCache()
            Dim product As Product = products.FirstOrDefault(Function(p) p.Id = productId)
            
            If product Is Nothing Then
                ShowMessage("商品が見つかりません", "alert alert-danger")
                Return
            End If
            
            If quantity > product.Stock Then
                ShowMessage($"在庫が不足しています。在庫数: {product.Stock}", "alert alert-warning")
                Return
            End If
            
            Dim cart As List(Of CartItem) = GetCartFromSession()
            Dim existingItem As CartItem = cart.FirstOrDefault(Function(c) c.Id = productId)
            
            If existingItem IsNot Nothing Then
                ' 既存アイテムの数量を更新
                If existingItem.Quantity + quantity > product.Stock Then
                    ShowMessage($"在庫が不足しています。現在のカート数量: {existingItem.Quantity}, 在庫数: {product.Stock}", "alert alert-warning")
                    Return
                End If
                existingItem.Quantity += quantity
            Else
                ' 新しいアイテムを追加
                cart.Add(New CartItem With {
                    .Id = product.Id,
                    .Name = product.Name,
                    .Price = product.Price,
                    .Quantity = quantity
                })
            End If
            
            Session("Cart") = cart
            UpdateCartDisplay()
            ShowMessage($"{product.Name} を {quantity} 個カートに追加しました", "alert alert-success")
            
        Catch ex As Exception
            ShowMessage($"エラーが発生しました: {ex.Message}", "alert alert-danger")
        End Try
    End Sub

    Private Sub RemoveFromCart(productId As Integer)
        Dim cart As List(Of CartItem) = GetCartFromSession()
        Dim item As CartItem = cart.FirstOrDefault(Function(c) c.Id = productId)
        
        If item IsNot Nothing Then
            cart.Remove(item)
            Session("Cart") = cart
            UpdateCartDisplay()
            ShowMessage($"{item.Name} をカートから削除しました", "alert alert-info")
        End If
    End Sub

    Private Sub ProcessCheckout(cart As List(Of CartItem))
        Try
            Dim total As Decimal = cart.Sum(Function(c) c.Total)
            
            ' 実際のシステムでは、ここで決済処理、在庫更新、注文データベース保存等を行う
            Dim orderSummary As New System.Text.StringBuilder()
            orderSummary.AppendLine("<h5>注文内容確認</h5>")
            orderSummary.AppendLine("<ul>")
            
            For Each item As CartItem In cart
                orderSummary.AppendLine($"<li>{item.Name} × {item.Quantity} = ¥{item.Total:N0}</li>")
            Next
            
            orderSummary.AppendLine("</ul>")
            orderSummary.AppendLine($"<strong>合計金額: ¥{total:N0}</strong>")
            
            ' カートをクリア
            Session("Cart") = New List(Of CartItem)()
            UpdateCartDisplay()
            
            ShowMessage($"購入手続きが完了しました！<br/>{orderSummary.ToString()}", "alert alert-success")
            
        Catch ex As Exception
            ShowMessage($"購入処理中にエラーが発生しました: {ex.Message}", "alert alert-danger")
        End Try
    End Sub

    Private Function GetCartFromSession() As List(Of CartItem)
        If Session("Cart") Is Nothing Then
            Session("Cart") = New List(Of CartItem)()
        End If
        Return DirectCast(Session("Cart"), List(Of CartItem))
    End Function

    Private Function GetProductsFromCache() As List(Of Product)
        Dim products As List(Of Product) = TryCast(Cache("Products"), List(Of Product))
        If products Is Nothing Then
            ' Cacheにない場合は再読込
            LoadProducts()
            products = DirectCast(Cache("Products"), List(Of Product))
        End If
        Return products
    End Function

    Private Sub UpdateCartDisplay()
        Dim cart As List(Of CartItem) = GetCartFromSession()
        
        gvCart.DataSource = cart
        gvCart.DataBind()
        
        Dim total As Decimal = cart.Sum(Function(c) c.Total)
        lblTotal.Text = $"¥{total:N0}"
    End Sub

    Private Sub UpdateSessionInfo()
        Dim info As New System.Text.StringBuilder()
        info.AppendLine($"セッションID: {Session.SessionID}<br/>")
        info.AppendLine($"開始時刻: {Session("SessionStartTime"):HH:mm:ss}<br/>")
        info.AppendLine($"タイムアウト: {Session.Timeout}分<br/>")
        
        Dim cart As List(Of CartItem) = GetCartFromSession()
        info.AppendLine($"カート商品数: {cart.Sum(Function(c) c.Quantity)}個")
        
        lblSessionInfo.Text = info.ToString()
    End Sub

    Private Sub ShowMessage(message As String, cssClass As String)
        lblMessage.Text = message
        lblMessage.CssClass = cssClass
    End Sub
End Class</code></pre>
                    </div>

                    <h3 class="section-title">5.6 状態管理のベストプラクティス</h3>
                    <p>効果的な状態管理のための指針を学習しましょう。</p>

                    <div class="warning">
                        <h6>⚠️ 状態管理の注意点</h6>
                        <ul>
                            <li><strong>ViewState</strong>: 大量のデータを保存するとページサイズが増大</li>
                            <li><strong>Session</strong>: メモリ使用量に注意、セッションタイムアウトの設定</li>
                            <li><strong>Application</strong>: 同時アクセス制御（Lock/UnLock）が必要</li>
                            <li><strong>Cache</strong>: メモリ効率を考慮した適切な期限設定</li>
                        </ul>
                    </div>

                    <h4>パフォーマンス最適化</h4>
                    <pre class="code-block"><code class="language-vbnet">' ViewStateの無効化（必要に応じて）
&lt;asp:Label ID="lblStaticText" runat="server" EnableViewState="false" /&gt;

' Sessionのタイムアウト設定
&lt;system.web&gt;
    &lt;sessionState timeout="20" /&gt; &lt;!-- 20分でタイムアウト --&gt;
&lt;/system.web&gt;

' Cacheの効率的な使用
Private Function GetExpensiveData() As DataTable
    Dim cacheKey As String = "ExpensiveData"
    Dim data As DataTable = TryCast(Cache(cacheKey), DataTable)
    
    If data Is Nothing Then
        ' データが存在しない場合のみ重い処理を実行
        data = LoadDataFromDatabase()
        
        ' 30分でキャッシュ期限切れ、ファイル変更で無効化
        Dim dependency As New CacheDependency(Server.MapPath("~/App_Data/data.xml"))
        Cache.Insert(cacheKey, data, dependency, 
                    DateTime.Now.AddMinutes(30), 
                    TimeSpan.Zero)
    End If
    
    Return data
End Function</code></pre>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>ページ内のコントロール状態をPostBack間で保持する仕組みは何ですか？</li>
                            <li>特定のユーザーのセッション期間中にデータを保持する仕組みは何ですか？</li>
                            <li>全ユーザー間で共有されるアプリケーション レベルのデータ管理は何ですか？</li>
                            <li>期限や依存関係を設定できる高パフォーマンスなデータストレージは何ですか？</li>
                            <li>Sessionのデータをすべてクリアするメソッドは何ですか？</li>
                            <li>Applicationオブジェクトに同時アクセスを制御するメソッドのペアは何ですか？</li>
                            <li>VB.NETのローカル変数に相当するWeb Forms状態管理は何ですか？</li>
                            <li>Cacheでファイル変更を監視する依存関係オブジェクトは何ですか？</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>ViewState</li>
                                <li>Session</li>
                                <li>Application</li>
                                <li>Cache</li>
                                <li>Session.Clear() または Session.Abandon()</li>
                                <li>Application.Lock() と Application.UnLock()</li>
                                <li>ViewState</li>
                                <li>CacheDependency</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-4.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-6.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>