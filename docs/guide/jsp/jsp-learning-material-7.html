<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSP/Servlet初心者向け学習教材 - 第7章: セッションとスコープ</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        .navbar {
            background-color: #1565c0;
        }
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        .chapter-title {
            color: #1565c0;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #1565c0;
            padding-bottom: 0.5rem;
        }
        .section-title {
            color: #1976d2;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        code {
            display: block;
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            white-space: pre;
            overflow-x: auto;
        }
        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        .quiz-question {
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .diagram {
            max-width: 100%;
            height: auto;
            margin: 1.5rem 0;
            text-align: center;
        }
        .exercise {
            background-color: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1.5rem 0;
        }
        .note {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 1rem;
            margin: 1.5rem 0;
        }
        #table-of-contents .list-group-item {
            border: none;
            padding: 0.5rem 1rem;
        }
        #table-of-contents .list-group-item-action {
            color: #1976d2;
        }
        /* 選択された目次項目のスタイル */
        #table-of-contents .list-group-item-action.active,
        .list-group-item.active {
            color: white !important; /* テキストを白色にして青い背景に対してコントラストをつける */
            background-color: #1976d2;
            border-color: #1976d2;
        }
        .section-nav {
            padding-left: 1rem;
        }
        .inline-code {
            background-color: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            display: inline;
        }
        footer {
            background-color: #1565c0;
            color: white;
            padding: 1rem 0;
            margin-top: 3rem;
        }
        .table-example {
            width: 100%;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        .table-example th {
            background-color: #e3f2fd;
            border: 1px solid #b3e5fc;
            padding: 0.5rem;
            text-align: center;
        }
        .table-example td {
            border: 1px solid #b3e5fc;
            padding: 0.5rem;
            text-align: center;
        }
        .example-result {
            background-color: #f1f8e9;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .warning {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 1rem;
            margin: 1.5rem 0;
        }
    </style>
</head>
<body data-bs-spy="scroll" data-bs-target="#tableOfContents">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">JSP/Servlet初心者向け学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#introduction">はじめに</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#chapter7">第7章: セッションとスコープ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row">
            <!-- Sidebar - Table of Contents -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">目次</h5>
                        </div>
                        <div id="table-of-contents" class="list-group list-group-flush">
                            <a href="#introduction" class="list-group-item list-group-item-action">はじめに</a>
                            <a href="#chapter7" class="list-group-item list-group-item-action">第7章: セッションとスコープ</a>
                            <div class="section-nav">
                                <a href="#scope-intro" class="list-group-item list-group-item-action">7.1 スコープの概念</a>
                                <a href="#scope-types" class="list-group-item list-group-item-action">7.2 スコープの種類</a>
                                <a href="#session-management" class="list-group-item list-group-item-action">7.3 セッション管理</a>
                                <a href="#session-attributes" class="list-group-item list-group-item-action">7.4 セッション属性</a>
                                <a href="#login-example" class="list-group-item list-group-item-action">7.5 ログイン機能の実装例</a>
                                <a href="#best-practices" class="list-group-item list-group-item-action">7.6 セッション管理のベストプラクティス</a>
                                <a href="#chapter7-quiz" class="list-group-item list-group-item-action">7.7 理解度確認テスト</a>
                            </div>
                            <a href="#next-steps" class="list-group-item list-group-item-action">次のステップ</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-lg-9">
                <section id="introduction">
                    <h1 class="display-5 mb-4">JSP/Servlet初心者向け学習教材</h1>
                    <p class="lead">この第7章では、Webアプリケーションにおけるセッション管理とスコープの概念について学習します。ユーザー認証やショッピングカートなど、状態を保持する機能の実装に必須の知識を身につけましょう。</p>

                    <div class="note">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Webアプリケーションにおけるスコープの概念と種類</li>
                            <li>セッション管理の基本とライフサイクル</li>
                            <li>セッション属性の設定と取得</li>
                            <li>ログイン認証の実装方法</li>
                            <li>セッション管理のセキュリティと最適化</li>
                        </ul>
                    </div>
                </section>

                <section id="chapter7">
                    <h2 class="chapter-title">第7章：セッションとスコープ</h2>
                    <p>HTTPはステートレス（無状態）なプロトコルであるため、Webアプリケーションで状態を保持するには特別な仕組みが必要です。この章では、JSP/Servletでデータを保持するためのスコープの概念とセッション管理について学びます。</p>

                    <section id="scope-intro">
                        <h3 class="section-title">7.1 スコープの概念</h3>
                        <p>Webアプリケーションでは、データを保持する「スコープ」という概念があります。スコープとは、データの有効範囲（生存期間と利用可能な範囲）を定義するものです。</p>

                        <h4>スコープの重要性</h4>
                        <p>スコープを理解することは、以下の理由から重要です：</p>
                        <ul>
                            <li><strong>データの適切な管理</strong>：データをどのスコープに保存するかで、メモリ効率や利便性が変わります。</li>
                            <li><strong>セキュリティ</strong>：適切なスコープを使用することで、データへのアクセス制限を実現できます。</li>
                            <li><strong>アプリケーション設計</strong>：スコープを理解することで、より効果的なアプリケーション設計が可能になります。</li>
                        </ul>

                        <div class="diagram">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 300" width="600" height="300">
                                <!-- アプリケーションスコープ -->
                                <rect x="50" y="50" width="500" height="200" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="5" />
                                <text x="270" y="75" text-anchor="middle" font-size="16" font-weight="bold">アプリケーションスコープ</text>
                                
                                <!-- セッションスコープ -->
                                <rect x="100" y="90" width="175" height="140" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="5" />
                                <text x="187.5" y="115" text-anchor="middle" font-size="14" font-weight="bold">セッションスコープ1</text>
                                
                                <!-- 別セッションスコープ -->
                                <rect x="325" y="90" width="175" height="140" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="5" />
                                <text x="412.5" y="115" text-anchor="middle" font-size="14" font-weight="bold">セッションスコープ2</text>
                                
                                <!-- リクエストスコープ1 -->
                                <rect x="125" y="130" width="125" height="40" fill="#fff8e1" stroke="#ffc107" stroke-width="2" rx="5" />
                                <text x="187.5" y="155" text-anchor="middle" font-size="12" font-weight="bold">リクエストスコープ</text>
                                
                                <!-- リクエストスコープ2 -->
                                <rect x="350" y="130" width="125" height="40" fill="#fff8e1" stroke="#ffc107" stroke-width="2" rx="5" />
                                <text x="412.5" y="155" text-anchor="middle" font-size="12" font-weight="bold">リクエストスコープ</text>
                                
                                <!-- ページスコープ1 -->
                                <rect x="125" y="180" width="50" height="30" fill="#ffebee" stroke="#f44336" stroke-width="2" rx="5" />
                                <text x="150" y="200" text-anchor="middle" font-size="10" font-weight="bold">Page</text>
                                
                                <!-- ページスコープ2 -->
                                <rect x="200" y="180" width="50" height="30" fill="#ffebee" stroke="#f44336" stroke-width="2" rx="5" />
                                <text x="225" y="200" text-anchor="middle" font-size="10" font-weight="bold">Page</text>
                                
                                <!-- ページスコープ3 -->
                                <rect x="350" y="180" width="50" height="30" fill="#ffebee" stroke="#f44336" stroke-width="2" rx="5" />
                                <text x="375" y="200" text-anchor="middle" font-size="10" font-weight="bold">Page</text>
                                
                                <!-- ページスコープ4 -->
                                <rect x="425" y="180" width="50" height="30" fill="#ffebee" stroke="#f44336" stroke-width="2" rx="5" />
                                <text x="450" y="200" text-anchor="middle" font-size="10" font-weight="bold">Page</text>
                            </svg>
                            <p class="text-center">図7.1: スコープの階層と関係</p>
                        </div>

                        <div class="note">
                            <h5>JSP/Servletとスコープ</h5>
                            <p>JSPやServletでは、これらのスコープにデータを保存するための標準的なAPIが提供されており、適切なスコープを選択してデータを管理することが可能です。</p>
                        </div>
                    </section>

                    <section id="scope-types">
                        <h3 class="section-title">7.2 スコープの種類</h3>
                        <p>JSP/Servletでは以下の4種類のスコープがあります。それぞれのスコープは異なる目的と生存期間を持っています。</p>

                        <h4>Pageスコープ</h4>
                        <p>Pageスコープは最も短い生存期間を持つスコープです。</p>
                        <ul>
                            <li><strong>生存期間</strong>：1つのJSPページの処理中のみ</li>
                            <li><strong>使用場面</strong>：特定のJSPページ内でのみ必要な一時的なデータの保存</li>
                            <li><strong>アクセス方法</strong>：JSPでは<span class="inline-code">pageContext.setAttribute()</span>と<span class="inline-code">pageContext.getAttribute()</span></li>
                        </ul>

                        <code>&lt;%
// Pageスコープにデータを設定
pageContext.setAttribute("userName", "山田太郎");

// Pageスコープからデータを取得
String userName = (String) pageContext.getAttribute("userName");
%&gt;

&lt;p&gt;ようこそ、${pageScope.userName}さん！&lt;/p&gt;</code>

                        <h4>Requestスコープ</h4>
                        <p>Requestスコープは1つのHTTPリクエストの間だけ有効なスコープです。</p>
                        <ul>
                            <li><strong>生存期間</strong>：HTTPリクエストの開始から、レスポンスが返されるまで</li>
                            <li><strong>使用場面</strong>：フォームデータの処理、リクエスト内でのデータの受け渡し</li>
                            <li><strong>アクセス方法</strong>：<span class="inline-code">request.setAttribute()</span>と<span class="inline-code">request.getAttribute()</span></li>
                            <li><strong>特徴</strong>：forward（転送）された先のJSP/Servletでもデータが利用可能</li>
                        </ul>

                        <code>// Servletでのリクエストスコープの利用例
protected void doPost(HttpServletRequest request, HttpServletResponse response)
        throws ServletException, IOException {
    
    // フォームからのデータを取得
    String userName = request.getParameter("userName");
    
    // リクエストスコープにデータを設定
    request.setAttribute("userName", userName);
    request.setAttribute("accessTime", new java.util.Date());
    
    // 別のJSPにフォワード
    RequestDispatcher dispatcher = request.getRequestDispatcher("/welcome.jsp");
    dispatcher.forward(request, response);
}</code>

                        <p>welcome.jsp での取得例：</p>
                        <code>&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ようこそ&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;ようこそ、${requestScope.userName}さん！&lt;/h1&gt;
    &lt;p&gt;アクセス時刻: ${requestScope.accessTime}&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code>

                        <h4>Sessionスコープ</h4>
                        <p>Sessionスコープはユーザーのセッション期間中有効なスコープです。</p>
                        <ul>
                            <li><strong>生存期間</strong>：ユーザーセッションの開始から終了まで（通常はブラウザを閉じるまで）</li>
                            <li><strong>使用場面</strong>：ログイン情報、ショッピングカートなど、複数のリクエストにまたがるユーザー固有のデータ</li>
                            <li><strong>アクセス方法</strong>：<span class="inline-code">session.setAttribute()</span>と<span class="inline-code">session.getAttribute()</span></li>
                        </ul>

                        <code>// Servletでのセッションスコープの利用例
protected void doPost(HttpServletRequest request, HttpServletResponse response)
        throws ServletException, IOException {
    
    // ユーザー認証処理（簡略化）
    String userId = request.getParameter("userId");
    String password = request.getParameter("password");
    
    // 認証が成功したと仮定
    HttpSession session = request.getSession();
    session.setAttribute("isLoggedIn", true);
    session.setAttribute("userId", userId);
    
    // ダッシュボードページにリダイレクト
    response.sendRedirect("dashboard.jsp");
}</code>

                        <p>dashboard.jsp での取得例：</p>
                        <code>&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ダッシュボード&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;% 
    // セッションから情報を取得
    Boolean isLoggedIn = (Boolean) session.getAttribute("isLoggedIn");
    
    // 未ログインの場合はログインページにリダイレクト
    if (isLoggedIn == null || !isLoggedIn) {
        response.sendRedirect("login.jsp");
        return;
    }
    %&gt;
    
    &lt;h1&gt;ダッシュボード&lt;/h1&gt;
    &lt;p&gt;ようこそ、${sessionScope.userId}さん！&lt;/p&gt;
    
    &lt;!-- ダッシュボードの内容 --&gt;
&lt;/body&gt;
&lt;/html&gt;</code>

                        <h4>Applicationスコープ</h4>
                        <p>Applicationスコープはアプリケーション全体で共有されるスコープです。</p>
                        <ul>
                            <li><strong>生存期間</strong>：Webアプリケーションの起動から停止まで</li>
                            <li><strong>使用場面</strong>：アプリケーション全体で共有される設定情報、カウンターなど</li>
                            <li><strong>アクセス方法</strong>：<span class="inline-code">application.setAttribute()</span>と<span class="inline-code">application.getAttribute()</span>、またはServletContextを使用</li>
                        </ul>

                        <code>// Servletでのアプリケーションスコープの利用例
public class AppInitServlet extends HttpServlet {
    
    public void init() throws ServletException {
        // サーブレットの初期化時にアプリケーション設定を読み込み
        ServletContext application = getServletContext();
        
        // データベース接続情報などの設定
        application.setAttribute("dbUrl", "jdbc:mysql://localhost:3306/mydb");
        application.setAttribute("appVersion", "1.0.0");
        
        // アクセスカウンターの初期化
        application.setAttribute("visitorCount", 0);
    }
}

// 別のServletでアプリケーションスコープのデータを利用
protected void doGet(HttpServletRequest request, HttpServletResponse response)
        throws ServletException, IOException {
    
    ServletContext application = getServletContext();
    
    // 訪問者カウンターを更新
    Integer visitorCount = (Integer) application.getAttribute("visitorCount");
    application.setAttribute("visitorCount", visitorCount + 1);
    
    // JSPにデータを渡す
    request.setAttribute("dbUrl", application.getAttribute("dbUrl"));
    request.setAttribute("appVersion", application.getAttribute("appVersion"));
    request.setAttribute("visitorCount", application.getAttribute("visitorCount"));
    
    RequestDispatcher dispatcher = request.getRequestDispatcher("/stats.jsp");
    dispatcher.forward(request, response);
}</code>

                        <div class="table-responsive">
                            <table class="table-example">
                                <tr>
                                    <th>スコープ</th>
                                    <th>生存期間</th>
                                    <th>主な用途</th>
                                    <th>アクセス方法（JSP EL）</th>
                                </tr>
                                <tr>
                                    <td>Page</td>
                                    <td>JSPページの処理中のみ</td>
                                    <td>ページ内での一時的な計算値</td>
                                    <td>${pageScope.変数名}</td>
                                </tr>
                                <tr>
                                    <td>Request</td>
                                    <td>HTTPリクエスト/レスポンス処理中</td>
                                    <td>リクエスト処理中のデータ受け渡し</td>
                                    <td>${requestScope.変数名}</td>
                                </tr>
                                <tr>
                                    <td>Session</td>
                                    <td>ユーザーセッション期間</td>
                                    <td>ログイン情報、ショッピングカート</td>
                                    <td>${sessionScope.変数名}</td>
                                </tr>
                                <tr>
                                    <td>Application</td>
                                    <td>アプリケーション稼働期間</td>
                                    <td>全ユーザー共通の設定、カウンター</td>
                                    <td>${applicationScope.変数名}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="exercise">
                            <h5>演習 7.2.1: スコープの使い分け</h5>
                            <p>以下のそれぞれのデータをどのスコープに保存するのが適切か考えてみましょう。</p>
                            <ol>
                                <li>データベース接続情報</li>
                                <li>ユーザーのログイン状態</li>
                                <li>検索フォームからの検索キーワード</li>
                                <li>特定のJSPページで使用する一時的な計算結果</li>
                                <li>サイト全体の訪問者数カウンター</li>
                            </ol>
                            <p>それぞれの理由も説明してください。</p>
                        </div>
                    </section>

                    <section id="session-management">
                        <h3 class="section-title">7.3 セッション管理</h3>
                        <p>Webアプリケーションでは、ユーザーのセッションを適切に管理することが重要です。セッション管理はログイン状態の維持やショッピングカートなどの機能を実現するために不可欠です。</p>

                        <h4>HTTPセッションとは</h4>
                        <p>HTTPセッションは、同一ユーザーからの複数のリクエストをグループ化し、ユーザー固有の状態を保持するための仕組みです。HTTPはステートレスなプロトコルですが、セッションを使用することでステートフルなアプリケーションが実現できます。</p>

                        <h4>セッション追跡の仕組み</h4>
                        <p>Webアプリケーションでセッションを追跡する主な方法は以下の通りです：</p>
                        <ul>
                            <li><strong>Cookie</strong>：サーバーからクライアントに送信される小さなテキストデータで、ブラウザに保存されます。JSP/Servletでは自動的にセッションIDがCookieとして送信されます。</li>
                            <li><strong>URL書き換え</strong>：URLにセッションIDを埋め込む方法で、Cookieが無効な場合の代替手段として使用されます。</li>
                            <li><strong>Hidden Field</strong>：フォームの隠しフィールドにセッションIDを格納する方法（あまり一般的ではありません）。</li>
                        </ul>

                        <div class="diagram">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 300" width="600" height="300">
                                <!-- クライアント -->
                                <rect x="50" y="50" width="120" height="200" fill="#bbdefb" stroke="#1976d2" stroke-width="2" rx="5" />
                                <text x="110" y="85" text-anchor="middle" font-size="16">ブラウザ</text>
                                <text x="110" y="115" text-anchor="middle" font-size="12">Cookie:</text>
                                <text x="110" y="135" text-anchor="middle" font-size="12">JSESSIONID=</text>
                                <text x="110" y="155" text-anchor="middle" font-size="12">A12B3C4D5</text>
                                
                                <!-- サーバー -->
                                <rect x="350" y="50" width="200" height="200" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="5" />
                                <text x="450" y="85" text-anchor="middle" font-size="16">Webサーバー</text>
                                
                                <!-- セッション情報 -->
                                <rect x="370" y="110" width="160" height="100" fill="#c8e6c9" stroke="#388e3c" stroke-width="2" rx="5" />
                                <text x="450" y="135" text-anchor="middle" font-size="14">セッション情報</text>
                                <text x="450" y="155" text-anchor="middle" font-size="12">ID: A12B3C4D5</text>
                                <text x="450" y="175" text-anchor="middle" font-size="12">userId: user123</text>
                                <text x="450" y="195" text-anchor="middle" font-size="12">isLoggedIn: true</text>
                                
                                <!-- リクエスト矢印 -->
                                <line x1="170" y1="120" x2="350" y2="120" stroke="#1976d2" stroke-width="2" marker-end="url(#arrow)" />
                                <text x="260" y="110" text-anchor="middle" font-size="12">リクエスト</text>
                                <text x="260" y="130" text-anchor="middle" font-size="12">Cookie: JSESSIONID=A12B3C4D5</text>
                                
                                <!-- レスポンス矢印 -->
                                <line x1="350" y1="180" x2="170" y2="180" stroke="#1976d2" stroke-width="2" marker-end="url(#arrow)" />
                                <text x="260" y="200" text-anchor="middle" font-size="12">レスポンス</text>
                                
                                <defs>
                                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                        <path d="M0,0 L0,6 L9,3 z" fill="#1976d2" />
                                    </marker>
                                </defs>
                            </svg>
                            <p class="text-center">図7.2: HTTPセッションの仕組み</p>
                        </div>

                        <h4>JSP/Servletでのセッション操作</h4>
                        <p>JSP/Servletでは、<span class="inline-code">HttpSession</span>インターフェースを使用してセッションを操作します。</p>

                        <h5>セッションの作成と取得</h5>
                        <code>// Servletでのセッション取得
HttpSession session = request.getSession(); // 既存のセッションを取得、なければ新規作成

// または、新規作成を行わない場合
HttpSession session = request.getSession(false); // 既存のセッションがなければnullを返す</code>

                        <h5>セッションへのデータ保存と取得</h5>
                        <code>// データの保存
session.setAttribute("userName", "山田太郎");
session.setAttribute("isLoggedIn", true);
session.setAttribute("cart", new ShoppingCart());

// データの取得
String userName = (String) session.getAttribute("userName");
Boolean isLoggedIn = (Boolean) session.getAttribute("isLoggedIn");
ShoppingCart cart = (ShoppingCart) session.getAttribute("cart");

// データの削除
session.removeAttribute("userName");</code>

                        <h5>セッションの無効化</h5>
                        <code>// ログアウト時などにセッションを無効にする
session.invalidate();</code>

                        <h4>セッションのライフサイクル</h4>
                        <p>セッションには以下のようなライフサイクルがあります：</p>
                        <ol>
                            <li><strong>作成</strong>：<span class="inline-code">request.getSession()</span>が初めて呼び出されたとき</li>
                            <li><strong>使用</strong>：セッションに属性を設定したり、取得したりする期間</li>
                            <li><strong>終了</strong>：以下のいずれかの条件で終了します
                                <ul>
                                    <li><span class="inline-code">session.invalidate()</span>メソッドが呼び出された</li>
                                    <li>セッションタイムアウトが発生した（一定時間アクセスがない）</li>
                                    <li>アプリケーションが停止した</li>
                                </ul>
                            </li>
                        </ol>

                        <h4>セッションタイムアウトの設定</h4>
                        <p>セッションタイムアウトは、最後のアクセスからどれくらいの時間が経過したらセッションを無効にするかを指定します。設定は以下の方法で行えます：</p>

                        <h5>web.xmlでの設定（アプリケーション全体）</h5>
                        <code>&lt;web-app ...&gt;
    &lt;!-- セッションタイムアウトを30分（1800秒）に設定 --&gt;
    &lt;session-config&gt;
        &lt;session-timeout&gt;30&lt;/session-timeout&gt;
    &lt;/session-config&gt;
&lt;/web-app&gt;</code>

                        <h5>プログラムでの設定（個別セッション）</h5>
                        <code>// セッションタイムアウトを20分（1200秒）に設定
session.setMaxInactiveInterval(1200);</code>

                        <div class="warning">
                            <h5>注意: セッションタイムアウト</h5>
                            <p>セッションタイムアウトの適切な設定は重要です。値が小さすぎるとユーザーのセッションが頻繁に切れてストレスになり、大きすぎるとサーバーリソースの無駄遣いやセキュリティリスクになります。用途に応じて適切な値を設定しましょう。</p>
                        </div>

                        <div class="exercise">
                            <h5>演習 7.3.1: セッション操作の実践</h5>
                            <p>以下の要件を満たすServletを作成してください：</p>
                            <ol>
                                <li>ユーザーが初めてアクセスした場合、アクセスカウンターを1に初期化し、現在の日時をセッションに保存する</li>
                                <li>それ以降のアクセスでは、カウンターをインクリメントする</li>
                                <li>カウンター値、初回アクセス時間、現在の時刻を表示するJSPにフォワードする</li>
                                <li>「セッションリセット」ボタンで、セッションを無効化し、新しいセッションを開始できるようにする</li>
                            </ol>
                        </div>
                    </section>

                    <section id="session-attributes">
                        <h3 class="section-title">7.4 セッション属性</h3>
                        <p>セッションには様々な種類のデータを属性として保存できます。ここでは、セッション属性の効果的な使用方法について説明します。</p>

                        <h4>セッション属性の命名規則</h4>
                        <p>セッション属性の名前は、以下のような規則に従うことをお勧めします：</p>
                        <ul>
                            <li>意味のある名前を使用する（例：<span class="inline-code">userID</span>）</li>
                            <li>一貫性のある命名規則を使用する（例：キャメルケースやスネークケース）</li>
                            <li>名前の衝突を避けるため、必要に応じて名前空間を使用する（例：<span class="inline-code">auth.userID</span>）</li>
                        </ul>

                        <h4>セッションに保存するデータの選択</h4>
                        <p>セッションに保存するデータは、以下の点を考慮して選択するべきです：</p>
                        <ul>
                            <li><strong>サイズ</strong>：大きなデータオブジェクトはメモリを圧迫するため、必要最小限のデータだけを保存する</li>
                            <li><strong>セキュリティ</strong>：パスワードなどの機密情報はセッションに平文で保存しない</li>
                            <li><strong>シリアライズ可能性</strong>：セッション属性として保存されるオブジェクトは<span class="inline-code">Serializable</span>インターフェースを実装することが望ましい</li>
                        </ul>

                        <h4>セッション属性の効果的な管理</h4>
                        <p>セッション属性を効果的に管理するためのテクニックを紹介します：</p>

                        <h5>DTO (Data Transfer Object) クラスの使用</h5>
                        <p>関連するデータをグループ化したDTOクラスを作成することで、セッション管理が容易になります。</p>

                        <code>// ユーザー情報を保持するDTOクラス
public class UserDTO implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String userId;
    private String name;
    private String email;
    private boolean isAdmin;
    private Date lastLoginTime;
    
    // コンストラクタ、ゲッター、セッターなど
    // ...
}

// Servletでの使用例
protected void doPost(HttpServletRequest request, HttpServletResponse response)
        throws ServletException, IOException {
    
    // ユーザー認証が成功したと仮定
    UserDTO user = new UserDTO();
    user.setUserId("user123");
    user.setName("山田太郎");
    user.setEmail("yamada@example.com");
    user.setAdmin(false);
    user.setLastLoginTime(new Date());
    
    // セッションに保存
    HttpSession session = request.getSession();
    session.setAttribute("currentUser", user);
    
    response.sendRedirect("dashboard.jsp");
}</code>

                        <h5>セッション属性リスナーの活用</h5>
                        <p>セッション属性の変更を監視するためのリスナーを使用すると、属性の管理が容易になります。</p>

                        <code>// セッション属性リスナーの実装例
@WebListener
public class SessionAttributeListener implements HttpSessionAttributeListener {
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        Object attributeValue = event.getValue();
        
        System.out.println("セッション属性が追加されました: " + attributeName);
        
        // ログイン時の処理など
        if ("currentUser".equals(attributeName)) {
            UserDTO user = (UserDTO) attributeValue;
            System.out.println("ユーザーがログインしました: " + user.getName());
        }
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        
        System.out.println("セッション属性が削除されました: " + attributeName);
        
        // ログアウト時の処理など
        if ("currentUser".equals(attributeName)) {
            System.out.println("ユーザーがログアウトしました");
        }
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        Object attributeValue = event.getValue();
        
        System.out.println("セッション属性が更新されました: " + attributeName);
    }
}</code>

                        <h5>セッション属性の値変更を検知する</h5>
                        <p>オブジェクトがセッションに追加/削除されるタイミングで特定の処理を行いたい場合は、<span class="inline-code">HttpSessionBindingListener</span>インターフェースを使用します。</p>

                        <code>// HttpSessionBindingListenerを実装したユーザークラス
public class User implements Serializable, HttpSessionBindingListener {
    private static final long serialVersionUID = 1L;
    
    private String userId;
    private String name;
    
    // コンストラクタ、ゲッター、セッターなど
    
    @Override
    public void valueBound(HttpSessionBindingEvent event) {
        // オブジェクトがセッションに追加されたときの処理
        System.out.println("ユーザー " + name + " がセッションにバインドされました");
        
        // ログイン履歴の記録など
    }
    
    @Override
    public void valueUnbound(HttpSessionBindingEvent event) {
        // オブジェクトがセッションから削除されたときの処理
        System.out.println("ユーザー " + name + " がセッションからアンバインドされました");
        
        // ログアウト処理など
    }
}</code>

                        <div class="note">
                            <h5>セッション属性のベストプラクティス</h5>
                            <ul>
                                <li>必要最小限の情報だけをセッションに保存する</li>
                                <li>大きなオブジェクトはデータベースに保存し、IDだけをセッションに保存する</li>
                                <li>不要になった属性は明示的に削除する</li>
                                <li>セッションにオブジェクトを保存する場合は<span class="inline-code">Serializable</span>を実装する</li>
                            </ul>
                        </div>

                        <div class="exercise">
                            <h5>演習 7.4.1: セッション属性の効果的な活用</h5>
                            <p>ショッピングカート機能を実装するための<span class="inline-code">ShoppingCart</span>クラスと、それを利用するServletを設計してください。以下の要件を満たすようにしてください：</p>
                            <ol>
                                <li>Serializableを実装したShoppingCartクラスを作成する</li>
                                <li>商品を追加・削除・更新するメソッドを実装する</li>
                                <li>カートの合計金額を計算するメソッドを実装する</li>
                                <li>セッションにShoppingCartを保存し、管理するServletを実装する</li>
                                <li>カートの内容を表示するJSPを実装する</li>
                            </ol>
                        </div>
                    </section>

                    <section id="login-example">
                        <h3 class="section-title">7.5 ログイン機能の実装例</h3>
                        <p>ここでは、セッションを使用したログイン機能の実装例を紹介します。これは実際のWebアプリケーションでよく使われるパターンです。</p>

                        <h4>ログイン機能の構成要素</h4>
                        <p>ログイン機能の基本的な構成要素は以下の通りです：</p>
                        <ul>
                            <li><strong>ログインフォーム</strong>：ユーザーIDとパスワードを入力するためのフォーム</li>
                            <li><strong>認証処理</strong>：ユーザーIDとパスワードを検証するServlet</li>
                            <li><strong>セッション管理</strong>：ログイン状態を保持するためのセッション</li>
                            <li><strong>保護されたページ</strong>：ログインしたユーザーのみアクセス可能なページ</li>
                            <li><strong>ログアウト処理</strong>：セッションを無効化する処理</li>
                        </ul>

                        <h4>実装例</h4>

                        <h5>1. ログインフォーム（login.jsp）</h5>
                        <code>&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ログイン&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-6"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-primary text-white"&gt;
                        &lt;h4 class="mb-0"&gt;ログイン&lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;% if (request.getAttribute("errorMessage") != null) { %&gt;
                            &lt;div class="alert alert-danger" role="alert"&gt;
                                ${requestScope.errorMessage}
                            &lt;/div&gt;
                        &lt;% } %&gt;
                        
                        &lt;form action="login" method="post"&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="userId" class="form-label"&gt;ユーザーID&lt;/label&gt;
                                &lt;input type="text" class="form-control" id="userId" name="userId" required&gt;
                            &lt;/div&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="password" class="form-label"&gt;パスワード&lt;/label&gt;
                                &lt;input type="password" class="form-control" id="password" name="password" required&gt;
                            &lt;/div&gt;
                            &lt;button type="submit" class="btn btn-primary"&gt;ログイン&lt;/button&gt;
                        &lt;/form&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code>

                        <h5>2. ログイン処理用Servlet（LoginServlet.java）</h5>
                        <code>package com.example.login;

import java.io.IOException;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;

@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        // セッションがあり、ログイン済みの場合はダッシュボードにリダイレクト
        HttpSession session = request.getSession(false);
        if (session != null && session.getAttribute("isLoggedIn") != null &&
                (Boolean) session.getAttribute("isLoggedIn")) {
            response.sendRedirect("dashboard.jsp");
            return;
        }
        
        // ログインページを表示
        request.getRequestDispatcher("/login.jsp").forward(request, response);
    }
    
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        String userId = request.getParameter("userId");
        String password = request.getParameter("password");
        
        // 認証処理（実際はデータベースで検証）
        if (isValidUser(userId, password)) {
            // ログイン成功：セッションにユーザー情報を保存
            HttpSession session = request.getSession();
            session.setAttribute("isLoggedIn", true);
            session.setAttribute("userId", userId);
            session.setAttribute("lastLoginTime", new java.util.Date());
            
            // ダッシュボードにリダイレクト
            response.sendRedirect("dashboard.jsp");
        } else {
            // ログイン失敗：エラーメッセージを設定してログインページに戻る
            request.setAttribute("errorMessage", "ユーザーIDまたはパスワードが正しくありません。");
            request.getRequestDispatcher("/login.jsp").forward(request, response);
        }
    }
    
    // ユーザー認証メソッド（実際はデータベース連携）
    private boolean isValidUser(String userId, String password) {
        // 例：簡易的な認証（実際の開発では使わないでください）
        return "admin".equals(userId) && "password".equals(password);
    }
}</code>

                        <h5>3. ダッシュボードページ（dashboard.jsp）</h5>
                        <code>&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ダッシュボード&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;% 
    // セッションチェック
    if (session.getAttribute("isLoggedIn") == null || !(Boolean) session.getAttribute("isLoggedIn")) {
        // 未ログインの場合はログインページにリダイレクト
        response.sendRedirect("login");
        return;
    }
    
    String userId = (String) session.getAttribute("userId");
    java.util.Date lastLoginTime = (java.util.Date) session.getAttribute("lastLoginTime");
    %&gt;
    
    &lt;nav class="navbar navbar-expand-lg navbar-dark bg-primary"&gt;
        &lt;div class="container"&gt;
            &lt;a class="navbar-brand" href="#"&gt;管理システム&lt;/a&gt;
            &lt;button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"&gt;
                &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;
            &lt;/button&gt;
            &lt;div class="collapse navbar-collapse" id="navbarNav"&gt;
                &lt;ul class="navbar-nav me-auto"&gt;
                    &lt;li class="nav-item"&gt;
                        &lt;a class="nav-link active" href="#"&gt;ダッシュボード&lt;/a&gt;
                    &lt;/li&gt;
                    &lt;li class="nav-item"&gt;
                        &lt;a class="nav-link" href="#"&gt;設定&lt;/a&gt;
                    &lt;/li&gt;
                &lt;/ul&gt;
                &lt;span class="navbar-text me-3"&gt;
                    ようこそ、${sessionScope.userId}さん
                &lt;/span&gt;
                &lt;a href="logout" class="btn btn-outline-light"&gt;ログアウト&lt;/a&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/nav&gt;
    
    &lt;div class="container mt-4"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-md-12"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h4&gt;ダッシュボード&lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;p&gt;最終ログイン時刻: ${sessionScope.lastLoginTime}&lt;/p&gt;
                        
                        &lt;h5 class="mt-4"&gt;利用可能なメニュー&lt;/h5&gt;
                        &lt;div class="list-group mt-3"&gt;
                            &lt;a href="#" class="list-group-item list-group-item-action"&gt;ユーザー管理&lt;/a&gt;
                            &lt;a href="#" class="list-group-item list-group-item-action"&gt;コンテンツ管理&lt;/a&gt;
                            &lt;a href="#" class="list-group-item list-group-item-action"&gt;統計レポート&lt;/a&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code>

                        <h5>4. ログアウト処理用Servlet（LogoutServlet.java）</h5>
                        <code>package com.example.login;

import java.io.IOException;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;

@WebServlet("/logout")
public class LogoutServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        // セッションを取得（新規作成はしない）
        HttpSession session = request.getSession(false);
        
        // セッションが存在すれば無効化
        if (session != null) {
            session.invalidate();
        }
        
        // ログインページにリダイレクト
        response.sendRedirect("login");
    }
}</code>

                        <h5>5. セッションフィルター（SessionFilter.java）</h5>
                        <p>保護されたページに未ログインユーザーがアクセスしないようにフィルターを実装します。</p>

                        <code>package com.example.filter;

import java.io.IOException;
import jakarta.servlet.Filter;
import jakarta.servlet.FilterChain;
import jakarta.servlet.FilterConfig;
import jakarta.servlet.ServletException;
import jakarta.servlet.ServletRequest;
import jakarta.servlet.ServletResponse;
import jakarta.servlet.annotation.WebFilter;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;

// 保護されたURLパターンを指定
@WebFilter(urlPatterns = {"/dashboard.jsp", "/admin/*", "/secure/*"})
public class SessionFilter implements Filter {
    
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        // フィルターの初期化処理
    }
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // セッションの取得（新規作成はしない）
        HttpSession session = httpRequest.getSession(false);
        
        // ログイン済みかチェック
        boolean isLoggedIn = session != null && session.getAttribute("isLoggedIn") != null &&
                (Boolean) session.getAttribute("isLoggedIn");
        
        if (isLoggedIn) {
            // ログイン済みの場合、リクエストを続行
            chain.doFilter(request, response);
        } else {
            // 未ログインの場合、ログインページにリダイレクト
            httpResponse.sendRedirect(httpRequest.getContextPath() + "/login");
        }
    }
    
    @Override
    public void destroy() {
        // フィルターの破棄処理
    }
}</code>

                        <div class="diagram">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 400" width="600" height="400">
                                <!-- ユーザー -->
                                <rect x="50" y="50" width="100" height="50" fill="#bbdefb" stroke="#1976d2" stroke-width="2" rx="5" />
                                <text x="100" y="80" text-anchor="middle" font-size="14">ユーザー</text>
                                
                                <!-- ログインページ -->
                                <rect x="250" y="50" width="120" height="50" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="5" />
                                <text x="310" y="80" text-anchor="middle" font-size="14">login.jsp</text>
                                
                                <!-- LoginServlet -->
                                <rect x="250" y="150" width="120" height="50" fill="#c8e6c9" stroke="#388e3c" stroke-width="2" rx="5" />
                                <text x="310" y="180" text-anchor="middle" font-size="14">LoginServlet</text>
                                
                                <!-- SessionFilter -->
                                <rect x="450" y="150" width="120" height="50" fill="#ffecb3" stroke="#ffa000" stroke-width="2" rx="5" />
                                <text x="510" y="180" text-anchor="middle" font-size="14">SessionFilter</text>
                                
                                <!-- ダッシュボード -->
                                <rect x="250" y="250" width="120" height="50" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="5" />
                                <text x="310" y="280" text-anchor="middle" font-size="14">dashboard.jsp</text>
                                
                                <!-- LogoutServlet -->
                                <rect x="250" y="350" width="120" height="50" fill="#c8e6c9" stroke="#388e3c" stroke-width="2" rx="5" />
                                <text x="310" y="380" text-anchor="middle" font-size="14">LogoutServlet</text>
                                
                                <!-- アクセス矢印 -->
                                <line x1="150" y1="75" x2="250" y2="75" stroke="#1976d2" stroke-width="2" marker-end="url(#arrow)" />
                                <text x="200" y="65" text-anchor="middle" font-size="12">アクセス</text>
                                
                                <!-- フォーム送信矢印 -->
                                <line x1="310" y1="100" x2="310" y2="150" stroke="#1976d2" stroke-width="2" marker-end="url(#arrow)" />
                                <text x="330" y="125" text-anchor="middle" font-size="12">POST</text>
                                
                                <!-- リダイレクト矢印 -->
                                <line x1="310" y1="200" x2="310" y2="250" stroke="#1976d2" stroke-width="2" marker-end="url(#arrow)" />
                                <text x="330" y="225" text-anchor="middle" font-size="12">リダイレクト</text>
                                
                                <!-- フィルター矢印 -->
                                <line x1="410" y1="175" x2="450" y2="175" stroke="#ffa000" stroke-width="2" marker-end="url(#arrow)" />
                                <text x="430" y="165" text-anchor="middle" font-size="12">チェック</text>
                                
                                <!-- フィルターからログインへの矢印 -->
                                <line x1="500" y1="150" x2="500" y2="75" x2x="310" y2="75" stroke="#ffa000" stroke-width="2" stroke-dasharray="5,5" />
                                <line x1="500" y1="75" x2="370" y2="75" stroke="#ffa000" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrow)" />
                                <text x="480" y="120" text-anchor="middle" font-size="12" transform="rotate(-90, 480, 120)">未ログイン</text>
                                
                                <!-- ログアウト矢印 -->
                                <line x1="310" y1="300" x2="310" y2="350" stroke="#1976d2" stroke-width="2" marker-end="url(#arrow)" />
                                <text x="330" y="325" text-anchor="middle" font-size="12">ログアウト</text>
                                
                                <!-- ログアウト後の矢印 -->
                                <line x1="250" y1="375" x2="100" y2="375" x2x="100" y2="100" stroke="#1976d2" stroke-width="2" stroke-dasharray="5,5" />
                                <line x1="100" y1="375" x2="100" y2="110" stroke="#1976d2" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrow)" />
                                <text x="160" y="395" text-anchor="middle" font-size="12">セッション無効化</text>
                                
                                <defs>
                                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                        <path d="M0,0 L0,6 L9,3 z" fill="#1976d2" />
                                    </marker>
                                </defs>
                            </svg>
                            <p class="text-center">図7.3: ログイン機能の実装フロー</p>
                        </div>

                        <div class="warning">
                            <h5>注意: セキュリティの考慮事項</h5>
                            <p>この例は基本的な実装を示すためのものです。実際のアプリケーションでは以下の点に注意してください：</p>
                            <ul>
                                <li>パスワードは必ずハッシュ化して保存する</li>
                                <li>HTTPS（SSL/TLS）を使用してデータを暗号化する</li>
                                <li>セッションハイジャックを防ぐための対策を実装する</li>
                                <li>SQL Injectionなどの攻撃を防ぐためにパラメータをエスケープする</li>
                                <li>CSRF（Cross-Site Request Forgery）対策を実装する</li>
                            </ul>
                        </div>

                        <div class="exercise">
                            <h5>演習 7.5.1: ログイン機能の拡張</h5>
                            <p>上記のログイン機能の実装例をベースに、以下の機能を追加してください：</p>
                            <ol>
                                <li>「ログイン状態を保持」チェックボックスを追加し、選択された場合は次回のアクセスでも自動ログインする機能</li>
                                <li>ログイン失敗回数を記録し、一定回数以上失敗したらアカウントをロックする機能</li>
                                <li>最終ログイン日時と前回のIPアドレスをユーザーに表示する機能</li>
                            </ol>
                        </div>
                    </section>

                    <section id="best-practices">
                        <h3 class="section-title">7.6 セッション管理のベストプラクティス</h3>
                        <p>セッション管理は適切に行わないとセキュリティ上の問題やパフォーマンスの低下を引き起こす可能性があります。ここでは、セッション管理におけるベストプラクティスを紹介します。</p>

                        <h4>セキュリティに関するベストプラクティス</h4>
                        <ul>
                            <li><strong>HTTPSの使用</strong>：セッションIDを含むすべての通信をHTTPS経由で行い、傍受を防止します。</li>
                            <li><strong>セッションIDの保護</strong>：
                                <ul>
                                    <li>セッションIDをURLに含めない（URL書き換えを避ける）</li>
                                    <li>Cookieにはセキュア属性とHttpOnly属性を設定する</li>
                                    <li>セッションIDを定期的に再生成する（特に権限レベルが変わったとき）</li>
                                </ul>
                            </li>
                            <li><strong>タイムアウト設定</strong>：適切なセッションタイムアウトを設定し、不要に長いセッションを避けます。</li>
                            <li><strong>ログアウト機能</strong>：明示的なログアウト機能を提供し、ユーザーがセッションを終了できるようにします。</li>
                            <li><strong>機密情報の管理</strong>：パスワードなどの機密情報はセッションに保存せず、必要に応じてデータベースを参照します。</li>
                            <li><strong>CSRF対策</strong>：トークンを使用してクロスサイトリクエストフォージェリ攻撃を防止します。</li>
                        </ul>

                        <h5>web.xmlでのセキュアなCookie設定</h5>
                        <code>&lt;web-app ...&gt;
    &lt;session-config&gt;
        &lt;session-timeout&gt;30&lt;/session-timeout&gt;
        &lt;cookie-config&gt;
            &lt;http-only&gt;true&lt;/http-only&gt;
            &lt;secure&gt;true&lt;/secure&gt;
            &lt;same-site&gt;strict&lt;/same-site&gt;
        &lt;/cookie-config&gt;
        &lt;tracking-mode&gt;COOKIE&lt;/tracking-mode&gt;
    &lt;/session-config&gt;
&lt;/web-app&gt;</code>

                        <h4>パフォーマンスとスケーラビリティに関するベストプラクティス</h4>
                        <ul>
                            <li><strong>セッションサイズの最小化</strong>：必要最小限のデータだけをセッションに保存し、メモリ使用量を抑えます。</li>
                            <li><strong>大きなオブジェクトの扱い</strong>：大きなデータはデータベースに保存し、IDのみをセッションに保存します。</li>
                            <li><strong>セッションレプリケーション</strong>：クラスタ環境では、セッションレプリケーションの負荷を考慮した設計を行います。</li>
                            <li><strong>不要なセッションの作成を避ける</strong>：静的コンテンツへのアクセスでは不必要にセッションを作成しないようにします。</li>
                            <li><strong>分散セッション管理</strong>：大規模なアプリケーションでは、Redis, Memcachedなどを使った分散セッション管理を検討します。</li>
                        </ul>

                        <h4>JSP/Servletでのセッション管理の良い習慣</h4>
                        <ul>
                            <li><strong>セッションの明示的な取得</strong>：新規セッションが不要な場合は<span class="inline-code">request.getSession(false)</span>を使用します。</li>
                            <li><strong>セッション属性の一貫した命名規則</strong>：命名規則を守り、名前の衝突を避けます。</li>
                            <li><strong>不要な属性の削除</strong>：不要になった属性は明示的に削除し、メモリを解放します。</li>
                            <li><strong>例外処理</strong>：セッション関連の処理では適切な例外処理を行います。</li>
                            <li><strong>リスナーの活用</strong>：<span class="inline-code">HttpSessionListener</span>などを使用して、セッションのライフサイクルを監視します。</li>
                        </ul>

                        <h5>セッションリスナーの実装例</h5>
                        <code>@WebListener
public class SessionMonitorListener implements HttpSessionListener {
    
    @Override
    public void sessionCreated(HttpSessionEvent se) {
        HttpSession session = se.getSession();
        System.out.println("セッション作成: " + session.getId());
        
        // アクティブセッション数のカウントなど
        ServletContext context = session.getServletContext();
        Integer activeSessions = (Integer) context.getAttribute("activeSessions");
        if (activeSessions == null) {
            activeSessions = 1;
        } else {
            activeSessions++;
        }
        context.setAttribute("activeSessions", activeSessions);
        
        System.out.println("アクティブセッション数: " + activeSessions);
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent se) {
        HttpSession session = se.getSession();
        System.out.println("セッション破棄: " + session.getId());
        
        // アクティブセッション数の更新
        ServletContext context = session.getServletContext();
        Integer activeSessions = (Integer) context.getAttribute("activeSessions");
        if (activeSessions != null) {
            context.setAttribute("activeSessions", activeSessions - 1);
        }
    }
}</code>

                        <div class="note">
                            <h5>セッション管理の戦略</h5>
                            <p>アプリケーションの特性に合わせて、以下のようなセッション管理戦略を検討してください：</p>
                            <ul>
                                <li><strong>ステートレスアプローチ</strong>：可能な限りセッションを使用せず、JWT（JSON Web Token）などのトークンベースの認証を使用する</li>
                                <li><strong>ハイブリッドアプローチ</strong>：軽量な認証情報はトークンで、ショッピングカートなどの重要な状態はセッションで管理する</li>
                                <li><strong>分散セッション管理</strong>：Redis, Memcached, Database などを使用して、アプリケーションサーバーとは別にセッションを管理する</li>
                            </ul>
                        </div>

                        <div class="warning">
                            <h5>セッション関連の一般的な問題</h5>
                            <ul>
                                <li><strong>セッションハイジャック</strong>：他のユーザーのセッションIDを盗み取り、なりすましを行う攻撃</li>
                                <li><strong>セッション固定化攻撃</strong>：攻撃者が事前に用意したセッションIDを被害者に利用させる攻撃</li>
                                <li><strong>クロスサイトスクリプティング（XSS）</strong>：スクリプトを埋め込み、Cookieやセッション情報を盗む攻撃</li>
                                <li><strong>セッションリーク</strong>：セッションが適切に終了されず、サーバーのメモリを消費し続ける問題</li>
                            </ul>
                            <p>これらの問題に対処するためには、上記のベストプラクティスを適用することが重要です。</p>
                        </div>

                        <div class="exercise">
                            <h5>演習 7.6.1: セキュアなセッション管理の実装</h5>
                            <p>以下の要件を満たすように、セキュアなセッション管理機能を実装してください：</p>
                            <ol>
                                <li>セッションIDを定期的に再生成する機能（ログイン成功時、権限変更時など）</li>
                                <li>セッションの同時ログイン制限機能（同じユーザーIDで複数のセッションを作成しない）</li>
                                <li>セッション監視リスナーを実装し、不審なセッション活動をログに記録する</li>
                                <li>セッションタイムアウトを設定し、一定時間操作がないセッションを自動的に終了する</li>
                            </ol>
                        </div>
                    </section>

                    <section id="chapter7-quiz">
                        <h3 class="section-title">7.7 理解度確認テスト</h3>
                        <div class="quiz-container">
                            <h4>第7章の理解度チェック</h4>
                            <p>以下の問題に答えて、第7章の内容の理解度を確認しましょう。</p>
                            
                            <div class="quiz-question">
                                <p><strong>問題1:</strong> JSP/Servletにおける4つのスコープのうち、最も短い生存期間を持つものはどれですか？</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q1" id="q1a" value="a">
                                    <label class="form-check-label" for="q1a">
                                        Requestスコープ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q1" id="q1b" value="b">
                                    <label class="form-check-label" for="q1b">
                                        Sessionスコープ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q1" id="q1c" value="c">
                                        <label class="form-check-label" for="q1c">
                                        Pageスコープ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q1" id="q1d" value="d">
                                        <label class="form-check-label" for="q1d">
                                        Applicationスコープ
                                    </label>
                                </div>
                            </div>
                            
                            <div class="quiz-question">
                                <p><strong>問題2:</strong> ログインしたユーザーの情報を保存するのに最も適切なスコープはどれですか？</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q2" id="q2a" value="a">
                                    <label class="form-check-label" for="q2a">
                                        Pageスコープ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q2" id="q2b" value="b">
                                    <label class="form-check-label" for="q2b">
                                        Requestスコープ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q2" id="q2c" value="c">
                                        <label class="form-check-label" for="q2c">
                                        Sessionスコープ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q2" id="q2d" value="d">
                                        <label class="form-check-label" for="q2d">
                                        Applicationスコープ
                                    </label>
                                </div>
                            </div>
                            
                            <div class="quiz-question">
                                <p><strong>問題3:</strong> セッションを取得するための正しいコードはどれですか？</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q3" id="q3a" value="a">
                                    <label class="form-check-label" for="q3a">
                                        Session session = new Session();
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q3" id="q3b" value="b">
                                    <label class="form-check-label" for="q3b">
                                        HttpSession session = request.getSession();
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q3" id="q3c" value="c">
                                        <label class="form-check-label" for="q3c">
                                        HttpSession session = response.getSession();
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q3" id="q3d" value="d">
                                        <label class="form-check-label" for="q3d">
                                        Session session = request.createSession();
                                    </label>
                                </div>
                            </div>
                            
                            <div class="quiz-question">
                                <p><strong>問題4:</strong> セッションを無効化するための正しいコードはどれですか？</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q4" id="q4a" value="a">
                                    <label class="form-check-label" for="q4a">
                                        session.invalidate();
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q4" id="q4b" value="b">
                                    <label class="form-check-label" for="q4b">
                                        session.destroy();
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q4" id="q4c" value="c">
                                        <label class="form-check-label" for="q4c">
                                        session.close();
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q4" id="q4d" value="d">
                                        <label class="form-check-label" for="q4d">
                                        session.remove();
                                    </label>
                                </div>
                            </div>
                            
                            <div class="quiz-question">
                                <p><strong>問題5:</strong> セッションタイムアウトを20分に設定するためのweb.xmlの記述で正しいものはどれですか？</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q5" id="q5a" value="a">
                                    <label class="form-check-label" for="q5a">
                                        &lt;session-config&gt;&lt;timeout&gt;20&lt;/timeout&gt;&lt;/session-config&gt;
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q5" id="q5b" value="b">
                                    <label class="form-check-label" for="q5b">
                                        &lt;session-config&gt;&lt;session-timeout&gt;20&lt;/session-timeout&gt;&lt;/session-config&gt;
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q5" id="q5c" value="c">
                                        <label class="form-check-label" for="q5c">
                                        &lt;session&gt;&lt;timeout&gt;20&lt;/timeout&gt;&lt;/session&gt;
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q5" id="q5d" value="d">
                                        <label class="form-check-label" for="q5d">
                                        &lt;session-timeout&gt;20&lt;/session-timeout&gt;
                                    </label>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary mt-3" id="checkAnswers">回答を確認</button>
                            <div id="quizResults" class="mt-3 d-none">
                                <div class="alert alert-success">
                                    <h5>正解:</h5>
                                    <ol>
                                        <li>c（Pageスコープ - JSPページの処理中のみ有効）</li>
                                        <li>c（Sessionスコープ - ユーザーのセッション期間中有効）</li>
                                        <li>b（HttpSession session = request.getSession();）</li>
                                        <li>a（session.invalidate();）</li>
                                        <li>b（&lt;session-config&gt;&lt;session-timeout&gt;20&lt;/session-timeout&gt;&lt;/session-config&gt;）</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="next-steps">
                        <h3 class="section-title">次のステップ</h3>
                        <p>この章では、JSP/Servletにおけるスコープの概念とセッション管理の方法について学びました。次の章では、データベース連携についてさらに深く学びます。</p>
                        <p>セッション管理は多くのWebアプリケーションで重要な要素ですので、この章の内容をしっかりと理解し、実際にアプリケーションを開発する際に活用してください。</p>
                        <div class="note">
                            <h5>推奨される追加学習</h5>
                            <ul>
                                <li><strong>Jakarta EEのドキュメント</strong>：<a href="https://jakarta.ee/specifications/servlet/" target="_blank">Jakarta Servlet Specification</a></li>
                                <li><strong>セキュアなセッション管理</strong>：<a href="https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html" target="_blank">OWASP Session Management Cheat Sheet</a></li>
                                <li><strong>JWT（JSON Web Token）認証</strong>：トークンベースの認証メカニズムについて学習する</li>
                            </ul>
                        </div>
                    </section>
                </section>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-4">
        <div class="container">
            <p class="mb-0">Copyright © 2025 F-Circle All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 理解度テストの回答確認ボタンの処理
        document.getElementById('checkAnswers').addEventListener('click', function() {
            document.getElementById('quizResults').classList.remove('d-none');
        });
    </script>
</body>
</html>