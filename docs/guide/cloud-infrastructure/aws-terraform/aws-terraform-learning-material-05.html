<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Terraform学習教材 第5章 - ストレージとデータベースサービス</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/hcl.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- カスタムCSS -->
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #FF9900;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .navbar-brand i {
            margin-right: 10px;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }

        .chapter-title {
            color: #FF9900;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #FF9900;
            padding-bottom: 0.5rem;
            font-weight: 600;
        }

        .section-title {
            color: #FF6600;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }

        .quiz-container {
            background-color: #FFF3E0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #FF9900;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info-box {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #2196f3;
        }

        .code-block {
            background-color: #1e1e1e;
            color: white;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .nav-link.active {
            background-color: #FF9900 !important;
            color: white !important;
            font-weight: 500;
        }

        .nav-link {
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 2px 0;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background-color: #FFF3E0;
            color: #FF6600;
        }

        .concept-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .concept-card h4 {
            color: #FF6600;
            margin-bottom: 15px;
        }

        .term-definition {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4169e1;
        }

        .term-definition dt {
            font-weight: bold;
            color: #4169e1;
            margin-bottom: 8px;
        }

        .term-definition dd {
            margin-left: 20px;
            color: #333;
        }

        .footer {
            background-color: #333;
            color: white;
            padding: 2rem 0;
            margin-top: 4rem;
        }

        .mermaid {
            margin: 20px 0;
            text-align: center;
        }

        pre.code-block code {
            display: block;
            padding: 0 !important;
            background: transparent !important;
        }

        .comparison-table {
            margin: 20px 0;
        }

        .comparison-table th {
            background-color: #FF9900;
            color: white;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fab fa-aws"></i>
                AWS Terraform 学習教材
            </a>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-01.html">
                                第1章: Terraform入門とAWS環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-02.html">
                                第2章: HCL構文とTerraformの基本操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-03.html">
                                第3章: VPCとネットワークインフラの構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-04.html">
                                第4章: EC2インスタンスとコンピューティングリソース
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aws-terraform-learning-material-05.html">
                                第5章: ストレージとデータベースサービス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-06.html">
                                第6章: IAMとセキュリティ管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-07.html">
                                第7章: Terraformステート管理とバックエンド
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-08.html">
                                第8章: Terraformモジュールとコードの再利用
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-09.html">
                                第9章: CI/CDパイプラインとの統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-10.html">
                                第10章: 実践プロジェクトとベストプラクティス
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第5章: ストレージとデータベースサービス</h1>
                </div>

                <div id="chapter5">
                    <h2 class="chapter-title">データの永続化とストレージ戦略</h2>

                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5><i class="fas fa-graduation-cap"></i> この章で学ぶこと</h5>
                        <ul>
                            <li>S3バケットの作成と設定、バージョニングとライフサイクルポリシー</li>
                            <li>RDS（Relational Database Service）によるデータベース管理</li>
                            <li>DynamoDBによるNoSQLデータベースの構築</li>
                            <li>EBS（Elastic Block Store）ボリュームの管理</li>
                            <li>バックアップとディザスタリカバリ戦略の実装</li>
                        </ul>
                    </div>

                    <!-- Section 5.1 -->
                    <h3 class="section-title">5.1 S3（Simple Storage Service）の活用</h3>

                    <div class="concept-card">
                        <h4>S3の基本概念と特徴</h4>
                        <p>
                            S3は、AWSが提供するオブジェクトストレージサービスです。
                            高い耐久性（99.999999999%）と可用性を持ち、実質無制限の容量を提供します。
                        </p>

                        <div class="mermaid">
                            flowchart TD
                                A[S3バケット] --> B[オブジェクト<br/>（ファイル）]
                                A --> C[メタデータ]
                                A --> D[権限設定]
                                B --> E[キー<br/>（ファイル名）]
                                B --> F[値<br/>（データ本体）]
                                B --> G[バージョンID]
                                D --> H[バケットポリシー]
                                D --> I[ACL]
                                D --> J[パブリックアクセス<br/>ブロック]
                                A --> K[ストレージクラス]
                                K --> L[Standard]
                                K --> M[Standard-IA]
                                K --> N[Glacier]
                        </div>
                    </div>

                    <div class="term-definition">
                        <dt>S3ストレージクラスの選択基準</dt>
                        <dd>
                            <ul>
                                <li><strong>Standard</strong>：頻繁にアクセスされるデータ、低レイテンシ</li>
                                <li><strong>Standard-IA</strong>：アクセス頻度が低いが、即座に必要なデータ</li>
                                <li><strong>One Zone-IA</strong>：単一AZ、再作成可能なデータ</li>
                                <li><strong>Intelligent-Tiering</strong>：アクセスパターンが不明なデータ</li>
                                <li><strong>Glacier Instant</strong>：四半期に1回程度アクセス、ミリ秒単位の取得</li>
                                <li><strong>Glacier Flexible</strong>：年に1-2回アクセス、取得に分～時間</li>
                                <li><strong>Glacier Deep Archive</strong>：7-10年保管、取得に12時間</li>
                            </ul>
                        </dd>
                    </div>

                    <div class="concept-card">
                        <h4>S3バケットの作成と設定</h4>

                        <pre class="code-block"><code class="language-hcl"># s3.tf - S3バケットの包括的な設定

# メインのS3バケット
resource "aws_s3_bucket" "main" {
  bucket = "${var.project_name}-${var.environment}-data"

  # 誤削除防止
  force_destroy = false

  tags = {
    Name        = "${var.project_name}-main-bucket"
    Environment = var.environment
    ManagedBy   = "Terraform"
  }
}

# バージョニング設定
resource "aws_s3_bucket_versioning" "main" {
  bucket = aws_s3_bucket.main.id

  versioning_configuration {
    status = "Enabled"
  }
}

# 暗号化設定
resource "aws_s3_bucket_server_side_encryption_configuration" "main" {
  bucket = aws_s3_bucket.main.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = aws_kms_key.s3.arn
    }
  }
}

# パブリックアクセスブロック
resource "aws_s3_bucket_public_access_block" "main" {
  bucket = aws_s3_bucket.main.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# ライフサイクルポリシー
resource "aws_s3_bucket_lifecycle_configuration" "main" {
  bucket = aws_s3_bucket.main.id

  rule {
    id     = "archive-old-data"
    status = "Enabled"

    # 30日後にStandard-IAへ移行
    transition {
      days          = 30
      storage_class = "STANDARD_IA"
    }

    # 90日後にGlacier Instantへ移行
    transition {
      days          = 90
      storage_class = "GLACIER_IR"
    }

    # 365日後にGlacier Deep Archiveへ移行
    transition {
      days          = 365
      storage_class = "DEEP_ARCHIVE"
    }

    # 7年後に削除
    expiration {
      days = 2555  # 7年
    }

    # 不完全なマルチパートアップロードを削除
    abort_incomplete_multipart_upload {
      days_after_initiation = 7
    }
  }

  rule {
    id     = "delete-old-versions"
    status = "Enabled"

    # 古いバージョンを90日後に削除
    noncurrent_version_expiration {
      noncurrent_days = 90
    }

    # 古いバージョンを30日後にStandard-IAへ
    noncurrent_version_transition {
      noncurrent_days = 30
      storage_class   = "STANDARD_IA"
    }
  }
}

# アクセスログ用バケット
resource "aws_s3_bucket" "logs" {
  bucket = "${var.project_name}-${var.environment}-logs"

  lifecycle_rule {
    enabled = true
    expiration {
      days = 30  # ログは30日後に自動削除
    }
  }
}

# メインバケットのアクセスログ設定
resource "aws_s3_bucket_logging" "main" {
  bucket = aws_s3_bucket.main.id

  target_bucket = aws_s3_bucket.logs.id
  target_prefix = "s3-access-logs/"
}

# CORS設定（Webアプリケーションからのアクセス用）
resource "aws_s3_bucket_cors_configuration" "main" {
  bucket = aws_s3_bucket.main.id

  cors_rule {
    allowed_headers = ["*"]
    allowed_methods = ["GET", "PUT", "POST", "DELETE", "HEAD"]
    allowed_origins = ["https://*.${var.domain_name}"]
    expose_headers  = ["ETag"]
    max_age_seconds = 3000
  }
}</code></pre>
                    </div>

                    <!-- Section 5.2 -->
                    <h3 class="section-title">5.2 RDS（Relational Database Service）</h3>

                    <div class="concept-card">
                        <h4>RDSの概要とメリット</h4>
                        <p>
                            RDSは、リレーショナルデータベースのマネージドサービスです。
                            バックアップ、パッチ適用、フェイルオーバーなどを自動化し、
                            データベース管理の負荷を大幅に削減します。
                        </p>

                        <div class="info-box">
                            <h6><i class="fas fa-database"></i> RDSがサポートするデータベースエンジン</h6>
                            <ul>
                                <li>Amazon Aurora（MySQL/PostgreSQL互換）</li>
                                <li>MySQL</li>
                                <li>MariaDB</li>
                                <li>PostgreSQL</li>
                                <li>Oracle Database</li>
                                <li>Microsoft SQL Server</li>
                            </ul>
                        </div>

                        <pre class="code-block"><code class="language-hcl"># rds.tf - 高可用性RDSインスタンスの構築

# DBサブネットグループ
resource "aws_db_subnet_group" "main" {
  name       = "${var.project_name}-db-subnet-group"
  subnet_ids = aws_subnet.private_db[*].id

  tags = {
    Name = "${var.project_name}-db-subnet-group"
  }
}

# DBパラメータグループ
resource "aws_db_parameter_group" "main" {
  name   = "${var.project_name}-db-params"
  family = "mysql8.0"

  parameter {
    name  = "character_set_server"
    value = "utf8mb4"
  }

  parameter {
    name  = "collation_server"
    value = "utf8mb4_unicode_ci"
  }

  parameter {
    name  = "max_connections"
    value = "1000"
  }

  parameter {
    name  = "slow_query_log"
    value = "1"
  }

  parameter {
    name  = "long_query_time"
    value = "1"
  }

  tags = {
    Name = "${var.project_name}-db-params"
  }
}

# オプショングループ
resource "aws_db_option_group" "main" {
  name                     = "${var.project_name}-db-options"
  option_group_description = "DB option group for ${var.project_name}"
  engine_name              = "mysql"
  major_engine_version     = "8.0"

  option {
    option_name = "MARIADB_AUDIT_PLUGIN"

    option_settings {
      name  = "SERVER_AUDIT_EVENTS"
      value = "CONNECT,QUERY"
    }
  }

  tags = {
    Name = "${var.project_name}-db-options"
  }
}

# RDSインスタンス（プライマリ）
resource "aws_db_instance" "main" {
  identifier = "${var.project_name}-db"

  # エンジン設定
  engine         = "mysql"
  engine_version = "8.0.35"
  instance_class = var.db_instance_class

  # ストレージ設定
  allocated_storage     = 100
  max_allocated_storage = 1000  # 自動スケーリング上限
  storage_type          = "gp3"
  storage_encrypted     = true
  kms_key_id           = aws_kms_key.rds.arn
  iops                 = 3000

  # データベース設定
  db_name  = var.db_name
  username = var.db_username
  password = random_password.db_password.result

  # ネットワーク設定
  db_subnet_group_name   = aws_db_subnet_group.main.name
  vpc_security_group_ids = [aws_security_group.rds.id]
  publicly_accessible    = false

  # パラメータ・オプショングループ
  parameter_group_name = aws_db_parameter_group.main.name
  option_group_name    = aws_db_option_group.main.name

  # バックアップ設定
  backup_retention_period = 30  # 30日間保持
  backup_window          = "03:00-04:00"  # JST 12:00-13:00
  maintenance_window     = "sun:04:00-sun:05:00"  # JST 日曜13:00-14:00

  # 高可用性設定
  multi_az               = true
  auto_minor_version_upgrade = false
  deletion_protection    = var.environment == "production" ? true : false
  skip_final_snapshot    = false
  final_snapshot_identifier = "${var.project_name}-db-final-snapshot-${formatdate("YYYY-MM-DD-hhmm", timestamp())}"

  # モニタリング
  enabled_cloudwatch_logs_exports = ["error", "general", "slowquery"]
  performance_insights_enabled    = true
  performance_insights_retention_period = 7
  monitoring_interval            = 60
  monitoring_role_arn           = aws_iam_role.rds_monitoring.arn

  tags = {
    Name        = "${var.project_name}-db"
    Environment = var.environment
  }
}

# リードレプリカ
resource "aws_db_instance" "read_replica" {
  count = var.enable_read_replica ? var.read_replica_count : 0

  identifier             = "${var.project_name}-db-read-${count.index + 1}"
  replicate_source_db    = aws_db_instance.main.identifier
  instance_class         = var.db_instance_class

  # リードレプリカ独自の設定
  publicly_accessible = false
  auto_minor_version_upgrade = false

  # パフォーマンスインサイト
  performance_insights_enabled = true

  tags = {
    Name        = "${var.project_name}-db-read-${count.index + 1}"
    Environment = var.environment
    Type        = "ReadReplica"
  }
}

# データベースパスワード生成
resource "random_password" "db_password" {
  length  = 32
  special = true
}

# パスワードをSecrets Managerに保存
resource "aws_secretsmanager_secret" "db_password" {
  name = "${var.project_name}-db-password"
}

resource "aws_secretsmanager_secret_version" "db_password" {
  secret_id     = aws_secretsmanager_secret.db_password.id
  secret_string = jsonencode({
    username = var.db_username
    password = random_password.db_password.result
    engine   = "mysql"
    host     = aws_db_instance.main.address
    port     = aws_db_instance.main.port
    dbname   = var.db_name
  })
}</code></pre>
                    </div>

                    <!-- Section 5.3 -->
                    <h3 class="section-title">5.3 DynamoDB - NoSQLデータベース</h3>

                    <div class="concept-card">
                        <h4>DynamoDBの特徴と使用場面</h4>
                        <p>
                            DynamoDBは、完全マネージド型のNoSQLデータベースサービスです。
                            ミリ秒レベルのレイテンシーと、実質無制限のスケーラビリティを提供します。
                        </p>

                        <div class="mermaid">
                            flowchart TD
                                A[DynamoDBテーブル] --> B[パーティションキー<br/>（必須）]
                                A --> C[ソートキー<br/>（オプション）]
                                A --> D[属性<br/>（スキーマレス）]
                                A --> E[グローバルセカンダリインデックス<br/>（GSI）]
                                A --> F[ローカルセカンダリインデックス<br/>（LSI）]
                                A --> G[キャパシティモード]
                                G --> H[プロビジョンド]
                                G --> I[オンデマンド]
                                H --> J[読み込みキャパシティユニット]
                                H --> K[書き込みキャパシティユニット]
                        </div>

                        <pre class="code-block"><code class="language-hcl"># dynamodb.tf

# DynamoDBテーブル（ユーザーセッション管理）
resource "aws_dynamodb_table" "sessions" {
  name           = "${var.project_name}-sessions"
  billing_mode   = "PAY_PER_REQUEST"  # オンデマンド
  hash_key       = "session_id"
  range_key      = "user_id"

  attribute {
    name = "session_id"
    type = "S"
  }

  attribute {
    name = "user_id"
    type = "S"
  }

  attribute {
    name = "created_at"
    type = "N"
  }

  # グローバルセカンダリインデックス
  global_secondary_index {
    name            = "UserIdIndex"
    hash_key        = "user_id"
    range_key       = "created_at"
    projection_type = "ALL"
  }

  # TTL設定（期限切れデータの自動削除）
  ttl {
    attribute_name = "expiry_time"
    enabled        = true
  }

  # ポイントインタイムリカバリ
  point_in_time_recovery {
    enabled = true
  }

  # 暗号化設定
  server_side_encryption {
    enabled     = true
    kms_key_arn = aws_kms_key.dynamodb.arn
  }

  # ストリーム設定（変更の追跡）
  stream_enabled   = true
  stream_view_type = "NEW_AND_OLD_IMAGES"

  tags = {
    Name        = "${var.project_name}-sessions"
    Environment = var.environment
  }
}

# DynamoDBテーブル（商品カタログ）
resource "aws_dynamodb_table" "products" {
  name             = "${var.project_name}-products"
  billing_mode     = "PROVISIONED"
  read_capacity    = 5
  write_capacity   = 5
  hash_key         = "product_id"

  attribute {
    name = "product_id"
    type = "S"
  }

  attribute {
    name = "category"
    type = "S"
  }

  attribute {
    name = "price"
    type = "N"
  }

  # GSI for category queries
  global_secondary_index {
    name            = "CategoryPriceIndex"
    hash_key        = "category"
    range_key       = "price"
    read_capacity   = 3
    write_capacity  = 3
    projection_type = "ALL"
  }

  # Auto Scaling設定
  lifecycle {
    ignore_changes = [read_capacity, write_capacity]
  }
}

# Auto Scaling for DynamoDB
resource "aws_appautoscaling_target" "dynamodb_read" {
  service_namespace  = "dynamodb"
  resource_id        = "table/${aws_dynamodb_table.products.name}"
  scalable_dimension = "dynamodb:table:ReadCapacityUnits"
  min_capacity       = 5
  max_capacity       = 100
}

resource "aws_appautoscaling_policy" "dynamodb_read_policy" {
  name               = "${var.project_name}-dynamodb-read-scaling"
  service_namespace  = aws_appautoscaling_target.dynamodb_read.service_namespace
  resource_id        = aws_appautoscaling_target.dynamodb_read.resource_id
  scalable_dimension = aws_appautoscaling_target.dynamodb_read.scalable_dimension
  policy_type        = "TargetTrackingScaling"

  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = "DynamoDBReadCapacityUtilization"
    }
    target_value = 70.0
  }
}</code></pre>
                    </div>

                    <!-- Section 5.4 -->
                    <h3 class="section-title">5.4 EBSボリュームとスナップショット</h3>

                    <div class="concept-card">
                        <h4>EBSボリュームタイプの選択</h4>

                        <table class="table table-bordered comparison-table">
                            <thead>
                                <tr>
                                    <th>ボリュームタイプ</th>
                                    <th>用途</th>
                                    <th>最大IOPS</th>
                                    <th>最大スループット</th>
                                    <th>価格</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>gp3</td>
                                    <td>汎用SSD（最新）</td>
                                    <td>16,000</td>
                                    <td>1,000 MB/s</td>
                                    <td>低</td>
                                </tr>
                                <tr>
                                    <td>gp2</td>
                                    <td>汎用SSD（旧世代）</td>
                                    <td>16,000</td>
                                    <td>250 MB/s</td>
                                    <td>低</td>
                                </tr>
                                <tr>
                                    <td>io2</td>
                                    <td>高性能SSD</td>
                                    <td>64,000</td>
                                    <td>1,000 MB/s</td>
                                    <td>高</td>
                                </tr>
                                <tr>
                                    <td>st1</td>
                                    <td>スループット最適化HDD</td>
                                    <td>500</td>
                                    <td>500 MB/s</td>
                                    <td>最低</td>
                                </tr>
                            </tbody>
                        </table>

                        <pre class="code-block"><code class="language-hcl"># ebs.tf - EBSボリュームとスナップショット管理

# 追加のEBSボリューム
resource "aws_ebs_volume" "data" {
  availability_zone = aws_instance.app.availability_zone
  size              = 100
  type              = "gp3"
  iops              = 3000
  throughput        = 125
  encrypted         = true
  kms_key_id        = aws_kms_key.ebs.arn

  tags = {
    Name        = "${var.project_name}-data-volume"
    Environment = var.environment
  }
}

# EC2インスタンスへのアタッチ
resource "aws_volume_attachment" "data" {
  device_name = "/dev/sdf"
  volume_id   = aws_ebs_volume.data.id
  instance_id = aws_instance.app.id
}

# スナップショット作成
resource "aws_ebs_snapshot" "data" {
  volume_id   = aws_ebs_volume.data.id
  description = "Snapshot of ${var.project_name} data volume"

  tags = {
    Name        = "${var.project_name}-data-snapshot"
    Environment = var.environment
    CreatedAt   = timestamp()
  }
}

# Data Lifecycle Manager（自動バックアップ）
resource "aws_dlm_lifecycle_policy" "backup" {
  description        = "EBS backup policy for ${var.project_name}"
  execution_role_arn = aws_iam_role.dlm_lifecycle_role.arn
  state              = "ENABLED"

  policy_details {
    resource_types = ["VOLUME"]

    schedule {
      name = "daily-snapshots"

      create_rule {
        interval      = 24
        interval_unit = "HOURS"
        times         = ["03:00"]  # UTC
      }

      retain_rule {
        count = 7  # 7日分保持
      }

      tags_to_add = {
        SnapshotCreator = "DLM"
        Environment     = var.environment
      }

      copy_tags = true
    }

    target_tags = {
      Backup = "true"
    }
  }

  tags = {
    Name = "${var.project_name}-backup-policy"
  }
}</code></pre>
                    </div>

                    <div class="warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> データ保護のベストプラクティス</h6>
                        <ul>
                            <li>すべてのEBSボリュームとRDSインスタンスで暗号化を有効化</li>
                            <li>定期的なスナップショット/バックアップの自動化</li>
                            <li>クロスリージョンバックアップの検討</li>
                            <li>削除保護（deletion protection）の有効化</li>
                            <li>重要データは複数のストレージサービスで冗長化</li>
                        </ul>
                    </div>

                    <!-- 実習課題 -->
                    <div class="exercise-container">
                        <h5><i class="fas fa-laptop-code"></i> 実習課題：3層アーキテクチャのデータ層構築</h5>

                        <h6>課題内容</h6>
                        <p>Webアプリケーションのデータ層を以下の要件で構築してください：</p>
                        <ol>
                            <li>静的コンテンツ用のS3バケット（CloudFront連携）</li>
                            <li>Multi-AZ構成のRDS（MySQL）インスタンス</li>
                            <li>セッション管理用のDynamoDBテーブル</li>
                            <li>すべてのデータストアで暗号化を有効化</li>
                            <li>自動バックアップとポイントインタイムリカバリの設定</li>
                        </ol>

                        <h6>考慮事項</h6>
                        <ul>
                            <li>各サービスの適切なサイジングとコスト最適化</li>
                            <li>セキュリティグループとNACLの適切な設定</li>
                            <li>バックアップ戦略とRPO/RTOの設定</li>
                            <li>モニタリングとアラートの実装</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5><i class="fas fa-question-circle"></i> 理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>S3のストレージクラスを選択する基準は？</strong>
                                <ul>
                                    <li>アクセス頻度：頻繁ならStandard、稀ならGlacier系</li>
                                    <li>取得速度：即座に必要ならIA系、時間があるならGlacier</li>
                                    <li>データの重要性：再作成可能ならOne Zone-IA</li>
                                    <li>コスト：長期保管ならGlacier Deep Archive</li>
                                </ul>
                            </li>
                            <li>
                                <strong>RDSとAuroraの違いは？</strong>
                                <ul>
                                    <li>Aurora：クラウドネイティブ、自動フェイルオーバー、高速</li>
                                    <li>RDS：従来型DB、より多くのエンジン選択肢</li>
                                    <li>Aurora：ストレージ自動拡張、リードレプリカ最大15台</li>
                                    <li>RDS：ストレージ事前定義、リードレプリカ最大5台</li>
                                </ul>
                            </li>
                            <li>
                                <strong>DynamoDBのキャパシティモードの選択基準は？</strong>
                                <ul>
                                    <li>オンデマンド：トラフィックが予測不可能、スパイクあり</li>
                                    <li>プロビジョンド：安定したトラフィック、コスト最適化</li>
                                    <li>オンデマンド：開発環境、新規アプリケーション</li>
                                    <li>プロビジョンド：本番環境、Auto Scaling併用</li>
                                </ul>
                            </li>
                            <li>
                                <strong>EBSスナップショットの特徴は？</strong>
                                <ul>
                                    <li>増分バックアップ（初回以降は差分のみ）</li>
                                    <li>S3に保存されるが直接アクセス不可</li>
                                    <li>リージョン間コピーが可能</li>
                                    <li>暗号化ボリュームのスナップショットも暗号化される</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <!-- 章のまとめ -->
                    <div class="concept-card">
                        <h4><i class="fas fa-bookmark"></i> この章のまとめ</h4>
                        <p>
                            第5章では、AWSの主要なストレージとデータベースサービスをTerraformで管理する方法を学びました。
                            S3によるオブジェクトストレージ、RDSによるリレーショナルデータベース、
                            DynamoDBによるNoSQLデータベース、そしてEBSボリュームの管理について、
                            実践的な設定方法を習得しました。
                        </p>
                        <p>
                            特に重要なのは、各サービスの特性を理解し、要件に応じて適切なサービスと
                            設定を選択することです。また、暗号化、バックアップ、高可用性の設定により、
                            データの安全性と可用性を確保する方法も学びました。
                        </p>
                        <p>
                            次章では、これらのリソースへのアクセスを制御するIAMとセキュリティ管理について
                            詳しく学習します。
                        </p>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aws-terraform-learning-material-04.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aws-terraform-learning-material-06.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>

    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>