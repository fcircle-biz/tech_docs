<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Terraform学習教材 第3章 - VPCとネットワークインフラの構築</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/hcl.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- カスタムCSS -->
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #FF9900;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .navbar-brand i {
            margin-right: 10px;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }

        .chapter-title {
            color: #FF9900;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #FF9900;
            padding-bottom: 0.5rem;
            font-weight: 600;
        }

        .section-title {
            color: #FF6600;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }

        .quiz-container {
            background-color: #FFF3E0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #FF9900;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info-box {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #2196f3;
        }

        .success-box {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .code-block {
            background-color: #1e1e1e;
            color: white;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .nav-link.active {
            background-color: #FF9900 !important;
            color: white !important;
            font-weight: 500;
        }

        .nav-link {
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 2px 0;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background-color: #FFF3E0;
            color: #FF6600;
        }

        .concept-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .concept-card h4 {
            color: #FF6600;
            border-bottom: 2px solid #FFE0B2;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .term-definition {
            background-color: #FFFDE7;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            border-left: 3px solid #FFB300;
        }

        .term-definition dt {
            color: #FF6F00;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .network-diagram {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .cidr-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }

        .cidr-table table {
            width: 100%;
            margin: 0;
        }

        .cidr-table th {
            background-color: #FF9900;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .cidr-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .cidr-table tr:hover {
            background-color: #FFF3E0;
        }

        .best-practice-box {
            background-color: #F3E5F5;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #9C27B0;
        }

        footer {
            margin-top: auto;
        }

        .mermaid {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <i class="fab fa-aws"></i>
                <strong>AWS Terraform学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-01.html">
                                第1章: Terraform入門とAWS環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-02.html">
                                第2章: HCL構文とTerraformの基本操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aws-terraform-learning-material-03.html">
                                第3章: VPCとネットワークインフラの構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-04.html">
                                第4章: EC2インスタンスとコンピューティングリソース
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-05.html">
                                第5章: ストレージとデータベースサービス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-06.html">
                                第6章: IAMとセキュリティ管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-07.html">
                                第7章: Terraformステート管理とバックエンド
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-08.html">
                                第8章: Terraformモジュールとコードの再利用
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-09.html">
                                第9章: CI/CDパイプラインとの統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-10.html">
                                第10章: 実践プロジェクトとベストプラクティス
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第3章: VPCとネットワークインフラの構築</h1>
                </div>

                <div id="chapter3">
                    <h2 class="chapter-title">セキュアなネットワーク環境をコードで構築する</h2>

                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5><i class="fas fa-graduation-cap"></i> この章で学ぶこと</h5>
                        <ul>
                            <li>VPCとサブネットを適切に設計・構築できる</li>
                            <li>インターネットゲートウェイとNATゲートウェイを設定できる</li>
                            <li>ルートテーブルとセキュリティグループを適切に設定できる</li>
                            <li>ネットワークのベストプラクティスを理解する</li>
                        </ul>
                    </div>

                    <!-- Section 3.1 -->
                    <h3 class="section-title">3.1 VPCの設計と構築</h3>

                    <div class="concept-card">
                        <h4>VPC（Virtual Private Cloud）の概念</h4>
                        <p>
                            VPCはAWS上に作成する仮想的なプライベートネットワークです。
                            従来のデータセンターのネットワークと同じように、IPアドレス範囲を定義し、
                            サブネットを作成し、ルーティングやセキュリティ設定を行うことができます。
                        </p>

                        <div class="term-definition">
                            <dt>VPCの主な特徴</dt>
                            <dd>
                                <ul>
                                    <li>完全に隔離された仮想ネットワーク環境</li>
                                    <li>自由にIPアドレス範囲（CIDR）を設定可能</li>
                                    <li>複数のアベイラビリティゾーン（AZ）にまたがることが可能</li>
                                    <li>インターネットやオンプレミスとの接続を柔軟に設定</li>
                                </ul>
                            </dd>
                        </div>

                        <div class="mermaid">
                            flowchart TB
                                subgraph AWS["AWSクラウド"]
                                    subgraph VPC["VPC (10.0.0.0/16)"]
                                        subgraph AZ1["アベイラビリティゾーンA"]
                                            PS1["パブリックサブネット<br/>10.0.1.0/24"]
                                            PRS1["プライベートサブネット<br/>10.0.11.0/24"]
                                        end
                                        subgraph AZ2["アベイラビリティゾーンB"]
                                            PS2["パブリックサブネット<br/>10.0.2.0/24"]
                                            PRS2["プライベートサブネット<br/>10.0.12.0/24"]
                                        end
                                    end
                                    IGW["インターネット<br/>ゲートウェイ"]
                                end
                                Internet["インターネット"]
                                Internet -.-> IGW
                                IGW -.-> PS1
                                IGW -.-> PS2
                        </div>
                    </div>

                    <div class="concept-card">
                        <h4>CIDR範囲の設計</h4>

                        <p>
                            CIDR（Classless Inter-Domain Routing）は、IPアドレスの範囲を表現する方法です。
                            VPCを設計する際は、将来の拡張性を考慮して適切なCIDR範囲を選択する必要があります。
                        </p>

                        <div class="cidr-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>CIDR表記</th>
                                        <th>IPアドレス範囲</th>
                                        <th>使用可能なIP数</th>
                                        <th>推奨用途</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>10.0.0.0/16</code></td>
                                        <td>10.0.0.0 - 10.0.255.255</td>
                                        <td>65,536</td>
                                        <td>大規模環境</td>
                                    </tr>
                                    <tr>
                                        <td><code>10.0.0.0/20</code></td>
                                        <td>10.0.0.0 - 10.0.15.255</td>
                                        <td>4,096</td>
                                        <td>中規模環境</td>
                                    </tr>
                                    <tr>
                                        <td><code>10.0.0.0/24</code></td>
                                        <td>10.0.0.0 - 10.0.0.255</td>
                                        <td>256</td>
                                        <td>小規模環境・サブネット</td>
                                    </tr>
                                    <tr>
                                        <td><code>10.0.0.0/28</code></td>
                                        <td>10.0.0.0 - 10.0.0.15</td>
                                        <td>16</td>
                                        <td>最小サブネット</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="info-box">
                            <h6><i class="fas fa-info-circle"></i> RFC 1918プライベートIPアドレス範囲</h6>
                            <ul>
                                <li><strong>10.0.0.0/8</strong> (10.0.0.0 - 10.255.255.255)</li>
                                <li><strong>172.16.0.0/12</strong> (172.16.0.0 - 172.31.255.255)</li>
                                <li><strong>192.168.0.0/16</strong> (192.168.0.0 - 192.168.255.255)</li>
                            </ul>
                            <p>これらの範囲はインターネット上でルーティングされないため、プライベートネットワークで自由に使用できます。</p>
                        </div>
                    </div>

                    <div class="concept-card">
                        <h4>TerraformでVPCを作成</h4>

                        <pre class="code-block"><code class="language-hcl"># vpc.tf - VPCの基本設定

# VPCの作成
resource "aws_vpc" "main" {
  cidr_block = "10.0.0.0/16"  # 65,536個のIPアドレス

  # DNSサポートの有効化（推奨）
  enable_dns_support   = true
  enable_dns_hostnames = true

  # VPC内のインスタンスにIPv6アドレスを割り当てる場合
  # assign_generated_ipv6_cidr_block = true

  tags = {
    Name        = "main-vpc"
    Environment = var.environment
    Project     = var.project_name
    ManagedBy   = "Terraform"
  }
}

# VPCのデフォルトセキュリティグループの設定
resource "aws_default_security_group" "default" {
  vpc_id = aws_vpc.main.id

  # デフォルトセキュリティグループは使用しないため、
  # すべてのトラフィックを拒否
  # （明示的にセキュリティグループを作成して使用する）

  tags = {
    Name = "default-sg-do-not-use"
    Note = "デフォルトSGは使用しない"
  }
}

# VPCのデフォルトネットワークACLの設定
resource "aws_default_network_acl" "default" {
  default_network_acl_id = aws_vpc.main.default_network_acl_id

  # デフォルトではすべてのトラフィックを許可
  ingress {
    protocol   = -1
    rule_no    = 100
    action     = "allow"
    cidr_block = "0.0.0.0/0"
    from_port  = 0
    to_port    = 0
  }

  egress {
    protocol   = -1
    rule_no    = 100
    action     = "allow"
    cidr_block = "0.0.0.0/0"
    from_port  = 0
    to_port    = 0
  }

  tags = {
    Name = "main-vpc-default-nacl"
  }
}</code></pre>

                        <div class="best-practice-box">
                            <h6><i class="fas fa-star"></i> VPC設計のベストプラクティス</h6>
                            <ul>
                                <li><strong>CIDR範囲は大きめに確保</strong>：後から変更できないため、将来の拡張を考慮</li>
                                <li><strong>サブネットは/24以上を推奨</strong>：AWSが予約するIPアドレス（5個）を考慮</li>
                                <li><strong>環境ごとにVPCを分離</strong>：開発、ステージング、本番は別VPCに</li>
                                <li><strong>リージョン間でCIDRが重複しないように</strong>：将来のVPCピアリングに備える</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 3.2 -->
                    <h3 class="section-title">3.2 サブネットの作成と管理</h3>

                    <div class="concept-card">
                        <h4>サブネット設計の原則</h4>

                        <p>
                            サブネットは、VPC内をさらに細かく分割したネットワーク領域です。
                            用途に応じてパブリックサブネットとプライベートサブネットを使い分けます。
                        </p>

                        <div class="term-definition">
                            <dt>パブリックサブネット</dt>
                            <dd>
                                インターネットゲートウェイ経由でインターネットと直接通信できるサブネット。
                                Webサーバー、ロードバランサーなど、外部からアクセスが必要なリソースを配置。
                            </dd>
                        </div>

                        <div class="term-definition">
                            <dt>プライベートサブネット</dt>
                            <dd>
                                インターネットから直接アクセスできないサブネット。
                                データベース、アプリケーションサーバーなど、保護が必要なリソースを配置。
                            </dd>
                        </div>

                        <div class="network-diagram">
                            <div class="mermaid">
                                flowchart TD
                                    subgraph "3層アーキテクチャのサブネット設計"
                                        subgraph "パブリック層"
                                            ALB["Application<br/>Load Balancer"]
                                            NAT1["NAT Gateway 1"]
                                            NAT2["NAT Gateway 2"]
                                        end
                                        subgraph "プライベート層（App）"
                                            APP1["App Server 1"]
                                            APP2["App Server 2"]
                                        end
                                        subgraph "プライベート層（DB）"
                                            DB1["RDS Primary"]
                                            DB2["RDS Standby"]
                                        end
                                        ALB --> APP1
                                        ALB --> APP2
                                        APP1 --> DB1
                                        APP2 --> DB1
                                        DB1 -.-> DB2
                                        APP1 --> NAT1
                                        APP2 --> NAT2
                                    end
                            </div>
                        </div>
                    </div>

                    <div class="concept-card">
                        <h4>マルチAZ構成のサブネット作成</h4>

                        <pre class="code-block"><code class="language-hcl"># subnets.tf - 高可用性を考慮したサブネット設計

# 利用可能なアベイラビリティゾーンを取得
data "aws_availability_zones" "available" {
  state = "available"
}

# ローカル変数でサブネット設計を定義
locals {
  azs = slice(data.aws_availability_zones.available.names, 0, 2)  # 2つのAZを使用

  # サブネットCIDRの計算
  # パブリック: 10.0.1.0/24, 10.0.2.0/24
  # プライベート（App）: 10.0.11.0/24, 10.0.12.0/24
  # プライベート（DB）: 10.0.21.0/24, 10.0.22.0/24
  public_subnet_cidrs  = [for i in range(2) : cidrsubnet(var.vpc_cidr, 8, i + 1)]
  private_subnet_cidrs = [for i in range(2) : cidrsubnet(var.vpc_cidr, 8, i + 11)]
  database_subnet_cidrs = [for i in range(2) : cidrsubnet(var.vpc_cidr, 8, i + 21)]
}

# パブリックサブネットの作成
resource "aws_subnet" "public" {
  count = length(local.azs)

  vpc_id                  = aws_vpc.main.id
  cidr_block              = local.public_subnet_cidrs[count.index]
  availability_zone       = local.azs[count.index]
  map_public_ip_on_launch = true  # 自動でパブリックIPを割り当て

  tags = {
    Name = format("public-subnet-%s", local.azs[count.index])
    Type = "Public"
    Tier = "Public"
    "kubernetes.io/role/elb" = "1"  # EKSで使用する場合のタグ
  }
}

# プライベートサブネット（アプリケーション層）
resource "aws_subnet" "private_app" {
  count = length(local.azs)

  vpc_id            = aws_vpc.main.id
  cidr_block        = local.private_subnet_cidrs[count.index]
  availability_zone = local.azs[count.index]

  tags = {
    Name = format("private-app-subnet-%s", local.azs[count.index])
    Type = "Private"
    Tier = "Application"
    "kubernetes.io/role/internal-elb" = "1"  # EKSで使用する場合のタグ
  }
}

# プライベートサブネット（データベース層）
resource "aws_subnet" "private_db" {
  count = length(local.azs)

  vpc_id            = aws_vpc.main.id
  cidr_block        = local.database_subnet_cidrs[count.index]
  availability_zone = local.azs[count.index]

  tags = {
    Name = format("private-db-subnet-%s", local.azs[count.index])
    Type = "Private"
    Tier = "Database"
  }
}

# RDS用のサブネットグループ
resource "aws_db_subnet_group" "database" {
  name       = "${var.project_name}-db-subnet-group"
  subnet_ids = aws_subnet.private_db[*].id

  tags = {
    Name = "${var.project_name}-db-subnet-group"
  }
}</code></pre>

                        <div class="info-box">
                            <h6><i class="fas fa-lightbulb"></i> cidrsubnet関数の使い方</h6>
                            <p>
                                <code>cidrsubnet(prefix, newbits, netnum)</code>は、
                                既存のCIDRブロックからサブネットを計算する便利な関数です。
                            </p>
                            <ul>
                                <li><strong>prefix</strong>: 元のCIDRブロック (例: "10.0.0.0/16")</li>
                                <li><strong>newbits</strong>: 追加するビット数 (8なら/16が/24になる)</li>
                                <li><strong>netnum</strong>: サブネット番号 (0から始まる)</li>
                            </ul>
                            <p>例: <code>cidrsubnet("10.0.0.0/16", 8, 1)</code> → "10.0.1.0/24"</p>
                        </div>
                    </div>

                    <!-- Section 3.3 -->
                    <h3 class="section-title">3.3 インターネット接続の設定</h3>

                    <div class="concept-card">
                        <h4>インターネットゲートウェイ（IGW）</h4>

                        <p>
                            インターネットゲートウェイは、VPCとインターネット間の通信を可能にする
                            水平スケーリング、冗長性、高可用性を備えたVPCコンポーネントです。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># internet_gateway.tf

# インターネットゲートウェイの作成
resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "${var.project_name}-igw"
  }
}

# パブリックサブネット用のルートテーブル
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "${var.project_name}-public-rt"
    Type = "Public"
  }
}

# インターネットへのルートを追加
resource "aws_route" "public_internet" {
  route_table_id         = aws_route_table.public.id
  destination_cidr_block = "0.0.0.0/0"
  gateway_id             = aws_internet_gateway.main.id
}

# パブリックサブネットにルートテーブルを関連付け
resource "aws_route_table_association" "public" {
  count = length(aws_subnet.public)

  subnet_id      = aws_subnet.public[count.index].id
  route_table_id = aws_route_table.public.id
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>NATゲートウェイの設定</h4>

                        <p>
                            NATゲートウェイは、プライベートサブネット内のリソースから
                            インターネットへのアウトバウンド接続を可能にしますが、
                            インターネットからの直接アクセスは防ぎます。
                        </p>

                        <div class="mermaid">
                            flowchart LR
                                subgraph "プライベートサブネット"
                                    EC2["EC2インスタンス<br/>(プライベートIP)"]
                                end
                                subgraph "パブリックサブネット"
                                    NAT["NAT Gateway<br/>(Elastic IP)"]
                                end
                                IGW["Internet<br/>Gateway"]
                                Internet["インターネット"]

                                EC2 -->|アウトバウンド| NAT
                                NAT --> IGW
                                IGW --> Internet
                                Internet -.->|インバウンド拒否| EC2

                                style EC2 fill:#FFE0B2
                                style NAT fill:#E3F2FD
                        </div>

                        <pre class="code-block"><code class="language-hcl"># nat_gateway.tf

# Elastic IPの割り当て（NATゲートウェイ用）
resource "aws_eip" "nat" {
  count = var.enable_nat_gateway ? length(local.azs) : 0

  domain = "vpc"

  tags = {
    Name = format("nat-eip-%s", local.azs[count.index])
  }

  # IGWが作成されるまで待つ
  depends_on = [aws_internet_gateway.main]
}

# NATゲートウェイの作成（高可用性のため各AZに1つ）
resource "aws_nat_gateway" "main" {
  count = var.enable_nat_gateway ? length(local.azs) : 0

  allocation_id = aws_eip.nat[count.index].id
  subnet_id     = aws_subnet.public[count.index].id

  tags = {
    Name = format("nat-gateway-%s", local.azs[count.index])
    AZ   = local.azs[count.index]
  }

  # IGWが作成されるまで待つ
  depends_on = [aws_internet_gateway.main]
}

# プライベートサブネット用のルートテーブル
resource "aws_route_table" "private" {
  count = var.enable_nat_gateway ? length(local.azs) : 0

  vpc_id = aws_vpc.main.id

  tags = {
    Name = format("private-rt-%s", local.azs[count.index])
    Type = "Private"
  }
}

# プライベートサブネットからインターネットへのルート
resource "aws_route" "private_nat" {
  count = var.enable_nat_gateway ? length(local.azs) : 0

  route_table_id         = aws_route_table.private[count.index].id
  destination_cidr_block = "0.0.0.0/0"
  nat_gateway_id         = aws_nat_gateway.main[count.index].id
}

# プライベートサブネット（App層）にルートテーブルを関連付け
resource "aws_route_table_association" "private_app" {
  count = var.enable_nat_gateway ? length(aws_subnet.private_app) : 0

  subnet_id      = aws_subnet.private_app[count.index].id
  route_table_id = aws_route_table.private[count.index].id
}

# プライベートサブネット（DB層）にルートテーブルを関連付け
resource "aws_route_table_association" "private_db" {
  count = var.enable_nat_gateway ? length(aws_subnet.private_db) : 0

  subnet_id      = aws_subnet.private_db[count.index].id
  route_table_id = aws_route_table.private[count.index].id
}</code></pre>

                        <div class="warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> NATゲートウェイのコスト</h6>
                            <p>
                                NATゲートウェイは高可用性と高パフォーマンスを提供しますが、
                                時間単位の料金とデータ転送料金が発生します。
                                開発環境ではコスト削減のため、1つのNATゲートウェイのみ使用するか、
                                NATインスタンスを検討することも可能です。
                            </p>
                        </div>
                    </div>

                    <div class="concept-card">
                        <h4>VPCエンドポイントの活用</h4>

                        <p>
                            VPCエンドポイントを使用すると、インターネットゲートウェイやNATゲートウェイを
                            経由せずに、AWSサービスにプライベート接続できます。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># vpc_endpoints.tf

# S3用のVPCエンドポイント（ゲートウェイタイプ）
resource "aws_vpc_endpoint" "s3" {
  vpc_id       = aws_vpc.main.id
  service_name = "com.amazonaws.${var.aws_region}.s3"

  # すべてのルートテーブルに関連付け
  route_table_ids = concat(
    [aws_route_table.public.id],
    aws_route_table.private[*].id
  )

  tags = {
    Name = "${var.project_name}-s3-endpoint"
  }
}

# DynamoDB用のVPCエンドポイント（ゲートウェイタイプ）
resource "aws_vpc_endpoint" "dynamodb" {
  vpc_id       = aws_vpc.main.id
  service_name = "com.amazonaws.${var.aws_region}.dynamodb"

  route_table_ids = concat(
    [aws_route_table.public.id],
    aws_route_table.private[*].id
  )

  tags = {
    Name = "${var.project_name}-dynamodb-endpoint"
  }
}

# Systems Manager用のVPCエンドポイント（インターフェイスタイプ）
resource "aws_vpc_endpoint" "ssm" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.${var.aws_region}.ssm"
  vpc_endpoint_type   = "Interface"
  private_dns_enabled = true

  subnet_ids         = aws_subnet.private_app[*].id
  security_group_ids = [aws_security_group.vpc_endpoint.id]

  tags = {
    Name = "${var.project_name}-ssm-endpoint"
  }
}

# VPCエンドポイント用のセキュリティグループ
resource "aws_security_group" "vpc_endpoint" {
  name        = "${var.project_name}-vpc-endpoint-sg"
  description = "Security group for VPC endpoints"
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = [aws_vpc.main.cidr_block]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "${var.project_name}-vpc-endpoint-sg"
  }
}</code></pre>
                    </div>

                    <!-- Section 3.4 -->
                    <h3 class="section-title">3.4 ルーティングとセキュリティ</h3>

                    <div class="concept-card">
                        <h4>セキュリティグループの設計</h4>

                        <p>
                            セキュリティグループは、インスタンスレベルで動作する仮想ファイアウォールです。
                            インバウンドとアウトバウンドのトラフィックを制御します。
                        </p>

                        <div class="term-definition">
                            <dt>セキュリティグループの特徴</dt>
                            <dd>
                                <ul>
                                    <li><strong>ステートフル</strong>：許可した通信の戻りトラフィックは自動的に許可</li>
                                    <li><strong>デフォルト拒否</strong>：明示的に許可したトラフィックのみ通過</li>
                                    <li><strong>インスタンス単位</strong>：EC2インスタンスやRDSなどに適用</li>
                                    <li><strong>ルールは許可のみ</strong>：拒否ルールは設定できない</li>
                                </ul>
                            </dd>
                        </div>

                        <pre class="code-block"><code class="language-hcl"># security_groups.tf - 階層的なセキュリティグループ設計

# ALB用セキュリティグループ
resource "aws_security_group" "alb" {
  name        = "${var.project_name}-alb-sg"
  description = "Security group for Application Load Balancer"
  vpc_id      = aws_vpc.main.id

  # HTTP
  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow HTTP from anywhere"
  }

  # HTTPS
  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow HTTPS from anywhere"
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound traffic"
  }

  tags = {
    Name = "${var.project_name}-alb-sg"
    Type = "LoadBalancer"
  }
}

# アプリケーションサーバー用セキュリティグループ
resource "aws_security_group" "app" {
  name        = "${var.project_name}-app-sg"
  description = "Security group for application servers"
  vpc_id      = aws_vpc.main.id

  # ALBからのトラフィックのみ許可
  ingress {
    from_port       = var.app_port
    to_port         = var.app_port
    protocol        = "tcp"
    security_groups = [aws_security_group.alb.id]
    description     = "Allow traffic from ALB"
  }

  # 管理用SSHアクセス（踏み台サーバー経由）
  ingress {
    from_port       = 22
    to_port         = 22
    protocol        = "tcp"
    security_groups = [aws_security_group.bastion.id]
    description     = "SSH from bastion host"
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound traffic"
  }

  tags = {
    Name = "${var.project_name}-app-sg"
    Type = "Application"
  }
}

# データベース用セキュリティグループ
resource "aws_security_group" "database" {
  name        = "${var.project_name}-db-sg"
  description = "Security group for RDS database"
  vpc_id      = aws_vpc.main.id

  # アプリケーションサーバーからのみアクセス許可
  ingress {
    from_port       = var.db_port  # 3306 for MySQL, 5432 for PostgreSQL
    to_port         = var.db_port
    protocol        = "tcp"
    security_groups = [aws_security_group.app.id]
    description     = "Database access from application servers"
  }

  # 他のDBインスタンスとのレプリケーション通信
  ingress {
    from_port = var.db_port
    to_port   = var.db_port
    protocol  = "tcp"
    self      = true  # 同じセキュリティグループ内の通信を許可
    description = "Database replication"
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound traffic"
  }

  tags = {
    Name = "${var.project_name}-db-sg"
    Type = "Database"
  }
}

# 踏み台サーバー用セキュリティグループ
resource "aws_security_group" "bastion" {
  name        = "${var.project_name}-bastion-sg"
  description = "Security group for bastion host"
  vpc_id      = aws_vpc.main.id

  # 特定のIPアドレスからのSSHのみ許可
  dynamic "ingress" {
    for_each = var.allowed_ssh_ips
    content {
      from_port   = 22
      to_port     = 22
      protocol    = "tcp"
      cidr_blocks = [ingress.value]
      description = "SSH from allowed IP"
    }
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Allow all outbound traffic"
  }

  tags = {
    Name = "${var.project_name}-bastion-sg"
    Type = "Bastion"
  }

  lifecycle {
    create_before_destroy = true
  }
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>ネットワークACLの設定</h4>

                        <p>
                            ネットワークACL（NACL）は、サブネットレベルで動作するファイアウォールです。
                            セキュリティグループとは異なり、ステートレスで、明示的な許可と拒否ルールを設定できます。
                        </p>

                        <div class="term-definition">
                            <dt>NACLとセキュリティグループの違い</dt>
                            <dd>
                                <table class="table">
                                    <tr>
                                        <th>項目</th>
                                        <th>セキュリティグループ</th>
                                        <th>ネットワークACL</th>
                                    </tr>
                                    <tr>
                                        <td>適用レベル</td>
                                        <td>インスタンス</td>
                                        <td>サブネット</td>
                                    </tr>
                                    <tr>
                                        <td>ステート</td>
                                        <td>ステートフル</td>
                                        <td>ステートレス</td>
                                    </tr>
                                    <tr>
                                        <td>ルール</td>
                                        <td>許可のみ</td>
                                        <td>許可と拒否</td>
                                    </tr>
                                    <tr>
                                        <td>評価順序</td>
                                        <td>すべて評価</td>
                                        <td>番号順</td>
                                    </tr>
                                </table>
                            </dd>
                        </div>

                        <pre class="code-block"><code class="language-hcl"># network_acl.tf - カスタムNACLの例（オプション）

# パブリックサブネット用のカスタムNACL
resource "aws_network_acl" "public" {
  vpc_id     = aws_vpc.main.id
  subnet_ids = aws_subnet.public[*].id

  # インバウンドルール
  # HTTP
  ingress {
    rule_no    = 100
    protocol   = "tcp"
    action     = "allow"
    cidr_block = "0.0.0.0/0"
    from_port  = 80
    to_port    = 80
  }

  # HTTPS
  ingress {
    rule_no    = 110
    protocol   = "tcp"
    action     = "allow"
    cidr_block = "0.0.0.0/0"
    from_port  = 443
    to_port    = 443
  }

  # エフェメラルポート（戻りトラフィック用）
  ingress {
    rule_no    = 200
    protocol   = "tcp"
    action     = "allow"
    cidr_block = "0.0.0.0/0"
    from_port  = 1024
    to_port    = 65535
  }

  # アウトバウンドルール
  egress {
    rule_no    = 100
    protocol   = -1
    action     = "allow"
    cidr_block = "0.0.0.0/0"
    from_port  = 0
    to_port    = 0
  }

  tags = {
    Name = "${var.project_name}-public-nacl"
  }
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>VPCフローログの有効化</h4>

                        <p>
                            VPCフローログは、VPC内のネットワークインターフェースとの間で送受信される
                            IPトラフィックに関する情報をキャプチャします。セキュリティ分析や監査に重要です。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># flow_logs.tf

# フローログ用のCloudWatch Logsグループ
resource "aws_cloudwatch_log_group" "flow_log" {
  name              = "/aws/vpc/${var.project_name}"
  retention_in_days = var.flow_log_retention_days  # デフォルト: 30日

  tags = {
    Name = "${var.project_name}-flow-logs"
  }
}

# フローログ用のIAMロール
resource "aws_iam_role" "flow_log" {
  name = "${var.project_name}-flow-log-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "vpc-flow-logs.amazonaws.com"
        }
      }
    ]
  })
}

# フローログロールのポリシー
resource "aws_iam_role_policy" "flow_log" {
  name = "${var.project_name}-flow-log-policy"
  role = aws_iam_role.flow_log.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:PutLogEvents",
          "logs:DescribeLogGroups",
          "logs:DescribeLogStreams"
        ]
        Resource = "*"
      }
    ]
  })
}

# VPCフローログの設定
resource "aws_flow_log" "main" {
  iam_role_arn    = aws_iam_role.flow_log.arn
  log_destination_arn = aws_cloudwatch_log_group.flow_log.arn
  traffic_type    = "ALL"  # ACCEPT, REJECT, または ALL
  vpc_id          = aws_vpc.main.id

  tags = {
    Name = "${var.project_name}-vpc-flow-log"
  }
}</code></pre>
                    </div>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5><i class="fas fa-laptop-code"></i> 実習 3-1: 3層アーキテクチャVPCの構築</h5>
                        <p>Web層、アプリケーション層、データベース層を持つVPCを構築します。</p>

                        <h6>手順</h6>
                        <ol>
                            <li>VPCとサブネットを作成（パブリック×2、プライベート×4）</li>
                            <li>インターネットゲートウェイとNATゲートウェイを設定</li>
                            <li>適切なルートテーブルを設定</li>
                            <li>各層のセキュリティグループを作成</li>
                            <li>terraform applyで適用し、AWSコンソールで確認</li>
                        </ol>

                        <h6>期待される結果</h6>
                        <p>
                            高可用性を考慮した3層アーキテクチャのネットワークが構築され、
                            各層が適切に分離されていることを確認できます。
                        </p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5><i class="fas fa-question-circle"></i> 理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>VPCのCIDRブロックを後から変更できますか？</strong>
                                <ul>
                                    <li>基本的に変更不可（セカンダリCIDRの追加は可能）</li>
                                    <li>適切なサイズを最初に設計することが重要</li>
                                </ul>
                            </li>
                            <li>
                                <strong>パブリックサブネットとプライベートサブネットの違いは？</strong>
                                <ul>
                                    <li>パブリック：IGW経由でインターネットと直接通信可能</li>
                                    <li>プライベート：インターネットから直接アクセス不可</li>
                                    <li>ルートテーブルの設定が異なる</li>
                                </ul>
                            </li>
                            <li>
                                <strong>NATゲートウェイとNATインスタンスの違いは？</strong>
                                <ul>
                                    <li>NATゲートウェイ：マネージドサービス、高可用性、高性能</li>
                                    <li>NATインスタンス：EC2インスタンス、自己管理、低コスト</li>
                                </ul>
                            </li>
                            <li>
                                <strong>セキュリティグループとNACLの使い分けは？</strong>
                                <ul>
                                    <li>セキュリティグループ：第一の防御層、インスタンス単位</li>
                                    <li>NACL：第二の防御層、サブネット単位、特定IPの拒否に使用</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <!-- 章のまとめ -->
                    <div class="concept-card">
                        <h4><i class="fas fa-bookmark"></i> この章のまとめ</h4>
                        <p>
                            第3章では、TerraformでAWS VPCとネットワークインフラを構築する方法を学びました。
                            VPCの設計から始まり、サブネットの作成、インターネット接続の設定、
                            セキュリティグループの実装まで、実践的なネットワーク構築スキルを習得しました。
                        </p>
                        <p>
                            特に重要なのは、高可用性を考慮したマルチAZ構成と、
                            セキュリティのベストプラクティスに従った階層的なセキュリティグループの設計です。
                        </p>
                        <p>
                            次章では、このネットワーク基盤の上にEC2インスタンスやAuto Scaling、
                            Load Balancerを構築する方法を学習します。
                        </p>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aws-terraform-learning-material-02.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aws-terraform-learning-material-04.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>

    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>