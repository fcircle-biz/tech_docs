<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Terraform学習教材 第2章 - HCL構文とTerraformの基本操作</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/hcl.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- カスタムCSS -->
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #FF9900;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .navbar-brand i {
            margin-right: 10px;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }

        .chapter-title {
            color: #FF9900;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #FF9900;
            padding-bottom: 0.5rem;
            font-weight: 600;
        }

        .section-title {
            color: #FF6600;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }

        .quiz-container {
            background-color: #FFF3E0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #FF9900;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info-box {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #2196f3;
        }

        .success-box {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .code-block {
            background-color: #1e1e1e;
            color: white;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .nav-link.active {
            background-color: #FF9900 !important;
            color: white !important;
            font-weight: 500;
        }

        .nav-link {
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 2px 0;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background-color: #FFF3E0;
            color: #FF6600;
        }

        .concept-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .concept-card h4 {
            color: #FF6600;
            border-bottom: 2px solid #FFE0B2;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .term-definition {
            background-color: #FFFDE7;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            border-left: 3px solid #FFB300;
        }

        .term-definition dt {
            color: #FF6F00;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .syntax-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }

        .syntax-table table {
            width: 100%;
            margin: 0;
        }

        .syntax-table th {
            background-color: #FF9900;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .syntax-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .syntax-table code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            color: #d14;
        }

        footer {
            margin-top: auto;
        }

        .mermaid {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .compare-box {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .compare-item {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #ddd;
        }

        .compare-item.good {
            border-color: #4caf50;
        }

        .compare-item.bad {
            border-color: #f44336;
        }

        .compare-item h6 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .compare-item.good h6 {
            color: #4caf50;
        }

        .compare-item.bad h6 {
            color: #f44336;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <i class="fab fa-aws"></i>
                <strong>AWS Terraform学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-01.html">
                                第1章: Terraform入門とAWS環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aws-terraform-learning-material-02.html">
                                第2章: HCL構文とTerraformの基本操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-03.html">
                                第3章: VPCとネットワークインフラの構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-04.html">
                                第4章: EC2インスタンスとコンピューティングリソース
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-05.html">
                                第5章: ストレージとデータベースサービス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-06.html">
                                第6章: IAMとセキュリティ管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-07.html">
                                第7章: Terraformステート管理とバックエンド
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-08.html">
                                第8章: Terraformモジュールとコードの再利用
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-09.html">
                                第9章: CI/CDパイプラインとの統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-10.html">
                                第10章: 実践プロジェクトとベストプラクティス
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第2章: HCL構文とTerraformの基本操作</h1>
                </div>

                <div id="chapter2">
                    <h2 class="chapter-title">Terraformの言語を習得する</h2>

                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5><i class="fas fa-graduation-cap"></i> この章で学ぶこと</h5>
                        <ul>
                            <li>HCL構文の基本を理解し、正しく記述できる</li>
                            <li>変数、出力、ローカル値を効果的に使用できる</li>
                            <li>リソースの依存関係を理解し、制御できる</li>
                            <li>Terraformのライフサイクルを理解する</li>
                        </ul>
                    </div>

                    <!-- Section 2.1 -->
                    <h3 class="section-title">2.1 HCL構文の基本</h3>

                    <div class="concept-card">
                        <h4>HCL（HashiCorp Configuration Language）の理解</h4>
                        <p>
                            HCLはHashiCorp社が開発した設定言語で、人間が読み書きしやすく、かつ機械が処理しやすい構文を持っています。
                            JSONの厳密さとYAMLの可読性の良いところを組み合わせた言語です。
                        </p>

                        <div class="mermaid">
                            flowchart LR
                                A["HCLファイル<br/>(.tf)"] --> B["パーサー"]
                                B --> C["抽象構文木<br/>(AST)"]
                                C --> D["実行計画"]
                                D --> E["API呼び出し"]
                                F["JSONファイル<br/>(.tf.json)"] --> B
                                style A fill:#FFE0B2
                                style F fill:#E3F2FD
                        </div>

                        <div class="info-box">
                            <h6><i class="fas fa-info-circle"></i> HCLとJSONの互換性</h6>
                            <p>
                                TerraformはHCL形式（.tf）とJSON形式（.tf.json）の両方をサポートしています。
                                自動生成されたコードやプログラムから出力する場合はJSON形式が便利ですが、
                                人間が書く場合はHCL形式の方が読みやすく推奨されています。
                            </p>
                        </div>
                    </div>

                    <div class="concept-card">
                        <h4>ブロックとアーギュメントの構造</h4>

                        <div class="term-definition">
                            <dt>ブロック（Block）</dt>
                            <dd>
                                設定の論理的な単位を表すコンテナです。`resource`、`data`、`variable`などがブロックタイプです。
                                ブロックは中括弧 `{}` で囲まれ、その中に設定を記述します。
                            </dd>
                        </div>

                        <pre class="code-block"><code class="language-hcl"># ブロックの基本構造
ブロックタイプ "ラベル1" "ラベル2" {
  # アーギュメント
  アーギュメント名 = 値

  # ネストされたブロック
  ネストブロック {
    アーギュメント名 = 値
  }
}</code></pre>

                        <h6>実際の例：</h6>
                        <pre class="code-block"><code class="language-hcl"># resourceブロックの例
resource "aws_instance" "web_server" {
  # アーギュメント
  instance_type = "t3.micro"
  ami           = "ami-0123456789abcdef"

  # ネストされたブロック
  root_block_device {
    volume_size = 30
    volume_type = "gp3"
  }

  # タグはマップ形式のアーギュメント
  tags = {
    Name        = "WebServer"
    Environment = "Production"
  }
}</code></pre>

                        <div class="term-definition">
                            <dt>アーギュメント（Argument）</dt>
                            <dd>
                                ブロック内で値を設定するためのキーと値のペアです。
                                `名前 = 値` の形式で記述します。
                            </dd>
                        </div>
                    </div>

                    <div class="concept-card">
                        <h4>データ型の詳細</h4>

                        <div class="syntax-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>型</th>
                                        <th>説明</th>
                                        <th>例</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>string</strong></td>
                                        <td>文字列</td>
                                        <td><code>"Hello, World"</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>number</strong></td>
                                        <td>数値（整数・小数）</td>
                                        <td><code>42</code>, <code>3.14</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>bool</strong></td>
                                        <td>真偽値</td>
                                        <td><code>true</code>, <code>false</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>list</strong></td>
                                        <td>順序付きリスト</td>
                                        <td><code>["a", "b", "c"]</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>set</strong></td>
                                        <td>重複のないコレクション</td>
                                        <td><code>["a", "b", "c"]</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>map</strong></td>
                                        <td>キーと値のペア</td>
                                        <td><code>{ key = "value" }</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>object</strong></td>
                                        <td>構造化オブジェクト</td>
                                        <td><code>{ name = "John", age = 30 }</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>tuple</strong></td>
                                        <td>固定長の順序付きリスト</td>
                                        <td><code>["a", 1, true]</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>any</strong></td>
                                        <td>任意の型</td>
                                        <td>任意の値</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h6>型の使用例：</h6>
                        <pre class="code-block"><code class="language-hcl"># 各データ型の実例
variable "example_string" {
  type    = string
  default = "Hello, Terraform"
}

variable "example_number" {
  type    = number
  default = 42
}

variable "example_bool" {
  type    = bool
  default = true
}

variable "example_list" {
  type    = list(string)
  default = ["dev", "staging", "prod"]
}

variable "example_map" {
  type = map(string)
  default = {
    dev     = "t3.micro"
    staging = "t3.small"
    prod    = "t3.medium"
  }
}

variable "example_object" {
  type = object({
    name = string
    port = number
    ssl  = bool
  })
  default = {
    name = "web-server"
    port = 443
    ssl  = true
  }
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>式と演算子</h4>

                        <p>HCLは豊富な式と演算子をサポートしており、動的な値の計算が可能です。</p>

                        <h6>算術演算子</h6>
                        <pre class="code-block"><code class="language-hcl"># 算術演算の例
locals {
  addition       = 10 + 5        # 15
  subtraction    = 10 - 5        # 5
  multiplication = 10 * 5        # 50
  division       = 10 / 5        # 2
  modulo         = 10 % 3        # 1

  # 実用例：ストレージサイズの計算
  base_size_gb   = 100
  extra_size_gb  = 50
  total_size_gb  = local.base_size_gb + local.extra_size_gb
}</code></pre>

                        <h6>比較演算子</h6>
                        <pre class="code-block"><code class="language-hcl"># 比較演算の例
locals {
  equal            = 5 == 5      # true
  not_equal        = 5 != 3      # true
  less_than        = 3 < 5       # true
  less_or_equal    = 3 <= 3      # true
  greater_than     = 5 > 3       # true
  greater_or_equal = 5 >= 5      # true
}</code></pre>

                        <h6>論理演算子</h6>
                        <pre class="code-block"><code class="language-hcl"># 論理演算の例
variable "environment" {
  default = "production"
}

variable "enable_monitoring" {
  default = true
}

locals {
  # AND演算
  is_prod_with_monitoring = (
    var.environment == "production" && var.enable_monitoring
  )

  # OR演算
  is_test_or_dev = (
    var.environment == "test" || var.environment == "development"
  )

  # NOT演算
  is_not_production = !var.is_production
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>コメントの記述方法</h4>

                        <p>コメントはコードの意図を説明する重要な要素です。HCLは3種類のコメント記法をサポートしています。</p>

                        <pre class="code-block"><code class="language-hcl"># 単一行コメント（推奨）
# これは最も一般的なコメント形式です

// C言語スタイルの単一行コメント
// これも使用できますが、#が推奨されています

/*
   複数行コメント
   長い説明や
   一時的にコードをコメントアウトする際に便利です
*/

resource "aws_instance" "example" {
  # インスタンスタイプは環境によって変更される
  instance_type = var.instance_type  # インライン コメント

  /*
  以下の設定は本番環境でのみ有効にする
  monitoring = true
  ebs_optimized = true
  */
}</code></pre>

                        <div class="info-box">
                            <h6><i class="fas fa-lightbulb"></i> コメントのベストプラクティス</h6>
                            <ul>
                                <li>「なぜ」そのような設定にしたのかを説明する</li>
                                <li>複雑なロジックや計算式には必ずコメントを付ける</li>
                                <li>一時的な設定や今後の変更予定を記載する</li>
                                <li>セキュリティや費用に関する重要な注意事項を記載する</li>
                            </ul>
                        </div>
                    </div>

                    <div class="concept-card">
                        <h4>ヒアドキュメント</h4>

                        <p>複数行の文字列を扱う場合、ヒアドキュメント記法が便利です。</p>

                        <pre class="code-block"><code class="language-hcl"># ヒアドキュメントの基本形式
resource "aws_instance" "web" {
  # インデントが保持される形式（<<-EOF）
  user_data = &lt;&lt;-EOF
    #!/bin/bash
    apt-get update
    apt-get install -y nginx

    cat > /var/www/html/index.html &lt;&lt;-HTML
    &lt;html&gt;
      &lt;body&gt;
        &lt;h1&gt;Hello from Terraform!&lt;/h1&gt;
      &lt;/body&gt;
    &lt;/html&gt;
    HTML

    systemctl start nginx
  EOF
}

# インデントが保持されない形式（<<EOF）
output "message" {
  value = &lt;&lt;EOF
このメッセージは
    インデントが
        そのまま保持されます
EOF
}</code></pre>
                    </div>

                    <!-- Section 2.2 -->
                    <h3 class="section-title">2.2 変数と出力</h3>

                    <div class="concept-card">
                        <h4>入力変数（Variables）の詳細</h4>

                        <p>
                            変数は、Terraformコードを柔軟で再利用可能にする重要な機能です。
                            同じコードを異なる環境（開発、ステージング、本番）で使い回すことができます。
                        </p>

                        <div class="term-definition">
                            <dt>変数の宣言</dt>
                            <dd>
                                `variable`ブロックで変数を宣言します。型、デフォルト値、説明、バリデーションルールなどを指定できます。
                            </dd>
                        </div>

                        <pre class="code-block"><code class="language-hcl"># variables.tf - 変数の完全な定義例
variable "instance_type" {
  description = "EC2インスタンスのタイプ"
  type        = string
  default     = "t3.micro"

  # バリデーションルール
  validation {
    condition = contains([
      "t3.micro", "t3.small", "t3.medium", "t3.large"
    ], var.instance_type)
    error_message = "インスタンスタイプはt3シリーズから選択してください。"
  }
}

variable "environment" {
  description = "デプロイ環境（dev, staging, prod）"
  type        = string

  validation {
    condition     = can(regex("^(dev|staging|prod)$", var.environment))
    error_message = "環境はdev、staging、prodのいずれかを指定してください。"
  }
}

variable "tags" {
  description = "リソースに付与するタグ"
  type        = map(string)
  default     = {}
}

variable "enable_monitoring" {
  description = "CloudWatch詳細監視を有効にするか"
  type        = bool
  default     = false
}

variable "instance_count" {
  description = "作成するインスタンス数"
  type        = number
  default     = 1

  validation {
    condition     = var.instance_count > 0 && var.instance_count <= 10
    error_message = "インスタンス数は1〜10の範囲で指定してください。"
  }
}

variable "subnet_ids" {
  description = "インスタンスを配置するサブネットID"
  type        = list(string)

  validation {
    condition     = length(var.subnet_ids) > 0
    error_message = "少なくとも1つのサブネットIDを指定してください。"
  }
}

# 複雑な型の変数
variable "database_config" {
  description = "データベース設定"
  type = object({
    engine         = string
    engine_version = string
    instance_class = string
    allocated_storage = number
    multi_az       = bool
    backup_retention_period = number
  })

  default = {
    engine         = "mysql"
    engine_version = "8.0"
    instance_class = "db.t3.micro"
    allocated_storage = 20
    multi_az       = false
    backup_retention_period = 7
  }
}

# 機密情報を扱う変数
variable "db_password" {
  description = "データベースのパスワード"
  type        = string
  sensitive   = true  # terraform planの出力で隠される
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>変数の値を設定する方法</h4>

                        <p>変数に値を設定する方法は複数あり、優先順位があります。</p>

                        <div class="mermaid">
                            flowchart TD
                                A["環境変数<br/>(TF_VAR_xxx)"] --> B["優先順位<br/>決定"]
                                C["terraform.tfvars"] --> B
                                D["*.auto.tfvars"] --> B
                                E["コマンドライン<br/>-var/-var-file"] --> B
                                F["デフォルト値"] --> B
                                B --> G["最終的な値"]
                                style E fill:#FFE0B2
                                style A fill:#E3F2FD
                        </div>

                        <h6>1. terraform.tfvarsファイル</h6>
                        <pre class="code-block"><code class="language-hcl"># terraform.tfvars
instance_type     = "t3.small"
environment       = "staging"
enable_monitoring = true
instance_count    = 3

tags = {
  Project     = "WebApp"
  Owner       = "DevOps Team"
  CostCenter  = "Engineering"
}</code></pre>

                        <h6>2. 環境固有の.tfvarsファイル</h6>
                        <pre class="code-block"><code class="language-hcl"># production.tfvars
instance_type     = "t3.large"
environment       = "prod"
enable_monitoring = true
instance_count    = 5

# development.tfvars
instance_type     = "t3.micro"
environment       = "dev"
enable_monitoring = false
instance_count    = 1</code></pre>

                        <h6>3. コマンドライン引数</h6>
                        <pre class="code-block"><code class="language-bash"># 個別の変数を指定
terraform apply -var="instance_type=t3.medium" -var="environment=test"

# tfvarsファイルを指定
terraform apply -var-file="production.tfvars"

# 複数のtfvarsファイルを使用
terraform apply -var-file="base.tfvars" -var-file="production.tfvars"</code></pre>

                        <h6>4. 環境変数</h6>
                        <pre class="code-block"><code class="language-bash"># TF_VAR_プレフィックスを付けて環境変数を設定
export TF_VAR_instance_type="t3.small"
export TF_VAR_environment="staging"
export TF_VAR_db_password="SecurePassword123!"

terraform apply</code></pre>

                        <h6>5. 対話的な入力</h6>
                        <p>デフォルト値がない変数で、値が提供されていない場合、Terraformは対話的に値を要求します。</p>
                    </div>

                    <div class="concept-card">
                        <h4>出力値（Output）</h4>

                        <p>
                            出力値は、Terraformで作成したリソースの情報を表示したり、
                            他のTerraform設定やスクリプトで使用するために値をエクスポートする機能です。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># outputs.tf
output "instance_ids" {
  description = "作成されたEC2インスタンスのID"
  value       = aws_instance.web[*].id
}

output "load_balancer_dns" {
  description = "ロードバランサーのDNS名"
  value       = aws_lb.main.dns_name
}

output "database_endpoint" {
  description = "RDSデータベースのエンドポイント"
  value       = aws_db_instance.main.endpoint
  sensitive   = false  # エンドポイントは機密情報ではない
}

output "database_password" {
  description = "データベースのパスワード（機密情報）"
  value       = random_password.db.result
  sensitive   = true  # パスワードは機密情報
}

# 条件付き出力
output "monitoring_dashboard_url" {
  description = "CloudWatchダッシュボードのURL"
  value = var.enable_monitoring ? (
    "https://console.aws.amazon.com/cloudwatch/home?region=${var.aws_region}#dashboards:name=${aws_cloudwatch_dashboard.main[0].dashboard_name}"
  ) : "Monitoring is disabled"
}

# 複雑な出力の構造化
output "infrastructure_summary" {
  description = "インフラストラクチャの概要"
  value = {
    environment = var.environment
    region      = var.aws_region
    vpc_id      = aws_vpc.main.id
    instances   = {
      count = length(aws_instance.web)
      type  = var.instance_type
      ids   = aws_instance.web[*].id
    }
    database = {
      engine   = aws_db_instance.main.engine
      endpoint = aws_db_instance.main.endpoint
      port     = aws_db_instance.main.port
    }
  }
}</code></pre>

                        <h6>出力値の利用方法</h6>
                        <pre class="code-block"><code class="language-bash"># すべての出力を表示
terraform output

# 特定の出力を表示
terraform output instance_ids

# JSON形式で出力（スクリプトでの利用に便利）
terraform output -json

# 特定の出力をJSON形式で取得
terraform output -json database_endpoint | jq -r '.value'</code></pre>
                    </div>

                    <!-- Section 2.3 -->
                    <h3 class="section-title">2.3 ローカル値と式</h3>

                    <div class="concept-card">
                        <h4>locals ブロックの活用</h4>

                        <p>
                            ローカル値は、同じ式を何度も繰り返し書くことを避けるための仕組みです。
                            変数と異なり、外部から値を設定することはできませんが、他の値から計算して導出できます。
                        </p>

                        <div class="term-definition">
                            <dt>ローカル値の特徴</dt>
                            <dd>
                                <ul>
                                    <li>設定内で繰り返し使用される式を一箇所で定義</li>
                                    <li>複雑な計算結果を分かりやすい名前で参照</li>
                                    <li>コードの重複を削減し、保守性を向上</li>
                                </ul>
                            </dd>
                        </div>

                        <pre class="code-block"><code class="language-hcl"># locals.tf
locals {
                            # 基本的な値の定義
  project_name = "myapp"
  environment  = var.environment

  # 複数の値を組み合わせた命名規則
  name_prefix = "${local.project_name}-${local.environment}"

  # 共通タグの定義
  common_tags = {
    Project     = local.project_name
    Environment = local.environment
    ManagedBy   = "Terraform"
    CreatedAt   = timestamp()
    Owner       = "DevOps Team"
  }

  # 環境別の設定をマップで定義
  instance_config = {
    dev = {
      instance_type = "t3.micro"
      count         = 1
      monitoring    = false
    }
    staging = {
      instance_type = "t3.small"
      count         = 2
      monitoring    = true
    }
    prod = {
      instance_type = "t3.medium"
      count         = 4
      monitoring    = true
    }
  }

  # 現在の環境の設定を取得
  current_config = local.instance_config[local.environment]

  # サブネットのCIDR計算
  vpc_cidr = "10.0.0.0/16"
  azs      = data.aws_availability_zones.available.names
  private_subnet_cidrs = [
    for i, az in local.azs :
    cidrsubnet(local.vpc_cidr, 8, i)
  ]
  public_subnet_cidrs = [
    for i, az in local.azs :
    cidrsubnet(local.vpc_cidr, 8, i + 100)
  ]
}

# ローカル値の使用例
resource "aws_instance" "web" {
  count         = local.current_config.count
  instance_type = local.current_config.instance_type

  monitoring = local.current_config.monitoring

  tags = merge(
    local.common_tags,
    {
      Name = "${local.name_prefix}-web-${count.index + 1}"
      Type = "WebServer"
    }
  )
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>条件式（Conditional Expressions）</h4>

                        <p>
                            Terraformの条件式は、三項演算子の形式で条件に基づいて異なる値を選択できます。
                            環境に応じた設定の切り替えなどに便利です。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># 条件式の基本構文
# condition ? true_value : false_value

locals {
  # 環境に応じたインスタンスタイプの選択
  instance_type = var.environment == "prod" ? "t3.large" : "t3.micro"

  # 複数条件のネスト
  backup_retention = (
    var.environment == "prod" ? 30 :
    var.environment == "staging" ? 7 :
    1
  )

  # boolを使った有効/無効の切り替え
  enable_detailed_monitoring = var.environment != "dev"

  # 空文字列やnullを使った条件分岐
  kms_key_id = var.enable_encryption ? aws_kms_key.main[0].id : null
}

# リソースの条件付き作成
resource "aws_cloudwatch_dashboard" "main" {
  # countを使った条件付き作成
  count = var.enable_monitoring ? 1 : 0

  dashboard_name = "${local.name_prefix}-dashboard"
  dashboard_body = jsonencode({
    widgets = []
  })
}

# 動的なブロックの条件制御
resource "aws_instance" "web" {
  instance_type = local.instance_type

  # 条件に基づく動的ブロック
  dynamic "ebs_block_device" {
    for_each = var.environment == "prod" ? [1] : []
    content {
      device_name = "/dev/sdf"
      volume_size = 100
      volume_type = "gp3"
    }
  }
}</code></pre>

                        <div class="compare-box">
                            <div class="compare-item good">
                                <h6><i class="fas fa-check-circle"></i> 良い例</h6>
                                <pre class="code-block"><code class="language-hcl"># 明確で読みやすい条件式
enable_backup = (
  var.environment == "prod" ||
  var.environment == "staging"
)</code></pre>
                            </div>
                            <div class="compare-item bad">
                                <h6><i class="fas fa-times-circle"></i> 避けるべき例</h6>
                                <pre class="code-block"><code class="language-hcl"># 複雑すぎる条件式
value = a ? b ? c : d : e ? f : g</code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="concept-card">
                        <h4>for式による反復処理</h4>

                        <p>
                            for式を使用することで、リストやマップを変換したり、フィルタリングしたりできます。
                            プログラミング言語のmap、filter、reduce操作に相当します。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># for式の基本構文と例

locals {
  # リストの変換
  instance_names = ["web", "app", "db"]
  full_instance_names = [
    for name in local.instance_names :
    "${local.name_prefix}-${name}"
  ]
  # 結果: ["myapp-dev-web", "myapp-dev-app", "myapp-dev-db"]

  # インデックス付きの反復
  indexed_names = [
    for i, name in local.instance_names :
    "${name}-${i}"
  ]
  # 結果: ["web-0", "app-1", "db-2"]

  # 条件付きフィルタリング
  production_instances = [
    for instance in aws_instance.all :
    instance.id
    if instance.tags["Environment"] == "prod"
  ]

  # マップの変換
  instance_sizes = {
    web = "t3.small"
    app = "t3.medium"
    db  = "t3.large"
  }

  instance_details = {
    for name, size in local.instance_sizes :
    name => {
      size   = size
      memory = (
        size == "t3.small" ? "2GB" :
        size == "t3.medium" ? "4GB" :
        "8GB"
      )
    }
  }

  # リストからマップを作成
  security_group_rules = {
    for rule in var.ingress_rules :
    rule.name => {
      from_port   = rule.from_port
      to_port     = rule.to_port
      protocol    = rule.protocol
      cidr_blocks = rule.cidr_blocks
    }
  }

  # ネストされたループ
  subnet_azs = flatten([
    for az_index, az in data.aws_availability_zones.available.names : [
      for subnet_index in range(2) : {
        az           = az
        subnet_index = subnet_index
        cidr         = cidrsubnet(var.vpc_cidr, 8, az_index * 2 + subnet_index)
      }
    ]
  ])
}</code></pre>

                        <h6>実用的な例：タグの一括適用</h6>
                        <pre class="code-block"><code class="language-hcl">variable "resources" {
  default = {
    web_server = { type = "ec2", size = "small" }
    app_server = { type = "ec2", size = "medium" }
    database   = { type = "rds", size = "large" }
  }
}

locals {
  # すべてのリソースに共通タグを追加
  resources_with_tags = {
    for name, config in var.resources :
    name => merge(config, {
      tags = {
        Name        = "${local.name_prefix}-${name}"
        Type        = config.type
        Size        = config.size
        Environment = var.environment
        ManagedBy   = "Terraform"
      }
    })
  }
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>スプラット演算子</h4>

                        <p>
                            スプラット演算子（[*]）は、リストやセット内のすべての要素から特定の属性を抽出する便利な記法です。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># スプラット演算子の使用例

resource "aws_instance" "web" {
  count         = 3
  instance_type = "t3.micro"
  # ... その他の設定
}

output "all_instance_ids" {
  # スプラット演算子を使用
  value = aws_instance.web[*].id
  # これは以下と同等
  # value = [for instance in aws_instance.web : instance.id]
}

output "all_private_ips" {
  value = aws_instance.web[*].private_ip
}

output "all_public_ips" {
  # 条件付きスプラット（nullを除外）
  value = [
    for ip in aws_instance.web[*].public_ip :
    ip if ip != null
  ]
}

# ネストされた属性へのアクセス
output "all_root_volume_ids" {
  value = aws_instance.web[*].root_block_device[0].volume_id
}

# 複数の属性を組み合わせる
output "instance_summary" {
  value = [
    for i, instance in aws_instance.web : {
      index      = i
      id         = instance.id
      private_ip = instance.private_ip
      public_ip  = instance.public_ip
      state      = instance.instance_state
    }
  ]
}</code></pre>
                    </div>

                    <!-- Section 2.4 -->
                    <h3 class="section-title">2.4 リソースの依存関係とライフサイクル</h3>

                    <div class="concept-card">
                        <h4>暗黙的な依存関係と明示的な依存関係</h4>

                        <p>
                            Terraformは通常、リソース間の依存関係を自動的に検出しますが、
                            場合によっては明示的に依存関係を指定する必要があります。
                        </p>

                        <div class="mermaid">
                            flowchart LR
                                A["VPC"] --> B["Subnet"]
                                B --> C["Security Group"]
                                B --> D["EC2 Instance"]
                                C --> D
                                D --> E["Elastic IP"]
                                style A fill:#FFE0B2
                                style D fill:#E3F2FD
                        </div>

                        <h6>暗黙的な依存関係（自動検出）</h6>
                        <pre class="code-block"><code class="language-hcl"># Terraformが自動的に依存関係を理解する例

resource "aws_vpc" "main" {
  cidr_block = "10.0.0.0/16"
}

resource "aws_subnet" "public" {
  # vpc_idでaws_vpc.mainを参照しているため、
  # TerraformはVPCを先に作成する必要があることを理解
  vpc_id     = aws_vpc.main.id
  cidr_block = "10.0.1.0/24"
}

resource "aws_instance" "web" {
  # subnet_idでaws_subnet.publicを参照
  # VPC → Subnet → Instance の順序で作成される
  subnet_id     = aws_subnet.public.id
  instance_type = "t3.micro"
}</code></pre>

                        <h6>明示的な依存関係（depends_on）</h6>
                        <pre class="code-block"><code class="language-hcl"># 明示的に依存関係を指定する必要がある例

resource "aws_s3_bucket" "logs" {
  bucket = "my-application-logs"
}

resource "aws_s3_bucket_policy" "logs_policy" {
  bucket = aws_s3_bucket.logs.id
  policy = data.aws_iam_policy_document.logs.json
}

resource "aws_instance" "app" {
  instance_type = "t3.micro"

  # S3バケットとポリシーが設定されてからインスタンスを作成
  # （アプリケーションがS3にログを書き込むため）
  depends_on = [
    aws_s3_bucket.logs,
    aws_s3_bucket_policy.logs_policy
  ]

  user_data = &lt;&lt;-EOF
    #!/bin/bash
    # アプリケーションの設定でS3バケットを使用
    echo "LOG_BUCKET=${aws_s3_bucket.logs.id}" >> /etc/environment
  EOF
}</code></pre>

                        <div class="warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> depends_onの使用に関する注意</h6>
                            <p>
                                depends_onは最後の手段として使用すべきです。
                                可能な限り、リソース参照による暗黙的な依存関係を使用することで、
                                コードがより明確で保守しやすくなります。
                            </p>
                        </div>
                    </div>

                    <div class="concept-card">
                        <h4>リソースのライフサイクル管理</h4>

                        <p>
                            lifecycleブロックを使用して、リソースの作成、更新、削除の動作をカスタマイズできます。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># ライフサイクルメタ引数の例

resource "aws_instance" "database" {
  instance_type = "t3.large"

  lifecycle {
    # 新しいリソースを作成してから古いものを削除
    # （ダウンタイムを最小化）
    create_before_destroy = true

    # このリソースの削除を防ぐ
    # （重要なデータベースなど）
    prevent_destroy = true

    # 特定の属性の変更を無視
    # （外部で管理される可能性がある属性）
    ignore_changes = [
      tags["LastModified"],
      user_data,
    ]

    # リソースの置き換えが必要な場合の条件
    # （特定の条件下でのみ置き換えを許可）
    replace_triggered_by = [
      aws_instance.web.id
    ]
  }
}

# create_before_destroyの実用例
resource "aws_launch_configuration" "app" {
  name_prefix     = "app-lc-"
  instance_type   = var.instance_type
  image_id        = data.aws_ami.app.id

  lifecycle {
    create_before_destroy = true
  }
}

resource "aws_autoscaling_group" "app" {
  name                = "app-asg"
  launch_configuration = aws_launch_configuration.app.name
  min_size            = 2
  max_size            = 10

  lifecycle {
    create_before_destroy = true
    # Launch Configurationが変更されても
    # ASG自体は再作成しない
    ignore_changes = [launch_configuration]
  }
}

# prevent_destroyの実用例
resource "aws_s3_bucket" "critical_data" {
  bucket = "company-critical-data"

  lifecycle {
    prevent_destroy = true
  }

  # バージョニングを有効化（データ保護）
  versioning {
    enabled = true
  }
}

# ignore_changesの実用例
resource "aws_instance" "managed" {
  instance_type = "t3.medium"
  ami           = data.aws_ami.latest.id

  tags = {
    Name        = "ManagedInstance"
    Environment = var.environment
    # この2つのタグは外部システムが更新する可能性がある
    LastBackup  = ""
    MonitoringStatus = ""
  }

  lifecycle {
    # 外部で更新される可能性のあるタグを無視
    ignore_changes = [
      tags["LastBackup"],
      tags["MonitoringStatus"],
    ]
  }
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>リソースのタイムアウト設定</h4>

                        <p>
                            一部のリソースでは、作成、更新、削除操作のタイムアウトを設定できます。
                            大規模なリソースや時間のかかる操作に有用です。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># タイムアウトの設定例

resource "aws_db_instance" "large_database" {
  identifier     = "my-large-database"
  engine         = "mysql"
  engine_version = "8.0"
  instance_class = "db.r5.xlarge"
  allocated_storage = 1000

  # データベースの作成には時間がかかる可能性がある
  timeouts {
    create = "60m"  # 作成に最大60分
    update = "30m"  # 更新に最大30分
    delete = "30m"  # 削除に最大30分
  }
}

resource "aws_elasticsearch_domain" "logs" {
  domain_name = "application-logs"
  elasticsearch_version = "7.10"

  cluster_config {
    instance_type = "r5.large.elasticsearch"
    instance_count = 3
  }

  # Elasticsearchドメインの作成は特に時間がかかる
  timeouts {
    create = "90m"
    update = "60m"
    delete = "90m"
  }
}</code></pre>
                    </div>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5><i class="fas fa-laptop-code"></i> 実習 2-1: 変数を使用した環境別設定</h5>
                        <p>変数とローカル値を使って、開発環境と本番環境で異なる設定を適用する構成を作成します。</p>

                        <h6>手順</h6>
                        <ol>
                            <li>variables.tfファイルを作成し、環境変数を定義</li>
                            <li>dev.tfvarsとprod.tfvarsを作成</li>
                            <li>main.tfでリソースを定義</li>
                            <li>各環境向けにterraform planを実行して違いを確認</li>
                        </ol>

                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-hcl"># variables.tf
variable "environment" {
  description = "環境名"
  type        = string
  validation {
    condition     = contains(["dev", "prod"], var.environment)
    error_message = "環境はdevまたはprodを指定してください。"
  }
}

variable "instance_count" {
  description = "インスタンス数"
  type        = number
  default     = 1
}

# locals.tf
locals {
  name_prefix = "terraform-demo-${var.environment}"

  instance_type = {
    dev  = "t3.micro"
    prod = "t3.small"
  }

  common_tags = {
    Project     = "TerraformDemo"
    Environment = var.environment
    ManagedBy   = "Terraform"
  }
}

# main.tf
resource "aws_instance" "app" {
  count         = var.instance_count
  instance_type = local.instance_type[var.environment]
  ami           = data.aws_ami.amazon_linux_2.id

  tags = merge(
    local.common_tags,
    {
      Name = "${local.name_prefix}-${count.index + 1}"
    }
  )
}

# dev.tfvars
environment    = "dev"
instance_count = 1

# prod.tfvars
environment    = "prod"
instance_count = 3</code></pre>

                        <pre class="code-block"><code class="language-bash"># 開発環境の計画を確認
terraform plan -var-file="dev.tfvars"

# 本番環境の計画を確認
terraform plan -var-file="prod.tfvars"</code></pre>

                        <h6>期待される結果</h6>
                        <p>
                            開発環境では1台のt3.microインスタンス、本番環境では3台のt3.smallインスタンスが
                            作成される計画が表示されます。
                        </p>
                    </div>

                    <div class="exercise-container">
                        <h5><i class="fas fa-laptop-code"></i> 実習 2-2: for式とconditionを使った動的設定</h5>
                        <p>for式と条件式を使って、複数のセキュリティグループルールを動的に作成します。</p>

                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-hcl"># セキュリティグループルールの動的生成
variable "app_ports" {
  description = "アプリケーションポート設定"
  type = list(object({
    name        = string
    port        = number
    protocol    = string
    cidr_blocks = list(string)
  }))
  default = [
    {
      name        = "http"
      port        = 80
      protocol    = "tcp"
      cidr_blocks = ["0.0.0.0/0"]
    },
    {
      name        = "https"
      port        = 443
      protocol    = "tcp"
      cidr_blocks = ["0.0.0.0/0"]
    },
    {
      name        = "ssh"
      port        = 22
      protocol    = "tcp"
      cidr_blocks = ["10.0.0.0/8"]
    }
  ]
}

locals {
  # 本番環境ではSSHを除外
  filtered_ports = [
    for rule in var.app_ports :
    rule if !(var.environment == "prod" && rule.name == "ssh")
  ]
}

resource "aws_security_group" "app" {
  name        = "${local.name_prefix}-sg"
  description = "Security group for ${var.environment} environment"

  dynamic "ingress" {
    for_each = local.filtered_ports
    content {
      description = ingress.value.name
      from_port   = ingress.value.port
      to_port     = ingress.value.port
      protocol    = ingress.value.protocol
      cidr_blocks = ingress.value.cidr_blocks
    }
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = local.common_tags
}</code></pre>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5><i class="fas fa-question-circle"></i> 理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>HCLでサポートされているデータ型をすべて挙げてください。</strong>
                                <ul>
                                    <li>プリミティブ型: string, number, bool</li>
                                    <li>コレクション型: list, set, map</li>
                                    <li>構造型: object, tuple</li>
                                    <li>特殊型: any, null</li>
                                </ul>
                            </li>
                            <li>
                                <strong>変数とローカル値の違いは何ですか？</strong>
                                <ul>
                                    <li>変数: 外部から値を設定可能、デフォルト値を持てる</li>
                                    <li>ローカル値: 設定内で計算される値、外部から設定不可</li>
                                    <li>使い分け: 外部入力が必要なら変数、内部計算ならローカル値</li>
                                </ul>
                            </li>
                            <li>
                                <strong>depends_onを使用すべき場面はどのような時ですか？</strong>
                                <ul>
                                    <li>リソース間に直接的な参照関係がない場合</li>
                                    <li>論理的な依存関係がある場合</li>
                                    <li>作成順序を明示的に制御する必要がある場合</li>
                                </ul>
                            </li>
                            <li>
                                <strong>lifecycle.create_before_destroyはどのような場合に使用しますか？</strong>
                                <ul>
                                    <li>ダウンタイムを最小限にしたい場合</li>
                                    <li>Launch ConfigurationやSecurity Groupなど、使用中は削除できないリソース</li>
                                    <li>Blue-Greenデプロイメントを実現したい場合</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <!-- 章のまとめ -->
                    <div class="concept-card">
                        <h4><i class="fas fa-bookmark"></i> この章のまとめ</h4>
                        <p>
                            第2章では、HCL構文の詳細とTerraformの基本操作を学習しました。
                            変数、ローカル値、出力を使った柔軟な設定方法を習得し、
                            条件式やfor式を使った動的な構成の作成方法を理解しました。
                        </p>
                        <p>
                            また、リソース間の依存関係の管理方法と、ライフサイクル設定による
                            リソースの作成・更新・削除の動作制御についても学びました。
                        </p>
                        <p>
                            次章では、これらの知識を活用して、実際のAWS VPCとネットワークインフラを
                            Terraformで構築する方法を学びます。セキュアで可用性の高いネットワーク設計を
                            コードで実現する方法を習得していきます。
                        </p>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aws-terraform-learning-material-01.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aws-terraform-learning-material-03.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>

    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>