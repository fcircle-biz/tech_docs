<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Terraform学習教材 第7章 - Terraformステート管理とバックエンド</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/hcl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- カスタムCSS -->
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #FF9900;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .navbar-brand i {
            margin-right: 10px;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }

        .chapter-title {
            color: #FF9900;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #FF9900;
            padding-bottom: 0.5rem;
            font-weight: 600;
        }

        .section-title {
            color: #FF6600;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }

        .quiz-container {
            background-color: #FFF3E0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #FF9900;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info-box {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #2196f3;
        }

        .success-box {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .code-block {
            background-color: #1e1e1e;
            color: white;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .nav-link.active {
            background-color: #FF9900 !important;
            color: white !important;
            font-weight: 500;
        }

        .nav-link {
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 2px 0;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background-color: #FFF3E0;
            color: #FF6600;
        }

        .concept-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .concept-card h4 {
            color: #FF6600;
            margin-bottom: 15px;
        }

        .term-definition {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4169e1;
        }

        .term-definition dt {
            font-weight: bold;
            color: #4169e1;
            margin-bottom: 8px;
        }

        .term-definition dd {
            margin-left: 20px;
            color: #333;
        }

        .footer {
            background-color: #333;
            color: white;
            padding: 2rem 0;
            margin-top: 4rem;
        }

        .mermaid {
            margin: 20px 0;
            text-align: center;
        }

        pre.code-block code {
            display: block;
            padding: 0 !important;
            background: transparent !important;
        }

        .comparison-table {
            margin: 20px 0;
        }

        .comparison-table th {
            background-color: #FF9900;
            color: white;
        }

        .state-diagram {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fab fa-aws"></i>
                AWS Terraform 学習教材
            </a>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-01.html">
                                第1章: Terraform入門とAWS環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-02.html">
                                第2章: HCL構文とTerraformの基本操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-03.html">
                                第3章: VPCとネットワークインフラの構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-04.html">
                                第4章: EC2インスタンスとコンピューティングリソース
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-05.html">
                                第5章: ストレージとデータベースサービス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-06.html">
                                第6章: IAMとセキュリティ管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aws-terraform-learning-material-07.html">
                                第7章: Terraformステート管理とバックエンド
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-08.html">
                                第8章: Terraformモジュールとコードの再利用
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-09.html">
                                第9章: CI/CDパイプラインとの統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-10.html">
                                第10章: 実践プロジェクトとベストプラクティス
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: Terraformステート管理とバックエンド</h1>
                </div>

                <div id="chapter7">
                    <h2 class="chapter-title">チーム開発のためのステート管理戦略</h2>

                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5><i class="fas fa-graduation-cap"></i> この章で学ぶこと</h5>
                        <ul>
                            <li>Terraformステートの役割と重要性を理解する</li>
                            <li>リモートバックエンドの設定と管理方法を習得する</li>
                            <li>S3バックエンドによるステート共有とロック機能の実装</li>
                            <li>Workspaceによる環境分離とマルチ環境管理</li>
                            <li>ステート操作とトラブルシューティング手法</li>
                        </ul>
                    </div>

                    <!-- Section 7.1 -->
                    <h3 class="section-title">7.1 Terraformステートの理解</h3>

                    <div class="concept-card">
                        <h4>ステートファイルとは何か</h4>
                        <p>
                            Terraformステートは、Terraformが管理するインフラストラクチャの現在の状態を
                            記録したJSONファイルです。実際のリソースとTerraformの設定をマッピングし、
                            変更の検出と適用を可能にします。
                        </p>

                        <div class="mermaid">
                            flowchart TD
                                A[Terraform設定<br/>（.tfファイル）] --> B[terraform plan]
                                B --> C{差分検出}
                                D[Terraformステート<br/>（terraform.tfstate）] --> C
                                E[実際のインフラ<br/>（AWS）] --> C
                                C --> F[実行計画]
                                F --> G[terraform apply]
                                G --> H[インフラ更新]
                                G --> I[ステート更新]
                                H --> E
                                I --> D
                        </div>
                    </div>

                    <div class="term-definition">
                        <dt>ステートファイルに含まれる情報</dt>
                        <dd>
                            <ul>
                                <li><strong>リソースマッピング</strong>：Terraformリソースと実際のリソースIDの対応</li>
                                <li><strong>メタデータ</strong>：リソースの依存関係、プロバイダー情報</li>
                                <li><strong>アトリビュート</strong>：リソースのすべての属性値</li>
                                <li><strong>センシティブデータ</strong>：パスワードやアクセスキーなどの機密情報</li>
                            </ul>
                        </dd>
                    </div>

                    <div class="warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> ステートファイルの取り扱い注意</h6>
                        <ul>
                            <li>ステートファイルには機密情報が含まれる可能性がある</li>
                            <li>Gitなどのバージョン管理システムにコミットしない</li>
                            <li>手動での編集は避け、terraform stateコマンドを使用</li>
                            <li>定期的なバックアップを実施する</li>
                        </ul>
                    </div>

                    <div class="concept-card">
                        <h4>ローカルステートの問題点</h4>

                        <div class="state-diagram">
                            <h6>チーム開発での課題</h6>
                            <div class="mermaid">
                                flowchart LR
                                    A[開発者A<br/>terraform.tfstate] -->|同時編集| D[衝突!]
                                    B[開発者B<br/>terraform.tfstate] -->|同時編集| D
                                    C[開発者C<br/>terraform.tfstate] -->|同時編集| D
                                    D --> E[インフラの不整合]
                                    D --> F[ステートの破損]
                                    D --> G[リソースの重複作成]
                            </div>
                        </div>

                        <p>
                            ローカルステートを使用すると、複数の開発者が同時に作業する際に
                            以下の問題が発生します：
                        </p>
                        <ul>
                            <li>ステートファイルの同期が取れない</li>
                            <li>同時実行による競合状態（Race Condition）</li>
                            <li>ステートファイルの紛失リスク</li>
                            <li>機密情報の管理が困難</li>
                        </ul>
                    </div>

                    <!-- Section 7.2 -->
                    <h3 class="section-title">7.2 リモートバックエンドの設定</h3>

                    <div class="concept-card">
                        <h4>S3バックエンドの構築</h4>
                        <p>
                            S3バックエンドは、最も一般的なTerraformのリモートバックエンドです。
                            DynamoDBと組み合わせることで、ステートロック機能も実現できます。
                        </p>

                        <pre class="code-block"><code class="language-hcl"># backend-infrastructure.tf - バックエンド用インフラの構築
# このファイルは最初に別途適用する

# ステート保存用S3バケット
resource "aws_s3_bucket" "terraform_state" {
  bucket = "${var.project_name}-terraform-state"

  lifecycle {
    prevent_destroy = true  # 誤削除防止
  }

  tags = {
    Name        = "Terraform State Store"
    Environment = "shared"
    ManagedBy   = "Terraform"
  }
}

# バケットのバージョニング有効化
resource "aws_s3_bucket_versioning" "terraform_state" {
  bucket = aws_s3_bucket.terraform_state.id

  versioning_configuration {
    status = "Enabled"
  }
}

# バケットの暗号化
resource "aws_s3_bucket_server_side_encryption_configuration" "terraform_state" {
  bucket = aws_s3_bucket.terraform_state.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = aws_kms_key.terraform_state.id
    }
  }
}

# パブリックアクセスブロック
resource "aws_s3_bucket_public_access_block" "terraform_state" {
  bucket = aws_s3_bucket.terraform_state.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# ステートロック用DynamoDBテーブル
resource "aws_dynamodb_table" "terraform_locks" {
  name           = "${var.project_name}-terraform-locks"
  billing_mode   = "PAY_PER_REQUEST"
  hash_key       = "LockID"

  attribute {
    name = "LockID"
    type = "S"
  }

  point_in_time_recovery {
    enabled = true
  }

  server_side_encryption {
    enabled     = true
    kms_key_arn = aws_kms_key.terraform_state.arn
  }

  tags = {
    Name        = "Terraform State Lock Table"
    Environment = "shared"
    ManagedBy   = "Terraform"
  }
}

# KMSキー（ステート暗号化用）
resource "aws_kms_key" "terraform_state" {
  description             = "KMS key for Terraform state encryption"
  deletion_window_in_days = 30
  enable_key_rotation     = true

  tags = {
    Name = "${var.project_name}-terraform-state-key"
  }
}

resource "aws_kms_alias" "terraform_state" {
  name          = "alias/${var.project_name}-terraform-state"
  target_key_id = aws_kms_key.terraform_state.key_id
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>バックエンド設定の実装</h4>

                        <pre class="code-block"><code class="language-hcl"># backend.tf - プロジェクトのバックエンド設定

terraform {
  backend "s3" {
    # バケット名とリージョン
    bucket = "myproject-terraform-state"
    key    = "infrastructure/terraform.tfstate"
    region = "ap-northeast-1"

    # 暗号化設定
    encrypt        = true
    kms_key_id     = "alias/myproject-terraform-state"

    # ステートロック設定
    dynamodb_table = "myproject-terraform-locks"

    # アクセス権限（AssumeRole使用時）
    # role_arn = "arn:aws:iam::123456789012:role/terraform-backend-role"

    # その他のオプション
    workspace_key_prefix = "workspaces"
    acl                 = "private"
  }
}

# バックエンド設定の確認用データソース
data "terraform_remote_state" "current" {
  backend = "s3"

  config = {
    bucket = "myproject-terraform-state"
    key    = "infrastructure/terraform.tfstate"
    region = "ap-northeast-1"
  }
}</code></pre>

                        <div class="info-box">
                            <h6><i class="fas fa-info-circle"></i> バックエンド初期化の手順</h6>
                            <pre class="code-block"><code class="language-bash"># 1. バックエンドインフラを先に作成
cd backend-infrastructure/
terraform init
terraform apply

# 2. メインプロジェクトでバックエンドを初期化
cd ../main-project/
terraform init -backend-config=backend.hcl

# 3. 既存のローカルステートをマイグレーション
terraform init -migrate-state

# 4. バックエンドの再設定（必要な場合）
terraform init -reconfigure</code></pre>
                        </div>
                    </div>

                    <!-- Section 7.3 -->
                    <h3 class="section-title">7.3 Workspaceによる環境管理</h3>

                    <div class="concept-card">
                        <h4>Terraform Workspaceの概念</h4>
                        <p>
                            Workspaceは、同一のTerraform設定から複数の独立した環境を管理するための機能です。
                            各Workspaceは独自のステートファイルを持ち、環境ごとの分離を実現します。
                        </p>

                        <div class="mermaid">
                            flowchart TD
                                A[Terraform設定] --> B[Workspace: default]
                                A --> C[Workspace: dev]
                                A --> D[Workspace: staging]
                                A --> E[Workspace: production]
                                B --> F[dev.tfstate]
                                C --> G[staging.tfstate]
                                D --> H[production.tfstate]
                                E --> I[default.tfstate]
                                F --> J[開発環境]
                                G --> K[ステージング環境]
                                H --> L[本番環境]
                                I --> M[デフォルト環境]
                        </div>

                        <pre class="code-block"><code class="language-bash"># Workspace操作コマンド

# 現在のWorkspaceを確認
terraform workspace show

# Workspace一覧を表示
terraform workspace list

# 新しいWorkspaceを作成して切り替え
terraform workspace new dev
terraform workspace new staging
terraform workspace new production

# Workspaceを切り替え
terraform workspace select dev

# Workspaceを削除（ステートが空の場合のみ）
terraform workspace delete old-env</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>Workspace対応の設定</h4>

                        <pre class="code-block"><code class="language-hcl"># variables.tf - Workspace対応の変数定義

variable "environment_configs" {
  description = "Environment-specific configurations"
  type = map(object({
    instance_type    = string
    instance_count   = number
    db_instance_class = string
    enable_deletion_protection = bool
  }))

  default = {
    dev = {
      instance_type    = "t3.micro"
      instance_count   = 1
      db_instance_class = "db.t3.micro"
      enable_deletion_protection = false
    }
    staging = {
      instance_type    = "t3.small"
      instance_count   = 2
      db_instance_class = "db.t3.small"
      enable_deletion_protection = false
    }
    production = {
      instance_type    = "t3.medium"
      instance_count   = 3
      db_instance_class = "db.r5.large"
      enable_deletion_protection = true
    }
  }
}

# main.tf - Workspaceベースの設定

locals {
  # 現在のWorkspace名を取得
  environment = terraform.workspace == "default" ? "dev" : terraform.workspace

  # Workspace固有の設定を取得
  config = var.environment_configs[local.environment]

  # タグの定義
  common_tags = {
    Environment = local.environment
    Workspace   = terraform.workspace
    ManagedBy   = "Terraform"
    Project     = var.project_name
  }
}

# EC2インスタンス（Workspace対応）
resource "aws_instance" "app" {
  count = local.config.instance_count

  instance_type = local.config.instance_type
  ami           = data.aws_ami.amazon_linux_2.id

  tags = merge(
    local.common_tags,
    {
      Name = "${var.project_name}-${local.environment}-app-${count.index + 1}"
    }
  )
}

# RDSインスタンス（Workspace対応）
resource "aws_db_instance" "main" {
  identifier = "${var.project_name}-${local.environment}-db"

  instance_class         = local.config.db_instance_class
  deletion_protection    = local.config.enable_deletion_protection

  # 環境別のバックアップ設定
  backup_retention_period = local.environment == "production" ? 30 : 7

  tags = merge(
    local.common_tags,
    {
      Name = "${var.project_name}-${local.environment}-database"
    }
  )
}</code></pre>
                    </div>

                    <!-- Section 7.4 -->
                    <h3 class="section-title">7.4 ステート操作とトラブルシューティング</h3>

                    <div class="concept-card">
                        <h4>ステート操作コマンド</h4>

                        <pre class="code-block"><code class="language-bash"># terraform state コマンド集

# ステート内のリソース一覧表示
terraform state list

# 特定のリソースの詳細表示
terraform state show aws_instance.web

# リソースの移動（リネーム）
terraform state mv aws_instance.old aws_instance.new

# リソースの削除（ステートからのみ）
terraform state rm aws_instance.temporary

# 既存リソースのインポート
terraform import aws_instance.existing i-1234567890abcdef0

# ステートのプル（リモート→ローカル）
terraform state pull > terraform.tfstate.backup

# ステートのプッシュ（ローカル→リモート）
terraform state push terraform.tfstate.backup

# ステートのロック解除（緊急時のみ）
terraform force-unlock <lock-id>

# ステートの置換
terraform state replace-provider hashicorp/aws registry.terraform.io/hashicorp/aws</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>ステート管理のベストプラクティス</h4>

                        <div class="success-box">
                            <h6><i class="fas fa-check-circle"></i> 推奨事項</h6>
                            <ul>
                                <li>本番環境では必ずリモートバックエンドを使用</li>
                                <li>ステートロックを有効にして同時実行を防ぐ</li>
                                <li>定期的なステートのバックアップ</li>
                                <li>環境ごとに別のステートファイルまたはWorkspaceを使用</li>
                                <li>機密情報は別途Secrets Managerで管理</li>
                            </ul>
                        </div>

                        <pre class="code-block"><code class="language-hcl"># state-management-policy.tf - ステート管理ポリシー

# ステートバケットへのアクセスを制限するポリシー
data "aws_iam_policy_document" "terraform_backend_policy" {
  statement {
    sid    = "ListStateBucket"
    effect = "Allow"

    actions = [
      "s3:ListBucket"
    ]

    resources = [
      "arn:aws:s3:::${var.state_bucket_name}"
    ]
  }

  statement {
    sid    = "GetPutDeleteState"
    effect = "Allow"

    actions = [
      "s3:GetObject",
      "s3:PutObject",
      "s3:DeleteObject"
    ]

    resources = [
      "arn:aws:s3:::${var.state_bucket_name}/*"
    ]
  }

  statement {
    sid    = "StateLocking"
    effect = "Allow"

    actions = [
      "dynamodb:GetItem",
      "dynamodb:PutItem",
      "dynamodb:DeleteItem"
    ]

    resources = [
      "arn:aws:dynamodb:*:*:table/${var.lock_table_name}"
    ]
  }

  statement {
    sid    = "EncryptDecryptState"
    effect = "Allow"

    actions = [
      "kms:Decrypt",
      "kms:GenerateDataKey"
    ]

    resources = [
      var.kms_key_arn
    ]
  }
}

# 自動バックアップのライフサイクルポリシー
resource "aws_s3_bucket_lifecycle_configuration" "state_backup" {
  bucket = aws_s3_bucket.terraform_state.id

  rule {
    id     = "state-backup-lifecycle"
    status = "Enabled"

    noncurrent_version_transition {
      noncurrent_days = 30
      storage_class   = "STANDARD_IA"
    }

    noncurrent_version_transition {
      noncurrent_days = 60
      storage_class   = "GLACIER"
    }

    noncurrent_version_expiration {
      noncurrent_days = 365
    }
  }
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>トラブルシューティング</h4>

                        <table class="table table-bordered comparison-table">
                            <thead>
                                <tr>
                                    <th>問題</th>
                                    <th>原因</th>
                                    <th>解決方法</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Error acquiring the state lock</td>
                                    <td>他のプロセスがロック中</td>
                                    <td>実行中のプロセスを待つか、force-unlockを使用</td>
                                </tr>
                                <tr>
                                    <td>State file is locked</td>
                                    <td>異常終了によるロック残存</td>
                                    <td>DynamoDBから手動でロック削除</td>
                                </tr>
                                <tr>
                                    <td>Resource already exists</td>
                                    <td>手動作成されたリソース</td>
                                    <td>terraform importでインポート</td>
                                </tr>
                                <tr>
                                    <td>Drift detected</td>
                                    <td>手動変更による差分</td>
                                    <td>terraform refreshで同期</td>
                                </tr>
                                <tr>
                                    <td>Backend initialization required</td>
                                    <td>バックエンド設定変更</td>
                                    <td>terraform init -reconfigure</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 実習課題 -->
                    <div class="exercise-container">
                        <h5><i class="fas fa-laptop-code"></i> 実習課題：マルチ環境のステート管理システム構築</h5>

                        <h6>課題内容</h6>
                        <p>以下の要件を満たすTerraformステート管理システムを構築してください：</p>
                        <ol>
                            <li>S3バックエンドの構築（暗号化、バージョニング有効）</li>
                            <li>DynamoDBによるステートロック機能の実装</li>
                            <li>dev、staging、productionの3環境をWorkspaceで管理</li>
                            <li>環境ごとに異なるリソース設定（インスタンスサイズなど）</li>
                            <li>ステートファイルへのアクセス権限をIAMで制御</li>
                            <li>既存リソースのインポート処理</li>
                        </ol>

                        <h6>追加チャレンジ</h6>
                        <ul>
                            <li>ステートファイルの自動バックアップ設定</li>
                            <li>クロスリージョンレプリケーション</li>
                            <li>Terraform Cloudとの連携</li>
                            <li>ステート操作の監査ログ設定</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5><i class="fas fa-question-circle"></i> 理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>ローカルステートとリモートステートの使い分けは？</strong>
                                <ul>
                                    <li>ローカル：個人開発、検証環境、学習用途</li>
                                    <li>リモート：チーム開発、本番環境、CI/CD統合</li>
                                    <li>リモートステートはロック機能で同時実行を防ぐ</li>
                                </ul>
                            </li>
                            <li>
                                <strong>Workspaceと別ディレクトリの使い分けは？</strong>
                                <ul>
                                    <li>Workspace：同じ設定で環境を分離（dev/staging/prod）</li>
                                    <li>別ディレクトリ：大きく異なる設定や独立したプロジェクト</li>
                                    <li>Workspaceは設定の重複を避けられるが、分離度は低い</li>
                                </ul>
                            </li>
                            <li>
                                <strong>terraform importを使うタイミングは？</strong>
                                <ul>
                                    <li>既存の手動作成リソースをTerraform管理下に置く</li>
                                    <li>他のツールで作成したリソースを引き継ぐ</li>
                                    <li>ステートファイル破損時の復旧</li>
                                </ul>
                            </li>
                            <li>
                                <strong>ステートロックが解除されない場合の対処法は？</strong>
                                <ul>
                                    <li>まず実行中のterraformプロセスを確認</li>
                                    <li>DynamoDBテーブルでロック状態を確認</li>
                                    <li>最終手段：terraform force-unlock（要注意）</li>
                                    <li>根本対策：タイムアウト設定と適切なエラーハンドリング</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <!-- 章のまとめ -->
                    <div class="concept-card">
                        <h4><i class="fas fa-bookmark"></i> この章のまとめ</h4>
                        <p>
                            第7章では、Terraformステート管理の重要性と実践的な管理方法を学習しました。
                            ステートファイルの役割を理解し、S3とDynamoDBを使用したリモートバックエンドの
                            構築方法、Workspaceによる環境分離、そしてステート操作のコマンドと
                            トラブルシューティング手法を習得しました。
                        </p>
                        <p>
                            特に重要なのは、チーム開発においてリモートバックエンドとステートロックが
                            必須であること、そしてWorkspaceを使用した効率的な環境管理です。
                            これらの知識により、安全で効率的なインフラ管理が可能になります。
                        </p>
                        <p>
                            次章では、Terraformモジュールを使用したコードの再利用と、
                            より高度な設計パターンについて学習します。
                        </p>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aws-terraform-learning-material-06.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aws-terraform-learning-material-08.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>

    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>