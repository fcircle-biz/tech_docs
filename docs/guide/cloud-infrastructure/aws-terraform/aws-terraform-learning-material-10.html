<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Terraform学習教材 第10章 - 実践プロジェクトとベストプラクティス</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/hcl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- カスタムCSS -->
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #FF9900;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .navbar-brand i {
            margin-right: 10px;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }

        .chapter-title {
            color: #FF9900;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #FF9900;
            padding-bottom: 0.5rem;
            font-weight: 600;
        }

        .section-title {
            color: #FF6600;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }

        .quiz-container {
            background-color: #FFF3E0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #FF9900;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #2196f3;
        }

        .best-practice {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .code-block {
            background-color: #282c34;
            color: #abb2bf;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .quiz-option {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .quiz-option:hover {
            background-color: #f5f5f5;
        }

        .quiz-option.correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .quiz-option.incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .concept-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,.05);
            margin: 1.5rem 0;
        }

        .architecture-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .project-phase {
            background-color: #f7f3ff;
            border-radius: 8px;
            padding: 1.2rem;
            margin: 1rem 0;
            border-left: 4px solid #6366f1;
        }

        .nav-link.active {
            background-color: #FF9900;
            color: white !important;
            border-radius: 4px;
        }

        .checklist-item {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-left: 3px solid #4caf50;
            background: #f1f8f4;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fab fa-aws"></i>
                AWS Terraform学習教材
            </a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-01.html">
                                第1章: Terraform入門とAWS環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-02.html">
                                第2章: HCL構文とTerraformの基本操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-03.html">
                                第3章: VPCとネットワークインフラの構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-04.html">
                                第4章: EC2インスタンスとコンピューティングリソース
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-05.html">
                                第5章: ストレージとデータベースサービス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-06.html">
                                第6章: IAMとセキュリティ管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-07.html">
                                第7章: Terraformステート管理とバックエンド
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-08.html">
                                第8章: Terraformモジュールとコードの再利用
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-09.html">
                                第9章: CI/CDパイプラインとの統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aws-terraform-learning-material-10.html">
                                第10章: 実践プロジェクトとベストプラクティス
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第10章: 実践プロジェクトとベストプラクティス</h1>
                </div>

                <div id="chapter10">
                    <h2 class="chapter-title">エンタープライズレベルのTerraform実装を完成させる</h2>

                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5><i class="fas fa-graduation-cap"></i> この章で学ぶこと</h5>
                        <ul>
                            <li>エンタープライズレベルのTerraformプロジェクト構造を設計する</li>
                            <li>マイクロサービスアーキテクチャをTerraformで実装する</li>
                            <li>完全なWebアプリケーションインフラを構築する</li>
                            <li>運用における重要なベストプラクティスを実践する</li>
                        </ul>
                    </div>

                    <!-- Section 10.1 -->
                    <h3 class="section-title">10.1 エンタープライズプロジェクト構造</h3>

                    <div class="concept-card">
                        <h4>大規模組織向けのTerraformプロジェクト設計</h4>
                        <p>
                            エンタープライズレベルのTerraformプロジェクトでは、複数のチーム、環境、
                            リージョンを考慮した、スケーラブルで保守可能な構造が必要です。
                            ここでは、実際の大規模プロジェクトで採用される構造パターンを学びます。
                        </p>

                        <div class="mermaid">
                            graph TD
                                A[terraform-infrastructure] --> B[environments]
                                A --> C[modules]
                                A --> D[global]
                                A --> E[policies]

                                B --> F[dev]
                                B --> G[staging]
                                B --> H[production]

                                C --> I[networking]
                                C --> J[compute]
                                C --> K[data]
                                C --> L[security]

                                F --> M[ap-northeast-1]
                                F --> N[us-west-2]

                                H --> O[ap-northeast-1]
                                H --> P[us-west-2]
                                H --> Q[eu-west-1]

                                D --> R[iam]
                                D --> S[cloudtrail]
                                D --> T[organizations]
                        </div>

                        <h5 class="mt-4">推奨ディレクトリ構造</h5>
                        <pre class="code-block"><code class="language-bash"># エンタープライズTerraformプロジェクト構造
terraform-infrastructure/
├── environments/
│   ├── dev/
│   │   ├── ap-northeast-1/
│   │   │   ├── main.tf
│   │   │   ├── variables.tf
│   │   │   ├── outputs.tf
│   │   │   ├── backend.tf
│   │   │   └── terraform.tfvars
│   │   └── us-west-2/
│   │       └── ...
│   ├── staging/
│   │   └── ...
│   └── production/
│       ├── ap-northeast-1/
│       ├── us-west-2/
│       └── eu-west-1/
├── modules/
│   ├── networking/
│   │   ├── vpc/
│   │   ├── subnets/
│   │   ├── nat-gateway/
│   │   └── transit-gateway/
│   ├── compute/
│   │   ├── ecs-cluster/
│   │   ├── eks-cluster/
│   │   ├── lambda/
│   │   └── batch/
│   ├── data/
│   │   ├── rds/
│   │   ├── dynamodb/
│   │   ├── s3/
│   │   └── elasticsearch/
│   └── security/
│       ├── kms/
│       ├── secrets-manager/
│       └── waf/
├── global/
│   ├── iam/
│   ├── cloudtrail/
│   └── organizations/
├── policies/
│   ├── sentinel/
│   └── opa/
└── scripts/
    ├── init-backend.sh
    ├── migrate-state.sh
    └── destroy-environment.sh</code></pre>

                        <h5 class="mt-4">環境別設定ファイル</h5>
                        <pre class="code-block"><code class="language-hcl"># environments/production/ap-northeast-1/main.tf
terraform {
  required_version = ">= 1.5.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = var.region

  default_tags {
    tags = {
      Environment = var.environment
      ManagedBy   = "Terraform"
      CostCenter  = var.cost_center
      Owner       = var.owner_team
    }
  }
}

# ネットワーキングモジュール
module "networking" {
  source = "../../../modules/networking/vpc"

  vpc_cidr           = var.vpc_cidr
  environment        = var.environment
  availability_zones = data.aws_availability_zones.available.names
  enable_nat_gateway = true
  enable_vpn_gateway = true
}

# EKSクラスター
module "eks" {
  source = "../../../modules/compute/eks-cluster"

  cluster_name    = "${var.environment}-main-cluster"
  cluster_version = "1.28"
  vpc_id          = module.networking.vpc_id
  subnet_ids      = module.networking.private_subnet_ids

  node_groups = {
    general = {
      desired_size = 3
      min_size     = 2
      max_size     = 10
      instance_types = ["m5.large"]
    }
    spot = {
      desired_size = 2
      min_size     = 1
      max_size     = 5
      instance_types = ["m5.large", "m5a.large"]
      capacity_type  = "SPOT"
    }
  }
}</code></pre>
                    </div>

                    <!-- Section 10.2 -->
                    <h3 class="section-title">10.2 マイクロサービスアーキテクチャの実装</h3>

                    <div class="architecture-card">
                        <h4><i class="fas fa-project-diagram"></i> マイクロサービスインフラストラクチャ</h4>
                        <p>
                            モダンなマイクロサービスアーキテクチャを AWS と Terraform で実装します。
                            ECS/EKS、API Gateway、サービスメッシュ、分散トレーシングなど、
                            必要なコンポーネントをすべて含みます。
                        </p>
                    </div>

                    <div class="concept-card">
                        <div class="mermaid">
                            graph TB
                                A[CloudFront] --> B[ALB]
                                B --> C[API Gateway]

                                C --> D[Auth Service<br/>Lambda]
                                C --> E[User Service<br/>ECS Fargate]
                                C --> F[Product Service<br/>ECS Fargate]
                                C --> G[Order Service<br/>EKS]

                                E --> H[(RDS<br/>Users DB)]
                                F --> I[(DynamoDB<br/>Products)]
                                G --> J[(RDS<br/>Orders DB)]

                                K[Service Mesh<br/>App Mesh] --> E
                                K --> F
                                K --> G

                                L[Monitoring<br/>CloudWatch/X-Ray] --> E
                                L --> F
                                L --> G
                        </div>

                        <h5 class="mt-4">サービスごとのTerraform実装</h5>
                        <pre class="code-block"><code class="language-hcl"># modules/microservices/user-service/main.tf
resource "aws_ecs_task_definition" "user_service" {
  family                   = "${var.environment}-user-service"
  network_mode             = "awsvpc"
  requires_compatibilities = ["FARGATE"]
  cpu                      = var.task_cpu
  memory                   = var.task_memory
  execution_role_arn       = aws_iam_role.ecs_execution_role.arn
  task_role_arn           = aws_iam_role.ecs_task_role.arn

  container_definitions = jsonencode([
    {
      name  = "user-service"
      image = "${var.ecr_repository_url}:${var.image_tag}"

      portMappings = [
        {
          containerPort = 8080
          protocol      = "tcp"
        }
      ]

      environment = [
        {
          name  = "DB_HOST"
          value = var.database_endpoint
        },
        {
          name  = "ENVIRONMENT"
          value = var.environment
        }
      ]

      secrets = [
        {
          name      = "DB_PASSWORD"
          valueFrom = aws_secretsmanager_secret.db_password.arn
        }
      ]

      logConfiguration = {
        logDriver = "awslogs"
        options = {
          "awslogs-group"         = aws_cloudwatch_log_group.user_service.name
          "awslogs-region"        = var.region
          "awslogs-stream-prefix" = "ecs"
        }
      }

      healthCheck = {
        command     = ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
        interval    = 30
        timeout     = 5
        retries     = 3
        startPeriod = 60
      }
    }
  ])
}

resource "aws_ecs_service" "user_service" {
  name            = "${var.environment}-user-service"
  cluster         = var.ecs_cluster_id
  task_definition = aws_ecs_task_definition.user_service.arn
  desired_count   = var.desired_count
  launch_type     = "FARGATE"

  network_configuration {
    subnets          = var.private_subnet_ids
    security_groups  = [aws_security_group.user_service.id]
    assign_public_ip = false
  }

  load_balancer {
    target_group_arn = aws_lb_target_group.user_service.arn
    container_name   = "user-service"
    container_port   = 8080
  }

  service_registries {
    registry_arn = aws_service_discovery_service.user_service.arn
  }

  deployment_configuration {
    maximum_percent         = 200
    minimum_healthy_percent = 100
  }

  deployment_circuit_breaker {
    enable   = true
    rollback = true
  }
}</code></pre>

                        <h5 class="mt-4">API Gatewayの統合</h5>
                        <pre class="code-block"><code class="language-hcl"># modules/api-gateway/main.tf
resource "aws_api_gateway_rest_api" "main" {
  name        = "${var.environment}-api"
  description = "Microservices API Gateway"

  endpoint_configuration {
    types = ["REGIONAL"]
  }
}

resource "aws_api_gateway_resource" "users" {
  rest_api_id = aws_api_gateway_rest_api.main.id
  parent_id   = aws_api_gateway_rest_api.main.root_resource_id
  path_part   = "users"
}

resource "aws_api_gateway_method" "users_get" {
  rest_api_id   = aws_api_gateway_rest_api.main.id
  resource_id   = aws_api_gateway_resource.users.id
  http_method   = "GET"
  authorization = "COGNITO_USER_POOLS"
  authorizer_id = aws_api_gateway_authorizer.cognito.id
}

resource "aws_api_gateway_integration" "users_integration" {
  rest_api_id = aws_api_gateway_rest_api.main.id
  resource_id = aws_api_gateway_resource.users.id
  http_method = aws_api_gateway_method.users_get.http_method

  integration_http_method = "GET"
  type                   = "HTTP_PROXY"
  uri                    = "http://${aws_lb.internal.dns_name}/users"

  connection_type = "VPC_LINK"
  connection_id   = aws_api_gateway_vpc_link.main.id
}</code></pre>
                    </div>

                    <!-- Section 10.3 -->
                    <h3 class="section-title">10.3 完全なWebアプリケーションプロジェクト</h3>

                    <div class="concept-card">
                        <h4>実践プロジェクト：ECサイトインフラストラクチャ</h4>
                        <p>
                            これまでに学んだ知識を統合して、実際のEコマースサイトの
                            完全なインフラストラクチャをTerraformで構築します。
                        </p>

                        <div class="project-phase">
                            <h5><i class="fas fa-layer-group"></i> フェーズ1：基盤インフラストラクチャ</h5>
                            <pre class="code-block"><code class="language-hcl"># infrastructure/base/main.tf
module "networking" {
  source = "./modules/networking"

  project_name = var.project_name
  environment  = var.environment

  vpc_cidr = "10.0.0.0/16"

  public_subnet_cidrs  = ["10.0.1.0/24", "10.0.2.0/24"]
  private_subnet_cidrs = ["10.0.10.0/24", "10.0.11.0/24"]
  database_subnet_cidrs = ["10.0.20.0/24", "10.0.21.0/24"]
}

module "security" {
  source = "./modules/security"

  vpc_id = module.networking.vpc_id

  allowed_ingress_cidr_blocks = var.allowed_cidr_blocks
  enable_waf                  = true
  enable_shield               = var.environment == "production"
}</code></pre>
                        </div>

                        <div class="project-phase">
                            <h5><i class="fas fa-database"></i> フェーズ2：データレイヤー</h5>
                            <pre class="code-block"><code class="language-hcl"># infrastructure/data/main.tf
module "rds_cluster" {
  source = "./modules/rds-aurora"

  cluster_identifier = "${var.project_name}-${var.environment}"
  engine             = "aurora-mysql"
  engine_version     = "8.0.mysql_aurora.3.04.0"

  master_username = "admin"
  database_name   = "ecommerce"

  vpc_id              = data.terraform_remote_state.base.outputs.vpc_id
  subnet_ids          = data.terraform_remote_state.base.outputs.database_subnet_ids
  security_group_ids  = [module.security.database_sg_id]

  instance_count     = var.environment == "production" ? 3 : 1
  instance_class     = var.environment == "production" ? "db.r6g.large" : "db.t3.medium"

  backup_retention_period = var.environment == "production" ? 30 : 7
  preferred_backup_window = "03:00-04:00"

  enable_performance_insights = true
  performance_insights_retention_period = 7
}

module "redis_cluster" {
  source = "./modules/elasticache"

  cluster_id = "${var.project_name}-cache-${var.environment}"
  engine     = "redis"
  node_type  = var.environment == "production" ? "cache.r6g.large" : "cache.t3.micro"

  num_cache_nodes = var.environment == "production" ? 3 : 1
  subnet_ids      = data.terraform_remote_state.base.outputs.private_subnet_ids

  enable_automatic_failover = var.environment == "production"
  enable_at_rest_encryption = true
  enable_transit_encryption = true
}</code></pre>
                        </div>

                        <div class="project-phase">
                            <h5><i class="fas fa-rocket"></i> フェーズ3：アプリケーションレイヤー</h5>
                            <pre class="code-block"><code class="language-hcl"># infrastructure/application/main.tf
module "ecs_cluster" {
  source = "./modules/ecs-cluster"

  cluster_name = "${var.project_name}-${var.environment}"

  enable_container_insights = true
  enable_fargate_capacity_providers = true
}

module "frontend_service" {
  source = "./modules/ecs-service"

  service_name    = "frontend"
  cluster_id      = module.ecs_cluster.cluster_id
  vpc_id          = data.terraform_remote_state.base.outputs.vpc_id
  subnet_ids      = data.terraform_remote_state.base.outputs.private_subnet_ids

  container_image = "${var.ecr_repository}/frontend:${var.frontend_version}"
  container_port  = 3000
  cpu            = 512
  memory         = 1024

  desired_count = var.environment == "production" ? 3 : 1
  max_capacity  = var.environment == "production" ? 10 : 3
  min_capacity  = var.environment == "production" ? 2 : 1

  health_check_path = "/"

  environment_variables = {
    API_ENDPOINT = module.api_gateway.endpoint_url
    ENVIRONMENT  = var.environment
  }
}

module "backend_api" {
  source = "./modules/ecs-service"

  service_name = "api"
  cluster_id   = module.ecs_cluster.cluster_id
  vpc_id       = data.terraform_remote_state.base.outputs.vpc_id
  subnet_ids   = data.terraform_remote_state.base.outputs.private_subnet_ids

  container_image = "${var.ecr_repository}/api:${var.api_version}"
  container_port  = 8080
  cpu            = 1024
  memory         = 2048

  desired_count = var.environment == "production" ? 5 : 2
  max_capacity  = var.environment == "production" ? 20 : 5
  min_capacity  = var.environment == "production" ? 3 : 1

  health_check_path = "/api/health"

  secrets = {
    DB_PASSWORD    = aws_secretsmanager_secret.db_password.arn
    JWT_SECRET     = aws_secretsmanager_secret.jwt_secret.arn
    STRIPE_API_KEY = aws_secretsmanager_secret.stripe_key.arn
  }
}</code></pre>
                        </div>
                    </div>

                    <!-- Section 10.4 -->
                    <h3 class="section-title">10.4 運用のベストプラクティス</h3>

                    <div class="best-practice">
                        <h4><i class="fas fa-star"></i> Terraform運用における黄金律</h4>

                        <h5>1. コードレビューとテスト</h5>
                        <div class="checklist-item">
                            <strong>✓ Pull Requestでの必須レビュー</strong>
                            <p>すべてのインフラ変更は、最低2名のレビューを経てマージする</p>
                        </div>
                        <div class="checklist-item">
                            <strong>✓ 自動テストの実装</strong>
                            <p>Terratest、Kitchen-Terraform などを使用した自動テスト</p>
                        </div>
                        <div class="checklist-item">
                            <strong>✓ ポリシーテスト</strong>
                            <p>Sentinel、OPA でコンプライアンスを自動チェック</p>
                        </div>

                        <h5 class="mt-4">2. 状態管理のベストプラクティス</h5>
                        <pre class="code-block"><code class="language-hcl"># backend-config.tf
terraform {
  backend "s3" {
    bucket         = "company-terraform-state"
    key            = "env/${var.environment}/terraform.tfstate"
    region         = "ap-northeast-1"
    encrypt        = true
    kms_key_id     = "arn:aws:kms:ap-northeast-1:123456789012:key/uuid"

    dynamodb_table = "terraform-state-lock"

    # ステートのバージョニング
    versioning = true

    # ステートへのアクセスログ
    logging {
      target_bucket = "company-terraform-logs"
      target_prefix = "state-access/"
    }
  }
}</code></pre>

                        <h5 class="mt-4">3. ディザスタリカバリ戦略</h5>
                        <pre class="code-block"><code class="language-bash">#!/bin/bash
# disaster-recovery.sh

# ステートのバックアップ
backup_state() {
    local env=$1
    local timestamp=$(date +%Y%m%d_%H%M%S)

    # S3からステートをダウンロード
    aws s3 cp s3://company-terraform-state/env/${env}/terraform.tfstate \
              ./backups/${env}_${timestamp}.tfstate

    # 暗号化してアーカイブ
    tar czf ./backups/${env}_${timestamp}.tar.gz \
            ./backups/${env}_${timestamp}.tfstate

    # 別リージョンのS3にコピー
    aws s3 cp ./backups/${env}_${timestamp}.tar.gz \
              s3://dr-terraform-backups/${env}/ \
              --region us-west-2
}

# リカバリ手順
restore_state() {
    local env=$1
    local backup_file=$2

    # バックアップから復元
    tar xzf ${backup_file}

    # ステートを検証
    terraform state pull > current.tfstate
    terraform state push ${backup_file%.tar.gz}.tfstate
}
</code></pre>

                        <h5 class="mt-4">4. 監視とアラート</h5>
                        <pre class="code-block"><code class="language-hcl"># monitoring.tf
resource "aws_cloudwatch_metric_alarm" "terraform_apply_failures" {
  alarm_name          = "terraform-apply-failures"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "1"
  metric_name        = "ApplyFailures"
  namespace          = "Terraform/Operations"
  period             = "300"
  statistic          = "Sum"
  threshold          = "0"
  alarm_description  = "Terraform Apply操作の失敗を検知"

  alarm_actions = [aws_sns_topic.alerts.arn]
}

resource "aws_cloudwatch_dashboard" "terraform_ops" {
  dashboard_name = "terraform-operations"

  dashboard_body = jsonencode({
    widgets = [
      {
        type = "metric"
        properties = {
          metrics = [
            ["Terraform/Operations", "ApplyDuration", { stat = "Average" }],
            [".", "PlanDuration", { stat = "Average" }],
            [".", "StateSize", { stat = "Maximum" }]
          ]
          period = 300
          stat   = "Average"
          region = "ap-northeast-1"
          title  = "Terraform Operations Metrics"
        }
      }
    ]
  })
}</code></pre>
                    </div>

                    <!-- Section 10.5 -->
                    <h3 class="section-title">10.5 トラブルシューティングガイド</h3>

                    <div class="warning">
                        <h4><i class="fas fa-exclamation-triangle"></i> よくある問題と解決方法</h4>

                        <h5>1. State Lock エラー</h5>
                        <pre class="code-block"><code class="language-bash"># エラー: Error acquiring the state lock
# 解決方法:
terraform force-unlock <lock-id>

# または DynamoDB から直接削除
aws dynamodb delete-item \
  --table-name terraform-state-lock \
  --key '{"LockID": {"S": "company-terraform-state/env/prod/terraform.tfstate"}}'</code></pre>

                        <h5>2. リソースのドリフト検出</h5>
                        <pre class="code-block"><code class="language-bash"># 実際の状態との差分を確認
terraform refresh
terraform plan -refresh-only

# ドリフトしたリソースを再インポート
terraform import aws_instance.example i-1234567890abcdef0</code></pre>

                        <h5>3. 大規模変更の安全な実行</h5>
                        <pre class="code-block"><code class="language-bash"># ターゲットを指定して段階的に適用
terraform apply -target=module.networking
terraform apply -target=module.database
terraform apply  # 残りすべて

# 並列実行数の制限
terraform apply -parallelism=5</code></pre>
                    </div>

                    <!-- 実習セクション -->
                    <div class="exercise-container">
                        <h4><i class="fas fa-laptop-code"></i> 総合演習：完全なプロジェクトの構築</h4>

                        <h5>演習の目標</h5>
                        <p>
                            3層アーキテクチャのWebアプリケーションを、すべての学習内容を活用して構築します。
                            CI/CD、モニタリング、セキュリティ、スケーラビリティを含む完全なソリューションです。
                        </p>

                        <h5>要件</h5>
                        <ul>
                            <li>マルチAZ構成のVPCネットワーク</li>
                            <li>ALB + ECS Fargate によるWebアプリケーション</li>
                            <li>Aurora Serverless v2 データベース</li>
                            <li>ElastiCache Redis セッションストア</li>
                            <li>CloudFront CDN配信</li>
                            <li>GitHub Actions CI/CDパイプライン</li>
                            <li>CloudWatch/X-Ray による監視</li>
                            <li>WAF/Shield によるセキュリティ</li>
                        </ul>

                        <h5>実装のヒント</h5>
                        <ol>
                            <li>まず基盤となるネットワークから構築</li>
                            <li>データレイヤーを次に構築</li>
                            <li>アプリケーションレイヤーを最後に追加</li>
                            <li>各ステップでterraform planを実行して検証</li>
                            <li>環境ごとにワークスペースを分離</li>
                        </ol>
                    </div>

                    <!-- クイズセクション -->
                    <div class="quiz-container">
                        <h4><i class="fas fa-question-circle"></i> 最終理解度チェック</h4>

                        <div class="mb-3">
                            <p><strong>問題1：</strong> エンタープライズプロジェクトでTerraformステートを管理する最適な方法は？</p>
                            <div class="quiz-option" onclick="checkAnswer(this, false)">A. ローカルファイルシステムで管理</div>
                            <div class="quiz-option" onclick="checkAnswer(this, true)">B. S3 + DynamoDBでリモート管理</div>
                            <div class="quiz-option" onclick="checkAnswer(this, false)">C. Gitリポジトリにコミット</div>
                            <div class="quiz-option" onclick="checkAnswer(this, false)">D. 各開発者が個別に管理</div>
                        </div>

                        <div class="mb-3">
                            <p><strong>問題2：</strong> マイクロサービスアーキテクチャでサービス間通信を管理する最適な方法は？</p>
                            <div class="quiz-option" onclick="checkAnswer(this, false)">A. 直接IPアドレスで通信</div>
                            <div class="quiz-option" onclick="checkAnswer(this, false)">B. ハードコードされたDNS名</div>
                            <div class="quiz-option" onclick="checkAnswer(this, true)">C. Service Discovery + Service Mesh</div>
                            <div class="quiz-option" onclick="checkAnswer(this, false)">D. 外部ロードバランサー経由</div>
                        </div>

                        <div class="mb-3">
                            <p><strong>問題3：</strong> 本番環境へのTerraform適用で最も重要な考慮事項は？</p>
                            <div class="quiz-option" onclick="checkAnswer(this, false)">A. 実行速度の最適化</div>
                            <div class="quiz-option" onclick="checkAnswer(this, true)">B. 変更の影響範囲の事前確認とレビュー</div>
                            <div class="quiz-option" onclick="checkAnswer(this, false)">C. 最新バージョンのTerraformの使用</div>
                            <div class="quiz-option" onclick="checkAnswer(this, false)">D. すべてのリソースの再作成</div>
                        </div>
                    </div>

                    <!-- コース修了メッセージ -->
                    <div class="architecture-card mt-5">
                        <h3><i class="fas fa-trophy"></i> おめでとうございます！</h3>
                        <p>
                            AWS Terraform学習コースを修了しました。これまでの学習を通じて、
                            Infrastructure as Codeの基礎から、エンタープライズレベルの実装まで、
                            幅広い知識とスキルを習得しました。
                        </p>

                        <h5 class="mt-4">習得したスキル</h5>
                        <ul>
                            <li>✅ Terraformの基本概念とHCL構文</li>
                            <li>✅ AWSリソースの宣言的管理</li>
                            <li>✅ ステート管理とバックエンド設定</li>
                            <li>✅ モジュール化と再利用可能なコード設計</li>
                            <li>✅ CI/CDパイプラインの統合</li>
                            <li>✅ エンタープライズレベルのベストプラクティス</li>
                        </ul>

                        <h5 class="mt-4">次のステップ</h5>
                        <p>
                            学習を継続し、実践経験を積むことをお勧めします：
                        </p>
                        <ul>
                            <li>実際のプロジェクトでTerraformを使用する</li>
                            <li>HashiCorp Certified: Terraform Associate認定を取得</li>
                            <li>他のHashiCorpツール（Vault、Consul、Nomad）を学習</li>
                            <li>マルチクラウド環境でのTerraform活用を探求</li>
                        </ul>
                    </div>

                    <!-- ナビゲーション -->
                    <div class="d-flex justify-content-between mt-5 mb-3">
                        <a href="aws-terraform-learning-material-09.html" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left"></i> 前の章へ
                        </a>
                        <a href="aws-terraform-learning-material-01.html" class="btn btn-success">
                            <i class="fas fa-home"></i> コースの最初へ戻る
                        </a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Highlight.js の初期化
        hljs.highlightAll();

        // Mermaid.js の初期化
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });

        // クイズの回答チェック
        function checkAnswer(element, isCorrect) {
            // すでに回答済みの場合は何もしない
            if (element.classList.contains('answered')) {
                return;
            }

            // 全ての選択肢を無効化
            const options = element.parentElement.querySelectorAll('.quiz-option');
            options.forEach(opt => {
                opt.classList.add('answered');
                opt.style.cursor = 'default';
            });

            // 選択した回答のスタイルを設定
            if (isCorrect) {
                element.classList.add('correct');
                // 正解メッセージを表示
                const message = document.createElement('div');
                message.className = 'alert alert-success mt-2';
                message.innerHTML = '<i class="fas fa-check-circle"></i> 正解です！';
                element.parentElement.appendChild(message);
            } else {
                element.classList.add('incorrect');
                // 不正解メッセージを表示
                const message = document.createElement('div');
                message.className = 'alert alert-danger mt-2';
                message.innerHTML = '<i class="fas fa-times-circle"></i> 不正解です。もう一度考えてみましょう。';
                element.parentElement.appendChild(message);
            }
        }

        // スムーススクロール
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // 完了時の祝福アニメーション
        window.addEventListener('load', function() {
            const trophyCard = document.querySelector('.architecture-card');
            if (trophyCard) {
                trophyCard.style.opacity = '0';
                trophyCard.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    trophyCard.style.transition = 'all 1s ease';
                    trophyCard.style.opacity = '1';
                    trophyCard.style.transform = 'translateY(0)';
                }, 500);
            }
        });
    </script>
</body>
</html>