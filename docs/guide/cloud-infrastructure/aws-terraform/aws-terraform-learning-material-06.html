<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Terraform学習教材 第6章 - IAMとセキュリティ管理</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/hcl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- カスタムCSS -->
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #FF9900;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .navbar-brand i {
            margin-right: 10px;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }

        .chapter-title {
            color: #FF9900;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #FF9900;
            padding-bottom: 0.5rem;
            font-weight: 600;
        }

        .section-title {
            color: #FF6600;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: 500;
        }

        .quiz-container {
            background-color: #FFF3E0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #FF9900;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info-box {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #2196f3;
        }

        .security-box {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .code-block {
            background-color: #1e1e1e;
            color: white;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .nav-link.active {
            background-color: #FF9900 !important;
            color: white !important;
            font-weight: 500;
        }

        .nav-link {
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 2px 0;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background-color: #FFF3E0;
            color: #FF6600;
        }

        .concept-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .concept-card h4 {
            color: #FF6600;
            margin-bottom: 15px;
        }

        .term-definition {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4169e1;
        }

        .term-definition dt {
            font-weight: bold;
            color: #4169e1;
            margin-bottom: 8px;
        }

        .term-definition dd {
            margin-left: 20px;
            color: #333;
        }

        .footer {
            background-color: #333;
            color: white;
            padding: 2rem 0;
            margin-top: 4rem;
        }

        .mermaid {
            margin: 20px 0;
            text-align: center;
        }

        pre.code-block code {
            display: block;
            padding: 0 !important;
            background: transparent !important;
        }

        .best-practice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .best-practice h5 {
            color: white;
            margin-bottom: 15px;
        }

        .best-practice ul li {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fab fa-aws"></i>
                AWS Terraform 学習教材
            </a>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-01.html">
                                第1章: Terraform入門とAWS環境設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-02.html">
                                第2章: HCL構文とTerraformの基本操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-03.html">
                                第3章: VPCとネットワークインフラの構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-04.html">
                                第4章: EC2インスタンスとコンピューティングリソース
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-05.html">
                                第5章: ストレージとデータベースサービス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aws-terraform-learning-material-06.html">
                                第6章: IAMとセキュリティ管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-07.html">
                                第7章: Terraformステート管理とバックエンド
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-08.html">
                                第8章: Terraformモジュールとコードの再利用
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-09.html">
                                第9章: CI/CDパイプラインとの統合
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aws-terraform-learning-material-10.html">
                                第10章: 実践プロジェクトとベストプラクティス
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: IAMとセキュリティ管理</h1>
                </div>

                <div id="chapter6">
                    <h2 class="chapter-title">AWSセキュリティのベストプラクティス実装</h2>

                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5><i class="fas fa-graduation-cap"></i> この章で学ぶこと</h5>
                        <ul>
                            <li>IAM（Identity and Access Management）の基本概念と構成要素</li>
                            <li>最小権限の原則に基づいたIAMポリシーの設計と実装</li>
                            <li>IAMロールによるクロスアカウントアクセスとサービス連携</li>
                            <li>AWS Organizations とSCP（Service Control Policy）による統制</li>
                            <li>セキュリティベストプラクティスとコンプライアンス対応</li>
                        </ul>
                    </div>

                    <!-- Section 6.1 -->
                    <h3 class="section-title">6.1 IAMの基本概念と構成要素</h3>

                    <div class="concept-card">
                        <h4>IAMの役割と重要性</h4>
                        <p>
                            IAM（Identity and Access Management）は、AWSリソースへのアクセスを
                            安全に制御するためのウェブサービスです。「誰が」「何に対して」「何ができるか」
                            を定義し、セキュリティの要となります。
                        </p>

                        <div class="mermaid">
                            flowchart TD
                                A[IAM] --> B[ユーザー<br/>（人間）]
                                A --> C[グループ<br/>（ユーザーの集合）]
                                A --> D[ロール<br/>（一時的な権限）]
                                A --> E[ポリシー<br/>（権限の定義）]
                                B --> F[アクセスキー<br/>（プログラムアクセス）]
                                B --> G[パスワード<br/>（コンソールアクセス）]
                                B --> H[MFA<br/>（多要素認証）]
                                D --> I[EC2インスタンス]
                                D --> J[Lambda関数]
                                D --> K[クロスアカウント]
                                E --> L[管理ポリシー]
                                E --> M[インラインポリシー]
                        </div>
                    </div>

                    <div class="term-definition">
                        <dt>IAMの主要コンポーネント</dt>
                        <dd>
                            <ul>
                                <li><strong>IAMユーザー</strong>：個人またはアプリケーションを表す恒久的なアイデンティティ</li>
                                <li><strong>IAMグループ</strong>：共通の権限を持つユーザーの集まり</li>
                                <li><strong>IAMロール</strong>：一時的に引き受けることができる権限のセット</li>
                                <li><strong>IAMポリシー</strong>：権限を定義するJSONドキュメント</li>
                            </ul>
                        </dd>
                    </div>

                    <div class="concept-card">
                        <h4>IAMユーザーとグループの管理</h4>

                        <pre class="code-block"><code class="language-hcl"># iam_users.tf - ユーザーとグループの定義

# 開発者グループ
resource "aws_iam_group" "developers" {
  name = "${var.project_name}-developers"
  path = "/users/"
}

# 管理者グループ
resource "aws_iam_group" "admins" {
  name = "${var.project_name}-admins"
  path = "/users/"
}

# 読み取り専用グループ
resource "aws_iam_group" "readonly" {
  name = "${var.project_name}-readonly"
  path = "/users/"
}

# IAMユーザーの作成
resource "aws_iam_user" "developer" {
  for_each = toset(var.developer_users)

  name = each.value
  path = "/users/"

  tags = {
    Department = "Development"
    ManagedBy  = "Terraform"
  }
}

# グループメンバーシップの設定
resource "aws_iam_group_membership" "developers" {
  name = "${var.project_name}-developers-membership"

  users = [
    for user in aws_iam_user.developer : user.name
  ]

  group = aws_iam_group.developers.name
}

# パスワードポリシーの設定
resource "aws_iam_account_password_policy" "strict" {
  minimum_password_length        = 14
  require_lowercase_letters      = true
  require_numbers                = true
  require_uppercase_letters      = true
  require_symbols                = true
  allow_users_to_change_password = true
  max_password_age               = 90
  password_reuse_prevention      = 5
}

# MFA強制ポリシー
data "aws_iam_policy_document" "enforce_mfa" {
  statement {
    sid    = "DenyAllExceptListedIfNoMFA"
    effect = "Deny"

    not_actions = [
      "iam:CreateVirtualMFADevice",
      "iam:EnableMFADevice",
      "iam:GetUser",
      "iam:ListMFADevices",
      "iam:ListVirtualMFADevices",
      "iam:ResyncMFADevice",
      "sts:GetSessionToken"
    ]

    resources = ["*"]

    condition {
      test     = "BoolIfExists"
      variable = "aws:MultiFactorAuthPresent"
      values   = ["false"]
    }
  }
}

resource "aws_iam_policy" "enforce_mfa" {
  name        = "${var.project_name}-enforce-mfa"
  path        = "/"
  description = "Enforce MFA for all users"

  policy = data.aws_iam_policy_document.enforce_mfa.json
}

# グループへのポリシー割り当て
resource "aws_iam_group_policy_attachment" "developers_mfa" {
  group      = aws_iam_group.developers.name
  policy_arn = aws_iam_policy.enforce_mfa.arn
}</code></pre>
                    </div>

                    <!-- Section 6.2 -->
                    <h3 class="section-title">6.2 IAMポリシーの設計と実装</h3>

                    <div class="concept-card">
                        <h4>最小権限の原則</h4>
                        <p>
                            最小権限の原則（Principle of Least Privilege）は、ユーザーやサービスに対して、
                            タスクを実行するために必要最小限の権限のみを付与するセキュリティの基本原則です。
                        </p>

                        <div class="security-box">
                            <h6><i class="fas fa-shield-alt"></i> ポリシー設計のベストプラクティス</h6>
                            <ul>
                                <li>明示的な拒否（Deny）は許可（Allow）よりも優先される</li>
                                <li>リソースARNは可能な限り具体的に指定する</li>
                                <li>条件（Condition）を使用してアクセスをさらに制限する</li>
                                <li>定期的に権限をレビューし、不要な権限を削除する</li>
                            </ul>
                        </div>

                        <pre class="code-block"><code class="language-hcl"># iam_policies.tf - カスタムポリシーの定義

# S3バケットへの限定的なアクセスポリシー
data "aws_iam_policy_document" "s3_restricted_access" {
  statement {
    sid    = "ListBuckets"
    effect = "Allow"

    actions = [
      "s3:ListBucket",
      "s3:GetBucketLocation"
    ]

    resources = [
      aws_s3_bucket.main.arn
    ]

    condition {
      test     = "StringEquals"
      variable = "s3:prefix"
      values   = ["public/*", "shared/*"]
    }
  }

  statement {
    sid    = "ReadWriteObjects"
    effect = "Allow"

    actions = [
      "s3:GetObject",
      "s3:PutObject",
      "s3:DeleteObject"
    ]

    resources = [
      "${aws_s3_bucket.main.arn}/public/*",
      "${aws_s3_bucket.main.arn}/shared/*"
    ]

    condition {
      test     = "StringEquals"
      variable = "s3:x-amz-server-side-encryption"
      values   = ["AES256"]
    }
  }

  statement {
    sid    = "DenyUnencryptedObjectUploads"
    effect = "Deny"

    actions = [
      "s3:PutObject"
    ]

    resources = [
      "${aws_s3_bucket.main.arn}/*"
    ]

    condition {
      test     = "StringNotEquals"
      variable = "s3:x-amz-server-side-encryption"
      values   = ["AES256", "aws:kms"]
    }
  }
}

resource "aws_iam_policy" "s3_restricted_access" {
  name        = "${var.project_name}-s3-restricted-access"
  path        = "/"
  description = "Restricted S3 bucket access with encryption enforcement"

  policy = data.aws_iam_policy_document.s3_restricted_access.json
}

# EC2管理者ポリシー（特定タグのインスタンスのみ）
data "aws_iam_policy_document" "ec2_admin_tagged" {
  statement {
    sid    = "EC2ReadAll"
    effect = "Allow"

    actions = [
      "ec2:Describe*",
      "ec2:Get*"
    ]

    resources = ["*"]
  }

  statement {
    sid    = "EC2ManageTagged"
    effect = "Allow"

    actions = [
      "ec2:StartInstances",
      "ec2:StopInstances",
      "ec2:RebootInstances",
      "ec2:TerminateInstances"
    ]

    resources = [
      "arn:aws:ec2:*:*:instance/*"
    ]

    condition {
      test     = "StringEquals"
      variable = "ec2:ResourceTag/Environment"
      values   = ["Development", "Staging"]
    }

    condition {
      test     = "StringEquals"
      variable = "ec2:ResourceTag/ManagedBy"
      values   = ["Terraform"]
    }
  }

  statement {
    sid    = "RequireMFAForTermination"
    effect = "Deny"

    actions = [
      "ec2:TerminateInstances"
    ]

    resources = ["*"]

    condition {
      test     = "BoolIfExists"
      variable = "aws:MultiFactorAuthPresent"
      values   = ["false"]
    }
  }
}

resource "aws_iam_policy" "ec2_admin_tagged" {
  name        = "${var.project_name}-ec2-admin-tagged"
  path        = "/"
  description = "EC2 administration for tagged instances only"

  policy = data.aws_iam_policy_document.ec2_admin_tagged.json
}

# 時間制限付きアクセスポリシー
data "aws_iam_policy_document" "time_restricted_access" {
  statement {
    sid    = "WorkingHoursOnly"
    effect = "Allow"

    actions = [
      "ec2:*",
      "rds:*"
    ]

    resources = ["*"]

    condition {
      test     = "DateGreaterThan"
      variable = "aws:CurrentTime"
      values   = ["09:00Z"]  # UTC 9:00 (JST 18:00)
    }

    condition {
      test     = "DateLessThan"
      variable = "aws:CurrentTime"
      values   = ["18:00Z"]  # UTC 18:00 (JST 03:00)
    }

    condition {
      test     = "ForAllValues:StringEquals"
      variable = "aws:RequestedRegion"
      values   = var.allowed_regions
    }
  }
}</code></pre>
                    </div>

                    <!-- Section 6.3 -->
                    <h3 class="section-title">6.3 IAMロールとサービス連携</h3>

                    <div class="concept-card">
                        <h4>IAMロールの活用シーン</h4>
                        <p>
                            IAMロールは、AWSサービスやアプリケーションが一時的に権限を取得するための仕組みです。
                            認証情報をハードコーディングすることなく、安全にAWSリソースへアクセスできます。
                        </p>

                        <div class="mermaid">
                            flowchart LR
                                A[EC2インスタンス] -->|AssumeRole| B[IAMロール]
                                C[Lambda関数] -->|AssumeRole| B
                                D[他のAWSアカウント] -->|AssumeRole| E[クロスアカウントロール]
                                B --> F[一時的な認証情報]
                                F --> G[AWSサービスへアクセス]
                                E --> H[信頼関係]
                                H --> I[外部アカウントからのアクセス]
                        </div>

                        <pre class="code-block"><code class="language-hcl"># iam_roles.tf - 各種IAMロールの定義

# EC2インスタンス用ロール
resource "aws_iam_role" "ec2_app" {
  name = "${var.project_name}-ec2-app-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ec2.amazonaws.com"
        }
      }
    ]
  })

  tags = {
    Name = "${var.project_name}-ec2-app-role"
  }
}

# EC2インスタンスプロファイル
resource "aws_iam_instance_profile" "ec2_app" {
  name = "${var.project_name}-ec2-app-profile"
  role = aws_iam_role.ec2_app.name
}

# Lambda実行ロール
resource "aws_iam_role" "lambda_execution" {
  name = "${var.project_name}-lambda-execution"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "lambda.amazonaws.com"
        }
      }
    ]
  })
}

# ECS タスク実行ロール
resource "aws_iam_role" "ecs_task_execution" {
  name = "${var.project_name}-ecs-task-execution"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ecs-tasks.amazonaws.com"
        }
      }
    ]
  })
}

# クロスアカウントロール
resource "aws_iam_role" "cross_account_access" {
  name = "${var.project_name}-cross-account-access"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          AWS = "arn:aws:iam::${var.trusted_account_id}:root"
        }
        Condition = {
          StringEquals = {
            "sts:ExternalId" = var.external_id
          }
          IpAddress = {
            "aws:SourceIp" = var.allowed_ip_ranges
          }
        }
      }
    ]
  })

  max_session_duration = 3600  # 1時間
}

# サービス連携ポリシーの例（Secrets Manager + RDS）
data "aws_iam_policy_document" "secrets_manager_rds" {
  statement {
    sid    = "ReadDatabaseSecret"
    effect = "Allow"

    actions = [
      "secretsmanager:GetSecretValue",
      "secretsmanager:DescribeSecret"
    ]

    resources = [
      aws_secretsmanager_secret.db_password.arn
    ]
  }

  statement {
    sid    = "DecryptSecret"
    effect = "Allow"

    actions = [
      "kms:Decrypt"
    ]

    resources = [
      aws_kms_key.secrets.arn
    ]

    condition {
      test     = "StringEquals"
      variable = "kms:ViaService"
      values   = ["secretsmanager.${var.aws_region}.amazonaws.com"]
    }
  }
}

resource "aws_iam_policy" "secrets_manager_rds" {
  name   = "${var.project_name}-secrets-manager-rds"
  policy = data.aws_iam_policy_document.secrets_manager_rds.json
}

# ロールへのポリシーアタッチメント
resource "aws_iam_role_policy_attachment" "ec2_app_secrets" {
  role       = aws_iam_role.ec2_app.name
  policy_arn = aws_iam_policy.secrets_manager_rds.arn
}

# Session Managerアクセス用ポリシー
resource "aws_iam_role_policy_attachment" "ec2_ssm" {
  role       = aws_iam_role.ec2_app.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
}</code></pre>
                    </div>

                    <!-- Section 6.4 -->
                    <h3 class="section-title">6.4 セキュリティベストプラクティス</h3>

                    <div class="best-practice">
                        <h5><i class="fas fa-lock"></i> IAMセキュリティのゴールデンルール</h5>
                        <ul>
                            <li><strong>ルートユーザーを使用しない</strong>：日常業務では絶対に使わない</li>
                            <li><strong>個別のIAMユーザーを作成</strong>：共有アカウントは使用しない</li>
                            <li><strong>最小権限の原則を厳守</strong>：必要最小限の権限のみ付与</li>
                            <li><strong>MFAを必須化</strong>：すべての人間ユーザーにMFAを強制</li>
                            <li><strong>アクセスキーの定期的なローテーション</strong>：90日ごとに更新</li>
                            <li><strong>IAMロールを優先使用</strong>：長期的な認証情報より一時的な認証情報</li>
                        </ul>
                    </div>

                    <div class="concept-card">
                        <h4>KMSによる暗号化管理</h4>

                        <pre class="code-block"><code class="language-hcl"># kms.tf - 暗号化キーの管理

# カスタマーマスターキー（CMK）
resource "aws_kms_key" "main" {
  description             = "${var.project_name} master encryption key"
  deletion_window_in_days = 30
  enable_key_rotation     = true

  tags = {
    Name = "${var.project_name}-cmk"
  }
}

# キーエイリアス
resource "aws_kms_alias" "main" {
  name          = "alias/${var.project_name}-main"
  target_key_id = aws_kms_key.main.key_id
}

# キーポリシー
resource "aws_kms_key_policy" "main" {
  key_id = aws_kms_key.main.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid    = "Enable IAM User Permissions"
        Effect = "Allow"
        Principal = {
          AWS = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"
        }
        Action   = "kms:*"
        Resource = "*"
      },
      {
        Sid    = "Allow services to use the key"
        Effect = "Allow"
        Principal = {
          Service = [
            "s3.amazonaws.com",
            "rds.amazonaws.com",
            "dynamodb.amazonaws.com"
          ]
        }
        Action = [
          "kms:Decrypt",
          "kms:GenerateDataKey"
        ]
        Resource = "*"
      },
      {
        Sid    = "Allow attachment of persistent resources"
        Effect = "Allow"
        Principal = {
          AWS = aws_iam_role.ec2_app.arn
        }
        Action = [
          "kms:CreateGrant",
          "kms:ListGrants",
          "kms:RevokeGrant"
        ]
        Resource = "*"
        Condition = {
          Bool = {
            "kms:GrantIsForAWSResource" = "true"
          }
        }
      }
    ]
  })
}</code></pre>
                    </div>

                    <div class="concept-card">
                        <h4>AWS Organizations とService Control Policy</h4>

                        <pre class="code-block"><code class="language-hcl"># organizations.tf - 組織レベルのセキュリティ制御

# Service Control Policy - リージョン制限
data "aws_iam_policy_document" "scp_region_restriction" {
  statement {
    sid    = "DenyAllOutsideAllowedRegions"
    effect = "Deny"

    actions = ["*"]

    resources = ["*"]

    condition {
      test     = "StringNotEquals"
      variable = "aws:RequestedRegion"

      values = [
        "ap-northeast-1",  # 東京
        "us-east-1"        # バージニア（グローバルサービス用）
      ]
    }
  }
}

# SCP - 危険なアクションの禁止
data "aws_iam_policy_document" "scp_deny_dangerous_actions" {
  statement {
    sid    = "DenyDangerousActions"
    effect = "Deny"

    actions = [
      "ec2:TerminateInstances",
      "rds:DeleteDBInstance",
      "s3:DeleteBucket",
      "iam:DeleteRole",
      "organizations:LeaveOrganization",
      "account:CloseAccount"
    ]

    resources = ["*"]

    condition {
      test     = "StringNotEquals"
      variable = "aws:PrincipalOrgID"
      values   = [var.organization_id]
    }
  }

  statement {
    sid    = "RequireMFAForDeletion"
    effect = "Deny"

    actions = [
      "*:Delete*",
      "*:Remove*",
      "*:Terminate*"
    ]

    resources = ["*"]

    condition {
      test     = "BoolIfExists"
      variable = "aws:MultiFactorAuthPresent"
      values   = ["false"]
    }
  }
}</code></pre>
                    </div>

                    <div class="warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> セキュリティ監査とコンプライアンス</h6>
                        <ul>
                            <li>CloudTrailですべてのAPI呼び出しをログ記録</li>
                            <li>AWS Configで設定変更を追跡</li>
                            <li>GuardDutyで脅威を検知</li>
                            <li>Security Hubでセキュリティ状態を一元管理</li>
                            <li>定期的なアクセス権限のレビューと棚卸し</li>
                        </ul>
                    </div>

                    <!-- 実習課題 -->
                    <div class="exercise-container">
                        <h5><i class="fas fa-laptop-code"></i> 実習課題：ゼロトラストセキュリティモデルの実装</h5>

                        <h6>課題内容</h6>
                        <p>以下のセキュリティ要件を満たすIAM構成を実装してください：</p>
                        <ol>
                            <li>開発者、運用、読み取り専用の3つのグループを作成</li>
                            <li>各グループに最小権限の原則に基づいたポリシーを適用</li>
                            <li>すべてのユーザーにMFAを強制</li>
                            <li>EC2インスタンス用のIAMロールを作成（S3、DynamoDB、Secrets Managerアクセス）</li>
                            <li>クロスアカウントアクセス用のロールを設定</li>
                            <li>KMS暗号化キーを作成し、各サービスで使用</li>
                        </ol>

                        <h6>追加チャレンジ</h6>
                        <ul>
                            <li>時間ベースのアクセス制御を実装</li>
                            <li>IPアドレスベースの制限を追加</li>
                            <li>タグベースのリソースアクセス制御</li>
                            <li>AWS SSO（IAM Identity Center）との統合</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5><i class="fas fa-question-circle"></i> 理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>IAMユーザーとIAMロールの使い分けは？</strong>
                                <ul>
                                    <li>IAMユーザー：人間または外部アプリケーション用の恒久的アイデンティティ</li>
                                    <li>IAMロール：AWSサービスやアプリケーション用の一時的な権限</li>
                                    <li>可能な限りIAMロールを使用し、長期的な認証情報を避ける</li>
                                </ul>
                            </li>
                            <li>
                                <strong>ポリシーの評価順序と優先度は？</strong>
                                <ul>
                                    <li>明示的な拒否（Explicit Deny）が最優先</li>
                                    <li>Organizations SCP → IAM境界 → セッションポリシー → アイデンティティベース → リソースベース</li>
                                    <li>すべてのポリシーで許可されて初めてアクセス可能</li>
                                </ul>
                            </li>
                            <li>
                                <strong>AssumeRoleとPassRoleの違いは？</strong>
                                <ul>
                                    <li>AssumeRole：ロールを引き受けて一時認証情報を取得</li>
                                    <li>PassRole：サービスにロールを渡す（EC2やLambdaなど）</li>
                                    <li>PassRoleには別途iam:PassRole権限が必要</li>
                                </ul>
                            </li>
                            <li>
                                <strong>KMSキーローテーションのベストプラクティスは？</strong>
                                <ul>
                                    <li>自動キーローテーションを有効化（年1回）</li>
                                    <li>手動ローテーションでより頻繁な更新も可能</li>
                                    <li>古いキーでも暗号化されたデータは復号可能</li>
                                    <li>キーポリシーでサービスごとのアクセスを制限</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <!-- 章のまとめ -->
                    <div class="concept-card">
                        <h4><i class="fas fa-bookmark"></i> この章のまとめ</h4>
                        <p>
                            第6章では、AWSセキュリティの要であるIAMについて深く学習しました。
                            IAMユーザー、グループ、ロール、ポリシーの各コンポーネントの役割と
                            相互関係を理解し、最小権限の原則に基づいたセキュアなアクセス制御の
                            実装方法を習得しました。
                        </p>
                        <p>
                            特に重要なのは、長期的な認証情報の使用を避け、IAMロールと一時的な
                            認証情報を活用すること、そしてMFAの強制やKMSによる暗号化など、
                            多層防御によってセキュリティを強化することです。
                        </p>
                        <p>
                            次章では、Terraformのステート管理とリモートバックエンドの設定について、
                            チーム開発に必要な知識を学習します。
                        </p>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aws-terraform-learning-material-05.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aws-terraform-learning-material-07.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
                    本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>

    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>