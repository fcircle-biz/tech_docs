<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET Core (VB.NET)学習教材 第10章 - 実践的なWebアプリケーション開発</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #663399;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #663399;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #663399;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #8e44ad;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #f8f4fc;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #663399;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #663399 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>ASP.NET Core (VB.NET)学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-1.html">第1章: ASP.NET Core入門と開発環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-2.html">第2章: MVCアーキテクチャの基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-3.html">第3章: Razorビューとレイアウト</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-4.html">第4章: モデルバインディングとバリデーション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-5.html">第5章: 依存性注入とミドルウェア</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-6.html">第6章: Entity Framework Coreとデータアクセス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-7.html">第7章: Web APIの開発</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-8.html">第8章: 認証と認可</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-9.html">第9章: 状態管理とキャッシング</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aspnetcore-vb-learning-material-10.html">第10章: 実践的なWebアプリケーション開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第10章: 実践的なWebアプリケーション開発</h1>
                </div>

                <div id="chapter10">
                    <h2 class="chapter-title">統合ユーザー管理システムの構築</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>これまで学んだ技術を統合した実践的なWebアプリケーションの開発</li>
                            <li>ユーザー管理システムの完全なCRUD操作の実装</li>
                            <li>ページング機能による大量データの効率的な表示</li>
                            <li>検索・フィルタリング機能の実装</li>
                            <li>ファイルアップロード機能の実装</li>
                            <li>エラーハンドリングとログ記録の実装</li>
                        </ul>
                    </div>

                    <h3 class="section-title">10.1 プロジェクト概要とアーキテクチャ</h3>
                    <p>
                        この章では、従業員管理システムを構築します。
                        これまで学習したすべての技術を統合し、実務レベルのWebアプリケーションを作成します。
                    </p>

                    <div class="mermaid">
                        graph TD
                            A["フロントエンド<br/>(Razor Pages + Bootstrap)"] --> B["コントローラー層<br/>(MVC Controller)"]
                            B --> C["サービス層<br/>(Business Logic)"]
                            C --> D["リポジトリ層<br/>(Data Access)"]
                            D --> E["データベース<br/>(SQL Server + EF Core)"]
                            
                            F["認証・認可<br/>(ASP.NET Identity)"] --> B
                            G["キャッシング<br/>(Memory Cache)"] --> C
                            H["ログ記録<br/>(ILogger)"] --> C
                            I["ファイル管理<br/>(File Storage)"] --> C
                    </div>

                    <p><strong>システム機能一覧：</strong></p>
                    <ul>
                        <li><strong>従業員管理：</strong>登録、表示、更新、削除（CRUD操作）</li>
                        <li><strong>検索・フィルタリング：</strong>名前、部署、役職による絞り込み</li>
                        <li><strong>ページング：</strong>大量データの効率的な表示</li>
                        <li><strong>ファイルアップロード：</strong>従業員の顔写真アップロード</li>
                        <li><strong>権限管理：</strong>管理者・一般ユーザーの役割分離</li>
                        <li><strong>エラーハンドリング：</strong>包括的なエラー処理とログ記録</li>
                    </ul>

                    <h3 class="section-title">10.2 データモデルの設計</h3>
                    <p>
                        まず、システムで使用するデータモデルを定義します。
                        Entity Framework Coreを使用してデータベースファーストアプローチでデータベース設計を行います。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 10-1: データモデルの作成</h5>
                        <p>従業員管理に必要なエンティティを定義します。</p>
                        
                        <h6>従業員エンティティ</h6>
                        <pre class="code-block"><code class="language-vbnet">' Models/Employee.vb
Imports System.ComponentModel.DataAnnotations
Imports System.ComponentModel.DataAnnotations.Schema

&lt;Table("Employees")&gt;
Public Class Employee
    &lt;Key&gt;
    Public Property Id As Integer

    &lt;Required(ErrorMessage:="従業員番号は必須です")&gt;
    &lt;StringLength(10, ErrorMessage:="従業員番号は10文字以内で入力してください")&gt;
    &lt;Display(Name:="従業員番号")&gt;
    Public Property EmployeeNumber As String

    &lt;Required(ErrorMessage:="名前は必須です")&gt;
    &lt;StringLength(100, ErrorMessage:="名前は100文字以内で入力してください")&gt;
    &lt;Display(Name:="氏名")&gt;
    Public Property FullName As String

    &lt;Required(ErrorMessage:="名前（カナ）は必須です")&gt;
    &lt;StringLength(100, ErrorMessage:="名前（カナ）は100文字以内で入力してください")&gt;
    &lt;Display(Name:="氏名（カナ）")&gt;
    &lt;RegularExpression("^[ァ-ヶー　]*$", ErrorMessage:="全角カタカナで入力してください")&gt;
    Public Property FullNameKana As String

    &lt;Required(ErrorMessage:="メールアドレスは必須です")&gt;
    &lt;EmailAddress(ErrorMessage:="正しいメールアドレス形式で入力してください")&gt;
    &lt;Display(Name:="メールアドレス")&gt;
    Public Property Email As String

    &lt;Required(ErrorMessage:="部署は必須です")&gt;
    Public Property DepartmentId As Integer

    &lt;Required(ErrorMessage:="役職は必須です")&gt;
    Public Property PositionId As Integer

    &lt;Required(ErrorMessage:="入社日は必須です")&gt;
    &lt;Display(Name:="入社日")&gt;
    &lt;DataType(DataType.Date)&gt;
    Public Property HireDate As DateTime

    &lt;Display(Name:="電話番号")&gt;
    &lt;Phone(ErrorMessage:="正しい電話番号形式で入力してください")&gt;
    Public Property PhoneNumber As String

    &lt;Display(Name:="住所")&gt;
    &lt;StringLength(200, ErrorMessage:="住所は200文字以内で入力してください")&gt;
    Public Property Address As String

    &lt;Display(Name:="顔写真")&gt;
    Public Property PhotoFileName As String

    Public Property IsActive As Boolean = True

    Public Property CreatedAt As DateTime = DateTime.UtcNow
    Public Property UpdatedAt As DateTime = DateTime.UtcNow

    ' ナビゲーションプロパティ
    Public Property Department As Department
    Public Property Position As Position
End Class</code></pre>

                        <h6>部署エンティティ</h6>
                        <pre class="code-block"><code class="language-vbnet">' Models/Department.vb
&lt;Table("Departments")&gt;
Public Class Department
    &lt;Key&gt;
    Public Property Id As Integer

    &lt;Required&gt;
    &lt;StringLength(100)&gt;
    &lt;Display(Name:="部署名")&gt;
    Public Property Name As String

    &lt;StringLength(10)&gt;
    &lt;Display(Name:="部署コード")&gt;
    Public Property Code As String

    &lt;StringLength(500)&gt;
    &lt;Display(Name:="説明")&gt;
    Public Property Description As String

    Public Property IsActive As Boolean = True

    ' ナビゲーションプロパティ
    Public Property Employees As ICollection(Of Employee) = New List(Of Employee)()
End Class</code></pre>

                        <h6>役職エンティティ</h6>
                        <pre class="code-block"><code class="language-vbnet">' Models/Position.vb
&lt;Table("Positions")&gt;
Public Class Position
    &lt;Key&gt;
    Public Property Id As Integer

    &lt;Required&gt;
    &lt;StringLength(100)&gt;
    &lt;Display(Name:="役職名")&gt;
    Public Property Name As String

    &lt;Display(Name:="役職レベル")&gt;
    Public Property Level As Integer

    &lt;StringLength(500)&gt;
    &lt;Display(Name:="説明")&gt;
    Public Property Description As String

    Public Property IsActive As Boolean = True

    ' ナビゲーションプロパティ
    Public Property Employees As ICollection(Of Employee) = New List(Of Employee)()
End Class</code></pre>

                        <h6>DbContextの設定</h6>
                        <pre class="code-block"><code class="language-vbnet">' Data/ApplicationDbContext.vb
Public Class ApplicationDbContext
    Inherits IdentityDbContext(Of ApplicationUser)

    Public Sub New(options As DbContextOptions(Of ApplicationDbContext))
        MyBase.New(options)
    End Sub

    Public Property Employees As DbSet(Of Employee)
    Public Property Departments As DbSet(Of Department)
    Public Property Positions As DbSet(Of Position)

    Protected Overrides Sub OnModelCreating(modelBuilder As ModelBuilder)
        MyBase.OnModelCreating(modelBuilder)

        ' Employee エンティティ設定
        modelBuilder.Entity(Of Employee)(Sub(entity)
            entity.HasIndex(Function(e) e.EmployeeNumber).IsUnique()
            entity.HasIndex(Function(e) e.Email).IsUnique()
            
            entity.HasOne(Function(e) e.Department) _
                  .WithMany(Function(d) d.Employees) _
                  .HasForeignKey(Function(e) e.DepartmentId) _
                  .OnDelete(DeleteBehavior.Restrict)
                  
            entity.HasOne(Function(e) e.Position) _
                  .WithMany(Function(p) p.Employees) _
                  .HasForeignKey(Function(e) e.PositionId) _
                  .OnDelete(DeleteBehavior.Restrict)
        End Sub)

        ' 初期データの設定
        SeedData(modelBuilder)
    End Sub

    Private Sub SeedData(modelBuilder As ModelBuilder)
        ' 部署の初期データ
        modelBuilder.Entity(Of Department)().HasData(
            New Department With {.Id = 1, .Name = "総務部", .Code = "GA"},
            New Department With {.Id = 2, .Name = "営業部", .Code = "SA"},
            New Department With {.Id = 3, .Name = "開発部", .Code = "EN"},
            New Department With {.Id = 4, .Name = "人事部", .Code = "HR"}
        )

        ' 役職の初期データ
        modelBuilder.Entity(Of Position)().HasData(
            New Position With {.Id = 1, .Name = "部長", .Level = 5},
            New Position With {.Id = 2, .Name = "課長", .Level = 4},
            New Position With {.Id = 3, .Name = "主任", .Level = 3},
            New Position With {.Id = 4, .Name = "係長", .Level = 2},
            New Position With {.Id = 5, .Name = "一般", .Level = 1}
        )
    End Sub
End Class</code></pre>
                    </div>

                    <h3 class="section-title">10.3 サービス層の実装</h3>
                    <p>
                        ビジネスロジックを分離するため、サービス層を実装します。
                        これにより、コントローラーの責務を軽くし、テストしやすいコードを作成できます。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 10-2: 従業員サービスの実装</h5>
                        <p>従業員の業務処理を担当するサービスクラスを作成します。</p>

                        <h6>従業員サービスインターフェース</h6>
                        <pre class="code-block"><code class="language-vbnet">' Services/IEmployeeService.vb
Public Interface IEmployeeService
    Function GetEmployeesAsync(page As Integer, pageSize As Integer, searchTerm As String, departmentId As Integer?, positionId As Integer?) As Task(Of PagedResult(Of Employee))
    Function GetEmployeeByIdAsync(id As Integer) As Task(Of Employee)
    Function CreateEmployeeAsync(employee As Employee) As Task(Of ServiceResult)
    Function UpdateEmployeeAsync(employee As Employee) As Task(Of ServiceResult)
    Function DeleteEmployeeAsync(id As Integer) As Task(Of ServiceResult)
    Function GetDepartmentsAsync() As Task(Of List(Of Department))
    Function GetPositionsAsync() As Task(Of List(Of Position))
    Function SaveEmployeePhotoAsync(employeeId As Integer, photo As IFormFile) As Task(Of ServiceResult(Of String))
End Interface

' ViewModels/PagedResult.vb
Public Class PagedResult(Of T)
    Public Property Items As List(Of T)
    Public Property TotalCount As Integer
    Public Property PageNumber As Integer
    Public Property PageSize As Integer
    Public Property TotalPages As Integer

    Public ReadOnly Property HasPrevious As Boolean
        Get
            Return PageNumber > 1
        End Get
    End Property

    Public ReadOnly Property HasNext As Boolean
        Get
            Return PageNumber < TotalPages
        End Get
    End Property
End Class

' ViewModels/ServiceResult.vb
Public Class ServiceResult
    Public Property Success As Boolean
    Public Property Message As String
    Public Property Errors As List(Of String) = New List(Of String)()

    Public Shared Function CreateSuccess(Optional message As String = "") As ServiceResult
        Return New ServiceResult With {.Success = True, .Message = message}
    End Function

    Public Shared Function CreateFailure(message As String, Optional errors As List(Of String) = Nothing) As ServiceResult
        Return New ServiceResult With {
            .Success = False,
            .Message = message,
            .Errors = If(errors, New List(Of String)())
        }
    End Function
End Class

Public Class ServiceResult(Of T)
    Inherits ServiceResult
    Public Property Data As T

    Public Shared Shadows Function CreateSuccess(data As T, Optional message As String = "") As ServiceResult(Of T)
        Return New ServiceResult(Of T) With {.Success = True, .Data = data, .Message = message}
    End Function

    Public Shared Shadows Function CreateFailure(message As String, Optional errors As List(Of String) = Nothing) As ServiceResult(Of T)
        Return New ServiceResult(Of T) With {
            .Success = False,
            .Message = message,
            .Errors = If(errors, New List(Of String)())
        }
    End Function
End Class</code></pre>

                        <h6>従業員サービス実装</h6>
                        <pre class="code-block"><code class="language-vbnet">' Services/EmployeeService.vb
Imports Microsoft.EntityFrameworkCore
Imports Microsoft.Extensions.Caching.Memory
Imports Microsoft.Extensions.Logging

Public Class EmployeeService
    Implements IEmployeeService

    Private ReadOnly _context As ApplicationDbContext
    Private ReadOnly _cache As IMemoryCache
    Private ReadOnly _logger As ILogger(Of EmployeeService)
    Private ReadOnly _webHostEnvironment As IWebHostEnvironment

    Public Sub New(context As ApplicationDbContext, cache As IMemoryCache, 
                   logger As ILogger(Of EmployeeService), webHostEnvironment As IWebHostEnvironment)
        _context = context
        _cache = cache
        _logger = logger
        _webHostEnvironment = webHostEnvironment
    End Sub

    Public Async Function GetEmployeesAsync(page As Integer, pageSize As Integer, searchTerm As String, 
                                          departmentId As Integer?, positionId As Integer?) As Task(Of PagedResult(Of Employee)) Implements IEmployeeService.GetEmployeesAsync
        Try
            Dim query = _context.Employees.Include(Function(e) e.Department).Include(Function(e) e.Position).Where(Function(e) e.IsActive)

            ' 検索条件の適用
            If Not String.IsNullOrEmpty(searchTerm) Then
                query = query.Where(Function(e) e.FullName.Contains(searchTerm) OrElse 
                                              e.FullNameKana.Contains(searchTerm) OrElse 
                                              e.EmployeeNumber.Contains(searchTerm) OrElse 
                                              e.Email.Contains(searchTerm))
            End If

            If departmentId.HasValue AndAlso departmentId.Value > 0 Then
                query = query.Where(Function(e) e.DepartmentId = departmentId.Value)
            End If

            If positionId.HasValue AndAlso positionId.Value > 0 Then
                query = query.Where(Function(e) e.PositionId = positionId.Value)
            End If

            ' 総数取得
            Dim totalCount = Await query.CountAsync()

            ' ページング適用
            Dim employees = Await query.OrderBy(Function(e) e.EmployeeNumber) _
                                      .Skip((page - 1) * pageSize) _
                                      .Take(pageSize) _
                                      .ToListAsync()

            Return New PagedResult(Of Employee) With {
                .Items = employees,
                .TotalCount = totalCount,
                .PageNumber = page,
                .PageSize = pageSize,
                .TotalPages = Math.Ceiling(totalCount / CDbl(pageSize))
            }

        Catch ex As Exception
            _logger.LogError(ex, "従業員一覧取得中にエラーが発生しました")
            Return New PagedResult(Of Employee) With {.Items = New List(Of Employee)()}
        End Try
    End Function

    Public Async Function CreateEmployeeAsync(employee As Employee) As Task(Of ServiceResult) Implements IEmployeeService.CreateEmployeeAsync
        Try
            ' 重複チェック
            Dim existingByNumber = Await _context.Employees.FirstOrDefaultAsync(Function(e) e.EmployeeNumber = employee.EmployeeNumber)
            If existingByNumber IsNot Nothing Then
                Return ServiceResult.CreateFailure("この従業員番号は既に使用されています。")
            End If

            Dim existingByEmail = Await _context.Employees.FirstOrDefaultAsync(Function(e) e.Email = employee.Email)
            If existingByEmail IsNot Nothing Then
                Return ServiceResult.CreateFailure("このメールアドレスは既に使用されています。")
            End If

            employee.CreatedAt = DateTime.UtcNow
            employee.UpdatedAt = DateTime.UtcNow

            _context.Employees.Add(employee)
            Await _context.SaveChangesAsync()

            _logger.LogInformation($"従業員が登録されました: {employee.EmployeeNumber} - {employee.FullName}")
            Return ServiceResult.CreateSuccess("従業員が正常に登録されました。")

        Catch ex As Exception
            _logger.LogError(ex, "従業員登録中にエラーが発生しました")
            Return ServiceResult.CreateFailure("従業員の登録中にエラーが発生しました。")
        End Try
    End Function

    Public Async Function SaveEmployeePhotoAsync(employeeId As Integer, photo As IFormFile) As Task(Of ServiceResult(Of String)) Implements IEmployeeService.SaveEmployeePhotoAsync
        Try
            If photo Is Nothing OrElse photo.Length = 0 Then
                Return ServiceResult(Of String).CreateFailure("ファイルが選択されていません。")
            End If

            ' ファイル拡張子チェック
            Dim allowedExtensions = {".jpg", ".jpeg", ".png", ".gif"}
            Dim extension = Path.GetExtension(photo.FileName).ToLowerInvariant()
            If Not allowedExtensions.Contains(extension) Then
                Return ServiceResult(Of String).CreateFailure("サポートされていないファイル形式です。JPG、PNG、GIFファイルのみアップロード可能です。")
            End If

            ' ファイルサイズチェック（5MB以下）
            If photo.Length > 5 * 1024 * 1024 Then
                Return ServiceResult(Of String).CreateFailure("ファイルサイズが大きすぎます。5MB以下のファイルを選択してください。")
            End If

            ' 保存ディレクトリの作成
            Dim uploadsPath = Path.Combine(_webHostEnvironment.WebRootPath, "uploads", "photos")
            If Not Directory.Exists(uploadsPath) Then
                Directory.CreateDirectory(uploadsPath)
            End If

            ' ファイル名の生成（重複回避）
            Dim fileName = $"{employeeId}_{Guid.NewGuid()}{extension}"
            Dim filePath = Path.Combine(uploadsPath, fileName)

            ' ファイル保存
            Using stream = New FileStream(filePath, FileMode.Create)
                Await photo.CopyToAsync(stream)
            End Using

            ' データベース更新
            Dim employee = Await _context.Employees.FindAsync(employeeId)
            If employee IsNot Nothing Then
                ' 古いファイルの削除
                If Not String.IsNullOrEmpty(employee.PhotoFileName) Then
                    Dim oldFilePath = Path.Combine(uploadsPath, employee.PhotoFileName)
                    If File.Exists(oldFilePath) Then
                        File.Delete(oldFilePath)
                    End If
                End If

                employee.PhotoFileName = fileName
                employee.UpdatedAt = DateTime.UtcNow
                Await _context.SaveChangesAsync()
            End If

            Return ServiceResult(Of String).CreateSuccess(fileName, "写真がアップロードされました。")

        Catch ex As Exception
            _logger.LogError(ex, "ファイルアップロード中にエラーが発生しました")
            Return ServiceResult(Of String).CreateFailure("ファイルのアップロード中にエラーが発生しました。")
        End Try
    End Function

    Public Async Function GetDepartmentsAsync() As Task(Of List(Of Department)) Implements IEmployeeService.GetDepartmentsAsync
        Return Await _cache.GetOrCreateAsync("departments", Async Function(entry)
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(30)
            Return Await _context.Departments.Where(Function(d) d.IsActive).OrderBy(Function(d) d.Name).ToListAsync()
        End Function)
    End Function

    Public Async Function GetPositionsAsync() As Task(Of List(Of Position)) Implements IEmployeeService.GetPositionsAsync
        Return Await _cache.GetOrCreateAsync("positions", Async Function(entry)
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(30)
            Return Await _context.Positions.Where(Function(p) p.IsActive).OrderBy(Function(p) p.Level).ThenBy(Function(p) p.Name).ToListAsync()
        End Function)
    End Function

    ' その他のメソッド実装...
End Class</code></pre>
                    </div>

                    <h3 class="section-title">10.4 コントローラーとビューの実装</h3>
                    <p>
                        ユーザーインターフェースを構築します。Bootstrap 5を使用してレスポンシブデザインを実装し、
                        優れたユーザビリティを提供します。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 10-3: 従業員管理コントローラーの実装</h5>
                        <p>CRUD操作、ページング、検索機能を持つコントローラーを作成します。</p>

                        <h6>従業員コントローラー</h6>
                        <pre class="code-block"><code class="language-vbnet">' Controllers/EmployeesController.vb
&lt;Authorize&gt;
Public Class EmployeesController
    Inherits Controller

    Private ReadOnly _employeeService As IEmployeeService
    Private ReadOnly _logger As ILogger(Of EmployeesController)

    Public Sub New(employeeService As IEmployeeService, logger As ILogger(Of EmployeesController))
        _employeeService = employeeService
        _logger = logger
    End Sub

    ' GET: Employees
    Public Async Function Index(page As Integer = 1, pageSize As Integer = 10, 
                               searchTerm As String = "", departmentId As Integer? = Nothing, 
                               positionId As Integer? = Nothing) As Task(Of IActionResult)
        
        ' ページサイズの制限
        If pageSize < 5 Then pageSize = 5
        If pageSize > 100 Then pageSize = 100

        Dim result = Await _employeeService.GetEmployeesAsync(page, pageSize, searchTerm, departmentId, positionId)
        
        ' ViewBagに検索条件とドロップダウンデータを設定
        ViewBag.CurrentSearchTerm = searchTerm
        ViewBag.CurrentDepartmentId = departmentId
        ViewBag.CurrentPositionId = positionId
        ViewBag.PageSize = pageSize
        
        ViewBag.Departments = Await _employeeService.GetDepartmentsAsync()
        ViewBag.Positions = Await _employeeService.GetPositionsAsync()

        Return View(result)
    End Function

    ' GET: Employees/Details/5
    Public Async Function Details(id As Integer) As Task(Of IActionResult)
        Dim employee = Await _employeeService.GetEmployeeByIdAsync(id)
        If employee Is Nothing Then
            Return NotFound()
        End If
        Return View(employee)
    End Function

    ' GET: Employees/Create
    &lt;Authorize(Roles:="Admin,HR")&gt;
    Public Async Function Create() As Task(Of IActionResult)
        ViewBag.Departments = New SelectList(Await _employeeService.GetDepartmentsAsync(), "Id", "Name")
        ViewBag.Positions = New SelectList(Await _employeeService.GetPositionsAsync(), "Id", "Name")
        Return View()
    End Function

    ' POST: Employees/Create
    &lt;HttpPost&gt;
    &lt;ValidateAntiForgeryToken&gt;
    &lt;Authorize(Roles:="Admin,HR")&gt;
    Public Async Function Create(employee As Employee) As Task(Of IActionResult)
        If ModelState.IsValid Then
            Dim result = Await _employeeService.CreateEmployeeAsync(employee)
            
            If result.Success Then
                TempData("SuccessMessage") = result.Message
                Return RedirectToAction(NameOf(Index))
            Else
                For Each errorMsg In result.Errors
                    ModelState.AddModelError("", errorMsg)
                Next
                ModelState.AddModelError("", result.Message)
            End If
        End If

        ViewBag.Departments = New SelectList(Await _employeeService.GetDepartmentsAsync(), "Id", "Name", employee.DepartmentId)
        ViewBag.Positions = New SelectList(Await _employeeService.GetPositionsAsync(), "Id", "Name", employee.PositionId)
        Return View(employee)
    End Function

    ' POST: Employees/UploadPhoto/5
    &lt;HttpPost&gt;
    &lt;ValidateAntiForgeryToken&gt;
    &lt;Authorize(Roles:="Admin,HR")&gt;
    Public Async Function UploadPhoto(id As Integer, photo As IFormFile) As Task(Of IActionResult)
        Dim result = Await _employeeService.SaveEmployeePhotoAsync(id, photo)
        
        If result.Success Then
            TempData("SuccessMessage") = result.Message
        Else
            TempData("ErrorMessage") = result.Message
        End If

        Return RedirectToAction(NameOf(Details), New With {.id = id})
    End Function

    ' AJAX: 従業員検索
    &lt;HttpGet&gt;
    Public Async Function SearchEmployees(searchTerm As String) As Task(Of JsonResult)
        If String.IsNullOrEmpty(searchTerm) OrElse searchTerm.Length < 2 Then
            Return Json(New List(Of Object)())
        End If

        Dim result = Await _employeeService.GetEmployeesAsync(1, 10, searchTerm, Nothing, Nothing)
        Dim employees = result.Items.Select(Function(e) New With {
            .id = e.Id,
            .employeeNumber = e.EmployeeNumber,
            .fullName = e.FullName,
            .department = e.Department?.Name,
            .position = e.Position?.Name
        })

        Return Json(employees)
    End Function
End Class</code></pre>

                        <h6>従業員一覧ビュー</h6>
                        <pre class="code-block"><code class="language-html">&lt;!-- Views/Employees/Index.cshtml --&gt;
@ModelType PagedResult(Of Employee)

@{
    ViewData("Title") = "従業員一覧"
}

&lt;div class="d-flex justify-content-between align-items-center mb-4"&gt;
    &lt;h2&gt;&lt;i class="fas fa-users"&gt;&lt;/i&gt; 従業員一覧&lt;/h2&gt;
    @If User.IsInRole("Admin") OrElse User.IsInRole("HR") Then
        &lt;a asp-action="Create" class="btn btn-primary"&gt;
            &lt;i class="fas fa-plus"&gt;&lt;/i&gt; 新規登録
        &lt;/a&gt;
    End If
&lt;/div&gt;

&lt;!-- 検索フォーム --&gt;
&lt;div class="card mb-4"&gt;
    &lt;div class="card-body"&gt;
        &lt;form method="get" class="row g-3"&gt;
            &lt;div class="col-md-4"&gt;
                &lt;label for="searchTerm" class="form-label"&gt;検索キーワード&lt;/label&gt;
                &lt;input type="text" class="form-control" id="searchTerm" name="searchTerm" 
                       value="@ViewBag.CurrentSearchTerm" placeholder="名前、従業員番号、メール"&gt;
            &lt;/div&gt;
            &lt;div class="col-md-3"&gt;
                &lt;label for="departmentId" class="form-label"&gt;部署&lt;/label&gt;
                &lt;select class="form-select" id="departmentId" name="departmentId"&gt;
                    &lt;option value=""&gt;すべて&lt;/option&gt;
                    @For Each dept In ViewBag.Departments
                        &lt;option value="@dept.Id" @(If(ViewBag.CurrentDepartmentId = dept.Id, "selected", ""))&gt;
                            @dept.Name
                        &lt;/option&gt;
                    Next
                &lt;/select&gt;
            &lt;/div&gt;
            &lt;div class="col-md-3"&gt;
                &lt;label for="positionId" class="form-label"&gt;役職&lt;/label&gt;
                &lt;select class="form-select" id="positionId" name="positionId"&gt;
                    &lt;option value=""&gt;すべて&lt;/option&gt;
                    @For Each pos In ViewBag.Positions
                        &lt;option value="@pos.Id" @(If(ViewBag.CurrentPositionId = pos.Id, "selected", ""))&gt;
                            @pos.Name
                        &lt;/option&gt;
                    Next
                &lt;/select&gt;
            &lt;/div&gt;
            &lt;div class="col-md-2 d-flex align-items-end"&gt;
                &lt;button type="submit" class="btn btn-outline-secondary w-100"&gt;
                    &lt;i class="fas fa-search"&gt;&lt;/i&gt; 検索
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- 結果表示 --&gt;
&lt;div class="card"&gt;
    &lt;div class="card-header d-flex justify-content-between align-items-center"&gt;
        &lt;span&gt;検索結果: @Model.TotalCount 件&lt;/span&gt;
        &lt;div class="dropdown"&gt;
            &lt;button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"&gt;
                表示件数: @ViewBag.PageSize
            &lt;/button&gt;
            &lt;ul class="dropdown-menu"&gt;
                &lt;li&gt;&lt;a class="dropdown-item" href="?pageSize=10&amp;searchTerm=@ViewBag.CurrentSearchTerm&amp;departmentId=@ViewBag.CurrentDepartmentId&amp;positionId=@ViewBag.CurrentPositionId"&gt;10件&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a class="dropdown-item" href="?pageSize=25&amp;searchTerm=@ViewBag.CurrentSearchTerm&amp;departmentId=@ViewBag.CurrentDepartmentId&amp;positionId=@ViewBag.CurrentPositionId"&gt;25件&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a class="dropdown-item" href="?pageSize=50&amp;searchTerm=@ViewBag.CurrentSearchTerm&amp;departmentId=@ViewBag.CurrentDepartmentId&amp;positionId=@ViewBag.CurrentPositionId"&gt;50件&lt;/a&gt;&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="table-responsive"&gt;
        &lt;table class="table table-hover"&gt;
            &lt;thead class="table-light"&gt;
                &lt;tr&gt;
                    &lt;th&gt;写真&lt;/th&gt;
                    &lt;th&gt;従業員番号&lt;/th&gt;
                    &lt;th&gt;氏名&lt;/th&gt;
                    &lt;th&gt;部署&lt;/th&gt;
                    &lt;th&gt;役職&lt;/th&gt;
                    &lt;th&gt;メールアドレス&lt;/th&gt;
                    &lt;th&gt;入社日&lt;/th&gt;
                    &lt;th&gt;操作&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
                @For Each employee In Model.Items
                    &lt;tr&gt;
                        &lt;td&gt;
                            @If Not String.IsNullOrEmpty(employee.PhotoFileName) Then
                                &lt;img src="~/uploads/photos/@employee.PhotoFileName" 
                                     alt="@employee.FullName" class="rounded-circle" 
                                     style="width: 40px; height: 40px; object-fit: cover;"&gt;
                            Else
                                &lt;div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px; color: white;"&gt;
                                    &lt;i class="fas fa-user"&gt;&lt;/i&gt;
                                &lt;/div&gt;
                            End If
                        &lt;/td&gt;
                        &lt;td&gt;@employee.EmployeeNumber&lt;/td&gt;
                        &lt;td&gt;
                            &lt;div&gt;@employee.FullName&lt;/div&gt;
                            &lt;small class="text-muted"&gt;@employee.FullNameKana&lt;/small&gt;
                        &lt;/td&gt;
                        &lt;td&gt;@employee.Department?.Name&lt;/td&gt;
                        &lt;td&gt;@employee.Position?.Name&lt;/td&gt;
                        &lt;td&gt;&lt;a href="mailto:@employee.Email"&gt;@employee.Email&lt;/a&gt;&lt;/td&gt;
                        &lt;td&gt;@employee.HireDate.ToString("yyyy/MM/dd")&lt;/td&gt;
                        &lt;td&gt;
                            &lt;div class="btn-group" role="group"&gt;
                                &lt;a asp-action="Details" asp-route-id="@employee.Id" 
                                   class="btn btn-sm btn-outline-info"&gt;
                                    &lt;i class="fas fa-eye"&gt;&lt;/i&gt;
                                &lt;/a&gt;
                                @If User.IsInRole("Admin") OrElse User.IsInRole("HR") Then
                                    &lt;a asp-action="Edit" asp-route-id="@employee.Id" 
                                       class="btn btn-sm btn-outline-warning"&gt;
                                        &lt;i class="fas fa-edit"&gt;&lt;/i&gt;
                                    &lt;/a&gt;
                                End If
                                @If User.IsInRole("Admin") Then
                                    &lt;button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="confirmDelete(@employee.Id, '@employee.FullName')"&gt;
                                        &lt;i class="fas fa-trash"&gt;&lt;/i&gt;
                                    &lt;/button&gt;
                                End If
                            &lt;/div&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                Next
            &lt;/tbody&gt;
        &lt;/table&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- ページネーション --&gt;
@If Model.TotalPages > 1 Then
    &lt;nav aria-label="従業員一覧ページネーション" class="mt-4"&gt;
        &lt;ul class="pagination justify-content-center"&gt;
            @If Model.HasPrevious Then
                &lt;li class="page-item"&gt;
                    &lt;a class="page-link" href="?page=@(Model.PageNumber - 1)&amp;pageSize=@ViewBag.PageSize&amp;searchTerm=@ViewBag.CurrentSearchTerm&amp;departmentId=@ViewBag.CurrentDepartmentId&amp;positionId=@ViewBag.CurrentPositionId"&gt;前へ&lt;/a&gt;
                &lt;/li&gt;
            End If
            
            @For pageNum = Math.Max(1, Model.PageNumber - 2) To Math.Min(Model.TotalPages, Model.PageNumber + 2)
                &lt;li class="page-item @(If(pageNum = Model.PageNumber, "active", ""))"&gt;
                    &lt;a class="page-link" href="?page=@pageNum&amp;pageSize=@ViewBag.PageSize&amp;searchTerm=@ViewBag.CurrentSearchTerm&amp;departmentId=@ViewBag.CurrentDepartmentId&amp;positionId=@ViewBag.CurrentPositionId"&gt;@pageNum&lt;/a&gt;
                &lt;/li&gt;
            Next
            
            @If Model.HasNext Then
                &lt;li class="page-item"&gt;
                    &lt;a class="page-link" href="?page=@(Model.PageNumber + 1)&amp;pageSize=@ViewBag.PageSize&amp;searchTerm=@ViewBag.CurrentSearchTerm&amp;departmentId=@ViewBag.CurrentDepartmentId&amp;positionId=@ViewBag.CurrentPositionId"&gt;次へ&lt;/a&gt;
                &lt;/li&gt;
            End If
        &lt;/ul&gt;
    &lt;/nav&gt;
End If</code></pre>
                    </div>

                    <h3 class="section-title">10.5 エラーハンドリングとログ記録</h3>
                    <p>
                        本格的なWebアプリケーションには、適切なエラーハンドリングとログ記録が不可欠です。
                        ユーザビリティとシステムの保守性を向上させます。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 10-4: グローバル例外処理とログ記録の実装</h5>
                        <p>包括的なエラーハンドリング機能を実装します。</p>

                        <h6>カスタム例外ミドルウェア</h6>
                        <pre class="code-block"><code class="language-vbnet">' Middleware/GlobalExceptionMiddleware.vb
Public Class GlobalExceptionMiddleware
    Private ReadOnly _next As RequestDelegate
    Private ReadOnly _logger As ILogger(Of GlobalExceptionMiddleware)
    Private ReadOnly _environment As IWebHostEnvironment

    Public Sub New(nextMiddleware As RequestDelegate, logger As ILogger(Of GlobalExceptionMiddleware), environment As IWebHostEnvironment)
        _next = nextMiddleware
        _logger = logger
        _environment = environment
    End Sub

    Public Async Function InvokeAsync(context As HttpContext) As Task
        Try
            Await _next(context)
        Catch ex As Exception
            _logger.LogError(ex, "予期しないエラーが発生しました。URL: {Url}", context.Request.Path)
            Await HandleExceptionAsync(context, ex)
        End Try
    End Function

    Private Async Function HandleExceptionAsync(context As HttpContext, ex As Exception) As Task
        context.Response.ContentType = "text/html"
        
        Dim errorViewModel = New ErrorViewModel()
        Dim viewPath As String
        
        Select Case ex.GetType()
            Case GetType(UnauthorizedAccessException)
                context.Response.StatusCode = StatusCodes.Status401Unauthorized
                errorViewModel.Title = "アクセス権限がありません"
                errorViewModel.Message = "このページにアクセスする権限がありません。"
                viewPath = "/Views/Error/401.cshtml"
                
            Case GetType(ArgumentException), GetType(InvalidOperationException)
                context.Response.StatusCode = StatusCodes.Status400BadRequest
                errorViewModel.Title = "不正なリクエストです"
                errorViewModel.Message = "リクエストの内容に問題があります。"
                viewPath = "/Views/Error/400.cshtml"
                
            Case Else
                context.Response.StatusCode = StatusCodes.Status500InternalServerError
                errorViewModel.Title = "内部サーバーエラー"
                errorViewModel.Message = "申し訳ございません。システムエラーが発生しました。"
                viewPath = "/Views/Error/500.cshtml"
        End Select

        If _environment.IsDevelopment() Then
            errorViewModel.Details = ex.ToString()
        End If
        
        errorViewModel.RequestId = Activity.Current?.Id ?? context.TraceIdentifier

        ' エラーページの生成（簡略化）
        Dim html = $"
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;{errorViewModel.Title}&lt;/title&gt;
            &lt;link href=""https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"" rel=""stylesheet""&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;div class=""container mt-5""&gt;
                &lt;div class=""row justify-content-center""&gt;
                    &lt;div class=""col-md-6""&gt;
                        &lt;div class=""text-center""&gt;
                            &lt;h1 class=""display-4 text-danger""&gt;{context.Response.StatusCode}&lt;/h1&gt;
                            &lt;h2&gt;{errorViewModel.Title}&lt;/h2&gt;
                            &lt;p class=""lead""&gt;{errorViewModel.Message}&lt;/p&gt;
                            &lt;a href=""/"" class=""btn btn-primary""&gt;ホームに戻る&lt;/a&gt;
                        &lt;/div&gt;
                        {If(errorViewModel.Details IsNot Nothing, $"&lt;details class=""mt-4""&gt;&lt;summary&gt;詳細&lt;/summary&gt;&lt;pre&gt;{errorViewModel.Details}&lt;/pre&gt;&lt;/details&gt;", "")}
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/body&gt;
        &lt;/html&gt;"
        
        Await context.Response.WriteAsync(html)
    End Function
End Class

' ViewModels/ErrorViewModel.vb
Public Class ErrorViewModel
    Public Property RequestId As String
    Public Property Title As String
    Public Property Message As String
    Public Property Details As String

    Public ReadOnly Property ShowRequestId As Boolean
        Get
            Return Not String.IsNullOrEmpty(RequestId)
        End Get
    End Property
End Class</code></pre>

                        <h6>構造化ログ記録の設定</h6>
                        <pre class="code-block"><code class="language-vbnet">' Program.vb または Startup.vb
' ログ記録の設定
builder.Services.AddLogging(Sub(logging)
    logging.ClearProviders()
    logging.AddConsole()
    logging.AddDebug()
    
    ' 本番環境では外部ログサービス（例：Serilog）を使用
    If builder.Environment.IsProduction() Then
        logging.AddEventLog()
    End If
End Sub)

' アプリケーション設定でのログレベル設定
' appsettings.json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  }
}</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>この章で実装した従業員管理システムの主要機能を5つ挙げてください。</li>
                            <li>サービス層を導入することの利点を3つ説明してください。</li>
                            <li>ページング機能を実装する際に考慮すべき点は何ですか？</li>
                            <li>ファイルアップロード機能でセキュリティ上注意すべき点を3つ挙げてください。</li>
                            <li>グローバル例外処理を実装する利点は何ですか？</li>
                        </ol>
                        
                        <div class="mt-3">
                            <strong>解答例：</strong>
                            <ol>
                                <li>CRUD操作、検索・フィルタリング、ページング、ファイルアップロード、権限管理</li>
                                <li>ビジネスロジックの分離、テスタビリティ向上、コードの再利用性向上</li>
                                <li>パフォーマンス、ユーザビリティ、メモリ使用量、データベース負荷</li>
                                <li>ファイル拡張子チェック、ファイルサイズ制限、アップロードパスの制限</li>
                                <li>統一的なエラー処理、ログ記録、ユーザビリティ向上、保守性向上</li>
                            </ol>
                        </div>
                    </div>

                    <div class="highlight">
                        <h5>学習完了おめでとうございます！</h5>
                        <p>
                            この10章の学習を通じて、ASP.NET Core (VB.NET)を使用した本格的なWebアプリケーション開発のスキルを身につけました。
                            学んだ技術を組み合わせることで、実務レベルのアプリケーションを構築できるようになりました。
                        </p>
                        <p><strong>次のステップとして以下を推奨します：</strong></p>
                        <ul>
                            <li>Blazor Server/WebAssemblyによるSPA開発</li>
                            <li>Docker コンテナ化とクラウドデプロイメント</li>
                            <li>マイクロサービスアーキテクチャの設計</li>
                            <li>gRPCやSignalRを使用したリアルタイム通信</li>
                            <li>パフォーマンス最適化とスケーラビリティ向上</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnetcore-vb-learning-material-9.html" class="btn btn-secondary">← 第9章: 状態管理とキャッシング</a>
                        <a href="../README.html" class="btn btn-success">学習完了 - 目次に戻る</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 F-Circle All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>