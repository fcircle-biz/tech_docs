<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET Core (VB.NET)学習教材 第9章 - 状態管理とキャッシング</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #663399;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #663399;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #663399;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #8e44ad;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #f8f4fc;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #663399;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #663399 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>ASP.NET Core (VB.NET)学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-1.html">第1章: ASP.NET Core入門と開発環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-2.html">第2章: MVCアーキテクチャの基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-3.html">第3章: Razorビューとレイアウト</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-4.html">第4章: モデルバインディングとバリデーション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-5.html">第5章: 依存性注入とミドルウェア</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-6.html">第6章: Entity Framework Coreとデータアクセス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-7.html">第7章: Web APIの開発</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-8.html">第8章: 認証と認可</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aspnetcore-vb-learning-material-9.html">第9章: 状態管理とキャッシング</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-10.html">第10章: 実践的なWebアプリケーション開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第9章: 状態管理とキャッシング</h1>
                </div>

                <div id="chapter9">
                    <h2 class="chapter-title">効率的なデータ管理とパフォーマンス向上</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>ASP.NET Coreの状態管理オプションとその適用場面</li>
                            <li>セッション管理の実装と設定方法</li>
                            <li>TempData、ViewData、ViewBagの特徴と使い分け</li>
                            <li>メモリキャッシュによるパフォーマンス最適化</li>
                            <li>分散キャッシュの概念と実装</li>
                            <li>レスポンスキャッシングとCDN活用</li>
                        </ul>
                    </div>

                    <h3 class="section-title">9.1 状態管理の基本概念</h3>
                    <p>
                        HTTPプロトコルはステートレス（状態を保持しない）なプロトコルです。
                        しかし、Webアプリケーションでは、ユーザーの状態や情報を一連のリクエスト間で保持する必要があります。
                        ASP.NET Coreは、様々な状態管理の仕組みを提供しています。
                    </p>

                    <div class="mermaid">
                        graph TD
                            A["状態管理方式"] --> B["クライアント側"]
                            A --> C["サーバー側"]
                            
                            B --> D["Cookie"]
                            B --> E["Hidden Field"]
                            B --> F["Query String"]
                            B --> G["Local Storage"]
                            
                            C --> H["Session"]
                            C --> I["TempData"]
                            C --> J["ViewData/ViewBag"]
                            C --> K["Application State"]
                            C --> L["Database"]
                    </div>

                    <p><strong>状態管理方式の比較：</strong></p>
                    <ul>
                        <li><strong>セッション：</strong>サーバー側でユーザー固有の情報を複数リクエストに跨って保持</li>
                        <li><strong>TempData：</strong>リダイレクト後の次のリクエストまで一時的にデータを保持</li>
                        <li><strong>ViewData/ViewBag：</strong>コントローラーからビューへの単発データ転送</li>
                        <li><strong>Cookie：</strong>クライアント側で小さなデータを永続保持</li>
                    </ul>

                    <h3 class="section-title">9.2 セッション管理</h3>
                    <p>
                        セッションは、Webアプリケーションで最も一般的に使用される状態管理方式です。
                        サーバー側でユーザーごとの情報を保持し、セッションIDを通じてクライアントと関連付けます。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 9-1: セッションの基本設定と使用</h5>
                        <p>ショッピングカート機能を例に、セッション管理を実装します。</p>
                        
                        <h6>手順1: セッションサービスの設定</h6>
                        <pre class="code-block"><code class="language-vbnet">' Startup.vb のConfigureServicesメソッド
Public Sub ConfigureServices(services As IServiceCollection)
    services.AddControllersWithViews()
    
    ' セッション機能の追加
    services.AddSession(Sub(options)
        options.IdleTimeout = TimeSpan.FromMinutes(30) ' セッション有効期限
        options.Cookie.HttpOnly = True ' XSS攻撃の防御
        options.Cookie.IsEssential = True ' GDPR対応
        options.Cookie.Name = "MyApp.Session"
        options.Cookie.SecurePolicy = CookieSecurePolicy.Always ' HTTPS必須
    End Sub)
    
    ' メモリ内分散キャッシュ（セッション用）
    services.AddDistributedMemoryCache()
End Sub

' Configureメソッド
Public Sub Configure(app As IApplicationBuilder, env As IWebHostEnvironment)
    If env.IsDevelopment() Then
        app.UseDeveloperExceptionPage()
    End If
    
    app.UseHttpsRedirection()
    app.UseStaticFiles()
    app.UseRouting()
    
    ' セッションミドルウェアの有効化（認証より前に配置）
    app.UseSession()
    
    app.UseAuthentication()
    app.UseAuthorization()
    
    app.UseEndpoints(Sub(endpoints)
        endpoints.MapControllerRoute("default", "{controller=Home}/{action=Index}/{id?}")
    End Sub)
End Sub</code></pre>

                        <h6>手順2: セッションを使用するコントローラー</h6>
                        <pre class="code-block"><code class="language-vbnet">' Controllers/CartController.vb
Imports Microsoft.AspNetCore.Http
Imports System.Text.Json

Public Class CartController
    Inherits Controller

    Private Const CartSessionKey As String = "CartItems"

    Public Function Index() As IActionResult
        Dim cartItems = GetCartItems()
        Return View(cartItems)
    End Function

    ' 商品をカートに追加
    Public Function AddToCart(productId As Integer, productName As String, price As Decimal) As IActionResult
        Dim cartItems = GetCartItems()
        
        Dim existingItem = cartItems.FirstOrDefault(Function(item) item.ProductId = productId)
        If existingItem IsNot Nothing Then
            existingItem.Quantity += 1
        Else
            cartItems.Add(New CartItem With {
                .ProductId = productId,
                .ProductName = productName,
                .Price = price,
                .Quantity = 1
            })
        End If
        
        SaveCartItems(cartItems)
        TempData("Message") = $"{productName}をカートに追加しました。"
        
        Return RedirectToAction("Index")
    End Function

    ' セッションからカート情報を取得
    Private Function GetCartItems() As List(Of CartItem)
        Dim cartJson = HttpContext.Session.GetString(CartSessionKey)
        If String.IsNullOrEmpty(cartJson) Then
            Return New List(Of CartItem)()
        End If
        
        Return JsonSerializer.Deserialize(Of List(Of CartItem))(cartJson)
    End Function

    ' セッションにカート情報を保存
    Private Sub SaveCartItems(cartItems As List(Of CartItem))
        Dim cartJson = JsonSerializer.Serialize(cartItems)
        HttpContext.Session.SetString(CartSessionKey, cartJson)
    End Sub
End Class

' Models/CartItem.vb
Public Class CartItem
    Public Property ProductId As Integer
    Public Property ProductName As String
    Public Property Price As Decimal
    Public Property Quantity As Integer
    
    Public ReadOnly Property Total As Decimal
        Get
            Return Price * Quantity
        End Get
    End Property
End Class</code></pre>

                        <h6>手順3: セッション拡張メソッドの作成</h6>
                        <pre class="code-block"><code class="language-vbnet">' Extensions/SessionExtensions.vb
Imports Microsoft.AspNetCore.Http
Imports System.Text.Json

Public Module SessionExtensions
    ' オブジェクトの保存
    &lt;Extension&gt;
    Public Sub SetObject(Of T)(session As ISession, key As String, value As T)
        Dim json = JsonSerializer.Serialize(value)
        session.SetString(key, json)
    End Sub

    ' オブジェクトの取得
    &lt;Extension&gt;
    Public Function GetObject(Of T)(session As ISession, key As String) As T
        Dim json = session.GetString(key)
        If String.IsNullOrEmpty(json) Then
            Return Nothing
        End If
        Return JsonSerializer.Deserialize(Of T)(json)
    End Function

    ' 整数値の保存・取得
    &lt;Extension&gt;
    Public Sub SetInt32(session As ISession, key As String, value As Integer)
        Dim bytes = BitConverter.GetBytes(value)
        session.Set(key, bytes)
    End Sub

    &lt;Extension&gt;
    Public Function GetInt32(session As ISession, key As String) As Integer?
        Dim bytes = session.Get(key)
        If bytes Is Nothing Then
            Return Nothing
        End If
        Return BitConverter.ToInt32(bytes, 0)
    End Function
End Module</code></pre>

                        <h6>期待される結果</h6>
                        <p>
                            ユーザーがカートに商品を追加すると、セッションに保存され、
                            ブラウザを閉じるまで（またはセッション期限まで）カート内容が保持されます。
                        </p>
                    </div>

                    <h3 class="section-title">9.3 TempData、ViewData、ViewBag</h3>
                    <p>
                        これらは、コントローラーからビューへデータを渡すための仕組みです。
                        それぞれ異なる特徴と適用場面があります。
                    </p>

                    <div class="mermaid">
                        graph LR
                            A["Controller"] --> B["TempData<br/>（次のリクエストまで保持）"]
                            A --> C["ViewData<br/>（現在のリクエストのみ）"]
                            A --> D["ViewBag<br/>（現在のリクエストのみ）"]
                            
                            B --> E["View<br/>（リダイレクト後）"]
                            C --> F["View<br/>（同一リクエスト）"]
                            D --> F
                    </div>

                    <div class="exercise-container">
                        <h5>実習 9-2: データ転送方式の実装と比較</h5>
                        <p>各データ転送方式の特徴を実際のコードで確認します。</p>

                        <h6>コントローラーでのデータ設定</h6>
                        <pre class="code-block"><code class="language-vbnet">' Controllers/DataTransferController.vb
Public Class DataTransferController
    Inherits Controller

    Public Function Index() As IActionResult
        ' ViewData：Dictionary型、型安全ではない
        ViewData("CurrentTime") = DateTime.Now
        ViewData("UserCount") = 125
        ViewData("IsLoggedIn") = True

        ' ViewBag：dynamic型、型安全ではない（IntelliSenseが効かない）
        ViewBag.AppName = "データ転送デモ"
        ViewBag.Version = "1.0.0"
        ViewBag.Categories = New String() {"技術", "ビジネス", "趣味"}

        ' TempData：次のリクエストまで保持される
        TempData("InfoMessage") = "データが正常に読み込まれました。"
        TempData("ProcessedCount") = 50

        Return View()
    End Function

    Public Function ProcessData() As IActionResult
        ' データ処理のシミュレーション
        System.Threading.Thread.Sleep(1000)

        ' TempData：成功メッセージを設定してリダイレクト
        TempData("SuccessMessage") = "データ処理が完了しました。"
        TempData("ProcessedAt") = DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss")
        
        ' Keep()メソッドでTempDataを次のリクエストでも保持
        TempData.Keep("InfoMessage")

        Return RedirectToAction("Result")
    End Function

    Public Function Result() As IActionResult
        ' TempDataから値を取得（自動的にクリアされる）
        Dim successMessage = TempData("SuccessMessage")?.ToString()
        Dim processedAt = TempData("ProcessedAt")?.ToString()
        
        ' Peek()メソッドで値を取得するがクリアしない
        Dim infoMessage = TempData.Peek("InfoMessage")?.ToString()

        ViewBag.SuccessMessage = successMessage
        ViewBag.ProcessedAt = processedAt
        ViewBag.InfoMessage = infoMessage

        Return View()
    End Function
End Class</code></pre>

                        <h6>型安全なTempDataヘルパーの作成</h6>
                        <pre class="code-block"><code class="language-vbnet">' Helpers/TempDataHelper.vb
Imports Microsoft.AspNetCore.Mvc

Public Module TempDataHelper
    ' 型安全なTempData設定
    &lt;Extension&gt;
    Public Sub SetValue(Of T)(tempData As ITempDataDictionary, key As String, value As T)
        tempData(key) = value
    End Sub

    ' 型安全なTempData取得
    &lt;Extension&gt;
    Public Function GetValue(Of T)(tempData As ITempDataDictionary, key As String) As T
        If tempData.TryGetValue(key, Nothing) Then
            Return CType(tempData(key), T)
        End If
        Return Nothing
    End Function

    ' メッセージ専用のヘルパーメソッド
    &lt;Extension&gt;
    Public Sub SetSuccessMessage(tempData As ITempDataDictionary, message As String)
        tempData("SuccessMessage") = message
    End Sub

    &lt;Extension&gt;
    Public Function GetSuccessMessage(tempData As ITempDataDictionary) As String
        Return tempData.GetValue(Of String)("SuccessMessage")
    End Function
End Module</code></pre>

                        <h6>ビューでのデータ表示</h6>
                        <pre class="code-block"><code class="language-html">&lt;!-- Views/DataTransfer/Index.cshtml --&gt;
&lt;h2&gt;データ転送方式の比較&lt;/h2&gt;

&lt;div class="row"&gt;
    &lt;div class="col-md-4"&gt;
        &lt;h4&gt;ViewData&lt;/h4&gt;
        &lt;p&gt;現在時刻: @ViewData("CurrentTime")&lt;/p&gt;
        &lt;p&gt;ユーザー数: @ViewData("UserCount")&lt;/p&gt;
        &lt;p&gt;ログイン状態: @ViewData("IsLoggedIn")&lt;/p&gt;
    &lt;/div&gt;
    
    &lt;div class="col-md-4"&gt;
        &lt;h4&gt;ViewBag&lt;/h4&gt;
        &lt;p&gt;アプリ名: @ViewBag.AppName&lt;/p&gt;
        &lt;p&gt;バージョン: @ViewBag.Version&lt;/p&gt;
        &lt;p&gt;カテゴリ:&lt;/p&gt;
        &lt;ul&gt;
            @For Each category In ViewBag.Categories
                &lt;li&gt;@category&lt;/li&gt;
            Next
        &lt;/ul&gt;
    &lt;/div&gt;
    
    &lt;div class="col-md-4"&gt;
        &lt;h4&gt;TempData&lt;/h4&gt;
        @If TempData("InfoMessage") IsNot Nothing Then
            &lt;div class="alert alert-info"&gt;@TempData("InfoMessage")&lt;/div&gt;
        End If
        &lt;p&gt;処理件数: @TempData("ProcessedCount")&lt;/p&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
                    </div>

                    <h3 class="section-title">9.4 メモリキャッシュ</h3>
                    <p>
                        メモリキャッシュは、アプリケーションサーバーのメモリ内にデータを保存してアクセス速度を向上させる技術です。
                        データベースクエリの結果や計算集約的な処理結果をキャッシュすることで、パフォーマンスが大幅に改善されます。
                    </p>

                    <div class="warning">
                        <h6>メモリキャッシュの注意点</h6>
                        <ul>
                            <li>サーバーを複数台構成にする場合、各サーバーで独立したキャッシュが作成される</li>
                            <li>アプリケーションの再起動時にキャッシュデータは失われる</li>
                            <li>メモリ使用量に注意して適切な有効期限を設定する</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 9-3: メモリキャッシュの実装</h5>
                        <p>商品情報の取得処理にメモリキャッシュを適用します。</p>

                        <h6>キャッシュサービスの設定</h6>
                        <pre class="code-block"><code class="language-vbnet">' Startup.vb のConfigureServicesメソッド
services.AddMemoryCache(Sub(options)
    options.SizeLimit = 1024 ' エントリ数の上限
End Sub)</code></pre>

                        <h6>キャッシュを使用するサービスクラス</h6>
                        <pre class="code-block"><code class="language-vbnet">' Services/ProductService.vb
Imports Microsoft.Extensions.Caching.Memory
Imports Microsoft.Extensions.Logging

Public Class ProductService
    Private ReadOnly _memoryCache As IMemoryCache
    Private ReadOnly _logger As ILogger(Of ProductService)

    Public Sub New(memoryCache As IMemoryCache, logger As ILogger(Of ProductService))
        _memoryCache = memoryCache
        _logger = logger
    End Sub

    Public Async Function GetProductsAsync() As Task(Of List(Of Product))
        Const cacheKey As String = "all_products"

        ' キャッシュから取得を試行
        If _memoryCache.TryGetValue(cacheKey, Nothing) Then
            _logger.LogInformation("キャッシュから商品データを取得しました")
            Return CType(_memoryCache.Get(cacheKey), List(Of Product))
        End If

        ' キャッシュにない場合はデータベースから取得
        _logger.LogInformation("データベースから商品データを取得中...")
        Dim products = Await LoadProductsFromDatabaseAsync()

        ' キャッシュに保存（5分間保持）
        Dim cacheOptions = New MemoryCacheEntryOptions() With {
            .AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(5),
            .Priority = CacheItemPriority.Normal,
            .Size = 1 ' SizeLimitに対するサイズ
        }

        ' キャッシュエントリ削除時のコールバック
        cacheOptions.RegisterPostEvictionCallback(Sub(key, value, reason, state)
            _logger.LogInformation($"キャッシュエントリ '{key}' が削除されました。理由: {reason}")
        End Sub)

        _memoryCache.Set(cacheKey, products, cacheOptions)
        _logger.LogInformation($"商品データをキャッシュに保存しました（{products.Count}件）")

        Return products
    End Function

    Public Async Function GetProductByIdAsync(productId As Integer) As Task(Of Product)
        Dim cacheKey = $"product_{productId}"

        Return Await _memoryCache.GetOrCreateAsync(cacheKey, Async Function(entry)
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(10)
            entry.Priority = CacheItemPriority.High
            entry.Size = 1

            _logger.LogInformation($"商品ID {productId} をデータベースから取得中...")
            Return Await LoadProductFromDatabaseAsync(productId)
        End Function)
    End Function

    ' キャッシュクリア機能
    Public Sub ClearProductCache()
        _memoryCache.Remove("all_products")
        _logger.LogInformation("商品キャッシュをクリアしました")
    End Sub

    ' 特定の商品キャッシュを削除
    Public Sub ClearProductCache(productId As Integer)
        _memoryCache.Remove($"product_{productId}")
        _logger.LogInformation($"商品ID {productId} のキャッシュをクリアしました")
    End Sub

    ' データベースからの取得処理（シミュレーション）
    Private Async Function LoadProductsFromDatabaseAsync() As Task(Of List(Of Product))
        ' データベース処理の重い処理をシミュレート
        Await Task.Delay(2000)
        
        Return New List(Of Product) From {
            New Product With {.Id = 1, .Name = "商品A", .Price = 1000},
            New Product With {.Id = 2, .Name = "商品B", .Price = 2000},
            New Product With {.Id = 3, .Name = "商品C", .Price = 1500}
        }
    End Function

    Private Async Function LoadProductFromDatabaseAsync(productId As Integer) As Task(Of Product)
        Await Task.Delay(500)
        Return New Product With {.Id = productId, .Name = $"商品{productId}", .Price = productId * 1000}
    End Function
End Class</code></pre>

                        <h6>コントローラーでの使用</h6>
                        <pre class="code-block"><code class="language-vbnet">' Controllers/ProductController.vb
Public Class ProductController
    Inherits Controller

    Private ReadOnly _productService As ProductService

    Public Sub New(productService As ProductService)
        _productService = productService
    End Sub

    Public Async Function Index() As Task(Of IActionResult)
        Dim stopwatch = Diagnostics.Stopwatch.StartNew()
        Dim products = Await _productService.GetProductsAsync()
        stopwatch.Stop()

        ViewBag.LoadTime = stopwatch.ElapsedMilliseconds
        Return View(products)
    End Function

    &lt;HttpPost&gt;
    Public Function ClearCache() As IActionResult
        _productService.ClearProductCache()
        TempData("Message") = "キャッシュをクリアしました"
        Return RedirectToAction("Index")
    End Function
End Class</code></pre>
                    </div>

                    <h3 class="section-title">9.5 分散キャッシュ</h3>
                    <p>
                        分散キャッシュは、複数のサーバー間でキャッシュデータを共有する仕組みです。
                        スケールアウトされたWebアプリケーションでは、Redis、SQL Serverなどの外部ストレージを使用します。
                    </p>

                    <div class="mermaid">
                        graph TD
                            A["Web Server 1"] --> D["分散キャッシュ<br/>(Redis)"]
                            B["Web Server 2"] --> D
                            C["Web Server 3"] --> D
                            
                            D --> E["データベース<br/>（キャッシュミス時）"]
                    </div>

                    <div class="exercise-container">
                        <h5>実習 9-4: SQL Server分散キャッシュの設定</h5>
                        <p>SQL Serverを使用した分散キャッシュを実装します。</p>

                        <h6>分散キャッシュの設定</h6>
                        <pre class="code-block"><code class="language-vbnet">' Startup.vb のConfigureServicesメソッド
services.AddStackExchangeRedisCache(Sub(options)
    options.Configuration = Configuration.GetConnectionString("RedisConnection")
    options.InstanceName = "MyApp"
End Sub)

' または SQL Server分散キャッシュ
services.AddSqlServerCache(Sub(options)
    options.ConnectionString = Configuration.GetConnectionString("DefaultConnection")
    options.SchemaName = "dbo"
    options.TableName = "CacheEntries"
End Sub)</code></pre>

                        <h6>分散キャッシュサービス</h6>
                        <pre class="code-block"><code class="language-vbnet">' Services/DistributedCacheService.vb
Imports Microsoft.Extensions.Caching.Distributed
Imports System.Text.Json

Public Class DistributedCacheService
    Private ReadOnly _distributedCache As IDistributedCache
    Private ReadOnly _logger As ILogger(Of DistributedCacheService)

    Public Sub New(distributedCache As IDistributedCache, logger As ILogger(Of DistributedCacheService))
        _distributedCache = distributedCache
        _logger = logger
    End Sub

    Public Async Function SetAsync(Of T)(key As String, value As T, expiration As TimeSpan) As Task
        Dim json = JsonSerializer.Serialize(value)
        Dim options = New DistributedCacheEntryOptions() With {
            .AbsoluteExpirationRelativeToNow = expiration
        }
        
        Await _distributedCache.SetStringAsync(key, json, options)
        _logger.LogInformation($"分散キャッシュに保存: {key}")
    End Function

    Public Async Function GetAsync(Of T)(key As String) As Task(Of T)
        Dim json = Await _distributedCache.GetStringAsync(key)
        If String.IsNullOrEmpty(json) Then
            Return Nothing
        End If

        _logger.LogInformation($"分散キャッシュから取得: {key}")
        Return JsonSerializer.Deserialize(Of T)(json)
    End Function

    Public Async Function GetOrSetAsync(Of T)(key As String, factory As Func(Of Task(Of T)), expiration As TimeSpan) As Task(Of T)
        Dim cachedValue = Await GetAsync(Of T)(key)
        If cachedValue IsNot Nothing Then
            Return cachedValue
        End If

        Dim value = Await factory()
        Await SetAsync(key, value, expiration)
        Return value
    End Function

    Public Async Function RemoveAsync(key As String) As Task
        Await _distributedCache.RemoveAsync(key)
        _logger.LogInformation($"分散キャッシュから削除: {key}")
    End Function
End Class</code></pre>
                    </div>

                    <h3 class="section-title">9.6 レスポンスキャッシング</h3>
                    <p>
                        レスポンスキャッシングは、HTTP応答全体をキャッシュしてネットワーク転送量とサーバー負荷を軽減する技術です。
                        静的コンテンツやあまり変更されないページに効果的です。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 9-5: レスポンスキャッシングの実装</h5>
                        <p>ページ全体のキャッシング機能を実装します。</p>

                        <h6>レスポンスキャッシングの設定</h6>
                        <pre class="code-block"><code class="language-vbnet">' Startup.vb
services.AddResponseCaching(Sub(options)
    options.MaximumBodySize = 64 * 1024 * 1024 ' 64MB
    options.UseCaseSensitivePaths = True
End Sub)

' Configureメソッド
app.UseResponseCaching()</code></pre>

                        <h6>コントローラーでのキャッシング制御</h6>
                        <pre class="code-block"><code class="language-vbnet">' コントローラーでの使用例
&lt;ResponseCache(Duration:=300, Location:=ResponseCacheLocation.Any)&gt;
Public Function CachedPage() As IActionResult
    ViewBag.GeneratedAt = DateTime.Now
    Return View()
End Function

' 動的なキャッシング制御
Public Function DynamicCache() As IActionResult
    ' 条件によってキャッシング設定を変更
    If User.Identity.IsAuthenticated Then
        ' ログイン済みユーザーはキャッシュしない
        Response.Headers("Cache-Control") = "no-cache, no-store, must-revalidate"
    Else
        ' 匿名ユーザーは5分間キャッシュ
        Response.Headers("Cache-Control") = "public, max-age=300"
    End If
    
    Return View()
End Function</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>セッション、TempData、ViewData、ViewBagのそれぞれの特徴と適用場面を説明してください。</li>
                            <li>メモリキャッシュと分散キャッシュの違いとそれぞれの利点を述べてください。</li>
                            <li>レスポンスキャッシングを使用する際の注意点を3つ挙げてください。</li>
                            <li>キャッシュの有効期限設定で考慮すべき要因は何ですか？</li>
                            <li>TempData.Keep()とTempData.Peek()の違いを説明してください。</li>
                        </ol>
                        
                        <div class="mt-3">
                            <strong>解答例：</strong>
                            <ol>
                                <li>Session：複数リクエストに跨った状態保持、TempData：リダイレクト間のデータ転送、ViewData/ViewBag：コントローラーからビューへの単発データ転送</li>
                                <li>メモリキャッシュ：単一サーバー内高速アクセス、分散キャッシュ：複数サーバー間でのデータ共有が可能</li>
                                <li>認証状態の考慮、動的データのキャッシュ回避、適切な有効期限設定</li>
                                <li>データの更新頻度、メモリ使用量、パフォーマンス要件、ビジネス要件</li>
                                <li>Keep()：次のリクエストでも値を保持、Peek()：値を取得するが削除しない</li>
                            </ol>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnetcore-vb-learning-material-8.html" class="btn btn-secondary">← 第8章: 認証と認可</a>
                        <a href="aspnetcore-vb-learning-material-10.html" class="btn btn-primary">第10章: 実践的なWebアプリケーション開発 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 F-Circle All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>