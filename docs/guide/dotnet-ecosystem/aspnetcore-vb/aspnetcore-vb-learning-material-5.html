<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET Core (VB.NET)学習教材 第5章 - 依存性注入とミドルウェア</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #663399;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #663399;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #663399;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #8e44ad;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #663399;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* コードハイライト */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #663399 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>ASP.NET Core (VB.NET)学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-1.html">
                                第1章: ASP.NET Core入門
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-2.html">
                                第2章: MVCアーキテクチャ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-3.html">
                                第3章: Razorビューとレイアウト
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-4.html">
                                第4章: モデルバインディング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aspnetcore-vb-learning-material-5.html">
                                第5章: 依存性注入とミドルウェア
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-6.html">
                                第6章: Entity Framework Core
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-7.html">
                                第7章: Web API開発
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-8.html">
                                第8章: 認証と認可
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-9.html">
                                第9章: 状態管理とキャッシング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnetcore-vb-learning-material-10.html">
                                第10章: 実践的なWebアプリケーション
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第5章: 依存性注入とミドルウェア</h1>
                </div>

                <div id="chapter5">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">アプリケーションの柔軟性を高める仕組み</h2>
                    
                    <!-- 学習目標（必須） -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>依存性注入（DI: Dependency Injection）の概念と利点</li>
                            <li>ASP.NET CoreのDIコンテナの使い方とサービス登録方法</li>
                            <li>サービスライフタイム（Singleton, Scoped, Transient）の使い分け</li>
                            <li>ミドルウェアパイプラインの構造と動作原理</li>
                            <li>カスタムミドルウェアの作成とリクエスト処理のカスタマイズ</li>
                            <li>VB.NETでの依存性注入とミドルウェアの実践的な実装方法</li>
                        </ul>
                    </div>

                    <!-- 5.1 依存性注入の基礎 -->
                    <h3 class="section-title">5.1 依存性注入（DI）とは</h3>
                    
                    <p>
                        依存性注入（Dependency Injection）は、オブジェクト間の依存関係を外部から注入することで、コードの結合度を下げ、
                        テスタビリティと保守性を向上させる設計パターンです。従来の開発では、クラス内で必要なオブジェクトを直接作成していましたが、
                        DIを使用することで、依存するオブジェクトを外部から提供してもらうようになります。
                    </p>

                    <div class="highlight">
                        <h5>なぜ依存性注入が重要なのか？</h5>
                        <ul>
                            <li><strong>疎結合化</strong>：クラス間の依存関係が弱くなり、変更に強いコードになる</li>
                            <li><strong>テストしやすさ</strong>：モックオブジェクトを注入してテストができる</li>
                            <li><strong>再利用性</strong>：異なる実装を簡単に差し替えることができる</li>
                            <li><strong>保守性</strong>：変更の影響範囲が限定される</li>
                        </ul>
                    </div>

                    <p>例えば、データベースアクセスを行うサービスクラスを考えてみましょう：</p>

                    <div class="mermaid">
                        classDiagram
                            class UserController {
                                -userService As IUserService
                                +GetUser(id As Integer) As ActionResult
                            }
                            class IUserService {
                                &lt;&lt;interface&gt;&gt;
                                +GetUserById(id As Integer) As User
                            }
                            class UserService {
                                +GetUserById(id As Integer) As User
                            }
                            class DatabaseUserService {
                                +GetUserById(id As Integer) As User
                            }
                            
                            UserController --> IUserService
                            UserService ..|> IUserService
                            DatabaseUserService ..|> IUserService
                    </div>

                    <!-- 5.2 ASP.NET CoreのDIコンテナ -->
                    <h3 class="section-title">5.2 ASP.NET CoreのDIコンテナ</h3>
                    
                    <p>
                        ASP.NET Coreには組み込みのDIコンテナが含まれており、`Program.vb`（または`Startup.vb`）で
                        サービスを登録し、コントローラーやその他のクラスで注入を受けることができます。
                    </p>

                    <h4>5.2.1 サービス登録の基本</h4>
                    
                    <p>まず、依存性注入される側のサービスクラスとインターフェースを作成します：</p>

                    <pre class="code-block"><code class="language-vbnet">' IUserService.vb - サービスインターフェース
Public Interface IUserService
    Function GetUserById(id As Integer) As User
    Function GetAllUsers() As List(Of User)
    Function CreateUser(user As User) As Boolean
End Interface</code></pre>

                    <pre class="code-block"><code class="language-vbnet">' UserService.vb - サービス実装クラス
Public Class UserService
    Implements IUserService

    ' データベースへのアクセスや外部APIへの呼び出しなどを行う
    Public Function GetUserById(id As Integer) As User Implements IUserService.GetUserById
        ' 実際の実装ではデータベースアクセスなどを行う
        Return New User With {
            .Id = id,
            .Name = $"ユーザー{id}",
            .Email = $"user{id}@example.com"
        }
    End Function

    Public Function GetAllUsers() As List(Of User) Implements IUserService.GetAllUsers
        ' 実装を記述
        Return New List(Of User)()
    End Function

    Public Function CreateUser(user As User) As Boolean Implements IUserService.CreateUser
        ' 実装を記述
        Return True
    End Function
End Class</code></pre>

                    <h4>5.2.2 Program.vbでのサービス登録</h4>

                    <p>`Program.vb`でサービスをDIコンテナに登録します：</p>

                    <pre class="code-block"><code class="language-vbnet">' Program.vb
Imports Microsoft.Extensions.DependencyInjection

Module Program
    Sub Main(args As String())
        Dim builder = WebApplication.CreateBuilder(args)

        ' コントローラーサービスを追加
        builder.Services.AddControllers()

        ' カスタムサービスをDIコンテナに登録
        ' インターフェースと実装クラスをペアで登録
        builder.Services.AddScoped(Of IUserService, UserService)()

        ' その他のサービスも登録可能
        builder.Services.AddTransient(Of IEmailService, EmailService)()
        builder.Services.AddSingleton(Of IConfigurationService, ConfigurationService)()

        Dim app = builder.Build()

        ' ミドルウェアパイプラインの設定
        If app.Environment.IsDevelopment() Then
            app.UseDeveloperExceptionPage()
        End If

        app.UseRouting()
        app.MapControllers()

        app.Run()
    End Sub
End Module</code></pre>

                    <!-- 実習 5-1 -->
                    <div class="exercise-container">
                        <h5>実習 5-1: 基本的な依存性注入の実装</h5>
                        <p>
                            シンプルなメッセージサービスを作成し、コントローラーで注入を受ける例を実装してみましょう。
                        </p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいASP.NET CoreプロジェクトをVB.NETで作成</li>
                            <li>IMessageServiceインターフェースとMessageServiceクラスを作成</li>
                            <li>Program.vbでサービスを登録</li>
                            <li>HomeControllerでサービスを注入して使用</li>
                        </ol>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-vbnet">' IMessageService.vb
Public Interface IMessageService
    Function GetWelcomeMessage() As String
    Function GetGoodbyeMessage() As String
End Interface

' MessageService.vb
Public Class MessageService
    Implements IMessageService

    Public Function GetWelcomeMessage() As String Implements IMessageService.GetWelcomeMessage
        Return "ASP.NET Core with VB.NETへようこそ！"
    End Function

    Public Function GetGoodbyeMessage() As String Implements IMessageService.GetGoodbyeMessage
        Return "また次回お会いしましょう！"
    End Function
End Class</code></pre>
                        
                        <pre class="code-block"><code class="language-vbnet">' HomeController.vb
Public Class HomeController
    Inherits Controller

    Private ReadOnly _messageService As IMessageService

    ' コンストラクター注入
    Public Sub New(messageService As IMessageService)
        _messageService = messageService
    End Sub

    Public Function Index() As IActionResult
        ViewBag.Message = _messageService.GetWelcomeMessage()
        Return View()
    End Function
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>HomeControllerのIndexアクションで、注入されたMessageServiceからメッセージを取得できる</p>
                    </div>

                    <!-- 5.3 サービスライフタイム -->
                    <h3 class="section-title">5.3 サービスライフタイム</h3>
                    
                    <p>
                        ASP.NET CoreのDIコンテナでは、サービスのライフタイム（生存期間）を3種類から選択できます。
                        用途に応じて適切なライフタイムを選択することで、パフォーマンスとリソース使用量を最適化できます。
                    </p>

                    <div class="mermaid">
                        graph TD
                            A[Transient] --> A1["毎回新しいインスタンスを作成"]
                            B[Scoped] --> B1["HTTPリクエストごとに1つのインスタンス"]
                            C[Singleton] --> C1["アプリケーション全体で1つのインスタンス"]
                            
                            A1 --> A2["軽量なサービス向け"]
                            B1 --> B2["データベース接続など"]
                            C1 --> C2["設定サービスなど"]
                    </div>

                    <h4>5.3.1 Transient（都度作成）</h4>
                    <p>
                        依存性が要求されるたびに新しいインスタンスが作成されます。
                        軽量で状態を持たないサービスに適しています。
                    </p>

                    <pre class="code-block"><code class="language-vbnet">' Program.vb内
builder.Services.AddTransient(Of ICalculatorService, CalculatorService)()</code></pre>

                    <h4>5.3.2 Scoped（スコープ）</h4>
                    <p>
                        HTTPリクエストごとに1つのインスタンスが作成され、そのリクエスト内では同じインスタンスが使い回されます。
                        データベース接続やユーザーコンテキストなどに適しています。
                    </p>

                    <pre class="code-block"><code class="language-vbnet">' Program.vb内
builder.Services.AddScoped(Of IUserService, UserService)()</code></pre>

                    <h4>5.3.3 Singleton（シングルトン）</h4>
                    <p>
                        アプリケーション全体で1つのインスタンスが作成され、すべてのリクエストで共有されます。
                        設定サービスやキャッシュサービスなどに適しています。
                    </p>

                    <pre class="code-block"><code class="language-vbnet">' Program.vb内
builder.Services.AddSingleton(Of IConfigurationService, ConfigurationService)()</code></pre>

                    <div class="warning">
                        <h5>ライフタイムの選択における注意点</h5>
                        <ul>
                            <li>Singletonサービス内でScopedやTransientサービスを注入しないよう注意</li>
                            <li>状態を持つサービスはSingletonにしない（マルチスレッドアクセスのリスク）</li>
                            <li>データベースコンテキストはScopedで登録するのが一般的</li>
                        </ul>
                    </div>

                    <!-- 5.4 ミドルウェアの基礎 -->
                    <h3 class="section-title">5.4 ミドルウェアパイプライン</h3>
                    
                    <p>
                        ミドルウェアは、HTTPリクエストとレスポンスを処理するためのコンポーネントです。
                        ASP.NET Coreでは、複数のミドルウェアが順番に実行される「パイプライン」を形成し、
                        各ミドルウェアがリクエストを処理したり、次のミドルウェアに処理を委譲したりします。
                    </p>

                    <div class="mermaid">
                        sequenceDiagram
                            participant Client as クライアント
                            participant MW1 as 認証ミドルウェア
                            participant MW2 as ルーティングミドルウェア
                            participant MW3 as MVCミドルウェア
                            participant Controller as コントローラー
                            
                            Client->>MW1: HTTPリクエスト
                            MW1->>MW2: 認証済みリクエスト
                            MW2->>MW3: ルート決定済みリクエスト
                            MW3->>Controller: アクション呼び出し
                            Controller->>MW3: ActionResult
                            MW3->>MW2: HTMLレスポンス
                            MW2->>MW1: レスポンス
                            MW1->>Client: HTTPレスポンス
                    </div>

                    <h4>5.4.1 組み込みミドルウェア</h4>
                    <p>ASP.NET Coreには多くの組み込みミドルウェアが用意されています：</p>

                    <pre class="code-block"><code class="language-vbnet">' Program.vb - 一般的なミドルウェア設定
Module Program
    Sub Main(args As String())
        Dim builder = WebApplication.CreateBuilder(args)
        
        builder.Services.AddControllers()
        
        Dim app = builder.Build()

        ' 1. 開発環境での例外ページ
        If app.Environment.IsDevelopment() Then
            app.UseDeveloperExceptionPage()
        End If

        ' 2. HTTPS リダイレクト
        app.UseHttpsRedirection()

        ' 3. 静的ファイルの配信
        app.UseStaticFiles()

        ' 4. ルーティング
        app.UseRouting()

        ' 5. 認証（後の章で詳しく学習）
        app.UseAuthentication()

        ' 6. 認可
        app.UseAuthorization()

        ' 7. MVCコントローラーのマッピング
        app.MapControllers()

        app.Run()
    End Sub
End Module</code></pre>

                    <div class="highlight">
                        <h5>ミドルウェアの順序の重要性</h5>
                        <p>
                            ミドルウェアは登録された順番で実行されるため、順序が非常に重要です。
                            例えば、認証ミドルウェアは認可ミドルウェアより前に配置する必要があります。
                        </p>
                    </div>

                    <!-- 5.5 カスタムミドルウェア -->
                    <h3 class="section-title">5.5 カスタムミドルウェアの作成</h3>
                    
                    <p>
                        独自の処理が必要な場合は、カスタムミドルウェアを作成できます。
                        ミドルウェアは`Invoke`または`InvokeAsync`メソッドを持つクラスとして実装します。
                    </p>

                    <h4>5.5.1 基本的なカスタムミドルウェア</h4>

                    <pre class="code-block"><code class="language-vbnet">' RequestLoggingMiddleware.vb - リクエストログ出力ミドルウェア
Imports Microsoft.AspNetCore.Http

Public Class RequestLoggingMiddleware
    Private ReadOnly _next As RequestDelegate
    Private ReadOnly _logger As ILogger(Of RequestLoggingMiddleware)

    Public Sub New(nextMiddleware As RequestDelegate, logger As ILogger(Of RequestLoggingMiddleware))
        _next = nextMiddleware
        _logger = logger
    End Sub

    Public Async Function InvokeAsync(context As HttpContext) As Task
        ' リクエスト開始ログ
        Dim startTime = DateTime.UtcNow
        _logger.LogInformation($"リクエスト開始: {context.Request.Method} {context.Request.Path}")

        Try
            ' 次のミドルウェアを呼び出し
            Await _next(context)
        Finally
            ' リクエスト完了ログ
            Dim endTime = DateTime.UtcNow
            Dim duration = endTime - startTime
            _logger.LogInformation($"リクエスト完了: {context.Response.StatusCode} ({duration.TotalMilliseconds}ms)")
        End Try
    End Function
End Class</code></pre>

                    <h4>5.5.2 ミドルウェア拡張メソッド</h4>
                    <p>使いやすくするため、拡張メソッドを作成することが推奨されます：</p>

                    <pre class="code-block"><code class="language-vbnet">' MiddlewareExtensions.vb - ミドルウェア拡張メソッド
Imports Microsoft.AspNetCore.Builder
Imports System.Runtime.CompilerServices

Public Module MiddlewareExtensions
    &lt;Extension()&gt;
    Public Function UseRequestLogging(app As IApplicationBuilder) As IApplicationBuilder
        Return app.UseMiddleware(Of RequestLoggingMiddleware)()
    End Function
End Module</code></pre>

                    <h4>5.5.3 カスタムミドルウェアの登録</h4>

                    <pre class="code-block"><code class="language-vbnet">' Program.vb - カスタムミドルウェアを登録
Module Program
    Sub Main(args As String())
        Dim builder = WebApplication.CreateBuilder(args)
        
        builder.Services.AddControllers()
        ' ログサービスは自動的に登録される
        
        Dim app = builder.Build()

        ' カスタムミドルウェアを追加（なるべく早い段階で）
        app.UseRequestLogging()

        If app.Environment.IsDevelopment() Then
            app.UseDeveloperExceptionPage()
        End If

        app.UseHttpsRedirection()
        app.UseRouting()
        app.MapControllers()

        app.Run()
    End Sub
End Module</code></pre>

                    <!-- 実習 5-2 -->
                    <div class="exercise-container">
                        <h5>実習 5-2: カスタムミドルウェアの作成</h5>
                        <p>
                            APIレスポンスにカスタムヘッダーを追加するミドルウェアを作成してみましょう。
                        </p>
                        <h6>手順</h6>
                        <ol>
                            <li>CustomHeaderMiddlewareクラスを作成</li>
                            <li>レスポンスヘッダーに"X-Custom-Header"を追加する処理を実装</li>
                            <li>拡張メソッドを作成してミドルウェアを登録</li>
                            <li>Program.vbでミドルウェアを有効化</li>
                        </ol>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-vbnet">' CustomHeaderMiddleware.vb
Public Class CustomHeaderMiddleware
    Private ReadOnly _next As RequestDelegate

    Public Sub New(nextMiddleware As RequestDelegate)
        _next = nextMiddleware
    End Sub

    Public Async Function InvokeAsync(context As HttpContext) As Task
        ' カスタムヘッダーを追加
        context.Response.Headers.Add("X-Custom-Header", "ASP.NET Core VB.NET")
        context.Response.Headers.Add("X-Processed-At", DateTime.UtcNow.ToString("yyyy-MM-dd HH:mm:ss UTC"))

        ' 次のミドルウェアを呼び出し
        Await _next(context)
    End Function
End Class</code></pre>
                        <h6>期待される結果</h6>
                        <p>すべてのHTTPレスポンスにカスタムヘッダーが追加される</p>
                    </div>

                    <!-- 5.6 実践的なDIとミドルウェア -->
                    <h3 class="section-title">5.6 実践的な依存性注入とミドルウェアの組み合わせ</h3>
                    
                    <p>
                        実際のWebアプリケーション開発では、依存性注入とミドルウェアを組み合わせて
                        よりリッチな機能を実現します。
                    </p>

                    <h4>5.6.1 設定サービスの注入</h4>

                    <pre class="code-block"><code class="language-vbnet">' AppSettings.vb - 設定クラス
Public Class AppSettings
    Public Property ApplicationName As String
    Public Property Version As String
    Public Property EnableLogging As Boolean
    Public Property DatabaseConnectionString As String
End Class

' Program.vb - 設定サービスの登録
Module Program
    Sub Main(args As String())
        Dim builder = WebApplication.CreateBuilder(args)
        
        ' 設定オプションを登録
        builder.Services.Configure(Of AppSettings)(builder.Configuration.GetSection("AppSettings"))
        
        ' 他のサービスも登録
        builder.Services.AddScoped(Of IUserService, UserService)()
        builder.Services.AddControllers()
        
        Dim app = builder.Build()
        
        app.UseRouting()
        app.MapControllers()
        app.Run()
    End Sub
End Module</code></pre>

                    <h4>5.6.2 設定を使用するミドルウェア</h4>

                    <pre class="code-block"><code class="language-vbnet">' ConfigurableLoggingMiddleware.vb
Imports Microsoft.Extensions.Options

Public Class ConfigurableLoggingMiddleware
    Private ReadOnly _next As RequestDelegate
    Private ReadOnly _logger As ILogger(Of ConfigurableLoggingMiddleware)
    Private ReadOnly _settings As AppSettings

    Public Sub New(nextMiddleware As RequestDelegate, 
                   logger As ILogger(Of ConfigurableLoggingMiddleware),
                   options As IOptions(Of AppSettings))
        _next = nextMiddleware
        _logger = logger
        _settings = options.Value
    End Sub

    Public Async Function InvokeAsync(context As HttpContext) As Task
        ' 設定に応じてログ出力を制御
        If _settings.EnableLogging Then
            _logger.LogInformation($"[{_settings.ApplicationName}] リクエスト: {context.Request.Path}")
        End If

        Await _next(context)

        If _settings.EnableLogging Then
            _logger.LogInformation($"[{_settings.ApplicationName}] レスポンス: {context.Response.StatusCode}")
        End If
    End Function
End Class</code></pre>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>依存性注入の利点として正しくないものはどれですか？</strong><br>
                                a) テストしやすくなる<br>
                                b) コードの結合度が下がる<br>
                                c) パフォーマンスが大幅に向上する<br>
                                d) 変更に強いコードになる
                            </li>
                            <li>
                                <strong>サービスライフタイムで、HTTPリクエストごとに1つのインスタンスを作成するのはどれですか？</strong><br>
                                a) Transient<br>
                                b) Scoped<br>
                                c) Singleton<br>
                                d) Instance
                            </li>
                            <li>
                                <strong>ミドルウェアパイプラインにおいて、最も重要な要素は何ですか？</strong><br>
                                a) ミドルウェアの数<br>
                                b) ミドルウェアの実行順序<br>
                                c) ミドルウェアの複雑さ<br>
                                d) ミドルウェアのパフォーマンス
                            </li>
                            <li>
                                <strong>VB.NETでカスタムミドルウェアを作成する際に必須のメソッドはどれですか？</strong><br>
                                a) Execute<br>
                                b) Process<br>
                                c) InvokeAsync<br>
                                d) Handle
                            </li>
                        </ol>
                    </div>

                    <!-- 実習 5-3 -->
                    <div class="exercise-container">
                        <h5>実習 5-3: 統合演習 - DIとミドルウェアの組み合わせ</h5>
                        <p>
                            ユーザーの訪問回数をカウントし、設定に応じてログ出力するシステムを実装しましょう。
                        </p>
                        <h6>要件</h6>
                        <ul>
                            <li>訪問回数をカウントするサービス（Singletonで登録）</li>
                            <li>設定で有効/無効を切り替えできるログ出力ミドルウェア</li>
                            <li>DI経由で設定とサービスを注入</li>
                        </ul>
                        <h6>手順</h6>
                        <ol>
                            <li>IVisitCounterServiceインターフェースとVisitCounterServiceクラスを作成</li>
                            <li>appsettings.jsonに設定項目を追加</li>
                            <li>設定クラスを作成し、Program.vbで登録</li>
                            <li>訪問カウントミドルウェアを作成</li>
                            <li>全体を統合してテスト</li>
                        </ol>
                        <h6>期待される結果</h6>
                        <p>設定に応じて訪問ログが出力され、各リクエストで訪問回数がカウントアップされる</p>
                    </div>

                    <!-- まとめ -->
                    <div class="highlight">
                        <h5>この章のまとめ</h5>
                        <ul>
                            <li><strong>依存性注入</strong>は、疎結合でテストしやすいコードを作るための重要な仕組み</li>
                            <li><strong>サービスライフタイム</strong>（Transient, Scoped, Singleton）を適切に選択することが重要</li>
                            <li><strong>ミドルウェア</strong>は、HTTPリクエスト処理のパイプラインを構成する</li>
                            <li><strong>カスタムミドルウェア</strong>を作成することで、横断的関心事を効率的に処理できる</li>
                            <li><strong>DIとミドルウェア</strong>を組み合わせることで、設定可能で拡張性の高いアプリケーションを構築できる</li>
                        </ul>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnetcore-vb-learning-material-4.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnetcore-vb-learning-material-6.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>