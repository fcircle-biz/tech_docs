<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET VB.NET学習教材 第9章 - セキュリティとメンバーシップ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0078d4;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0078d4;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #2196F3;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0078d4;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .security-note {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ff9800;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0078d4 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        .security-table {
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../README.md">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">ASP.NET VB.NET学習ガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: Web Forms入門</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: Webコントロール</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">第3章: イベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">第4章: データ検証</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">第5章: 状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">第6章: データベース連携</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">第7章: データバインド</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: マスターページ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter9">第9章: セキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-10.html">第10章: 実践開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第9章: セキュリティとメンバーシップ</h1>
                </div>

                <div id="chapter9">
                    <h2 class="chapter-title">Webアプリケーションのセキュリティとメンバーシップシステム</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Webアプリケーションにおける認証・認可の基本概念</li>
                            <li>ASP.NETメンバーシップシステムの実装方法</li>
                            <li>ログインコントロールの使用とカスタマイズ</li>
                            <li>ロールベースアクセス制御の実装</li>
                            <li>セキュリティベストプラクティス（パスワードハッシュ化、XSS対策など）</li>
                            <li>セッション管理とセキュリティ強化</li>
                        </ul>
                    </div>

                    <div class="security-note">
                        <h6>🔒 セキュリティの重要性</h6>
                        <p>Webアプリケーションは外部からアクセス可能なため、セキュリティは最重要課題です。適切な認証・認可なしに機密情報が漏洩する可能性があります。この章ではセキュアなWebアプリケーション開発の基礎を学習します。</p>
                    </div>

                    <h3 class="section-title">9.1 認証と認可の基本概念</h3>
                    <p>Webアプリケーションのセキュリティの基盤となる認証（Authentication）と認可（Authorization）について学習します。</p>

                    <h4>認証と認可の違い</h4>
                    <table class="table table-striped security-table">
                        <thead>
                            <tr>
                                <th>概念</th>
                                <th>英語</th>
                                <th>目的</th>
                                <th>具体例</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>認証</td>
                                <td>Authentication</td>
                                <td>ユーザーが誰かを確認</td>
                                <td>ログイン、パスワード認証</td>
                            </tr>
                            <tr>
                                <td>認可</td>
                                <td>Authorization</td>
                                <td>ユーザーのアクセス権限を確認</td>
                                <td>管理者画面へのアクセス制御</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="exercise-container">
                        <h5>実習 9-1: ASP.NETメンバーシップシステムの設定</h5>
                        <p>ASP.NETの標準的なメンバーシップシステムを設定し、ユーザー登録とログイン機能を実装します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>Web.configファイルを開き、メンバーシップの設定を追加</li>
                            <li>接続文字列を設定（SQL Server Express LocalDBを使用）</li>
                            <li>aspnet_regsql.exeを実行してメンバーシップデータベーススキーマを作成</li>
                            <li>Login.aspxページを作成</li>
                        </ol>
                        <h6>Web.config設定例</h6>
                        <pre class="code-block"><code class="language-html">&lt;configuration&gt;
  &lt;connectionStrings&gt;
    &lt;add name="MembershipDB" 
         connectionString="Data Source=(localdb)\MSSQLLocalDB;Initial Catalog=MembershipDB;Integrated Security=True" 
         providerName="System.Data.SqlClient" /&gt;
  &lt;/connectionStrings&gt;
  
  &lt;system.web&gt;
    &lt;membership defaultProvider="SqlProvider"&gt;
      &lt;providers&gt;
        &lt;add name="SqlProvider" 
             type="System.Web.Security.SqlMembershipProvider" 
             connectionStringName="MembershipDB"
             enablePasswordRetrieval="false"
             enablePasswordReset="true"
             requiresQuestionAndAnswer="false"
             applicationName="/"
             requiresUniqueEmail="false"
             passwordFormat="Hashed"
             maxInvalidPasswordAttempts="5"
             minRequiredPasswordLength="6"
             minRequiredNonalphanumericCharacters="0" /&gt;
      &lt;/providers&gt;
    &lt;/membership&gt;
    
    &lt;roleManager enabled="true" defaultProvider="SqlProvider"&gt;
      &lt;providers&gt;
        &lt;add name="SqlProvider" 
             type="System.Web.Security.SqlRoleProvider" 
             connectionStringName="MembershipDB"
             applicationName="/" /&gt;
      &lt;/providers&gt;
    &lt;/roleManager&gt;
  &lt;/system.web&gt;
&lt;/configuration&gt;</code></pre>
                        <h6>期待される結果</h6>
                        <p>メンバーシップデータベースが作成され、ユーザー認証機能の基盤が構築されます。</p>
                    </div>

                    <h3 class="section-title">9.2 ログインコントロールの実装</h3>
                    <p>ASP.NETのLoginコントロールを使用してユーザー認証機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 9-2: ログインページの作成</h5>
                        <p>Loginコントロールを使用したログインページとユーザー登録機能を実装します。</p>
                        <h6>Login.aspx（VB.NET）</h6>
                        <pre class="code-block"><code class="language-html">&lt;%@ Page Language="VB" AutoEventWireup="false" CodeBehind="Login.aspx.vb" Inherits="WebApplication.Login" %&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head runat="server"&gt;
    &lt;title&gt;ログイン&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id="form1" runat="server"&gt;
        &lt;div&gt;
            &lt;h2&gt;ユーザーログイン&lt;/h2&gt;
            &lt;asp:Login ID="Login1" runat="server"
                       DestinationPageUrl="~/Default.aspx"
                       TitleText="ログイン"
                       UserNameLabelText="ユーザー名:"
                       PasswordLabelText="パスワード:"
                       LoginButtonText="ログイン"
                       CreateUserText="新規ユーザー登録"
                       CreateUserUrl="~/Register.aspx"
                       FailureText="ログインに失敗しました。"&gt;
            &lt;/asp:Login&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        <h6>Register.aspx（ユーザー登録）</h6>
                        <pre class="code-block"><code class="language-html">&lt;asp:CreateUserWizard ID="CreateUserWizard1" runat="server"
                      ContinueDestinationPageUrl="~/Default.aspx"
                      CreateUserButtonText="ユーザー作成"
                      ContinueButtonText="続行"&gt;
    &lt;WizardSteps&gt;
        &lt;asp:CreateUserWizardStep ID="CreateUserWizardStep1" runat="server"&gt;
        &lt;/asp:CreateUserWizardStep&gt;
        &lt;asp:CompleteWizardStep ID="CompleteWizardStep1" runat="server"&gt;
        &lt;/asp:CompleteWizardStep&gt;
    &lt;/WizardSteps&gt;
&lt;/asp:CreateUserWizard&gt;</code></pre>
                    </div>

                    <h3 class="section-title">9.3 ロールベースアクセス制御</h3>
                    <p>ロール（役割）に基づいたアクセス制御を実装し、ユーザーの権限に応じた機能制限を行います。</p>

                    <div class="exercise-container">
                        <h5>実習 9-3: ロール管理システムの実装</h5>
                        <p>管理者とユーザーのロールを作成し、ページアクセス制御を実装します。</p>
                        <h6>ロール作成（VB.NET）</h6>
                        <pre class="code-block"><code class="language-vbnet">Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    ' ロールが存在しない場合は作成
    If Not Roles.RoleExists("Administrator") Then
        Roles.CreateRole("Administrator")
    End If
    
    If Not Roles.RoleExists("User") Then
        Roles.CreateRole("User")
    End If
End Sub

Protected Sub btnAssignRole_Click(sender As Object, e As EventArgs) Handles btnAssignRole.Click
    Dim userName As String = txtUserName.Text
    Dim roleName As String = ddlRoles.SelectedValue
    
    If Membership.GetUser(userName) IsNot Nothing Then
        Roles.AddUserToRole(userName, roleName)
        lblMessage.Text = String.Format("ユーザー '{0}' をロール '{1}' に追加しました。", userName, roleName)
    Else
        lblMessage.Text = "指定されたユーザーが見つかりません。"
    End If
End Sub</code></pre>
                        <h6>ページレベルでのアクセス制御（Web.config）</h6>
                        <pre class="code-block"><code class="language-html">&lt;location path="Admin"&gt;
  &lt;system.web&gt;
    &lt;authorization&gt;
      &lt;allow roles="Administrator" /&gt;
      &lt;deny users="*" /&gt;
    &lt;/authorization&gt;
  &lt;/system.web&gt;
&lt;/location&gt;

&lt;location path="User"&gt;
  &lt;system.web&gt;
    &lt;authorization&gt;
      &lt;allow roles="Administrator,User" /&gt;
      &lt;deny users="?" /&gt;
    &lt;/authorization&gt;
  &lt;/system.web&gt;
&lt;/location&gt;</code></pre>
                    </div>

                    <h3 class="section-title">9.4 セキュリティベストプラクティス</h3>
                    <p>Webアプリケーションの脆弱性から守るためのセキュリティ対策を実装します。</p>

                    <h4>主要なセキュリティ脅威と対策</h4>
                    <table class="table table-striped security-table">
                        <thead>
                            <tr>
                                <th>脅威</th>
                                <th>説明</th>
                                <th>対策</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>XSS（クロスサイトスクリプティング）</td>
                                <td>悪意のあるスクリプト注入</td>
                                <td>入力値の検証、HTMLエンコーディング</td>
                            </tr>
                            <tr>
                                <td>SQLインジェクション</td>
                                <td>SQLクエリの不正操作</td>
                                <td>パラメータ化クエリの使用</td>
                            </tr>
                            <tr>
                                <td>CSRF（クロスサイトリクエストフォージェリ）</td>
                                <td>なりすましリクエスト</td>
                                <td>ViewStateの活用、トークン検証</td>
                            </tr>
                            <tr>
                                <td>セッションハイジャック</td>
                                <td>セッションIDの盗用</td>
                                <td>HTTPS使用、セッションタイムアウト設定</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="exercise-container">
                        <h5>実習 9-4: XSS対策とHTMLエンコーディング</h5>
                        <p>ユーザー入力データの適切な処理とXSS攻撃対策を実装します。</p>
                        <h6>安全な出力処理（VB.NET）</h6>
                        <pre class="code-block"><code class="language-vbnet">' 危険な処理（XSS脆弱性あり）
lblUnsafe.Text = Request.QueryString("message")

' 安全な処理（HTMLエンコーディング）
lblSafe.Text = Server.HtmlEncode(Request.QueryString("message"))

' ユーザー入力の検証
Protected Sub btnSubmit_Click(sender As Object, e As EventArgs) Handles btnSubmit.Click
    Dim userInput As String = txtUserInput.Text
    
    ' 入力値検証（長さチェック）
    If userInput.Length > 100 Then
        lblError.Text = "入力が長すぎます。"
        Return
    End If
    
    ' 危険な文字の除去
    userInput = userInput.Replace("&lt;script", "").Replace("javascript:", "")
    
    ' HTMLエンコードして安全に表示
    lblResult.Text = Server.HtmlEncode(userInput)
End Sub

' ValidatorControlsを使用した検証
Protected Sub CustomValidator1_ServerValidate(source As Object, args As ServerValidateEventArgs) Handles CustomValidator1.ServerValidate
    ' カスタム検証ロジック
    Dim input As String = args.Value
    
    ' SQLインジェクション対策の基本チェック
    If input.Contains("'") OrElse input.Contains("--") OrElse input.Contains("DROP") Then
        args.IsValid = False
    Else
        args.IsValid = True
    End If
End Sub</code></pre>
                    </div>

                    <h3 class="section-title">9.5 セッション管理とセキュリティ強化</h3>
                    <p>セッションセキュリティの強化とHTTPS通信の実装について学習します。</p>

                    <div class="exercise-container">
                        <h5>実習 9-5: セキュアなセッション管理の実装</h5>
                        <p>セッションのセキュリティ設定とHTTPS強制を実装します。</p>
                        <h6>Web.configでのセッション設定</h6>
                        <pre class="code-block"><code class="language-html">&lt;system.web&gt;
  &lt;sessionState 
    mode="InProc"
    timeout="20"
    cookieless="false"
    cookieTimeout="20"
    cookieName="ASP.NET_SessionId"
    cookieSameSite="Strict"
    httpOnlyCookies="true"
    useHostingIdentity="false"
    regenerateExpiredSessionId="true" /&gt;
    
  &lt;httpCookies httpOnlyCookies="true" requireSSL="true" /&gt;
  
  &lt;compilation debug="false" targetFramework="4.8" /&gt;
&lt;/system.web&gt;</code></pre>
                        <h6>セッションタイムアウト管理（VB.NET）</h6>
                        <pre class="code-block"><code class="language-vbnet">Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    ' セッションタイムアウトチェック
    If Session("UserID") Is Nothing Then
        Response.Redirect("~/Login.aspx?timeout=true")
    End If
    
    ' セッション更新
    Session("LastActivity") = DateTime.Now
End Sub

Protected Sub Application_PreSendRequestHeaders(sender As Object, e As EventArgs)
    ' セキュリティヘッダーの追加
    Response.Headers.Remove("Server")
    Response.Headers.Add("X-Content-Type-Options", "nosniff")
    Response.Headers.Add("X-Frame-Options", "DENY")
    Response.Headers.Add("X-XSS-Protection", "1; mode=block")
End Sub</code></pre>
                    </div>

                    <div class="security-note">
                        <h6>🔐 パスワード管理のベストプラクティス</h6>
                        <ul>
                            <li><strong>パスワードハッシュ化</strong>: 平文パスワードの保存は絶対に禁止</li>
                            <li><strong>強度要件</strong>: 最小8文字、英数字記号の組み合わせ</li>
                            <li><strong>アカウントロック</strong>: 連続ログイン失敗でアカウント一時停止</li>
                            <li><strong>定期的な変更促進</strong>: パスワード有効期限の設定</li>
                        </ul>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>認証（Authentication）と認可（Authorization）の違いを説明してください。</li>
                            <li>ASP.NETメンバーシップシステムの主要な設定項目を3つ挙げてください。</li>
                            <li>XSS攻撃を防ぐためのVB.NETでのコーディング手法を説明してください。</li>
                            <li>ロールベースアクセス制御で「Administrator」ロールのみにアクセスを許可するWeb.config設定を書いてください。</li>
                            <li>セッションハイジャック対策として実装すべき設定を3つ説明してください。</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li><strong>認証</strong>：ユーザーが誰かを確認する処理（ログイン）。<strong>認可</strong>：認証されたユーザーのアクセス権限を確認する処理（管理者画面アクセス制御など）。</li>
                                <li>connectionStringName（データベース接続）、passwordFormat（パスワード形式）、minRequiredPasswordLength（最小パスワード長）</li>
                                <li>Server.HtmlEncode()を使用してユーザー入力をHTMLエンコードし、スクリプトタグの実行を防ぐ</li>
                                <li>
                                    <pre>&lt;location path="Admin"&gt;
  &lt;system.web&gt;
    &lt;authorization&gt;
      &lt;allow roles="Administrator" /&gt;
      &lt;deny users="*" /&gt;
    &lt;/authorization&gt;
  &lt;/system.web&gt;
&lt;/location&gt;</pre>
                                </li>
                                <li>HTTPS通信の強制、httpOnlyCookiesの有効化、セッションタイムアウトの適切な設定</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-8.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-10.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>