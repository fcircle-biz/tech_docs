<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET VB.NET学習教材 第3章 - イベント処理とPostBack</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0078d4;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0078d4;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #2196F3;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0078d4;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0078d4 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        .lifecycle-diagram {
            background-color: #f8f9fa;
            border: 2px solid #0078d4;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../README.md">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">ASP.NET VB.NET学習ガイド</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">第1章: Web Forms入門</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">第2章: Webコントロール</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter3">第3章: イベント処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">第4章: データ検証</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">第5章: 状態管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">第6章: データベース連携</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">第7章: データバインド</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">第8章: マスターページ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-9.html">第9章: セキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-10.html">第10章: 実践開発</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第3章: イベント処理とPostBack</h1>
                </div>

                <div id="chapter3">
                    <h2 class="chapter-title">イベント処理とPostBack</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>ASP.NET Web Formsのイベントドリブンモデルを理解する</li>
                            <li>PostBackの仕組みとページライフサイクルを学習する</li>
                            <li>サーバーコントロールイベントの実装方法を習得する</li>
                            <li>VB.NETのイベント処理との違いを体験する</li>
                            <li>Page_LoadとIsPostBackプロパティの活用方法を学ぶ</li>
                        </ul>
                    </div>

                    <h3 class="section-title">3.1 Web Formsイベントドリブンモデル</h3>
                    <p>ASP.NET Web Formsは、VB.NETのWindows Formsと同様のイベントドリブンプログラミングモデルを採用しています。</p>

                    <h4>コンソールアプリケーションとの違い</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>プログラミングモデル</th>
                                    <th>コンソールアプリケーション</th>
                                    <th>Web Forms</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>実行フロー</strong></td>
                                    <td>Main()から順次実行</td>
                                    <td>イベント発生時に処理実行</td>
                                </tr>
                                <tr>
                                    <td><strong>ユーザー入力</strong></td>
                                    <td>Console.ReadLine()で待機</td>
                                    <td>ボタンクリック等のイベント</td>
                                </tr>
                                <tr>
                                    <td><strong>処理タイミング</strong></td>
                                    <td>プログラマーが制御</td>
                                    <td>ユーザーアクションが起点</td>
                                </tr>
                                <tr>
                                    <td><strong>ページ状態</strong></td>
                                    <td>変数で保持</td>
                                    <td>PostBack間でViewStateで保持</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 class="section-title">3.2 ページライフサイクル</h3>
                    <p>Web Formsページは、各リクエストで決まったライフサイクルを経て処理されます。</p>

                    <div class="lifecycle-diagram">
                        <h5>📋 ASP.NET ページライフサイクル</h5>
                        <ol>
                            <li><strong>Page_PreInit</strong> - ページ初期化前（テーマ設定等）</li>
                            <li><strong>Page_Init</strong> - ページとコントロールの初期化</li>
                            <li><strong>Page_Load</strong> - ページ読み込み（最も多用される）</li>
                            <li><strong>コントロールイベント</strong> - Button_Click等のイベント処理</li>
                            <li><strong>Page_PreRender</strong> - レンダリング前処理</li>
                            <li><strong>Page_Render</strong> - HTMLの生成</li>
                            <li><strong>Page_Unload</strong> - ページのクリーンアップ</li>
                        </ol>
                    </div>

                    <h3 class="section-title">3.3 PostBackメカニズム</h3>
                    <p>PostBackは、Webページがサーバーに送信されて処理される仕組みです。</p>

                    <pre class="code-block"><code class="language-vbnet">' Page_Loadイベントの基本パターン
Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
    If Not IsPostBack Then
        ' 初回アクセス時のみ実行される処理
        InitializeControls()
    End If
    
    ' 毎回実行される処理
    UpdateDateTime()
End Sub

Private Sub InitializeControls()
    ' ドロップダウンリストの初期化
    ddlCategories.Items.Add(New ListItem("選択してください", ""))
    ddlCategories.Items.Add(New ListItem("プログラミング", "programming"))
    ddlCategories.Items.Add(New ListItem("データベース", "database"))
    ddlCategories.Items.Add(New ListItem("ネットワーク", "network"))
End Sub

Private Sub UpdateDateTime()
    lblCurrentTime.Text = $"現在時刻: {DateTime.Now:yyyy-MM-dd HH:mm:ss}"
End Sub</code></pre>

                    <!-- 実習 -->
                    <div class="exercise-container">
                        <h5>実習 3-1: イベント処理とライフサイクル体験アプリ</h5>
                        <p>ページライフサイクルとイベント処理の順序を理解するための実習を行いましょう。</p>

                        <h6>EventLifecycle.aspx（マークアップ）</h6>
                        <pre class="code-block"><code class="language-html">&lt;%@ Page Title="イベントライフサイクル" Language="VB" MasterPageFile="~/Site.Master" AutoEventWireup="true" CodeBehind="EventLifecycle.aspx.vb" Inherits="HelloWorldWebApp.EventLifecycle" %&gt;

&lt;asp:Content ID="BodyContent" ContentPlaceHolderID="MainContent" runat="server"&gt;
    &lt;div class="container mt-4"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-md-8"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-warning text-dark"&gt;
                        &lt;h3 class="card-title mb-0"&gt;イベントライフサイクル デモ&lt;/h3&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;!-- カウンター --&gt;
                        &lt;div class="mb-3"&gt;
                            &lt;h5&gt;PostBackカウンター&lt;/h5&gt;
                            &lt;asp:Label ID="lblCounter" runat="server" Text="0" CssClass="badge bg-info fs-4"&gt;&lt;/asp:Label&gt;
                            &lt;asp:HiddenField ID="hiddenCounter" runat="server" Value="0" /&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- 現在時刻 --&gt;
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Label ID="lblCurrentTime" runat="server" CssClass="text-muted"&gt;&lt;/asp:Label&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- テキスト入力 --&gt;
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Label ID="lblTextInput" runat="server" Text="メッセージ:" CssClass="form-label" AssociatedControlID="txtMessage"&gt;&lt;/asp:Label&gt;
                            &lt;asp:TextBox ID="txtMessage" runat="server" CssClass="form-control" placeholder="何かメッセージを入力してください"&gt;&lt;/asp:TextBox&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- ボタン群 --&gt;
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Button ID="btnPostBack" runat="server" Text="PostBack実行" CssClass="btn btn-primary me-2" /&gt;
                            &lt;asp:Button ID="btnShowMessage" runat="server" Text="メッセージ表示" CssClass="btn btn-success me-2" /&gt;
                            &lt;asp:Button ID="btnClear" runat="server" Text="クリア" CssClass="btn btn-secondary" /&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- メッセージ表示 --&gt;
                        &lt;div class="mb-3"&gt;
                            &lt;asp:Label ID="lblDisplayMessage" runat="server" Text="" CssClass="alert alert-info d-block"&gt;&lt;/asp:Label&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- ドロップダウン連動 --&gt;
                        &lt;div class="mb-3"&gt;
                            &lt;div class="row"&gt;
                                &lt;div class="col-md-6"&gt;
                                    &lt;asp:Label ID="lblCategory" runat="server" Text="カテゴリ:" CssClass="form-label" AssociatedControlID="ddlCategory"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:DropDownList ID="ddlCategory" runat="server" CssClass="form-select" AutoPostBack="true"&gt;&lt;/asp:DropDownList&gt;
                                &lt;/div&gt;
                                &lt;div class="col-md-6"&gt;
                                    &lt;asp:Label ID="lblSubCategory" runat="server" Text="サブカテゴリ:" CssClass="form-label" AssociatedControlID="ddlSubCategory"&gt;&lt;/asp:Label&gt;
                                    &lt;asp:DropDownList ID="ddlSubCategory" runat="server" CssClass="form-select"&gt;&lt;/asp:DropDownList&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- チェックボックス連動 --&gt;
                        &lt;div class="mb-3"&gt;
                            &lt;asp:CheckBox ID="chkEnableControls" runat="server" Text="追加コントロールを有効化" AutoPostBack="true" CssClass="form-check-input me-1" /&gt;
                            &lt;asp:Label runat="server" AssociatedControlID="chkEnableControls" CssClass="form-check-label"&gt;追加コントロールを有効化&lt;/asp:Label&gt;
                            
                            &lt;div class="mt-2"&gt;
                                &lt;asp:Panel ID="pnlAdditionalControls" runat="server" Visible="false"&gt;
                                    &lt;asp:TextBox ID="txtAdditional" runat="server" CssClass="form-control mb-2" placeholder="追加入力フィールド"&gt;&lt;/asp:TextBox&gt;
                                    &lt;asp:Button ID="btnAdditional" runat="server" Text="追加処理" CssClass="btn btn-outline-primary" /&gt;
                                &lt;/asp:Panel&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="col-md-4"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-secondary text-white"&gt;
                        &lt;h5 class="card-title mb-0"&gt;イベント実行ログ&lt;/h5&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;asp:ListBox ID="lstEventLog" runat="server" CssClass="form-control" Rows="15"&gt;&lt;/asp:ListBox&gt;
                        &lt;asp:Button ID="btnClearLog" runat="server" Text="ログクリア" CssClass="btn btn-sm btn-outline-secondary mt-2" /&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/asp:Content&gt;</code></pre>

                        <h6>EventLifecycle.aspx.vb（コードビハインド）</h6>
                        <pre class="code-block"><code class="language-vbnet">Public Class EventLifecycle
    Inherits System.Web.UI.Page

    Protected Sub Page_PreInit(sender As Object, e As EventArgs) Handles Me.PreInit
        AddEventLog("Page_PreInit - ページ初期化前")
    End Sub

    Protected Sub Page_Init(sender As Object, e As EventArgs) Handles Me.Init
        AddEventLog("Page_Init - ページ初期化")
        InitializeControls()
    End Sub

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not IsPostBack Then
            AddEventLog("Page_Load - 初回ロード（IsPostBack = False）")
            InitializePageData()
        Else
            AddEventLog("Page_Load - PostBack後のロード（IsPostBack = True）")
        End If
        
        UpdateCounter()
        UpdateCurrentTime()
        LoadEventLogFromViewState()
    End Sub

    Protected Sub Page_PreRender(sender As Object, e As EventArgs) Handles Me.PreRender
        AddEventLog("Page_PreRender - レンダリング前処理")
        SaveEventLogToViewState()
    End Sub

    Protected Sub Page_Unload(sender As Object, e As EventArgs) Handles Me.Unload
        ' このイベントではコントロールにアクセスできないため、ログには記録されない
    End Sub

    ' ボタンイベント
    Protected Sub btnPostBack_Click(sender As Object, e As EventArgs) Handles btnPostBack.Click
        AddEventLog("btnPostBack_Click - PostBackボタンクリック")
    End Sub

    Protected Sub btnShowMessage_Click(sender As Object, e As EventArgs) Handles btnShowMessage.Click
        AddEventLog("btnShowMessage_Click - メッセージ表示ボタンクリック")
        
        If String.IsNullOrWhiteSpace(txtMessage.Text) Then
            lblDisplayMessage.Text = "メッセージが入力されていません。"
            lblDisplayMessage.CssClass = "alert alert-warning d-block"
        Else
            lblDisplayMessage.Text = $"入力されたメッセージ: {Server.HtmlEncode(txtMessage.Text)}"
            lblDisplayMessage.CssClass = "alert alert-success d-block"
        End If
    End Sub

    Protected Sub btnClear_Click(sender As Object, e As EventArgs) Handles btnClear.Click
        AddEventLog("btnClear_Click - クリアボタンクリック")
        txtMessage.Text = ""
        lblDisplayMessage.Text = ""
        ddlCategory.SelectedIndex = 0
        ddlSubCategory.Items.Clear()
        chkEnableControls.Checked = False
        pnlAdditionalControls.Visible = False
        txtAdditional.Text = ""
    End Sub

    Protected Sub btnClearLog_Click(sender As Object, e As EventArgs) Handles btnClearLog.Click
        lstEventLog.Items.Clear()
        ViewState("EventLog") = New List(Of String)()
    End Sub

    Protected Sub btnAdditional_Click(sender As Object, e As EventArgs) Handles btnAdditional.Click
        AddEventLog("btnAdditional_Click - 追加処理ボタンクリック")
        If Not String.IsNullOrWhiteSpace(txtAdditional.Text) Then
            lblDisplayMessage.Text = $"追加処理実行: {Server.HtmlEncode(txtAdditional.Text)}"
            lblDisplayMessage.CssClass = "alert alert-info d-block"
        End If
    End Sub

    ' AutoPostBackイベント
    Protected Sub ddlCategory_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlCategory.SelectedIndexChanged
        AddEventLog($"ddlCategory_SelectedIndexChanged - カテゴリ変更: {ddlCategory.SelectedValue}")
        UpdateSubCategories()
    End Sub

    Protected Sub chkEnableControls_CheckedChanged(sender As Object, e As EventArgs) Handles chkEnableControls.CheckedChanged
        AddEventLog($"chkEnableControls_CheckedChanged - チェック状態: {chkEnableControls.Checked}")
        pnlAdditionalControls.Visible = chkEnableControls.Checked
    End Sub

    ' 初期化メソッド
    Private Sub InitializeControls()
        ' カテゴリの初期化
        If ddlCategory.Items.Count = 0 Then
            ddlCategory.Items.Add(New ListItem("選択してください", ""))
            ddlCategory.Items.Add(New ListItem("プログラミング", "programming"))
            ddlCategory.Items.Add(New ListItem("データベース", "database"))
            ddlCategory.Items.Add(New ListItem("ネットワーク", "network"))
        End If
    End Sub

    Private Sub InitializePageData()
        hiddenCounter.Value = "0"
        
        If ViewState("EventLog") Is Nothing Then
            ViewState("EventLog") = New List(Of String)()
        End If
    End Sub

    Private Sub UpdateCounter()
        Dim currentCount As Integer = Integer.Parse(hiddenCounter.Value)
        currentCount += 1
        hiddenCounter.Value = currentCount.ToString()
        lblCounter.Text = currentCount.ToString()
    End Sub

    Private Sub UpdateCurrentTime()
        lblCurrentTime.Text = $"ページ生成時刻: {DateTime.Now:yyyy-MM-dd HH:mm:ss.fff}"
    End Sub

    Private Sub UpdateSubCategories()
        ddlSubCategory.Items.Clear()
        
        Select Case ddlCategory.SelectedValue
            Case "programming"
                ddlSubCategory.Items.Add(New ListItem("VB.NET", "vbnet"))
                ddlSubCategory.Items.Add(New ListItem("C#", "csharp"))
                ddlSubCategory.Items.Add(New ListItem("Java", "java"))
            Case "database"
                ddlSubCategory.Items.Add(New ListItem("SQL Server", "sqlserver"))
                ddlSubCategory.Items.Add(New ListItem("Oracle", "oracle"))
                ddlSubCategory.Items.Add(New ListItem("MySQL", "mysql"))
            Case "network"
                ddlSubCategory.Items.Add(New ListItem("TCP/IP", "tcpip"))
                ddlSubCategory.Items.Add(New ListItem("HTTP", "http"))
                ddlSubCategory.Items.Add(New ListItem("DNS", "dns"))
        End Select
    End Sub

    ' イベントログ管理
    Private Sub AddEventLog(message As String)
        Dim eventLog As List(Of String) = GetEventLogFromViewState()
        eventLog.Add($"{DateTime.Now:HH:mm:ss.fff} - {message}")
        ViewState("EventLog") = eventLog
    End Sub

    Private Function GetEventLogFromViewState() As List(Of String)
        If ViewState("EventLog") Is Nothing Then
            ViewState("EventLog") = New List(Of String)()
        End If
        Return DirectCast(ViewState("EventLog"), List(Of String))
    End Function

    Private Sub LoadEventLogFromViewState()
        Dim eventLog As List(Of String) = GetEventLogFromViewState()
        lstEventLog.Items.Clear()
        
        For Each logEntry As String In eventLog
            lstEventLog.Items.Add(logEntry)
        Next
        
        ' 最新のエントリが見えるようにスクロール
        If lstEventLog.Items.Count > 0 Then
            lstEventLog.SelectedIndex = lstEventLog.Items.Count - 1
        End If
    End Sub

    Private Sub SaveEventLogToViewState()
        ' ViewStateは自動的に保存されるため、特別な処理は不要
        ' このメソッドは将来の拡張のためのプレースホルダー
    End Sub
End Class</code></pre>

                        <h6>実習手順</h6>
                        <ol>
                            <li>上記のコードでEventLifecycle.aspxを作成</li>
                            <li>ページを実行し、右側のイベントログを確認</li>
                            <li>各ボタンをクリックしてイベントの実行順序を観察</li>
                            <li>ドロップダウンリストを変更してAutoPostBackの動作を確認</li>
                            <li>チェックボックスで追加コントロールの表示/非表示を体験</li>
                            <li>PostBackカウンターが増加する仕組みを理解</li>
                        </ol>
                    </div>

                    <h3 class="section-title">3.4 AutoPostBackプロパティ</h3>
                    <p>一部のコントロールは、値が変更されたときに自動的にPostBackを発生させることができます。</p>

                    <pre class="code-block"><code class="language-vbnet">' AutoPostBackを使用したコントロール例
&lt;asp:DropDownList ID="ddlCategories" runat="server" AutoPostBack="true"&gt;
&lt;/asp:DropDownList&gt;

&lt;asp:CheckBox ID="chkAutoSave" runat="server" Text="自動保存" AutoPostBack="true" /&gt;

&lt;asp:TextBox ID="txtAutoComplete" runat="server" AutoPostBack="true" /&gt;

' 対応するイベントハンドラ
Protected Sub ddlCategories_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlCategories.SelectedIndexChanged
    ' ドロップダウンリストの選択が変更されたときの処理
End Sub

Protected Sub chkAutoSave_CheckedChanged(sender As Object, e As EventArgs) Handles chkAutoSave.CheckedChanged
    ' チェックボックスの状態が変更されたときの処理
End Sub

Protected Sub txtAutoComplete_TextChanged(sender As Object, e As EventArgs) Handles txtAutoComplete.TextChanged
    ' テキストボックスの内容が変更されたときの処理（フォーカスが外れたとき）
End Sub</code></pre>

                    <div class="warning">
                        <h6>⚠️ AutoPostBackの注意点</h6>
                        <ul>
                            <li><strong>パフォーマンス</strong>: 頻繁なPostBackはサーバー負荷とレスポンス時間に影響</li>
                            <li><strong>ユーザビリティ</strong>: 予期しないページ更新はユーザー体験を損なう可能性</li>
                            <li><strong>JavaScript無効</strong>: JavaScriptが無効な環境では動作しない</li>
                            <li><strong>データ消失</strong>: 未保存のデータが失われる可能性</li>
                        </ul>
                    </div>

                    <h3 class="section-title">3.5 ViewStateとコントロール状態</h3>
                    <p>ViewStateは、PostBack間でコントロールの状態を保持するメカニズムです。</p>

                    <pre class="code-block"><code class="language-vbnet">' ViewStateの明示的な使用例
Protected Sub btnSaveToViewState_Click(sender As Object, e As EventArgs)
    ' カスタムデータをViewStateに保存
    ViewState("UserData") = txtUserInput.Text
    ViewState("SaveTime") = DateTime.Now
    
    lblStatus.Text = "データがViewStateに保存されました"
End Sub

Protected Sub btnLoadFromViewState_Click(sender As Object, e As EventArgs)
    ' ViewStateからデータを復元
    If ViewState("UserData") IsNot Nothing Then
        txtDisplay.Text = ViewState("UserData").ToString()
        lblSaveTime.Text = $"保存時刻: {ViewState("SaveTime")}"
    Else
        lblStatus.Text = "ViewStateにデータが見つかりません"
    End If
End Sub

' Page_Loadでの状態管理
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    If Not IsPostBack Then
        ' 初回のみ初期化
        ViewState("VisitCount") = 0
    Else
        ' PostBack時はカウントアップ
        Dim count As Integer = CInt(ViewState("VisitCount"))
        count += 1
        ViewState("VisitCount") = count
    End If
    
    lblVisitCount.Text = $"このページの実行回数: {ViewState("VisitCount")}"
End Sub</code></pre>

                    <h3 class="section-title">3.6 JavaScript連携</h3>
                    <p>Web Formsでは、サーバーサイドの処理とクライアントサイドのJavaScriptを組み合わせることができます。</p>

                    <pre class="code-block"><code class="language-vbnet">' サーバーサイドからJavaScriptを実行
Protected Sub btnShowAlert_Click(sender As Object, e As EventArgs)
    Dim script As String = "alert('サーバーからのメッセージです！');"
    ClientScript.RegisterStartupScript(Me.GetType(), "ShowAlert", script, True)
End Sub

' 確認ダイアログとの連携
Protected Sub btnDeleteWithConfirm_Click(sender As Object, e As EventArgs)
    ' JavaScriptで確認ダイアログを表示してからPostBack
    Dim script As String = "return confirm('本当に削除しますか？');"
    btnDelete.Attributes.Add("onclick", script)
End Sub

' クライアントサイド検証
Protected Sub Page_Load(sender As Object, e As EventArgs) Handles Me.Load
    If Not IsPostBack Then
        ' 必須入力チェックのJavaScript
        Dim validationScript As String = "
            function validateForm() {
                var name = document.getElementById('" & txtName.ClientID & "').value;
                if (name.trim() === '') {
                    alert('名前を入力してください');
                    return false;
                }
                return true;
            }"
        
        ClientScript.RegisterClientScriptBlock(Me.GetType(), "ValidationScript", validationScript, True)
        btnSubmit.Attributes.Add("onclick", "return validateForm();")
    End If
End Sub</code></pre>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>初回ページアクセス時のみ実行される処理を判定するプロパティは何ですか？</li>
                            <li>ページライフサイクルで最も多く使用されるイベントは何ですか？</li>
                            <li>コントロールの値変更時に自動的にPostBackを発生させるプロパティは何ですか？</li>
                            <li>PostBack間でデータを保持するASP.NET固有の仕組みは何ですか？</li>
                            <li>DropDownListの選択項目が変更されたときに発生するイベントは何ですか？</li>
                            <li>サーバーサイドからクライアントサイドのJavaScriptを実行するために使用するオブジェクトは何ですか？</li>
                            <li>VB.NETコンソールアプリと異なり、Web Formsで採用されているプログラミングモデルは何ですか？</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>IsPostBack</li>
                                <li>Page_Load</li>
                                <li>AutoPostBack</li>
                                <li>ViewState</li>
                                <li>SelectedIndexChanged</li>
                                <li>ClientScript</li>
                                <li>イベントドリブンモデル</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-2.html" class="btn btn-secondary">← 前の章</a>
                        <a href="aspnet-vb-learning-material-4.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>