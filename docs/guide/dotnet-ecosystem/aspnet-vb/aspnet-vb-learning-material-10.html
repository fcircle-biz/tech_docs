<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET（VB.NET）学習教材 第10章 - 実践的なWebアプリケーション開発</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #512da8;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .chapter-title {
            color: #512da8;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #512da8;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #673ab7;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .quiz-container {
            background-color: #ede7f6;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #512da8;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .nav-link.active {
            background-color: #512da8 !important;
            color: white !important;
        }

        .best-practice {
            background-color: #e8f5e8;
            border: 1px solid #66bb6a;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .architecture-diagram {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>ASP.NET（VB.NET）学習教材</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学習章</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-1.html">
                                第1章: ASP.NET Web Forms入門と開発環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-2.html">
                                第2章: Web FormsとWebコントロール
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-3.html">
                                第3章: イベント処理とPostBack
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-4.html">
                                第4章: データ検証とエラーハンドリング
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-5.html">
                                第5章: 状態管理（Session、ViewState、Cache）
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-6.html">
                                第6章: データベース連携（ADO.NET）
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-7.html">
                                第7章: データバインドとGridView
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-8.html">
                                第8章: マスターページとナビゲーション
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="aspnet-vb-learning-material-9.html">
                                第9章: セキュリティとメンバーシップ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="aspnet-vb-learning-material-10.html">
                                第10章: 実践的なWebアプリケーション開発
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第10章: 実践的なWebアプリケーション開発</h1>
                </div>

                <div id="chapter10">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">完全な企業レベルWebアプリケーションの構築</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>3層アーキテクチャによる実践的なWebアプリケーション設計方法を習得する</li>
                            <li>社員管理システムの完全な実装を通じて統合的開発スキルを身につける</li>
                            <li>パフォーマンス最適化とスケーラビリティの実装技術を理解する</li>
                            <li>テスト戦略、ユニットテスト、統合テストの実装方法を学ぶ</li>
                            <li>デプロイメント、運用保守、監視の実践的手法を習得する</li>
                            <li>プロジェクト管理とチーム開発のベストプラクティスを理解する</li>
                        </ul>
                    </div>

                    <!-- セクション1: 3層アーキテクチャの設計理論 -->
                    <h3 class="section-title">10.1 3層アーキテクチャの設計理論と実装戦略</h3>
                    
                    <p><strong>3層アーキテクチャ（3-Tier Architecture）</strong>は、エンタープライズレベルのWebアプリケーション開発において最も重要な設計パターンの一つです。これまでの章で学習した技術を統合し、保守性、拡張性、再利用性を重視した本格的なアプリケーション構築を実現します。</p>
                    
                    <div class="highlight">
                        <h6>3層アーキテクチャが解決する企業レベルの課題</h6>
                        <ul>
                            <li><strong>保守性の問題</strong>：ビジネスロジックが画面に散在して修正が困難</li>
                            <li><strong>拡張性の制約</strong>：新機能追加時の既存機能への影響</li>
                            <li><strong>テスタビリティ</strong>：各層の独立したテストが困難</li>
                            <li><strong>再利用性の低さ</strong>：同じロジックの重複実装</li>
                            <li><strong>チーム開発の困難</strong>：役割分担が不明確</li>
                            <li><strong>技術変更への対応</strong>：データベースやUIの変更が全体に影響</li>
                        </ul>
                    </div>

                    <!-- 3層アーキテクチャ詳細図 -->
                    <div class="architecture-diagram">
                        <h6 class="text-center mb-3">3層アーキテクチャ構成図</h6>
                        <div class="mermaid">
                            graph TB
                                subgraph "プレゼンテーション層 (Presentation Layer)"
                                    A1[ASP.NET Web Forms]
                                    A2[マスターページ]
                                    A3[ユーザーコントロール]
                                    A4[JavaScript/CSS]
                                end
                                
                                subgraph "ビジネス論理層 (Business Logic Layer)"
                                    B1[ビジネスオブジェクト]
                                    B2[ビジネスルール]
                                    B3[ワークフロー制御]
                                    B4[データ検証]
                                    B5[トランザクション管理]
                                end
                                
                                subgraph "データアクセス層 (Data Access Layer)"
                                    C1[データアクセスオブジェクト]
                                    C2[SQL生成・実行]
                                    C3[接続管理]
                                    C4[例外処理]
                                end
                                
                                subgraph "データ層 (Data Layer)"
                                    D1[SQL Server データベース]
                                    D2[ストアドプロシージャ]
                                    D3[ビュー・インデックス]
                                end
                                
                                A1 --> B1
                                A2 --> B2
                                B1 --> C1
                                B2 --> C2
                                C1 --> D1
                                C2 --> D2
                        </div>
                    </div>

                    <div class="best-practice">
                        <h6><i class="fas fa-lightbulb"></i> 各層の責任と設計原則</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>層</th>
                                    <th>主要責任</th>
                                    <th>含むべきもの</th>
                                    <th>含むべきでないもの</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>プレゼンテーション層</strong></td>
                                    <td>UI、ユーザー操作</td>
                                    <td>画面制御、入力検証、表示ロジック</td>
                                    <td>ビジネスルール、DB接続</td>
                                </tr>
                                <tr>
                                    <td><strong>ビジネス論理層</strong></td>
                                    <td>業務ルール、処理制御</td>
                                    <td>業務ロジック、計算処理、承認フロー</td>
                                    <td>UI制御、SQL文</td>
                                </tr>
                                <tr>
                                    <td><strong>データアクセス層</strong></td>
                                    <td>データの保存・取得</td>
                                    <td>CRUD操作、DB接続管理</td>
                                    <td>業務ルール、UI制御</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- セクション2: 社員管理システムの要件分析と設計 -->
                    <h3 class="section-title">10.2 社員管理システムの要件分析と設計</h3>
                    
                    <p>実践的な学習として、企業で実際に使用されるレベルの<strong>社員管理システム</strong>を構築します。この系統だったアプローチにより、要件分析から設計、実装、テスト、デプロイまでの全工程を経験できます。</p>

                    <div class="highlight">
                        <h6>社員管理システムの機能要件</h6>
                        <h7><strong>基本機能（必須）</strong></h7>
                        <ul>
                            <li><strong>社員情報管理</strong>：登録、更新、削除、検索</li>
                            <li><strong>部署管理</strong>：部署の階層管理、部署別社員一覧</li>
                            <li><strong>ユーザー認証</strong>：ログイン、ログアウト、権限管理</li>
                            <li><strong>レポート機能</strong>：社員一覧、部署別統計、CSV出力</li>
                        </ul>
                        
                        <h7><strong>高度な機能（推奨）</strong></h7>
                        <ul>
                            <li><strong>写真管理</strong>：プロフィール写真のアップロード・表示</li>
                            <li><strong>履歴管理</strong>：人事異動、昇格履歴の追跡</li>
                            <li><strong>承認ワークフロー</strong>：情報変更の承認プロセス</li>
                            <li><strong>ダッシュボード</strong>：統計情報の可視化</li>
                        </ul>
                    </div>

                    <!-- データベース設計図 -->
                    <div class="architecture-diagram">
                        <h6 class="text-center mb-3">社員管理システム データベース設計</h6>
                        <div class="mermaid">
                            erDiagram
                                EMPLOYEES ||--o{ EMPLOYEE_HISTORY : has
                                EMPLOYEES }o--|| DEPARTMENTS : belongs_to
                                EMPLOYEES ||--o| EMPLOYEE_PHOTOS : has
                                DEPARTMENTS ||--o{ DEPARTMENTS : parent_of
                                USERS ||--|| EMPLOYEES : represents
                                USERS }o--|| USER_ROLES : has
                                
                                EMPLOYEES {
                                    int EmployeeID PK
                                    string EmployeeCode UK
                                    string FirstName
                                    string LastName
                                    string Email UK
                                    string PhoneNumber
                                    date HireDate
                                    int DepartmentID FK
                                    int PositionID FK
                                    decimal Salary
                                    boolean IsActive
                                    datetime CreatedDate
                                    datetime ModifiedDate
                                    string CreatedBy
                                    string ModifiedBy
                                }
                                
                                DEPARTMENTS {
                                    int DepartmentID PK
                                    string DepartmentName
                                    string DepartmentCode UK
                                    int ParentDepartmentID FK
                                    int ManagerEmployeeID FK
                                    boolean IsActive
                                    datetime CreatedDate
                                }
                                
                                POSITIONS {
                                    int PositionID PK
                                    string PositionName
                                    string PositionCode UK
                                    int Level
                                    decimal BaseSalary
                                    boolean IsActive
                                }
                                
                                EMPLOYEE_HISTORY {
                                    int HistoryID PK
                                    int EmployeeID FK
                                    string ChangeType
                                    string OldValue
                                    string NewValue
                                    datetime ChangeDate
                                    string ChangedBy
                                    string Reason
                                }
                                
                                EMPLOYEE_PHOTOS {
                                    int PhotoID PK
                                    int EmployeeID FK
                                    string FileName
                                    string ContentType
                                    byte[] PhotoData
                                    datetime UploadDate
                                }
                                
                                USERS {
                                    int UserID PK
                                    string UserName UK
                                    string Email UK
                                    string PasswordHash
                                    int EmployeeID FK
                                    boolean IsActive
                                    datetime LastLogin
                                    datetime CreatedDate
                                }
                                
                                USER_ROLES {
                                    int UserRoleID PK
                                    int UserID FK
                                    string RoleName
                                    datetime AssignedDate
                                    string AssignedBy
                                }
                        </div>
                    </div>

                    <!-- セクション3: データアクセス層の実装 -->
                    <h3 class="section-title">10.3 データアクセス層の実装</h3>
                    
                    <p>まず、最下位層であるデータアクセス層から実装を開始します。この層では、データベースとの接続、CRUD操作、例外処理を統一的に管理し、上位層に対して一貫したインターフェースを提供します。</p>

                    <!-- 実習1: データアクセス層の実装 -->
                    <div class="exercise-container">
                        <h5>実習 10-1: 企業レベルデータアクセス層の構築</h5>
                        <p>汎用性と保守性を重視したデータアクセス層を実装し、社員管理システムの基盤を構築しましょう。</p>
                        
                        <h6>手順1: 基底データアクセスクラスの作成</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/DataAccess/BaseDataAccess.vb
Imports System.Data.SqlClient
Imports System.Configuration

Public MustInherit Class BaseDataAccess
    ' 接続文字列を取得
    Protected ReadOnly Property ConnectionString As String
        Get
            Return ConfigurationManager.ConnectionStrings("EmployeeManagementDB").ConnectionString
        End Get
    End Property
    
    ' 汎用データ取得メソッド
    Protected Function ExecuteDataTable(sql As String, Optional parameters As SqlParameter() = Nothing) As DataTable
        Dim dataTable As New DataTable()
        
        Try
            Using connection As New SqlConnection(ConnectionString)
                Using command As New SqlCommand(sql, connection)
                    ' パラメータを追加
                    If parameters IsNot Nothing Then
                        command.Parameters.AddRange(parameters)
                    End If
                    
                    connection.Open()
                    Using adapter As New SqlDataAdapter(command)
                        adapter.Fill(dataTable)
                    End Using
                End Using
            End Using
        Catch ex As Exception
            LogError("ExecuteDataTable", sql, ex)
            Throw New ApplicationException("データの取得中にエラーが発生しました。", ex)
        End Try
        
        Return dataTable
    End Function
    
    ' 汎用実行メソッド（INSERT、UPDATE、DELETE）
    Protected Function ExecuteNonQuery(sql As String, Optional parameters As SqlParameter() = Nothing) As Integer
        Dim rowsAffected As Integer = 0
        
        Try
            Using connection As New SqlConnection(ConnectionString)
                Using command As New SqlCommand(sql, connection)
                    If parameters IsNot Nothing Then
                        command.Parameters.AddRange(parameters)
                    End If
                    
                    connection.Open()
                    rowsAffected = command.ExecuteNonQuery()
                End Using
            End Using
        Catch ex As Exception
            LogError("ExecuteNonQuery", sql, ex)
            Throw New ApplicationException("データの更新中にエラーが発生しました。", ex)
        End Try
        
        Return rowsAffected
    End Function
    
    ' スカラー値取得メソッド
    Protected Function ExecuteScalar(sql As String, Optional parameters As SqlParameter() = Nothing) As Object
        Dim result As Object = Nothing
        
        Try
            Using connection As New SqlConnection(ConnectionString)
                Using command As New SqlCommand(sql, connection)
                    If parameters IsNot Nothing Then
                        command.Parameters.AddRange(parameters)
                    End If
                    
                    connection.Open()
                    result = command.ExecuteScalar()
                End Using
            End Using
        Catch ex As Exception
            LogError("ExecuteScalar", sql, ex)
            Throw New ApplicationException("データの取得中にエラーが発生しました。", ex)
        End Try
        
        Return result
    End Function
    
    ' トランザクション付き実行メソッド
    Protected Function ExecuteTransaction(commands As List(Of SqlCommandInfo)) As Boolean
        Try
            Using connection As New SqlConnection(ConnectionString)
                connection.Open()
                Using transaction As SqlTransaction = connection.BeginTransaction()
                    Try
                        For Each cmdInfo As SqlCommandInfo In commands
                            Using command As New SqlCommand(cmdInfo.Sql, connection, transaction)
                                If cmdInfo.Parameters IsNot Nothing Then
                                    command.Parameters.AddRange(cmdInfo.Parameters)
                                End If
                                command.ExecuteNonQuery()
                            End Using
                        Next
                        
                        transaction.Commit()
                        Return True
                    Catch ex As Exception
                        transaction.Rollback()
                        LogError("ExecuteTransaction", "Multiple Commands", ex)
                        Throw
                    End Try
                End Using
            End Using
        Catch ex As Exception
            Throw New ApplicationException("トランザクションの実行中にエラーが発生しました。", ex)
        End Try
    End Function
    
    ' SQLパラメータ作成ヘルパー
    Protected Function CreateParameter(parameterName As String, value As Object, Optional dbType As SqlDbType = SqlDbType.NVarChar) As SqlParameter
        Dim parameter As New SqlParameter(parameterName, dbType)
        parameter.Value = If(value, DBNull.Value)
        Return parameter
    End Function
    
    ' エラーログ記録
    Private Sub LogError(methodName As String, sql As String, ex As Exception)
        ' 実装例：データベース、ファイル、EventLogへのエラー記録
        Dim errorMessage As String = $"Method: {methodName}, SQL: {sql}, Error: {ex.Message}, StackTrace: {ex.StackTrace}"
        
        Try
            ' EventLogに記録
            Dim eventLog As New EventLog("Application")
            eventLog.Source = "EmployeeManagement"
            eventLog.WriteEntry(errorMessage, EventLogEntryType.Error)
        Catch
            ' ログ記録エラーは無視
        End Try
    End Sub
End Class

' SQLコマンド情報を格納するクラス
Public Class SqlCommandInfo
    Public Property Sql As String
    Public Property Parameters As SqlParameter()
    
    Public Sub New(sql As String, Optional parameters As SqlParameter() = Nothing)
        Me.Sql = sql
        Me.Parameters = parameters
    End Sub
End Class</code></pre>

                        <h6>手順2: 社員データアクセスクラス</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/DataAccess/EmployeeDataAccess.vb
Public Class EmployeeDataAccess
    Inherits BaseDataAccess
    
    ' 全社員取得
    Public Function GetAllEmployees() As DataTable
        Dim sql As String = "
            SELECT 
                e.EmployeeID, e.EmployeeCode, e.FirstName, e.LastName, 
                e.Email, e.PhoneNumber, e.HireDate, e.Salary, e.IsActive,
                d.DepartmentName, p.PositionName
            FROM Employees e
            LEFT JOIN Departments d ON e.DepartmentID = d.DepartmentID
            LEFT JOIN Positions p ON e.PositionID = p.PositionID
            WHERE e.IsActive = 1
            ORDER BY e.EmployeeCode"
        
        Return ExecuteDataTable(sql)
    End Function
    
    ' 社員ID別取得
    Public Function GetEmployeeById(employeeId As Integer) As DataTable
        Dim sql As String = "
            SELECT 
                e.*, d.DepartmentName, p.PositionName
            FROM Employees e
            LEFT JOIN Departments d ON e.DepartmentID = d.DepartmentID
            LEFT JOIN Positions p ON e.PositionID = p.PositionID
            WHERE e.EmployeeID = @EmployeeID"
        
        Dim parameters() As SqlParameter = {
            CreateParameter("@EmployeeID", employeeId, SqlDbType.Int)
        }
        
        Return ExecuteDataTable(sql, parameters)
    End Function
    
    ' 部署別社員取得
    Public Function GetEmployeesByDepartment(departmentId As Integer) As DataTable
        Dim sql As String = "
            SELECT 
                e.EmployeeID, e.EmployeeCode, e.FirstName, e.LastName, 
                e.Email, e.HireDate, p.PositionName, e.Salary
            FROM Employees e
            LEFT JOIN Positions p ON e.PositionID = p.PositionID
            WHERE e.DepartmentID = @DepartmentID AND e.IsActive = 1
            ORDER BY p.Level DESC, e.HireDate"
        
        Dim parameters() As SqlParameter = {
            CreateParameter("@DepartmentID", departmentId, SqlDbType.Int)
        }
        
        Return ExecuteDataTable(sql, parameters)
    End Function
    
    ' 社員検索
    Public Function SearchEmployees(searchText As String, departmentId As Integer?, isActive As Boolean?) As DataTable
        Dim whereConditions As New List(Of String)()
        Dim parameters As New List(Of SqlParameter)()
        
        Dim sql As String = "
            SELECT 
                e.EmployeeID, e.EmployeeCode, e.FirstName, e.LastName, 
                e.Email, e.PhoneNumber, e.HireDate, e.Salary, e.IsActive,
                d.DepartmentName, p.PositionName
            FROM Employees e
            LEFT JOIN Departments d ON e.DepartmentID = d.DepartmentID
            LEFT JOIN Positions p ON e.PositionID = p.PositionID"
        
        ' 検索条件の構築
        If Not String.IsNullOrEmpty(searchText) Then
            whereConditions.Add("(e.FirstName LIKE @SearchText OR e.LastName LIKE @SearchText OR e.Email LIKE @SearchText OR e.EmployeeCode LIKE @SearchText)")
            parameters.Add(CreateParameter("@SearchText", "%" & searchText & "%", SqlDbType.NVarChar))
        End If
        
        If departmentId.HasValue Then
            whereConditions.Add("e.DepartmentID = @DepartmentID")
            parameters.Add(CreateParameter("@DepartmentID", departmentId.Value, SqlDbType.Int))
        End If
        
        If isActive.HasValue Then
            whereConditions.Add("e.IsActive = @IsActive")
            parameters.Add(CreateParameter("@IsActive", isActive.Value, SqlDbType.Bit))
        End If
        
        If whereConditions.Count > 0 Then
            sql &= " WHERE " & String.Join(" AND ", whereConditions)
        End If
        
        sql &= " ORDER BY e.EmployeeCode"
        
        Return ExecuteDataTable(sql, parameters.ToArray())
    End Function
    
    ' 社員登録
    Public Function InsertEmployee(employee As Employee) As Integer
        Dim sql As String = "
            INSERT INTO Employees 
            (EmployeeCode, FirstName, LastName, Email, PhoneNumber, 
             HireDate, DepartmentID, PositionID, Salary, IsActive, 
             CreatedDate, CreatedBy)
            VALUES 
            (@EmployeeCode, @FirstName, @LastName, @Email, @PhoneNumber, 
             @HireDate, @DepartmentID, @PositionID, @Salary, @IsActive, 
             @CreatedDate, @CreatedBy);
            SELECT SCOPE_IDENTITY();"
        
        Dim parameters() As SqlParameter = {
            CreateParameter("@EmployeeCode", employee.EmployeeCode, SqlDbType.NVarChar),
            CreateParameter("@FirstName", employee.FirstName, SqlDbType.NVarChar),
            CreateParameter("@LastName", employee.LastName, SqlDbType.NVarChar),
            CreateParameter("@Email", employee.Email, SqlDbType.NVarChar),
            CreateParameter("@PhoneNumber", employee.PhoneNumber, SqlDbType.NVarChar),
            CreateParameter("@HireDate", employee.HireDate, SqlDbType.DateTime),
            CreateParameter("@DepartmentID", employee.DepartmentID, SqlDbType.Int),
            CreateParameter("@PositionID", employee.PositionID, SqlDbType.Int),
            CreateParameter("@Salary", employee.Salary, SqlDbType.Decimal),
            CreateParameter("@IsActive", True, SqlDbType.Bit),
            CreateParameter("@CreatedDate", DateTime.Now, SqlDbType.DateTime),
            CreateParameter("@CreatedBy", employee.CreatedBy, SqlDbType.NVarChar)
        }
        
        Dim newId As Object = ExecuteScalar(sql, parameters)
        Return Convert.ToInt32(newId)
    End Function
    
    ' 社員更新
    Public Function UpdateEmployee(employee As Employee) As Boolean
        ' 履歴記録と本体更新をトランザクションで実行
        Dim commands As New List(Of SqlCommandInfo)()
        
        ' 履歴記録用SQL
        Dim historySQL As String = "
            INSERT INTO EmployeeHistory 
            (EmployeeID, ChangeType, ChangeDate, ChangedBy, Reason)
            VALUES (@EmployeeID, 'UPDATE', @ChangeDate, @ChangedBy, @Reason)"
        
        Dim historyParams() As SqlParameter = {
            CreateParameter("@EmployeeID", employee.EmployeeID, SqlDbType.Int),
            CreateParameter("@ChangeDate", DateTime.Now, SqlDbType.DateTime),
            CreateParameter("@ChangedBy", employee.ModifiedBy, SqlDbType.NVarChar),
            CreateParameter("@Reason", "Employee information updated", SqlDbType.NVarChar)
        }
        
        commands.Add(New SqlCommandInfo(historySQL, historyParams))
        
        ' 本体更新用SQL
        Dim updateSQL As String = "
            UPDATE Employees SET 
                FirstName = @FirstName, LastName = @LastName, 
                Email = @Email, PhoneNumber = @PhoneNumber,
                DepartmentID = @DepartmentID, PositionID = @PositionID, 
                Salary = @Salary, ModifiedDate = @ModifiedDate, 
                ModifiedBy = @ModifiedBy
            WHERE EmployeeID = @EmployeeID"
        
        Dim updateParams() As SqlParameter = {
            CreateParameter("@EmployeeID", employee.EmployeeID, SqlDbType.Int),
            CreateParameter("@FirstName", employee.FirstName, SqlDbType.NVarChar),
            CreateParameter("@LastName", employee.LastName, SqlDbType.NVarChar),
            CreateParameter("@Email", employee.Email, SqlDbType.NVarChar),
            CreateParameter("@PhoneNumber", employee.PhoneNumber, SqlDbType.NVarChar),
            CreateParameter("@DepartmentID", employee.DepartmentID, SqlDbType.Int),
            CreateParameter("@PositionID", employee.PositionID, SqlDbType.Int),
            CreateParameter("@Salary", employee.Salary, SqlDbType.Decimal),
            CreateParameter("@ModifiedDate", DateTime.Now, SqlDbType.DateTime),
            CreateParameter("@ModifiedBy", employee.ModifiedBy, SqlDbType.NVarChar)
        }
        
        commands.Add(New SqlCommandInfo(updateSQL, updateParams))
        
        Return ExecuteTransaction(commands)
    End Function
    
    ' 社員削除（論理削除）
    Public Function DeleteEmployee(employeeId As Integer, deletedBy As String) As Boolean
        Dim commands As New List(Of SqlCommandInfo)()
        
        ' 履歴記録
        Dim historySQL As String = "
            INSERT INTO EmployeeHistory 
            (EmployeeID, ChangeType, ChangeDate, ChangedBy, Reason)
            VALUES (@EmployeeID, 'DELETE', @ChangeDate, @ChangedBy, @Reason)"
        
        Dim historyParams() As SqlParameter = {
            CreateParameter("@EmployeeID", employeeId, SqlDbType.Int),
            CreateParameter("@ChangeDate", DateTime.Now, SqlDbType.DateTime),
            CreateParameter("@ChangedBy", deletedBy, SqlDbType.NVarChar),
            CreateParameter("@Reason", "Employee deactivated", SqlDbType.NVarChar)
        }
        
        commands.Add(New SqlCommandInfo(historySQL, historyParams))
        
        ' 論理削除
        Dim deleteSQL As String = "
            UPDATE Employees SET 
                IsActive = 0, 
                ModifiedDate = @ModifiedDate, 
                ModifiedBy = @ModifiedBy
            WHERE EmployeeID = @EmployeeID"
        
        Dim deleteParams() As SqlParameter = {
            CreateParameter("@EmployeeID", employeeId, SqlDbType.Int),
            CreateParameter("@ModifiedDate", DateTime.Now, SqlDbType.DateTime),
            CreateParameter("@ModifiedBy", deletedBy, SqlDbType.NVarChar)
        }
        
        commands.Add(New SqlCommandInfo(deleteSQL, deleteParams))
        
        Return ExecuteTransaction(commands)
    End Function
    
    ' メールアドレスの重複チェック
    Public Function IsEmailExists(email As String, Optional excludeEmployeeId As Integer? = Nothing) As Boolean
        Dim sql As String = "SELECT COUNT(*) FROM Employees WHERE Email = @Email AND IsActive = 1"
        Dim parameters As New List(Of SqlParameter)()
        
        parameters.Add(CreateParameter("@Email", email, SqlDbType.NVarChar))
        
        If excludeEmployeeId.HasValue Then
            sql &= " AND EmployeeID <> @ExcludeEmployeeID"
            parameters.Add(CreateParameter("@ExcludeEmployeeID", excludeEmployeeId.Value, SqlDbType.Int))
        End If
        
        Dim count As Integer = Convert.ToInt32(ExecuteScalar(sql, parameters.ToArray()))
        Return count > 0
    End Function
    
    ' 社員コードの生成
    Public Function GenerateEmployeeCode() As String
        Dim sql As String = "SELECT MAX(CAST(RIGHT(EmployeeCode, 4) AS INT)) FROM Employees WHERE EmployeeCode LIKE 'EMP%'"
        Dim maxNumber As Object = ExecuteScalar(sql)
        
        Dim nextNumber As Integer = If(IsDBNull(maxNumber) OrElse maxNumber Is Nothing, 1, Convert.ToInt32(maxNumber) + 1)
        Return "EMP" & nextNumber.ToString("D4")
    End Function
End Class</code></pre>

                        <h6>実装のポイント</h6>
                        <ul>
                            <li><strong>継承活用</strong>：BaseDataAccessで共通処理を統一</li>
                            <li><strong>トランザクション管理</strong>：データ整合性の確保</li>
                            <li><strong>エラーハンドリング</strong>：包括的な例外処理とログ記録</li>
                            <li><strong>セキュリティ対策</strong>：パラメータ化クエリでSQLインジェクション防止</li>
                            <li><strong>パフォーマンス</strong>：接続の適切な管理とリソース解放</li>
                        </ul>
                    </div>

                    <!-- セクション4: ビジネス論理層の実装 -->
                    <h3 class="section-title">10.4 ビジネス論理層の実装</h3>
                    
                    <p>ビジネス論理層では、アプリケーションの中核となる業務ルール、データ検証、ワークフロー制御を実装します。この層は、プレゼンテーション層とデータアクセス層の間に位置し、システムの価値を決定する重要な役割を担います。</p>

                    <!-- 実習2: ビジネス論理層の実装 -->
                    <div class="exercise-container">
                        <h5>実習 10-2: 堅牢なビジネス論理層の構築</h5>
                        <p>業務ルール、検証ロジック、ワークフローを含む完全なビジネス論理層を実装してみましょう。</p>
                        
                        <h6>手順1: エンティティクラスの定義</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/Entities/Employee.vb
Public Class Employee
    Public Property EmployeeID As Integer
    Public Property EmployeeCode As String
    Public Property FirstName As String
    Public Property LastName As String
    Public Property Email As String
    Public Property PhoneNumber As String
    Public Property HireDate As DateTime
    Public Property DepartmentID As Integer
    Public Property PositionID As Integer
    Public Property Salary As Decimal
    Public Property IsActive As Boolean
    
    ' 関連情報
    Public Property DepartmentName As String
    Public Property PositionName As String
    
    ' 監査情報
    Public Property CreatedDate As DateTime
    Public Property CreatedBy As String
    Public Property ModifiedDate As DateTime?
    Public Property ModifiedBy As String
    
    ' 計算プロパティ
    Public ReadOnly Property FullName As String
        Get
            Return $"{FirstName} {LastName}".Trim()
        End Get
    End Property
    
    Public ReadOnly Property YearsOfService As Integer
        Get
            Return DateTime.Now.Year - HireDate.Year
        End Get
    End Property
    
    ' コンストラクタ
    Public Sub New()
        ' 初期値設定
        HireDate = DateTime.Today
        IsActive = True
        CreatedDate = DateTime.Now
        Salary = 0
    End Sub
    
    Public Sub New(employeeCode As String, firstName As String, lastName As String, email As String)
        Me.New()
        Me.EmployeeCode = employeeCode
        Me.FirstName = firstName
        Me.LastName = lastName
        Me.Email = email
    End Sub
End Class

' App_Code/Entities/Department.vb
Public Class Department
    Public Property DepartmentID As Integer
    Public Property DepartmentName As String
    Public Property DepartmentCode As String
    Public Property ParentDepartmentID As Integer?
    Public Property ManagerEmployeeID As Integer?
    Public Property IsActive As Boolean
    Public Property CreatedDate As DateTime
    
    ' 関連情報
    Public Property ParentDepartmentName As String
    Public Property ManagerName As String
    Public Property EmployeeCount As Integer
    
    Public Sub New()
        IsActive = True
        CreatedDate = DateTime.Now
    End Sub
End Class

' App_Code/Entities/Position.vb
Public Class Position
    Public Property PositionID As Integer
    Public Property PositionName As String
    Public Property PositionCode As String
    Public Property Level As Integer
    Public Property BaseSalary As Decimal
    Public Property IsActive As Boolean
    
    Public Sub New()
        IsActive = True
        Level = 1
        BaseSalary = 0
    End Sub
End Class</code></pre>

                        <h6>手順2: ビジネスルールクラス</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/BusinessLogic/EmployeeBusinessRules.vb
Public Class EmployeeBusinessRules
    ' 給与範囲の定数
    Private Const MIN_SALARY As Decimal = 200000 ' 20万円
    Private Const MAX_SALARY As Decimal = 20000000 ' 2000万円
    
    ' 入社日の制限
    Private Const MAX_FUTURE_HIRE_DAYS As Integer = 30
    Private Const MIN_HIRE_YEAR As Integer = 1970
    
    ' 社員登録の業務ルール検証
    Public Shared Function ValidateEmployeeForInsert(employee As Employee) As ValidationResult
        Dim result As New ValidationResult()
        
        ' 基本項目の検証
        If String.IsNullOrWhiteSpace(employee.FirstName) Then
            result.AddError("FirstName", "名前は必須です。")
        ElseIf employee.FirstName.Length > 50 Then
            result.AddError("FirstName", "名前は50文字以内で入力してください。")
        End If
        
        If String.IsNullOrWhiteSpace(employee.LastName) Then
            result.AddError("LastName", "姓は必須です。")
        ElseIf employee.LastName.Length > 50 Then
            result.AddError("LastName", "姓は50文字以内で入力してください。")
        End If
        
        ' メールアドレスの検証
        ValidateEmail(employee.Email, result)
        
        ' 電話番号の検証
        ValidatePhoneNumber(employee.PhoneNumber, result)
        
        ' 入社日の検証
        ValidateHireDate(employee.HireDate, result)
        
        ' 給与の検証
        ValidateSalary(employee.Salary, result)
        
        ' 部署・職位の検証
        ValidateDepartmentAndPosition(employee.DepartmentID, employee.PositionID, result)
        
        Return result
    End Function
    
    ' 社員更新の業務ルール検証
    Public Shared Function ValidateEmployeeForUpdate(employee As Employee) As ValidationResult
        Dim result As ValidationResult = ValidateEmployeeForInsert(employee)
        
        ' 更新固有の検証
        If employee.EmployeeID <= 0 Then
            result.AddError("EmployeeID", "更新対象の社員IDが無効です。")
        End If
        
        ' 既存社員の存在確認
        If Not IsEmployeeExists(employee.EmployeeID) Then
            result.AddError("EmployeeID", "指定された社員が存在しません。")
        End If
        
        Return result
    End Function
    
    ' メールアドレス検証
    Private Shared Sub ValidateEmail(email As String, result As ValidationResult)
        If String.IsNullOrWhiteSpace(email) Then
            result.AddError("Email", "メールアドレスは必須です。")
            Return
        End If
        
        If email.Length > 100 Then
            result.AddError("Email", "メールアドレスは100文字以内で入力してください。")
            Return
        End If
        
        ' 基本的なメール形式チェック
        Dim emailPattern As String = "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
        If Not System.Text.RegularExpressions.Regex.IsMatch(email, emailPattern) Then
            result.AddError("Email", "有効なメールアドレス形式で入力してください。")
        End If
        
        ' 会社ドメインチェック（業務ルール例）
        Dim allowedDomains() As String = {"company.com", "subsidiary.com", "partner.com"}
        Dim domain As String = email.Split("@"c).LastOrDefault()
        If Not String.IsNullOrEmpty(domain) AndAlso Not allowedDomains.Contains(domain.ToLower()) Then
            result.AddWarning("Email", $"推奨ドメイン外のメールアドレスです: {domain}")
        End If
    End Sub
    
    ' 電話番号検証
    Private Shared Sub ValidatePhoneNumber(phoneNumber As String, result As ValidationResult)
        If String.IsNullOrWhiteSpace(phoneNumber) Then
            result.AddError("PhoneNumber", "電話番号は必須です。")
            Return
        End If
        
        ' ハイフンを除去して数字のみチェック
        Dim digitsOnly As String = System.Text.RegularExpressions.Regex.Replace(phoneNumber, "[^\d]", "")
        
        If digitsOnly.Length < 10 OrElse digitsOnly.Length > 11 Then
            result.AddError("PhoneNumber", "電話番号は10桁または11桁で入力してください。")
        End If
        
        ' 日本の電話番号パターンチェック
        Dim phonePattern As String = "^0\d{1,4}-\d{1,4}-\d{4}$"
        If Not System.Text.RegularExpressions.Regex.IsMatch(phoneNumber, phonePattern) Then
            result.AddWarning("PhoneNumber", "電話番号の形式を確認してください（例：03-1234-5678）。")
        End If
    End Sub
    
    ' 入社日検証
    Private Shared Sub ValidateHireDate(hireDate As DateTime, result As ValidationResult)
        ' 過去の制限
        If hireDate.Year < MIN_HIRE_YEAR Then
            result.AddError("HireDate", $"入社日は{MIN_HIRE_YEAR}年以降で入力してください。")
        End If
        
        ' 未来の制限
        If hireDate > DateTime.Today.AddDays(MAX_FUTURE_HIRE_DAYS) Then
            result.AddError("HireDate", $"入社日は{MAX_FUTURE_HIRE_DAYS}日後までの日付で入力してください。")
        End If
        
        ' 土日チェック（警告）
        If hireDate.DayOfWeek = DayOfWeek.Saturday OrElse hireDate.DayOfWeek = DayOfWeek.Sunday Then
            result.AddWarning("HireDate", "入社日が土日になっています。")
        End If
    End Sub
    
    ' 給与検証
    Private Shared Sub ValidateSalary(salary As Decimal, result As ValidationResult)
        If salary < MIN_SALARY Then
            result.AddError("Salary", $"給与は{MIN_SALARY:C0}以上で入力してください。")
        ElseIf salary > MAX_SALARY Then
            result.AddError("Salary", $"給与は{MAX_SALARY:C0}以下で入力してください。")
        End If
        
        ' 給与の妥当性チェック（万円単位でない場合は警告）
        If salary Mod 10000 <> 0 Then
            result.AddWarning("Salary", "給与は万円単位での入力を推奨します。")
        End If
    End Sub
    
    ' 部署・職位検証
    Private Shared Sub ValidateDepartmentAndPosition(departmentId As Integer, positionId As Integer, result As ValidationResult)
        If departmentId <= 0 Then
            result.AddError("DepartmentID", "部署を選択してください。")
        End If
        
        If positionId <= 0 Then
            result.AddError("PositionID", "職位を選択してください。")
        End If
        
        ' 部署と職位の組み合わせチェック（業務ルール例）
        If Not IsValidDepartmentPositionCombination(departmentId, positionId) Then
            result.AddWarning("PositionID", "選択された部署と職位の組み合わせを確認してください。")
        End If
    End Sub
    
    ' 給与計算の業務ルール
    Public Shared Function CalculateAnnualSalary(monthlySalary As Decimal, Optional bonusMonths As Decimal = 2) As Decimal
        If monthlySalary < 0 Then
            Throw New ArgumentException("月給は0以上である必要があります。")
        End If
        
        Return monthlySalary * (12 + bonusMonths)
    End Function
    
    ' 昇格チェック
    Public Shared Function IsEligibleForPromotion(employee As Employee) As PromotionEligibility
        Dim eligibility As New PromotionEligibility()
        eligibility.EmployeeID = employee.EmployeeID
        eligibility.IsEligible = True
        
        ' 勤続年数チェック
        If employee.YearsOfService < 2 Then
            eligibility.IsEligible = False
            eligibility.Reasons.Add("勤続年数が2年未満です。")
        End If
        
        ' パフォーマンス評価チェック（ここでは省略、実際は評価データから取得）
        Dim performanceScore As Double = GetPerformanceScore(employee.EmployeeID)
        If performanceScore < 3.5 Then
            eligibility.IsEligible = False
            eligibility.Reasons.Add($"パフォーマンス評価が基準値（3.5）を下回ります。現在値: {performanceScore}")
        End If
        
        ' 現在の職位レベルチェック
        Dim currentPosition As Position = GetPositionById(employee.PositionID)
        If currentPosition.Level >= 5 Then
            eligibility.IsEligible = False
            eligibility.Reasons.Add("最高職位レベルに到達しています。")
        End If
        
        If eligibility.IsEligible Then
            eligibility.Reasons.Add("昇格要件を満たしています。")
            eligibility.RecommendedPositionLevel = currentPosition.Level + 1
        End If
        
        Return eligibility
    End Function
    
    ' ヘルパーメソッド群
    Private Shared Function IsEmployeeExists(employeeId As Integer) As Boolean
        Dim dataAccess As New EmployeeDataAccess()
        Dim dt As DataTable = dataAccess.GetEmployeeById(employeeId)
        Return dt.Rows.Count > 0
    End Function
    
    Private Shared Function IsValidDepartmentPositionCombination(departmentId As Integer, positionId As Integer) As Boolean
        ' 実装例：特定の部署では特定の職位のみ許可
        ' ここでは簡略化してTrue
        Return True
    End Function
    
    Private Shared Function GetPerformanceScore(employeeId As Integer) As Double
        ' 実装例：パフォーマンス評価システムからスコア取得
        ' ここでは固定値を返す
        Return 4.0
    End Function
    
    Private Shared Function GetPositionById(positionId As Integer) As Position
        ' 実装例：職位マスタから取得
        Return New Position() With {.PositionID = positionId, .Level = 2}
    End Function
End Class

' 検証結果クラス
Public Class ValidationResult
    Public Property IsValid As Boolean
    Public Property Errors As New List(Of ValidationMessage)()
    Public Property Warnings As New List(Of ValidationMessage)()
    
    Public ReadOnly Property HasErrors As Boolean
        Get
            Return Errors.Count > 0
        End Get
    End Property
    
    Public ReadOnly Property HasWarnings As Boolean
        Get
            Return Warnings.Count > 0
        End Get
    End Property
    
    Public Sub AddError(fieldName As String, message As String)
        Errors.Add(New ValidationMessage(fieldName, message))
        IsValid = False
    End Sub
    
    Public Sub AddWarning(fieldName As String, message As String)
        Warnings.Add(New ValidationMessage(fieldName, message))
    End Sub
    
    Public Function GetErrorMessages() As String()
        Return Errors.Select(Function(e) e.Message).ToArray()
    End Function
    
    Public Function GetWarningMessages() As String()
        Return Warnings.Select(Function(w) w.Message).ToArray()
    End Function
End Class

Public Class ValidationMessage
    Public Property FieldName As String
    Public Property Message As String
    
    Public Sub New(fieldName As String, message As String)
        Me.FieldName = fieldName
        Me.Message = message
    End Sub
End Class

' 昇格判定結果クラス
Public Class PromotionEligibility
    Public Property EmployeeID As Integer
    Public Property IsEligible As Boolean
    Public Property Reasons As New List(Of String)()
    Public Property RecommendedPositionLevel As Integer
End Class</code></pre>

                        <h6>手順3: ビジネスサービスクラス</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/BusinessLogic/EmployeeService.vb
Public Class EmployeeService
    Private ReadOnly _dataAccess As EmployeeDataAccess
    Private ReadOnly _departmentDataAccess As DepartmentDataAccess
    Private ReadOnly _positionDataAccess As PositionDataAccess
    
    Public Sub New()
        _dataAccess = New EmployeeDataAccess()
        _departmentDataAccess = New DepartmentDataAccess()
        _positionDataAccess = New PositionDataAccess()
    End Sub
    
    ' 社員一覧取得（ビジネスロジック付き）
    Public Function GetEmployees(Optional includeInactive As Boolean = False) As List(Of Employee)
        Dim dataTable As DataTable = _dataAccess.GetAllEmployees()
        Dim employees As New List(Of Employee)()
        
        For Each row As DataRow In dataTable.Rows
            Dim employee As Employee = ConvertDataRowToEmployee(row)
            
            ' ビジネスルール：非アクティブ社員の含有判定
            If includeInactive OrElse employee.IsActive Then
                employees.Add(employee)
            End If
        Next
        
        ' ビジネスルール：デフォルトソート（社員コード昇順）
        Return employees.OrderBy(Function(e) e.EmployeeCode).ToList()
    End Function
    
    ' 社員詳細取得
    Public Function GetEmployeeById(employeeId As Integer) As Employee
        If employeeId <= 0 Then
            Throw New ArgumentException("社員IDが無効です。", NameOf(employeeId))
        End If
        
        Dim dataTable As DataTable = _dataAccess.GetEmployeeById(employeeId)
        If dataTable.Rows.Count = 0 Then
            Return Nothing
        End If
        
        Return ConvertDataRowToEmployee(dataTable.Rows(0))
    End Function
    
    ' 社員登録（フルビジネスロジック）
    Public Function CreateEmployee(employee As Employee, createdBy As String) As ServiceResult(Of Integer)
        Dim result As New ServiceResult(Of Integer)()
        
        Try
            ' 入力検証
            Dim validationResult As ValidationResult = EmployeeBusinessRules.ValidateEmployeeForInsert(employee)
            If Not validationResult.IsValid Then
                result.Success = False
                result.Errors.AddRange(validationResult.GetErrorMessages())
                result.Warnings.AddRange(validationResult.GetWarningMessages())
                Return result
            End If
            
            ' 重複チェック
            If _dataAccess.IsEmailExists(employee.Email) Then
                result.Success = False
                result.Errors.Add("指定されたメールアドレスは既に使用されています。")
                Return result
            End If
            
            ' 社員コード生成
            If String.IsNullOrEmpty(employee.EmployeeCode) Then
                employee.EmployeeCode = _dataAccess.GenerateEmployeeCode()
            End If
            
            ' 監査情報設定
            employee.CreatedBy = createdBy
            employee.CreatedDate = DateTime.Now
            
            ' データ登録
            Dim newEmployeeId As Integer = _dataAccess.InsertEmployee(employee)
            
            result.Success = True
            result.Data = newEmployeeId
            result.Message = $"社員 '{employee.FullName}' (ID: {newEmployeeId}) が正常に登録されました。"
            
            ' 警告がある場合は追加
            If validationResult.HasWarnings Then
                result.Warnings.AddRange(validationResult.GetWarningMessages())
            End If
            
            ' 業務ルール：新入社員向け自動処理
            ScheduleNewEmployeeOnboarding(newEmployeeId)
            
        Catch ex As Exception
            result.Success = False
            result.Errors.Add($"社員登録中にエラーが発生しました: {ex.Message}")
            LogError("CreateEmployee", ex)
        End Try
        
        Return result
    End Function
    
    ' 社員更新
    Public Function UpdateEmployee(employee As Employee, modifiedBy As String) As ServiceResult(Of Boolean)
        Dim result As New ServiceResult(Of Boolean)()
        
        Try
            ' 入力検証
            Dim validationResult As ValidationResult = EmployeeBusinessRules.ValidateEmployeeForUpdate(employee)
            If Not validationResult.IsValid Then
                result.Success = False
                result.Errors.AddRange(validationResult.GetErrorMessages())
                Return result
            End If
            
            ' 既存データ取得
            Dim existingEmployee As Employee = GetEmployeeById(employee.EmployeeID)
            If existingEmployee Is Nothing Then
                result.Success = False
                result.Errors.Add("更新対象の社員が見つかりません。")
                Return result
            End If
            
            ' 重複チェック（自分以外）
            If _dataAccess.IsEmailExists(employee.Email, employee.EmployeeID) Then
                result.Success = False
                result.Errors.Add("指定されたメールアドレスは他の社員によって使用されています。")
                Return result
            End If
            
            ' 業務ルール：重要項目変更の承認チェック
            If RequiresApprovalForUpdate(existingEmployee, employee) Then
                result.Success = False
                result.Errors.Add("重要項目の変更には承認が必要です。承認ワークフローを開始してください。")
                Return result
            End If
            
            ' 監査情報設定
            employee.ModifiedBy = modifiedBy
            employee.ModifiedDate = DateTime.Now
            
            ' データ更新
            Dim updateSuccess As Boolean = _dataAccess.UpdateEmployee(employee)
            
            result.Success = updateSuccess
            result.Data = updateSuccess
            
            If updateSuccess Then
                result.Message = $"社員 '{employee.FullName}' の情報が正常に更新されました。"
                
                ' 業務ルール：給与変更時の自動通知
                If existingEmployee.Salary <> employee.Salary Then
                    NotifySalaryChange(employee.EmployeeID, existingEmployee.Salary, employee.Salary)
                End If
            Else
                result.Errors.Add("データベースの更新に失敗しました。")
            End If
            
        Catch ex As Exception
            result.Success = False
            result.Errors.Add($"社員更新中にエラーが発生しました: {ex.Message}")
            LogError("UpdateEmployee", ex)
        End Try
        
        Return result
    End Function
    
    ' 社員削除
    Public Function DeleteEmployee(employeeId As Integer, deletedBy As String, Optional reason As String = "") As ServiceResult(Of Boolean)
        Dim result As New ServiceResult(Of Boolean)()
        
        Try
            ' 既存データ確認
            Dim employee As Employee = GetEmployeeById(employeeId)
            If employee Is Nothing Then
                result.Success = False
                result.Errors.Add("削除対象の社員が見つかりません。")
                Return result
            End If
            
            ' 業務ルール：削除制限チェック
            Dim canDelete As Boolean = CanDeleteEmployee(employee)
            If Not canDelete Then
                result.Success = False
                result.Errors.Add("この社員は削除できません。管理者または現在進行中のプロジェクトに関連付けられています。")
                Return result
            End If
            
            ' 論理削除実行
            Dim deleteSuccess As Boolean = _dataAccess.DeleteEmployee(employeeId, deletedBy)
            
            result.Success = deleteSuccess
            result.Data = deleteSuccess
            
            If deleteSuccess Then
                result.Message = $"社員 '{employee.FullName}' が正常に削除されました。"
                
                ' 業務ルール：削除時の自動処理
                ScheduleEmployeeOffboarding(employeeId, reason)
            Else
                result.Errors.Add("データベースの削除処理に失敗しました。")
            End If
            
        Catch ex As Exception
            result.Success = False
            result.Errors.Add($"社員削除中にエラーが発生しました: {ex.Message}")
            LogError("DeleteEmployee", ex)
        End Try
        
        Return result
    End Function
    
    ' 高度な検索機能
    Public Function SearchEmployees(searchCriteria As EmployeeSearchCriteria) As ServiceResult(Of List(Of Employee))
        Dim result As New ServiceResult(Of List(Of Employee))()
        
        Try
            Dim dataTable As DataTable = _dataAccess.SearchEmployees(
                searchCriteria.SearchText, 
                searchCriteria.DepartmentID, 
                searchCriteria.IsActive)
            
            Dim employees As New List(Of Employee)()
            For Each row As DataRow In dataTable.Rows
                employees.Add(ConvertDataRowToEmployee(row))
            Next
            
            ' ビジネスルール：検索結果のソートと制限
            employees = ApplyBusinessSorting(employees, searchCriteria.SortBy, searchCriteria.SortDirection)
            
            If searchCriteria.MaxResults.HasValue AndAlso searchCriteria.MaxResults > 0 Then
                employees = employees.Take(searchCriteria.MaxResults.Value).ToList()
            End If
            
            result.Success = True
            result.Data = employees
            result.Message = $"{employees.Count} 件の社員が見つかりました。"
            
        Catch ex As Exception
            result.Success = False
            result.Errors.Add($"社員検索中にエラーが発生しました: {ex.Message}")
            LogError("SearchEmployees", ex)
        End Try
        
        Return result
    End Function
    
    ' 部署統計の取得
    Public Function GetDepartmentStatistics() As ServiceResult(Of List(Of DepartmentStatistics))
        Dim result As New ServiceResult(Of List(Of DepartmentStatistics))()
        
        Try
            Dim departments As List(Of Department) = _departmentDataAccess.GetAllDepartments()
            Dim statistics As New List(Of DepartmentStatistics)()
            
            For Each dept As Department In departments
                Dim employees As DataTable = _dataAccess.GetEmployeesByDepartment(dept.DepartmentID)
                
                Dim stat As New DepartmentStatistics() With {
                    .DepartmentID = dept.DepartmentID,
                    .DepartmentName = dept.DepartmentName,
                    .TotalEmployees = employees.Rows.Count,
                    .AverageSalary = CalculateAverageSalary(employees),
                    .AverageYearsOfService = CalculateAverageYearsOfService(employees)
                }
                
                statistics.Add(stat)
            Next
            
            result.Success = True
            result.Data = statistics.OrderByDescending(Function(s) s.TotalEmployees).ToList()
            
        Catch ex As Exception
            result.Success = False
            result.Errors.Add($"部署統計取得中にエラーが発生しました: {ex.Message}")
            LogError("GetDepartmentStatistics", ex)
        End Try
        
        Return result
    End Function
    
    ' ヘルパーメソッド群
    Private Function ConvertDataRowToEmployee(row As DataRow) As Employee
        Return New Employee() With {
            .EmployeeID = Convert.ToInt32(row("EmployeeID")),
            .EmployeeCode = row("EmployeeCode").ToString(),
            .FirstName = row("FirstName").ToString(),
            .LastName = row("LastName").ToString(),
            .Email = row("Email").ToString(),
            .PhoneNumber = If(IsDBNull(row("PhoneNumber")), "", row("PhoneNumber").ToString()),
            .HireDate = Convert.ToDateTime(row("HireDate")),
            .DepartmentID = Convert.ToInt32(row("DepartmentID")),
            .PositionID = Convert.ToInt32(row("PositionID")),
            .Salary = Convert.ToDecimal(row("Salary")),
            .IsActive = Convert.ToBoolean(row("IsActive")),
            .DepartmentName = If(IsDBNull(row("DepartmentName")), "", row("DepartmentName").ToString()),
            .PositionName = If(IsDBNull(row("PositionName")), "", row("PositionName").ToString())
        }
    End Function
    
    Private Function RequiresApprovalForUpdate(existingEmployee As Employee, newEmployee As Employee) As Boolean
        ' 重要項目の変更チェック
        Return existingEmployee.Salary <> newEmployee.Salary OrElse
               existingEmployee.DepartmentID <> newEmployee.DepartmentID OrElse
               existingEmployee.PositionID <> newEmployee.PositionID
    End Function
    
    Private Function CanDeleteEmployee(employee As Employee) As Boolean
        ' 削除制限のビジネスルール
        Return employee.PositionID <> 1 ' 例：社長は削除不可
    End Function
    
    Private Sub ScheduleNewEmployeeOnboarding(employeeId As Integer)
        ' 新入社員向け自動処理のスケジューリング
        ' 実装例：オンボーディングタスクの作成、研修予約など
    End Sub
    
    Private Sub ScheduleEmployeeOffboarding(employeeId As Integer, reason As String)
        ' 退職処理の自動スケジューリング
        ' 実装例：アカウント無効化、返却物チェックリスト作成など
    End Sub
    
    Private Sub NotifySalaryChange(employeeId As Integer, oldSalary As Decimal, newSalary As Decimal)
        ' 給与変更の自動通知
        ' 実装例：人事部への通知、システム連携など
    End Sub
    
    Private Function ApplyBusinessSorting(employees As List(Of Employee), sortBy As String, sortDirection As String) As List(Of Employee)
        Select Case sortBy?.ToLower()
            Case "name"
                Return If(sortDirection?.ToLower() = "desc",
                         employees.OrderByDescending(Function(e) e.FullName).ToList(),
                         employees.OrderBy(Function(e) e.FullName).ToList())
            Case "hiredate"
                Return If(sortDirection?.ToLower() = "desc",
                         employees.OrderByDescending(Function(e) e.HireDate).ToList(),
                         employees.OrderBy(Function(e) e.HireDate).ToList())
            Case "salary"
                Return If(sortDirection?.ToLower() = "desc",
                         employees.OrderByDescending(Function(e) e.Salary).ToList(),
                         employees.OrderBy(Function(e) e.Salary).ToList())
            Case Else
                Return employees.OrderBy(Function(e) e.EmployeeCode).ToList()
        End Select
    End Function
    
    Private Function CalculateAverageSalary(employees As DataTable) As Decimal
        If employees.Rows.Count = 0 Then Return 0
        
        Dim totalSalary As Decimal = 0
        For Each row As DataRow In employees.Rows
            totalSalary += Convert.ToDecimal(row("Salary"))
        Next
        
        Return totalSalary / employees.Rows.Count
    End Function
    
    Private Function CalculateAverageYearsOfService(employees As DataTable) As Double
        If employees.Rows.Count = 0 Then Return 0
        
        Dim totalYears As Double = 0
        For Each row As DataRow In employees.Rows
            Dim hireDate As DateTime = Convert.ToDateTime(row("HireDate"))
            totalYears += DateTime.Now.Subtract(hireDate).TotalDays / 365.25
        Next
        
        Return Math.Round(totalYears / employees.Rows.Count, 1)
    End Function
    
    Private Sub LogError(methodName As String, ex As Exception)
        ' エラーログ記録の実装
        Try
            Dim eventLog As New EventLog("Application")
            eventLog.Source = "EmployeeManagement"
            eventLog.WriteEntry($"EmployeeService.{methodName}: {ex.Message}", EventLogEntryType.Error)
        Catch
        End Try
    End Sub
End Class

' サービス結果クラス
Public Class ServiceResult(Of T)
    Public Property Success As Boolean
    Public Property Data As T
    Public Property Message As String
    Public Property Errors As New List(Of String)()
    Public Property Warnings As New List(Of String)()
    
    Public ReadOnly Property HasErrors As Boolean
        Get
            Return Errors.Count > 0
        End Get
    End Property
    
    Public ReadOnly Property HasWarnings As Boolean
        Get
            Return Warnings.Count > 0
        End Get
    End Property
End Class

' 検索条件クラス
Public Class EmployeeSearchCriteria
    Public Property SearchText As String
    Public Property DepartmentID As Integer?
    Public Property IsActive As Boolean?
    Public Property SortBy As String
    Public Property SortDirection As String
    Public Property MaxResults As Integer?
    
    Public Sub New()
        SortBy = "EmployeeCode"
        SortDirection = "ASC"
        MaxResults = 100
    End Sub
End Class

' 部署統計クラス
Public Class DepartmentStatistics
    Public Property DepartmentID As Integer
    Public Property DepartmentName As String
    Public Property TotalEmployees As Integer
    Public Property AverageSalary As Decimal
    Public Property AverageYearsOfService As Double
End Class</code></pre>

                        <h6>ビジネス層実装のポイント</h6>
                        <ul>
                            <li><strong>単一責任原則</strong>：各クラスが明確な責任を持つ</li>
                            <li><strong>包括的な検証</strong>：入力検証からビジネスルールまで網羅</li>
                            <li><strong>トランザクション整合性</strong>：複数操作の一貫性保証</li>
                            <li><strong>エラーハンドリング</strong>：詳細なエラー情報と復旧方法</li>
                            <li><strong>拡張性</strong>：新しいビジネスルールの追加が容易</li>
                        </ul>
                    </div>

                    <!-- セクション5: パフォーマンス最適化とテスト戦略 -->
                    <h3 class="section-title">10.5 パフォーマンス最適化とテスト戦略</h3>
                    
                    <p>エンタープライズレベルのWebアプリケーションでは、パフォーマンス最適化とテスト戦略が成功の鍵となります。ここでは、実用的な最適化手法と包括的なテスト戦略を学習します。</p>

                    <div class="best-practice">
                        <h6><i class="fas fa-rocket"></i> パフォーマンス最適化の重要領域</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>領域</th>
                                    <th>最適化手法</th>
                                    <th>期待効果</th>
                                    <th>実装コスト</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>データベース</strong></td>
                                    <td>インデックス、クエリ最適化、接続プール</td>
                                    <td>50-80%高速化</td>
                                    <td>中</td>
                                </tr>
                                <tr>
                                    <td><strong>キャッシング</strong></td>
                                    <td>出力キャッシュ、データキャッシュ、CDN</td>
                                    <td>80-95%高速化</td>
                                    <td>中</td>
                                </tr>
                                <tr>
                                    <td><strong>ViewState</strong></td>
                                    <td>最適化、圧縮、代替手法</td>
                                    <td>30-60%軽量化</td>
                                    <td>低</td>
                                </tr>
                                <tr>
                                    <td><strong>静的リソース</strong></td>
                                    <td>圧縮、結合、CDN配信</td>
                                    <td>40-70%高速化</td>
                                    <td>中</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 実習3: パフォーマンス最適化の実装 -->
                    <div class="exercise-container">
                        <h5>実習 10-3: 企業レベルパフォーマンス最適化の実装</h5>
                        <p>実践的なパフォーマンス最適化技術を実装し、高負荷環境に対応できるシステムを構築しましょう。</p>
                        
                        <h6>手順1: キャッシング戦略の実装</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/Caching/CacheManager.vb
Imports System.Web.Caching

Public Class CacheManager
    Private Shared ReadOnly _cache As Cache = HttpContext.Current.Cache
    
    ' キャッシュキーのプレフィックス
    Private Const EMPLOYEE_PREFIX As String = "EMP_"
    Private Const DEPARTMENT_PREFIX As String = "DEPT_"
    Private Const STATISTICS_PREFIX As String = "STATS_"
    
    ' キャッシュ期間設定
    Private Shared ReadOnly _defaultCacheTime As TimeSpan = TimeSpan.FromMinutes(15)
    Private Shared ReadOnly _shortCacheTime As TimeSpan = TimeSpan.FromMinutes(5)
    Private Shared ReadOnly _longCacheTime As TimeSpan = TimeSpan.FromHours(1)
    
    ' 汎用キャッシュ取得メソッド
    Public Shared Function GetFromCache(Of T)(key As String) As T
        Dim cachedItem As Object = _cache(key)
        If cachedItem IsNot Nothing AndAlso TypeOf cachedItem Is T Then
            Return DirectCast(cachedItem, T)
        End If
        Return Nothing
    End Function
    
    ' 汎用キャッシュ設定メソッド
    Public Shared Sub SetCache(Of T)(key As String, data As T, Optional cacheTime As TimeSpan? = Nothing)
        Dim expiration As TimeSpan = cacheTime.GetValueOrDefault(_defaultCacheTime)
        _cache.Insert(key, data, Nothing, DateTime.Now.Add(expiration), TimeSpan.Zero)
    End Sub
    
    ' キャッシュ削除メソッド
    Public Shared Sub RemoveFromCache(key As String)
        _cache.Remove(key)
    End Sub
    
    ' パターンマッチによるキャッシュ削除
    Public Shared Sub RemoveCacheByPattern(pattern As String)
        Dim keysToRemove As New List(Of String)()
        
        For Each entry As DictionaryEntry In _cache
            If entry.Key.ToString().Contains(pattern) Then
                keysToRemove.Add(entry.Key.ToString())
            End If
        Next
        
        For Each key As String In keysToRemove
            _cache.Remove(key)
        Next
    End Sub
    
    ' 社員データ専用キャッシュメソッド
    Public Shared Function GetCachedEmployee(employeeId As Integer) As Employee
        Dim key As String = EMPLOYEE_PREFIX & employeeId.ToString()
        Return GetFromCache(Of Employee)(key)
    End Function
    
    Public Shared Sub CacheEmployee(employee As Employee)
        Dim key As String = EMPLOYEE_PREFIX & employee.EmployeeID.ToString()
        SetCache(key, employee, _shortCacheTime)
    End Sub
    
    Public Shared Sub InvalidateEmployeeCache(employeeId As Integer)
        Dim key As String = EMPLOYEE_PREFIX & employeeId.ToString()
        RemoveFromCache(key)
        
        ' 関連キャッシュも削除
        RemoveCacheByPattern(DEPARTMENT_PREFIX)
        RemoveCacheByPattern(STATISTICS_PREFIX)
    End Sub
    
    ' 部署データ専用キャッシュメソッド
    Public Shared Function GetCachedDepartments() As List(Of Department)
        Dim key As String = DEPARTMENT_PREFIX & "ALL"
        Return GetFromCache(Of List(Of Department))(key)
    End Function
    
    Public Shared Sub CacheDepartments(departments As List(Of Department))
        Dim key As String = DEPARTMENT_PREFIX & "ALL"
        SetCache(key, departments, _longCacheTime)
    End Sub
    
    ' 統計データ専用キャッシュメソッド
    Public Shared Function GetCachedStatistics() As List(Of DepartmentStatistics)
        Dim key As String = STATISTICS_PREFIX & "DEPT"
        Return GetFromCache(Of List(Of DepartmentStatistics))(key)
    End Function
    
    Public Shared Sub CacheStatistics(statistics As List(Of DepartmentStatistics))
        Dim key As String = STATISTICS_PREFIX & "DEPT"
        SetCache(key, statistics, _defaultCacheTime)
    End Sub
    
    ' 依存関係ベースのキャッシュ無効化
    Public Shared Sub InvalidateRelatedCaches(operation As String, affectedEntityType As String)
        Select Case operation.ToUpper()
            Case "INSERT", "UPDATE", "DELETE"
                Select Case affectedEntityType.ToUpper()
                    Case "EMPLOYEE"
                        RemoveCacheByPattern(EMPLOYEE_PREFIX)
                        RemoveCacheByPattern(STATISTICS_PREFIX)
                    Case "DEPARTMENT"
                        RemoveCacheByPattern(DEPARTMENT_PREFIX)
                        RemoveCacheByPattern(STATISTICS_PREFIX)
                End Select
        End Select
    End Sub
    
    ' キャッシュ統計取得
    Public Shared Function GetCacheStatistics() As CacheStatistics
        Dim stats As New CacheStatistics()
        
        For Each entry As DictionaryEntry In _cache
            stats.TotalItems += 1
            
            Dim key As String = entry.Key.ToString()
            If key.StartsWith(EMPLOYEE_PREFIX) Then
                stats.EmployeeItems += 1
            ElseIf key.StartsWith(DEPARTMENT_PREFIX) Then
                stats.DepartmentItems += 1
            ElseIf key.StartsWith(STATISTICS_PREFIX) Then
                stats.StatisticsItems += 1
            Else
                stats.OtherItems += 1
            End If
        Next
        
        Return stats
    End Function
End Class

' キャッシュ統計クラス
Public Class CacheStatistics
    Public Property TotalItems As Integer
    Public Property EmployeeItems As Integer
    Public Property DepartmentItems As Integer
    Public Property StatisticsItems As Integer
    Public Property OtherItems As Integer
    
    Public ReadOnly Property CacheEfficiency As Double
        Get
            If TotalItems = 0 Then Return 0
            Return CDbl(EmployeeItems + DepartmentItems + StatisticsItems) / TotalItems * 100
        End Get
    End Property
End Class</code></pre>

                        <h6>手順2: 高速化対応サービスクラス</h6>
                        <pre class="code-block"><code class="language-vbnet">
' App_Code/BusinessLogic/OptimizedEmployeeService.vb
Public Class OptimizedEmployeeService
    Inherits EmployeeService
    
    ' キャッシュを活用した社員取得
    Public Shadows Function GetEmployeeById(employeeId As Integer) As Employee
        ' キャッシュから取得を試行
        Dim cachedEmployee As Employee = CacheManager.GetCachedEmployee(employeeId)
        If cachedEmployee IsNot Nothing Then
            Return cachedEmployee
        End If
        
        ' キャッシュにない場合はデータベースから取得
        Dim employee As Employee = MyBase.GetEmployeeById(employeeId)
        If employee IsNot Nothing Then
            CacheManager.CacheEmployee(employee)
        End If
        
        Return employee
    End Function
    
    ' パフォーマンス最適化された一覧取得
    Public Shadows Function GetEmployees(Optional includeInactive As Boolean = False) As List(Of Employee)
        Dim cacheKey As String = $"EMPLOYEES_ALL_{includeInactive}"
        Dim cachedEmployees As List(Of Employee) = CacheManager.GetFromCache(Of List(Of Employee))(cacheKey)
        
        If cachedEmployees IsNot Nothing Then
            Return cachedEmployees
        End If
        
        ' データベースから取得
        Dim employees As List(Of Employee) = MyBase.GetEmployees(includeInactive)
        
        ' キャッシュに保存
        CacheManager.SetCache(cacheKey, employees, TimeSpan.FromMinutes(10))
        
        Return employees
    End Function
    
    ' バッチ処理最適化された社員更新
    Public Function UpdateEmployeesBatch(employees As List(Of Employee), modifiedBy As String) As ServiceResult(Of Integer)
        Dim result As New ServiceResult(Of Integer)()
        Dim successCount As Integer = 0
        Dim errors As New List(Of String)()
        
        Try
            ' バッチ処理用トランザクション
            Using scope As New TransactionScope()
                For Each employee As Employee In employees
                    Try
                        Dim updateResult As ServiceResult(Of Boolean) = MyBase.UpdateEmployee(employee, modifiedBy)
                        If updateResult.Success Then
                            successCount += 1
                            ' キャッシュ無効化
                            CacheManager.InvalidateEmployeeCache(employee.EmployeeID)
                        Else
                            errors.AddRange(updateResult.Errors)
                        End If
                    Catch ex As Exception
                        errors.Add($"社員ID {employee.EmployeeID}: {ex.Message}")
                    End Try
                Next
                
                scope.Complete()
            End Using
            
            result.Success = successCount > 0
            result.Data = successCount
            result.Message = $"{successCount} 件の社員情報を更新しました。"
            result.Errors = errors
            
            ' 関連キャッシュの一括無効化
            If successCount > 0 Then
                CacheManager.InvalidateRelatedCaches("UPDATE", "EMPLOYEE")
            End If
            
        Catch ex As Exception
            result.Success = False
            result.Errors.Add($"バッチ更新中にエラーが発生しました: {ex.Message}")
        End Try
        
        Return result
    End Function
    
    ' 非同期データ取得（ASP.NET 4.5以降）
    Public Async Function GetEmployeesAsync() As Task(Of List(Of Employee))
        Return Await Task.Run(Function() GetEmployees())
    End Function
    
    ' メモリ効率を考慮したページング検索
    Public Function SearchEmployeesWithPaging(searchCriteria As EmployeeSearchCriteria, pageNumber As Integer, pageSize As Integer) As ServiceResult(Of PagedResult(Of Employee))
        Dim result As New ServiceResult(Of PagedResult(Of Employee))()
        
        Try
            ' キャッシュキーの生成
            Dim cacheKey As String = GenerateSearchCacheKey(searchCriteria, pageNumber, pageSize)
            Dim cachedResult As PagedResult(Of Employee) = CacheManager.GetFromCache(Of PagedResult(Of Employee))(cacheKey)
            
            If cachedResult IsNot Nothing Then
                result.Success = True
                result.Data = cachedResult
                Return result
            End If
            
            ' データベースからページング検索
            Dim allResults As ServiceResult(Of List(Of Employee)) = MyBase.SearchEmployees(searchCriteria)
            
            If Not allResults.Success Then
                result.Success = False
                result.Errors = allResults.Errors
                Return result
            End If
            
            ' ページング処理
            Dim totalCount As Integer = allResults.Data.Count
            Dim pagedEmployees As List(Of Employee) = allResults.Data.
                Skip((pageNumber - 1) * pageSize).
                Take(pageSize).
                ToList()
            
            Dim pagedResult As New PagedResult(Of Employee)() With {
                .Data = pagedEmployees,
                .TotalCount = totalCount,
                .PageNumber = pageNumber,
                .PageSize = pageSize,
                .TotalPages = Math.Ceiling(totalCount / pageSize)
            }
            
            ' キャッシュに保存（短期間）
            CacheManager.SetCache(cacheKey, pagedResult, TimeSpan.FromMinutes(5))
            
            result.Success = True
            result.Data = pagedResult
            
        Catch ex As Exception
            result.Success = False
            result.Errors.Add($"検索中にエラーが発生しました: {ex.Message}")
        End Try
        
        Return result
    End Function
    
    ' パフォーマンス監視機能
    Public Function GetPerformanceMetrics() As PerformanceMetrics
        Dim metrics As New PerformanceMetrics()
        
        ' キャッシュ統計
        metrics.CacheStatistics = CacheManager.GetCacheStatistics()
        
        ' データベース接続プール統計（.NET 4.0以降）
        metrics.DatabaseConnections = GetDatabaseConnectionStats()
        
        ' メモリ使用量
        metrics.MemoryUsage = GC.GetTotalMemory(False) / 1024 / 1024 ' MB
        
        ' プロセス情報
        Dim process As Process = Process.GetCurrentProcess()
        metrics.WorkingSet = process.WorkingSet64 / 1024 / 1024 ' MB
        metrics.ProcessorTime = process.TotalProcessorTime.TotalMilliseconds
        
        Return metrics
    End Function
    
    ' ヘルパーメソッド
    Private Function GenerateSearchCacheKey(criteria As EmployeeSearchCriteria, pageNumber As Integer, pageSize As Integer) As String
        Dim keyBuilder As New StringBuilder("SEARCH_")
        keyBuilder.Append(criteria.SearchText?.GetHashCode() ?? 0)
        keyBuilder.Append("_")
        keyBuilder.Append(criteria.DepartmentID ?? 0)
        keyBuilder.Append("_")
        keyBuilder.Append(criteria.IsActive ?? True)
        keyBuilder.Append("_")
        keyBuilder.Append(pageNumber)
        keyBuilder.Append("_")
        keyBuilder.Append(pageSize)
        
        Return keyBuilder.ToString()
    End Function
    
    Private Function GetDatabaseConnectionStats() As DatabaseConnectionStats
        ' 実装例：データベース接続プールの統計情報を取得
        Return New DatabaseConnectionStats() With {
            .ActiveConnections = 5,
            .PoolSize = 100,
            .AvailableConnections = 95
        }
    End Function
End Class

' ページング結果クラス
Public Class PagedResult(Of T)
    Public Property Data As List(Of T)
    Public Property TotalCount As Integer
    Public Property PageNumber As Integer
    Public Property PageSize As Integer
    Public Property TotalPages As Integer
    
    Public ReadOnly Property HasPreviousPage As Boolean
        Get
            Return PageNumber > 1
        End Get
    End Property
    
    Public ReadOnly Property HasNextPage As Boolean
        Get
            Return PageNumber < TotalPages
        End Get
    End Property
End Class

' パフォーマンスメトリクスクラス
Public Class PerformanceMetrics
    Public Property CacheStatistics As CacheStatistics
    Public Property DatabaseConnections As DatabaseConnectionStats
    Public Property MemoryUsage As Long ' MB
    Public Property WorkingSet As Long ' MB
    Public Property ProcessorTime As Double ' ミリ秒
    Public Property Timestamp As DateTime = DateTime.Now
End Class

Public Class DatabaseConnectionStats
    Public Property ActiveConnections As Integer
    Public Property PoolSize As Integer
    Public Property AvailableConnections As Integer
    
    Public ReadOnly Property UsagePercentage As Double
        Get
            If PoolSize = 0 Then Return 0
            Return CDbl(ActiveConnections) / PoolSize * 100
        End Get
    End Property
End Class</code></pre>

                        <h6>手順3: web.config パフォーマンス設定</h6>
                        <pre class="code-block"><code class="language-xml">&lt;configuration&gt;
  &lt;system.web&gt;
    &lt;!-- 出力キャッシュ設定 --&gt;
    &lt;caching&gt;
      &lt;outputCacheSettings&gt;
        &lt;outputCacheProfiles&gt;
          &lt;add name="EmployeeList" duration="600" varyByParam="departmentId;isActive" /&gt;
          &lt;add name="DepartmentStats" duration="1800" varyByParam="none" /&gt;
          &lt;add name="EmployeeDetail" duration="300" varyByParam="id" /&gt;
        &lt;/outputCacheProfiles&gt;
      &lt;/outputCacheSettings&gt;
    &lt;/caching&gt;

    &lt;!-- コンパイル最適化 --&gt;
    &lt;compilation debug="false" targetFramework="4.8" optimizeCompilations="true" /&gt;

    &lt;!-- セッション状態設定 --&gt;
    &lt;sessionState mode="InProc" cookieless="false" regenerateExpiredSessionId="true" 
                  timeout="20" cookieTimeout="20" /&gt;

    &lt;!-- HTTPランタイム設定 --&gt;
    &lt;httpRuntime targetFramework="4.8" maxRequestLength="51200" 
                 executionTimeout="110" enableVersionHeader="false" /&gt;

    &lt;!-- ViewState最適化 --&gt;
    &lt;pages enableViewState="false" enableViewStateMac="true" 
           viewStateEncryptionMode="Always" controlRenderingCompatibilityVersion="4.0" /&gt;

    &lt;!-- トレース無効化（本番環境） --&gt;
    &lt;trace enabled="false" pageOutput="false" requestLimit="100" localOnly="true" /&gt;

  &lt;/system.web&gt;

  &lt;system.webServer&gt;
    &lt;!-- 静的コンテンツの圧縮 --&gt;
    &lt;httpCompression directory="%SystemDrive%\inetpub\temp\IIS Temporary Compressed Files"&gt;
      &lt;scheme name="gzip" dll="%Windir%\system32\inetsrv\gzip.dll" /&gt;
      &lt;dynamicTypes&gt;
        &lt;add mimeType="text/*" enabled="true" /&gt;
        &lt;add mimeType="message/*" enabled="true" /&gt;
        &lt;add mimeType="application/javascript" enabled="true" /&gt;
        &lt;add mimeType="application/json" enabled="true" /&gt;
        &lt;add mimeType="*/*" enabled="false" /&gt;
      &lt;/dynamicTypes&gt;
      &lt;staticTypes&gt;
        &lt;add mimeType="text/*" enabled="true" /&gt;
        &lt;add mimeType="message/*" enabled="true" /&gt;
        &lt;add mimeType="application/javascript" enabled="true" /&gt;
        &lt;add mimeType="application/atom+xml" enabled="true" /&gt;
        &lt;add mimeType="application/xaml+xml" enabled="true" /&gt;
        &lt;add mimeType="application/json" enabled="true" /&gt;
        &lt;add mimeType="*/*" enabled="false" /&gt;
      &lt;/staticTypes&gt;
    &lt;/httpCompression&gt;

    &lt;!-- 静的ファイルのキャッシュ設定 --&gt;
    &lt;staticContent&gt;
      &lt;clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="7.00:00:00" /&gt;
    &lt;/staticContent&gt;

    &lt;!-- URL圧縮 --&gt;
    &lt;urlCompression doStaticCompression="true" doDynamicCompression="true" /&gt;

  &lt;/system.webServer&gt;

  &lt;!-- 接続文字列最適化 --&gt;
  &lt;connectionStrings&gt;
    &lt;add name="EmployeeManagementDB" 
         connectionString="Server=(localdb)\MSSQLLocalDB;Database=EmployeeManagementDB;Integrated Security=true;
                          Connection Timeout=30;Command Timeout=30;
                          Pooling=true;Min Pool Size=5;Max Pool Size=100;
                          Packet Size=4096;Application Name=EmployeeManagement" 
         providerName="System.Data.SqlClient" /&gt;
  &lt;/connectionStrings&gt;
&lt;/configuration&gt;</code></pre>

                        <h6>パフォーマンス最適化のポイント</h6>
                        <ul>
                            <li><strong>多層キャッシング</strong>：データ、出力、静的リソースの段階的キャッシュ</li>
                            <li><strong>効率的なデータアクセス</strong>：接続プール、クエリ最適化</li>
                            <li><strong>メモリ管理</strong>：適切なオブジェクト生成と破棄</li>
                            <li><strong>監視とメトリクス</strong>：パフォーマンス問題の早期発見</li>
                        </ul>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>3層アーキテクチャの利点</strong>：3層アーキテクチャを採用することで解決される企業レベルの課題を5つ挙げ、それぞれについて具体的な解決方法を説明してください。</li>
                            
                            <li><strong>ビジネスロジック設計</strong>：EmployeeBusinessRulesクラスで実装されている検証ロジックの中から、特に重要だと思う3つの検証を選び、なぜそれらが重要なのかをビジネス的観点から説明してください。</li>
                            
                            <li><strong>パフォーマンス最適化</strong>：以下のシナリオにおいて、最も効果的なパフォーマンス最適化手法を選択し、その理由を説明してください：
                                <ul>
                                    <li>1000人の社員データを頻繁に表示する画面</li>
                                    <li>複雑な統計レポートを生成する処理</li>
                                    <li>写真アップロード機能を含む社員登録フォーム</li>
                                </ul>
                            </li>
                            
                            <li><strong>キャッシング戦略</strong>：CacheManagerクラスで実装されているキャッシュ戦略について、データの整合性を保ちながら高いパフォーマンスを実現するための設計思想を説明してください。</li>
                            
                            <li><strong>実践プロジェクト応用</strong>：学習した技術を応用して、社員管理システムに以下の機能を追加する場合の設計アプローチを説明してください：
                                <ul>
                                    <li>社員の勤怠管理機能</li>
                                    <li>給与計算と明細出力機能</li>
                                    <li>組織変更の承認ワークフロー機能</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="aspnet-vb-learning-material-9.html" class="btn btn-secondary">← 第9章: セキュリティとメンバーシップ</a>
                        <div class="text-center">
                            <p class="text-success"><strong>ASP.NET（VB.NET）学習コース完了おめでとうございます！</strong></p>
                            <p class="text-muted">この知識を基に、さらに高度な.NET技術への学習を続けてください。</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>