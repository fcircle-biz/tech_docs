<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL学習教材 第10章 - 実践的なデータベース設計</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #1976d2; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #1976d2; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #1976d2; padding-bottom: 0.5rem; }
        .section-title { color: #42a5f5; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container { background-color: #e1f5fe; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #1976d2; }
        .exercise-container { background-color: #f3e5f5; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #9c27b0; }
        .highlight { background-color: #ffecb3; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #ffc107; }
        .warning { background-color: #ffebee; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #f44336; }
        .code-block { background-color: #1e1e1e; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #1976d2 !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SQL学習教材</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-1.html">第1章: 基礎概念</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-2.html">第2章: データ型</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-3.html">第3章: CRUD操作</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-4.html">第4章: SELECT文の詳細</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-5.html">第5章: 結合（JOIN）</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-6.html">第6章: 集計とグループ化</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-7.html">第7章: サブクエリ</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-8.html">第8章: パフォーマンス</a></li>
                        <li class="nav-item"><a class="nav-link" href="sql-learning-material-9.html">第9章: トランザクション</a></li>
                        <li class="nav-item"><a class="nav-link active" href="sql-learning-material-10.html">第10章: DB設計</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第10章: 実践的なデータベース設計</h1>
                </div>

                <div id="chapter10">
                    <h2 class="chapter-title">実践的なデータベース設計</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>正規化の基本概念（第1〜第3正規形）</li>
                            <li>ER図の作成方法</li>
                            <li>実践的なデータベース設計演習</li>
                            <li>アンチパターンとベストプラクティス</li>
                            <li>スケーラブルなデータベース設計</li>
                        </ul>
                    </div>

                    <h3 class="section-title">10.1 正規化の基本概念</h3>
                    <p>正規化は、データの冗長性を排除し、データの整合性を保つための設計手法です。</p>

                    <h4>正規化のレベル</h4>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header bg-primary text-white"><h6>第1正規形（1NF）</h6></div>
                                <div class="card-body"><p>繰り返し項目を排除し、各セルに単一の値を格納</p></div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header bg-success text-white"><h6>第2正規形（2NF）</h6></div>
                                <div class="card-body"><p>部分関数従属を排除し、完全関数従属のみを保持</p></div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-header bg-info text-white"><h6>第3正規形（3NF）</h6></div>
                                <div class="card-body"><p>推移的関数従属を排除し、非キー属性間の依存を除去</p></div>
                            </div>
                        </div>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 10-1: 正規化の実践</h5>
                        <p>非正規化されたテーブルを正規化する過程を実践します。</p>
                        <h6>正規化前（非正規形）</h6>
                        <pre class="code-block"><code class="language-sql">-- 非正規化されたテーブル例
CREATE TABLE order_summary (
    order_id INTEGER,
    customer_name VARCHAR(100),
    customer_email VARCHAR(255),
    customer_address VARCHAR(500),
    product1_name VARCHAR(200),
    product1_price DECIMAL(10,2),
    product1_quantity INTEGER,
    product2_name VARCHAR(200),
    product2_price DECIMAL(10,2),
    product2_quantity INTEGER
);</code></pre>

                        <h6>正規化後（第3正規形）</h6>
                        <pre class="code-block"><code class="language-sql">-- 顧客テーブル
CREATE TABLE customers_normalized (
    customer_id SERIAL PRIMARY KEY,
    customer_name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    address VARCHAR(500)
);

-- 商品テーブル
CREATE TABLE products_normalized (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(200) NOT NULL,
    price DECIMAL(10,2) NOT NULL
);

-- 注文テーブル
CREATE TABLE orders_normalized (
    order_id SERIAL PRIMARY KEY,
    customer_id INTEGER REFERENCES customers_normalized(customer_id),
    order_date TIMESTAMP DEFAULT NOW()
);

-- 注文詳細テーブル
CREATE TABLE order_details (
    detail_id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders_normalized(order_id),
    product_id INTEGER REFERENCES products_normalized(product_id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10,2) NOT NULL
);</code></pre>
                    </div>

                    <h3 class="section-title">10.2 ER図による設計</h3>
                    <p>Entity-Relationship図は、データベースの構造を視覚的に表現する重要なツールです。</p>

                    <div class="mermaid">
                        erDiagram
                            CUSTOMERS {
                                int customer_id PK
                                string name
                                string email UK
                                string phone
                                date created_at
                            }
                            
                            ORDERS {
                                int order_id PK
                                int customer_id FK
                                date order_date
                                string status
                                decimal total_amount
                            }
                            
                            ORDER_DETAILS {
                                int detail_id PK
                                int order_id FK
                                int product_id FK
                                int quantity
                                decimal unit_price
                            }
                            
                            PRODUCTS {
                                int product_id PK
                                string product_name
                                decimal price
                                int stock_quantity
                                int category_id FK
                            }
                            
                            CATEGORIES {
                                int category_id PK
                                string category_name
                                string description
                            }
                            
                            CUSTOMERS ||--o{ ORDERS : "places"
                            ORDERS ||--o{ ORDER_DETAILS : "contains"
                            PRODUCTS ||--o{ ORDER_DETAILS : "listed in"
                            CATEGORIES ||--o{ PRODUCTS : "includes"
                    </div>

                    <div class="exercise-container">
                        <h5>実習 10-2: 図書館システムの設計</h5>
                        <p>図書館管理システムのデータベース設計を実践します。</p>
                        <h6>要件定義</h6>
                        <ul>
                            <li>書籍の管理（書籍情報、著者、出版社）</li>
                            <li>利用者の管理（利用者情報、貸出履歴）</li>
                            <li>貸出・返却の管理（貸出日、返却予定日、返却日）</li>
                        </ul>

                        <h6>実装例</h6>
                        <pre class="code-block"><code class="language-sql">-- 著者テーブル
CREATE TABLE authors (
    author_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    birth_date DATE,
    nationality VARCHAR(50)
);

-- 出版社テーブル
CREATE TABLE publishers (
    publisher_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    address VARCHAR(200),
    phone VARCHAR(20)
);

-- 書籍テーブル
CREATE TABLE books (
    book_id SERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    isbn VARCHAR(13) UNIQUE,
    publisher_id INTEGER REFERENCES publishers(publisher_id),
    publication_date DATE,
    pages INTEGER,
    available_copies INTEGER DEFAULT 1
);

-- 書籍著者関係テーブル（多対多）
CREATE TABLE book_authors (
    book_id INTEGER REFERENCES books(book_id),
    author_id INTEGER REFERENCES authors(author_id),
    PRIMARY KEY (book_id, author_id)
);

-- 利用者テーブル
CREATE TABLE members (
    member_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE,
    phone VARCHAR(20),
    address VARCHAR(300),
    registration_date DATE DEFAULT CURRENT_DATE
);

-- 貸出テーブル
CREATE TABLE loans (
    loan_id SERIAL PRIMARY KEY,
    book_id INTEGER REFERENCES books(book_id),
    member_id INTEGER REFERENCES members(member_id),
    loan_date DATE DEFAULT CURRENT_DATE,
    due_date DATE NOT NULL,
    return_date DATE,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'returned', 'overdue'))
);</code></pre>
                    </div>

                    <h3 class="section-title">10.3 設計のベストプラクティス</h3>
                    <div class="highlight">
                        <h6>データベース設計の原則</h6>
                        <ul>
                            <li><strong>適切な正規化</strong>: 冗長性を排除しつつ、パフォーマンスを考慮</li>
                            <li><strong>命名規則の統一</strong>: 一貫した命名でメンテナンス性を向上</li>
                            <li><strong>制約の活用</strong>: データ品質を自動的に保証</li>
                            <li><strong>インデックス戦略</strong>: 検索パフォーマンスの最適化</li>
                            <li><strong>将来の拡張性</strong>: 要件変更に対する柔軟性</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>よくある設計アンチパターン</h6>
                        <ul>
                            <li><strong>神テーブル</strong>: 一つのテーブルにあまりにも多くの情報を詰め込む</li>
                            <li><strong>マジック値</strong>: 意味を持つ数値やコードをそのまま格納</li>
                            <li><strong>EAV構造</strong>: Entity-Attribute-Value構造の濫用</li>
                            <li><strong>不適切な外部キー</strong>: 参照整合性制約の不備</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 10-3: 設計改善の実践</h5>
                        <p>問題のある設計を改善する演習を行います。</p>
                        
                        <h6>改善前（問題のある設計）</h6>
                        <pre class="code-block"><code class="language-sql">-- 問題のあるテーブル設計
CREATE TABLE user_data (
    id SERIAL PRIMARY KEY,
    user_info TEXT,  -- JSON形式で全ユーザー情報
    type INTEGER,    -- 1=顧客, 2=管理者, 3=スタッフ（マジック値）
    data1 VARCHAR(255),  -- 用途不明
    data2 VARCHAR(255),  -- 用途不明
    data3 VARCHAR(255)   -- 用途不明
);</code></pre>

                        <h6>改善後（適切な設計）</h6>
                        <pre class="code-block"><code class="language-sql">-- ユーザー種別マスタ
CREATE TABLE user_types (
    type_id SERIAL PRIMARY KEY,
    type_name VARCHAR(50) NOT NULL UNIQUE,
    description TEXT
);

INSERT INTO user_types (type_name, description) VALUES
    ('customer', '一般顧客'),
    ('admin', '管理者'),
    ('staff', 'スタッフ');

-- 改善されたユーザーテーブル
CREATE TABLE users_improved (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    full_name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    type_id INTEGER REFERENCES user_types(type_id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>問題1:</strong> 第3正規形の条件を説明してください。</li>
                            <li><strong>問題2:</strong> 多対多の関係をデータベースで表現する方法は？</li>
                            <li><strong>問題3:</strong> データベース設計でマジック値を避けるべき理由は？</li>
                            <li><strong>問題4:</strong> 正規化の利点と欠点を挙げてください。</li>
                            <li><strong>問題5:</strong> ER図で表現される主な要素は何ですか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を表示</summary>
                            <div class="mt-2">
                                <strong>解答:</strong>
                                <ol>
                                    <li>第2正規形の条件を満たし、かつ推移的関数従属が存在しない状態</li>
                                    <li>中間テーブル（連関エンティティ）を使用して両方のエンティティの主キーを外部キーとして持つ</li>
                                    <li>コードの意味が不明確になり、保守性が低下するため</li>
                                    <li>利点：冗長性排除、整合性向上。欠点：結合コスト、複雑性増加</li>
                                    <li>エンティティ（実体）、アトリビュート（属性）、リレーションシップ（関係）</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <div class="highlight">
                        <h5>SQL学習の完了</h5>
                        <p>お疲れさまでした！これでSQL学習教材の全10章が完了しました。</p>
                        <p>これまでに学習した内容：</p>
                        <ul>
                            <li>SQLの基礎概念とデータベース操作</li>
                            <li>効果的なクエリ作成技法</li>
                            <li>パフォーマンス最適化</li>
                            <li>データ整合性の保持</li>
                            <li>実践的なデータベース設計</li>
                        </ul>
                        <p>次のステップとして、実際のプロジェクトでの実践や、より高度なデータベース技術の学習をお勧めします。</p>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="sql-learning-material-9.html" class="btn btn-secondary">← 前の章: トランザクション</a>
                        <a href="../README.md" class="btn btn-primary">SQLガイドTOPに戻る →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>