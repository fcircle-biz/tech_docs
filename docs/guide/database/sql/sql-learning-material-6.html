<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL学習教材 第6章 - 集計関数とグループ化</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #1976d2;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #1976d2;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #42a5f5;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #1976d2;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #1976d2 !important;
            color: white !important;
        }
        
        .function-table th {
            background-color: #1976d2;
            color: white;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SQL学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../README.md">ガイドTOP</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-1.html">第1章: 基礎概念</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-2.html">第2章: データ型</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-3.html">第3章: CRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-4.html">第4章: SELECT文の詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-5.html">第5章: 結合（JOIN）</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="sql-learning-material-6.html">第6章: 集計とグループ化</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-7.html">第7章: サブクエリ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-8.html">第8章: パフォーマンス</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-9.html">第9章: トランザクション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="sql-learning-material-10.html">第10章: DB設計</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: 集計関数とグループ化</h1>
                </div>

                <div id="chapter6">
                    <h2 class="chapter-title">集計関数とグループ化</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>集計関数（COUNT、SUM、AVG、MAX、MIN）の使用方法</li>
                            <li>GROUP BY句によるデータのグループ化</li>
                            <li>HAVING句による集計結果の絞り込み</li>
                            <li>複数列でのグループ化</li>
                            <li>JOINと集計関数の組み合わせ</li>
                            <li>実践的なデータ分析クエリの作成</li>
                        </ul>
                    </div>

                    <h3 class="section-title">6.1 集計関数の基本</h3>
                    <p>
                        集計関数は複数行のデータを集約して、単一の結果を返す関数です。
                        データ分析における最も基本的で重要な機能です。
                    </p>

                    <h4>主要な集計関数</h4>
                    <div class="table-responsive">
                        <table class="table function-table">
                            <thead>
                                <tr>
                                    <th>関数</th>
                                    <th>説明</th>
                                    <th>例</th>
                                    <th>注意点</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>COUNT(*)</td>
                                    <td>行数をカウント</td>
                                    <td>COUNT(*)</td>
                                    <td>NULL値も含む全行をカウント</td>
                                </tr>
                                <tr>
                                    <td>COUNT(列名)</td>
                                    <td>NULL以外の値をカウント</td>
                                    <td>COUNT(phone)</td>
                                    <td>NULL値は除外してカウント</td>
                                </tr>
                                <tr>
                                    <td>SUM()</td>
                                    <td>合計値を計算</td>
                                    <td>SUM(price)</td>
                                    <td>数値型のみ使用可能</td>
                                </tr>
                                <tr>
                                    <td>AVG()</td>
                                    <td>平均値を計算</td>
                                    <td>AVG(salary)</td>
                                    <td>NULL値は除外して計算</td>
                                </tr>
                                <tr>
                                    <td>MAX()</td>
                                    <td>最大値を取得</td>
                                    <td>MAX(created_at)</td>
                                    <td>日付、文字列でも使用可能</td>
                                </tr>
                                <tr>
                                    <td>MIN()</td>
                                    <td>最小値を取得</td>
                                    <td>MIN(price)</td>
                                    <td>日付、文字列でも使用可能</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 6-1: 基本的な集計関数</h5>
                        <p>各集計関数を使用してデータの統計情報を取得します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 基本的な集計関数の使用
SELECT 
    COUNT(*) AS total_products,
    COUNT(description) AS products_with_description,
    SUM(price) AS total_value,
    AVG(price) AS average_price,
    MAX(price) AS highest_price,
    MIN(price) AS lowest_price,
    MAX(created_at) AS latest_created,
    MIN(created_at) AS earliest_created
FROM products;

-- 顧客データの集計
SELECT 
    COUNT(*) AS total_customers,
    COUNT(phone) AS customers_with_phone,
    MAX(created_at) AS newest_customer,
    MIN(created_at) AS oldest_customer
FROM customers;

-- 注文データの集計
SELECT 
    COUNT(*) AS total_orders,
    SUM(quantity) AS total_quantity_ordered,
    AVG(quantity) AS average_order_quantity
FROM orders;</code></pre>
                    </div>

                    <h3 class="section-title">6.2 GROUP BY句によるグループ化</h3>
                    <p>
                        GROUP BY句は、指定した列の値が同じレコードをグループ化します。
                        各グループに対して集計関数を適用できます。
                    </p>

                    <div class="mermaid">
                        flowchart LR
                            A[全レコード] --> B[GROUP BY]
                            B --> C[グループ1]
                            B --> D[グループ2]
                            B --> E[グループ3]
                            C --> F[集計関数適用]
                            D --> G[集計関数適用]
                            E --> H[集計関数適用]
                    </div>

                    <div class="exercise-container">
                        <h5>実習 6-2: GROUP BYによるデータのグループ化</h5>
                        <p>カテゴリ別、顧客別などでデータをグループ化して集計します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- カテゴリ別の商品統計
SELECT 
    category_id,
    COUNT(*) AS product_count,
    AVG(price) AS average_price,
    SUM(stock_quantity) AS total_stock
FROM products
GROUP BY category_id
ORDER BY category_id;

-- カテゴリ名を含めた統計（JOIN使用）
SELECT 
    c.category_name,
    COUNT(p.product_id) AS product_count,
    AVG(p.price) AS average_price,
    MAX(p.price) AS max_price,
    MIN(p.price) AS min_price
FROM categories c
LEFT JOIN products p ON c.category_id = p.category_id
GROUP BY c.category_id, c.category_name
ORDER BY product_count DESC;

-- 月別注文統計
SELECT 
    DATE_TRUNC('month', order_date) AS order_month,
    COUNT(*) AS order_count,
    SUM(quantity) AS total_quantity
FROM orders
GROUP BY DATE_TRUNC('month', order_date)
ORDER BY order_month;</code></pre>
                    </div>

                    <h3 class="section-title">6.3 HAVING句による集計結果の絞り込み</h3>
                    <p>
                        HAVING句は、GROUP BYの結果に対して条件を指定します。
                        WHERE句は個別のレコードに対する条件、HAVING句はグループに対する条件です。
                    </p>

                    <div class="warning">
                        <h6>WHERE句とHAVING句の違い</h6>
                        <ul>
                            <li><strong>WHERE句</strong>: グループ化<em>前</em>のレコードに対する条件</li>
                            <li><strong>HAVING句</strong>: グループ化<em>後</em>の集計結果に対する条件</li>
                            <li><strong>実行順序</strong>: WHERE → GROUP BY → HAVING → ORDER BY</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 6-3: HAVING句による条件絞り込み</h5>
                        <p>集計結果に対して条件を適用してデータを絞り込みます。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 商品数が2個以上あるカテゴリのみ表示
SELECT 
    c.category_name,
    COUNT(p.product_id) AS product_count,
    AVG(p.price) AS average_price
FROM categories c
INNER JOIN products p ON c.category_id = p.category_id
GROUP BY c.category_id, c.category_name
HAVING COUNT(p.product_id) >= 2
ORDER BY product_count DESC;

-- 平均価格が10000円以上のカテゴリ
SELECT 
    c.category_name,
    COUNT(p.product_id) AS product_count,
    ROUND(AVG(p.price), 2) AS average_price,
    MAX(p.price) AS max_price
FROM categories c
INNER JOIN products p ON c.category_id = p.category_id
GROUP BY c.category_id, c.category_name
HAVING AVG(p.price) >= 10000
ORDER BY average_price DESC;

-- 複数回注文した顧客の統計
SELECT 
    c.name AS customer_name,
    COUNT(o.order_id) AS order_count,
    SUM(o.quantity) AS total_quantity_ordered,
    MAX(o.order_date) AS latest_order
FROM customers c
INNER JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.name
HAVING COUNT(o.order_id) > 1
ORDER BY order_count DESC;</code></pre>
                    </div>

                    <h3 class="section-title">6.4 複数列でのグループ化</h3>
                    <p>
                        複数の列を指定してグループ化することで、
                        より詳細な分析が可能になります。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 6-4: 複数列によるグループ化</h5>
                        <p>複数の列を組み合わせてより詳細な分析を行います。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 年月別、カテゴリ別の注文分析
SELECT 
    DATE_TRUNC('month', o.order_date) AS order_month,
    c.category_name,
    COUNT(o.order_id) AS order_count,
    SUM(o.quantity) AS total_quantity,
    SUM(p.price * o.quantity) AS total_revenue
FROM orders o
INNER JOIN products p ON o.product_id = p.product_id
INNER JOIN categories c ON p.category_id = c.category_id
GROUP BY DATE_TRUNC('month', o.order_date), c.category_id, c.category_name
ORDER BY order_month DESC, total_revenue DESC;

-- 顧客別、商品カテゴリ別の購入パターン分析
SELECT 
    cust.name AS customer_name,
    cat.category_name,
    COUNT(o.order_id) AS order_count,
    SUM(o.quantity) AS total_quantity,
    AVG(p.price) AS average_unit_price,
    SUM(p.price * o.quantity) AS total_spent
FROM customers cust
INNER JOIN orders o ON cust.customer_id = o.customer_id
INNER JOIN products p ON o.product_id = p.product_id
INNER JOIN categories cat ON p.category_id = cat.category_id
GROUP BY cust.customer_id, cust.name, cat.category_id, cat.category_name
HAVING SUM(p.price * o.quantity) > 5000
ORDER BY cust.name, total_spent DESC;</code></pre>
                    </div>

                    <h3 class="section-title">6.5 実践的なデータ分析クエリ</h3>
                    <p>
                        ビジネスで実際に使用される分析クエリの例を学習しましょう。
                    </p>

                    <div class="exercise-container">
                        <h5>実習 6-5: ビジネス分析クエリの実践</h5>
                        <p>売上分析、顧客分析など、実際のビジネスシナリオに基づくクエリを作成します。</p>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-sql">-- 1. 売上TOP5の商品分析
SELECT 
    p.product_name,
    c.category_name,
    SUM(o.quantity) AS total_sold,
    SUM(p.price * o.quantity) AS total_revenue,
    AVG(o.quantity) AS avg_order_quantity,
    COUNT(DISTINCT o.customer_id) AS unique_customers
FROM products p
INNER JOIN orders o ON p.product_id = o.product_id
INNER JOIN categories c ON p.category_id = c.category_id
GROUP BY p.product_id, p.product_name, c.category_name
ORDER BY total_revenue DESC
LIMIT 5;

-- 2. 顧客ランキング（購入金額順）
SELECT 
    c.name AS customer_name,
    c.email,
    COUNT(o.order_id) AS order_count,
    SUM(o.quantity) AS total_items_purchased,
    SUM(p.price * o.quantity) AS total_spent,
    AVG(p.price * o.quantity) AS average_order_value,
    MAX(o.order_date) AS last_order_date
FROM customers c
INNER JOIN orders o ON c.customer_id = o.customer_id
INNER JOIN products p ON o.product_id = p.product_id
GROUP BY c.customer_id, c.name, c.email
ORDER BY total_spent DESC
LIMIT 10;

-- 3. 在庫状況の分析
SELECT 
    c.category_name,
    COUNT(p.product_id) AS product_count,
    SUM(p.stock_quantity) AS total_stock,
    AVG(p.stock_quantity) AS avg_stock_per_product,
    COUNT(CASE WHEN p.stock_quantity < 10 THEN 1 END) AS low_stock_products,
    COUNT(CASE WHEN p.stock_quantity = 0 THEN 1 END) AS out_of_stock_products
FROM categories c
LEFT JOIN products p ON c.category_id = p.category_id
GROUP BY c.category_id, c.category_name
ORDER BY total_stock DESC;

-- 4. 月次売上トレンド分析
SELECT 
    DATE_TRUNC('month', o.order_date) AS sales_month,
    COUNT(o.order_id) AS order_count,
    COUNT(DISTINCT o.customer_id) AS unique_customers,
    SUM(o.quantity) AS total_items_sold,
    SUM(p.price * o.quantity) AS monthly_revenue,
    AVG(p.price * o.quantity) AS avg_order_value
FROM orders o
INNER JOIN products p ON o.product_id = p.product_id
GROUP BY DATE_TRUNC('month', o.order_date)
ORDER BY sales_month;</code></pre>
                    </div>

                    <div class="highlight">
                        <h6>集計クエリのパフォーマンス最適化</h6>
                        <ul>
                            <li><strong>インデックス</strong>: GROUP BY句で使用する列にはインデックスを作成</li>
                            <li><strong>WHERE句の活用</strong>: 不要なデータを事前に除外</li>
                            <li><strong>適切なデータ型</strong>: 集計対象列は適切なデータ型を選択</li>
                            <li><strong>LIMIT句の使用</strong>: 結果が大量になる場合は件数を制限</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>
                                <strong>問題1:</strong> COUNT(*)とCOUNT(列名)の違いは何ですか？
                            </li>
                            <li>
                                <strong>問題2:</strong> 以下のクエリの実行順序を正しく並べてください：
                                <br>SELECT、FROM、WHERE、GROUP BY、HAVING、ORDER BY
                            </li>
                            <li>
                                <strong>問題3:</strong> 以下のクエリの結果は何件になりますか？
                                <pre class="code-block"><code class="language-sql">-- 商品テーブルに3つのカテゴリの商品が存在
SELECT category_id, COUNT(*) 
FROM products 
GROUP BY category_id;</code></pre>
                            </li>
                            <li>
                                <strong>問題4:</strong> 平均価格が5000円以上のカテゴリを抽出するクエリを作成してください。
                            </li>
                            <li>
                                <strong>問題5:</strong> GROUP BY句を使用する際、SELECT句に指定できる列の制限について説明してください。
                            </li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を表示</summary>
                            <div class="mt-2">
                                <strong>解答:</strong>
                                <ol>
                                    <li>COUNT(*)は NULL を含む全行をカウント、COUNT(列名)は NULL を除外してカウント</li>
                                    <li>FROM → WHERE → GROUP BY → HAVING → SELECT → ORDER BY</li>
                                    <li>3件（カテゴリごとに1行ずつ結果が返される）</li>
                                    <li><pre class="code-block"><code class="language-sql">SELECT category_id, AVG(price) 
FROM products 
GROUP BY category_id 
HAVING AVG(price) >= 5000;</code></pre></li>
                                    <li>GROUP BY句に指定した列、または集計関数のみSELECT句に指定可能</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="sql-learning-material-5.html" class="btn btn-secondary">← 前の章: 結合（JOIN）</a>
                        <a href="sql-learning-material-7.html" class="btn btn-primary">次の章: サブクエリ →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>