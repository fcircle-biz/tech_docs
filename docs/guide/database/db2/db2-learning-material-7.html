<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-2.0">
    <title>DB2学習教材 第7章 - ユーザー管理と基本的なセキュリティ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #003d73;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #003d73;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #003d73;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #0062cc;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コード */
        code {
            display: block;
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            white-space: pre;
            overflow-x: auto;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e6f1ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #003d73;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #003d73 !important;
            color: white !important;
        }

        .nav-link:hover {
            background-color: #0062cc !important;
            color: white !important;
        }

        /* テーブル */
        .table th {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">DB2学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">ガイドライン一覧</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>目次</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-1.html">第1章: DB2の基本概念と環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-2.html">第2章: Docker環境でのDB2セットアップ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-3.html">第3章: DB2クライアントツールの導入</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-4.html">第4章: DB2 SQLの基本</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-5.html">第5章: テーブル設計とインデックス基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-6.html">第6章: DB2組み込み関数とストアドプロシージャ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter7">第7章: ユーザー管理と基本的なセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-8.html">第8章: 基本的なデータベース管理操作</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第7章: ユーザー管理と基本的なセキュリティ</h1>
                </div>

                <div id="chapter7">
                    <h2 class="chapter-title">ユーザー管理と基本的なセキュリティ</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>DB2のユーザー認証とアクセス制御の仕組み</li>
                            <li>基本的な権限の種類と付与・剥奪方法</li>
                            <li>ロールを使用した権限管理の効率化</li>
                            <li>スキーマレベルでのアクセス制御</li>
                            <li>監査とログ機能の基本的な使用方法</li>
                        </ul>
                    </div>

                    <!-- 7.1 DB2のセキュリティモデル -->
                    <h3 class="section-title">7.1 DB2のセキュリティモデル</h3>
                    <p>DB2は多層的なセキュリティモデルを採用しており、認証（Authentication）と認可（Authorization）の両方でアクセスを制御しています。</p>

                    <h4>DB2セキュリティの構成要素</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>レベル</th>
                                    <th>機能</th>
                                    <th>制御対象</th>
                                    <th>設定方法</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>インスタンス</td>
                                    <td>接続制御</td>
                                    <td>DB2インスタンスへの接続</td>
                                    <td>OS認証、LDAP</td>
                                </tr>
                                <tr>
                                    <td>データベース</td>
                                    <td>データベース権限</td>
                                    <td>特定データベースへのアクセス</td>
                                    <td>CONNECT、CREATETAB等</td>
                                </tr>
                                <tr>
                                    <td>スキーマ</td>
                                    <td>スキーマ権限</td>
                                    <td>スキーマ内オブジェクト</td>
                                    <td>CREATE、ALTER、DROP</td>
                                </tr>
                                <tr>
                                    <td>オブジェクト</td>
                                    <td>オブジェクト権限</td>
                                    <td>テーブル、ビュー等</td>
                                    <td>SELECT、INSERT、UPDATE、DELETE</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 実習 7-1 -->
                    <div class="exercise-container">
                        <h5>実習 7-1: 現在のセキュリティ設定の確認</h5>
                        <p>現在のユーザー権限とデータベースのセキュリティ設定を確認します。</p>
                        
                        <h6>実行するSQL</h6>
                        <code>-- 現在のユーザー情報の確認
VALUES USER;
VALUES SESSION_USER;
VALUES SYSTEM_USER;

-- データベース権限の確認
SELECT 
    GRANTOR,
    GRANTEE,
    GRANTEETYPE,
    DBADMAUTH,
    SECURITYADMAUTH,
    MAINTAUTHAUTH,
    ACCESSCTRLAUTH,
    DATAACCESS,
    CONNECTAUTH,
    NOFENCEAUTH,
    CREATETABAUTH
FROM SYSCAT.DBAUTH
WHERE GRANTEE = USER OR GRANTEE = 'PUBLIC';

-- スキーマ権限の確認
SELECT 
    SCHEMANAME,
    GRANTOR,
    GRANTEE,
    GRANTEETYPE,
    CREATEINAUTH,
    ALTERINAUTH,
    DROPINAUTH
FROM SYSCAT.SCHEMAAUTH
WHERE GRANTEE = USER OR GRANTEE = 'PUBLIC'
ORDER BY SCHEMANAME;

-- テーブル権限の確認
SELECT 
    TABSCHEMA,
    TABNAME,
    GRANTOR,
    GRANTEE,
    GRANTEETYPE,
    SELECTAUTH,
    INSERTAUTH,
    UPDATEAUTH,
    DELETEAUTH,
    INDEXAUTH,
    ALTERAUTH,
    REFERENCESAUTH
FROM SYSCAT.TABAUTH
WHERE TABSCHEMA = 'SALES_DEPT'
ORDER BY TABNAME;</code>

                        <h6>確認ポイント</h6>
                        <ul>
                            <li>現在のユーザーIDと権限レベル</li>
                            <li>データベースレベルでの管理権限</li>
                            <li>スキーマとオブジェクトへのアクセス権</li>
                            <li>PUBLIC権限の範囲</li>
                        </ul>
                    </div>

                    <!-- 7.2 基本的な権限管理 -->
                    <h3 class="section-title">7.2 基本的な権限管理</h3>
                    <p>DB2では、GRANT文とREVOKE文を使用して権限の付与と剥奪を行います。適切な権限設定により、セキュリティとユーザビリティのバランスを保つことができます。</p>

                    <!-- 実習 7-2 -->
                    <div class="exercise-container">
                        <h5>実習 7-2: 基本的な権限の付与と剥奪</h5>
                        <p>テーブルレベルでの権限付与と剥奪を実践的に学習します。</p>
                        
                        <h6>実行するSQL</h6>
                        <code>-- 権限管理用のテストユーザー作成（概念的な例）
-- 注意: 実際のユーザー作成はOS levelで行う必要があります

-- テーブル権限の付与例
-- SELECT権限の付与
GRANT SELECT ON sales_dept.customers_master TO PUBLIC;

-- 複数権限の同時付与
GRANT SELECT, INSERT, UPDATE ON sales_dept.products_master TO DB2INST1;

-- 全ての権限を付与
GRANT ALL PRIVILEGES ON sales_dept.order_headers TO DB2INST1;

-- WITH GRANT OPTIONを使用した権限の委譲
GRANT SELECT ON sales_dept.categories TO DB2INST1 WITH GRANT OPTION;

-- 列レベルでの権限制御
GRANT UPDATE (product_name, unit_price) ON sales_dept.products_master TO DB2INST1;

-- ビューを使用したアクセス制御
CREATE VIEW sales_dept.customer_summary AS
SELECT 
    customer_id,
    company_name,
    city,
    CASE 
        WHEN LENGTH(email) > 0 THEN 'YES'
        ELSE 'NO'
    END as has_email
FROM sales_dept.customers_master;

-- ビューに対する権限付与
GRANT SELECT ON sales_dept.customer_summary TO PUBLIC;

-- 権限の確認
SELECT 
    TABSCHEMA,
    TABNAME,
    GRANTEE,
    SELECTAUTH,
    INSERTAUTH,
    UPDATEAUTH,
    DELETEAUTH
FROM SYSCAT.TABAUTH
WHERE TABSCHEMA = 'SALES_DEPT'
  AND GRANTEE IN (USER, 'PUBLIC')
ORDER BY TABNAME;

-- 権限の剥奪例
-- 特定権限の剥奪
REVOKE INSERT ON sales_dept.products_master FROM DB2INST1;

-- 全権限の剥奪
REVOKE ALL PRIVILEGES ON sales_dept.order_headers FROM DB2INST1;

-- 権限剥奪の確認
SELECT 
    TABSCHEMA,
    TABNAME,
    GRANTEE,
    SELECTAUTH,
    INSERTAUTH,
    UPDATEAUTH,
    DELETEAUTH
FROM SYSCAT.TABAUTH
WHERE TABSCHEMA = 'SALES_DEPT'
  AND TABNAME = 'PRODUCTS_MASTER';</code>

                        <h6>権限の種類と用途</h6>
                        <ul>
                            <li><strong>SELECT</strong>: データの読み取り</li>
                            <li><strong>INSERT</strong>: 新しいデータの挿入</li>
                            <li><strong>UPDATE</strong>: 既存データの更新</li>
                            <li><strong>DELETE</strong>: データの削除</li>
                            <li><strong>INDEX</strong>: インデックスの作成</li>
                            <li><strong>ALTER</strong>: テーブル構造の変更</li>
                            <li><strong>REFERENCES</strong>: 外部キー制約での参照</li>
                        </ul>
                    </div>

                    <!-- 7.3 ロールベースのアクセス制御 -->
                    <h3 class="section-title">7.3 ロールベースのアクセス制御</h3>
                    <p>ロールを使用することで、複数のユーザーに対する権限管理を効率化できます。業務役割に応じたロールを定義し、ユーザーに割り当てることで管理が簡素化されます。</p>

                    <!-- 実習 7-3 -->
                    <div class="exercise-container">
                        <h5>実習 7-3: ロールの作成と権限管理</h5>
                        <p>業務に応じたロールを作成し、権限を効率的に管理する方法を学習します。</p>
                        
                        <h6>実行するSQL</h6>
                        <code>-- ロールの作成
CREATE ROLE sales_dept.sales_read_only;
CREATE ROLE sales_dept.sales_analyst;
CREATE ROLE sales_dept.sales_manager;
CREATE ROLE sales_dept.data_entry_clerk;

-- 読み取り専用ロールの権限設定
GRANT SELECT ON sales_dept.customers_master TO ROLE sales_dept.sales_read_only;
GRANT SELECT ON sales_dept.products_master TO ROLE sales_dept.sales_read_only;
GRANT SELECT ON sales_dept.order_headers TO ROLE sales_dept.sales_read_only;
GRANT SELECT ON sales_dept.order_details TO ROLE sales_dept.sales_read_only;
GRANT SELECT ON sales_dept.customer_summary TO ROLE sales_dept.sales_read_only;

-- データ分析者ロールの権限設定
GRANT ROLE sales_dept.sales_read_only TO ROLE sales_dept.sales_analyst;
GRANT SELECT ON sales_dept.employee_info TO ROLE sales_dept.sales_analyst;
-- 分析用の一時テーブル作成権限
GRANT CREATETAB ON DATABASE TO ROLE sales_dept.sales_analyst;

-- データ入力担当者ロールの権限設定
GRANT SELECT, INSERT, UPDATE ON sales_dept.order_headers TO ROLE sales_dept.data_entry_clerk;
GRANT SELECT, INSERT, UPDATE ON sales_dept.order_details TO ROLE sales_dept.data_entry_clerk;
GRANT SELECT ON sales_dept.customers_master TO ROLE sales_dept.data_entry_clerk;
GRANT SELECT ON sales_dept.products_master TO ROLE sales_dept.data_entry_clerk;

-- 販売マネージャーロールの権限設定（最も広い権限）
GRANT ROLE sales_dept.sales_analyst TO ROLE sales_dept.sales_manager;
GRANT ROLE sales_dept.data_entry_clerk TO ROLE sales_dept.sales_manager;
GRANT ALL PRIVILEGES ON sales_dept.customers_master TO ROLE sales_dept.sales_manager;
GRANT DELETE ON sales_dept.order_headers TO ROLE sales_dept.sales_manager;
GRANT DELETE ON sales_dept.order_details TO ROLE sales_dept.sales_manager;

-- ユーザーへのロール付与（概念的な例）
-- 実際の環境では、適切なユーザーIDに対して実行
GRANT ROLE sales_dept.sales_read_only TO DB2INST1;

-- ロール情報の確認
SELECT 
    ROLENAME,
    ROLEDEPTH,
    ADMIN
FROM SYSCAT.ROLES
WHERE ROLENAME LIKE 'SALES_DEPT.%'
ORDER BY ROLENAME;

-- ロールの権限確認
SELECT 
    TABSCHEMA,
    TABNAME,
    GRANTEE,
    GRANTEETYPE,
    SELECTAUTH,
    INSERTAUTH,
    UPDATEAUTH,
    DELETEAUTH
FROM SYSCAT.TABAUTH
WHERE GRANTEE LIKE 'SALES_DEPT.%'
ORDER BY GRANTEE, TABNAME;

-- ロールの階層確認
SELECT 
    ROLENAME,
    GRANTEDROLETNAME,
    ADMIN
FROM SYSCAT.ROLEAUTH
WHERE ROLENAME LIKE 'SALES_DEPT.%'
ORDER BY ROLENAME;</code>

                        <h6>ロール設計のベストプラクティス</h6>
                        <ul>
                            <li><strong>最小権限の原則</strong>: 業務に必要最小限の権限のみ付与</li>
                            <li><strong>役割の明確化</strong>: 業務役割に応じたロール設計</li>
                            <li><strong>階層化</strong>: 基本ロールから拡張ロールへの段階的な権限付与</li>
                            <li><strong>定期的な見直し</strong>: 業務変更に応じた権限の見直し</li>
                        </ul>
                    </div>

                    <!-- 7.4 行レベルセキュリティ -->
                    <h3 class="section-title">7.4 行レベルセキュリティ</h3>
                    <p>DB2の行レベルアクセス制御（LBAC: Label Based Access Control）により、同一テーブル内でもユーザーに応じてアクセス可能なデータを制限できます。</p>

                    <!-- 実習 7-4 -->
                    <div class="exercise-container">
                        <h5>実習 7-4: 行レベルセキュリティの実装</h5>
                        <p>ビューとセキュリティ関数を使用した行レベルのアクセス制御を実装します。</p>
                        
                        <h6>実行するSQL</h6>
                        <code>-- セキュリティ用のテーブル拡張
ALTER TABLE sales_dept.order_headers 
ADD COLUMN created_by VARCHAR(50) DEFAULT USER;

-- 既存データに作成者情報を設定
UPDATE sales_dept.order_headers 
SET created_by = 'DB2INST1' 
WHERE created_by IS NULL;

-- セキュリティレベル情報のテーブル
CREATE TABLE sales_dept.user_regions (
    username VARCHAR(50) NOT NULL,
    allowed_region VARCHAR(50) NOT NULL,
    PRIMARY KEY (username, allowed_region)
);

INSERT INTO sales_dept.user_regions VALUES
('DB2INST1', 'ALL'),
('SALES_USER1', 'NORTH'),
('SALES_USER2', 'SOUTH'),
('MANAGER1', 'ALL');

-- 地域情報付きの顧客テーブル作成
CREATE TABLE sales_dept.customers_with_region (
    customer_id INTEGER PRIMARY KEY,
    company_name VARCHAR(100),
    region VARCHAR(50),
    created_by VARCHAR(50) DEFAULT USER
);

INSERT INTO sales_dept.customers_with_region VALUES
(2001, 'North Corp', 'NORTH', 'SALES_USER1'),
(2002, 'South Inc', 'SOUTH', 'SALES_USER2'),
(2003, 'East Company', 'EAST', 'DB2INST1'),
(2004, 'West Ltd', 'WEST', 'DB2INST1');

-- 行レベルセキュリティ用のビューの作成
CREATE VIEW sales_dept.secure_customers AS
SELECT 
    c.customer_id,
    c.company_name,
    c.region,
    c.created_by
FROM sales_dept.customers_with_region c
WHERE EXISTS (
    SELECT 1 
    FROM sales_dept.user_regions ur 
    WHERE ur.username = USER 
      AND (ur.allowed_region = 'ALL' OR ur.allowed_region = c.region)
)
OR c.created_by = USER;

-- セキュリティビューの権限設定
GRANT SELECT ON sales_dept.secure_customers TO PUBLIC;
REVOKE SELECT ON sales_dept.customers_with_region FROM PUBLIC;

-- セキュリティポリシーの関数作成
CREATE OR REPLACE FUNCTION sales_dept.can_access_order(
    order_user VARCHAR(50),
    order_amount DECIMAL(10,2)
)
RETURNS INTEGER
LANGUAGE SQL
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE access_level INTEGER DEFAULT 0;
    
    -- 自分が作成した注文は常にアクセス可能
    IF order_user = USER THEN
        SET access_level = 1;
    -- 管理者は全てアクセス可能
    ELSEIF USER IN ('DB2INST1', 'MANAGER1') THEN
        SET access_level = 1;
    -- 一般ユーザーは100以下の注文のみアクセス可能
    ELSEIF order_amount <= 100.00 THEN
        SET access_level = 1;
    END IF;
    
    RETURN access_level;
END;

-- セキュリティ関数を使用したビュー
CREATE VIEW sales_dept.secure_orders AS
SELECT 
    order_id,
    customer_id,
    order_date,
    total_amount,
    created_by
FROM sales_dept.order_headers
WHERE sales_dept.can_access_order(created_by, total_amount) = 1;

-- テスト用のアクセス確認
SELECT * FROM sales_dept.secure_customers;
SELECT COUNT(*) as accessible_orders FROM sales_dept.secure_orders;</code>

                        <h6>行レベルセキュリティの実装方法</h6>
                        <ul>
                            <li><strong>ビューベース</strong>: WHERE条件でアクセス制御</li>
                            <li><strong>関数ベース</strong>: 複雑な条件をストアドファンクションで実装</li>
                            <li><strong>ポリシーベース</strong>: DB2 LBACによる統合的な制御</li>
                            <li><strong>アプリケーション層</strong>: アプリケーションでの制御と組み合わせ</li>
                        </ul>
                    </div>

                    <!-- 7.5 監査とログ機能 -->
                    <h3 class="section-title">7.5 監査とログ機能</h3>
                    <p>DB2は包括的な監査機能を提供しており、データアクセスや操作の履歴を記録・分析することができます。</p>

                    <!-- 実習 7-5 -->
                    <div class="exercise-container">
                        <h5>実習 7-5: 基本的な監査設定と確認</h5>
                        <p>DB2の監査機能を使用して、データベースアクセスの記録と分析を行います。</p>
                        
                        <h6>実行するSQL</h6>
                        <code>-- 現在の監査設定の確認
SELECT 
    NAME as CONFIG_PARAM,
    VALUE as CURRENT_VALUE,
    DEFERRED_VALUE
FROM SYSIBMADM.DBCFG 
WHERE NAME LIKE '%AUDIT%';

-- セキュリティ関連の設定確認
SELECT 
    NAME,
    VALUE
FROM SYSIBMADM.DBCFG 
WHERE NAME IN ('RESTRICTIVE', 'SYSADM_GROUP', 'SYSCTRL_GROUP', 'SYSMAINT_GROUP');

-- ログイン失敗の監査（通常は管理者権限が必要）
-- CREATE AUDIT POLICY login_failures
-- CATEGORIES LOGIN STATUS FAILURE;

-- データアクセスの監査ポリシー（概念的な例）
-- CREATE AUDIT POLICY data_access_audit
-- CATEGORIES SELECT, INSERT, UPDATE, DELETE
-- STATUS SUCCESS
-- ERROR TYPE NORMAL;

-- 手動での操作ログ記録用テーブル
CREATE TABLE sales_dept.access_log (
    log_id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username VARCHAR(50) DEFAULT USER,
    table_name VARCHAR(100),
    operation VARCHAR(20),
    access_time TIMESTAMP DEFAULT CURRENT TIMESTAMP,
    ip_address VARCHAR(50),
    details VARCHAR(500)
);

-- ログ記録のトリガー作成例（簡易版）
-- 実際の本格的な監査にはDB2の監査機能を使用することを推奨

-- アクセスログの挿入プロシージャ
CREATE OR REPLACE PROCEDURE sales_dept.log_access(
    IN table_name VARCHAR(100),
    IN operation VARCHAR(20),
    IN details VARCHAR(500)
)
LANGUAGE SQL
BEGIN
    INSERT INTO sales_dept.access_log (table_name, operation, details)
    VALUES (table_name, operation, details);
END;

-- セキュリティイベントの確認用ビュー
CREATE VIEW sales_dept.security_events AS
SELECT 
    log_id,
    username,
    table_name,
    operation,
    access_time,
    details,
    CASE 
        WHEN operation IN ('DELETE', 'UPDATE') AND table_name LIKE '%MASTER%' THEN 'HIGH'
        WHEN operation = 'SELECT' AND details LIKE '%SENSITIVE%' THEN 'MEDIUM'
        ELSE 'LOW'
    END as risk_level
FROM sales_dept.access_log;

-- 手動でのアクセスログ記録例
CALL sales_dept.log_access('CUSTOMERS_MASTER', 'SELECT', 'Regular query execution');
CALL sales_dept.log_access('ORDER_HEADERS', 'UPDATE', 'Order status change');
CALL sales_dept.log_access('EMPLOYEE_INFO', 'SELECT', 'Salary information accessed');

-- セキュリティレポートの生成
SELECT 
    username,
    operation,
    COUNT(*) as operation_count,
    MAX(access_time) as last_access
FROM sales_dept.access_log
GROUP BY username, operation
ORDER BY username, operation_count DESC;

-- 高リスク操作の確認
SELECT * FROM sales_dept.security_events
WHERE risk_level IN ('HIGH', 'MEDIUM')
ORDER BY access_time DESC;

-- 異常なアクセスパターンの検出（例）
WITH access_patterns AS (
    SELECT 
        username,
        DATE(access_time) as access_date,
        COUNT(*) as daily_access_count
    FROM sales_dept.access_log
    GROUP BY username, DATE(access_time)
)
SELECT 
    username,
    access_date,
    daily_access_count,
    AVG(daily_access_count) OVER(PARTITION BY username) as avg_daily_access
FROM access_patterns
WHERE daily_access_count > 100  -- 閾値は環境に応じて調整
ORDER BY daily_access_count DESC;</code>

                        <h6>監査のベストプラクティス</h6>
                        <ul>
                            <li><strong>段階的な導入</strong>: 重要なテーブルから監査を開始</li>
                            <li><strong>パフォーマンス考慮</strong>: 監査ログによる性能影響を評価</li>
                            <li><strong>保管期間の設定</strong>: ログの保管期間とアーカイブ戦略</li>
                            <li><strong>定期的な分析</strong>: ログの定期的な分析と異常検知</li>
                        </ul>
                    </div>

                    <!-- 7.6 セキュリティのベストプラクティス -->
                    <h3 class="section-title">7.6 セキュリティのベストプラクティス</h3>
                    <p>DB2データベースのセキュリティを効果的に管理するための推奨事項と注意点を整理します。</p>

                    <div class="highlight">
                        <h5>セキュリティ設計の原則</h5>
                        <ul>
                            <li><strong>最小権限の原則</strong>: 必要最小限の権限のみ付与</li>
                            <li><strong>職務分離</strong>: 管理者、開発者、ユーザーの権限を分離</li>
                            <li><strong>多層防御</strong>: ネットワーク、OS、データベースの複数レベルでセキュリティを強化</li>
                            <li><strong>定期的な見直し</strong>: 権限とアクセスパターンの定期的な監査</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h5>⚠️ セキュリティ上の注意点</h5>
                        <ul>
                            <li><strong>デフォルトアカウント</strong>: デフォルトのパスワードは必ず変更</li>
                            <li><strong>PUBLIC権限</strong>: PUBLIC権限の付与は慎重に検討</li>
                            <li><strong>管理者権限</strong>: DBA権限の付与は最小限に制限</li>
                            <li><strong>パスワードポリシー</strong>: 強力なパスワードポリシーの設定</li>
                            <li><strong>接続暗号化</strong>: 本番環境では必ずSSL/TLS暗号化を使用</li>
                        </ul>
                    </div>

                    <div class="highlight">
                        <h5>セキュリティチェックリスト</h5>
                        <ol>
                            <li>不要なサンプルデータベースとユーザーの削除</li>
                            <li>強力な認証メカニズムの設定</li>
                            <li>最小権限に基づく役割の定義</li>
                            <li>機密データの暗号化</li>
                            <li>監査ログの有効化と定期的な確認</li>
                            <li>バックアップファイルのセキュリティ確保</li>
                            <li>定期的なセキュリティパッチの適用</li>
                            <li>インシデント対応計画の策定</li>
                        </ol>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>DB2でテーブルに対するSELECT権限を付与するSQL文はどれですか？</strong>
                                <ol type="a">
                                    <li>ALLOW SELECT ON table_name TO user_name</li>
                                    <li>GRANT SELECT ON table_name TO user_name</li>
                                    <li>PERMIT SELECT ON table_name TO user_name</li>
                                    <li>GIVE SELECT ON table_name TO user_name</li>
                                </ol>
                            </li>
                            <li><strong>DB2でロールを作成するSQL文はどれですか？</strong>
                                <ol type="a">
                                    <li>CREATE ROLE role_name</li>
                                    <li>DEFINE ROLE role_name</li>
                                    <li>ADD ROLE role_name</li>
                                    <li>NEW ROLE role_name</li>
                                </ol>
                            </li>
                            <li><strong>権限を剥奪するために使用するSQL文はどれですか？</strong>
                                <ol type="a">
                                    <li>REMOVE</li>
                                    <li>DELETE</li>
                                    <li>REVOKE</li>
                                    <li>CANCEL</li>
                                </ol>
                            </li>
                            <li><strong>DB2のセキュリティモデルで「最小権限の原則」とは何ですか？</strong>
                                <ol type="a">
                                    <li>可能な限り少ないユーザーを作成する</li>
                                    <li>業務に必要最小限の権限のみを付与する</li>
                                    <li>権限の付与期間を最短にする</li>
                                    <li>権限の種類を最小限に制限する</li>
                                </ol>
                            </li>
                        </ol>
                        
                        <details style="margin-top: 1rem;">
                            <summary>解答を見る</summary>
                            <div style="margin-top: 0.5rem;">
                                <p><strong>解答:</strong></p>
                                <ol>
                                    <li>b) GRANT SELECT ON table_name TO user_name</li>
                                    <li>a) CREATE ROLE role_name</li>
                                    <li>c) REVOKE</li>
                                    <li>b) 業務に必要最小限の権限のみを付与する</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="db2-learning-material-6.html" class="btn btn-secondary">← 前の章</a>
                        <a href="db2-learning-material-8.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>