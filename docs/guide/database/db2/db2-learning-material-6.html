<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB2学習教材 第6章 - DB2組み込み関数とストアドプロシージャ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #003d73;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #003d73;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #003d73;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #0062cc;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コード */
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            color: #d63384;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e6f1ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #003d73;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #003d73 !important;
            color: white !important;
        }

        .nav-link:hover {
            background-color: #0062cc !important;
            color: white !important;
        }

        /* テーブル */
        .table th {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">DB2学習教材</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../README.md">ガイドライン一覧</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>目次</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-1.html">第1章: DB2の基本概念と環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-2.html">第2章: Docker環境でのDB2セットアップ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-3.html">第3章: DB2クライアントツールの導入</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-4.html">第4章: DB2 SQLの基本</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-5.html">第5章: テーブル設計とインデックス基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#chapter6">第6章: DB2組み込み関数とストアドプロシージャ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-7.html">第7章: ユーザー管理と基本的なセキュリティ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="db2-learning-material-8.html">第8章: 基本的なデータベース管理操作</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: DB2組み込み関数とストアドプロシージャ</h1>
                </div>

                <div id="chapter6">
                    <h2 class="chapter-title">DB2組み込み関数とストアドプロシージャ</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>DB2独自の文字列操作関数の使用方法</li>
                            <li>日付・時刻操作関数の実践的な活用</li>
                            <li>数値計算とNULL処理関数の効果的な使用</li>
                            <li>ウィンドウ関数による高度なデータ分析</li>
                            <li>基本的なストアドプロシージャの作成と実行</li>
                        </ul>
                    </div>

                    <!-- 6.1 文字列操作関数 -->
                    <h3 class="section-title">6.1 文字列操作関数</h3>
                    <p>DB2は豊富な文字列操作関数を提供しており、データの変換や整形、検索処理を効率的に行うことができます。</p>

                    <h4>主要な文字列関数</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>関数名</th>
                                    <th>機能</th>
                                    <th>構文例</th>
                                    <th>用途</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>SUBSTR</td>
                                    <td>部分文字列の抽出</td>
                                    <td>SUBSTR(string, start, length)</td>
                                    <td>文字列の切り出し</td>
                                </tr>
                                <tr>
                                    <td>LENGTH</td>
                                    <td>文字列長の取得</td>
                                    <td>LENGTH(string)</td>
                                    <td>長さのチェック</td>
                                </tr>
                                <tr>
                                    <td>UPPER/LOWER</td>
                                    <td>大小文字変換</td>
                                    <td>UPPER(string)</td>
                                    <td>文字列の正規化</td>
                                </tr>
                                <tr>
                                    <td>TRIM</td>
                                    <td>空白の除去</td>
                                    <td>TRIM(string)</td>
                                    <td>データクレンジング</td>
                                </tr>
                                <tr>
                                    <td>REPLACE</td>
                                    <td>文字列の置換</td>
                                    <td>REPLACE(string, old, new)</td>
                                    <td>データ変換</td>
                                </tr>
                                <tr>
                                    <td>LOCATE</td>
                                    <td>文字列の検索</td>
                                    <td>LOCATE(search, string)</td>
                                    <td>位置の特定</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 実習 6-1 -->
                    <div class="exercise-container">
                        <h5>実習 6-1: 文字列操作関数の活用</h5>
                        <p>実際のデータを使用して、様々な文字列操作関数を実践的に使用します。</p>
                        
                        <h6>実行するSQL</h6>
                        <pre class="code-block"><code class="language-sql">-- テストデータの準備
CREATE TABLE sales_dept.customer_data (
    id INTEGER PRIMARY KEY,
    full_name VARCHAR(100),
    email VARCHAR(100),
    phone VARCHAR(20),
    address VARCHAR(200)
);

INSERT INTO sales_dept.customer_data VALUES
(1, ' John Smith ', 'JOHN.SMITH@email.com', '(555) 123-4567', '123 Main St, New York, NY 10001'),
(2, 'jane doe', 'jane.doe@COMPANY.COM', '555.987.6543', '456 Oak Ave, Los Angeles, CA 90210'),
(3, 'Bob Wilson Jr.', 'bob_wilson@test.org', '555-111-2222', 'P.O. Box 789, Chicago, IL 60601');

-- 基本的な文字列操作
SELECT 
    id,
    full_name,
    TRIM(full_name) as trimmed_name,
    LENGTH(full_name) as name_length,
    LENGTH(TRIM(full_name)) as trimmed_length
FROM sales_dept.customer_data;

-- 大小文字の変換と正規化
SELECT 
    id,
    full_name,
    UPPER(TRIM(full_name)) as upper_name,
    LOWER(TRIM(email)) as lower_email,
    INITCAP(TRIM(full_name)) as proper_name
FROM sales_dept.customer_data;

-- 部分文字列の抽出
SELECT 
    id,
    full_name,
    SUBSTR(TRIM(full_name), 1, LOCATE(' ', TRIM(full_name))-1) as first_name,
    SUBSTR(TRIM(full_name), LOCATE(' ', TRIM(full_name))+1) as last_name_part
FROM sales_dept.customer_data
WHERE LOCATE(' ', TRIM(full_name)) > 0;

-- 文字列の置換とクリーニング
SELECT 
    id,
    phone,
    REPLACE(REPLACE(REPLACE(phone, '(', ''), ')', ''), '-', '') as clean_phone,
    REPLACE(REPLACE(REPLACE(REPLACE(phone, '(', ''), ')', ''), '-', ''), '.', '') as numeric_phone,
    REPLACE(address, '.', '') as clean_address
FROM sales_dept.customer_data;

-- 複合的な文字列処理
SELECT 
    id,
    UPPER(TRIM(full_name)) as standardized_name,
    LOWER(TRIM(email)) as standardized_email,
    TRANSLATE(REPLACE(REPLACE(REPLACE(phone, '(', ''), ')', ''), '-', ''), '.', '-') as formatted_phone,
    CASE 
        WHEN LOCATE('@', email) > 0 THEN 
            SUBSTR(email, LOCATE('@', email)+1)
        ELSE 'UNKNOWN'
    END as email_domain
FROM sales_dept.customer_data;</code></pre>

                        <h6>学習ポイント</h6>
                        <ul>
                            <li>TRIM関数による空白除去の重要性</li>
                            <li>LOCATE関数を使った動的な文字列分割</li>
                            <li>REPLACE関数による段階的なデータクリーニング</li>
                            <li>CASE文と文字列関数の組み合わせ</li>
                        </ul>
                    </div>

                    <!-- 6.2 日付・時刻操作関数 -->
                    <h3 class="section-title">6.2 日付・時刻操作関数</h3>
                    <p>DB2の日付・時刻関数を使用することで、複雑な日付計算やフォーマット変換を効率的に実行できます。</p>

                    <!-- 実習 6-2 -->
                    <div class="exercise-container">
                        <h5>実習 6-2: 日付・時刻関数の実践</h5>
                        <p>日付・時刻データの操作と分析を行う実践的な例を学習します。</p>
                        
                        <h6>実行するSQL</h6>
                        <pre class="code-block"><code class="language-sql">-- 日付関数の基本
SELECT 
    CURRENT DATE as today,
    CURRENT TIME as now,
    CURRENT TIMESTAMP as now_with_timestamp,
    CURRENT TIMEZONE as timezone_offset;

-- 日付の計算と操作
SELECT 
    CURRENT DATE as today,
    CURRENT DATE + 30 DAYS as thirty_days_later,
    CURRENT DATE - 1 MONTH as one_month_ago,
    CURRENT DATE + 1 YEAR as one_year_later,
    DATE('2024-12-31') - CURRENT DATE as days_to_year_end;

-- 日付から各部分を抽出
SELECT 
    CURRENT TIMESTAMP as full_timestamp,
    YEAR(CURRENT DATE) as current_year,
    MONTH(CURRENT DATE) as current_month,
    DAY(CURRENT DATE) as current_day,
    DAYOFWEEK(CURRENT DATE) as day_of_week,
    DAYOFYEAR(CURRENT DATE) as day_of_year,
    WEEK(CURRENT DATE) as week_of_year;

-- 注文データでの日付分析
SELECT 
    order_id,
    order_date,
    YEAR(order_date) as order_year,
    MONTH(order_date) as order_month,
    MONTHNAME(order_date) as month_name,
    DAYNAME(order_date) as day_name,
    DAYS(CURRENT DATE) - DAYS(order_date) as days_since_order,
    CASE 
        WHEN DAYS(CURRENT DATE) - DAYS(order_date) <= 7 THEN 'This Week'
        WHEN DAYS(CURRENT DATE) - DAYS(order_date) <= 30 THEN 'This Month'
        WHEN DAYS(CURRENT DATE) - DAYS(order_date) <= 90 THEN 'This Quarter'
        ELSE 'Older'
    END as recency_category
FROM sales_dept.order_headers
LIMIT 10;

-- 日付範囲での集計分析
SELECT 
    YEAR(order_date) as year,
    MONTH(order_date) as month,
    COUNT(*) as order_count,
    SUM(total_amount) as monthly_sales,
    AVG(total_amount) as avg_order_value
FROM sales_dept.order_headers
WHERE order_date >= CURRENT DATE - 1 YEAR
GROUP BY YEAR(order_date), MONTH(order_date)
ORDER BY year DESC, month DESC;

-- 営業日計算（土日を除く）
WITH business_days AS (
    SELECT 
        order_date,
        CASE 
            WHEN DAYOFWEEK(order_date) IN (1, 7) THEN 'Weekend'
            ELSE 'Weekday'
        END as day_type
    FROM sales_dept.order_headers
)
SELECT 
    day_type,
    COUNT(*) as order_count
FROM business_days
GROUP BY day_type;</code></pre>

                        <h6>日付関数の活用場面</h6>
                        <ul>
                            <li><strong>期間分析</strong>: 月次、四半期、年次の集計</li>
                            <li><strong>トレンド分析</strong>: 時系列データの変化追跡</li>
                            <li><strong>営業日計算</strong>: 業務日のみでの計算</li>
                            <li><strong>期限管理</strong>: 残日数や期限切れの判定</li>
                        </ul>
                    </div>

                    <!-- 6.3 NULL処理と条件分岐関数 -->
                    <h3 class="section-title">6.3 NULL処理と条件分岐関数</h3>
                    <p>データの欠損値やビジネスロジックに応じた条件分岐を効率的に処理する関数群です。</p>

                    <!-- 実習 6-3 -->
                    <div class="exercise-container">
                        <h5>実習 6-3: NULL処理と条件分岐の実装</h5>
                        <p>実際のデLOCAL環境でNULL値の処理と複雑な条件分岐を実装します。</p>
                        
                        <h6>実行するSQL</h6>
                        <pre class="code-block"><code class="language-sql">-- NULL処理のテストデータ作成
CREATE TABLE sales_dept.employee_info (
    emp_id INTEGER PRIMARY KEY,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    department VARCHAR(50),
    salary DECIMAL(10,2),
    commission DECIMAL(8,2),
    manager_id INTEGER,
    hire_date DATE
);

INSERT INTO sales_dept.employee_info VALUES
(101, 'John', 'Smith', 'Sales', 50000.00, 5000.00, 201, '2023-01-15'),
(102, 'Jane', 'Doe', 'IT', 60000.00, NULL, 202, '2023-02-01'),
(103, 'Bob', 'Wilson', 'Sales', 45000.00, 3000.00, 201, '2023-03-10'),
(104, 'Alice', 'Johnson', NULL, 55000.00, NULL, NULL, '2023-04-05'),
(105, 'Mike', 'Brown', 'IT', NULL, NULL, 202, '2023-05-20');

-- COALESCE関数によるNULL値の代替
SELECT 
    emp_id,
    first_name,
    last_name,
    COALESCE(department, 'Unassigned') as department,
    COALESCE(salary, 0) as salary,
    COALESCE(commission, 0) as commission,
    salary + COALESCE(commission, 0) as total_compensation
FROM sales_dept.employee_info;

-- NULLIF関数の使用（ゼロをNULLに変換）
SELECT 
    emp_id,
    first_name,
    salary,
    commission,
    NULLIF(commission, 0) as commission_if_not_zero,
    COALESCE(NULLIF(commission, 0), salary * 0.05) as effective_commission
FROM sales_dept.employee_info;

-- CASE文による複雑な条件分岐
SELECT 
    emp_id,
    first_name,
    last_name,
    salary,
    CASE 
        WHEN salary IS NULL THEN 'Salary Not Set'
        WHEN salary < 45000 THEN 'Entry Level'
        WHEN salary BETWEEN 45000 AND 55000 THEN 'Mid Level'
        WHEN salary > 55000 THEN 'Senior Level'
        ELSE 'Unknown'
    END as salary_grade,
    CASE 
        WHEN department = 'Sales' AND commission > 0 THEN 'Sales with Commission'
        WHEN department = 'Sales' AND (commission IS NULL OR commission = 0) THEN 'Sales Base Only'
        WHEN department = 'IT' THEN 'Technology'
        WHEN department IS NULL THEN 'Unassigned'
        ELSE department
    END as department_category
FROM sales_dept.employee_info;

-- 複合的なNULL処理とビジネスロジック
SELECT 
    emp_id,
    first_name || ' ' || last_name as full_name,
    COALESCE(department, 'Pending Assignment') as dept,
    COALESCE(salary, 40000) as base_salary,
    CASE 
        WHEN commission IS NULL THEN 
            CASE 
                WHEN department = 'Sales' THEN salary * 0.10
                ELSE 0
            END
        ELSE commission
    END as calculated_commission,
    CASE 
        WHEN manager_id IS NULL THEN 'No Manager'
        ELSE 'Manager ID: ' || CHAR(manager_id)
    END as manager_status,
    MONTHS_BETWEEN(CURRENT DATE, hire_date) as months_employed
FROM sales_dept.employee_info;</code></pre>

                        <h6>NULL処理のベストプラクティス</h6>
                        <ul>
                            <li><strong>COALESCE</strong>: 複数の値から最初の非NULL値を取得</li>
                            <li><strong>NULLIF</strong>: 条件に合致する場合にNULLを返す</li>
                            <li><strong>CASE文</strong>: 複雑な条件分岐とデフォルト値設定</li>
                            <li><strong>IS NULL/IS NOT NULL</strong>: 明示的なNULL判定</li>
                        </ul>
                    </div>

                    <!-- 6.4 ウィンドウ関数による分析 -->
                    <h3 class="section-title">6.4 ウィンドウ関数による分析</h3>
                    <p>ウィンドウ関数は、集計関数とは異なり、各行のコンテキストを保持しながら計算を行う強力な機能です。</p>

                    <!-- 実習 6-4 -->
                    <div class="exercise-container">
                        <h5>実習 6-4: ウィンドウ関数による高度な分析</h5>
                        <p>ROW_NUMBER, RANK, LAGなどのウィンドウ関数を使用した分析を実践します。</p>
                        
                        <h6>実行するSQL</h6>
                        <pre class="code-block"><code class="language-sql">-- ランキング関数の使用
SELECT 
    emp_id,
    first_name,
    last_name,
    department,
    salary,
    ROW_NUMBER() OVER(ORDER BY salary DESC) as salary_row_number,
    RANK() OVER(ORDER BY salary DESC) as salary_rank,
    DENSE_RANK() OVER(ORDER BY salary DESC) as salary_dense_rank,
    PERCENT_RANK() OVER(ORDER BY salary DESC) as salary_percentile
FROM sales_dept.employee_info
WHERE salary IS NOT NULL;

-- 部門別ランキング
SELECT 
    emp_id,
    first_name,
    department,
    salary,
    ROW_NUMBER() OVER(PARTITION BY department ORDER BY salary DESC) as dept_rank,
    RANK() OVER(PARTITION BY department ORDER BY salary DESC) as dept_salary_rank,
    AVG(salary) OVER(PARTITION BY department) as dept_avg_salary,
    salary - AVG(salary) OVER(PARTITION BY department) as salary_diff_from_avg
FROM sales_dept.employee_info
WHERE salary IS NOT NULL AND department IS NOT NULL;

-- 受注データでの時系列分析
SELECT 
    order_id,
    order_date,
    total_amount,
    ROW_NUMBER() OVER(ORDER BY order_date) as order_sequence,
    LAG(total_amount) OVER(ORDER BY order_date) as previous_order_amount,
    LEAD(total_amount) OVER(ORDER BY order_date) as next_order_amount,
    total_amount - LAG(total_amount) OVER(ORDER BY order_date) as amount_change,
    SUM(total_amount) OVER(ORDER BY order_date ROWS UNBOUNDED PRECEDING) as running_total,
    AVG(total_amount) OVER(ORDER BY order_date ROWS 2 PRECEDING) as moving_avg_3days
FROM sales_dept.order_headers
ORDER BY order_date;

-- 月次集計での比較分析
WITH monthly_sales AS (
    SELECT 
        YEAR(order_date) as year,
        MONTH(order_date) as month,
        SUM(total_amount) as monthly_total
    FROM sales_dept.order_headers
    GROUP BY YEAR(order_date), MONTH(order_date)
)
SELECT 
    year,
    month,
    monthly_total,
    LAG(monthly_total) OVER(ORDER BY year, month) as previous_month,
    monthly_total - LAG(monthly_total) OVER(ORDER BY year, month) as month_over_month_change,
    DECIMAL(
        (monthly_total - LAG(monthly_total) OVER(ORDER BY year, month)) / 
        LAG(monthly_total) OVER(ORDER BY year, month) * 100, 
        10, 2
    ) as percent_change,
    AVG(monthly_total) OVER(ORDER BY year, month ROWS 2 PRECEDING) as moving_avg_3months
FROM monthly_sales
ORDER BY year, month;

-- パーティション別の詳細分析
SELECT 
    order_id,
    customer_id,
    order_date,
    total_amount,
    COUNT(*) OVER(PARTITION BY customer_id) as customer_total_orders,
    SUM(total_amount) OVER(PARTITION BY customer_id) as customer_total_amount,
    AVG(total_amount) OVER(PARTITION BY customer_id) as customer_avg_order,
    RANK() OVER(PARTITION BY customer_id ORDER BY total_amount DESC) as customer_order_rank,
    FIRST_VALUE(order_date) OVER(PARTITION BY customer_id ORDER BY order_date) as first_order_date,
    LAST_VALUE(order_date) OVER(PARTITION BY customer_id ORDER BY order_date 
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) as last_order_date
FROM sales_dept.order_headers
ORDER BY customer_id, order_date;</code></pre>

                        <h6>ウィンドウ関数の種類と用途</h6>
                        <ul>
                            <li><strong>ランキング関数</strong>: ROW_NUMBER, RANK, DENSE_RANK</li>
                            <li><strong>オフセット関数</strong>: LAG, LEAD（前後の行の値を参照）</li>
                            <li><strong>集計関数</strong>: SUM, AVG, COUNT（ウィンドウ内での集計）</li>
                            <li><strong>フレーム関数</strong>: FIRST_VALUE, LAST_VALUE（範囲の最初/最後の値）</li>
                        </ul>
                    </div>

                    <!-- 6.5 ストアドプロシージャの基本 -->
                    <h3 class="section-title">6.5 ストアドプロシージャの基本</h3>
                    <p>ストアドプロシージャは、複数のSQL文をまとめて実行できる機能で、複雑なビジネスロジックの実装に適しています。</p>

                    <!-- 実習 6-5 -->
                    <div class="exercise-container">
                        <h5>実習 6-5: 基本的なストアドプロシージャの作成</h5>
                        <p>簡単なストアドプロシージャを作成し、パラメータを使った処理を実装します。</p>
                        
                        <h6>実行するSQL</h6>
                        <pre class="code-block"><code class="language-sql">-- 基本的なストアドプロシージャの作成
CREATE OR REPLACE PROCEDURE sales_dept.calculate_employee_bonus(
    IN emp_id INTEGER,
    OUT bonus_amount DECIMAL(10,2),
    OUT bonus_message VARCHAR(200)
)
LANGUAGE SQL
BEGIN
    DECLARE emp_salary DECIMAL(10,2);
    DECLARE emp_dept VARCHAR(50);
    DECLARE years_employed DECIMAL(5,2);
    
    -- 従業員情報の取得
    SELECT 
        COALESCE(salary, 0),
        COALESCE(department, 'Unknown'),
        DECIMAL(MONTHS_BETWEEN(CURRENT DATE, hire_date) / 12.0, 5, 2)
    INTO emp_salary, emp_dept, years_employed
    FROM sales_dept.employee_info
    WHERE employee_info.emp_id = calculate_employee_bonus.emp_id;
    
    -- ボーナス計算のロジック
    IF emp_salary = 0 THEN
        SET bonus_amount = 0;
        SET bonus_message = 'No salary information available';
    ELSEIF years_employed < 1 THEN
        SET bonus_amount = emp_salary * 0.05;
        SET bonus_message = 'New employee bonus: 5% of salary';
    ELSEIF years_employed >= 1 AND years_employed < 3 THEN
        IF emp_dept = 'Sales' THEN
            SET bonus_amount = emp_salary * 0.12;
            SET bonus_message = 'Sales department bonus: 12% of salary';
        ELSE
            SET bonus_amount = emp_salary * 0.10;
            SET bonus_message = 'Standard bonus: 10% of salary';
        END IF;
    ELSE
        IF emp_dept = 'Sales' THEN
            SET bonus_amount = emp_salary * 0.15;
            SET bonus_message = 'Senior sales bonus: 15% of salary';
        ELSE
            SET bonus_amount = emp_salary * 0.13;
            SET bonus_message = 'Senior employee bonus: 13% of salary';
        END IF;
    END IF;
END;

-- データ処理用のストアドプロシージャ
CREATE OR REPLACE PROCEDURE sales_dept.update_order_status(
    IN order_id INTEGER,
    IN new_status VARCHAR(20),
    OUT result_code INTEGER,
    OUT result_message VARCHAR(200)
)
LANGUAGE SQL
BEGIN
    DECLARE current_status VARCHAR(20);
    DECLARE order_count INTEGER;
    
    -- 注文の存在確認
    SELECT COUNT(*), COALESCE(status, 'UNKNOWN')
    INTO order_count, current_status
    FROM sales_dept.order_headers
    WHERE order_headers.order_id = update_order_status.order_id;
    
    IF order_count = 0 THEN
        SET result_code = -1;
        SET result_message = 'Order not found';
    ELSEIF current_status = new_status THEN
        SET result_code = 0;
        SET result_message = 'Status unchanged: ' || current_status;
    ELSEIF new_status NOT IN ('PENDING', 'CONFIRMED', 'SHIPPED', 'DELIVERED', 'CANCELLED') THEN
        SET result_code = -2;
        SET result_message = 'Invalid status: ' || new_status;
    ELSE
        UPDATE sales_dept.order_headers 
        SET status = new_status
        WHERE order_headers.order_id = update_order_status.order_id;
        
        SET result_code = 1;
        SET result_message = 'Status updated from ' || current_status || ' to ' || new_status;
    END IF;
END;

-- ストアドプロシージャの実行
CALL sales_dept.calculate_employee_bonus(101, ?, ?);
CALL sales_dept.calculate_employee_bonus(102, ?, ?);
CALL sales_dept.calculate_employee_bonus(105, ?, ?);

-- 注文ステータス更新の実行
CALL sales_dept.update_order_status(1001, 'SHIPPED', ?, ?);
CALL sales_dept.update_order_status(9999, 'DELIVERED', ?, ?);
CALL sales_dept.update_order_status(1001, 'INVALID_STATUS', ?, ?);

-- ストアドプロシージャ情報の確認
SELECT 
    PROCSCHEMA,
    PROCNAME,
    PARM_COUNT,
    CREATED,
    LAST_REGEN_TIME
FROM SYSCAT.PROCEDURES
WHERE PROCSCHEMA = 'SALES_DEPT';</code></pre>

                        <h6>ストアドプロシージャの利点</h6>
                        <ul>
                            <li><strong>パフォーマンス</strong>: コンパイル済みでネットワーク通信を削減</li>
                            <li><strong>セキュリティ</strong>: 直接的なテーブルアクセスを制限</li>
                            <li><strong>再利用性</strong>: 複雑なロジックをモジュール化</li>
                            <li><strong>整合性</strong>: ビジネスルールをデータベース側で保証</li>
                        </ul>
                    </div>

                    <!-- 6.6 関数とプロシージャの使い分け -->
                    <h3 class="section-title">6.6 関数とプロシージャの使い分け</h3>
                    <p>組み込み関数とストアドプロシージャの特徴を理解し、適切な場面で使い分けることが重要です。</p>

                    <div class="highlight">
                        <h5>使い分けの指針</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">

                                <thead>
                                    <tr>
                                        <th>項目</th>
                                        <th>組み込み関数</th>
                                        <th>ストアドプロシージャ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>用途</td>
                                        <td>データ変換・計算</td>
                                        <td>複雑な業務処理</td>
                                    </tr>
                                    <tr>
                                        <td>戻り値</td>
                                        <td>単一の値</td>
                                        <td>複数の出力パラメータ</td>
                                    </tr>
                                    <tr>
                                        <td>使用場所</td>
                                        <td>SELECT文、WHERE句など</td>
                                        <td>CALL文での呼び出し</td>
                                    </tr>
                                    <tr>
                                        <td>トランザクション</td>
                                        <td>影響しない</td>
                                        <td>制御可能</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="warning">
                        <h5>⚠️ パフォーマンスに関する注意</h5>
                        <ul>
                            <li>文字列関数の多用は処理速度に影響する場合があります</li>
                            <li>ウィンドウ関数は大きなデータセットでメモリを多く消費します</li>
                            <li>ストアドプロシージャ内でのカーソル処理は慎重に設計してください</li>
                            <li>複雑な関数の組み合わせは可読性を損なう可能性があります</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>DB2で文字列の長さを取得する関数はどれですか？</strong>
                                <ol type="a">
                                    <li>LEN(string)</li>
                                    <li>LENGTH(string)</li>
                                    <li>SIZE(string)</li>
                                    <li>COUNT(string)</li>
                                </ol>
                            </li>
                            <li><strong>NULL値を別の値で置き換えるDB2関数はどれですか？</strong>
                                <ol type="a">
                                    <li>ISNULL(value, replacement)</li>
                                    <li>NVL(value, replacement)</li>
                                    <li>COALESCE(value, replacement)</li>
                                    <li>IFNULL(value, replacement)</li>
                                </ol>
                            </li>
                            <li><strong>ウィンドウ関数で前の行の値を取得する関数はどれですか？</strong>
                                <ol type="a">
                                    <li>PREVIOUS()</li>
                                    <li>LAG()</li>
                                    <li>PRIOR()</li>
                                    <li>BEFORE()</li>
                                </ol>
                            </li>
                            <li><strong>ストアドプロシージャを実行するSQL文はどれですか？</strong>
                                <ol type="a">
                                    <li>EXECUTE procedure_name</li>
                                    <li>RUN procedure_name</li>
                                    <li>CALL procedure_name</li>
                                    <li>INVOKE procedure_name</li>
                                </ol>
                            </li>
                        </ol>
                        
                        <details style="margin-top: 1rem;">
                            <summary>解答を見る</summary>
                            <div style="margin-top: 0.5rem;">
                                <p><strong>解答:</strong></p>
                                <ol>
                                    <li>b) LENGTH(string)</li>
                                    <li>c) COALESCE(value, replacement)</li>
                                    <li>b) LAG()</li>
                                    <li>c) CALL procedure_name</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="db2-learning-material-5.html" class="btn btn-secondary">← 前の章</a>
                        <a href="db2-learning-material-7.html" class="btn btn-primary">次の章 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>