<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django + PostgreSQL チュートリアル Step 2 - Docker DesktopとPostgreSQL環境構築</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #2e7d33;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #2e7d33;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d33;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #4caf50;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d33;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #2e7d33 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Django + PostgreSQL チュートリアル</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step2-docker-postgresql.html">
                                Step 2: PostgreSQL環境
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-django-project-init.html">
                                Step 3: プロジェクト初期化
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-models-migration.html">
                                Step 4: モデル設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-views-templates-urls.html">
                                Step 5: ビュー・テンプレート
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-admin-interface.html">
                                Step 6: 管理サイト
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-crud-operations.html">
                                Step 7: CRUD操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step8-validation-security.html">
                                Step 8: バリデーション・セキュリティ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step9-testing-debugging.html">
                                Step 9: テスト・デバッグ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 2: Docker DesktopとPostgreSQL環境構築</h1>
                </div>

                <div id="step2">
                    <h2 class="chapter-title">コンテナベースのデータベース環境構築</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Docker Desktop for Windowsのインストールと設定</li>
                            <li>WSL2（Windows Subsystem for Linux）の設定と最適化</li>
                            <li>Docker Composeを使用したPostgreSQLコンテナの作成</li>
                            <li>pgAdmin4管理ツールの設定と使用方法</li>
                            <li>データベース接続設定と初期データベースの作成</li>
                            <li>DjangoからPostgreSQLへの接続設定</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.1 Docker Desktop for Windowsのインストール</h3>
                    <p>開発環境の一貫性を保つため、コンテナ技術を活用してPostgreSQLデータベース環境を構築します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-1: Docker Desktop for Windowsのインストール</h5>
                        <p>Docker公式サイトからDocker Desktop for Windowsをダウンロードしてインストールします。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>Docker公式サイト（https://www.docker.com/products/docker-desktop/）にアクセス</li>
                            <li>「Download for Windows」をクリックしてインストーラーをダウンロード</li>
                            <li>ダウンロードしたインストーラーを管理者権限で実行</li>
                            <li>インストール時の設定：
                                <ul>
                                    <li><strong>「Use WSL 2 instead of Hyper-V」を選択</strong></li>
                                    <li>「Add shortcut to desktop」にチェック</li>
                                </ul>
                            </li>
                            <li>インストール完了後にシステム再起動</li>
                            <li>Docker Desktopを起動し、利用規約に同意</li>
                        </ol>
                        <h6>インストール確認</h6>
                        <pre class="code-block"><code class="language-bash"># Dockerバージョン確認
docker --version

# Docker Compose バージョン確認
docker-compose --version

# Docker動作確認
docker run hello-world</code></pre>
                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash">Docker version 24.x.x, build xxxxxxx
Docker Compose version v2.x.x

Hello from Docker!
This message shows that your installation appears to be working correctly.</code></pre>
                    </div>

                    <div class="warning">
                        <h5>Windows環境でのDocker注意点</h5>
                        <ul>
                            <li><strong>WSL2バックエンド</strong>: Windows 10/11でのDockerの推奨実行環境</li>
                            <li><strong>Hyper-V</strong>: 古いWindows環境や企業環境での制限がある場合</li>
                            <li><strong>メモリ使用量</strong>: WSL2は初期設定で多くのメモリを使用する場合あり</li>
                            <li><strong>ファイル共有</strong>: WindowsとWSL2間でのファイル共有パフォーマンス</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.2 WSL2の設定と最適化</h3>
                    <p>Docker DesktopのWSL2バックエンドを最適化し、開発に適した環境に調整します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-2: WSL2設定の最適化</h5>
                        <p>Docker開発に適したWSL2の設定を行い、パフォーマンスを最適化します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>PowerShellを管理者権限で起動</li>
                            <li>WSL2の現在の状態を確認</li>
                            <li>WSL2の設定ファイルを作成・編集</li>
                            <li>設定を適用してWSL2を再起動</li>
                        </ol>
                        <h6>WSL状態確認</h6>
                        <pre class="code-block"><code class="language-bash"># WSL2の状態確認
wsl --list --verbose

# WSL2がデフォルトバージョンかどうか確認
wsl --status</code></pre>
                        
                        <h6>WSL設定ファイル（%UserProfile%\.wslconfig）</h6>
                        <pre class="code-block"><code class="language-ini">[wsl2]
# WSL2で使用するメモリの制限（システムメモリの50%程度を推奨）
memory=4GB

# WSL2で使用するプロセッサ数の制限
processors=4

# スワップファイルサイズの制限
swap=1GB

# ローカルホスト経由でのアクセスを有効化
localhostForwarding=true</code></pre>

                        <h6>WSL2再起動</h6>
                        <pre class="code-block"><code class="language-bash"># 全てのWSL2インスタンスをシャットダウン
wsl --shutdown

# Docker Desktopを再起動</code></pre>
                    </div>

                    <h3 class="section-title">2.3 Docker Compose設定ファイルの作成</h3>
                    <p>PostgreSQLとpgAdmin4を同時に管理するためのDocker Compose設定を作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-3: Docker Compose設定ファイルの作成</h5>
                        <p>PostgreSQLデータベースとpgAdmin4管理ツールをコンテナとして起動する設定を作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>プロジェクトルートディレクトリにdocker-compose.ymlファイルを作成</li>
                            <li>PostgreSQLサービスの設定を記述</li>
                            <li>pgAdmin4サービスの設定を記述</li>
                            <li>ボリューム設定でデータの永続化を設定</li>
                        </ol>
                        <h6>Docker Compose設定（docker-compose.yml）</h6>
                        <pre class="code-block"><code class="language-bash">version: '3.8'

services:
  # PostgreSQL データベースサービス
  postgres:
    image: postgres:16
    container_name: django_postgres
    environment:
      POSTGRES_USER: django_user
      POSTGRES_PASSWORD: django_password
      POSTGRES_DB: django_db
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U django_user -d django_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin4 管理ツール
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: django_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local</code></pre>
                    </div>

                    <h3 class="section-title">2.4 PostgreSQLコンテナの起動と管理</h3>
                    <p>作成したDocker Compose設定を使用してPostgreSQLコンテナを起動し、管理方法を学習します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-4: PostgreSQLコンテナの起動と管理</h5>
                        <p>Docker Composeを使用してPostgreSQLとpgAdmin4を起動し、基本的な管理操作を実行します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>コンテナをバックグラウンドで起動</li>
                            <li>コンテナの動作状況を確認</li>
                            <li>PostgreSQLコンテナに直接アクセス</li>
                            <li>基本的なPostgreSQLコマンドの実行</li>
                        </ol>
                        <h6>コンテナ起動</h6>
                        <pre class="code-block"><code class="language-bash"># Docker Composeでサービスを起動（バックグラウンド実行）
docker-compose up -d

# サービス状態の確認
docker-compose ps

# ログの確認
docker-compose logs postgres</code></pre>
                        
                        <h6>PostgreSQLコンテナへの接続</h6>
                        <pre class="code-block"><code class="language-bash"># PostgreSQLコンテナ内でpsqlクライアントを実行
docker-compose exec postgres psql -U django_user -d django_db

# PostgreSQLでの基本操作
\l        # データベース一覧
\dt       # テーブル一覧
\q        # psql終了</code></pre>

                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash"># docker-compose ps の結果例
NAME              COMMAND                  SERVICE    STATUS        PORTS
django_pgadmin    "/entrypoint.sh"        pgadmin    Up           0.0.0.0:5050-&gt;80/tcp
django_postgres   "docker-entrypoint.s…"  postgres   Up (healthy) 0.0.0.0:5432-&gt;5432/tcp</code></pre>
                    </div>

                    <h3 class="section-title">2.5 pgAdmin4管理ツールの設定</h3>
                    <p>WebベースのPostgreSQL管理ツールpgAdmin4をセットアップし、データベース管理の基本操作を学習します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-5: pgAdmin4による管理サイト接続設定</h5>
                        <p>pgAdmin4を使用してPostgreSQLデータベースへの接続を設定し、基本的なデータベース操作を行います。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>ブラウザでpgAdmin4にアクセス</li>
                            <li>管理者アカウントでログイン</li>
                            <li>PostgreSQLサーバーへの接続を設定</li>
                            <li>データベース、テーブル、ユーザー管理の基本操作を実行</li>
                        </ol>
                        <h6>pgAdmin4へのアクセス</h6>
                        <pre class="code-block"><code class="language-bash"># ブラウザで以下のURLにアクセス
http://localhost:5050

# ログイン情報
Email: admin@example.com
Password: admin</code></pre>
                        
                        <h6>PostgreSQLサーバー接続設定</h6>
                        <div style="border: 1px solid #ddd; padding: 1rem; margin: 1rem 0;">
                            <h6>接続情報</h6>
                            <ul>
                                <li><strong>Name</strong>: Django Development</li>
                                <li><strong>Host name/address</strong>: postgres</li>
                                <li><strong>Port</strong>: 5432</li>
                                <li><strong>Maintenance database</strong>: django_db</li>
                                <li><strong>Username</strong>: django_user</li>
                                <li><strong>Password</strong>: django_password</li>
                            </ul>
                        </div>
                        
                        <h6>基本的なSQL操作例</h6>
                        <pre class="code-block"><code class="language-sql">-- データベース情報の確認
SELECT version();

-- 現在の接続情報
SELECT current_database(), current_user;

-- テストテーブルの作成
CREATE TABLE test_table (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- サンプルデータの挿入
INSERT INTO test_table (name) VALUES ('Django Tutorial');

-- データの確認
SELECT * FROM test_table;</code></pre>
                    </div>

                    <h3 class="section-title">2.6 Djangoデータベース接続設定</h3>
                    <p>DjangoのデータベースバックエンドをSQLiteからPostgreSQLに変更し、接続設定を行います。</p>

                    <div class="exercise-container">
                        <h5>実習 2-6: Django設定でのPostgreSQL接続</h5>
                        <p>Djangoの設定ファイルを更新してPostgreSQLデータベースに接続できるよう設定します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>環境変数管理のための.envファイル作成</li>
                            <li>settings.pyファイルのデータベース設定を更新</li>
                            <li>接続テストとマイグレーション実行</li>
                            <li>Django管理ユーザーの作成</li>
                        </ol>
                        <h6>環境変数設定ファイル（.env）</h6>
                        <pre class="code-block"><code class="language-bash"># データベース設定
DB_NAME=django_db
DB_USER=django_user
DB_PASSWORD=django_password
DB_HOST=localhost
DB_PORT=5432

# Django設定
DEBUG=True
SECRET_KEY=your-secret-key-here

# セキュリティ設定
ALLOWED_HOSTS=localhost,127.0.0.1</code></pre>
                        
                        <h6>Django設定ファイル更新（myproject/settings.py）</h6>
                        <pre class="code-block"><code class="language-python">import os
from decouple import config

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = config('SECRET_KEY', default='django-insecure-temporary-key')

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = config('DEBUG', default=True, cast=bool)

ALLOWED_HOSTS = config('ALLOWED_HOSTS', default='localhost,127.0.0.1').split(',')

# Database
# https://docs.djangoproject.com/en/5.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': config('DB_NAME', default='django_db'),
        'USER': config('DB_USER', default='django_user'),
        'PASSWORD': config('DB_PASSWORD', default='django_password'),
        'HOST': config('DB_HOST', default='localhost'),
        'PORT': config('DB_PORT', default='5432'),
        'OPTIONS': {
            'charset': 'utf8',
        },
    }
}

# Internationalization
# https://docs.djangoproject.com/en/5.0/topics/i18n/

LANGUAGE_CODE = 'ja'
TIME_ZONE = 'Asia/Tokyo'
USE_I18N = True
USE_TZ = True</code></pre>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 2-7: 初期データベースセットアップ</h5>
                        <p>PostgreSQLデータベースに対してDjangoの初期マイグレーションを実行し、管理ユーザーを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>仮想環境が有効化されていることを確認</li>
                            <li>データベース接続テストを実行</li>
                            <li>Djangoの初期マイグレーションを実行</li>
                            <li>スーパーユーザーアカウントを作成</li>
                            <li>Django管理サイトでの動作確認</li>
                        </ol>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-bash"># 仮想環境の有効化（Windows）
venv\Scripts\activate

# データベース接続テスト
python manage.py dbshell

# 初期マイグレーションの実行
python manage.py migrate

# スーパーユーザーの作成
python manage.py createsuperuser

# 開発サーバーの起動
python manage.py runserver</code></pre>
                        <h6>期待されるマイグレーション結果</h6>
                        <pre class="code-block"><code class="language-bash">Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  # ... その他のマイグレーション

14 migrations applied successfully.</code></pre>
                    </div>

                    <h3 class="section-title">2.7 Docker環境の管理とメンテナンス</h3>
                    <p>開発環境として利用するDocker環境の基本的な管理操作とメンテナンス方法を学習します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-8: Docker環境の管理コマンド</h5>
                        <p>日常的なDocker環境の管理に必要な基本コマンドを習得します。</p>
                        <h6>基本管理コマンド</h6>
                        <pre class="code-block"><code class="language-bash"># サービスの状態確認
docker-compose ps

# サービスの停止
docker-compose stop

# サービスの開始
docker-compose start

# サービスの再起動
docker-compose restart

# サービスの完全停止と削除
docker-compose down

# ボリュームも含めて完全削除（注意：データも消える）
docker-compose down -v

# リソース使用量の確認
docker stats</code></pre>
                        
                        <h6>ログとデバッグ</h6>
                        <pre class="code-block"><code class="language-bash"># 全サービスのログを表示
docker-compose logs

# 特定サービスのログを表示
docker-compose logs postgres

# リアルタイムでログを監視
docker-compose logs -f

# PostgreSQLコンテナ内でシェル実行
docker-compose exec postgres bash

# PostgreSQLの設定ファイル確認
docker-compose exec postgres cat /var/lib/postgresql/data/postgresql.conf</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>Docker Composeについて</strong>: 
                                <p>Q. Docker Composeを使用する主な利点は何ですか？</p>
                                <p>A. 複数のコンテナを一つの設定ファイルで管理でき、アプリケーション全体を一度に起動・停止できる</p>
                            </li>
                            <li><strong>PostgreSQLの設定</strong>:
                                <p>Q. Django設定でpostgresql接続時に必要な主な設定項目は何ですか？</p>
                                <p>A. ENGINE（django.db.backends.postgresql）、NAME（データベース名）、USER、PASSWORD、HOST、PORTの設定</p>
                            </li>
                            <li><strong>コンテナの永続化</strong>:
                                <p>Q. Dockerボリュームを使用する理由は何ですか？</p>
                                <p>A. コンテナを削除してもデータが保持され、データの永続化とコンテナ間でのデータ共有が可能</p>
                            </li>
                        </ol>
                    </div>

                    <div class="highlight">
                        <h5>次のステップの準備</h5>
                        <p>Step 2が完了しました！次のStep 3では、Djangoプロジェクトの初期化と基本設定を行います。以下を確認してから進んでください：</p>
                        <ul>
                            <li>Docker DesktopがインストールされWSL2で正常動作している</li>
                            <li>PostgreSQLとpgAdmin4コンテナが起動している</li>
                            <li>pgAdmin4からPostgreSQLへの接続が確認できている</li>
                            <li>DjangoからPostgreSQLへの接続が設定済み</li>
                            <li>初期マイグレーションが完了しスーパーユーザーが作成済み</li>
                        </ul>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step1-environment-setup.html" class="btn btn-secondary">← 前の章: 環境構築</a>
                        <a href="step3-django-project-init.html" class="btn btn-primary">次の章: プロジェクト初期化 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>