<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« Step 4 - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #2196f3;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .chapter-title {
            color: #2196f3;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #1976d2;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #00bcd4;
        }

        .nav-link.active {
            background-color: #2196f3 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            color: #d63384;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            color: #212529;
            padding: 0;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç›®æ¬¡</h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: ç’°å¢ƒæ§‹ç¯‰
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">
                                Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">
                                Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step4-user-list-display.html">
                                Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">
                                Step 5: CRUDæ“ä½œ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-dashboard-visualization.html">
                                Step 6: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-security-deployment.html">
                                Step 7: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <span class="badge bg-primary">æ‰€è¦æ™‚é–“: 2.5æ™‚é–“</span>
                    </div>
                </div>

                <div id="step4">
                    <h2 class="chapter-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h2>
                    
                    <!-- å­¦ç¿’ç›®æ¨™ -->
                    <div class="highlight">
                        <h5>ã“ã®ç« ã§å­¦ã¶ã“ã¨</h5>
                        <ul>
                            <li>st.dataframeã‚’ä½¿ç”¨ã—ãŸåŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</li>
                            <li>å‹•çš„ãªæ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒšãƒ¼ã‚¸åˆ†å‰²ï¼‰ã®è¨­è¨ˆã¨å®Ÿè£…</li>
                            <li>ã‚«ãƒ©ãƒ ã®ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š</li>
                            <li>ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSV/Excelï¼‰æ©Ÿèƒ½ã®å®Ÿè£…</li>
                        </ul>
                    </div>

                    <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã®åŸºæœ¬ -->
                    <h3 class="section-title">4.1 Streamlitã§ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h3>
                    <p>Streamlitã¯ã€pandas DataFrameã¨ã®è¦ªå’Œæ€§ãŒé«˜ãã€åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºæ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚</p>
                    
                    <div class="info">
                        <h6>Streamlitãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³</h6>
                        <ul>
                            <li><strong>st.dataframe</strong>: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚½ãƒ¼ãƒˆã€ãƒ•ã‚£ãƒ«ã‚¿ä»˜ãï¼‰</li>
                            <li><strong>st.table</strong>: é™çš„ãªãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º</li>
                            <li><strong>st.data_editor</strong>: ç·¨é›†å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«</li>
                            <li><strong>st.column_config</strong>: ã‚«ãƒ©ãƒ ã®è©³ç´°è¨­å®š</li>
                            <li><strong>st.metric</strong>: çµ±è¨ˆå€¤ã®åŠ¹æœçš„ãªè¡¨ç¤º</li>
                        </ul>
                    </div>

                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®åŸºæœ¬å®Ÿè£… -->
                    <h3 class="section-title">4.2 åŸºæœ¬çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å®Ÿè£…</h3>
                    <p>SQLModelã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’pandas DataFrameã«å¤‰æ›ã—ã€Streamlitã§è¡¨ç¤ºã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 4-1: åŸºæœ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®ä½œæˆ</h5>
                        <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€åŸºæœ¬çš„ãªä¸€è¦§è¡¨ç¤ºã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><code>app/utils/data_processors.py</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>import pandas as pd
from typing import List, Dict, Any
from datetime import datetime
import io

from app.models.user import UserStatus, Department

def users_to_dataframe(users: List[dict]) -> pd.DataFrame:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’DataFrameã«å¤‰æ›"""
    if not users:
        return pd.DataFrame()
    
    data = []
    for user in users:
        user_data = {
            'ID': user.get('id'),
            'ãƒ¦ãƒ¼ã‚¶ãƒ¼å': user.get('username'),
            'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹': user.get('email'),
            'ãƒ•ãƒ«ãƒãƒ¼ãƒ ': user.get('full_name'),
            'å¹´é½¢': user.get('age') if user.get('age') else 'æœªè¨­å®š',
            'éƒ¨ç½²': get_department_display_name(Department(user.get('department'))),
            'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': get_status_display_name(UserStatus(user.get('status'))),
            'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–': 'âœ…' if user.get('is_active') else 'âŒ',
            'ä½œæˆæ—¥': user.get('created_at')[:10] if user.get('created_at') else '',
            'æ›´æ–°æ—¥': user.get('updated_at')[:10] if user.get('updated_at') else '',
            'æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³': user.get('last_login')[:16] if user.get('last_login') else 'æœªãƒ­ã‚°ã‚¤ãƒ³'
        }
        data.append(user_data)
    
    return pd.DataFrame(data)

def get_department_display_name(department: Department) -> str:
    """éƒ¨ç½²ã®è¡¨ç¤ºåã‚’å–å¾—"""
    if not department:
        return 'æœªè¨­å®š'
    
    department_map = {
        Department.ENGINEERING: 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°',
        Department.MARKETING: 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°',
        Department.SALES: 'å–¶æ¥­',
        Department.HR: 'äººäº‹',
        Department.FINANCE: 'è²¡å‹™',
        Department.OPERATIONS: 'é‹å–¶'
    }
    return department_map.get(department, department.value)

def get_status_display_name(status: UserStatus) -> str:
    """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤ºåã‚’å–å¾—"""
    if not status:
        return 'æœªè¨­å®š'
    
    status_map = {
        UserStatus.ACTIVE: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–',
        UserStatus.INACTIVE: 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–',
        UserStatus.PENDING: 'æ‰¿èªå¾…ã¡',
        UserStatus.SUSPENDED: 'åœæ­¢ä¸­'
    }
    return status_map.get(status, status.value)

def apply_filters(users: List[User], filters: Dict[str, Any]) -> List[User]:
    """ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’çµã‚Šè¾¼ã¿"""
    filtered_users = users.copy()
    
    # ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
    search_text = filters.get('search_text', '').lower()
    if search_text:
        filtered_users = [
            user for user in filtered_users
            if (search_text in user.username.lower() or
                search_text in user.email.lower() or
                search_text in user.full_name.lower())
        ]
    
    # éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿
    department_filter = filters.get('department')
    if department_filter and department_filter != 'ã™ã¹ã¦':
        dept_value = get_department_value_from_display(department_filter)
        if dept_value:
            filtered_users = [
                user for user in filtered_users
                if user.department == dept_value
            ]
    
    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
    status_filter = filters.get('status')
    if status_filter and status_filter != 'ã™ã¹ã¦':
        status_value = get_status_value_from_display(status_filter)
        if status_value:
            filtered_users = [
                user for user in filtered_users
                if user.status == status_value
            ]
    
    # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿
    active_filter = filters.get('is_active')
    if active_filter != 'ã™ã¹ã¦':
        is_active = active_filter == 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿'
        filtered_users = [
            user for user in filtered_users
            if user.is_active == is_active
        ]
    
    # å¹´é½¢ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿
    age_range = filters.get('age_range')
    if age_range and age_range != (0, 150):
        min_age, max_age = age_range
        filtered_users = [
            user for user in filtered_users
            if user.age and min_age <= user.age <= max_age
        ]
    
    return filtered_users

def get_department_value_from_display(display_name: str) -> Department:
    """è¡¨ç¤ºåã‹ã‚‰éƒ¨ç½²å€¤ã‚’å–å¾—"""
    display_to_value = {
        'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°': Department.ENGINEERING,
        'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°': Department.MARKETING,
        'å–¶æ¥­': Department.SALES,
        'äººäº‹': Department.HR,
        'è²¡å‹™': Department.FINANCE,
        'é‹å–¶': Department.OPERATIONS
    }
    return display_to_value.get(display_name)

def get_status_value_from_display(display_name: str) -> UserStatus:
    """è¡¨ç¤ºåã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤ã‚’å–å¾—"""
    display_to_value = {
        'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–': UserStatus.ACTIVE,
        'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–': UserStatus.INACTIVE,
        'æ‰¿èªå¾…ã¡': UserStatus.PENDING,
        'åœæ­¢ä¸­': UserStatus.SUSPENDED
    }
    return display_to_value.get(display_name)

def export_to_csv(df: pd.DataFrame) -> bytes:
    """DataFrameã‚’CSVã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
    output = io.StringIO()
    df.to_csv(output, index=False, encoding='utf-8-sig')
    return output.getvalue().encode('utf-8-sig')

def export_to_excel(df: pd.DataFrame) -> bytes:
    """DataFrameã‚’Excelã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
    output = io.BytesIO()
    
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, sheet_name='ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§', index=False)
        
        # ã‚»ãƒ«ã®æ›¸å¼è¨­å®š
        worksheet = writer.sheets['ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§']
        
        # ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        for col_num, value in enumerate(df.columns.values):
            cell = worksheet.cell(row=1, column=col_num + 1)
            cell.font = cell.font.copy(bold=True)
            cell.fill = cell.fill.copy(fgColor="CCCCCC")
        
        # åˆ—å¹…ã®è‡ªå‹•èª¿æ•´
        for column in worksheet.columns:
            max_length = 0
            column_letter = column[0].column_letter
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = min(max_length + 2, 50)
            worksheet.column_dimensions[column_letter].width = adjusted_width
    
    return output.getvalue()</code></pre>

                        <ol start="2">
                            <li><code>app/pages/user_list.py</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>import streamlit as st
import pandas as pd
from datetime import datetime
from typing import Dict, Any

from app.database.crud import UserCRUD
from app.models.user import UserStatus, Department
from app.utils.data_processors import (
    users_to_dataframe,
    apply_filters,
    export_to_csv,
    export_to_excel,
    get_department_display_name,
    get_status_display_name
)

def main():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    st.set_page_config(
        page_title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§",
        page_icon="ğŸ‘¥",
        layout="wide"
    )
    
    st.title("ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç®¡ç†")
    st.markdown("---")
    
    # ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    @st.cache_data(ttl=30)  # 30ç§’é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    def load_users():
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãï¼‰"""
        users = UserCRUD.get_users(limit=1000)
        # SQLModelã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¾æ›¸ã«å¤‰æ›ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯èƒ½ã«ã™ã‚‹
        return [user.model_dump() for user in users]
    
    users = load_users()
    
    if not users:
        st.warning("ğŸ“­ ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“")
        if st.button("ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒšãƒ¼ã‚¸ã¸"):
            st.switch_page("pages/add_user.py")
        return
    
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š
    with st.sidebar:
        st.header("ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿")
        
        # ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
        search_text = st.text_input(
            "ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢",
            placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã€åå‰ã§æ¤œç´¢",
            help="éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢ã•ã‚Œã¾ã™"
        )
        
        # éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿
        departments = ['ã™ã¹ã¦'] + [get_department_display_name(dept) for dept in Department]
        department_filter = st.selectbox(
            "ğŸ¢ éƒ¨ç½²",
            departments
        )
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
        statuses = ['ã™ã¹ã¦'] + [get_status_display_name(status) for status in UserStatus]
        status_filter = st.selectbox(
            "ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
            statuses
        )
        
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿
        active_filter = st.selectbox(
            "âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹",
            ['ã™ã¹ã¦', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿', 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿']
        )
        
        # å¹´é½¢ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿
        age_range = st.slider(
            "ğŸ‚ å¹´é½¢ç¯„å›²",
            min_value=0,
            max_value=150,
            value=(0, 150),
            step=1
        )
        
        # ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
        if st.button("ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢", use_container_width=True):
            st.rerun()
    
    # ãƒ•ã‚£ãƒ«ã‚¿ã®é©ç”¨
    filters = {
        'search_text': search_text,
        'department': department_filter,
        'status': status_filter,
        'is_active': active_filter,
        'age_range': age_range
    }
    
    filtered_users = apply_filters(users, filters)
    
    # çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°", len(users))
    
    with col2:
        active_count = len([u for u in users if u.is_active])
        st.metric("ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼", active_count)
    
    with col3:
        filtered_count = len(filtered_users)
        st.metric("ãƒ•ã‚£ãƒ«ã‚¿çµæœ", filtered_count)
    
    with col4:
        avg_age = sum(u.age for u in users if u.age) / len([u for u in users if u.age])
        st.metric("å¹³å‡å¹´é½¢", f"{avg_age:.1f}æ­³" if avg_age else "N/A")
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ä½œæˆã¨è¡¨ç¤º
    if filtered_users:
        df = users_to_dataframe(filtered_users)
        
        # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        st.markdown("---")
        col1, col2, col3 = st.columns([1, 1, 1])
        
        with col1:
            csv_data = export_to_csv(df)
            st.download_button(
                label="ğŸ“„ CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                data=csv_data,
                file_name=f"users_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                mime="text/csv",
                use_container_width=True
            )
        
        with col2:
            try:
                excel_data = export_to_excel(df)
                st.download_button(
                    label="ğŸ“Š Excel ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=excel_data,
                    file_name=f"users_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    use_container_width=True
                )
            except ImportError:
                st.info("Excelå‡ºåŠ›ã«ã¯openpyxlãŒå¿…è¦ã§ã™")
        
        with col3:
            if st.button("ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°", use_container_width=True):
                st.cache_data.clear()
                st.rerun()
        
        # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
        st.markdown("---")
        items_per_page = st.selectbox(
            "1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºä»¶æ•°",
            [10, 25, 50, 100],
            index=1
        )
        
        total_pages = (len(filtered_users) - 1) // items_per_page + 1
        
        if total_pages > 1:
            page = st.number_input(
                f"ãƒšãƒ¼ã‚¸ (1-{total_pages})",
                min_value=1,
                max_value=total_pages,
                value=1,
                step=1
            )
        else:
            page = 1
        
        # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
        start_idx = (page - 1) * items_per_page
        end_idx = start_idx + items_per_page
        paginated_df = df.iloc[start_idx:end_idx]
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡¨ç¤º
        st.subheader(f"ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ (ãƒšãƒ¼ã‚¸ {page}/{total_pages})")
        
        # ã‚«ãƒ©ãƒ è¨­å®š
        column_config = {
            'ID': st.column_config.NumberColumn(
                'ID',
                help='ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
                width='small'
            ),
            'ãƒ¦ãƒ¼ã‚¶ãƒ¼å': st.column_config.TextColumn(
                'ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
                help='ãƒ­ã‚°ã‚¤ãƒ³ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
                width='medium'
            ),
            'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹': st.column_config.TextColumn(
                'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
                help='é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
                width='large'
            ),
            'ãƒ•ãƒ«ãƒãƒ¼ãƒ ': st.column_config.TextColumn(
                'ãƒ•ãƒ«ãƒãƒ¼ãƒ ',
                help='è¡¨ç¤ºå',
                width='medium'
            ),
            'å¹´é½¢': st.column_config.NumberColumn(
                'å¹´é½¢',
                help='å¹´é½¢',
                width='small'
            ),
            'éƒ¨ç½²': st.column_config.TextColumn(
                'éƒ¨ç½²',
                help='æ‰€å±éƒ¨ç½²',
                width='medium'
            ),
            'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': st.column_config.TextColumn(
                'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
                help='ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
                width='medium'
            ),
            'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–': st.column_config.TextColumn(
                'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–',
                help='ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹',
                width='small'
            )
        }
        
        # é¸æŠå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
        selected_rows = st.dataframe(
            paginated_df,
            column_config=column_config,
            use_container_width=True,
            hide_index=True,
            on_select="rerun",
            selection_mode="multi-row"
        )
        
        # é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œ
        if selected_rows.selection.rows:
            st.markdown("---")
            st.subheader("ğŸ¯ é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œ")
            
            selected_users = paginated_df.iloc[selected_rows.selection.rows]
            st.write(f"é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: {len(selected_users)}")
            
            col1, col2, col3 = st.columns(3)
            
            with col1:
                if st.button("ğŸ“ ä¸€æ‹¬ç·¨é›†", use_container_width=True):
                    st.info("ä¸€æ‹¬ç·¨é›†æ©Ÿèƒ½ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…ã—ã¾ã™")
            
            with col2:
                if st.button("ğŸ“¤ é¸æŠãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ", use_container_width=True):
                    csv_selected = export_to_csv(selected_users)
                    st.download_button(
                        label="é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                        data=csv_selected,
                        file_name=f"selected_users_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                        mime="text/csv"
                    )
            
            with col3:
                if st.button("ğŸ—‘ï¸ é¸æŠå‰Šé™¤", use_container_width=True, type="secondary"):
                    st.warning("å‰Šé™¤æ©Ÿèƒ½ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…ã—ã¾ã™")
        
        # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        if total_pages > 1:
            st.markdown("---")
            col1, col2, col3, col4, col5 = st.columns(5)
            
            with col1:
                if page > 1:
                    if st.button("â®ï¸ æœ€åˆ"):
                        st.query_params.page = "1"
                        st.rerun()
            
            with col2:
                if page > 1:
                    if st.button("â—€ï¸ å‰ã¸"):
                        st.query_params.page = str(page - 1)
                        st.rerun()
            
            with col3:
                st.write(f"ãƒšãƒ¼ã‚¸ {page} / {total_pages}")
            
            with col4:
                if page < total_pages:
                    if st.button("â–¶ï¸ æ¬¡ã¸"):
                        st.query_params.page = str(page + 1)
                        st.rerun()
            
            with col5:
                if page < total_pages:
                    if st.button("â­ï¸ æœ€å¾Œ"):
                        st.query_params.page = str(total_pages)
                        st.rerun()
    
    else:
        st.info("ğŸ” æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“")
        st.markdown("æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„")

if __name__ == "__main__":
    main()</code></pre>

                        <ol start="3">
                            <li><code>requirements.txt</code>ã«Excelå‡¦ç†ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ï¼š</li>
                        </ol>
                        <pre><code>openpyxl==3.1.2</code></pre>

                        <ol start="4">
                            <li>ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š</li>
                        </ol>
                        <pre><code>pip install openpyxl</code></pre>

                        <ol start="5">
                            <li>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¦ãƒ†ã‚¹ãƒˆï¼š</li>
                        </ol>
                        <pre><code># ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•èµ·å‹•ã‚’ç„¡åŠ¹åŒ–ã—ã¦èµ·å‹•ï¼ˆWSLç’°å¢ƒæ¨å¥¨ï¼‰
PYTHONPATH=. streamlit run app/main.py --server.headless=true

# ã¾ãŸã¯é€šå¸¸èµ·å‹•
PYTHONPATH=. streamlit run app/main.py</code></pre>

                        <h6>å‹•ä½œç¢ºèªé …ç›®</h6>
                        <ul>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º</li>
                            <li>æ¤œç´¢æ©Ÿèƒ½</li>
                            <li>ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½</li>
                            <li>ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³</li>
                            <li>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½</li>
                        </ul>
                    </div>

                    <!-- é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° -->
                    <h3 class="section-title">4.3 é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨æ¤œç´¢</h3>
                    <p>è¤‡æ•°æ¡ä»¶ã‚’çµ„ã¿åˆã‚ã›ãŸè©³ç´°ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 4-2: é«˜åº¦ãªæ¤œç´¢æ©Ÿèƒ½ã®å®Ÿè£…</h5>
                        <p>æ—¥ä»˜ç¯„å›²æ¤œç´¢ã€è¤‡åˆæ¡ä»¶ã€ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><code>app/utils/advanced_filters.py</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>import streamlit as st
from datetime import datetime, date, timedelta
from typing import List, Dict, Any, Tuple
import pandas as pd

from app.models.user import User, UserStatus, Department

class AdvancedUserFilter:
    """é«˜åº¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.reset_filters()
    
    def reset_filters(self):
        """ãƒ•ã‚£ãƒ«ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ"""
        self.filters = {
            'text_search': '',
            'departments': [],
            'statuses': [],
            'is_active': None,
            'age_min': 0,
            'age_max': 150,
            'created_after': None,
            'created_before': None,
            'has_login': None,
            'sort_by': 'created_at',
            'sort_order': 'desc'
        }
    
    def render_sidebar_filters(self) -> Dict[str, Any]:
        """ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒ•ã‚£ãƒ«ã‚¿UIã‚’è¡¨ç¤º"""
        with st.sidebar:
            st.header("ğŸ” é«˜åº¦ãªæ¤œç´¢")
            
            # ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
            self.filters['text_search'] = st.text_input(
                "ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢",
                value=self.filters['text_search'],
                placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã€åå‰ã§æ¤œç´¢"
            )
            
            # éƒ¨ç½²è¤‡æ•°é¸æŠ
            department_options = [dept.value for dept in Department]
            department_labels = {
                'engineering': 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°',
                'marketing': 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°',
                'sales': 'å–¶æ¥­',
                'hr': 'äººäº‹', 
                'finance': 'è²¡å‹™',
                'operations': 'é‹å–¶'
            }
            
            selected_dept_labels = st.multiselect(
                "ğŸ¢ éƒ¨ç½²ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰",
                options=[department_labels[dept] for dept in department_options],
                default=[]
            )
            
            # è¡¨ç¤ºåã‹ã‚‰å€¤ã«å¤‰æ›
            self.filters['departments'] = [
                dept for dept, label in department_labels.items()
                if label in selected_dept_labels
            ]
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¤‡æ•°é¸æŠ
            status_options = [status.value for status in UserStatus]
            status_labels = {
                'active': 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–',
                'inactive': 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–',
                'pending': 'æ‰¿èªå¾…ã¡',
                'suspended': 'åœæ­¢ä¸­'
            }
            
            selected_status_labels = st.multiselect(
                "ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰",
                options=[status_labels[status] for status in status_options],
                default=[]
            )
            
            self.filters['statuses'] = [
                status for status, label in status_labels.items()
                if label in selected_status_labels
            ]
            
            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
            active_options = ['ã™ã¹ã¦', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿', 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿']
            active_selection = st.selectbox(
                "âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹",
                active_options
            )
            
            if active_selection == 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿':
                self.filters['is_active'] = True
            elif active_selection == 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿':
                self.filters['is_active'] = False
            else:
                self.filters['is_active'] = None
            
            # å¹´é½¢ç¯„å›²
            age_range = st.slider(
                "ğŸ‚ å¹´é½¢ç¯„å›²",
                min_value=0,
                max_value=150,
                value=(self.filters['age_min'], self.filters['age_max'])
            )
            self.filters['age_min'], self.filters['age_max'] = age_range
            
            # ä½œæˆæ—¥ãƒ•ã‚£ãƒ«ã‚¿
            st.markdown("ğŸ“… **ä½œæˆæ—¥ãƒ•ã‚£ãƒ«ã‚¿**")
            
            date_filter_type = st.selectbox(
                "æœŸé–“æŒ‡å®š",
                ['æŒ‡å®šãªã—', 'ä»Šæ—¥', 'ä»Šé€±', 'ä»Šæœˆ', 'éå»30æ—¥', 'ã‚«ã‚¹ã‚¿ãƒ ']
            )
            
            today = date.today()
            
            if date_filter_type == 'ä»Šæ—¥':
                self.filters['created_after'] = today
                self.filters['created_before'] = today
            elif date_filter_type == 'ä»Šé€±':
                week_start = today - timedelta(days=today.weekday())
                self.filters['created_after'] = week_start
                self.filters['created_before'] = today
            elif date_filter_type == 'ä»Šæœˆ':
                month_start = today.replace(day=1)
                self.filters['created_after'] = month_start
                self.filters['created_before'] = today
            elif date_filter_type == 'éå»30æ—¥':
                self.filters['created_after'] = today - timedelta(days=30)
                self.filters['created_before'] = today
            elif date_filter_type == 'ã‚«ã‚¹ã‚¿ãƒ ':
                col1, col2 = st.columns(2)
                with col1:
                    self.filters['created_after'] = st.date_input(
                        "é–‹å§‹æ—¥",
                        value=None
                    )
                with col2:
                    self.filters['created_before'] = st.date_input(
                        "çµ‚äº†æ—¥",
                        value=None
                    )
            else:
                self.filters['created_after'] = None
                self.filters['created_before'] = None
            
            # ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿
            login_filter = st.selectbox(
                "ğŸ” ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´",
                ['ã™ã¹ã¦', 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿', 'æœªãƒ­ã‚°ã‚¤ãƒ³']
            )
            
            if login_filter == 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿':
                self.filters['has_login'] = True
            elif login_filter == 'æœªãƒ­ã‚°ã‚¤ãƒ³':
                self.filters['has_login'] = False
            else:
                self.filters['has_login'] = None
            
            # ã‚½ãƒ¼ãƒˆè¨­å®š
            st.markdown("ğŸ“Š **ã‚½ãƒ¼ãƒˆè¨­å®š**")
            
            sort_options = {
                'created_at': 'ä½œæˆæ—¥',
                'updated_at': 'æ›´æ–°æ—¥',
                'username': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
                'email': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
                'full_name': 'ãƒ•ãƒ«ãƒãƒ¼ãƒ ',
                'age': 'å¹´é½¢',
                'last_login': 'æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³'
            }
            
            self.filters['sort_by'] = st.selectbox(
                "ã‚½ãƒ¼ãƒˆé …ç›®",
                options=list(sort_options.keys()),
                format_func=lambda x: sort_options[x],
                index=0
            )
            
            self.filters['sort_order'] = st.selectbox(
                "ã‚½ãƒ¼ãƒˆé †",
                ['desc', 'asc'],
                format_func=lambda x: 'é™é †' if x == 'desc' else 'æ˜‡é †'
            )
            
            # ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
            if st.button("ğŸ”„ ã™ã¹ã¦ã‚¯ãƒªã‚¢", use_container_width=True):
                self.reset_filters()
                st.rerun()
        
        return self.filters
    
    def apply_filters(self, users: List[User]) -> List[User]:
        """ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨"""
        filtered_users = users.copy()
        
        # ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
        if self.filters['text_search']:
            search_text = self.filters['text_search'].lower()
            filtered_users = [
                user for user in filtered_users
                if (search_text in user.username.lower() or
                    search_text in user.email.lower() or
                    search_text in user.full_name.lower())
            ]
        
        # éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿
        if self.filters['departments']:
            filtered_users = [
                user for user in filtered_users
                if user.department and user.department.value in self.filters['departments']
            ]
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
        if self.filters['statuses']:
            filtered_users = [
                user for user in filtered_users
                if user.status and user.status.value in self.filters['statuses']
            ]
        
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿
        if self.filters['is_active'] is not None:
            filtered_users = [
                user for user in filtered_users
                if user.is_active == self.filters['is_active']
            ]
        
        # å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿
        filtered_users = [
            user for user in filtered_users
            if user.age is None or (
                self.filters['age_min'] <= user.age <= self.filters['age_max']
            )
        ]
        
        # ä½œæˆæ—¥ãƒ•ã‚£ãƒ«ã‚¿
        if self.filters['created_after']:
            created_after = datetime.combine(self.filters['created_after'], datetime.min.time())
            filtered_users = [
                user for user in filtered_users
                if user.created_at and user.created_at >= created_after
            ]
        
        if self.filters['created_before']:
            created_before = datetime.combine(self.filters['created_before'], datetime.max.time())
            filtered_users = [
                user for user in filtered_users
                if user.created_at and user.created_at <= created_before
            ]
        
        # ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿
        if self.filters['has_login'] is not None:
            if self.filters['has_login']:
                filtered_users = [
                    user for user in filtered_users
                    if user.last_login is not None
                ]
            else:
                filtered_users = [
                    user for user in filtered_users
                    if user.last_login is None
                ]
        
        # ã‚½ãƒ¼ãƒˆ
        if self.filters['sort_by']:
            reverse = self.filters['sort_order'] == 'desc'
            
            if self.filters['sort_by'] == 'age':
                filtered_users.sort(
                    key=lambda x: x.age if x.age is not None else 0,
                    reverse=reverse
                )
            elif self.filters['sort_by'] == 'last_login':
                filtered_users.sort(
                    key=lambda x: x.last_login if x.last_login is not None else datetime.min,
                    reverse=reverse
                )
            else:
                filtered_users.sort(
                    key=lambda x: getattr(x, self.filters['sort_by'], ''),
                    reverse=reverse
                )
        
        return filtered_users</code></pre>

                        <h6>é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ã®ç‰¹å¾´</h6>
                        <ul>
                            <li><strong>è¤‡æ•°é¸æŠ</strong>: éƒ¨ç½²ã‚„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¤‡æ•°é¸æŠ</li>
                            <li><strong>æ—¥ä»˜ç¯„å›²</strong>: ä½œæˆæ—¥ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</li>
                            <li><strong>ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹</strong>: ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã§ã®çµã‚Šè¾¼ã¿</li>
                            <li><strong>å‹•çš„ã‚½ãƒ¼ãƒˆ</strong>: è¤‡æ•°é …ç›®ã§ã®ã‚½ãƒ¼ãƒˆ</li>
                        </ul>
                    </div>

                    <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– -->
                    <h3 class="section-title">4.4 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</h3>
                    <p>å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã™ã‚‹ãŸã‚ã®æœ€é©åŒ–æŠ€è¡“ã‚’å­¦ç¿’ã—ã¾ã™ã€‚</p>

                    <div class="info">
                        <h6>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ</h6>
                        <ul>
                            <li><strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½</strong>: @st.cache_dataã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥</li>
                            <li><strong>é…å»¶èª­ã¿è¾¼ã¿</strong>: å¿…è¦ãªæ™‚ã ã‘ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</li>
                            <li><strong>ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³</strong>: è¡¨ç¤ºä»¶æ•°ã®åˆ¶é™</li>
                            <li><strong>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨</strong>: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–</li>
                            <li><strong>ãƒ¡ãƒ¢ãƒªç®¡ç†</strong>: ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤</li>
                        </ul>
                    </div>

                    <!-- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                    <h3 class="section-title">4.5 ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½</h3>
                    <p>CSVã€Excelå½¢å¼ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®è©³ç´°å®Ÿè£…ã‚’å­¦ç¿’ã—ã¾ã™ã€‚</p>

                    <div class="warning">
                        <h6>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã®æ³¨æ„äº‹é …</h6>
                        <ul>
                            <li><strong>æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰</strong>: UTF-8 BOMã®é©åˆ‡ãªè¨­å®š</li>
                            <li><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º</strong>: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†åˆ¶é™</li>
                            <li><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong>: æ©Ÿå¯†æƒ…å ±ã®é™¤å¤–</li>
                            <li><strong>ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</strong>: è¦‹ã‚„ã™ã„å½¢å¼ã§ã®å‡ºåŠ›</li>
                        </ul>
                    </div>

                    <!-- ç†è§£åº¦ç¢ºèª -->
                    <div class="quiz-container">
                        <h5>ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º</h5>
                        <ol>
                            <li>Streamlitã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ï¼Ÿ</li>
                            <li>pandas DataFrameã‚’CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹éš›ã®æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰è¨­å®šã¯ï¼Ÿ</li>
                            <li>ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä½¿ç”¨ã™ã‚‹Streamlitãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¯ï¼Ÿ</li>
                            <li>ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºä»¶æ•°ã‚’åˆ¶å¾¡ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ï¼Ÿ</li>
                            <li>ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹Streamlitã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ï¼Ÿ</li>
                        </ol>
                        
                        <details>
                            <summary>è§£ç­”ä¾‹</summary>
                            <ol>
                                <li>st.dataframe</li>
                                <li>utf-8-sigï¼ˆBOMä»˜ãUTF-8ï¼‰</li>
                                <li>@st.cache_data</li>
                                <li>items_per_pageï¼ˆlimitï¼‰</li>
                                <li>st.metric</li>
                            </ol>
                        </details>
                    </div>

                    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step3-user-registration.html" class="btn btn-secondary">â† å‰ã®ã‚¹ãƒ†ãƒƒãƒ—: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½</a>
                        <a href="step5-user-crud-operations.html" class="btn btn-primary">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: CRUDæ“ä½œ â†’</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>