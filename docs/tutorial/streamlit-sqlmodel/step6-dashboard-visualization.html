<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« Step 6 - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨å¯è¦–åŒ–</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #2196f3;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .chapter-title {
            color: #2196f3;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #1976d2;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #00bcd4;
        }

        .nav-link.active {
            background-color: #2196f3 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            color: #d63384;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            color: #212529;
            padding: 0;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç›®æ¬¡</h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: ç’°å¢ƒæ§‹ç¯‰
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">
                                Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">
                                Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">
                                Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">
                                Step 5: CRUDæ“ä½œ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step6-dashboard-visualization.html">
                                Step 6: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-security-deployment.html">
                                Step 7: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 6: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨å¯è¦–åŒ–</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <span class="badge bg-primary">æ‰€è¦æ™‚é–“: 2.5æ™‚é–“</span>
                    </div>
                </div>

                <div id="step6">
                    <h2 class="chapter-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨å¯è¦–åŒ–</h2>
                    
                    <!-- å­¦ç¿’ç›®æ¨™ -->
                    <div class="highlight">
                        <h5>ã“ã®ç« ã§å­¦ã¶ã“ã¨</h5>
                        <ul>
                            <li>çµ±è¨ˆæƒ…å ±ã®é›†è¨ˆã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º</li>
                            <li>Plotlyã‚’ä½¿ç”¨ã—ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚°ãƒ©ãƒ•ã®ä½œæˆ</li>
                            <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­è¨ˆ</li>
                            <li>PDFãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</li>
                        </ul>
                    </div>

                    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ¦‚å¿µ -->
                    <h3 class="section-title">6.1 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®è¨­è¨ˆåŸå‰‡</h3>
                    <p>åŠ¹æœçš„ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ã€é‡è¦ãªæƒ…å ±ã‚’ä¸€ç›®ã§ç†è§£ã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆæƒ…å ±ã¨å‚¾å‘ã‚’è¦–è¦šçš„ã«è¡¨ç¾ã—ã¾ã™ã€‚</p>
                    
                    <div class="info">
                        <h6>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨­è¨ˆã®åŸºæœ¬åŸå‰‡</h6>
                        <ul>
                            <li><strong>æ˜ç¢ºæ€§</strong>: é‡è¦ãªæƒ…å ±ã‚’æœ€åˆã«è¡¨ç¤º</li>
                            <li><strong>ä¸€è²«æ€§</strong>: çµ±ä¸€ã•ã‚ŒãŸãƒ‡ã‚¶ã‚¤ãƒ³ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</li>
                            <li><strong>å®Ÿç”¨æ€§</strong>: å®Ÿéš›ã®ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ã‚’æä¾›</li>
                            <li><strong>å¿œç­”æ€§</strong>: ç•°ãªã‚‹ç”»é¢ã‚µã‚¤ã‚ºã«å¯¾å¿œ</li>
                            <li><strong>æ›´æ–°æ€§</strong>: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã¾ãŸã¯å®šæœŸçš„ãªæ›´æ–°</li>
                        </ul>
                    </div>

                    <!-- çµ±è¨ˆæƒ…å ±ã®é›†è¨ˆ -->
                    <h3 class="section-title">6.2 çµ±è¨ˆæƒ…å ±ã®é›†è¨ˆ</h3>
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœ‰ç”¨ãªçµ±è¨ˆæƒ…å ±ã‚’æŠ½å‡ºã—ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 6-1: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆæ©Ÿèƒ½ã®å®Ÿè£…</h5>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—ã—ã€ã‚ã‹ã‚Šã‚„ã™ãè¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><code>app/utils/dashboard_analytics.py</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>import pandas as pd
import numpy as np
from datetime import datetime, timedelta
from typing import Dict, List, Any, Optional
from dataclasses import dataclass

from app.models.user import User, UserStatus, Department
from app.database.crud import UserCRUD

@dataclass
class DashboardMetrics:
    """ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹"""
    total_users: int
    active_users: int
    inactive_users: int
    pending_users: int
    suspended_users: int
    average_age: float
    new_users_today: int
    new_users_week: int
    new_users_month: int
    login_rate: float
    department_distribution: Dict[str, int]
    age_distribution: Dict[str, int]
    registration_trends: Dict[str, int]
    activity_trends: Dict[str, int]

class DashboardAnalytics:
    """ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆ†æã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.users = UserCRUD.get_users(limit=10000)  # å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        self.df = self._create_dataframe()
    
    def _create_dataframe(self) -> pd.DataFrame:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’DataFrameã«å¤‰æ›"""
        if not self.users:
            return pd.DataFrame()
        
        data = []
        for user in self.users:
            user_data = {
                'id': user.id,
                'username': user.username,
                'email': user.email,
                'full_name': user.full_name,
                'age': user.age,
                'department': user.department.value if user.department else 'unassigned',
                'status': user.status.value if user.status else 'active',
                'is_active': user.is_active,
                'created_at': user.created_at,
                'updated_at': user.updated_at,
                'last_login': user.last_login
            }
            data.append(user_data)
        
        return pd.DataFrame(data)
    
    def calculate_metrics(self) -> DashboardMetrics:
        """ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨ˆç®—"""
        if self.df.empty:
            return self._empty_metrics()
        
        now = datetime.utcnow()
        today = now.date()
        week_ago = now - timedelta(days=7)
        month_ago = now - timedelta(days=30)
        
        # åŸºæœ¬çµ±è¨ˆ
        total_users = len(self.df)
        active_users = len(self.df[self.df['is_active'] == True])
        inactive_users = len(self.df[self.df['is_active'] == False])
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥çµ±è¨ˆ
        status_counts = self.df['status'].value_counts()
        pending_users = status_counts.get('pending', 0)
        suspended_users = status_counts.get('suspended', 0)
        
        # å¹´é½¢çµ±è¨ˆ
        valid_ages = self.df[self.df['age'].notna()]['age']
        average_age = float(valid_ages.mean()) if len(valid_ages) > 0 else 0.0
        
        # æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ
        new_users_today = len(self.df[self.df['created_at'].dt.date == today])
        new_users_week = len(self.df[self.df['created_at'] >= week_ago])
        new_users_month = len(self.df[self.df['created_at'] >= month_ago])
        
        # ãƒ­ã‚°ã‚¤ãƒ³ç‡
        logged_in_users = len(self.df[self.df['last_login'].notna()])
        login_rate = (logged_in_users / total_users * 100) if total_users > 0 else 0.0
        
        # éƒ¨ç½²åˆ†å¸ƒ
        department_distribution = self.df['department'].value_counts().to_dict()
        
        # å¹´é½¢åˆ†å¸ƒ
        age_distribution = self._calculate_age_distribution()
        
        # ç™»éŒ²å‚¾å‘
        registration_trends = self._calculate_registration_trends()
        
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å‚¾å‘
        activity_trends = self._calculate_activity_trends()
        
        return DashboardMetrics(
            total_users=total_users,
            active_users=active_users,
            inactive_users=inactive_users,
            pending_users=pending_users,
            suspended_users=suspended_users,
            average_age=average_age,
            new_users_today=new_users_today,
            new_users_week=new_users_week,
            new_users_month=new_users_month,
            login_rate=login_rate,
            department_distribution=department_distribution,
            age_distribution=age_distribution,
            registration_trends=registration_trends,
            activity_trends=activity_trends
        )
    
    def _calculate_age_distribution(self) -> Dict[str, int]:
        """å¹´é½¢åˆ†å¸ƒã®è¨ˆç®—"""
        if self.df.empty or 'age' not in self.df.columns:
            return {}
        
        valid_ages = self.df[self.df['age'].notna()]['age']
        if len(valid_ages) == 0:
            return {}
        
        age_bins = [0, 20, 30, 40, 50, 60, 100]
        age_labels = ['20æ­³æœªæº€', '20-29æ­³', '30-39æ­³', '40-49æ­³', '50-59æ­³', '60æ­³ä»¥ä¸Š']
        
        age_groups = pd.cut(valid_ages, bins=age_bins, labels=age_labels, right=False)
        return age_groups.value_counts().to_dict()
    
    def _calculate_registration_trends(self) -> Dict[str, int]:
        """ç™»éŒ²å‚¾å‘ã®è¨ˆç®—ï¼ˆéå»30æ—¥é–“ï¼‰"""
        if self.df.empty:
            return {}
        
        now = datetime.utcnow()
        thirty_days_ago = now - timedelta(days=30)
        
        recent_users = self.df[self.df['created_at'] >= thirty_days_ago].copy()
        
        if recent_users.empty:
            return {}
        
        recent_users['date'] = recent_users['created_at'].dt.date
        daily_registrations = recent_users.groupby('date').size()
        
        # éå»30æ—¥ã®æ—¥ä»˜ã‚’ç”Ÿæˆ
        date_range = pd.date_range(start=thirty_days_ago.date(), end=now.date(), freq='D')
        
        # å…¨æ—¥ä»˜ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†ä½œæˆï¼ˆç™»éŒ²ãŒãªã„æ—¥ã¯0ï¼‰
        result = {}
        for date in date_range:
            date_key = date.strftime('%Y-%m-%d')
            result[date_key] = daily_registrations.get(date.date(), 0)
        
        return result
    
    def _calculate_activity_trends(self) -> Dict[str, int]:
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å‚¾å‘ã®è¨ˆç®—ï¼ˆéå»30æ—¥é–“ã®ãƒ­ã‚°ã‚¤ãƒ³ï¼‰"""
        if self.df.empty:
            return {}
        
        now = datetime.utcnow()
        thirty_days_ago = now - timedelta(days=30)
        
        recent_logins = self.df[
            (self.df['last_login'].notna()) & 
            (self.df['last_login'] >= thirty_days_ago)
        ].copy()
        
        if recent_logins.empty:
            return {}
        
        recent_logins['date'] = recent_logins['last_login'].dt.date
        daily_logins = recent_logins.groupby('date').size()
        
        # éå»30æ—¥ã®æ—¥ä»˜ã‚’ç”Ÿæˆ
        date_range = pd.date_range(start=thirty_days_ago.date(), end=now.date(), freq='D')
        
        result = {}
        for date in date_range:
            date_key = date.strftime('%Y-%m-%d')
            result[date_key] = daily_logins.get(date.date(), 0)
        
        return result
    
    def _empty_metrics(self) -> DashboardMetrics:
        """ç©ºã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¿”ã™"""
        return DashboardMetrics(
            total_users=0,
            active_users=0,
            inactive_users=0,
            pending_users=0,
            suspended_users=0,
            average_age=0.0,
            new_users_today=0,
            new_users_week=0,
            new_users_month=0,
            login_rate=0.0,
            department_distribution={},
            age_distribution={},
            registration_trends={},
            activity_trends={}
        )
    
    def get_department_summary(self) -> Dict[str, Any]:
        """éƒ¨ç½²åˆ¥ã‚µãƒãƒªãƒ¼ã®å–å¾—"""
        if self.df.empty:
            return {}
        
        department_stats = {}
        
        for dept in self.df['department'].unique():
            dept_users = self.df[self.df['department'] == dept]
            
            department_stats[dept] = {
                'total_count': len(dept_users),
                'active_count': len(dept_users[dept_users['is_active'] == True]),
                'average_age': float(dept_users[dept_users['age'].notna()]['age'].mean()) if len(dept_users[dept_users['age'].notna()]) > 0 else 0.0,
                'login_rate': len(dept_users[dept_users['last_login'].notna()]) / len(dept_users) * 100 if len(dept_users) > 0 else 0.0
            }
        
        return department_stats
    
    def get_user_growth_analysis(self) -> Dict[str, Any]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼æˆé•·åˆ†æ"""
        if self.df.empty:
            return {}
        
        now = datetime.utcnow()
        
        # æœˆåˆ¥æˆé•·ç‡
        monthly_registrations = self.df.groupby(self.df['created_at'].dt.to_period('M')).size()
        
        # æˆé•·ç‡è¨ˆç®—
        growth_rates = {}
        for i in range(1, len(monthly_registrations)):
            current = monthly_registrations.iloc[i]
            previous = monthly_registrations.iloc[i-1]
            if previous > 0:
                growth_rate = ((current - previous) / previous) * 100
                growth_rates[str(monthly_registrations.index[i])] = round(growth_rate, 2)
        
        return {
            'monthly_registrations': monthly_registrations.to_dict(),
            'growth_rates': growth_rates,
            'total_growth': len(self.df),
            'average_monthly_growth': np.mean(list(growth_rates.values())) if growth_rates else 0
        }</code></pre>

                        <ol start="2">
                            <li><code>requirements.txt</code>ã«Plotlyã‚’è¿½åŠ ï¼š</li>
                        </ol>
                        <pre><code>plotly==5.17.0</code></pre>

                        <ol start="3">
                            <li>ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š</li>
                        </ol>
                        <pre><code>pip install plotly</code></pre>

                        <h6>çµ±è¨ˆæ©Ÿèƒ½ã®ç‰¹å¾´</h6>
                        <ul>
                            <li><strong>åŒ…æ‹¬çš„çµ±è¨ˆ</strong>: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€éƒ¨ç½²ã€å¹´é½¢ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®åˆ†æ</li>
                            <li><strong>æ™‚ç³»åˆ—åˆ†æ</strong>: ç™»éŒ²ãƒˆãƒ¬ãƒ³ãƒ‰ã¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒˆãƒ¬ãƒ³ãƒ‰</li>
                            <li><strong>æˆé•·åˆ†æ</strong>: æœˆåˆ¥æˆé•·ç‡ã®è¨ˆç®—</li>
                            <li><strong>éƒ¨ç½²åˆ¥çµ±è¨ˆ</strong>: çµ„ç¹”å˜ä½ã§ã®è©³ç´°åˆ†æ</li>
                        </ul>
                    </div>

                    <!-- ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ– -->
                    <h3 class="section-title">6.3 Plotlyã«ã‚ˆã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚°ãƒ©ãƒ•</h3>
                    <p>Plotlyã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’é­…åŠ›çš„ã§ç†è§£ã—ã‚„ã™ã„ã‚°ãƒ©ãƒ•ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 6-2: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚°ãƒ©ãƒ•ã®ä½œæˆ</h5>
                        <p>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’Plotlyã‚°ãƒ©ãƒ•ã¨ã—ã¦å¯è¦–åŒ–ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><code>app/utils/chart_generators.py</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import pandas as pd
from datetime import datetime, timedelta
from typing import Dict, List, Any

from app.utils.dashboard_analytics import DashboardMetrics

class ChartGenerator:
    """ã‚°ãƒ©ãƒ•ç”Ÿæˆã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, metrics: DashboardMetrics):
        self.metrics = metrics
        self.color_palette = [
            '#2196F3', '#4CAF50', '#FF9800', '#F44336', 
            '#9C27B0', '#00BCD4', '#795548', '#607D8B'
        ]
    
    def create_user_status_pie_chart(self) -> go.Figure:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å††ã‚°ãƒ©ãƒ•"""
        labels = ['ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'æ‰¿èªå¾…ã¡', 'åœæ­¢ä¸­']
        values = [
            self.metrics.active_users,
            self.metrics.inactive_users,
            self.metrics.pending_users,
            self.metrics.suspended_users
        ]
        
        # å€¤ãŒ0ã®ã‚‚ã®ã‚’é™¤å¤–
        non_zero_data = [(label, value) for label, value in zip(labels, values) if value > 0]
        
        if not non_zero_data:
            return self._create_empty_chart("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒ")
        
        labels, values = zip(*non_zero_data)
        
        fig = go.Figure(data=[go.Pie(
            labels=labels,
            values=values,
            hole=0.3,
            marker_colors=self.color_palette[:len(labels)],
            textinfo='label+percent+value',
            textposition='auto',
            hovertemplate='<b>%{label}</b><br>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: %{value}<br>å‰²åˆ: %{percent}<extra></extra>'
        )])
        
        fig.update_layout(
            title={
                'text': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒ',
                'x': 0.5,
                'xanchor': 'center',
                'font': {'size': 18}
            },
            font={'family': 'Noto Sans JP'},
            height=400,
            margin=dict(l=20, r=20, t=60, b=20)
        )
        
        return fig
    
    def create_department_bar_chart(self) -> go.Figure:
        """éƒ¨ç½²åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°æ£’ã‚°ãƒ©ãƒ•"""
        if not self.metrics.department_distribution:
            return self._create_empty_chart("éƒ¨ç½²åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°")
        
        # éƒ¨ç½²åã®æ—¥æœ¬èªåŒ–
        dept_labels = {
            'engineering': 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°',
            'marketing': 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°',
            'sales': 'å–¶æ¥­',
            'hr': 'äººäº‹',
            'finance': 'è²¡å‹™',
            'operations': 'é‹å–¶',
            'unassigned': 'æœªè¨­å®š'
        }
        
        departments = list(self.metrics.department_distribution.keys())
        values = list(self.metrics.department_distribution.values())
        labels = [dept_labels.get(dept, dept) for dept in departments]
        
        fig = go.Figure(data=[go.Bar(
            x=labels,
            y=values,
            marker_color=self.color_palette[0],
            text=values,
            textposition='auto',
            hovertemplate='<b>%{x}</b><br>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: %{y}<extra></extra>'
        )])
        
        fig.update_layout(
            title={
                'text': 'éƒ¨ç½²åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°',
                'x': 0.5,
                'xanchor': 'center',
                'font': {'size': 18}
            },
            xaxis_title='éƒ¨ç½²',
            yaxis_title='ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°',
            font={'family': 'Noto Sans JP'},
            height=400,
            margin=dict(l=20, r=20, t=60, b=20),
            xaxis={'tickangle': -45}
        )
        
        return fig
    
    def create_age_distribution_histogram(self) -> go.Figure:
        """å¹´é½¢åˆ†å¸ƒãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ """
        if not self.metrics.age_distribution:
            return self._create_empty_chart("å¹´é½¢åˆ†å¸ƒ")
        
        age_groups = list(self.metrics.age_distribution.keys())
        values = list(self.metrics.age_distribution.values())
        
        fig = go.Figure(data=[go.Bar(
            x=age_groups,
            y=values,
            marker_color=self.color_palette[2],
            text=values,
            textposition='auto',
            hovertemplate='<b>%{x}</b><br>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: %{y}<extra></extra>'
        )])
        
        fig.update_layout(
            title={
                'text': 'å¹´é½¢åˆ†å¸ƒ',
                'x': 0.5,
                'xanchor': 'center',
                'font': {'size': 18}
            },
            xaxis_title='å¹´é½¢ã‚°ãƒ«ãƒ¼ãƒ—',
            yaxis_title='ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°',
            font={'family': 'Noto Sans JP'},
            height=400,
            margin=dict(l=20, r=20, t=60, b=20)
        )
        
        return fig
    
    def create_registration_trend_chart(self) -> go.Figure:
        """ç™»éŒ²ãƒˆãƒ¬ãƒ³ãƒ‰ç·šã‚°ãƒ©ãƒ•"""
        if not self.metrics.registration_trends:
            return self._create_empty_chart("ç™»éŒ²ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆéå»30æ—¥ï¼‰")
        
        dates = list(self.metrics.registration_trends.keys())
        values = list(self.metrics.registration_trends.values())
        
        # æ—¥ä»˜ã‚’å¤‰æ›
        date_objects = [datetime.strptime(date, '%Y-%m-%d') for date in dates]
        
        fig = go.Figure()
        
        # ç™»éŒ²æ•°ã®ç·šã‚°ãƒ©ãƒ•
        fig.add_trace(go.Scatter(
            x=date_objects,
            y=values,
            mode='lines+markers',
            name='æ—¥åˆ¥ç™»éŒ²æ•°',
            line=dict(color=self.color_palette[1], width=3),
            marker=dict(size=6),
            hovertemplate='<b>%{x|%Y-%m-%d}</b><br>ç™»éŒ²æ•°: %{y}<extra></extra>'
        ))
        
        # ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆç§»å‹•å¹³å‡ï¼‰
        if len(values) >= 7:
            df = pd.DataFrame({'values': values})
            moving_avg = df['values'].rolling(window=7, center=True).mean()
            
            fig.add_trace(go.Scatter(
                x=date_objects,
                y=moving_avg,
                mode='lines',
                name='7æ—¥ç§»å‹•å¹³å‡',
                line=dict(color=self.color_palette[3], width=2, dash='dash'),
                hovertemplate='<b>%{x|%Y-%m-%d}</b><br>7æ—¥å¹³å‡: %{y:.1f}<extra></extra>'
            ))
        
        fig.update_layout(
            title={
                'text': 'ç™»éŒ²ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆéå»30æ—¥ï¼‰',
                'x': 0.5,
                'xanchor': 'center',
                'font': {'size': 18}
            },
            xaxis_title='æ—¥ä»˜',
            yaxis_title='ç™»éŒ²æ•°',
            font={'family': 'Noto Sans JP'},
            height=400,
            margin=dict(l=20, r=20, t=60, b=20),
            hovermode='x unified'
        )
        
        return fig
    
    def create_activity_trend_chart(self) -> go.Figure:
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒˆãƒ¬ãƒ³ãƒ‰ç·šã‚°ãƒ©ãƒ•"""
        if not self.metrics.activity_trends:
            return self._create_empty_chart("ãƒ­ã‚°ã‚¤ãƒ³ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆéå»30æ—¥ï¼‰")
        
        dates = list(self.metrics.activity_trends.keys())
        values = list(self.metrics.activity_trends.values())
        
        date_objects = [datetime.strptime(date, '%Y-%m-%d') for date in dates]
        
        fig = go.Figure()
        
        fig.add_trace(go.Scatter(
            x=date_objects,
            y=values,
            mode='lines+markers',
            name='æ—¥åˆ¥ãƒ­ã‚°ã‚¤ãƒ³æ•°',
            line=dict(color=self.color_palette[4], width=3),
            marker=dict(size=6),
            fill='tonexty',
            hovertemplate='<b>%{x|%Y-%m-%d}</b><br>ãƒ­ã‚°ã‚¤ãƒ³æ•°: %{y}<extra></extra>'
        ))
        
        fig.update_layout(
            title={
                'text': 'ãƒ­ã‚°ã‚¤ãƒ³ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆéå»30æ—¥ï¼‰',
                'x': 0.5,
                'xanchor': 'center',
                'font': {'size': 18}
            },
            xaxis_title='æ—¥ä»˜',
            yaxis_title='ãƒ­ã‚°ã‚¤ãƒ³æ•°',
            font={'family': 'Noto Sans JP'},
            height=400,
            margin=dict(l=20, r=20, t=60, b=20),
            hovermode='x unified'
        )
        
        return fig
    
    def create_comprehensive_dashboard(self) -> go.Figure:
        """åŒ…æ‹¬çš„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆè¤‡æ•°ã‚°ãƒ©ãƒ•ï¼‰"""
        fig = make_subplots(
            rows=2, cols=2,
            subplot_titles=(
                'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒ',
                'éƒ¨ç½²åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°',
                'å¹´é½¢åˆ†å¸ƒ',
                'ç™»éŒ²ãƒˆãƒ¬ãƒ³ãƒ‰'
            ),
            specs=[
                [{"type": "pie"}, {"type": "bar"}],
                [{"type": "bar"}, {"type": "scatter"}]
            ]
        )
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å††ã‚°ãƒ©ãƒ•
        if self.metrics.total_users > 0:
            labels = ['ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'æ‰¿èªå¾…ã¡', 'åœæ­¢ä¸­']
            values = [
                self.metrics.active_users,
                self.metrics.inactive_users,
                self.metrics.pending_users,
                self.metrics.suspended_users
            ]
            
            fig.add_trace(go.Pie(
                labels=labels,
                values=values,
                hole=0.3,
                marker_colors=self.color_palette[:4]
            ), row=1, col=1)
        
        # éƒ¨ç½²åˆ¥æ£’ã‚°ãƒ©ãƒ•
        if self.metrics.department_distribution:
            dept_labels = {
                'engineering': 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°',
                'marketing': 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°',
                'sales': 'å–¶æ¥­',
                'hr': 'äººäº‹',
                'finance': 'è²¡å‹™',
                'operations': 'é‹å–¶',
                'unassigned': 'æœªè¨­å®š'
            }
            
            departments = list(self.metrics.department_distribution.keys())
            values = list(self.metrics.department_distribution.values())
            labels = [dept_labels.get(dept, dept) for dept in departments]
            
            fig.add_trace(go.Bar(
                x=labels,
                y=values,
                marker_color=self.color_palette[0]
            ), row=1, col=2)
        
        # å¹´é½¢åˆ†å¸ƒ
        if self.metrics.age_distribution:
            age_groups = list(self.metrics.age_distribution.keys())
            values = list(self.metrics.age_distribution.values())
            
            fig.add_trace(go.Bar(
                x=age_groups,
                y=values,
                marker_color=self.color_palette[2]
            ), row=2, col=1)
        
        # ç™»éŒ²ãƒˆãƒ¬ãƒ³ãƒ‰
        if self.metrics.registration_trends:
            dates = list(self.metrics.registration_trends.keys())
            values = list(self.metrics.registration_trends.values())
            date_objects = [datetime.strptime(date, '%Y-%m-%d') for date in dates]
            
            fig.add_trace(go.Scatter(
                x=date_objects,
                y=values,
                mode='lines+markers',
                line=dict(color=self.color_palette[1])
            ), row=2, col=2)
        
        fig.update_layout(
            height=800,
            showlegend=False,
            title={
                'text': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
                'x': 0.5,
                'xanchor': 'center',
                'font': {'size': 20}
            },
            font={'family': 'Noto Sans JP'}
        )
        
        return fig
    
    def _create_empty_chart(self, title: str) -> go.Figure:
        """ç©ºã®ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ"""
        fig = go.Figure()
        
        fig.add_annotation(
            text="ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“",
            x=0.5,
            y=0.5,
            xref="paper",
            yref="paper",
            showarrow=False,
            font=dict(size=16, color="gray")
        )
        
        fig.update_layout(
            title={
                'text': title,
                'x': 0.5,
                'xanchor': 'center',
                'font': {'size': 18}
            },
            height=400,
            margin=dict(l=20, r=20, t=60, b=20),
            font={'family': 'Noto Sans JP'}
        )
        
        return fig</code></pre>

                        <h6>Plotlyã‚°ãƒ©ãƒ•ã®ç‰¹å¾´</h6>
                        <ul>
                            <li><strong>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–</strong>: ã‚ºãƒ¼ãƒ ã€ãƒ›ãƒãƒ¼ã€é¸æŠæ©Ÿèƒ½</li>
                            <li><strong>ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–</strong>: ç”»é¢ã‚µã‚¤ã‚ºã«è‡ªå‹•èª¿æ•´</li>
                            <li><strong>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½</strong>: è‰²ã€ãƒ•ã‚©ãƒ³ãƒˆã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®èª¿æ•´</li>
                            <li><strong>å¤šæ§˜ãªã‚°ãƒ©ãƒ•</strong>: å††ã€æ£’ã€ç·šã€æ•£å¸ƒå›³ãªã©</li>
                        </ul>
                    </div>

                    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ -->
                    <h3 class="section-title">6.4 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã®å®Ÿè£…</h3>
                    <p>çµ±è¨ˆæƒ…å ±ã¨ã‚°ãƒ©ãƒ•ã‚’çµ„ã¿åˆã‚ã›ãŸåŒ…æ‹¬çš„ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 6-3: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã®ä½œæˆ</h5>
                        <p>ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚°ãƒ©ãƒ•ã‚’çµ„ã¿åˆã‚ã›ãŸãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><code>app/pages/4_ğŸ“Š_Dashboard.py</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>import streamlit as st
import plotly.graph_objects as go
from datetime import datetime
import time

from app.utils.dashboard_analytics import DashboardAnalytics
from app.utils.chart_generators import ChartGenerator

def main():
    """ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    st.set_page_config(
        page_title="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰",
        page_icon="ğŸ“Š",
        layout="wide",
        initial_sidebar_state="collapsed"
    )
    
    st.title("ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰")
    
    # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°è¨­å®š
    auto_refresh = st.sidebar.checkbox("è‡ªå‹•æ›´æ–°ï¼ˆ30ç§’é–“éš”ï¼‰", value=False)
    
    if auto_refresh:
        # 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
        time.sleep(30)
        st.rerun()
    
    # æ‰‹å‹•æ›´æ–°ãƒœã‚¿ãƒ³
    col1, col2, col3 = st.columns([1, 1, 4])
    with col1:
        if st.button("ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°", use_container_width=True):
            st.cache_data.clear()
            st.rerun()
    
    with col2:
        if st.button("ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ", use_container_width=True):
            generate_pdf_report()
    
    st.markdown("---")
    
    # ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    @st.cache_data(ttl=300)  # 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    def load_dashboard_data():
        analytics = DashboardAnalytics()
        return analytics.calculate_metrics()
    
    try:
        metrics = load_dashboard_data()
        chart_generator = ChartGenerator(metrics)
        
        # ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
        display_key_metrics(metrics)
        
        st.markdown("---")
        
        # ã‚°ãƒ©ãƒ•è¡¨ç¤º
        display_charts(chart_generator, metrics)
        
        # è©³ç´°çµ±è¨ˆ
        display_detailed_statistics(metrics)
        
    except Exception as e:
        st.error(f"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        st.info("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ã®å•é¡ŒãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚")

def display_key_metrics(metrics):
    """ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¡¨ç¤º"""
    st.subheader("ğŸ“ˆ ä¸»è¦æŒ‡æ¨™")
    
    # ãƒ¡ã‚¤ãƒ³æŒ‡æ¨™
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            label="ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°",
            value=metrics.total_users,
            delta=f"+{metrics.new_users_month}ï¼ˆä»Šæœˆï¼‰",
            delta_color="normal"
        )
    
    with col2:
        active_rate = (metrics.active_users / metrics.total_users * 100) if metrics.total_users > 0 else 0
        st.metric(
            label="ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼",
            value=metrics.active_users,
            delta=f"{active_rate:.1f}%",
            delta_color="normal"
        )
    
    with col3:
        st.metric(
            label="å¹³å‡å¹´é½¢",
            value=f"{metrics.average_age:.1f}æ­³" if metrics.average_age > 0 else "N/A",
            delta=None
        )
    
    with col4:
        st.metric(
            label="ãƒ­ã‚°ã‚¤ãƒ³ç‡",
            value=f"{metrics.login_rate:.1f}%",
            delta=None
        )
    
    # æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡æ¨™
    st.markdown("#### ğŸ“… æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼")
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric(
            label="ä»Šæ—¥",
            value=metrics.new_users_today,
            delta=None
        )
    
    with col2:
        st.metric(
            label="ä»Šé€±",
            value=metrics.new_users_week,
            delta=None
        )
    
    with col3:
        st.metric(
            label="ä»Šæœˆ",
            value=metrics.new_users_month,
            delta=None
        )

def display_charts(chart_generator, metrics):
    """ã‚°ãƒ©ãƒ•ã®è¡¨ç¤º"""
    st.subheader("ğŸ“Š ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–")
    
    # ã‚¿ãƒ–ã§ã‚°ãƒ©ãƒ•ã‚’åˆ†é¡
    tab1, tab2, tab3, tab4 = st.tabs(["æ¦‚è¦", "åˆ†å¸ƒ", "ãƒˆãƒ¬ãƒ³ãƒ‰", "åŒ…æ‹¬"])
    
    with tab1:
        col1, col2 = st.columns(2)
        
        with col1:
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å††ã‚°ãƒ©ãƒ•
            status_chart = chart_generator.create_user_status_pie_chart()
            st.plotly_chart(status_chart, use_container_width=True)
        
        with col2:
            # éƒ¨ç½²åˆ¥æ£’ã‚°ãƒ©ãƒ•
            dept_chart = chart_generator.create_department_bar_chart()
            st.plotly_chart(dept_chart, use_container_width=True)
    
    with tab2:
        # å¹´é½¢åˆ†å¸ƒ
        age_chart = chart_generator.create_age_distribution_histogram()
        st.plotly_chart(age_chart, use_container_width=True)
        
        # éƒ¨ç½²åˆ¥è©³ç´°çµ±è¨ˆ
        if metrics.total_users > 0:
            analytics = DashboardAnalytics()
            dept_stats = analytics.get_department_summary()
            
            if dept_stats:
                st.markdown("#### éƒ¨ç½²åˆ¥è©³ç´°çµ±è¨ˆ")
                display_department_details(dept_stats)
    
    with tab3:
        col1, col2 = st.columns(1, 1)
        
        with col1:
            # ç™»éŒ²ãƒˆãƒ¬ãƒ³ãƒ‰
            reg_chart = chart_generator.create_registration_trend_chart()
            st.plotly_chart(reg_chart, use_container_width=True)
        
        with col2:
            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒˆãƒ¬ãƒ³ãƒ‰
            activity_chart = chart_generator.create_activity_trend_chart()
            st.plotly_chart(activity_chart, use_container_width=True)
    
    with tab4:
        # åŒ…æ‹¬çš„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        comprehensive_chart = chart_generator.create_comprehensive_dashboard()
        st.plotly_chart(comprehensive_chart, use_container_width=True)

def display_department_details(dept_stats):
    """éƒ¨ç½²åˆ¥è©³ç´°çµ±è¨ˆã®è¡¨ç¤º"""
    dept_labels = {
        'engineering': 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°',
        'marketing': 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°',
        'sales': 'å–¶æ¥­',
        'hr': 'äººäº‹',
        'finance': 'è²¡å‹™',
        'operations': 'é‹å–¶',
        'unassigned': 'æœªè¨­å®š'
    }
    
    for dept, stats in dept_stats.items():
        dept_name = dept_labels.get(dept, dept)
        
        with st.expander(f"ğŸ¢ {dept_name}"):
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric("ç·æ•°", stats['total_count'])
            
            with col2:
                st.metric("ã‚¢ã‚¯ãƒ†ã‚£ãƒ–", stats['active_count'])
            
            with col3:
                st.metric("å¹³å‡å¹´é½¢", f"{stats['average_age']:.1f}æ­³" if stats['average_age'] > 0 else "N/A")
            
            with col4:
                st.metric("ãƒ­ã‚°ã‚¤ãƒ³ç‡", f"{stats['login_rate']:.1f}%")

def display_detailed_statistics(metrics):
    """è©³ç´°çµ±è¨ˆã®è¡¨ç¤º"""
    st.markdown("---")
    st.subheader("ğŸ“‹ è©³ç´°çµ±è¨ˆ")
    
    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å†…è¨³
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å†…è¨³")
        status_data = {
            "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–": metrics.active_users,
            "éã‚¢ã‚¯ãƒ†ã‚£ãƒ–": metrics.inactive_users,
            "æ‰¿èªå¾…ã¡": metrics.pending_users,
            "åœæ­¢ä¸­": metrics.suspended_users
        }
        
        for status, count in status_data.items():
            percentage = (count / metrics.total_users * 100) if metrics.total_users > 0 else 0
            st.write(f"**{status}**: {count}å ({percentage:.1f}%)")
    
    with col2:
        st.markdown("#### ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±")
        st.write(f"**æœ€çµ‚æ›´æ–°**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        st.write(f"**ãƒ‡ãƒ¼ã‚¿æœŸé–“**: éå»30æ—¥")
        st.write(f"**ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°**: {metrics.total_users}")

def generate_pdf_report():
    """PDFãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰"""
    st.info("ğŸ“„ PDFãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…äºˆå®šã§ã™")
    
    # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€reportlabã‚„weasyprintç­‰ã‚’ä½¿ç”¨
    report_content = f"""
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆ
    
    **ç”Ÿæˆæ—¥æ™‚**: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}
    
    ## ã‚µãƒãƒªãƒ¼
    ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã«ã¯ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ï¼š
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±
    - éƒ¨ç½²åˆ¥åˆ†æ
    - æˆé•·ãƒˆãƒ¬ãƒ³ãƒ‰
    - ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£åˆ†æ
    """
    
    st.download_button(
        label="ğŸ“„ ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        data=report_content,
        file_name=f"dashboard_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md",
        mime="text/markdown"
    )

if __name__ == "__main__":
    main()</code></pre>

                        <h6>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ©Ÿèƒ½</h6>
                        <ul>
                            <li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</strong>: è‡ªå‹•ã¾ãŸã¯æ‰‹å‹•ã§ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°</li>
                            <li><strong>ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º</strong>: é‡è¦ãªæŒ‡æ¨™ã®è¦‹ã‚„ã™ã„è¡¨ç¤º</li>
                            <li><strong>ã‚¿ãƒ–åˆ†é¡</strong>: æƒ…å ±ã‚’æ•´ç†ã—ãŸã‚¿ãƒ–è¡¨ç¤º</li>
                            <li><strong>ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</strong>: PDFãƒ¬ãƒãƒ¼ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                        </ul>
                    </div>

                    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° -->
                    <h3 class="section-title">6.5 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿æ›´æ–°</h3>
                    <p>ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’å³åº§ã«åæ˜ ã™ã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="info">
                        <h6>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®å®Ÿè£…æ–¹æ³•</h6>
                        <ul>
                            <li><strong>è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥</strong>: å®šæœŸçš„ãªãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿</li>
                            <li><strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†</strong>: é©åˆ‡ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé–“è¨­å®š</li>
                            <li><strong>WebSocket</strong>: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ï¼ˆé«˜åº¦ãªå®Ÿè£…ï¼‰</li>
                            <li><strong>ãƒãƒ¼ãƒªãƒ³ã‚°</strong>: å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—</li>
                        </ul>
                    </div>

                    <!-- PDFãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ -->
                    <h3 class="section-title">6.6 PDFãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½</h3>
                    <p>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’PDFå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="warning">
                        <h6>PDFãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã®æ³¨æ„äº‹é …</h6>
                        <ul>
                            <li><strong>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé¸æŠ</strong>: reportlabã€weasyprintç­‰ã®æ¤œè¨</li>
                            <li><strong>ãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œ</strong>: æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š</li>
                            <li><strong>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</strong>: ã‚°ãƒ©ãƒ•ã¨ãƒ†ã‚­ã‚¹ãƒˆã®é©åˆ‡ãªé…ç½®</li>
                            <li><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º</strong>: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†åˆ¶é™</li>
                        </ul>
                    </div>

                    <!-- ç†è§£åº¦ç¢ºèª -->
                    <div class="quiz-container">
                        <h5>ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º</h5>
                        <ol>
                            <li>Plotlyã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå††ã‚°ãƒ©ãƒ•ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ã¯ï¼Ÿ</li>
                            <li>Streamlitã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆæ•°å€¤æŒ‡æ¨™ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ï¼Ÿ</li>
                            <li>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹ä¸»ãªç›®çš„ã¯ï¼Ÿ</li>
                            <li>æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–ã«é©ã—ãŸã‚°ãƒ©ãƒ•ã®ç¨®é¡ã¯ï¼Ÿ</li>
                            <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’å®Ÿè£…ã™ã‚‹éš›ã®è€ƒæ…®äº‹é …ã¯ï¼Ÿ</li>
                        </ol>
                        
                        <details>
                            <summary>è§£ç­”ä¾‹</summary>
                            <ol>
                                <li>go.Pie</li>
                                <li>st.metric</li>
                                <li>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Šã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·ã®è»½æ¸›</li>
                                <li>ç·šã‚°ãƒ©ãƒ•ï¼ˆgo.Scatterï¼‰</li>
                                <li>æ›´æ–°é »åº¦ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®é…æ…®</li>
                            </ol>
                        </details>
                    </div>

                    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step5-user-crud-operations.html" class="btn btn-secondary">â† å‰ã®ã‚¹ãƒ†ãƒƒãƒ—: CRUDæ“ä½œ</a>
                        <a href="step7-security-deployment.html" class="btn btn-primary">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ â†’</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>