<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« Step 7 - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #2196f3;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .chapter-title {
            color: #2196f3;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #1976d2;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #00bcd4;
        }

        .nav-link.active {
            background-color: #2196f3 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            color: #d63384;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            color: #212529;
            padding: 0;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç›®æ¬¡</h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: ç’°å¢ƒæ§‹ç¯‰
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">
                                Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">
                                Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">
                                Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">
                                Step 5: CRUDæ“ä½œ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-dashboard-visualization.html">
                                Step 6: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step7-security-deployment.html">
                                Step 7: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 7: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <span class="badge bg-primary">æ‰€è¦æ™‚é–“: 2æ™‚é–“</span>
                    </div>
                </div>

                <div id="step7">
                    <h2 class="chapter-title">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™</h2>
                    
                    <!-- å­¦ç¿’ç›®æ¨™ -->
                    <div class="highlight">
                        <h5>ã“ã®ç« ã§å­¦ã¶ã“ã¨</h5>
                        <ul>
                            <li>ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹æ©Ÿå¯†æƒ…å ±ã®å®‰å…¨ãªç®¡ç†</li>
                            <li>åŸºæœ¬çš„ãªèªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</li>
                            <li>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</li>
                            <li>Docker Composeã«ã‚ˆã‚‹æœ¬ç•ªç’°å¢ƒæ§‹ç¯‰</li>
                            <li>ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</li>
                        </ul>
                    </div>

                    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŸºç¤ -->
                    <h3 class="section-title">7.1 Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŸºç¤</h3>
                    <p>Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®‰å…¨ã«é‹ç”¨ã™ã‚‹ãŸã‚ã®åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                    
                    <div class="warning">
                        <h6>ä¸»è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨</h6>
                        <ul>
                            <li><strong>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³</strong>: æ‚ªæ„ã®ã‚ã‚‹SQLæ–‡ã®å®Ÿè¡Œ</li>
                            <li><strong>ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°(XSS)</strong>: æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ</li>
                            <li><strong>ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª(CSRF)</strong>: æ„å›³ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®Ÿè¡Œ</li>
                            <li><strong>èªè¨¼ãƒ»èªå¯ã®ä¸å‚™</strong>: ä¸é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡</li>
                            <li><strong>æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©</strong>: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„APIã‚­ãƒ¼ã®éœ²å‡º</li>
                        </ul>
                    </div>

                    <!-- ç’°å¢ƒå¤‰æ•°ç®¡ç† -->
                    <h3 class="section-title">7.2 ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹è¨­å®šç®¡ç†</h3>
                    <p>æ©Ÿå¯†æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ç®¡ç†ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-1: ç’°å¢ƒå¤‰æ•°è¨­å®šã®å®Ÿè£…</h5>
                        <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚„APIã‚­ãƒ¼ã‚’ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><code>app/config/settings.py</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>import os
from typing import Optional
from pydantic import BaseSettings, Field, validator
from sqlalchemy import URL

class DatabaseSettings(BaseSettings):
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š"""
    host: str = Field(..., env="DB_HOST")
    port: int = Field(5432, env="DB_PORT")
    username: str = Field(..., env="DB_USERNAME")
    password: str = Field(..., env="DB_PASSWORD")
    database: str = Field(..., env="DB_DATABASE")
    
    @property
    def database_url(self) -> str:
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLç”Ÿæˆ"""
        return URL.create(
            drivername="postgresql+psycopg2",
            username=self.username,
            password=self.password,
            host=self.host,
            port=self.port,
            database=self.database
        ).render_as_string(hide_password=False)
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

class SecuritySettings(BaseSettings):
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š"""
    secret_key: str = Field(..., env="SECRET_KEY")
    session_timeout: int = Field(3600, env="SESSION_TIMEOUT")  # ç§’å˜ä½
    max_login_attempts: int = Field(5, env="MAX_LOGIN_ATTEMPTS")
    password_min_length: int = Field(8, env="PASSWORD_MIN_LENGTH")
    enable_2fa: bool = Field(False, env="ENABLE_2FA")
    
    @validator("secret_key")
    def validate_secret_key(cls, v):
        if len(v) < 32:
            raise ValueError("SECRET_KEYã¯æœ€ä½32æ–‡å­—å¿…è¦ã§ã™")
        return v
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

class AppSettings(BaseSettings):
    """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š"""
    app_name: str = Field("User Management System", env="APP_NAME")
    app_version: str = Field("1.0.0", env="APP_VERSION")
    debug_mode: bool = Field(False, env="DEBUG_MODE")
    log_level: str = Field("INFO", env="LOG_LEVEL")
    max_upload_size: int = Field(10485760, env="MAX_UPLOAD_SIZE")  # 10MB
    allowed_file_types: list = Field(["csv", "xlsx"], env="ALLOWED_FILE_TYPES")
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

class Settings(BaseSettings):
    """çµ±åˆè¨­å®šã‚¯ãƒ©ã‚¹"""
    database: DatabaseSettings = DatabaseSettings()
    security: SecuritySettings = SecuritySettings()
    app: AppSettings = AppSettings()
    
    # å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š
    smtp_host: Optional[str] = Field(None, env="SMTP_HOST")
    smtp_port: int = Field(587, env="SMTP_PORT")
    smtp_username: Optional[str] = Field(None, env="SMTP_USERNAME")
    smtp_password: Optional[str] = Field(None, env="SMTP_PASSWORD")
    
    # é–‹ç™ºãƒ»æœ¬ç•ªç’°å¢ƒã®è­˜åˆ¥
    environment: str = Field("development", env="ENVIRONMENT")
    
    @property
    def is_production(self) -> bool:
        return self.environment.lower() == "production"
    
    @property
    def is_development(self) -> bool:
        return self.environment.lower() == "development"
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

# ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
settings = Settings()

def get_settings() -> Settings:
    """è¨­å®šå–å¾—é–¢æ•°"""
    return settings</code></pre>

                        <ol start="2">
                            <li><code>.env.example</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰ï¼š</li>
                        </ol>
                        <pre><code># ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=your_username
DB_PASSWORD=your_password
DB_DATABASE=user_management

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
SECRET_KEY=your_very_secure_secret_key_at_least_32_characters_long
SESSION_TIMEOUT=3600
MAX_LOGIN_ATTEMPTS=5
PASSWORD_MIN_LENGTH=8
ENABLE_2FA=false

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
APP_NAME=User Management System
APP_VERSION=1.0.0
DEBUG_MODE=false
LOG_LEVEL=INFO
MAX_UPLOAD_SIZE=10485760
ALLOWED_FILE_TYPES=csv,xlsx

# ç’°å¢ƒè­˜åˆ¥
ENVIRONMENT=development

# ãƒ¡ãƒ¼ãƒ«è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your_email@gmail.com
SMTP_PASSWORD=your_app_password</code></pre>

                        <ol start="3">
                            <li><code>.env</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆå®Ÿéš›ã®è¨­å®šå€¤ï¼‰</li>
                            <li><code>.gitignore</code>ã«<code>.env</code>ã‚’è¿½åŠ </li>
                        </ol>

                        <h6>ç’°å¢ƒå¤‰æ•°ç®¡ç†ã®åˆ©ç‚¹</h6>
                        <ul>
                            <li><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong>: æ©Ÿå¯†æƒ…å ±ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰åˆ†é›¢</li>
                            <li><strong>æŸ”è»Ÿæ€§</strong>: ç’°å¢ƒã”ã¨ã®è¨­å®šå¤‰æ›´</li>
                            <li><strong>ä¿å®ˆæ€§</strong>: è¨­å®šã®ä¸€å…ƒç®¡ç†</li>
                            <li><strong>ãƒ‡ãƒ—ãƒ­ã‚¤</strong>: ç’°å¢ƒå›ºæœ‰ã®è¨­å®šå¯¾å¿œ</li>
                        </ul>
                    </div>

                    <!-- èªè¨¼æ©Ÿèƒ½ -->
                    <h3 class="section-title">7.3 åŸºæœ¬èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…</h3>
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®åŸºæœ¬çš„ãªèªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-2: ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…</h5>
                        <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã«ã‚ˆã‚‹å®‰å…¨ãªèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><code>app/auth/authentication.py</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>import hashlib
import secrets
import hmac
from datetime import datetime, timedelta
from typing import Optional, Dict, Any
import streamlit as st

from app.config.settings import get_settings
from app.database.crud import UserCRUD
from app.models.user import User

class PasswordManager:
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def hash_password(password: str, salt: Optional[str] = None) -> Dict[str, str]:
        """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–"""
        if salt is None:
            salt = secrets.token_hex(32)
        
        # PBKDF2ã‚’ä½¿ç”¨ã—ãŸãƒãƒƒã‚·ãƒ¥åŒ–
        password_hash = hashlib.pbkdf2_hmac(
            'sha256',
            password.encode('utf-8'),
            salt.encode('utf-8'),
            100000  # ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°
        )
        
        return {
            'hash': password_hash.hex(),
            'salt': salt
        }
    
    @staticmethod
    def verify_password(password: str, stored_hash: str, salt: str) -> bool:
        """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ¤œè¨¼"""
        computed_hash = hashlib.pbkdf2_hmac(
            'sha256',
            password.encode('utf-8'),
            salt.encode('utf-8'),
            100000
        )
        
        return hmac.compare_digest(computed_hash.hex(), stored_hash)
    
    @staticmethod
    def validate_password_strength(password: str) -> Dict[str, Any]:
        """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ã®æ¤œè¨¼"""
        settings = get_settings()
        min_length = settings.security.password_min_length
        
        errors = []
        score = 0
        
        # é•·ã•ãƒã‚§ãƒƒã‚¯
        if len(password) < min_length:
            errors.append(f"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯{min_length}æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")
        else:
            score += 1
        
        # æ–‡å­—ç¨®ãƒã‚§ãƒƒã‚¯
        has_upper = any(c.isupper() for c in password)
        has_lower = any(c.islower() for c in password)
        has_digit = any(c.isdigit() for c in password)
        has_special = any(c in "!@#$%^&*()_+-=[]{}|;:,.<>?" for c in password)
        
        if has_upper:
            score += 1
        else:
            errors.append("å¤§æ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™")
        
        if has_lower:
            score += 1
        else:
            errors.append("å°æ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™")
        
        if has_digit:
            score += 1
        else:
            errors.append("æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™")
        
        if has_special:
            score += 1
        else:
            errors.append("ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™")
        
        # å¼·åº¦ãƒ¬ãƒ™ãƒ«
        if score >= 4:
            strength = "å¼·ã„"
        elif score >= 3:
            strength = "æ™®é€š"
        elif score >= 2:
            strength = "å¼±ã„"
        else:
            strength = "éå¸¸ã«å¼±ã„"
        
        return {
            'is_valid': len(errors) == 0,
            'errors': errors,
            'score': score,
            'strength': strength
        }

class SessionManager:
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def initialize_session():
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–"""
        if 'authenticated' not in st.session_state:
            st.session_state.authenticated = False
        if 'user_id' not in st.session_state:
            st.session_state.user_id = None
        if 'username' not in st.session_state:
            st.session_state.username = None
        if 'login_time' not in st.session_state:
            st.session_state.login_time = None
        if 'login_attempts' not in st.session_state:
            st.session_state.login_attempts = 0
    
    @staticmethod
    def login_user(user: User) -> bool:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³"""
        try:
            st.session_state.authenticated = True
            st.session_state.user_id = user.id
            st.session_state.username = user.username
            st.session_state.login_time = datetime.utcnow()
            st.session_state.login_attempts = 0
            
            # æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»ã®æ›´æ–°
            UserCRUD.update_last_login(user.id)
            
            return True
        except Exception as e:
            st.error(f"ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
            return False
    
    @staticmethod
    def logout_user():
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"""
        st.session_state.authenticated = False
        st.session_state.user_id = None
        st.session_state.username = None
        st.session_state.login_time = None
    
    @staticmethod
    def is_authenticated() -> bool:
        """èªè¨¼çŠ¶æ…‹ç¢ºèª"""
        if not st.session_state.get('authenticated', False):
            return False
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
        settings = get_settings()
        login_time = st.session_state.get('login_time')
        
        if login_time:
            session_duration = datetime.utcnow() - login_time
            if session_duration.total_seconds() > settings.security.session_timeout:
                SessionManager.logout_user()
                return False
        
        return True
    
    @staticmethod
    def get_current_user() -> Optional[User]:
        """ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—"""
        if SessionManager.is_authenticated():
            user_id = st.session_state.get('user_id')
            if user_id:
                return UserCRUD.get_user(user_id)
        return None
    
    @staticmethod
    def increment_login_attempts():
        """ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ã®å¢—åŠ """
        st.session_state.login_attempts = st.session_state.get('login_attempts', 0) + 1
    
    @staticmethod
    def is_locked_out() -> bool:
        """ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯çŠ¶æ…‹ç¢ºèª"""
        settings = get_settings()
        attempts = st.session_state.get('login_attempts', 0)
        return attempts >= settings.security.max_login_attempts

class AuthenticationSystem:
    """èªè¨¼ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.password_manager = PasswordManager()
        self.session_manager = SessionManager()
        SessionManager.initialize_session()
    
    def render_login_form(self) -> bool:
        """ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º"""
        if SessionManager.is_locked_out():
            st.error("ğŸ”’ ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚")
            return False
        
        with st.form("login_form"):
            st.subheader("ğŸ” ãƒ­ã‚°ã‚¤ãƒ³")
            
            username = st.text_input("ãƒ¦ãƒ¼ã‚¶ãƒ¼å", placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›")
            password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password", placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›")
            
            col1, col2 = st.columns(2)
            
            with col1:
                login_button = st.form_submit_button("ãƒ­ã‚°ã‚¤ãƒ³", use_container_width=True, type="primary")
            
            with col2:
                if st.form_submit_button("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ", use_container_width=True):
                    st.info("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™")
            
            if login_button:
                return self.authenticate_user(username, password)
        
        return False
    
    def authenticate_user(self, username: str, password: str) -> bool:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼"""
        if not username or not password:
            st.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            return False
        
        try:
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
            user = UserCRUD.get_user_by_username(username)
            
            if not user:
                st.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“")
                SessionManager.increment_login_attempts()
                return False
            
            # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯DBã«ãƒãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ï¼‰
            # ã“ã“ã§ã¯ç°¡å˜ãªæ¤œè¨¼ã‚’å®Ÿè£…
            if password == "demo_password":  # å®Ÿéš›ã®å®Ÿè£…ã§ã¯é©åˆ‡ãªãƒãƒƒã‚·ãƒ¥æ¤œè¨¼
                if user.is_active:
                    success = SessionManager.login_user(user)
                    if success:
                        st.success(f"ã‚ˆã†ã“ãã€{user.full_name}ã•ã‚“ï¼")
                        st.rerun()
                    return success
                else:
                    st.error("ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç„¡åŠ¹ã§ã™")
                    return False
            else:
                st.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“")
                SessionManager.increment_login_attempts()
                return False
                
        except Exception as e:
            st.error(f"èªè¨¼ã‚¨ãƒ©ãƒ¼: {str(e)}")
            return False
    
    def render_user_info(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º"""
        user = SessionManager.get_current_user()
        if user:
            st.sidebar.write(f"ãƒ­ã‚°ã‚¤ãƒ³ä¸­: **{user.full_name}**")
            
            if st.sidebar.button("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"):
                SessionManager.logout_user()
                st.rerun()
    
    def require_authentication(self):
        """èªè¨¼ãŒå¿…è¦ãªãƒšãƒ¼ã‚¸ã§ã®èªè¨¼ãƒã‚§ãƒƒã‚¯"""
        if not SessionManager.is_authenticated():
            st.warning("ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™")
            self.render_login_form()
            st.stop()
        else:
            self.render_user_info()</code></pre>

                        <h6>èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®ç‰¹å¾´</h6>
                        <ul>
                            <li><strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–</strong>: PBKDF2ã«ã‚ˆã‚‹å®‰å…¨ãªãƒãƒƒã‚·ãƒ¥</li>
                            <li><strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</strong>: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ãƒ­ãƒƒã‚¯æ©Ÿèƒ½</li>
                            <li><strong>ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–</strong>: ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°åˆ¶é™</li>
                            <li><strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯</strong>: è¤‡é›‘ã•ã®æ¤œè¨¼</li>
                        </ul>
                    </div>

                    <!-- SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­– -->
                    <h3 class="section-title">7.4 SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–</h3>
                    <p>SQLModelã¨SQLAlchemyã‚’ä½¿ç”¨ã—ãŸå®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="info">
                        <h6>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã®åŸºæœ¬</h6>
                        <ul>
                            <li><strong>ORMã®ä½¿ç”¨</strong>: SQLModelã«ã‚ˆã‚‹è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—</li>
                            <li><strong>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª</strong>: ãƒ—ãƒªãƒšã‚¢ãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ</li>
                            <li><strong>å…¥åŠ›æ¤œè¨¼</strong>: Pydanticã«ã‚ˆã‚‹å‹ãƒã‚§ãƒƒã‚¯</li>
                            <li><strong>æœ€å°æ¨©é™åŸå‰‡</strong>: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¨©é™ã®åˆ¶é™</li>
                        </ul>
                    </div>

                    <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– -->
                    <h3 class="section-title">7.5 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</h3>
                    <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¿œç­”æ€§ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®æœ€é©åŒ–æŠ€è¡“ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®å®Ÿè£…</h5>
                        <p>ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–ã€ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><code>app/utils/performance.py</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>import time
import functools
from typing import Any, Callable, Dict, Optional
import streamlit as st
import pandas as pd
from sqlalchemy import text

from app.database.connection import get_engine

class PerformanceMonitor:
    """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def measure_execution_time(func: Callable) -> Callable:
        """å®Ÿè¡Œæ™‚é–“æ¸¬å®šãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿"""
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            start_time = time.time()
            result = func(*args, **kwargs)
            end_time = time.time()
            
            execution_time = end_time - start_time
            
            # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œæ™‚é–“ã‚’è¡¨ç¤º
            if st.get_option("runner.fastReruns"):
                st.sidebar.text(f"{func.__name__}: {execution_time:.3f}s")
            
            return result
        return wrapper
    
    @staticmethod
    def cache_with_ttl(ttl: int = 300):
        """TTLä»˜ãã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿"""
        def decorator(func: Callable) -> Callable:
            @functools.wraps(func)
            @st.cache_data(ttl=ttl)
            def wrapper(*args, **kwargs):
                return func(*args, **kwargs)
            return wrapper
        return decorator

class DatabaseOptimizer:
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def optimize_query_performance():
        """ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–"""
        engine = get_engine()
        
        optimization_queries = [
            # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
            "CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);",
            "CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);",
            "CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at);",
            "CREATE INDEX IF NOT EXISTS idx_users_is_active ON users(is_active);",
            "CREATE INDEX IF NOT EXISTS idx_users_department ON users(department);",
            
            # çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
            "ANALYZE users;",
        ]
        
        try:
            with engine.connect() as conn:
                for query in optimization_queries:
                    conn.execute(text(query))
                    conn.commit()
            
            st.success("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ")
            
        except Exception as e:
            st.error(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–ã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    @staticmethod
    def get_database_statistics() -> Dict[str, Any]:
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆæƒ…å ±ã®å–å¾—"""
        engine = get_engine()
        
        try:
            with engine.connect() as conn:
                # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚º
                table_size_query = text("""
                    SELECT 
                        schemaname,
                        tablename,
                        attname,
                        n_distinct,
                        correlation
                    FROM pg_stats 
                    WHERE tablename = 'users'
                """)
                
                stats_result = conn.execute(table_size_query).fetchall()
                
                # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æƒ…å ±
                index_query = text("""
                    SELECT 
                        indexname,
                        indexdef
                    FROM pg_indexes 
                    WHERE tablename = 'users'
                """)
                
                index_result = conn.execute(index_query).fetchall()
                
                return {
                    'table_stats': [dict(row._mapping) for row in stats_result],
                    'indexes': [dict(row._mapping) for row in index_result]
                }
                
        except Exception as e:
            st.error(f"çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}")
            return {}

class ResourceManager:
    """ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def optimize_memory_usage():
        """ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–"""
        # DataFrameãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–
        if 'user_data' in st.session_state:
            df = st.session_state.user_data
            if isinstance(df, pd.DataFrame):
                # ãƒ‡ãƒ¼ã‚¿å‹ã®æœ€é©åŒ–
                for col in df.select_dtypes(include=['object']).columns:
                    df[col] = df[col].astype('category')
                
                # ä¸è¦ãªã‚«ãƒ©ãƒ ã®å‰Šé™¤
                if 'temp_columns' in df.columns:
                    df.drop('temp_columns', axis=1, inplace=True)
    
    @staticmethod
    def cleanup_cache():
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
        st.cache_data.clear()
        st.cache_resource.clear()
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        keys_to_remove = [
            key for key in st.session_state.keys() 
            if key.startswith('temp_') or key.startswith('cache_')
        ]
        
        for key in keys_to_remove:
            del st.session_state[key]
    
    @staticmethod
    def get_memory_usage() -> Dict[str, Any]:
        """ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å–å¾—"""
        import psutil
        import sys
        
        process = psutil.Process()
        memory_info = process.memory_info()
        
        return {
            'rss': memory_info.rss / 1024 / 1024,  # MB
            'vms': memory_info.vms / 1024 / 1024,  # MB
            'percent': process.memory_percent(),
            'python_objects': len(gc.get_objects()) if 'gc' in sys.modules else 0
        }

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ä»˜ãã®é–¢æ•°ä¾‹
@PerformanceMonitor.measure_execution_time
@PerformanceMonitor.cache_with_ttl(ttl=600)
def get_user_statistics():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®å–å¾—ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰"""
    from app.utils.dashboard_analytics import DashboardAnalytics
    
    analytics = DashboardAnalytics()
    return analytics.calculate_metrics()

def display_performance_dashboard():
    """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®è¡¨ç¤º"""
    st.subheader("âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("ğŸ—„ï¸ DBæœ€é©åŒ–å®Ÿè¡Œ"):
            DatabaseOptimizer.optimize_query_performance()
    
    with col2:
        if st.button("ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢"):
            ResourceManager.cleanup_cache()
            st.success("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
    
    with col3:
        if st.button("ğŸ“Š çµ±è¨ˆæƒ…å ±è¡¨ç¤º"):
            stats = DatabaseOptimizer.get_database_statistics()
            if stats:
                st.json(stats)
    
    # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡è¡¨ç¤º
    try:
        memory_usage = ResourceManager.get_memory_usage()
        
        st.markdown("#### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("RSS", f"{memory_usage['rss']:.1f} MB")
        with col2:
            st.metric("VMS", f"{memory_usage['vms']:.1f} MB")
        with col3:
            st.metric("ä½¿ç”¨ç‡", f"{memory_usage['percent']:.1f}%")
            
    except Exception as e:
        st.info("ãƒ¡ãƒ¢ãƒªç›£è¦–ã«ã¯psutilãŒå¿…è¦ã§ã™")</code></pre>

                        <h6>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®è¦ç‚¹</h6>
                        <ul>
                            <li><strong>ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°</strong>: é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜</li>
                            <li><strong>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</strong>: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®é«˜é€ŸåŒ–</li>
                            <li><strong>ãƒ¡ãƒ¢ãƒªç®¡ç†</strong>: ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤</li>
                            <li><strong>ç›£è¦–</strong>: å®Ÿè¡Œæ™‚é–“ã¨ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ã®è¿½è·¡</li>
                        </ul>
                    </div>

                    <!-- Docker Composeæœ¬ç•ªç’°å¢ƒ -->
                    <h3 class="section-title">7.6 Docker Composeã«ã‚ˆã‚‹æœ¬ç•ªç’°å¢ƒæ§‹ç¯‰</h3>
                    <p>æœ¬ç•ªç’°å¢ƒç”¨ã®Docker Composeè¨­å®šã‚’ä½œæˆã—ã€å®‰å…¨ã§åŠ¹ç‡çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-4: æœ¬ç•ªç”¨Docker Composeè¨­å®š</h5>
                        <p>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ãŸæœ¬ç•ªç’°å¢ƒç”¨ã®Dockerè¨­å®šã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><code>docker-compose.prod.yml</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.prod
    ports:
      - "8501:8501"
    environment:
      - ENVIRONMENT=production
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USERNAME=${DB_USERNAME:-admin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE:-user_management}
      - SECRET_KEY=${SECRET_KEY}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - app_logs:/app/logs
    networks:
      - app_network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "1001:1001"
    read_only: true
    tmpfs:
      - /tmp
      - /app/temp

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${DB_DATABASE:-user_management}
      POSTGRES_USER: ${DB_USERNAME:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - app_network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-admin} -d ${DB_DATABASE:-user_management}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - app_network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

  redis:
    image: redis:alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - app_network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  app_logs:
    driver: local
  nginx_logs:
    driver: local

networks:
  app_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16</code></pre>

                        <ol start="2">
                            <li><code>Dockerfile.prod</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>FROM python:3.11-slim as builder

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev && \
    rm -rf /var/lib/apt/lists/*

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# æœ¬ç•ªç’°å¢ƒ
FROM python:3.11-slim

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
RUN groupadd -r appuser && useradd -r -g appuser -u 1001 appuser && \
    apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends libpq5 && \
    rm -rf /var/lib/apt/lists/*

# Pythonä¾å­˜é–¢ä¿‚ã®ã‚³ãƒ”ãƒ¼
COPY --from=builder /root/.local /home/appuser/.local

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
WORKDIR /app
COPY --chown=appuser:appuser . .

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
RUN mkdir -p /app/logs && chown appuser:appuser /app/logs

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
USER appuser

# ç’°å¢ƒå¤‰æ•°
ENV PATH=/home/appuser/.local/bin:$PATH
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

EXPOSE 8501

CMD ["streamlit", "run", "app/main.py", "--server.port=8501", "--server.address=0.0.0.0", "--server.headless=true"]</code></pre>

                        <ol start="3">
                            <li><code>docker/nginx/nginx.conf</code>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š</li>
                        </ol>
                        <pre><code>events {
    worker_connections 1024;
}

http {
    upstream app {
        server app:8501;
    }

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # ãƒ¬ãƒ¼ãƒˆåˆ¶é™
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    server {
        listen 80;
        server_name localhost;

        # HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name localhost;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
        client_max_body_size 10M;
        client_body_timeout 60s;
        client_header_timeout 60s;

        location / {
            limit_req zone=api burst=20 nodelay;
            
            proxy_pass http://app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocketå¯¾å¿œ
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}</code></pre>

                        <h6>æœ¬ç•ªç’°å¢ƒã®ç‰¹å¾´</h6>
                        <ul>
                            <li><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–</strong>: æœ€å°æ¨©é™ã€èª­ã¿å–ã‚Šå°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ </li>
                            <li><strong>ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·</strong>: Nginxã«ã‚ˆã‚‹è² è·åˆ†æ•£ã¨SSLçµ‚ç«¯</li>
                            <li><strong>ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</strong>: ã‚³ãƒ³ãƒ†ãƒŠã®å¥å…¨æ€§ç›£è¦–</li>
                            <li><strong>æ°¸ç¶šåŒ–</strong>: ãƒ‡ãƒ¼ã‚¿ãƒœãƒªãƒ¥ãƒ¼ãƒ ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ä¿è­·</li>
                        </ul>
                    </div>

                    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
                    <h3 class="section-title">7.7 ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
                    <p>æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ç¢ºèªã™ã¹ãã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é …ç›®ã‚’æ•´ç†ã—ã¾ã™ã€‚</p>

                    <div class="warning">
                        <h6>å¿…é ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯é …ç›®</h6>
                        <ul>
                            <li><strong>èªè¨¼ãƒ»èªå¯</strong>: é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å®Ÿè£…</li>
                            <li><strong>æš—å·åŒ–</strong>: HTTPSé€šä¿¡ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–</li>
                            <li><strong>å…¥åŠ›æ¤œè¨¼</strong>: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSå¯¾ç­–</li>
                            <li><strong>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</strong>: æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©é˜²æ­¢</li>
                            <li><strong>ãƒ­ã‚°ç›£è¦–</strong>: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®è¨˜éŒ²</li>
                            <li><strong>ä¾å­˜é–¢ä¿‚</strong>: æ—¢çŸ¥è„†å¼±æ€§ã®ãƒã‚§ãƒƒã‚¯</li>
                            <li><strong>è¨­å®šç®¡ç†</strong>: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®å¤‰æ›´</li>
                            <li><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</strong>: ãƒ‡ãƒ¼ã‚¿å¾©æ—§è¨ˆç”»</li>
                        </ul>
                    </div>

                    <!-- ç†è§£åº¦ç¢ºèª -->
                    <div class="quiz-container">
                        <h5>ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º</h5>
                        <ol>
                            <li>ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹ä¸»ãªç†ç”±ã¯ï¼Ÿ</li>
                            <li>PBKDF2ã‚’ä½¿ç”¨ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã®åˆ©ç‚¹ã¯ï¼Ÿ</li>
                            <li>SQLModelãŒSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã«æœ‰åŠ¹ãªç†ç”±ã¯ï¼Ÿ</li>
                            <li>æœ¬ç•ªç’°å¢ƒã§ã®Dockerè¨­å®šã§é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …ã¯ï¼Ÿ</li>
                            <li>Streamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã§é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¯ï¼Ÿ</li>
                        </ol>
                        
                        <details>
                            <summary>è§£ç­”ä¾‹</summary>
                            <ol>
                                <li>æ©Ÿå¯†æƒ…å ±ã‚’ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åˆ†é›¢ã—ã€ç’°å¢ƒã”ã¨ã®è¨­å®šå¤‰æ›´ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚</li>
                                <li>ã‚½ãƒ«ãƒˆä»˜ãã§åå¾©è¨ˆç®—ã«ã‚ˆã‚Šã€ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã«å¯¾ã™ã‚‹è€æ€§ãŒé«˜ã„</li>
                                <li>ORMã«ã‚ˆã‚ŠSQLã‚¯ã‚¨ãƒªãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã«ã‚ˆã‚Šå®‰å…¨ã ã‹ã‚‰</li>
                                <li>æœ€å°æ¨©é™ã®åŸå‰‡ã€èª­ã¿å–ã‚Šå°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¨­å®š</li>
                                <li>ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ãƒ¡ãƒ¢ãƒªç®¡ç†ã€å®Ÿè¡Œæ™‚é–“ç›£è¦–</li>
                            </ol>
                        </details>
                    </div>

                    <!-- ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— -->
                    <div class="info">
                        <h6>ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ï¼</h6>
                        <p>ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã®ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã¾ã—ãŸï¼š</p>
                        <ul>
                            <li><strong>ç’°å¢ƒæ§‹ç¯‰</strong>: Dockerã¨PostgreSQLç’°å¢ƒã®æ§‹ç¯‰</li>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</strong>: SQLModelã«ã‚ˆã‚‹å‹å®‰å…¨ãªORM</li>
                            <li><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</strong>: Streamlitã«ã‚ˆã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªç”»é¢</li>
                            <li><strong>CRUDæ“ä½œ</strong>: å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿æ“ä½œæ©Ÿèƒ½</li>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–</strong>: Plotlyã«ã‚ˆã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
                            <li><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong>: èªè¨¼ã€æš—å·åŒ–ã€è„†å¼±æ€§å¯¾ç­–</li>
                            <li><strong>ãƒ‡ãƒ—ãƒ­ã‚¤</strong>: æœ¬ç•ªç’°å¢ƒç”¨ã®è¨­å®šã¨Docker Compose</li>
                        </ul>
                    </div>

                    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step6-dashboard-visualization.html" class="btn btn-secondary">â† å‰ã®ã‚¹ãƒ†ãƒƒãƒ—: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                        <a href="../README.html" class="btn btn-success">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº† ğŸ‰</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>