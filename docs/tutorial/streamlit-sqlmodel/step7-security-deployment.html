<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel チュートリアル Step 7 - セキュリティとデプロイ準備</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #2196f3;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .chapter-title {
            color: #2196f3;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #1976d2;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #00bcd4;
        }

        .nav-link.active {
            background-color: #2196f3 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            color: #d63384;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            color: #212529;
            padding: 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Streamlit + SQLModel チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">チュートリアル目次</h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">
                                Step 2: データベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">
                                Step 3: ユーザー登録機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">
                                Step 4: ユーザー一覧表示
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">
                                Step 5: CRUD操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-dashboard-visualization.html">
                                Step 6: ダッシュボード
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step7-security-deployment.html">
                                Step 7: セキュリティ・デプロイ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 7: セキュリティとデプロイ準備</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <span class="badge bg-primary">所要時間: 2時間</span>
                    </div>
                </div>

                <div id="step7">
                    <h2 class="chapter-title">セキュリティとデプロイ準備</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>環境変数による機密情報の安全な管理</li>
                            <li>基本的な認証機能の実装</li>
                            <li>SQLインジェクション対策とセキュリティ対策</li>
                            <li>アプリケーションのパフォーマンス最適化</li>
                            <li>Docker Composeによる本番環境構築</li>
                            <li>デプロイ前のセキュリティチェックリスト</li>
                        </ul>
                    </div>

                    <!-- セキュリティの基礎 -->
                    <h3 class="section-title">7.1 Webアプリケーションセキュリティの基礎</h3>
                    <p>Webアプリケーションを安全に運用するための基本的なセキュリティ対策を実装します。</p>
                    
                    <div class="warning">
                        <h6>主要なセキュリティ脅威</h6>
                        <ul>
                            <li><strong>SQLインジェクション</strong>: 悪意のあるSQL文の実行</li>
                            <li><strong>クロスサイトスクリプティング(XSS)</strong>: 悪意のあるスクリプトの実行</li>
                            <li><strong>クロスサイトリクエストフォージェリ(CSRF)</strong>: 意図しないリクエストの実行</li>
                            <li><strong>認証・認可の不備</strong>: 不適切なアクセス制御</li>
                            <li><strong>機密情報の漏洩</strong>: パスワードやAPIキーの露出</li>
                        </ul>
                    </div>

                    <!-- 環境変数管理 -->
                    <h3 class="section-title">7.2 環境変数による設定管理</h3>
                    <p>機密情報を環境変数として管理し、セキュリティを向上させます。</p>

                    <div class="exercise-container">
                        <h5>実習 7-1: 環境変数設定の実装</h5>
                        <p>データベース接続情報やAPIキーを環境変数で管理する仕組みを実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>app/config/settings.py</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>import os
from typing import Optional
from pydantic import BaseSettings, Field, validator
from sqlalchemy import URL

class DatabaseSettings(BaseSettings):
    """データベース設定"""
    host: str = Field(..., env="DB_HOST")
    port: int = Field(5432, env="DB_PORT")
    username: str = Field(..., env="DB_USERNAME")
    password: str = Field(..., env="DB_PASSWORD")
    database: str = Field(..., env="DB_DATABASE")
    
    @property
    def database_url(self) -> str:
        """データベースURL生成"""
        return URL.create(
            drivername="postgresql+psycopg2",
            username=self.username,
            password=self.password,
            host=self.host,
            port=self.port,
            database=self.database
        ).render_as_string(hide_password=False)
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

class SecuritySettings(BaseSettings):
    """セキュリティ設定"""
    secret_key: str = Field(..., env="SECRET_KEY")
    session_timeout: int = Field(3600, env="SESSION_TIMEOUT")  # 秒単位
    max_login_attempts: int = Field(5, env="MAX_LOGIN_ATTEMPTS")
    password_min_length: int = Field(8, env="PASSWORD_MIN_LENGTH")
    enable_2fa: bool = Field(False, env="ENABLE_2FA")
    
    @validator("secret_key")
    def validate_secret_key(cls, v):
        if len(v) < 32:
            raise ValueError("SECRET_KEYは最低32文字必要です")
        return v
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

class AppSettings(BaseSettings):
    """アプリケーション設定"""
    app_name: str = Field("User Management System", env="APP_NAME")
    app_version: str = Field("1.0.0", env="APP_VERSION")
    debug_mode: bool = Field(False, env="DEBUG_MODE")
    log_level: str = Field("INFO", env="LOG_LEVEL")
    max_upload_size: int = Field(10485760, env="MAX_UPLOAD_SIZE")  # 10MB
    allowed_file_types: list = Field(["csv", "xlsx"], env="ALLOWED_FILE_TYPES")
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

class Settings(BaseSettings):
    """統合設定クラス"""
    database: DatabaseSettings = DatabaseSettings()
    security: SecuritySettings = SecuritySettings()
    app: AppSettings = AppSettings()
    
    # 外部サービス設定
    smtp_host: Optional[str] = Field(None, env="SMTP_HOST")
    smtp_port: int = Field(587, env="SMTP_PORT")
    smtp_username: Optional[str] = Field(None, env="SMTP_USERNAME")
    smtp_password: Optional[str] = Field(None, env="SMTP_PASSWORD")
    
    # 開発・本番環境の識別
    environment: str = Field("development", env="ENVIRONMENT")
    
    @property
    def is_production(self) -> bool:
        return self.environment.lower() == "production"
    
    @property
    def is_development(self) -> bool:
        return self.environment.lower() == "development"
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

# グローバル設定インスタンス
settings = Settings()

def get_settings() -> Settings:
    """設定取得関数"""
    return settings</code></pre>

                        <ol start="2">
                            <li><code>.env.example</code>ファイルを作成（テンプレート）：</li>
                        </ol>
                        <pre><code># データベース設定
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=your_username
DB_PASSWORD=your_password
DB_DATABASE=user_management

# セキュリティ設定
SECRET_KEY=your_very_secure_secret_key_at_least_32_characters_long
SESSION_TIMEOUT=3600
MAX_LOGIN_ATTEMPTS=5
PASSWORD_MIN_LENGTH=8
ENABLE_2FA=false

# アプリケーション設定
APP_NAME=User Management System
APP_VERSION=1.0.0
DEBUG_MODE=false
LOG_LEVEL=INFO
MAX_UPLOAD_SIZE=10485760
ALLOWED_FILE_TYPES=csv,xlsx

# 環境識別
ENVIRONMENT=development

# メール設定（オプション）
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your_email@gmail.com
SMTP_PASSWORD=your_app_password</code></pre>

                        <ol start="3">
                            <li><code>.env</code>ファイルを作成（実際の設定値）</li>
                            <li><code>.gitignore</code>に<code>.env</code>を追加</li>
                        </ol>

                        <h6>環境変数管理の利点</h6>
                        <ul>
                            <li><strong>セキュリティ</strong>: 機密情報のソースコード分離</li>
                            <li><strong>柔軟性</strong>: 環境ごとの設定変更</li>
                            <li><strong>保守性</strong>: 設定の一元管理</li>
                            <li><strong>デプロイ</strong>: 環境固有の設定対応</li>
                        </ul>
                    </div>

                    <!-- 認証機能 -->
                    <h3 class="section-title">7.3 基本認証機能の実装</h3>
                    <p>ユーザーログインとセッション管理の基本的な認証機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 7-2: ログイン認証システムの実装</h5>
                        <p>パスワードハッシュ化とセッション管理による安全な認証システムを構築します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>app/auth/authentication.py</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>import hashlib
import secrets
import hmac
from datetime import datetime, timedelta
from typing import Optional, Dict, Any
import streamlit as st

from app.config.settings import get_settings
from app.database.crud import UserCRUD
from app.models.user import User

class PasswordManager:
    """パスワード管理クラス"""
    
    @staticmethod
    def hash_password(password: str, salt: Optional[str] = None) -> Dict[str, str]:
        """パスワードのハッシュ化"""
        if salt is None:
            salt = secrets.token_hex(32)
        
        # PBKDF2を使用したハッシュ化
        password_hash = hashlib.pbkdf2_hmac(
            'sha256',
            password.encode('utf-8'),
            salt.encode('utf-8'),
            100000  # イテレーション回数
        )
        
        return {
            'hash': password_hash.hex(),
            'salt': salt
        }
    
    @staticmethod
    def verify_password(password: str, stored_hash: str, salt: str) -> bool:
        """パスワードの検証"""
        computed_hash = hashlib.pbkdf2_hmac(
            'sha256',
            password.encode('utf-8'),
            salt.encode('utf-8'),
            100000
        )
        
        return hmac.compare_digest(computed_hash.hex(), stored_hash)
    
    @staticmethod
    def validate_password_strength(password: str) -> Dict[str, Any]:
        """パスワード強度の検証"""
        settings = get_settings()
        min_length = settings.security.password_min_length
        
        errors = []
        score = 0
        
        # 長さチェック
        if len(password) < min_length:
            errors.append(f"パスワードは{min_length}文字以上である必要があります")
        else:
            score += 1
        
        # 文字種チェック
        has_upper = any(c.isupper() for c in password)
        has_lower = any(c.islower() for c in password)
        has_digit = any(c.isdigit() for c in password)
        has_special = any(c in "!@#$%^&*()_+-=[]{}|;:,.<>?" for c in password)
        
        if has_upper:
            score += 1
        else:
            errors.append("大文字を含む必要があります")
        
        if has_lower:
            score += 1
        else:
            errors.append("小文字を含む必要があります")
        
        if has_digit:
            score += 1
        else:
            errors.append("数字を含む必要があります")
        
        if has_special:
            score += 1
        else:
            errors.append("特殊文字を含む必要があります")
        
        # 強度レベル
        if score >= 4:
            strength = "強い"
        elif score >= 3:
            strength = "普通"
        elif score >= 2:
            strength = "弱い"
        else:
            strength = "非常に弱い"
        
        return {
            'is_valid': len(errors) == 0,
            'errors': errors,
            'score': score,
            'strength': strength
        }

class SessionManager:
    """セッション管理クラス"""
    
    @staticmethod
    def initialize_session():
        """セッション初期化"""
        if 'authenticated' not in st.session_state:
            st.session_state.authenticated = False
        if 'user_id' not in st.session_state:
            st.session_state.user_id = None
        if 'username' not in st.session_state:
            st.session_state.username = None
        if 'login_time' not in st.session_state:
            st.session_state.login_time = None
        if 'login_attempts' not in st.session_state:
            st.session_state.login_attempts = 0
    
    @staticmethod
    def login_user(user: User) -> bool:
        """ユーザーログイン"""
        try:
            st.session_state.authenticated = True
            st.session_state.user_id = user.id
            st.session_state.username = user.username
            st.session_state.login_time = datetime.utcnow()
            st.session_state.login_attempts = 0
            
            # 最終ログイン時刻の更新
            UserCRUD.update_last_login(user.id)
            
            return True
        except Exception as e:
            st.error(f"ログイン処理でエラーが発生しました: {str(e)}")
            return False
    
    @staticmethod
    def logout_user():
        """ユーザーログアウト"""
        st.session_state.authenticated = False
        st.session_state.user_id = None
        st.session_state.username = None
        st.session_state.login_time = None
    
    @staticmethod
    def is_authenticated() -> bool:
        """認証状態確認"""
        if not st.session_state.get('authenticated', False):
            return False
        
        # セッションタイムアウトチェック
        settings = get_settings()
        login_time = st.session_state.get('login_time')
        
        if login_time:
            session_duration = datetime.utcnow() - login_time
            if session_duration.total_seconds() > settings.security.session_timeout:
                SessionManager.logout_user()
                return False
        
        return True
    
    @staticmethod
    def get_current_user() -> Optional[User]:
        """現在のユーザー取得"""
        if SessionManager.is_authenticated():
            user_id = st.session_state.get('user_id')
            if user_id:
                return UserCRUD.get_user(user_id)
        return None
    
    @staticmethod
    def increment_login_attempts():
        """ログイン試行回数の増加"""
        st.session_state.login_attempts = st.session_state.get('login_attempts', 0) + 1
    
    @staticmethod
    def is_locked_out() -> bool:
        """アカウントロック状態確認"""
        settings = get_settings()
        attempts = st.session_state.get('login_attempts', 0)
        return attempts >= settings.security.max_login_attempts

class AuthenticationSystem:
    """認証システム統合クラス"""
    
    def __init__(self):
        self.password_manager = PasswordManager()
        self.session_manager = SessionManager()
        SessionManager.initialize_session()
    
    def render_login_form(self) -> bool:
        """ログインフォーム表示"""
        if SessionManager.is_locked_out():
            st.error("🔒 ログイン試行回数が上限に達しました。しばらくお待ちください。")
            return False
        
        with st.form("login_form"):
            st.subheader("🔐 ログイン")
            
            username = st.text_input("ユーザー名", placeholder="ユーザー名を入力")
            password = st.text_input("パスワード", type="password", placeholder="パスワードを入力")
            
            col1, col2 = st.columns(2)
            
            with col1:
                login_button = st.form_submit_button("ログイン", use_container_width=True, type="primary")
            
            with col2:
                if st.form_submit_button("パスワードリセット", use_container_width=True):
                    st.info("パスワードリセット機能は未実装です")
            
            if login_button:
                return self.authenticate_user(username, password)
        
        return False
    
    def authenticate_user(self, username: str, password: str) -> bool:
        """ユーザー認証"""
        if not username or not password:
            st.error("ユーザー名とパスワードを入力してください")
            return False
        
        try:
            # ユーザー検索
            user = UserCRUD.get_user_by_username(username)
            
            if not user:
                st.error("ユーザー名またはパスワードが正しくありません")
                SessionManager.increment_login_attempts()
                return False
            
            # パスワード検証（実際の実装ではDBにハッシュを保存）
            # ここでは簡単な検証を実装
            if password == "demo_password":  # 実際の実装では適切なハッシュ検証
                if user.is_active:
                    success = SessionManager.login_user(user)
                    if success:
                        st.success(f"ようこそ、{user.full_name}さん！")
                        st.rerun()
                    return success
                else:
                    st.error("このアカウントは無効です")
                    return False
            else:
                st.error("ユーザー名またはパスワードが正しくありません")
                SessionManager.increment_login_attempts()
                return False
                
        except Exception as e:
            st.error(f"認証エラー: {str(e)}")
            return False
    
    def render_user_info(self):
        """ユーザー情報表示"""
        user = SessionManager.get_current_user()
        if user:
            st.sidebar.write(f"ログイン中: **{user.full_name}**")
            
            if st.sidebar.button("ログアウト"):
                SessionManager.logout_user()
                st.rerun()
    
    def require_authentication(self):
        """認証が必要なページでの認証チェック"""
        if not SessionManager.is_authenticated():
            st.warning("このページにアクセスするにはログインが必要です")
            self.render_login_form()
            st.stop()
        else:
            self.render_user_info()</code></pre>

                        <h6>認証システムの特徴</h6>
                        <ul>
                            <li><strong>パスワードハッシュ化</strong>: PBKDF2による安全なハッシュ</li>
                            <li><strong>セッション管理</strong>: タイムアウトとロック機能</li>
                            <li><strong>ブルートフォース対策</strong>: ログイン試行回数制限</li>
                            <li><strong>パスワード強度チェック</strong>: 複雑さの検証</li>
                        </ul>
                    </div>

                    <!-- SQLインジェクション対策 -->
                    <h3 class="section-title">7.4 SQLインジェクション対策</h3>
                    <p>SQLModelとSQLAlchemyを使用した安全なデータベース操作を実装します。</p>

                    <div class="info">
                        <h6>SQLインジェクション対策の基本</h6>
                        <ul>
                            <li><strong>ORMの使用</strong>: SQLModelによる自動エスケープ</li>
                            <li><strong>パラメータ化クエリ</strong>: プリペアドステートメント</li>
                            <li><strong>入力検証</strong>: Pydanticによる型チェック</li>
                            <li><strong>最小権限原則</strong>: データベース権限の制限</li>
                        </ul>
                    </div>

                    <!-- パフォーマンス最適化 -->
                    <h3 class="section-title">7.5 パフォーマンス最適化</h3>
                    <p>アプリケーションの応答性とスケーラビリティを向上させるための最適化技術を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 7-3: パフォーマンス最適化の実装</h5>
                        <p>キャッシング、データベースクエリ最適化、リソース管理を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>app/utils/performance.py</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>import time
import functools
from typing import Any, Callable, Dict, Optional
import streamlit as st
import pandas as pd
from sqlalchemy import text

from app.database.connection import get_engine

class PerformanceMonitor:
    """パフォーマンス監視クラス"""
    
    @staticmethod
    def measure_execution_time(func: Callable) -> Callable:
        """実行時間測定デコレータ"""
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            start_time = time.time()
            result = func(*args, **kwargs)
            end_time = time.time()
            
            execution_time = end_time - start_time
            
            # デバッグモードで実行時間を表示
            if st.get_option("runner.fastReruns"):
                st.sidebar.text(f"{func.__name__}: {execution_time:.3f}s")
            
            return result
        return wrapper
    
    @staticmethod
    def cache_with_ttl(ttl: int = 300):
        """TTL付きキャッシュデコレータ"""
        def decorator(func: Callable) -> Callable:
            @functools.wraps(func)
            @st.cache_data(ttl=ttl)
            def wrapper(*args, **kwargs):
                return func(*args, **kwargs)
            return wrapper
        return decorator

class DatabaseOptimizer:
    """データベース最適化クラス"""
    
    @staticmethod
    def optimize_query_performance():
        """クエリパフォーマンスの最適化"""
        engine = get_engine()
        
        optimization_queries = [
            # インデックス作成
            "CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);",
            "CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);",
            "CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at);",
            "CREATE INDEX IF NOT EXISTS idx_users_is_active ON users(is_active);",
            "CREATE INDEX IF NOT EXISTS idx_users_department ON users(department);",
            
            # 統計情報の更新
            "ANALYZE users;",
        ]
        
        try:
            with engine.connect() as conn:
                for query in optimization_queries:
                    conn.execute(text(query))
                    conn.commit()
            
            st.success("データベース最適化が完了しました")
            
        except Exception as e:
            st.error(f"データベース最適化エラー: {str(e)}")
    
    @staticmethod
    def get_database_statistics() -> Dict[str, Any]:
        """データベース統計情報の取得"""
        engine = get_engine()
        
        try:
            with engine.connect() as conn:
                # テーブルサイズ
                table_size_query = text("""
                    SELECT 
                        schemaname,
                        tablename,
                        attname,
                        n_distinct,
                        correlation
                    FROM pg_stats 
                    WHERE tablename = 'users'
                """)
                
                stats_result = conn.execute(table_size_query).fetchall()
                
                # インデックス情報
                index_query = text("""
                    SELECT 
                        indexname,
                        indexdef
                    FROM pg_indexes 
                    WHERE tablename = 'users'
                """)
                
                index_result = conn.execute(index_query).fetchall()
                
                return {
                    'table_stats': [dict(row._mapping) for row in stats_result],
                    'indexes': [dict(row._mapping) for row in index_result]
                }
                
        except Exception as e:
            st.error(f"統計情報取得エラー: {str(e)}")
            return {}

class ResourceManager:
    """リソース管理クラス"""
    
    @staticmethod
    def optimize_memory_usage():
        """メモリ使用量の最適化"""
        # DataFrameメモリ使用量の最適化
        if 'user_data' in st.session_state:
            df = st.session_state.user_data
            if isinstance(df, pd.DataFrame):
                # データ型の最適化
                for col in df.select_dtypes(include=['object']).columns:
                    df[col] = df[col].astype('category')
                
                # 不要なカラムの削除
                if 'temp_columns' in df.columns:
                    df.drop('temp_columns', axis=1, inplace=True)
    
    @staticmethod
    def cleanup_cache():
        """キャッシュのクリーンアップ"""
        st.cache_data.clear()
        st.cache_resource.clear()
        
        # セッション状態の不要なデータクリア
        keys_to_remove = [
            key for key in st.session_state.keys() 
            if key.startswith('temp_') or key.startswith('cache_')
        ]
        
        for key in keys_to_remove:
            del st.session_state[key]
    
    @staticmethod
    def get_memory_usage() -> Dict[str, Any]:
        """メモリ使用量の取得"""
        import psutil
        import sys
        
        process = psutil.Process()
        memory_info = process.memory_info()
        
        return {
            'rss': memory_info.rss / 1024 / 1024,  # MB
            'vms': memory_info.vms / 1024 / 1024,  # MB
            'percent': process.memory_percent(),
            'python_objects': len(gc.get_objects()) if 'gc' in sys.modules else 0
        }

# パフォーマンス監視付きの関数例
@PerformanceMonitor.measure_execution_time
@PerformanceMonitor.cache_with_ttl(ttl=600)
def get_user_statistics():
    """ユーザー統計の取得（最適化版）"""
    from app.utils.dashboard_analytics import DashboardAnalytics
    
    analytics = DashboardAnalytics()
    return analytics.calculate_metrics()

def display_performance_dashboard():
    """パフォーマンスダッシュボードの表示"""
    st.subheader("⚡ パフォーマンス監視")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("🗄️ DB最適化実行"):
            DatabaseOptimizer.optimize_query_performance()
    
    with col2:
        if st.button("🧹 キャッシュクリア"):
            ResourceManager.cleanup_cache()
            st.success("キャッシュをクリアしました")
    
    with col3:
        if st.button("📊 統計情報表示"):
            stats = DatabaseOptimizer.get_database_statistics()
            if stats:
                st.json(stats)
    
    # メモリ使用量表示
    try:
        memory_usage = ResourceManager.get_memory_usage()
        
        st.markdown("#### メモリ使用量")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("RSS", f"{memory_usage['rss']:.1f} MB")
        with col2:
            st.metric("VMS", f"{memory_usage['vms']:.1f} MB")
        with col3:
            st.metric("使用率", f"{memory_usage['percent']:.1f}%")
            
    except Exception as e:
        st.info("メモリ監視にはpsutilが必要です")</code></pre>

                        <h6>パフォーマンス最適化の要点</h6>
                        <ul>
                            <li><strong>キャッシング</strong>: 頻繁にアクセスされるデータの保存</li>
                            <li><strong>インデックス</strong>: データベースクエリの高速化</li>
                            <li><strong>メモリ管理</strong>: 不要なデータの削除</li>
                            <li><strong>監視</strong>: 実行時間とリソース使用量の追跡</li>
                        </ul>
                    </div>

                    <!-- Docker Compose本番環境 -->
                    <h3 class="section-title">7.6 Docker Composeによる本番環境構築</h3>
                    <p>本番環境用のDocker Compose設定を作成し、安全で効率的なデプロイ環境を構築します。</p>

                    <div class="exercise-container">
                        <h5>実習 7-4: 本番用Docker Compose設定</h5>
                        <p>セキュリティを考慮した本番環境用のDocker設定を作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>docker-compose.prod.yml</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.prod
    ports:
      - "8501:8501"
    environment:
      - ENVIRONMENT=production
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USERNAME=${DB_USERNAME:-admin}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE:-user_management}
      - SECRET_KEY=${SECRET_KEY}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - app_logs:/app/logs
    networks:
      - app_network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "1001:1001"
    read_only: true
    tmpfs:
      - /tmp
      - /app/temp

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${DB_DATABASE:-user_management}
      POSTGRES_USER: ${DB_USERNAME:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - app_network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-admin} -d ${DB_DATABASE:-user_management}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - app_network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

  redis:
    image: redis:alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - app_network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  app_logs:
    driver: local
  nginx_logs:
    driver: local

networks:
  app_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16</code></pre>

                        <ol start="2">
                            <li><code>Dockerfile.prod</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>FROM python:3.11-slim as builder

# セキュリティアップデート
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev && \
    rm -rf /var/lib/apt/lists/*

# 依存関係のインストール
COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# 本番環境
FROM python:3.11-slim

# セキュリティ設定
RUN groupadd -r appuser && useradd -r -g appuser -u 1001 appuser && \
    apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends libpq5 && \
    rm -rf /var/lib/apt/lists/*

# Python依存関係のコピー
COPY --from=builder /root/.local /home/appuser/.local

# アプリケーションファイルのコピー
WORKDIR /app
COPY --chown=appuser:appuser . .

# ログディレクトリの作成
RUN mkdir -p /app/logs && chown appuser:appuser /app/logs

# セキュリティ設定
USER appuser

# 環境変数
ENV PATH=/home/appuser/.local/bin:$PATH
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

EXPOSE 8501

CMD ["streamlit", "run", "app/main.py", "--server.port=8501", "--server.address=0.0.0.0", "--server.headless=true"]</code></pre>

                        <ol start="3">
                            <li><code>docker/nginx/nginx.conf</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>events {
    worker_connections 1024;
}

http {
    upstream app {
        server app:8501;
    }

    # セキュリティヘッダー
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # レート制限
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    server {
        listen 80;
        server_name localhost;

        # HTTPSリダイレクト
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name localhost;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # セキュリティ設定
        client_max_body_size 10M;
        client_body_timeout 60s;
        client_header_timeout 60s;

        location / {
            limit_req zone=api burst=20 nodelay;
            
            proxy_pass http://app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket対応
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # 静的ファイル
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}</code></pre>

                        <h6>本番環境の特徴</h6>
                        <ul>
                            <li><strong>セキュリティ強化</strong>: 最小権限、読み取り専用ファイルシステム</li>
                            <li><strong>リバースプロキシ</strong>: Nginxによる負荷分散とSSL終端</li>
                            <li><strong>ヘルスチェック</strong>: コンテナの健全性監視</li>
                            <li><strong>永続化</strong>: データボリュームによるデータ保護</li>
                        </ul>
                    </div>

                    <!-- セキュリティチェックリスト -->
                    <h3 class="section-title">7.7 デプロイ前セキュリティチェックリスト</h3>
                    <p>本番環境デプロイ前に確認すべきセキュリティ項目を整理します。</p>

                    <div class="warning">
                        <h6>必須セキュリティチェック項目</h6>
                        <ul>
                            <li><strong>認証・認可</strong>: 適切なアクセス制御の実装</li>
                            <li><strong>暗号化</strong>: HTTPS通信とパスワードハッシュ化</li>
                            <li><strong>入力検証</strong>: SQLインジェクション、XSS対策</li>
                            <li><strong>エラーハンドリング</strong>: 機密情報の漏洩防止</li>
                            <li><strong>ログ監視</strong>: セキュリティイベントの記録</li>
                            <li><strong>依存関係</strong>: 既知脆弱性のチェック</li>
                            <li><strong>設定管理</strong>: デフォルト設定の変更</li>
                            <li><strong>バックアップ</strong>: データ復旧計画</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>環境変数を使用する主な理由は？</li>
                            <li>PBKDF2を使用したパスワードハッシュ化の利点は？</li>
                            <li>SQLModelがSQLインジェクション対策に有効な理由は？</li>
                            <li>本番環境でのDocker設定で重要なセキュリティ考慮事項は？</li>
                            <li>Streamlitアプリケーションのパフォーマンス最適化で重要なポイントは？</li>
                        </ol>
                        
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>機密情報をソースコードから分離し、環境ごとの設定変更を可能にするため</li>
                                <li>ソルト付きで反復計算により、ブルートフォース攻撃に対する耐性が高い</li>
                                <li>ORMによりSQLクエリが自動生成され、パラメータ化により安全だから</li>
                                <li>最小権限の原則、読み取り専用ファイルシステム、セキュリティオプションの設定</li>
                                <li>キャッシング、データベースインデックス、メモリ管理、実行時間監視</li>
                            </ol>
                        </details>
                    </div>

                    <!-- まとめと次のステップ -->
                    <div class="info">
                        <h6>チュートリアル完了！</h6>
                        <p>このチュートリアルを通じて、以下のスキルを習得しました：</p>
                        <ul>
                            <li><strong>環境構築</strong>: DockerとPostgreSQL環境の構築</li>
                            <li><strong>データベース設計</strong>: SQLModelによる型安全なORM</li>
                            <li><strong>ユーザーインターフェース</strong>: Streamlitによるインタラクティブな画面</li>
                            <li><strong>CRUD操作</strong>: 完全なデータ操作機能</li>
                            <li><strong>データ可視化</strong>: Plotlyによるダッシュボード</li>
                            <li><strong>セキュリティ</strong>: 認証、暗号化、脆弱性対策</li>
                            <li><strong>デプロイ</strong>: 本番環境用の設定とDocker Compose</li>
                        </ul>
                    </div>

                    <!-- ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step6-dashboard-visualization.html" class="btn btn-secondary">← 前のステップ: ダッシュボード</a>
                        <a href="../README.html" class="btn btn-success">チュートリアル完了 🎉</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>