<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« Step 6 - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .navbar {
            background-color: #0066cc;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ« */
        .chapter-title {
            color: #0066cc;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #3399ff;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒœãƒƒã‚¯ã‚¹ */
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0066cc;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .success {
            background-color: #d4edda;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #28a745;
        }

        .security-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #fdcb6e;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav-link.active {
            background-color: #0066cc !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e6f2ff;
        }

        /* ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }
        
        .code-block {
            background-color: #1e1e1e !important;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            border: none !important;
        }
        
        .code-block code {
            background-color: transparent !important;
            color: #ffffff;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }

        .img-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ */
        .security-checklist {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
        }

        .checklist-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ãƒ›ãƒ¼ãƒ </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="../streamlit-sqlmodel/README.html">Streamlit + SQLModel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                        Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: ç’°å¢ƒæ§‹ç¯‰</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">Step 5: CRUDæ“ä½œ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#step6">Step 6: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- ç« ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 6: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="badge bg-info">æ‰€è¦æ™‚é–“: 2æ™‚é–“</span>
                        </div>
                    </div>
                </div>

                <div id="step6">
                    <!-- ç« ã‚¿ã‚¤ãƒˆãƒ« -->
                    <h2 class="chapter-title">æœ¬ç•ªç’°å¢ƒå¯¾å¿œã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–</h2>
                    
                    <!-- å­¦ç¿’ç›®æ¨™ -->
                    <div class="highlight">
                        <h5>ã“ã®ç« ã§å­¦ã¶ã“ã¨</h5>
                        <ul>
                            <li>ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹è¨­å®šç®¡ç†ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</li>
                            <li>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã¨ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</li>
                            <li>èªè¨¼æ©Ÿèƒ½ã®åŸºæœ¬å®Ÿè£…</li>
                            <li>ãƒ­ã‚®ãƒ³ã‚°ã¨ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°</li>
                            <li>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</li>
                            <li>æœ¬ç•ªç’°å¢ƒã§ã®PostgreSQLè¨­å®š</li>
                            <li>ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</li>
                        </ul>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºç¤ -->
                    <h3 class="section-title">6.1 Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŸºç¤</h3>
                    <p>æœ¬ç•ªç’°å¢ƒã§å®‰å…¨ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é‹ç”¨ã™ã‚‹ãŸã‚ã«ã€åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="security-box">
                        <h6>ğŸ”’ é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡</h6>
                        <ul>
                            <li><strong>æœ€å°æ¨©é™ã®åŸå‰‡</strong>: å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸</li>
                            <li><strong>å¤šå±¤é˜²å¾¡</strong>: è¤‡æ•°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å±¤ã§ä¿è­·</li>
                            <li><strong>å…¥åŠ›æ¤œè¨¼</strong>: ã™ã¹ã¦ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼</li>
                            <li><strong>æ©Ÿå¯†æƒ…å ±ã®ä¿è­·</strong>: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„è¨­å®šã®é©åˆ‡ãªç®¡ç†</li>
                            <li><strong>ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</strong>: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½è·¡</li>
                        </ul>
                    </div>

                    <h4>Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸»è¦è„…å¨</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>è„…å¨</th>
                                    <th>èª¬æ˜</th>
                                    <th>å¯¾ç­–</th>
                                    <th>å®Ÿè£…ãƒ¬ãƒ™ãƒ«</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³</strong></td>
                                    <td>ä¸æ­£ãªSQLæ–‡ã®æŒ¿å…¥</td>
                                    <td>ORMä½¿ç”¨ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª</td>
                                    <td>âœ… å¯¾å¿œæ¸ˆã¿</td>
                                </tr>
                                <tr>
                                    <td><strong>XSSæ”»æ’ƒ</strong></td>
                                    <td>ä¸æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ</td>
                                    <td>å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã€CSP</td>
                                    <td>âš¡ éƒ¨åˆ†å¯¾å¿œ</td>
                                </tr>
                                <tr>
                                    <td><strong>èªè¨¼ãƒ»èªå¯</strong></td>
                                    <td>ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹</td>
                                    <td>é©åˆ‡ãªèªè¨¼ã‚·ã‚¹ãƒ†ãƒ </td>
                                    <td>ğŸ”„ å®Ÿè£…äºˆå®š</td>
                                </tr>
                                <tr>
                                    <td><strong>æ©Ÿå¯†æƒ…å ±æ¼æ´©</strong></td>
                                    <td>è¨­å®šæƒ…å ±ã®éœ²å‡º</td>
                                    <td>ç’°å¢ƒå¤‰æ•°ã€æš—å·åŒ–</td>
                                    <td>ğŸ”„ å®Ÿè£…äºˆå®š</td>
                                </tr>
                                <tr>
                                    <td><strong>CSRFæ”»æ’ƒ</strong></td>
                                    <td>å½é€ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</td>
                                    <td>CSRFãƒˆãƒ¼ã‚¯ãƒ³</td>
                                    <td>ğŸ’¡ ä»Šå¾Œå®Ÿè£…</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: ç’°å¢ƒå¤‰æ•°ç®¡ç† -->
                    <h3 class="section-title">6.2 ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹è¨­å®šç®¡ç†</h3>
                    
                    <p>æ©Ÿå¯†æƒ…å ±ã¨ç’°å¢ƒå›ºæœ‰ã®è¨­å®šã‚’å®‰å…¨ã«ç®¡ç†ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 6-1: ã‚»ã‚­ãƒ¥ã‚¢ãªè¨­å®šç®¡ç†ã®å®Ÿè£…</h5>
                        <p>ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹è¨­å®šç®¡ç†ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã‚’å¼·åŒ–ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>ç’°å¢ƒå›ºæœ‰ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ</li>
                            <li>ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã®å¼·åŒ–</li>
                            <li>è¨­å®šæ¤œè¨¼æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®ç’°å¢ƒåˆ¥è¨­å®š</li>
                            <li>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ </li>
                        </ol>

                        <h6>app/config.py ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆ</h6>
                        <pre><code>"""
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šç®¡ç†
ç’°å¢ƒå¤‰æ•°ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã‚’å«ã‚€
"""

import os
import secrets
import logging
from typing import Optional, List, Dict, Any
from dotenv import load_dotenv
from pathlib import Path

# ç’°å¢ƒã«å¿œã˜ãŸ.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
env_file = f".env.{os.getenv('ENVIRONMENT', 'development')}"
if Path(env_file).exists():
    load_dotenv(env_file)
else:
    load_dotenv()  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®.envãƒ•ã‚¡ã‚¤ãƒ«

class SecuritySettings:
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£è¨­å®š"""
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
    SECRET_KEY: str = os.getenv("SECRET_KEY", secrets.token_urlsafe(32))
    SESSION_TIMEOUT: int = int(os.getenv("SESSION_TIMEOUT", "3600"))  # 1æ™‚é–“
    
    # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
    PASSWORD_MIN_LENGTH: int = int(os.getenv("PASSWORD_MIN_LENGTH", "8"))
    PASSWORD_REQUIRE_UPPERCASE: bool = os.getenv("PASSWORD_REQUIRE_UPPERCASE", "True").lower() == "true"
    PASSWORD_REQUIRE_NUMBERS: bool = os.getenv("PASSWORD_REQUIRE_NUMBERS", "True").lower() == "true"
    PASSWORD_REQUIRE_SPECIAL: bool = os.getenv("PASSWORD_REQUIRE_SPECIAL", "True").lower() == "true"
    
    # ãƒ¬ãƒ¼ãƒˆåˆ¶é™
    RATE_LIMIT_ENABLED: bool = os.getenv("RATE_LIMIT_ENABLED", "True").lower() == "true"
    RATE_LIMIT_REQUESTS: int = int(os.getenv("RATE_LIMIT_REQUESTS", "100"))
    RATE_LIMIT_WINDOW: int = int(os.getenv("RATE_LIMIT_WINDOW", "3600"))  # 1æ™‚é–“
    
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
    SECURITY_HEADERS: Dict[str, str] = {
        "X-Content-Type-Options": "nosniff",
        "X-Frame-Options": "DENY",
        "X-XSS-Protection": "1; mode=block",
        "Strict-Transport-Security": "max-age=31536000; includeSubDomains",
        "Content-Security-Policy": "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
    }

class DatabaseSettings:
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆï¼‰"""
    
    # åŸºæœ¬æ¥ç¶šæƒ…å ±
    POSTGRES_HOST: str = os.getenv("POSTGRES_HOST", "localhost")
    POSTGRES_PORT: int = int(os.getenv("POSTGRES_PORT", "5432"))
    POSTGRES_DB: str = os.getenv("POSTGRES_DB", "userdb")
    POSTGRES_USER: str = os.getenv("POSTGRES_USER", "postgres")
    POSTGRES_PASSWORD: str = os.getenv("POSTGRES_PASSWORD", "password")
    
    # SSLè¨­å®š
    POSTGRES_SSL_MODE: str = os.getenv("POSTGRES_SSL_MODE", "prefer")
    POSTGRES_SSL_CERT: Optional[str] = os.getenv("POSTGRES_SSL_CERT")
    POSTGRES_SSL_KEY: Optional[str] = os.getenv("POSTGRES_SSL_KEY")
    POSTGRES_SSL_CA: Optional[str] = os.getenv("POSTGRES_SSL_CA")
    
    # æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®š
    CONNECTION_POOL_SIZE: int = int(os.getenv("CONNECTION_POOL_SIZE", "20"))
    CONNECTION_POOL_MAX_OVERFLOW: int = int(os.getenv("CONNECTION_POOL_MAX_OVERFLOW", "30"))
    CONNECTION_POOL_TIMEOUT: int = int(os.getenv("CONNECTION_POOL_TIMEOUT", "30"))
    CONNECTION_POOL_RECYCLE: int = int(os.getenv("CONNECTION_POOL_RECYCLE", "3600"))
    
    # ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    QUERY_TIMEOUT: int = int(os.getenv("QUERY_TIMEOUT", "30"))
    
    @property
    def database_url(self) -> str:
        """ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URL ã‚’æ§‹ç¯‰"""
        url = (
            f"postgresql://{self.POSTGRES_USER}:{self.POSTGRES_PASSWORD}"
            f"@{self.POSTGRES_HOST}:{self.POSTGRES_PORT}/{self.POSTGRES_DB}"
        )
        
        # SSLè¨­å®šã‚’è¿½åŠ 
        ssl_params = []
        if self.POSTGRES_SSL_MODE:
            ssl_params.append(f"sslmode={self.POSTGRES_SSL_MODE}")
        if self.POSTGRES_SSL_CERT:
            ssl_params.append(f"sslcert={self.POSTGRES_SSL_CERT}")
        if self.POSTGRES_SSL_KEY:
            ssl_params.append(f"sslkey={self.POSTGRES_SSL_KEY}")
        if self.POSTGRES_SSL_CA:
            ssl_params.append(f"sslrootcert={self.POSTGRES_SSL_CA}")
        
        if ssl_params:
            url += "?" + "&".join(ssl_params)
        
        return url

class LoggingSettings:
    """ãƒ­ã‚°è¨­å®š"""
    
    LOG_LEVEL: str = os.getenv("LOG_LEVEL", "INFO")
    LOG_FORMAT: str = os.getenv(
        "LOG_FORMAT", 
        "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    )
    LOG_FILE: Optional[str] = os.getenv("LOG_FILE")
    LOG_MAX_BYTES: int = int(os.getenv("LOG_MAX_BYTES", "10485760"))  # 10MB
    LOG_BACKUP_COUNT: int = int(os.getenv("LOG_BACKUP_COUNT", "5"))
    
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°
    SECURITY_LOG_ENABLED: bool = os.getenv("SECURITY_LOG_ENABLED", "True").lower() == "true"
    SECURITY_LOG_FILE: Optional[str] = os.getenv("SECURITY_LOG_FILE", "security.log")

class Settings:
    """çµ±åˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚¯ãƒ©ã‚¹"""
    
    # ç’°å¢ƒè¨­å®š
    ENVIRONMENT: str = os.getenv("ENVIRONMENT", "development")
    DEBUG: bool = os.getenv("DEBUG", "False").lower() == "true"
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŸºæœ¬è¨­å®š
    APP_NAME: str = os.getenv("APP_NAME", "Modern User Management Dashboard")
    APP_VERSION: str = os.getenv("APP_VERSION", "1.0.0")
    APP_DESCRIPTION: str = os.getenv("APP_DESCRIPTION", "Streamlit + SQLModel Tutorial Application")
    
    # Streamlitè¨­å®š
    STREAMLIT_PORT: int = int(os.getenv("STREAMLIT_PORT", "8501"))
    STREAMLIT_HOST: str = os.getenv("STREAMLIT_HOST", "0.0.0.0")
    
    # å„ç¨®è¨­å®šã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    security = SecuritySettings()
    database = DatabaseSettings()
    logging = LoggingSettings()
    
    def __init__(self):
        """è¨­å®šã®åˆæœŸåŒ–ã¨æ¤œè¨¼"""
        self.validate_settings()
        self.setup_logging()
    
    def validate_settings(self):
        """è¨­å®šã®æ¤œè¨¼"""
        errors = []
        
        # å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
        required_vars = {
            "POSTGRES_HOST": self.database.POSTGRES_HOST,
            "POSTGRES_DB": self.database.POSTGRES_DB,
            "POSTGRES_USER": self.database.POSTGRES_USER,
            "POSTGRES_PASSWORD": self.database.POSTGRES_PASSWORD,
        }
        
        for var_name, var_value in required_vars.items():
            if not var_value:
                errors.append(f"å¿…é ˆç’°å¢ƒå¤‰æ•° {var_name} ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        
        # æœ¬ç•ªç’°å¢ƒã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        if self.ENVIRONMENT == "production":
            if self.DEBUG:
                errors.append("æœ¬ç•ªç’°å¢ƒã§DEBUGãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™")
            
            if self.security.SECRET_KEY == "your-secret-key-here":
                errors.append("æœ¬ç•ªç’°å¢ƒã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®SECRET_KEYãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™")
            
            if self.database.POSTGRES_PASSWORD == "password":
                errors.append("æœ¬ç•ªç’°å¢ƒã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™")
        
        if errors:
            error_msg = "\n".join(f"- {error}" for error in errors)
            raise ValueError(f"è¨­å®šã‚¨ãƒ©ãƒ¼:\n{error_msg}")
    
    def setup_logging(self):
        """ãƒ­ã‚°è¨­å®šã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"""
        # åŸºæœ¬ãƒ­ã‚°è¨­å®š
        log_level = getattr(logging, self.logging.LOG_LEVEL.upper())
        logging.basicConfig(
            level=log_level,
            format=self.logging.LOG_FORMAT,
            handlers=self._get_log_handlers()
        )
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®è¨­å®š
        if self.logging.SECURITY_LOG_ENABLED:
            self._setup_security_logging()
    
    def _get_log_handlers(self) -> List[logging.Handler]:
        """ãƒ­ã‚°ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å–å¾—"""
        handlers = [logging.StreamHandler()]  # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
        
        if self.logging.LOG_FILE:
            from logging.handlers import RotatingFileHandler
            file_handler = RotatingFileHandler(
                self.logging.LOG_FILE,
                maxBytes=self.logging.LOG_MAX_BYTES,
                backupCount=self.logging.LOG_BACKUP_COUNT
            )
            file_handler.setFormatter(
                logging.Formatter(self.logging.LOG_FORMAT)
            )
            handlers.append(file_handler)
        
        return handlers
    
    def _setup_security_logging(self):
        """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®è¨­å®š"""
        security_logger = logging.getLogger("security")
        
        if self.logging.SECURITY_LOG_FILE:
            from logging.handlers import RotatingFileHandler
            security_handler = RotatingFileHandler(
                self.logging.SECURITY_LOG_FILE,
                maxBytes=self.logging.LOG_MAX_BYTES,
                backupCount=self.logging.LOG_BACKUP_COUNT
            )
            security_handler.setFormatter(
                logging.Formatter(
                    "%(asctime)s - SECURITY - %(levelname)s - %(message)s"
                )
            )
            security_logger.addHandler(security_handler)
    
    def get_safe_config(self) -> Dict[str, Any]:
        """æ©Ÿå¯†æƒ…å ±ã‚’é™¤ã„ãŸè¨­å®šã‚’å–å¾—ï¼ˆãƒ­ã‚°å‡ºåŠ›ç”¨ï¼‰"""
        return {
            "app_name": self.APP_NAME,
            "app_version": self.APP_VERSION,
            "environment": self.ENVIRONMENT,
            "debug": self.DEBUG,
            "database_host": self.database.POSTGRES_HOST,
            "database_port": self.database.POSTGRES_PORT,
            "database_name": self.database.POSTGRES_DB,
            "streamlit_port": self.STREAMLIT_PORT,
            "log_level": self.logging.LOG_LEVEL,
        }
    
    def __repr__(self) -> str:
        safe_config = self.get_safe_config()
        return f"Settings({safe_config})"

# è¨­å®šã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
try:
    settings = Settings()
    logger = logging.getLogger(__name__)
    logger.info(f"ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ: {settings.get_safe_config()}")
except Exception as e:
    print(f"è¨­å®šåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
    raise

# è¨­å®šæ¤œè¨¼ç”¨ã®é–¢æ•°
def validate_production_config() -> List[str]:
    """æœ¬ç•ªç’°å¢ƒè¨­å®šã®æ¤œè¨¼"""
    warnings = []
    
    if settings.ENVIRONMENT == "production":
        # SSLè¨­å®šãƒã‚§ãƒƒã‚¯
        if settings.database.POSTGRES_SSL_MODE == "disable":
            warnings.append("æœ¬ç•ªç’°å¢ƒã§SSLãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™")
        
        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯
        if len(settings.database.POSTGRES_PASSWORD) < 12:
            warnings.append("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™ï¼ˆ12æ–‡å­—ä»¥ä¸Šæ¨å¥¨ï¼‰")
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒã‚§ãƒƒã‚¯
        if not settings.security.RATE_LIMIT_ENABLED:
            warnings.append("ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™")
    
    return warnings

if __name__ == "__main__":
    print("è¨­å®šæƒ…å ±:")
    print(settings)
    
    # æœ¬ç•ªç’°å¢ƒãƒã‚§ãƒƒã‚¯
    warnings = validate_production_config()
    if warnings:
        print("\nâš ï¸  æœ¬ç•ªç’°å¢ƒã®è­¦å‘Š:")
        for warning in warnings:
            print(f"- {warning}")
</code></pre>

                        <h6>.env.production ã‚µãƒ³ãƒ—ãƒ«</h6>
                        <pre><code># æœ¬ç•ªç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (.env.production)
ENVIRONMENT=production
DEBUG=False

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
APP_NAME=Modern User Management Dashboard
APP_VERSION=1.0.0
SECRET_KEY=your-production-secret-key-here

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š (æœ¬ç•ªç’°å¢ƒ)
POSTGRES_HOST=your-production-db-host
POSTGRES_PORT=5432
POSTGRES_DB=userdb_prod
POSTGRES_USER=app_user
POSTGRES_PASSWORD=your-strong-production-password

# SSLè¨­å®š
POSTGRES_SSL_MODE=require
POSTGRES_SSL_CERT=/path/to/client-cert.pem
POSTGRES_SSL_KEY=/path/to/client-key.pem
POSTGRES_SSL_CA=/path/to/ca-cert.pem

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
SESSION_TIMEOUT=1800
PASSWORD_MIN_LENGTH=12
RATE_LIMIT_ENABLED=True
RATE_LIMIT_REQUESTS=50
RATE_LIMIT_WINDOW=3600

# ãƒ­ã‚°è¨­å®š
LOG_LEVEL=INFO
LOG_FILE=/var/log/app/application.log
SECURITY_LOG_ENABLED=True
SECURITY_LOG_FILE=/var/log/app/security.log

# Streamlitè¨­å®š
STREAMLIT_HOST=0.0.0.0
STREAMLIT_PORT=8501</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹è¨­å®šç®¡ç†ãŒå¼·åŒ–ã•ã‚Œã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã¨æœ¬ç•ªç’°å¢ƒå¯¾å¿œãŒå®Ÿè£…ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: èªè¨¼æ©Ÿèƒ½ -->
                    <h3 class="section-title">6.3 åŸºæœ¬èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…</h3>
                    
                    <p>Streamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«åŸºæœ¬çš„ãªèªè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 6-2: èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…</h5>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>èªè¨¼ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆ</li>
                            <li>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–</li>
                            <li>ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½</li>
                            <li>ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†å¼·åŒ–</li>
                            <li>æ¨©é™ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡</li>
                        </ol>

                        <h6>app/models/auth.pyä½œæˆ</h6>
                        <pre><code>"""
èªè¨¼é–¢é€£ãƒ¢ãƒ‡ãƒ«
ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
"""

from typing import Optional, List
from datetime import datetime, timedelta
from sqlmodel import SQLModel, Field, Relationship
from passlib.context import CryptContext
from pydantic import EmailStr
import secrets
import hashlib

# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–è¨­å®š
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

class AuthUser(SQLModel, table=True):
    """èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«"""
    __tablename__ = "auth_users"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(unique=True, index=True, min_length=3, max_length=50)
    email: EmailStr = Field(unique=True, index=True)
    hashed_password: str = Field(min_length=8)
    full_name: str = Field(max_length=100)
    
    # æ¨©é™ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    is_active: bool = Field(default=True)
    is_superuser: bool = Field(default=False)
    role: str = Field(default="user")  # user, admin, moderator
    
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£
    last_login: Optional[datetime] = None
    login_attempts: int = Field(default=0)
    locked_until: Optional[datetime] = None
    password_changed_at: datetime = Field(default_factory=datetime.utcnow)
    
    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    
    def verify_password(self, password: str) -> bool:
        """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œè¨¼"""
        return pwd_context.verify(password, self.hashed_password)
    
    def set_password(self, password: str):
        """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦è¨­å®š"""
        self.hashed_password = pwd_context.hash(password)
        self.password_changed_at = datetime.utcnow()
    
    def is_locked(self) -> bool:
        """ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
        if self.locked_until is None:
            return False
        return datetime.utcnow() < self.locked_until
    
    def lock_account(self, duration_minutes: int = 30):
        """ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ­ãƒƒã‚¯"""
        self.locked_until = datetime.utcnow() + timedelta(minutes=duration_minutes)
    
    def unlock_account(self):
        """ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤"""
        self.locked_until = None
        self.login_attempts = 0
    
    def record_login_attempt(self, success: bool):
        """ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã‚’è¨˜éŒ²"""
        if success:
            self.last_login = datetime.utcnow()
            self.login_attempts = 0
        else:
            self.login_attempts += 1
            # 5å›å¤±æ•—ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯
            if self.login_attempts >= 5:
                self.lock_account()

class UserSession(SQLModel, table=True):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«"""
    __tablename__ = "user_sessions"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    session_token: str = Field(unique=True, index=True)
    user_id: int = Field(foreign_key="auth_users.id")
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
    created_at: datetime = Field(default_factory=datetime.utcnow)
    last_accessed: datetime = Field(default_factory=datetime.utcnow)
    expires_at: datetime
    
    # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±
    ip_address: Optional[str] = None
    user_agent: Optional[str] = None
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹
    is_active: bool = Field(default=True)
    
    @classmethod
    def create_session(
        cls, 
        user_id: int, 
        duration_hours: int = 24,
        ip_address: Optional[str] = None,
        user_agent: Optional[str] = None
    ) -> "UserSession":
        """æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ"""
        session_token = secrets.token_urlsafe(32)
        expires_at = datetime.utcnow() + timedelta(hours=duration_hours)
        
        return cls(
            session_token=session_token,
            user_id=user_id,
            expires_at=expires_at,
            ip_address=ip_address,
            user_agent=user_agent
        )
    
    def is_expired(self) -> bool:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæœŸé™åˆ‡ã‚Œã‹ãƒã‚§ãƒƒã‚¯"""
        return datetime.utcnow() > self.expires_at
    
    def extend_session(self, hours: int = 24):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å»¶é•·"""
        self.expires_at = datetime.utcnow() + timedelta(hours=hours)
        self.last_accessed = datetime.utcnow()

class LoginAttempt(SQLModel, table=True):
    """ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå±¥æ­´"""
    __tablename__ = "login_attempts"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(index=True)
    ip_address: Optional[str] = None
    user_agent: Optional[str] = None
    success: bool
    failure_reason: Optional[str] = None
    attempted_at: datetime = Field(default_factory=datetime.utcnow)

# èªè¨¼é–¢é€£ã®å‹å®šç¾©
class LoginRequest(SQLModel):
    """ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ"""
    username: str
    password: str
    remember_me: bool = False

class LoginResponse(SQLModel):
    """ãƒ­ã‚°ã‚¤ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹"""
    success: bool
    message: str
    session_token: Optional[str] = None
    user_info: Optional[dict] = None

class PasswordChangeRequest(SQLModel):
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ"""
    current_password: str
    new_password: str
    confirm_password: str

class UserRole:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™å®šç¾©"""
    USER = "user"
    MODERATOR = "moderator"
    ADMIN = "admin"
    SUPERUSER = "superuser"
    
    @classmethod
    def get_permissions(cls, role: str) -> List[str]:
        """ãƒ­ãƒ¼ãƒ«ã«åŸºã¥ãæ¨©é™ã‚’å–å¾—"""
        permissions = {
            cls.USER: ["read_own", "update_own"],
            cls.MODERATOR: ["read_own", "update_own", "read_users", "moderate_content"],
            cls.ADMIN: ["read_own", "update_own", "read_users", "update_users", "delete_users", "manage_system"],
            cls.SUPERUSER: ["all"]
        }
        return permissions.get(role, [])</code></pre>

                        <h6>app/auth/auth_manager.pyä½œæˆ</h6>
                        <pre><code>"""
èªè¨¼ç®¡ç†æ©Ÿèƒ½
ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
"""

import streamlit as st
from typing import Optional, Dict, Any
from datetime import datetime
import logging

from app.database.connection import get_db_session
from app.models.auth import AuthUser, UserSession, LoginAttempt, LoginRequest, LoginResponse
from app.config import settings

logger = logging.getLogger(__name__)
security_logger = logging.getLogger("security")

class AuthManager:
    """èªè¨¼ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def initialize_auth():
        """èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–"""
        if 'authenticated' not in st.session_state:
            st.session_state.authenticated = False
        
        if 'current_user' not in st.session_state:
            st.session_state.current_user = None
        
        if 'session_token' not in st.session_state:
            st.session_state.session_token = None
    
    @staticmethod
    def login(username: str, password: str, remember_me: bool = False) -> LoginResponse:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
            from sqlmodel import select
            statement = select(AuthUser).where(AuthUser.username == username)
            user = session.exec(statement).first()
            
            # ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã‚’è¨˜éŒ²
            AuthManager._record_login_attempt(session, username, user is not None and user.verify_password(password))
            
            if not user:
                security_logger.warning(f"å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: {username}")
                return LoginResponse(success=False, message="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“")
            
            if not user.is_active:
                security_logger.warning(f"éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: {username}")
                return LoginResponse(success=False, message="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™")
            
            if user.is_locked():
                security_logger.warning(f"ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: {username}")
                return LoginResponse(success=False, message="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„")
            
            if not user.verify_password(password):
                user.record_login_attempt(False)
                session.add(user)
                session.commit()
                
                security_logger.warning(f"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸æ­£ã§ã®ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: {username}")
                return LoginResponse(success=False, message="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“")
            
            # ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
            user.record_login_attempt(True)
            
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
            duration = 24 * 7 if remember_me else 24  # Remember me ã®å ´åˆã¯1é€±é–“
            user_session = UserSession.create_session(
                user_id=user.id,
                duration_hours=duration,
                ip_address=AuthManager._get_client_ip(),
                user_agent=AuthManager._get_user_agent()
            )
            
            session.add(user)
            session.add(user_session)
            session.commit()
            
            # Streamlitã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
            st.session_state.authenticated = True
            st.session_state.current_user = {
                'id': user.id,
                'username': user.username,
                'email': user.email,
                'full_name': user.full_name,
                'role': user.role,
                'is_superuser': user.is_superuser
            }
            st.session_state.session_token = user_session.session_token
            
            security_logger.info(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: {username}")
            
            return LoginResponse(
                success=True,
                message="ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸ",
                session_token=user_session.session_token,
                user_info=st.session_state.current_user
            )
            
        except Exception as e:
            logger.error(f"ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: {e}")
            return LoginResponse(success=False, message="ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
        finally:
            session.close()
    
    @staticmethod
    def logout():
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"""
        try:
            if st.session_state.get('session_token'):
                session_gen = get_db_session()
                session = next(session_gen)
                
                # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
                from sqlmodel import select
                statement = select(UserSession).where(UserSession.session_token == st.session_state.session_token)
                user_session = session.exec(statement).first()
                
                if user_session:
                    user_session.is_active = False
                    session.add(user_session)
                    session.commit()
                
                session.close()
            
            # Streamlitã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
            st.session_state.authenticated = False
            st.session_state.current_user = None
            st.session_state.session_token = None
            
            security_logger.info("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ")
            
        except Exception as e:
            logger.error(f"ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    
    @staticmethod
    def check_session() -> bool:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯"""
        if not st.session_state.get('authenticated') or not st.session_state.get('session_token'):
            return False
        
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            from sqlmodel import select
            statement = select(UserSession).where(
                UserSession.session_token == st.session_state.session_token,
                UserSession.is_active == True
            )
            user_session = session.exec(statement).first()
            
            if not user_session or user_session.is_expired():
                AuthManager.logout()
                return False
            
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å»¶é•·
            user_session.extend_session()
            session.add(user_session)
            session.commit()
            
            session.close()
            return True
            
        except Exception as e:
            logger.error(f"ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    @staticmethod
    def require_auth(func):
        """èªè¨¼ãŒå¿…è¦ãªé–¢æ•°ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿"""
        def wrapper(*args, **kwargs):
            if not AuthManager.check_session():
                st.error("ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™")
                AuthManager.show_login_form()
                return None
            return func(*args, **kwargs)
        return wrapper
    
    @staticmethod
    def require_role(required_role: str):
        """ç‰¹å®šã®ãƒ­ãƒ¼ãƒ«ãŒå¿…è¦ãªé–¢æ•°ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿"""
        def decorator(func):
            def wrapper(*args, **kwargs):
                if not AuthManager.check_session():
                    st.error("ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™")
                    return None
                
                user = st.session_state.get('current_user')
                if not user or not AuthManager.has_permission(user['role'], required_role):
                    st.error("ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“")
                    return None
                
                return func(*args, **kwargs)
            return wrapper
        return decorator
    
    @staticmethod
    def has_permission(user_role: str, required_role: str) -> bool:
        """æ¨©é™ãƒã‚§ãƒƒã‚¯"""
        role_hierarchy = {
            'user': 1,
            'moderator': 2,
            'admin': 3,
            'superuser': 4
        }
        
        user_level = role_hierarchy.get(user_role, 0)
        required_level = role_hierarchy.get(required_role, 999)
        
        return user_level >= required_level
    
    @staticmethod
    def show_login_form():
        """ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º"""
        st.subheader("ğŸ” ãƒ­ã‚°ã‚¤ãƒ³")
        
        with st.form("login_form"):
            username = st.text_input("ãƒ¦ãƒ¼ã‚¶ãƒ¼å")
            password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password")
            remember_me = st.checkbox("ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿æŒ")
            
            submitted = st.form_submit_button("ãƒ­ã‚°ã‚¤ãƒ³")
            
            if submitted:
                if username and password:
                    response = AuthManager.login(username, password, remember_me)
                    
                    if response.success:
                        st.success(response.message)
                        st.rerun()
                    else:
                        st.error(response.message)
                else:
                    st.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
    
    @staticmethod
    def _record_login_attempt(session, username: str, success: bool):
        """ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã‚’è¨˜éŒ²"""
        attempt = LoginAttempt(
            username=username,
            ip_address=AuthManager._get_client_ip(),
            user_agent=AuthManager._get_user_agent(),
            success=success,
            failure_reason=None if success else "Invalid credentials"
        )
        session.add(attempt)
    
    @staticmethod
    def _get_client_ip() -> str:
        """ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—"""
        # Streamlitã§ã¯ç›´æ¥å–å¾—ã§ããªã„ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
        return "127.0.0.1"
    
    @staticmethod
    def _get_user_agent() -> str:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—"""
        # Streamlitã§ã¯ç›´æ¥å–å¾—ã§ããªã„ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
        return "Streamlit App"</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>åŸºæœ¬çš„ãªèªè¨¼æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ãƒ­ã‚°æ©Ÿèƒ½ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° -->
                    <h3 class="section-title">6.4 ãƒ­ã‚°æ©Ÿèƒ½ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</h3>
                    
                    <p>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½è·¡ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 6-3: ãƒ­ã‚°æ©Ÿèƒ½ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®å®Ÿè£…</h5>
                        <p>åŒ…æ‹¬çš„ãªãƒ­ã‚°æ©Ÿèƒ½ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>æ§‹é€ åŒ–ãƒ­ã‚°ã®å®Ÿè£…</li>
                            <li>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½è·¡</li>
                            <li>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</li>
                            <li>ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°</li>
                            <li>ãƒ­ã‚°åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
                        </ol>

                        <h6>app/utils/monitoring.pyä½œæˆ</h6>
                        <pre><code>"""
ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°æ©Ÿèƒ½
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
"""

import logging
import time
import traceback
from datetime import datetime, timedelta
from typing import Dict, Any, List, Optional
from functools import wraps
import streamlit as st
import psutil
import threading

from app.config import settings

# å°‚ç”¨ãƒ­ã‚¬ãƒ¼ã®è¨­å®š
app_logger = logging.getLogger("app")
security_logger = logging.getLogger("security")
performance_logger = logging.getLogger("performance")
error_logger = logging.getLogger("error")

class SecurityMonitor:
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def log_security_event(
        event_type: str,
        user_id: Optional[int] = None,
        username: Optional[str] = None,
        description: str = "",
        severity: str = "INFO",
        additional_data: Optional[Dict[str, Any]] = None
    ):
        """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ­ã‚°ã«è¨˜éŒ²"""
        event_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "event_type": event_type,
            "user_id": user_id,
            "username": username,
            "description": description,
            "severity": severity,
            "session_id": id(st.session_state),
            "additional_data": additional_data or {}
        }
        
        log_level = getattr(logging, severity.upper(), logging.INFO)
        security_logger.log(log_level, f"SECURITY_EVENT: {event_data}")
        
        # é‡è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆ
        if severity in ["WARNING", "ERROR", "CRITICAL"]:
            SecurityMonitor._trigger_security_alert(event_data)
    
    @staticmethod
    def _trigger_security_alert(event_data: Dict[str, Any]):
        """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼"""
        # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚„Slacké€šçŸ¥ãªã©ã‚’è¡Œã†
        app_logger.critical(f"SECURITY_ALERT: {event_data}")
    
    @staticmethod
    def track_login_attempt(username: str, success: bool, ip_address: str = "unknown"):
        """ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã‚’è¿½è·¡"""
        event_type = "LOGIN_SUCCESS" if success else "LOGIN_FAILURE"
        severity = "INFO" if success else "WARNING"
        description = f"ãƒ­ã‚°ã‚¤ãƒ³{'æˆåŠŸ' if success else 'å¤±æ•—'}: {username}"
        
        SecurityMonitor.log_security_event(
            event_type=event_type,
            username=username,
            description=description,
            severity=severity,
            additional_data={"ip_address": ip_address}
        )
    
    @staticmethod
    def track_data_access(
        operation: str, 
        table_name: str, 
        record_id: Optional[int] = None,
        user_id: Optional[int] = None
    ):
        """ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¿½è·¡"""
        SecurityMonitor.log_security_event(
            event_type="DATA_ACCESS",
            user_id=user_id,
            description=f"ãƒ‡ãƒ¼ã‚¿æ“ä½œ: {operation} on {table_name}",
            additional_data={
                "operation": operation,
                "table_name": table_name,
                "record_id": record_id
            }
        )
    
    @staticmethod
    def track_permission_violation(
        user_id: int,
        attempted_action: str,
        required_permission: str
    ):
        """æ¨©é™é•åã‚’è¿½è·¡"""
        SecurityMonitor.log_security_event(
            event_type="PERMISSION_VIOLATION",
            user_id=user_id,
            description=f"æ¨©é™ä¸è¶³: {attempted_action} (å¿…è¦æ¨©é™: {required_permission})",
            severity="WARNING",
            additional_data={
                "attempted_action": attempted_action,
                "required_permission": required_permission
            }
        )

class PerformanceMonitor:
    """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.metrics = {}
        self.start_time = time.time()
    
    @staticmethod
    def measure_execution_time(func_name: str = None):
        """å®Ÿè¡Œæ™‚é–“ã‚’æ¸¬å®šã™ã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿"""
        def decorator(func):
            @wraps(func)
            def wrapper(*args, **kwargs):
                start_time = time.time()
                try:
                    result = func(*args, **kwargs)
                    execution_time = time.time() - start_time
                    
                    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ­ã‚°
                    performance_logger.info(
                        f"PERFORMANCE: {func_name or func.__name__} "
                        f"executed in {execution_time:.4f}s"
                    )
                    
                    # é–¾å€¤ãƒã‚§ãƒƒã‚¯
                    if execution_time > 5.0:  # 5ç§’ä»¥ä¸Š
                        performance_logger.warning(
                            f"SLOW_QUERY: {func_name or func.__name__} "
                            f"took {execution_time:.4f}s"
                        )
                    
                    return result
                except Exception as e:
                    execution_time = time.time() - start_time
                    error_logger.error(
                        f"ERROR_WITH_TIMING: {func_name or func.__name__} "
                        f"failed after {execution_time:.4f}s: {e}"
                    )
                    raise
            return wrapper
        return decorator
    
    @staticmethod
    def get_system_metrics() -> Dict[str, Any]:
        """ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—"""
        try:
            cpu_percent = psutil.cpu_percent(interval=1)
            memory = psutil.virtual_memory()
            disk = psutil.disk_usage('/')
            
            return {
                "timestamp": datetime.utcnow().isoformat(),
                "cpu_percent": cpu_percent,
                "memory_percent": memory.percent,
                "memory_available_mb": memory.available // (1024 * 1024),
                "disk_percent": disk.percent,
                "disk_free_gb": disk.free // (1024 ** 3)
            }
        except Exception as e:
            app_logger.error(f"ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return {}
    
    @staticmethod
    def log_database_metrics(query_count: int, connection_pool_size: int):
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ãƒ­ã‚°"""
        performance_logger.info(
            f"DB_METRICS: queries={query_count}, "
            f"pool_size={connection_pool_size}"
        )

class ErrorTracker:
    """ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def track_error(
        error: Exception,
        context: str = "",
        user_id: Optional[int] = None,
        additional_data: Optional[Dict[str, Any]] = None
    ):
        """ã‚¨ãƒ©ãƒ¼ã‚’è¿½è·¡"""
        error_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "error_type": type(error).__name__,
            "error_message": str(error),
            "context": context,
            "user_id": user_id,
            "traceback": traceback.format_exc(),
            "additional_data": additional_data or {}
        }
        
        error_logger.error(f"ERROR_TRACKED: {error_data}")
        
        # é‡è¦ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã«ã‚‚è¨˜éŒ²
        if isinstance(error, (PermissionError, ValueError)):
            SecurityMonitor.log_security_event(
                event_type="APPLICATION_ERROR",
                user_id=user_id,
                description=f"ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: {error}",
                severity="ERROR",
                additional_data=error_data
            )
    
    @staticmethod
    def track_streamlit_error(func):
        """Streamlité–¢æ•°ã®ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿"""
        @wraps(func)
        def wrapper(*args, **kwargs):
            try:
                return func(*args, **kwargs)
            except Exception as e:
                ErrorTracker.track_error(
                    error=e,
                    context=f"Streamlit function: {func.__name__}",
                    user_id=st.session_state.get('current_user', {}).get('id')
                )
                # ã‚¨ãƒ©ãƒ¼ã‚’å†ç™ºç”Ÿã•ã›ã‚‹
                raise
        return wrapper

class LogAnalyzer:
    """ãƒ­ã‚°åˆ†æã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def get_security_summary(hours: int = 24) -> Dict[str, Any]:
        """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼ã‚’å–å¾—"""
        # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é›†è¨ˆ
        return {
            "login_attempts": 45,
            "successful_logins": 42,
            "failed_logins": 3,
            "security_events": 8,
            "period_hours": hours
        }
    
    @staticmethod
    def get_performance_summary(hours: int = 24) -> Dict[str, Any]:
        """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼ã‚’å–å¾—"""
        return {
            "avg_response_time": 1.2,
            "slow_queries": 3,
            "total_requests": 156,
            "error_rate": 0.02,
            "period_hours": hours
        }
    
    @staticmethod
    def get_error_summary(hours: int = 24) -> Dict[str, Any]:
        """ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼ã‚’å–å¾—"""
        return {
            "total_errors": 5,
            "critical_errors": 0,
            "warning_errors": 2,
            "info_errors": 3,
            "period_hours": hours
        }

class MonitoringDashboard:
    """ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"""
    
    @staticmethod
    def show_security_dashboard():
        """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º"""
        st.subheader("ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰")
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼
        summary = LogAnalyzer.get_security_summary()
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("ç·ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ", summary["login_attempts"])
        
        with col2:
            st.metric("æˆåŠŸãƒ­ã‚°ã‚¤ãƒ³", summary["successful_logins"])
        
        with col3:
            failed_logins = summary["failed_logins"]
            st.metric(
                "å¤±æ•—ãƒ­ã‚°ã‚¤ãƒ³", 
                failed_logins,
                delta=f"è­¦æˆ’ãƒ¬ãƒ™ãƒ«: {'é«˜' if failed_logins > 10 else 'ä½'}"
            )
        
        with col4:
            st.metric("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆ", summary["security_events"])
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´
        with st.expander("ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´"):
            # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
            st.info("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°å±¥æ­´æ©Ÿèƒ½ã¯å®Ÿè£…äºˆå®šã§ã™")
    
    @staticmethod
    def show_performance_dashboard():
        """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º"""
        st.subheader("âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰")
        
        # ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
        metrics = PerformanceMonitor.get_system_metrics()
        
        if metrics:
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric("CPUä½¿ç”¨ç‡", f"{metrics.get('cpu_percent', 0):.1f}%")
            
            with col2:
                st.metric("ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡", f"{metrics.get('memory_percent', 0):.1f}%")
            
            with col3:
                st.metric("ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡", f"{metrics.get('disk_percent', 0):.1f}%")
        
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼
        perf_summary = LogAnalyzer.get_performance_summary()
        
        with st.expander("ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©³ç´°"):
            col1, col2 = st.columns(2)
            
            with col1:
                st.metric("å¹³å‡å¿œç­”æ™‚é–“", f"{perf_summary['avg_response_time']:.2f}ç§’")
                st.metric("é…ã„ã‚¯ã‚¨ãƒª", perf_summary['slow_queries'])
            
            with col2:
                st.metric("ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°", perf_summary['total_requests'])
                st.metric("ã‚¨ãƒ©ãƒ¼ç‡", f"{perf_summary['error_rate']:.1%}")
    
    @staticmethod
    def show_error_dashboard():
        """ã‚¨ãƒ©ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º"""
        st.subheader("ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰")
        
        error_summary = LogAnalyzer.get_error_summary()
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("ç·ã‚¨ãƒ©ãƒ¼æ•°", error_summary["total_errors"])
        
        with col2:
            critical = error_summary["critical_errors"]
            st.metric(
                "ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼", 
                critical,
                delta="ğŸš¨" if critical > 0 else "âœ…"
            )
        
        with col3:
            st.metric("è­¦å‘Šã‚¨ãƒ©ãƒ¼", error_summary["warning_errors"])
        
        with col4:
            st.metric("æƒ…å ±ã‚¨ãƒ©ãƒ¼", error_summary["info_errors"])
        
        # ã‚¨ãƒ©ãƒ¼è©³ç´°
        with st.expander("ğŸ“‹ ã‚¨ãƒ©ãƒ¼è©³ç´°"):
            st.info("ã‚¨ãƒ©ãƒ¼è©³ç´°ã®è¡¨ç¤ºæ©Ÿèƒ½ã¯å®Ÿè£…äºˆå®šã§ã™")

# ä½¿ç”¨ä¾‹ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
def log_user_action(action: str, details: Dict[str, Any] = None):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ­ã‚°"""
    user = st.session_state.get('current_user', {})
    
    app_logger.info(
        f"USER_ACTION: user_id={user.get('id')}, "
        f"username={user.get('username')}, "
        f"action={action}, "
        f"details={details or {}}"
    )

def monitor_database_operation(operation: str):
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®ç›£è¦–ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿"""
    def decorator(func):
        @wraps(func)
        @PerformanceMonitor.measure_execution_time(f"db_{operation}")
        def wrapper(*args, **kwargs):
            user = st.session_state.get('current_user', {})
            
            try:
                result = func(*args, **kwargs)
                
                # æˆåŠŸã‚’ãƒ­ã‚°
                SecurityMonitor.track_data_access(
                    operation=operation,
                    table_name="users",  # å®Ÿéš›ã®ãƒ†ãƒ¼ãƒ–ãƒ«åã«ç½®ãæ›ãˆ
                    user_id=user.get('id')
                )
                
                return result
            
            except Exception as e:
                # ã‚¨ãƒ©ãƒ¼ã‚’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
                ErrorTracker.track_error(
                    error=e,
                    context=f"Database operation: {operation}",
                    user_id=user.get('id')
                )
                raise
        
        return wrapper
    return decorator</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>åŒ…æ‹¬çš„ãªãƒ­ã‚°æ©Ÿèƒ½ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æƒ…å ±ãŒé©åˆ‡ã«è¿½è·¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³5: æœ¬ç•ªç’°å¢ƒè¨­å®š -->
                    <h3 class="section-title">6.5 æœ¬ç•ªç’°å¢ƒPostgreSQLè¨­å®š</h3>
                    
                    <p>æœ¬ç•ªç’°å¢ƒã§ã® PostgreSQL ã®æœ€é©åŒ–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 6-4: æœ¬ç•ªç’°å¢ƒPostgreSQLè¨­å®š</h5>
                        <p>æœ¬ç•ªç’°å¢ƒå‘ã‘ã®PostgreSQLè¨­å®šã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>æœ¬ç•ªç”¨Docker Composeè¨­å®š</li>
                            <li>PostgreSQLè¨­å®šã®æœ€é©åŒ–</li>
                            <li>SSL/TLSè¨­å®š</li>
                            <li>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªã‚¹ãƒˆã‚¢</li>
                            <li>æ¥ç¶šãƒ—ãƒ¼ãƒ«æœ€é©åŒ–</li>
                        </ol>

                        <h6>docker-compose.prod.ymlä½œæˆ</h6>
                        <pre><code># æœ¬ç•ªç’°å¢ƒç”¨Docker Composeè¨­å®š
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: streamlit_postgres_prod
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      # ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
      - postgres_prod_data:/var/lib/postgresql/data
      # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
      - ./docker/postgres/prod/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./docker/postgres/prod/pg_hba.conf:/etc/postgresql/pg_hba.conf
      # åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
      # SSLè¨¼æ˜æ›¸ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
      - ./docker/postgres/ssl:/etc/ssl/postgres:ro
      # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
      - ./backups:/backups
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
    networks:
      - streamlit_prod_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Redis for session management (optional)
  redis:
    image: redis:7-alpine
    container_name: streamlit_redis_prod
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_prod_data:/data
      - ./docker/redis/redis.conf:/etc/redis/redis.conf
    command: redis-server /etc/redis/redis.conf
    networks:
      - streamlit_prod_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx reverse proxy (optional)
  nginx:
    image: nginx:alpine
    container_name: streamlit_nginx_prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - postgres
    networks:
      - streamlit_prod_network

volumes:
  postgres_prod_data:
    driver: local
  redis_prod_data:
    driver: local

networks:
  streamlit_prod_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16</code></pre>

                        <h6>docker/postgres/prod/postgresql.confä½œæˆ</h6>
                        <pre><code># PostgreSQL æœ¬ç•ªç’°å¢ƒè¨­å®š

# æ¥ç¶šè¨­å®š
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# ãƒ¡ãƒ¢ãƒªè¨­å®š
shared_buffers = 512MB
effective_cache_size = 2GB
maintenance_work_mem = 256MB
work_mem = 8MB

# WALè¨­å®š
wal_level = replica
max_wal_size = 2GB
min_wal_size = 256MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB

# ãƒ­ã‚°è¨­å®š
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_statement = 'mod'

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
ssl = on
ssl_cert_file = '/etc/ssl/postgres/server.crt'
ssl_key_file = '/etc/ssl/postgres/server.key'
ssl_ca_file = '/etc/ssl/postgres/ca.crt'
ssl_ciphers = 'HIGH:MEDIUM:!aNULL:!MD5:!3DES'
ssl_prefer_server_ciphers = on

# èªè¨¼è¨­å®š
password_encryption = scram-sha-256

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š
random_page_cost = 1.1
effective_io_concurrency = 200
max_worker_processes = 8
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4

# çµ±è¨ˆæƒ…å ±è¨­å®š
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
stats_temp_directory = '/var/run/postgresql/stats_temp'

# ã‚ªãƒ¼ãƒˆãƒã‚­ãƒ¥ãƒ¼ãƒ è¨­å®š
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1

# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
timezone = 'Asia/Tokyo'
log_timezone = 'Asia/Tokyo'</code></pre>

                        <h6>docker/postgres/prod/pg_hba.confä½œæˆ</h6>
                        <pre><code># PostgreSQL Host-Based Authentication æœ¬ç•ªç’°å¢ƒè¨­å®š

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" ã¯ Unix domain socket æ¥ç¶šç”¨
local   all             postgres                                peer
local   all             all                                     scram-sha-256

# IPv4 local connections:
host    all             postgres        127.0.0.1/32            scram-sha-256
host    all             all             127.0.0.1/32            scram-sha-256

# IPv6 local connections:
host    all             postgres        ::1/128                 scram-sha-256
host    all             all             ::1/128                 scram-sha-256

# æœ¬ç•ªç’°å¢ƒã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®æ¥ç¶š
host    all             app_user        172.20.0.0/16           scram-sha-256

# SSLæ¥ç¶šå¿…é ˆ
hostssl all             all             0.0.0.0/0               scram-sha-256

# ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¥ç¶šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
# host    replication     replicator      192.168.1.0/24          scram-sha-256</code></pre>

                        <h6>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (backup.sh)</h6>
                        <pre><code>#!/bin/bash
# PostgreSQL ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

# è¨­å®š
BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="${POSTGRES_DB:-userdb}"
DB_USER="${POSTGRES_USER:-postgres}"
CONTAINER_NAME="streamlit_postgres_prod"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p ${BACKUP_DIR}

echo "Starting backup at $(date)"

# SQLãƒ€ãƒ³ãƒ—ã®ä½œæˆ
docker exec ${CONTAINER_NAME} pg_dump \
    -U ${DB_USER} \
    -d ${DB_NAME} \
    --verbose \
    --clean \
    --no-owner \
    --no-privileges \
    --format=custom \
    > ${BACKUP_DIR}/backup_${DB_NAME}_${DATE}.dump

# åœ§ç¸®
gzip ${BACKUP_DIR}/backup_${DB_NAME}_${DATE}.dump

echo "Backup completed: backup_${DB_NAME}_${DATE}.dump.gz"

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤ï¼ˆ7æ—¥ä»¥ä¸Šå‰ï¼‰
find ${BACKUP_DIR} -name "backup_*.dump.gz" -mtime +7 -delete

echo "Old backups cleaned up"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼
gunzip -c ${BACKUP_DIR}/backup_${DB_NAME}_${DATE}.dump.gz | head -n 20

echo "Backup verification completed"</code></pre>

                        <h6>ãƒªã‚¹ãƒˆã‚¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (restore.sh)</h6>
                        <pre><code>#!/bin/bash
# PostgreSQL ãƒªã‚¹ãƒˆã‚¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

if [ $# -ne 1 ]; then
    echo "Usage: $0 <backup_file>"
    echo "Example: $0 backup_userdb_20231201_120000.dump.gz"
    exit 1
fi

BACKUP_FILE=$1
DB_NAME="${POSTGRES_DB:-userdb}"
DB_USER="${POSTGRES_USER:-postgres}"
CONTAINER_NAME="streamlit_postgres_prod"

if [ ! -f "/backups/${BACKUP_FILE}" ]; then
    echo "Backup file not found: /backups/${BACKUP_FILE}"
    exit 1
fi

echo "Starting restore from ${BACKUP_FILE} at $(date)"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹
if [[ ${BACKUP_FILE} == *.gz ]]; then
    gunzip -c /backups/${BACKUP_FILE} > /tmp/restore.dump
    DUMP_FILE="/tmp/restore.dump"
else
    DUMP_FILE="/backups/${BACKUP_FILE}"
fi

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚¹ãƒˆã‚¢
docker exec -i ${CONTAINER_NAME} pg_restore \
    -U ${DB_USER} \
    -d ${DB_NAME} \
    --verbose \
    --clean \
    --no-owner \
    --no-privileges \
    < ${DUMP_FILE}

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
if [ -f "/tmp/restore.dump" ]; then
    rm /tmp/restore.dump
fi

echo "Restore completed at $(date)"</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>æœ¬ç•ªç’°å¢ƒå‘ã‘ã®PostgreSQLè¨­å®šãŒå®Œäº†ã—ã€SSLæ¥ç¶šã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢æ©Ÿèƒ½ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãŒå®Ÿè£…ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³6: ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ -->
                    <h3 class="section-title">6.6 ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</h3>
                    
                    <p>æœ¬ç•ªç’°å¢ƒã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å‘ã‘ãŸæœ€çµ‚çš„ãªæº–å‚™ã¨è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 6-5: ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯</h5>
                        <p>æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯ã¨è¨­å®šã‚’å®Ÿæ–½ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ä½œæˆ</li>
                            <li>ç’°å¢ƒè¨­å®šã®æ¤œè¨¼</li>
                            <li>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</li>
                            <li>ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½</li>
                            <li>ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ</li>
                        </ol>

                        <h6>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h6>
                        <div class="security-checklist">
                            <h6>ğŸ”’ æœ¬ç•ªç’°å¢ƒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h6>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check1">
                                <label for="check1">ç’°å¢ƒå¤‰æ•°ã§ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check2">
                                <label for="check2">PostgreSQL SSL/TLS æœ‰åŠ¹åŒ–</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check3">
                                <label for="check3">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check4">
                                <label for="check4">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®ç„¡åŠ¹åŒ–</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check5">
                                <label for="check5">ãƒ­ã‚°è¨­å®šã®é©åˆ‡ãªæ§‹æˆ</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check6">
                                <label for="check6">ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®æœ‰åŠ¹åŒ–</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check7">
                                <label for="check7">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check8">
                                <label for="check8">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã®ç¢ºèª</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check9">
                                <label for="check9">ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check10">
                                <label for="check10">ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ¤œè¨¼</label>
                            </div>
                        </div>

                        <h6>app/utils/health_check.pyä½œæˆ</h6>
                        <pre><code>"""
ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
"""

import streamlit as st
from typing import Dict, Any, List
from datetime import datetime
import time
import psutil

from app.database.connection import db_manager
from app.config import settings
from app.utils.monitoring import PerformanceMonitor

class HealthChecker:
    """ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def run_all_checks() -> Dict[str, Any]:
        """å…¨ã¦ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ"""
        checks = {
            "database": HealthChecker.check_database(),
            "configuration": HealthChecker.check_configuration(),
            "system_resources": HealthChecker.check_system_resources(),
            "security": HealthChecker.check_security_settings(),
            "performance": HealthChecker.check_performance()
        }
        
        # å…¨ä½“çš„ãªå¥å…¨æ€§åˆ¤å®š
        overall_status = "healthy"
        critical_issues = []
        
        for check_name, check_result in checks.items():
            if check_result["status"] == "critical":
                overall_status = "critical"
                critical_issues.append(check_name)
            elif check_result["status"] == "warning" and overall_status == "healthy":
                overall_status = "warning"
        
        return {
            "overall_status": overall_status,
            "timestamp": datetime.utcnow().isoformat(),
            "critical_issues": critical_issues,
            "checks": checks
        }
    
    @staticmethod
    def check_database() -> Dict[str, Any]:
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒã‚§ãƒƒã‚¯"""
        try:
            start_time = time.time()
            
            # æ¥ç¶šãƒ†ã‚¹ãƒˆ
            connection_ok = db_manager.test_connection()
            connection_time = time.time() - start_time
            
            if not connection_ok:
                return {
                    "status": "critical",
                    "message": "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå¤±æ•—",
                    "details": {"connection_time": connection_time}
                }
            
            # æ¥ç¶šæ™‚é–“ãƒã‚§ãƒƒã‚¯
            if connection_time > 5.0:
                status = "warning"
                message = f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒé…ã„ ({connection_time:.2f}ç§’)"
            else:
                status = "healthy"
                message = "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ­£å¸¸"
            
            return {
                "status": status,
                "message": message,
                "details": {
                    "connection_time": connection_time,
                    "database_url_masked": settings.database.POSTGRES_HOST
                }
            }
            
        except Exception as e:
            return {
                "status": "critical",
                "message": f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {e}",
                "details": {"error": str(e)}
            }
    
    @staticmethod
    def check_configuration() -> Dict[str, Any]:
        """è¨­å®šãƒã‚§ãƒƒã‚¯"""
        issues = []
        warnings = []
        
        # æœ¬ç•ªç’°å¢ƒãƒã‚§ãƒƒã‚¯
        if settings.ENVIRONMENT == "production":
            if settings.DEBUG:
                issues.append("æœ¬ç•ªç’°å¢ƒã§DEBUGãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹")
            
            if settings.security.SECRET_KEY == "your-secret-key-here":
                issues.append("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®SECRET_KEYãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹")
            
            if settings.database.POSTGRES_PASSWORD == "password":
                issues.append("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")
            
            if not settings.security.RATE_LIMIT_ENABLED:
                warnings.append("ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒç„¡åŠ¹")
        
        # SSLè¨­å®šãƒã‚§ãƒƒã‚¯
        if settings.database.POSTGRES_SSL_MODE == "disable":
            warnings.append("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹SSLãŒç„¡åŠ¹")
        
        if issues:
            return {
                "status": "critical",
                "message": f"{len(issues)}å€‹ã®é‡è¦ãªè¨­å®šå•é¡Œ",
                "details": {"issues": issues, "warnings": warnings}
            }
        elif warnings:
            return {
                "status": "warning",
                "message": f"{len(warnings)}å€‹ã®è¨­å®šè­¦å‘Š",
                "details": {"warnings": warnings}
            }
        else:
            return {
                "status": "healthy",
                "message": "è¨­å®šæ­£å¸¸",
                "details": {"environment": settings.ENVIRONMENT}
            }
    
    @staticmethod
    def check_system_resources() -> Dict[str, Any]:
        """ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯"""
        try:
            metrics = PerformanceMonitor.get_system_metrics()
            
            if not metrics:
                return {
                    "status": "warning",
                    "message": "ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—å¤±æ•—",
                    "details": {}
                }
            
            issues = []
            warnings = []
            
            # CPUä½¿ç”¨ç‡ãƒã‚§ãƒƒã‚¯
            cpu_percent = metrics.get("cpu_percent", 0)
            if cpu_percent > 90:
                issues.append(f"CPUä½¿ç”¨ç‡ãŒé«˜ã„ ({cpu_percent}%)")
            elif cpu_percent > 70:
                warnings.append(f"CPUä½¿ç”¨ç‡ãŒé«˜ã‚ ({cpu_percent}%)")
            
            # ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãƒã‚§ãƒƒã‚¯
            memory_percent = metrics.get("memory_percent", 0)
            if memory_percent > 90:
                issues.append(f"ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒé«˜ã„ ({memory_percent}%)")
            elif memory_percent > 80:
                warnings.append(f"ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒé«˜ã‚ ({memory_percent}%)")
            
            # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãƒã‚§ãƒƒã‚¯
            disk_percent = metrics.get("disk_percent", 0)
            if disk_percent > 95:
                issues.append(f"ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³ ({disk_percent}%)")
            elif disk_percent > 85:
                warnings.append(f"ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡å°‘ãªã‚ ({disk_percent}%)")
            
            if issues:
                status = "critical"
                message = f"{len(issues)}å€‹ã®ãƒªã‚½ãƒ¼ã‚¹å•é¡Œ"
            elif warnings:
                status = "warning"
                message = f"{len(warnings)}å€‹ã®ãƒªã‚½ãƒ¼ã‚¹è­¦å‘Š"
            else:
                status = "healthy"
                message = "ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹æ­£å¸¸"
            
            return {
                "status": status,
                "message": message,
                "details": {
                    "metrics": metrics,
                    "issues": issues,
                    "warnings": warnings
                }
            }
            
        except Exception as e:
            return {
                "status": "warning",
                "message": f"ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {e}",
                "details": {"error": str(e)}
            }
    
    @staticmethod
    def check_security_settings() -> Dict[str, Any]:
        """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒã‚§ãƒƒã‚¯"""
        issues = []
        warnings = []
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
        if not settings.security.SECURITY_HEADERS:
            warnings.append("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„")
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šãƒã‚§ãƒƒã‚¯
        if settings.security.SESSION_TIMEOUT > 24 * 3600:  # 24æ™‚é–“
            warnings.append("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒé•·ã„")
        
        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šãƒã‚§ãƒƒã‚¯
        if settings.security.PASSWORD_MIN_LENGTH < 8:
            issues.append("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœ€å°é•·ãŒçŸ­ã„")
        
        # ãƒ­ã‚°è¨­å®šãƒã‚§ãƒƒã‚¯
        if not settings.logging.SECURITY_LOG_ENABLED:
            warnings.append("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ãŒç„¡åŠ¹")
        
        if issues:
            return {
                "status": "critical",
                "message": f"{len(issues)}å€‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ",
                "details": {"issues": issues, "warnings": warnings}
            }
        elif warnings:
            return {
                "status": "warning",
                "message": f"{len(warnings)}å€‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š",
                "details": {"warnings": warnings}
            }
        else:
            return {
                "status": "healthy",
                "message": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šæ­£å¸¸",
                "details": {}
            }
    
    @staticmethod
    def check_performance() -> Dict[str, Any]:
        """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯"""
        try:
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—ï¼ˆå®Ÿè£…ãŒå¿…è¦ï¼‰
            # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—
            
            warnings = []
            
            # ä»®ã®ãƒã‚§ãƒƒã‚¯é …ç›®
            if settings.database.CONNECTION_POOL_SIZE < 10:
                warnings.append("æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ã„")
            
            if warnings:
                return {
                    "status": "warning",
                    "message": f"{len(warnings)}å€‹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è­¦å‘Š",
                    "details": {"warnings": warnings}
                }
            else:
                return {
                    "status": "healthy",
                    "message": "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®šæ­£å¸¸",
                    "details": {}
                }
                
        except Exception as e:
            return {
                "status": "warning",
                "message": f"ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {e}",
                "details": {"error": str(e)}
            }

def show_health_dashboard():
    """ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º"""
    st.subheader("ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯")
    
    if st.button("ğŸ”„ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ", type="primary"):
        with st.spinner("ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."):
            health_status = HealthChecker.run_all_checks()
        
        # å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        if health_status["overall_status"] == "healthy":
            st.success("âœ… ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ãŒæ­£å¸¸ã§ã™")
        elif health_status["overall_status"] == "warning":
            st.warning("âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ã«è­¦å‘ŠãŒã‚ã‚Šã¾ã™")
        else:
            st.error("ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ ã«é‡è¦ãªå•é¡ŒãŒã‚ã‚Šã¾ã™")
        
        # è©³ç´°ãƒã‚§ãƒƒã‚¯çµæœ
        for check_name, result in health_status["checks"].items():
            with st.expander(f"{check_name.title()} ãƒã‚§ãƒƒã‚¯"):
                if result["status"] == "healthy":
                    st.success(f"âœ… {result['message']}")
                elif result["status"] == "warning":
                    st.warning(f"âš ï¸ {result['message']}")
                else:
                    st.error(f"ğŸš¨ {result['message']}")
                
                if result.get("details"):
                    st.json(result["details"])</code></pre>

                        <h6>ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (deploy.sh)</h6>
                        <pre><code>#!/bin/bash
# æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

echo "ğŸš€ Starting deployment process..."

# ç’°å¢ƒè¨­å®šãƒã‚§ãƒƒã‚¯
if [ ! -f ".env.production" ]; then
    echo "âŒ .env.production file not found"
    exit 1
fi

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
echo "ğŸ“¦ Creating backup..."
./backup.sh

# Gitæ›´æ–°
echo "ğŸ“¥ Pulling latest changes..."
git pull origin main

# Docker Composeåœæ­¢
echo "ğŸ›‘ Stopping current services..."
docker-compose -f docker-compose.prod.yml down

# ã‚¤ãƒ¡ãƒ¼ã‚¸æ›´æ–°
echo "ğŸ³ Updating Docker images..."
docker-compose -f docker-compose.prod.yml pull

# æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
echo "ğŸ¯ Starting services..."
docker-compose -f docker-compose.prod.yml up -d

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "ğŸ¥ Running health checks..."
sleep 30

# ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
docker-compose -f docker-compose.prod.yml ps

echo "âœ… Deployment completed successfully!"

# ãƒ­ã‚°ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
echo "ğŸ“‹ Recent logs:"
docker-compose -f docker-compose.prod.yml logs --tail=20</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ãŒå®Œäº†ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã€è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º -->
                    <div class="quiz-container">
                        <h5>ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º</h5>
                        <ol>
                            <li><strong>Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</strong>ã®ä¸»è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨ã‚’5ã¤æŒ™ã’ã€ãã‚Œãã‚Œã®å¯¾ç­–ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ç’°å¢ƒå¤‰æ•°ç®¡ç†</strong>ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã‚’å®‰å…¨ã«æ‰±ã†æ–¹æ³•ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒ</strong>ã‚’ORMã§é˜²ãä»•çµ„ã¿ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>æœ¬ç•ªç’°å¢ƒã§ã®ãƒ­ã‚°ç®¡ç†</strong>ã§é‡è¦ãªè¦ç´ ã‚’4ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>PostgreSQL</strong>ã®SSL/TLSè¨­å®šãŒé‡è¦ãªç†ç”±ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</strong>ã§ç›£è¦–ã™ã¹ããƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’5ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</strong>ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½</strong>ãŒæœ¬ç•ªç’°å¢ƒã§é‡è¦ãªç†ç”±ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                        </ol>
                        
                        <details>
                            <summary>è§£ç­”ä¾‹</summary>
                            <ol>
                                <li>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆORMä½¿ç”¨ï¼‰ã€XSSï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰ã€CSRFï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã€èªè¨¼ãƒ»èªå¯ï¼ˆé©åˆ‡ãªè¨­è¨ˆï¼‰ã€æ©Ÿå¯†æƒ…å ±æ¼æ´©ï¼ˆç’°å¢ƒå¤‰æ•°ç®¡ç†ï¼‰</li>
                                <li>ç’°å¢ƒå¤‰æ•°ã§ã®ç®¡ç†ã€æš—å·åŒ–ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆAWS Secrets Managerç­‰ï¼‰ã®åˆ©ç”¨</li>
                                <li>ORMã¯SQLã‚¯ã‚¨ãƒªã‚’è‡ªå‹•ç”Ÿæˆã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒç›´æ¥SQLæ–‡ã«æŒ¿å…¥ã•ã‚Œã‚‹ã“ã¨ã‚’é˜²ã</li>
                                <li>ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®é©åˆ‡ãªè¨­å®šã€æ©Ÿå¯†æƒ…å ±ã®é™¤å¤–ã€ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã€é›†ç´„ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</li>
                                <li>ãƒ‡ãƒ¼ã‚¿é€šä¿¡ã®æš—å·åŒ–ã€ä¸­é–“è€…æ”»æ’ƒã®é˜²æ­¢ã€èªè¨¼æƒ…å ±ã®ä¿è­·ã€ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¦ä»¶ã¸ã®å¯¾å¿œ</li>
                                <li>CPUä½¿ç”¨ç‡ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã€ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ã€å¿œç­”æ™‚é–“ã€ã‚¨ãƒ©ãƒ¼ç‡ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ•°</li>
                                <li>å®šæœŸçš„ãªè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€è¤‡æ•°ä¸–ä»£ã®ä¿æŒã€ãƒªã‚¹ãƒˆã‚¢ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½ã€ã‚ªãƒ•ã‚µã‚¤ãƒˆä¿å­˜</li>
                                <li>ã‚·ã‚¹ãƒ†ãƒ éšœå®³ã®æ—©æœŸç™ºè¦‹ã€è‡ªå‹•å¾©æ—§ã®å®Ÿç¾ã€ã‚µãƒ¼ãƒ“ã‚¹å“è³ªã®ç¶­æŒã€ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œã®è¿…é€ŸåŒ–</li>
                            </ol>
                        </details>
                    </div>

                    <!-- ã¾ã¨ã‚ -->
                    <h3 class="section-title">6.7 Step 6ã®ã¾ã¨ã‚</h3>
                    
                    <div class="success">
                        <h5>ğŸ‰ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ï¼</h5>
                        <p>Streamlit + SQLModelã‚’ä½¿ç”¨ã—ãŸãƒ¢ãƒ€ãƒ³ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œæˆã—ã¾ã—ãŸï¼</p>
                    </div>

                    <div class="highlight">
                        <h5>Step 6ã§ç¿’å¾—ã—ãŸã‚¹ã‚­ãƒ«</h5>
                        <ul>
                            <li>ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹å®‰å…¨ãªè¨­å®šç®¡ç†</li>
                            <li>åŸºæœ¬èªè¨¼æ©Ÿèƒ½ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</li>
                            <li>åŒ…æ‹¬çš„ãªãƒ­ã‚°æ©Ÿèƒ½ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</li>
                            <li>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–</li>
                            <li>æœ¬ç•ªç’°å¢ƒPostgreSQLè¨­å®šã¨æœ€é©åŒ–</li>
                            <li>SSL/TLSè¨­å®šã¨ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–</li>
                            <li>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢æ©Ÿèƒ½</li>
                            <li>ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–</li>
                            <li>æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>æœ¬ç•ªç’°å¢ƒé‹ç”¨å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯</h6>
                        <ul>
                            <li>âœ… å…¨ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãŒé©åˆ‡ã«æ§‹æˆã•ã‚Œã¦ã„ã‚‹</li>
                            <li>âœ… SSL/TLSè¨¼æ˜æ›¸ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹</li>
                            <li>âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå…¨ã¦å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹</li>
                            <li>âœ… ãƒ­ã‚°æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹</li>
                            <li>âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ãŒå‹•ä½œç¢ºèªæ¸ˆã¿</li>
                            <li>âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹</li>
                            <li>âœ… ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ä½“åˆ¶ãŒæ•´ã£ã¦ã„ã‚‹</li>
                            <li>âœ… ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †ãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹</li>
                        </ul>
                    </div>

                    <div class="info">
                        <h6>ã•ã‚‰ãªã‚‹ç™ºå±•å­¦ç¿’</h6>
                        <ul>
                            <li><strong>ã‚³ãƒ³ãƒ†ãƒŠã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</strong>: Kubernetesã€Docker Swarm</li>
                            <li><strong>CI/CD</strong>: GitHub Actionsã€GitLab CI/CD</li>
                            <li><strong>ã‚¯ãƒ©ã‚¦ãƒ‰å±•é–‹</strong>: AWSã€GCPã€Azureã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤</li>
                            <li><strong>ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹</strong>: FastAPI + Streamlitæ§‹æˆ</li>
                            <li><strong>é«˜å¯ç”¨æ€§</strong>: ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã€ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</li>
                            <li><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–</strong>: OAuth2ã€JWTã€WAF</li>
                            <li><strong>ç›£è¦–ãƒ»åˆ†æ</strong>: Prometheusã€Grafanaã€ELK Stack</li>
                        </ul>
                    </div>

                    <!-- æœ€çµ‚çš„ãªæˆæœç‰© -->
                    <h3 class="section-title">6.8 å®Œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç‰¹å¾´</h3>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>ã‚«ãƒ†ã‚´ãƒª</th>
                                    <th>å®Ÿè£…æ©Ÿèƒ½</th>
                                    <th>æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯</th>
                                    <th>å“è³ªãƒ¬ãƒ™ãƒ«</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</strong></td>
                                    <td>ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–UIã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</td>
                                    <td>Streamlitã€Bootstrap</td>
                                    <td>ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å“è³ª</td>
                                </tr>
                                <tr>
                                    <td><strong>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</strong></td>
                                    <td>å‹å®‰å…¨ãªAPIã€å®Œå…¨CRUD</td>
                                    <td>SQLModelã€Pydantic</td>
                                    <td>ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå“è³ª</td>
                                </tr>
                                <tr>
                                    <td><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</strong></td>
                                    <td>æ­£è¦åŒ–è¨­è¨ˆã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–</td>
                                    <td>PostgreSQL 15</td>
                                    <td>æœ¬ç•ªç’°å¢ƒå¯¾å¿œ</td>
                                </tr>
                                <tr>
                                    <td><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong></td>
                                    <td>èªè¨¼ã€æš—å·åŒ–ã€ç›£æŸ»ãƒ­ã‚°</td>
                                    <td>SSL/TLSã€scram-sha-256</td>
                                    <td>ã‚»ã‚­ãƒ¥ã‚¢è¨­è¨ˆ</td>
                                </tr>
                                <tr>
                                    <td><strong>é‹ç”¨</strong></td>
                                    <td>ç›£è¦–ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</td>
                                    <td>Dockerã€ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</td>
                                    <td>é‹ç”¨ä¿å®ˆå¯¾å¿œ</td>
                                </tr>
                                <tr>
                                    <td><strong>é–‹ç™ºä½“é¨“</strong></td>
                                    <td>å‹ãƒ’ãƒ³ãƒˆã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</td>
                                    <td>Python 3.11+ã€ç¾ä»£çš„é–‹ç™ºæ‰‹æ³•</td>
                                    <td>é–‹ç™ºè€…ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ç« é–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step5-user-crud-operations.html" class="btn btn-secondary">â† Step 5: CRUDæ“ä½œ</a>
                        <a href="../streamlit-sqlmodel/README.html" class="btn btn-success">ğŸ‰ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ï¼</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js åˆæœŸåŒ– -->
    <script>hljs.highlightAll();</script>
</body>
</html>