<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« Step 2 - SQLModelã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .navbar {
            background-color: #0066cc;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ« */
        .chapter-title {
            color: #0066cc;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #3399ff;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒœãƒƒã‚¯ã‚¹ */
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0066cc;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav-link.active {
            background-color: #0066cc !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e6f2ff;
        }

        /* ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }

        .img-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ãƒ›ãƒ¼ãƒ </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="../streamlit-sqlmodel/README.html">Streamlit + SQLModel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                        Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: ç’°å¢ƒæ§‹ç¯‰</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#step2">Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">Step 5: CRUDæ“ä½œ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-security-deployment.html">Step 6: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- ç« ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 2: SQLModelã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="badge bg-info">æ‰€è¦æ™‚é–“: 2.5æ™‚é–“</span>
                        </div>
                    </div>
                </div>

                <div id="step2">
                    <!-- ç« ã‚¿ã‚¤ãƒˆãƒ« -->
                    <h2 class="chapter-title">å‹å®‰å…¨ãªORMè¨­è¨ˆã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ</h2>
                    
                    <!-- å­¦ç¿’ç›®æ¨™ -->
                    <div class="highlight">
                        <h5>ã“ã®ç« ã§å­¦ã¶ã“ã¨</h5>
                        <ul>
                            <li>SQLModelã®åŸºæœ¬æ¦‚å¿µã¨Pydanticã¨ã®é–¢ä¿‚</li>
                            <li>å‹ãƒ’ãƒ³ãƒˆã‚’æ´»ç”¨ã—ãŸUserãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã®è¨­è¨ˆ</li>
                            <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®è¨­å®šã¨ç®¡ç†</li>
                            <li>ãƒ†ãƒ¼ãƒ–ãƒ«è‡ªå‹•ä½œæˆã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</li>
                            <li>åŸºæœ¬CRUDæ“ä½œã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³</li>
                            <li>SQLAlchemyã‚¨ãƒ³ã‚¸ãƒ³ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</li>
                        </ul>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: SQLModelæ¦‚è¦ -->
                    <h3 class="section-title">2.1 SQLModelã¨ã¯</h3>
                    <p>SQLModelã¯ã€FastAPIã®ä½œè€…ãŒé–‹ç™ºã—ãŸç¾ä»£çš„ãªPython ORMï¼ˆObject-Relational Mappingï¼‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚SQLAlchemyã¨Pydanticã®å„ªã‚ŒãŸæ©Ÿèƒ½ã‚’çµ±åˆã—ã€å‹å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚’å®Ÿç¾ã—ã¾ã™ã€‚</p>

                    <div class="info">
                        <h6>SQLModelã®ç‰¹å¾´</h6>
                        <ul>
                            <li><strong>å‹å®‰å…¨æ€§</strong>: Python 3.6+ã®å‹ãƒ’ãƒ³ãƒˆã‚’ãƒ•ãƒ«æ´»ç”¨</li>
                            <li><strong>è‡ªå‹•ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</strong>: Pydanticã«ã‚ˆã‚‹å…¥åŠ›æ¤œè¨¼</li>
                            <li><strong>ã‚¨ãƒ‡ã‚£ã‚¿ã‚µãƒãƒ¼ãƒˆ</strong>: IDE/ã‚¨ãƒ‡ã‚£ã‚¿ã§ã®å„ªã‚ŒãŸè£œå®Œã¨ã‚¨ãƒ©ãƒ¼æ¤œå‡º</li>
                            <li><strong>ã‚·ãƒ³ãƒ—ãƒ«ãª API</strong>: å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ãã€ç›´æ„Ÿçš„ãªä½¿ç”¨æ–¹æ³•</li>
                            <li><strong>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</strong>: SQLAlchemyãƒ™ãƒ¼ã‚¹ã®é«˜æ€§èƒ½ãªã‚¯ã‚¨ãƒª</li>
                        </ul>
                    </div>

                    <h4>å¾“æ¥ã®ORMã¨ã®æ¯”è¼ƒ</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>æ©Ÿèƒ½</th>
                                    <th>SQLModel</th>
                                    <th>SQLAlchemy Core</th>
                                    <th>Django ORM</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>å‹ãƒ’ãƒ³ãƒˆ</td>
                                    <td>âœ… ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚µãƒãƒ¼ãƒˆ</td>
                                    <td>âš ï¸ é™å®šçš„</td>
                                    <td>âŒ éå¯¾å¿œ</td>
                                </tr>
                                <tr>
                                    <td>è‡ªå‹•ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</td>
                                    <td>âœ… Pydanticçµ±åˆ</td>
                                    <td>âŒ æ‰‹å‹•å®Ÿè£…</td>
                                    <td>âœ… Form/Serializer</td>
                                </tr>
                                <tr>
                                    <td>ã‚¨ãƒ‡ã‚£ã‚¿ã‚µãƒãƒ¼ãƒˆ</td>
                                    <td>âœ… å„ªç§€</td>
                                    <td>âš ï¸ åŸºæœ¬çš„</td>
                                    <td>âš ï¸ åŸºæœ¬çš„</td>
                                </tr>
                                <tr>
                                    <td>å­¦ç¿’ã‚³ã‚¹ãƒˆ</td>
                                    <td>âœ… ä½ã„</td>
                                    <td>âš ï¸ ä¸­ç¨‹åº¦</td>
                                    <td>âš ï¸ ä¸­ç¨‹åº¦</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®š -->
                    <h3 class="section-title">2.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®è¨­å®š</h3>
                    
                    <p>SQLModelã‚’ä½¿ç”¨ã—ã¦PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®è¨­å®šã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 2-1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ</h5>
                        <p>SQLModelã‚¨ãƒ³ã‚¸ãƒ³ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’è¡Œã†connection.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>app/database/connection.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ</li>
                            <li>SQLAlchemyã‚¨ãƒ³ã‚¸ãƒ³ã®è¨­å®š</li>
                            <li>ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®å®Ÿè£…</li>
                            <li>æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®è¨­å®š</li>
                            <li>æ¥ç¶šãƒ†ã‚¹ãƒˆé–¢æ•°ã®å®Ÿè£…</li>
                        </ol>

                        <h6>app/database/connection.pyä½œæˆ</h6>
                        <pre><code>"""
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
SQLModelã‚¨ãƒ³ã‚¸ãƒ³ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’è¡Œã„ã¾ã™ã€‚
"""

from typing import Generator
from sqlmodel import SQLModel, Session, create_engine
from sqlalchemy.pool import StaticPool
import logging
from app.config import settings

# ãƒ­ã‚°è¨­å®š
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class DatabaseManager:
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self._engine = None
        self._initialize_engine()
    
    def _initialize_engine(self) -> None:
        """SQLAlchemyã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–"""
        try:
            # PostgreSQLæ¥ç¶šç”¨ã‚¨ãƒ³ã‚¸ãƒ³ä½œæˆ
            self._engine = create_engine(
                settings.database_url,
                # æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®š
                pool_size=20,           # åŸºæœ¬æ¥ç¶šæ•°
                max_overflow=30,        # æœ€å¤§è¿½åŠ æ¥ç¶šæ•°
                pool_pre_ping=True,     # æ¥ç¶šã®äº‹å‰ç¢ºèª
                pool_recycle=3600,      # æ¥ç¶šã®å†åˆ©ç”¨æ™‚é–“ï¼ˆç§’ï¼‰
                
                # PostgreSQLæœ€é©åŒ–è¨­å®š
                connect_args={
                    "options": "-c timezone=Asia/Tokyo"
                },
                
                # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆæœ¬ç•ªã§ã¯ç„¡åŠ¹åŒ–ï¼‰
                echo=settings.DEBUG
            )
            
            logger.info("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ")
            
        except Exception as e:
            logger.error(f"âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    @property
    def engine(self):
        """SQLAlchemyã‚¨ãƒ³ã‚¸ãƒ³ã‚’å–å¾—"""
        if self._engine is None:
            self._initialize_engine()
        return self._engine
    
    def create_tables(self) -> None:
        """ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ"""
        try:
            SQLModel.metadata.create_all(self.engine)
            logger.info("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ")
        except Exception as e:
            logger.error(f"âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    def get_session(self) -> Generator[Session, None, None]:
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ï¼‰"""
        with Session(self.engine) as session:
            try:
                yield session
            except Exception as e:
                session.rollback()
                logger.error(f"âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: {e}")
                raise
            finally:
                session.close()
    
    def test_connection(self) -> bool:
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ"""
        try:
            with Session(self.engine) as session:
                # ç°¡å˜ãªã‚¯ã‚¨ãƒªã§æ¥ç¶šç¢ºèª
                result = session.exec("SELECT 1").first()
                if result:
                    logger.info("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ")
                    return True
                else:
                    logger.warning("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœãŒä¸æ­£ã§ã™")
                    return False
                    
        except Exception as e:
            logger.error(f"âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def close(self) -> None:
        """ã‚¨ãƒ³ã‚¸ãƒ³ã‚’é–‰ã˜ã‚‹"""
        if self._engine:
            self._engine.dispose()
            logger.info("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³ã‚’é–‰ã˜ã¾ã—ãŸ")

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
db_manager = DatabaseManager()

# ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—é–¢æ•°ï¼ˆä¾å­˜æ€§æ³¨å…¥ç”¨ï¼‰
def get_db_session() -> Generator[Session, None, None]:
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°"""
    yield from db_manager.get_session()

# ã‚¨ãƒ³ã‚¸ãƒ³å–å¾—é–¢æ•°
def get_engine():
    """ã‚¨ãƒ³ã‚¸ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°"""
    return db_manager.engine

# åˆæœŸåŒ–é–¢æ•°
def init_database() -> None:
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–"""
    logger.info("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–é–‹å§‹...")
    
    # æ¥ç¶šãƒ†ã‚¹ãƒˆ
    if not db_manager.test_connection():
        raise ConnectionError("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“")
    
    # ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    db_manager.create_tables()
    
    logger.info("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å®Œäº†")

if __name__ == "__main__":
    # å˜ä½“ãƒ†ã‚¹ãƒˆç”¨
    print("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...")
    
    # æ¥ç¶šãƒ†ã‚¹ãƒˆ
    if db_manager.test_connection():
        print("âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ")
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ†ã‚¹ãƒˆ
        try:
            db_manager.create_tables()
            print("âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ†ã‚¹ãƒˆæˆåŠŸ")
        except Exception as e:
            print(f"âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    else:
        print("âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—")</code></pre>

                        <h6>æ¥ç¶šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ</h6>
                        <pre><code># PostgreSQLã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
docker-compose ps

# æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cd app/database
python connection.py

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...
# âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ
# âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ
# âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ
# âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ
# âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ†ã‚¹ãƒˆæˆåŠŸ</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒæˆåŠŸã—ã€ã‚¨ãƒ©ãƒ¼ãªãæ¥ç¶šãƒ—ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: Userãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ -->
                    <h3 class="section-title">2.3 Userãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã®è¨­è¨ˆ</h3>
                    
                    <p>SQLModelã‚’ä½¿ç”¨ã—ã¦ã€å‹å®‰å…¨ãªUserãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã‚’è¨­è¨ˆã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 2-2: Userãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…</h5>
                        <p>å‹ãƒ’ãƒ³ãƒˆã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã—ãŸUserãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>app/models/user.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ</li>
                            <li>åŸºæœ¬Userãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã®å®šç¾©</li>
                            <li>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¶ç´„ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š</li>
                            <li>ä½œæˆãƒ»æ›´æ–°ç”¨ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©</li>
                            <li>ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©</li>
                        </ol>

                        <h6>app/models/user.pyä½œæˆ</h6>
                        <pre><code>"""
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«å®šç¾©
SQLModelã‚’ä½¿ç”¨ã—ãŸå‹å®‰å…¨ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«
"""

from typing import Optional
from datetime import datetime
from sqlmodel import SQLModel, Field, Relationship
from pydantic import EmailStr, validator
import re

class UserBase(SQLModel):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ï¼ˆå…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰"""
    username: str = Field(
        min_length=3,
        max_length=50,
        regex=r"^[a-zA-Z0-9_-]+$",
        description="ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆ3-50æ–‡å­—ã€è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ï¼‰"
    )
    email: EmailStr = Field(
        description="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
    )
    full_name: str = Field(
        min_length=1,
        max_length=100,
        description="æ°åï¼ˆ1-100æ–‡å­—ï¼‰"
    )
    age: Optional[int] = Field(
        default=None,
        ge=0,
        le=150,
        description="å¹´é½¢ï¼ˆ0-150æ­³ï¼‰"
    )
    department: Optional[str] = Field(
        default=None,
        max_length=100,
        description="æ‰€å±éƒ¨ç½²ï¼ˆæœ€å¤§100æ–‡å­—ï¼‰"
    )
    is_active: bool = Field(
        default=True,
        description="ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹"
    )

class User(UserBase, table=True):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¢ãƒ‡ãƒ«"""
    __tablename__ = "users"
    
    id: Optional[int] = Field(
        default=None, 
        primary_key=True,
        description="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆè‡ªå‹•æ¡ç•ªï¼‰"
    )
    created_at: datetime = Field(
        default_factory=datetime.utcnow,
        description="ä½œæˆæ—¥æ™‚"
    )
    updated_at: datetime = Field(
        default_factory=datetime.utcnow,
        description="æ›´æ–°æ—¥æ™‚"
    )
    
    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®šï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
    username: str = Field(
        unique=True,
        index=True,
        min_length=3,
        max_length=50,
        regex=r"^[a-zA-Z0-9_-]+$"
    )
    email: EmailStr = Field(
        unique=True,
        index=True
    )
    
    class Config:
        # JSON Schemaç”¨ã®è¨­å®š
        schema_extra = {
            "example": {
                "username": "john_doe",
                "email": "john@example.com",
                "full_name": "John Doe",
                "age": 30,
                "department": "Engineering",
                "is_active": True
            }
        }
    
    @validator('username')
    def validate_username(cls, v):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³"""
        if not re.match(r"^[a-zA-Z0-9_-]+$", v):
            raise ValueError('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™')
        
        # äºˆç´„èªãƒã‚§ãƒƒã‚¯
        reserved_words = ['admin', 'root', 'system', 'null', 'undefined']
        if v.lower() in reserved_words:
            raise ValueError(f'"{v}"ã¯äºˆç´„èªã®ãŸã‚ä½¿ç”¨ã§ãã¾ã›ã‚“')
        
        return v
    
    @validator('full_name')
    def validate_full_name(cls, v):
        """æ°åã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³"""
        if not v.strip():
            raise ValueError('æ°åã¯ç©ºç™½ã®ã¿ã«ã§ãã¾ã›ã‚“')
        return v.strip()
    
    @validator('department')
    def validate_department(cls, v):
        """éƒ¨ç½²åã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³"""
        if v is not None and not v.strip():
            return None  # ç©ºç™½ã®å ´åˆã¯Noneã«å¤‰æ›
        return v.strip() if v else None

class UserCreate(UserBase):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆç”¨ãƒ¢ãƒ‡ãƒ«"""
    pass

class UserUpdate(SQLModel):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ç”¨ãƒ¢ãƒ‡ãƒ«ï¼ˆéƒ¨åˆ†æ›´æ–°å¯¾å¿œï¼‰"""
    username: Optional[str] = Field(
        default=None,
        min_length=3,
        max_length=50,
        regex=r"^[a-zA-Z0-9_-]+$"
    )
    email: Optional[EmailStr] = None
    full_name: Optional[str] = Field(
        default=None,
        min_length=1,
        max_length=100
    )
    age: Optional[int] = Field(
        default=None,
        ge=0,
        le=150
    )
    department: Optional[str] = Field(
        default=None,
        max_length=100
    )
    is_active: Optional[bool] = None
    updated_at: datetime = Field(default_factory=datetime.utcnow)

class UserRead(UserBase):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿å–ã‚Šç”¨ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ï¼‰"""
    id: int
    created_at: datetime
    updated_at: datetime

class UserResponse(UserRead):
    """APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«"""
    class Config:
        from_attributes = True  # SQLModel -> Pydanticå¤‰æ›ã‚’æœ‰åŠ¹åŒ–

# çµ±è¨ˆæƒ…å ±ç”¨ãƒ¢ãƒ‡ãƒ«
class UserStats(SQLModel):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±ãƒ¢ãƒ‡ãƒ«"""
    total_users: int = Field(description="ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°")
    active_users: int = Field(description="ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°")
    inactive_users: int = Field(description="éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°")
    average_age: Optional[float] = Field(description="å¹³å‡å¹´é½¢")
    departments: list[str] = Field(description="éƒ¨ç½²ä¸€è¦§")

# æ¤œç´¢æ¡ä»¶ç”¨ãƒ¢ãƒ‡ãƒ«
class UserSearch(SQLModel):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢æ¡ä»¶ãƒ¢ãƒ‡ãƒ«"""
    username: Optional[str] = None
    email: Optional[str] = None
    full_name: Optional[str] = None
    department: Optional[str] = None
    is_active: Optional[bool] = None
    min_age: Optional[int] = Field(default=None, ge=0)
    max_age: Optional[int] = Field(default=None, le=150)

# å‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹
UserID = int</code></pre>

                        <h6>ãƒ¢ãƒ‡ãƒ«ã®å‹•ä½œç¢ºèª</h6>
                        <pre><code># ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆtest_models.pyï¼‰
from app.models.user import User, UserCreate, UserUpdate, UserResponse
from datetime import datetime
import json

def test_user_models():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®ãƒ†ã‚¹ãƒˆ"""
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ‡ãƒ¼ã‚¿
    user_data = {
        "username": "test_user",
        "email": "test@example.com",
        "full_name": "Test User",
        "age": 25,
        "department": "IT",
        "is_active": True
    }
    
    # UserCreateãƒ¢ãƒ‡ãƒ«ã®ãƒ†ã‚¹ãƒˆ
    print("=== UserCreate ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆ ===")
    try:
        user_create = UserCreate(**user_data)
        print(f"âœ… UserCreateä½œæˆæˆåŠŸ: {user_create}")
        print(f"JSON: {user_create.json()}")
    except Exception as e:
        print(f"âŒ UserCreateã‚¨ãƒ©ãƒ¼: {e}")
    
    # Userãƒ¢ãƒ‡ãƒ«ã®ãƒ†ã‚¹ãƒˆ
    print("\n=== User ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆ ===")
    try:
        user = User(**user_data)
        user.id = 1
        user.created_at = datetime.utcnow()
        user.updated_at = datetime.utcnow()
        print(f"âœ… Userä½œæˆæˆåŠŸ: {user}")
    except Exception as e:
        print(f"âŒ Userã‚¨ãƒ©ãƒ¼: {e}")
    
    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
    print("\n=== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ ===")
    
    # ä¸æ­£ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ†ã‚¹ãƒˆ
    try:
        invalid_user = UserCreate(
            username="admin",  # äºˆç´„èª
            email="test@example.com",
            full_name="Test User"
        )
        print(f"âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—: {invalid_user}")
    except Exception as e:
        print(f"âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ: {e}")
    
    # ä¸æ­£ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ
    try:
        invalid_email = UserCreate(
            username="test_user2",
            email="invalid-email",  # ä¸æ­£ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            full_name="Test User"
        )
        print(f"âŒ ãƒ¡ãƒ¼ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—: {invalid_email}")
    except Exception as e:
        print(f"âœ… ãƒ¡ãƒ¼ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ: {e}")

if __name__ == "__main__":
    test_user_models()</code></pre>

                        <h6>ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h6>
                        <pre><code># ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cd app/models
python test_models.py

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
# === UserCreate ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆ ===
# âœ… UserCreateä½œæˆæˆåŠŸ: username='test_user' email='test@example.com' ...
# === User ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆ ===
# âœ… Userä½œæˆæˆåŠŸ: id=1 username='test_user' ...
# === ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ ===
# âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ: "admin"ã¯äºˆç´„èªã®ãŸã‚ä½¿ç”¨ã§ãã¾ã›ã‚“
# âœ… ãƒ¡ãƒ¼ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ: value is not a valid email address</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©åˆ‡ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: CRUDæ“ä½œå®Ÿè£… -->
                    <h3 class="section-title">2.4 åŸºæœ¬CRUDæ“ä½œã®å®Ÿè£…</h3>
                    
                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã™ã‚‹åŸºæœ¬çš„ãªCRUDï¼ˆCreate, Read, Update, Deleteï¼‰æ“ä½œã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 2-3: CRUDæ“ä½œãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ</h5>
                        <p>å‹å®‰å…¨ãªCRUDæ“ä½œã‚’æä¾›ã™ã‚‹crud.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>app/database/crud.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ</li>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆCreateï¼‰æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆReadï¼‰æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ï¼ˆUpdateï¼‰æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ï¼ˆDeleteï¼‰æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>æ¤œç´¢ãƒ»çµ±è¨ˆæ©Ÿèƒ½ã®å®Ÿè£…</li>
                        </ol>

                        <h6>app/database/crud.pyä½œæˆ</h6>
                        <pre><code>"""
ãƒ¦ãƒ¼ã‚¶ãƒ¼CRUDæ“ä½œãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
å‹å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚’æä¾›ã—ã¾ã™ã€‚
"""

from typing import List, Optional
from sqlmodel import Session, select, func, and_, or_
from sqlalchemy.exc import IntegrityError
from datetime import datetime
import logging

from app.models.user import (
    User, UserCreate, UserUpdate, UserSearch, UserStats
)

logger = logging.getLogger(__name__)

class UserCRUD:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼CRUDæ“ä½œã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def create_user(session: Session, user_data: UserCreate) -> User:
        """
        æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
        
        Args:
            session: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            user_data: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ‡ãƒ¼ã‚¿
            
        Returns:
            ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
            
        Raises:
            IntegrityError: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒé‡è¤‡
            ValueError: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
        """
        try:
            # æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
            db_user = User.from_orm(user_data)
            db_user.created_at = datetime.utcnow()
            db_user.updated_at = datetime.utcnow()
            
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ 
            session.add(db_user)
            session.commit()
            session.refresh(db_user)
            
            logger.info(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæˆåŠŸ: {db_user.username} (ID: {db_user.id})")
            return db_user
            
        except IntegrityError as e:
            session.rollback()
            if "users_username_key" in str(e):
                raise ValueError(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼å '{user_data.username}' ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™")
            elif "users_email_key" in str(e):
                raise ValueError(f"ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ '{user_data.email}' ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™")
            else:
                raise ValueError(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã‚¨ãƒ©ãƒ¼: {e}")
        except Exception as e:
            session.rollback()
            logger.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    @staticmethod
    def get_user_by_id(session: Session, user_id: int) -> Optional[User]:
        """
        IDã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        
        Args:
            session: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
            
        Returns:
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯Noneï¼‰
        """
        try:
            statement = select(User).where(User.id == user_id)
            user = session.exec(statement).first()
            
            if user:
                logger.info(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸ: {user.username} (ID: {user_id})")
            else:
                logger.warning(f"âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ID {user_id}")
                
            return user
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼ (ID: {user_id}): {e}")
            raise
    
    @staticmethod
    def get_user_by_username(session: Session, username: str) -> Optional[User]:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        
        Args:
            session: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            username: ãƒ¦ãƒ¼ã‚¶ãƒ¼å
            
        Returns:
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯Noneï¼‰
        """
        try:
            statement = select(User).where(User.username == username)
            user = session.exec(statement).first()
            return user
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼ (username: {username}): {e}")
            raise
    
    @staticmethod
    def get_user_by_email(session: Session, email: str) -> Optional[User]:
        """
        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        
        Args:
            session: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            email: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            
        Returns:
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯Noneï¼‰
        """
        try:
            statement = select(User).where(User.email == email)
            user = session.exec(statement).first()
            return user
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼ (email: {email}): {e}")
            raise
    
    @staticmethod
    def get_users(
        session: Session, 
        skip: int = 0, 
        limit: int = 100,
        search: Optional[UserSearch] = None
    ) -> List[User]:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ï¼ˆæ¤œç´¢ãƒ»ãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œï¼‰
        
        Args:
            session: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            skip: ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ä»¶æ•°
            limit: å–å¾—ã™ã‚‹æœ€å¤§ä»¶æ•°
            search: æ¤œç´¢æ¡ä»¶
            
        Returns:
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ
        """
        try:
            statement = select(User)
            
            # æ¤œç´¢æ¡ä»¶ã‚’é©ç”¨
            if search:
                conditions = []
                
                if search.username:
                    conditions.append(User.username.ilike(f"%{search.username}%"))
                if search.email:
                    conditions.append(User.email.ilike(f"%{search.email}%"))
                if search.full_name:
                    conditions.append(User.full_name.ilike(f"%{search.full_name}%"))
                if search.department:
                    conditions.append(User.department.ilike(f"%{search.department}%"))
                if search.is_active is not None:
                    conditions.append(User.is_active == search.is_active)
                if search.min_age is not None:
                    conditions.append(User.age >= search.min_age)
                if search.max_age is not None:
                    conditions.append(User.age <= search.max_age)
                
                if conditions:
                    statement = statement.where(and_(*conditions))
            
            # ã‚½ãƒ¼ãƒˆã¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°
            statement = statement.order_by(User.created_at.desc()).offset(skip).limit(limit)
            
            users = session.exec(statement).all()
            logger.info(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ: {len(users)}ä»¶")
            return users
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            raise
    
    @staticmethod
    def update_user(session: Session, user_id: int, user_data: UserUpdate) -> Optional[User]:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
        
        Args:
            session: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
            user_data: æ›´æ–°ãƒ‡ãƒ¼ã‚¿
            
        Returns:
            æ›´æ–°ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯Noneï¼‰
        """
        try:
            # æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            db_user = UserCRUD.get_user_by_id(session, user_id)
            if not db_user:
                return None
            
            # æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ï¼ˆNoneã§ãªã„å€¤ã®ã¿ï¼‰
            user_dict = user_data.dict(exclude_unset=True)
            for field, value in user_dict.items():
                if field != "updated_at":  # updated_atã¯è‡ªå‹•è¨­å®š
                    setattr(db_user, field, value)
            
            # æ›´æ–°æ—¥æ™‚ã‚’è¨­å®š
            db_user.updated_at = datetime.utcnow()
            
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚³ãƒŸãƒƒãƒˆ
            session.add(db_user)
            session.commit()
            session.refresh(db_user)
            
            logger.info(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°æˆåŠŸ: {db_user.username} (ID: {user_id})")
            return db_user
            
        except IntegrityError as e:
            session.rollback()
            if "users_username_key" in str(e):
                raise ValueError(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™")
            elif "users_email_key" in str(e):
                raise ValueError(f"ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™")
            else:
                raise ValueError(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã‚¨ãƒ©ãƒ¼: {e}")
        except Exception as e:
            session.rollback()
            logger.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼ (ID: {user_id}): {e}")
            raise
    
    @staticmethod
    def delete_user(session: Session, user_id: int) -> bool:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
        
        Args:
            session: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
            
        Returns:
            å‰Šé™¤æˆåŠŸæ™‚Trueã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆFalse
        """
        try:
            # æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            db_user = UserCRUD.get_user_by_id(session, user_id)
            if not db_user:
                return False
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
            username = db_user.username
            session.delete(db_user)
            session.commit()
            
            logger.info(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æˆåŠŸ: {username} (ID: {user_id})")
            return True
            
        except Exception as e:
            session.rollback()
            logger.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼ (ID: {user_id}): {e}")
            raise
    
    @staticmethod
    def get_user_stats(session: Session) -> UserStats:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
        
        Args:
            session: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            
        Returns:
            çµ±è¨ˆæƒ…å ±
        """
        try:
            # ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
            total_users = session.exec(select(func.count(User.id))).first()
            
            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
            active_users = session.exec(
                select(func.count(User.id)).where(User.is_active == True)
            ).first()
            
            # éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
            inactive_users = total_users - active_users
            
            # å¹³å‡å¹´é½¢ï¼ˆå¹´é½¢ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰
            avg_age = session.exec(
                select(func.avg(User.age)).where(User.age.is_not(None))
            ).first()
            
            # éƒ¨ç½²ä¸€è¦§ï¼ˆé‡è¤‡é™¤å»ã€NULLé™¤å¤–ï¼‰
            departments = session.exec(
                select(User.department).where(
                    User.department.is_not(None)
                ).distinct()
            ).all()
            
            stats = UserStats(
                total_users=total_users or 0,
                active_users=active_users or 0,
                inactive_users=inactive_users or 0,
                average_age=float(avg_age) if avg_age else None,
                departments=[dept for dept in departments if dept]
            )
            
            logger.info(f"âœ… çµ±è¨ˆæƒ…å ±å–å¾—æˆåŠŸ: {stats}")
            return stats
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            raise

# CRUDæ“ä½œã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
user_crud = UserCRUD()</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>CRUDæ“ä½œãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä½œæˆã•ã‚Œã€å‹å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œãŒæä¾›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³5: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ– -->
                    <h3 class="section-title">2.5 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã¨ãƒ†ã‚¹ãƒˆ</h3>
                    
                    <p>ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ã¨CRUDæ“ä½œã‚’ä½¿ç”¨ã—ã¦ã€å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã—ã€å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 2-4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã¨CRUDæ“ä½œãƒ†ã‚¹ãƒˆ</h5>
                        <p>å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ãƒ¢ãƒ‡ãƒ«ã¨CRUDæ“ä½œã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ</li>
                            <li>ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã®ç¢ºèª</li>
                            <li>CRUDæ“ä½œã®å‹•ä½œãƒ†ã‚¹ãƒˆ</li>
                            <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¢ºèª</li>
                            <li>çµ±è¨ˆæƒ…å ±ã®å–å¾—ãƒ†ã‚¹ãƒˆ</li>
                        </ol>

                        <h6>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ãƒ»ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ</h6>
                        <pre><code># test_database.py
"""
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã¨CRUDæ“ä½œã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app.database.connection import db_manager, get_db_session
from app.database.crud import user_crud
from app.models.user import UserCreate, UserUpdate, UserSearch
from datetime import datetime

def test_database_operations():
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®ç·åˆãƒ†ã‚¹ãƒˆ"""
    
    print("ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹...")
    
    # 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
    print("\n=== 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ ===")
    if not db_manager.test_connection():
        print("âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå¤±æ•—")
        return False
    
    # 2. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ†ã‚¹ãƒˆ
    print("\n=== 2. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ†ã‚¹ãƒˆ ===")
    try:
        db_manager.create_tables()
        print("âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæˆåŠŸ")
    except Exception as e:
        print(f"âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        return False
    
    # 3. CRUDæ“ä½œãƒ†ã‚¹ãƒˆ
    print("\n=== 3. CRUDæ“ä½œãƒ†ã‚¹ãƒˆ ===")
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
    session_gen = get_db_session()
    session = next(session_gen)
    
    try:
        # Create ãƒ†ã‚¹ãƒˆ
        print("\n--- Create ãƒ†ã‚¹ãƒˆ ---")
        test_users = [
            UserCreate(
                username="alice_smith",
                email="alice@example.com",
                full_name="Alice Smith",
                age=28,
                department="Engineering",
                is_active=True
            ),
            UserCreate(
                username="bob_jones",
                email="bob@example.com",
                full_name="Bob Jones",
                age=35,
                department="Marketing",
                is_active=True
            ),
            UserCreate(
                username="charlie_brown",
                email="charlie@example.com",
                full_name="Charlie Brown",
                age=42,
                department="Engineering",
                is_active=False
            )
        ]
        
        created_users = []
        for user_data in test_users:
            try:
                user = user_crud.create_user(session, user_data)
                created_users.append(user)
                print(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ: {user.username} (ID: {user.id})")
            except Exception as e:
                print(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        
        # Read ãƒ†ã‚¹ãƒˆ
        print("\n--- Read ãƒ†ã‚¹ãƒˆ ---")
        if created_users:
            first_user = created_users[0]
            
            # IDã§å–å¾—
            user_by_id = user_crud.get_user_by_id(session, first_user.id)
            if user_by_id:
                print(f"âœ… IDå–å¾—æˆåŠŸ: {user_by_id.username}")
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§å–å¾—
            user_by_username = user_crud.get_user_by_username(session, first_user.username)
            if user_by_username:
                print(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—æˆåŠŸ: {user_by_username.email}")
            
            # ä¸€è¦§å–å¾—
            all_users = user_crud.get_users(session, limit=10)
            print(f"âœ… ä¸€è¦§å–å¾—æˆåŠŸ: {len(all_users)}ä»¶")
        
        # Update ãƒ†ã‚¹ãƒˆ
        print("\n--- Update ãƒ†ã‚¹ãƒˆ ---")
        if created_users:
            user_to_update = created_users[0]
            update_data = UserUpdate(
                department="Data Science",
                age=29
            )
            
            updated_user = user_crud.update_user(session, user_to_update.id, update_data)
            if updated_user:
                print(f"âœ… æ›´æ–°æˆåŠŸ: {updated_user.department}, Age: {updated_user.age}")
        
        # Search ãƒ†ã‚¹ãƒˆ
        print("\n--- Search ãƒ†ã‚¹ãƒˆ ---")
        search_criteria = UserSearch(
            department="Engineering",
            is_active=True
        )
        
        search_results = user_crud.get_users(session, search=search_criteria)
        print(f"âœ… æ¤œç´¢æˆåŠŸ: Engineeringéƒ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ {len(search_results)}ä»¶")
        
        # Stats ãƒ†ã‚¹ãƒˆ
        print("\n--- Stats ãƒ†ã‚¹ãƒˆ ---")
        stats = user_crud.get_user_stats(session)
        print(f"âœ… çµ±è¨ˆå–å¾—æˆåŠŸ:")
        print(f"   ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: {stats.total_users}")
        print(f"   ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: {stats.active_users}")
        print(f"   éã‚¢ã‚¯ãƒ†ã‚£ãƒ–: {stats.inactive_users}")
        print(f"   å¹³å‡å¹´é½¢: {stats.average_age}")
        print(f"   éƒ¨ç½²: {stats.departments}")
        
        # Delete ãƒ†ã‚¹ãƒˆï¼ˆæœ€å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ï¼‰
        print("\n--- Delete ãƒ†ã‚¹ãƒˆ ---")
        if created_users:
            user_to_delete = created_users[-1]
            delete_success = user_crud.delete_user(session, user_to_delete.id)
            if delete_success:
                print(f"âœ… å‰Šé™¤æˆåŠŸ: {user_to_delete.username}")
            
            # å‰Šé™¤ç¢ºèª
            deleted_user = user_crud.get_user_by_id(session, user_to_delete.id)
            if not deleted_user:
                print("âœ… å‰Šé™¤ç¢ºèª: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸ")
        
        print("\nğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼")
        return True
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {e}")
        return False
    
    finally:
        session.close()

def test_error_handling():
    """ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ"""
    print("\n=== 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ ===")
    
    session_gen = get_db_session()
    session = next(session_gen)
    
    try:
        # é‡è¤‡ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ†ã‚¹ãƒˆ
        print("\n--- é‡è¤‡ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ†ã‚¹ãƒˆ ---")
        try:
            user1 = UserCreate(
                username="duplicate_test",
                email="test1@example.com",
                full_name="Test User 1"
            )
            user_crud.create_user(session, user1)
            print("âœ… æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæˆåŠŸ")
            
            user2 = UserCreate(
                username="duplicate_test",  # åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å
                email="test2@example.com",
                full_name="Test User 2"
            )
            user_crud.create_user(session, user2)
            print("âŒ é‡è¤‡ãƒã‚§ãƒƒã‚¯å¤±æ•—")
            
        except ValueError as e:
            print(f"âœ… é‡è¤‡ã‚¨ãƒ©ãƒ¼æ­£å¸¸æ¤œå‡º: {e}")
        
        # å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ãƒ†ã‚¹ãƒˆ
        print("\n--- å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆ ---")
        non_existent_user = user_crud.get_user_by_id(session, 99999)
        if non_existent_user is None:
            print("âœ… å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‡¦ç†æ­£å¸¸")
        
        # ä¸æ­£ãªæ›´æ–°ãƒ†ã‚¹ãƒˆ
        print("\n--- å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ›´æ–°ãƒ†ã‚¹ãƒˆ ---")
        update_result = user_crud.update_user(
            session, 99999, UserUpdate(full_name="Updated Name")
        )
        if update_result is None:
            print("âœ… å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ›´æ–°å‡¦ç†æ­£å¸¸")
        
        print("âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Œäº†")
        
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    
    finally:
        session.close()

if __name__ == "__main__":
    print("ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç·åˆãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("=" * 50)
    
    # ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    main_test_success = test_database_operations()
    
    # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    test_error_handling()
    
    print("\n" + "=" * 50)
    if main_test_success:
        print("ğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼")
    else:
        print("âŒ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ")
    
    print("\næ¬¡ã¯ Step 3 ã§Streamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚")</code></pre>

                        <h6>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h6>
                        <pre><code># PostgreSQLã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
docker-compose ps

# ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
python test_database.py

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
# ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç·åˆãƒ†ã‚¹ãƒˆé–‹å§‹
# ==================================================
# ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹...
# 
# === 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ ===
# âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ
# âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ
# 
# === 2. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ†ã‚¹ãƒˆ ===
# âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ
# âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæˆåŠŸ
# 
# === 3. CRUDæ“ä½œãƒ†ã‚¹ãƒˆ ===
# 
# --- Create ãƒ†ã‚¹ãƒˆ ---
# âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ: alice_smith (ID: 1)
# âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ: bob_jones (ID: 2)
# âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ: charlie_brown (ID: 3)
# ...
# ğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼</code></pre>

                        <h6>Adminerã§ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª</h6>
                        <p>ãƒ–ãƒ©ã‚¦ã‚¶ã§ <code>http://localhost:8080</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
                        <ul>
                            <li>ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œusersã€ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨</li>
                            <li>é©åˆ‡ãªã‚«ãƒ©ãƒ ã¨åˆ¶ç´„ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨</li>
                            <li>ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒæŒ¿å…¥ã•ã‚Œã¦ã„ã‚‹ã“ã¨</li>
                            <li>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨</li>
                        </ul>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã€CRUDæ“ä½œãŒå…¨ã¦æˆåŠŸã—ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚‚é©åˆ‡ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º -->
                    <div class="quiz-container">
                        <h5>ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º</h5>
                        <ol>
                            <li><strong>SQLModel</strong>ãŒ<strong>SQLAlchemy</strong>ã¨<strong>Pydantic</strong>ã‚’çµ±åˆã™ã‚‹åˆ©ç‚¹ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>Field</strong>é–¢æ•°ã§è¨­å®šã§ãã‚‹åˆ¶ç´„ã®ç¨®é¡ã‚’5ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«</strong>ã®è¨­å®šã§<code>pool_pre_ping=True</code>ã®ç›®çš„ã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
                            <li><strong>UserCreate</strong>ã€<strong>UserUpdate</strong>ã€<strong>UserRead</strong>ãƒ¢ãƒ‡ãƒ«ã‚’åˆ†é›¢ã™ã‚‹ç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
                            <li><strong>IntegrityError</strong>ãŒç™ºç”Ÿã™ã‚‹å…¸å‹çš„ãªã‚±ãƒ¼ã‚¹ã‚’2ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</strong>ã§try-except-finallyãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
                            <li><strong>å‹ãƒ’ãƒ³ãƒˆ</strong>ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§å¾—ã‚‰ã‚Œã‚‹é–‹ç™ºä¸Šã®åˆ©ç‚¹ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ï¼ˆvalidatorï¼‰</strong>ã§ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹åˆ©ç‚¹ã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
                        </ol>
                        
                        <details>
                            <summary>è§£ç­”ä¾‹</summary>
                            <ol>
                                <li>å‹å®‰å…¨æ€§ã®å‘ä¸Šã€è‡ªå‹•ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¨ãƒ‡ã‚£ã‚¿ã§ã®è£œå®Œã¨ã‚¨ãƒ©ãƒ¼æ¤œå‡º</li>
                                <li>uniqueï¼ˆä¸€æ„åˆ¶ç´„ï¼‰ã€indexï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã€min_length/max_lengthï¼ˆæ–‡å­—æ•°åˆ¶é™ï¼‰ã€ge/leï¼ˆæ•°å€¤ç¯„å›²ï¼‰ã€regexï¼ˆæ­£è¦è¡¨ç¾ï¼‰</li>
                                <li>æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¦ã„ãªã„ã‹äº‹å‰ã«ç¢ºèªã—ã€ãƒ‡ãƒƒãƒ‰ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’é˜²ããŸã‚</li>
                                <li>APIè¨­è¨ˆã®æ˜ç¢ºåŒ–ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼ˆå¿…è¦ãªé …ç›®ã®ã¿å…¬é–‹ï¼‰ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ã®åˆ†é›¢</li>
                                <li>ä¸€æ„åˆ¶ç´„é•åï¼ˆé‡è¤‡ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥ï¼‰ã€å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„é•åï¼ˆå­˜åœ¨ã—ãªã„é–¢é€£ãƒ‡ãƒ¼ã‚¿å‚ç…§ï¼‰</li>
                                <li>ã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ãƒªã‚½ãƒ¼ã‚¹ã®ç¢ºå®Ÿãªè§£æ”¾ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼</li>
                                <li>IDE/ã‚¨ãƒ‡ã‚£ã‚¿ã§ã®è£œå®Œã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Š</li>
                                <li>ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã«ç‰¹åŒ–ã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€è¤‡é›‘ãªæ¡ä»¶ãƒã‚§ãƒƒã‚¯ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</li>
                            </ol>
                        </details>
                    </div>

                    <!-- ã¾ã¨ã‚ -->
                    <h3 class="section-title">2.6 Step 2ã®ã¾ã¨ã‚</h3>
                    
                    <div class="highlight">
                        <h5>Step 2ã§ç¿’å¾—ã—ãŸã‚¹ã‚­ãƒ«</h5>
                        <ul>
                            <li>SQLModelã«ã‚ˆã‚‹å‹å®‰å…¨ãªãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ</li>
                            <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®è¨­å®šã¨ç®¡ç†</li>
                            <li>Pydanticãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ´»ç”¨</li>
                            <li>å®Œå…¨ãªCRUDæ“ä½œã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³</li>
                            <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†</li>
                            <li>è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹APIè¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</li>
                            <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</li>
                            <li>çµ±è¨ˆæƒ…å ±ã¨ãƒ‡ãƒ¼ã‚¿é›†è¨ˆã®å®Ÿè£…</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>æ¬¡ã®Stepã«é€²ã‚€å‰ã«ç¢ºèªã™ã‚‹ã“ã¨</h6>
                        <ul>
                            <li>âœ… PostgreSQLã‚³ãƒ³ãƒ†ãƒŠãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹</li>
                            <li>âœ… usersãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹</li>
                            <li>âœ… CRUDæ“ä½œãŒå…¨ã¦æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹</li>
                            <li>âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©åˆ‡ã«æ©Ÿèƒ½ã—ã¦ã„ã‚‹</li>
                            <li>âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹</li>
                            <li>âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹</li>
                            <li>âœ… çµ±è¨ˆæƒ…å ±ã®å–å¾—ãŒå¯èƒ½ã§ã‚ã‚‹</li>
                        </ul>
                    </div>

                    <div class="info">
                        <h6>ç™ºå±•çš„ãªå­¦ç¿’ã®ãƒ’ãƒ³ãƒˆ</h6>
                        <ul>
                            <li><strong>ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—</strong>: ä»–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®é–¢é€£ã‚’å®šç¾©ã™ã‚‹</li>
                            <li><strong>ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</strong>: Alembicã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ç®¡ç†</li>
                            <li><strong>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–</strong>: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</li>
                            <li><strong>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³</strong>: è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã§ã®ä¸€è²«æ€§ä¿è¨¼</li>
                            <li><strong>æ¥ç¶šç›£è¦–</strong>: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¨æ¥ç¶šçŠ¶æ…‹ã®ç›£è¦–</li>
                        </ul>
                    </div>

                    <!-- ç« é–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step1-environment-setup.html" class="btn btn-secondary">â† Step 1: ç’°å¢ƒæ§‹ç¯‰</a>
                        <a href="step3-user-registration.html" class="btn btn-primary">Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½ â†’</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>