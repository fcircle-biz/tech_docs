<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel チュートリアル Step 3 - Streamlit基礎とユーザー登録機能</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0066cc;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0066cc;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #3399ff;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0066cc;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0066cc !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e6f2ff;
        }

        /* コードブロック */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }

        .img-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* テーブルスタイル */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ボタンスタイル */
        .btn-outline-primary {
            border-color: #0066cc;
            color: #0066cc;
        }

        .btn-outline-primary:hover {
            background-color: #0066cc;
            border-color: #0066cc;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="../streamlit-sqlmodel/README.html">Streamlit + SQLModel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                        Streamlit + SQLModel チュートリアル
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: データベース設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#step3">Step 3: ユーザー登録機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">Step 4: ユーザー一覧表示</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">Step 5: CRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-security-deployment.html">Step 6: セキュリティとデプロイ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 3: Streamlit基礎とユーザー登録機能</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="badge bg-info">所要時間: 2.5時間</span>
                        </div>
                    </div>
                </div>

                <div id="step3">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">インタラクティブなUI構築とフォーム処理</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Streamlitの基本コンポーネントの使用方法</li>
                            <li>フォーム入力とバリデーションの実装</li>
                            <li>SQLModelと連携したデータ保存機能</li>
                            <li>エラーハンドリングとユーザーフィードバック</li>
                            <li>セッションステートによる状態管理</li>
                            <li>レスポンシブなレイアウト設計</li>
                        </ul>
                    </div>

                    <!-- セクション1: Streamlit基本概念 -->
                    <h3 class="section-title">3.1 Streamlitの基本概念</h3>
                    <p>Streamlitは、PythonでインタラクティブなWebアプリケーションを簡単に作成できるフレームワークです。従来のWebアプリケーション開発とは異なり、HTMLやCSS、JavaScriptを書く必要がありません。</p>

                    <div class="info">
                        <h6>Streamlitの特徴</h6>
                        <ul>
                            <li><strong>Pythonic</strong>: 純粋なPythonコードでWebアプリを作成</li>
                            <li><strong>リアクティブ</strong>: コードの変更で即座にアプリが更新</li>
                            <li><strong>豊富なコンポーネント</strong>: グラフ、表、フォームなど多様な要素</li>
                            <li><strong>簡単なデプロイ</strong>: Streamlit Cloudやその他のプラットフォームで簡単に公開</li>
                            <li><strong>データ科学特化</strong>: Pandas、Plotly、Matplotlibとのシームレスな統合</li>
                        </ul>
                    </div>

                    <h4>主要なStreamlitコンポーネント</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>コンポーネント</th>
                                    <th>関数</th>
                                    <th>用途</th>
                                    <th>例</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>テキスト表示</td>
                                    <td>st.title(), st.header(), st.write()</td>
                                    <td>タイトル、見出し、一般テキスト</td>
                                    <td>st.title("アプリタイトル")</td>
                                </tr>
                                <tr>
                                    <td>入力フォーム</td>
                                    <td>st.text_input(), st.number_input()</td>
                                    <td>ユーザー入力の受け取り</td>
                                    <td>name = st.text_input("名前")</td>
                                </tr>
                                <tr>
                                    <td>選択</td>
                                    <td>st.selectbox(), st.radio(), st.checkbox()</td>
                                    <td>オプション選択</td>
                                    <td>option = st.selectbox("選択", ["A", "B"])</td>
                                </tr>
                                <tr>
                                    <td>ボタン</td>
                                    <td>st.button(), st.form_submit_button()</td>
                                    <td>アクション実行</td>
                                    <td>if st.button("実行"):</td>
                                </tr>
                                <tr>
                                    <td>データ表示</td>
                                    <td>st.dataframe(), st.table()</td>
                                    <td>表形式データの表示</td>
                                    <td>st.dataframe(df)</td>
                                </tr>
                                <tr>
                                    <td>レイアウト</td>
                                    <td>st.columns(), st.sidebar()</td>
                                    <td>画面レイアウト</td>
                                    <td>col1, col2 = st.columns(2)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- セクション2: バリデーション機能 -->
                    <h3 class="section-title">3.2 入力バリデーション機能の実装</h3>
                    
                    <p>ユーザー入力の検証を行うためのバリデーション機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 3-1: バリデーション機能の作成</h5>
                        <p>フォーム入力の検証を行うvalidators.pyファイルを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>app/utils/validators.pyファイルを作成</li>
                            <li>各フィールドのバリデーション関数を実装</li>
                            <li>エラーメッセージの管理</li>
                            <li>統合バリデーション機能の実装</li>
                            <li>Streamlit用のヘルパー関数作成</li>
                        </ol>

                        <h6>app/utils/validators.py作成</h6>
                        <pre><code>"""
入力バリデーション機能
フォーム入力の検証とエラーメッセージの管理
"""

import re
from typing import List, Optional, Tuple, Dict, Any
from email_validator import validate_email, EmailNotValidError

class ValidationError(Exception):
    """バリデーションエラー"""
    def __init__(self, field: str, message: str):
        self.field = field
        self.message = message
        super().__init__(f"{field}: {message}")

class UserValidator:
    """ユーザー入力バリデーションクラス"""
    
    # 予約語リスト
    RESERVED_USERNAMES = {
        'admin', 'root', 'system', 'user', 'test', 'demo',
        'null', 'undefined', 'anonymous', 'guest', 'public'
    }
    
    # 部署リスト（例）
    VALID_DEPARTMENTS = {
        'Engineering', 'Marketing', 'Sales', 'HR', 'Finance',
        'Operations', 'Data Science', 'Product', 'Design', 'Legal'
    }
    
    @staticmethod
    def validate_username(username: str) -> Tuple[bool, Optional[str]]:
        """
        ユーザー名のバリデーション
        
        Args:
            username: ユーザー名
            
        Returns:
            (is_valid, error_message)
        """
        if not username:
            return False, "ユーザー名は必須です"
        
        username = username.strip()
        
        # 長さチェック
        if len(username) < 3:
            return False, "ユーザー名は3文字以上で入力してください"
        
        if len(username) > 50:
            return False, "ユーザー名は50文字以下で入力してください"
        
        # 文字種チェック（英数字、ハイフン、アンダースコアのみ）
        if not re.match(r'^[a-zA-Z0-9_-]+$', username):
            return False, "ユーザー名は英数字、ハイフン（-）、アンダースコア（_）のみ使用できます"
        
        # 先頭文字チェック（数字やハイフンで始まらない）
        if username[0] in '-_' or username[0].isdigit():
            return False, "ユーザー名は英字で始まる必要があります"
        
        # 予約語チェック
        if username.lower() in UserValidator.RESERVED_USERNAMES:
            return False, f"'{username}' は予約語のため使用できません"
        
        # 連続する特殊文字チェック
        if '--' in username or '__' in username or '-_' in username or '_-' in username:
            return False, "特殊文字を連続して使用することはできません"
        
        return True, None
    
    @staticmethod
    def validate_email(email: str) -> Tuple[bool, Optional[str]]:
        """
        メールアドレスのバリデーション
        
        Args:
            email: メールアドレス
            
        Returns:
            (is_valid, error_message)
        """
        if not email:
            return False, "メールアドレスは必須です"
        
        email = email.strip().lower()
        
        try:
            # email-validatorライブラリを使用
            valid = validate_email(email)
            return True, None
        except EmailNotValidError as e:
            return False, "有効なメールアドレスを入力してください"
    
    @staticmethod
    def validate_full_name(full_name: str) -> Tuple[bool, Optional[str]]:
        """
        氏名のバリデーション
        
        Args:
            full_name: 氏名
            
        Returns:
            (is_valid, error_message)
        """
        if not full_name:
            return False, "氏名は必須です"
        
        full_name = full_name.strip()
        
        # 長さチェック
        if len(full_name) < 1:
            return False, "氏名を入力してください"
        
        if len(full_name) > 100:
            return False, "氏名は100文字以下で入力してください"
        
        # 空白のみチェック
        if not full_name.strip():
            return False, "氏名に有効な文字を入力してください"
        
        return True, None
    
    @staticmethod
    def validate_age(age: Optional[int]) -> Tuple[bool, Optional[str]]:
        """
        年齢のバリデーション
        
        Args:
            age: 年齢
            
        Returns:
            (is_valid, error_message)
        """
        if age is None:
            return True, None  # 年齢は任意項目
        
        if age < 0:
            return False, "年齢は0以上で入力してください"
        
        if age > 150:
            return False, "年齢は150以下で入力してください"
        
        return True, None
    
    @staticmethod
    def validate_department(department: Optional[str]) -> Tuple[bool, Optional[str]]:
        """
        部署のバリデーション
        
        Args:
            department: 部署名
            
        Returns:
            (is_valid, error_message)
        """
        if not department:
            return True, None  # 部署は任意項目
        
        department = department.strip()
        
        # 長さチェック
        if len(department) > 100:
            return False, "部署名は100文字以下で入力してください"
        
        return True, None
    
    @classmethod
    def validate_user_data(cls, user_data: Dict[str, Any]) -> Dict[str, List[str]]:
        """
        ユーザーデータの統合バリデーション
        
        Args:
            user_data: ユーザーデータ辞書
            
        Returns:
            フィールド別エラーメッセージ辞書
        """
        errors = {}
        
        # 各フィールドのバリデーション
        validations = [
            ('username', cls.validate_username, user_data.get('username', '')),
            ('email', cls.validate_email, user_data.get('email', '')),
            ('full_name', cls.validate_full_name, user_data.get('full_name', '')),
            ('age', cls.validate_age, user_data.get('age')),
            ('department', cls.validate_department, user_data.get('department', ''))
        ]
        
        for field, validator, value in validations:
            is_valid, error_message = validator(value)
            if not is_valid:
                if field not in errors:
                    errors[field] = []
                errors[field].append(error_message)
        
        return errors

class StreamlitValidationHelper:
    """Streamlit用バリデーションヘルパー"""
    
    @staticmethod
    def display_field_errors(errors: Dict[str, List[str]], field: str) -> bool:
        """
        フィールドのエラーメッセージを表示
        
        Args:
            errors: エラーメッセージ辞書
            field: フィールド名
            
        Returns:
            エラーがあるかどうか
        """
        import streamlit as st
        
        if field in errors:
            for error in errors[field]:
                st.error(f"⚠️ {error}")
            return True
        return False
    
    @staticmethod
    def display_all_errors(errors: Dict[str, List[str]]) -> bool:
        """
        全てのエラーメッセージを表示
        
        Args:
            errors: エラーメッセージ辞書
            
        Returns:
            エラーがあるかどうか
        """
        import streamlit as st
        
        if errors:
            st.error("⚠️ 入力内容に問題があります:")
            for field, error_list in errors.items():
                for error in error_list:
                    st.error(f"• **{field}**: {error}")
            return True
        return False
    
    @staticmethod
    def validate_and_show_errors(user_data: Dict[str, Any]) -> bool:
        """
        バリデーションを実行し、エラーがあれば表示
        
        Args:
            user_data: ユーザーデータ
            
        Returns:
            バリデーション成功かどうか
        """
        errors = UserValidator.validate_user_data(user_data)
        has_errors = StreamlitValidationHelper.display_all_errors(errors)
        return not has_errors

# 便利な関数
def get_valid_departments() -> List[str]:
    """有効な部署リストを取得"""
    return sorted(list(UserValidator.VALID_DEPARTMENTS))

def is_valid_user_data(user_data: Dict[str, Any]) -> bool:
    """ユーザーデータが有効かチェック"""
    errors = UserValidator.validate_user_data(user_data)
    return len(errors) == 0</code></pre>

                        <h6>バリデーション機能のテスト</h6>
                        <pre><code># test_validators.py
from app.utils.validators import UserValidator

def test_validators():
    """バリデーション機能のテスト"""
    
    print("=== ユーザー名バリデーションテスト ===")
    
    # 正常なケース
    valid, error = UserValidator.validate_username("john_doe")
    print(f"john_doe: {valid}, {error}")
    
    # 異常なケース
    test_cases = [
        "",  # 空文字
        "ab",  # 短すぎる
        "admin",  # 予約語
        "123user",  # 数字で始まる
        "user@name",  # 無効な文字
        "user--name",  # 連続する特殊文字
    ]
    
    for case in test_cases:
        valid, error = UserValidator.validate_username(case)
        print(f"'{case}': {valid}, {error}")
    
    print("\n=== メールアドレスバリデーションテスト ===")
    
    email_cases = [
        "test@example.com",  # 正常
        "",  # 空文字
        "invalid-email",  # 無効
        "test@",  # 不完全
    ]
    
    for case in email_cases:
        valid, error = UserValidator.validate_email(case)
        print(f"'{case}': {valid}, {error}")

if __name__ == "__main__":
    test_validators()</code></pre>

                        <h6>期待される結果</h6>
                        <p>バリデーション機能が正常に動作し、適切なエラーメッセージが表示されることを確認してください。</p>
                    </div>

                    <!-- セクション3: ユーザー登録フォーム -->
                    <h3 class="section-title">3.3 ユーザー登録フォームの実装</h3>
                    
                    <p>Streamlitのフォーム機能を使用して、ユーザー登録画面を作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 3-2: ユーザー登録フォームの作成</h5>
                        <p>メインアプリケーションにユーザー登録機能を追加します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>app/main.pyを更新してユーザー登録機能を追加</li>
                            <li>フォームレイアウトの設計</li>
                            <li>入力フィールドの実装</li>
                            <li>リアルタイムバリデーションの追加</li>
                            <li>データ保存機能の統合</li>
                        </ol>

                        <h6>app/main.py更新</h6>
                        <pre><code>"""
Modern User Management Dashboard
メインアプリケーションファイル - ユーザー登録機能付き
"""

import streamlit as st
from datetime import datetime
import sys
import os

# プロジェクトルートをPythonパスに追加
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from config import settings
from database.connection import db_manager, get_db_session, init_database
from database.crud import user_crud
from models.user import UserCreate
from utils.validators import (
    UserValidator, StreamlitValidationHelper, get_valid_departments
)

def initialize_app():
    """アプリケーションの初期化"""
    if 'app_initialized' not in st.session_state:
        try:
            # データベース初期化
            init_database()
            st.session_state.app_initialized = True
            st.session_state.initialization_success = True
        except Exception as e:
            st.session_state.app_initialized = True
            st.session_state.initialization_success = False
            st.session_state.initialization_error = str(e)

def show_user_registration_form():
    """ユーザー登録フォームを表示"""
    
    st.header("👤 新規ユーザー登録")
    st.markdown("新しいユーザーアカウントを作成します。")
    
    # フォーム作成
    with st.form("user_registration_form", clear_on_submit=True):
        st.subheader("📝 ユーザー情報入力")
        
        # 2カラムレイアウト
        col1, col2 = st.columns(2)
        
        with col1:
            # 基本情報
            st.markdown("**基本情報**")
            username = st.text_input(
                "ユーザー名 *",
                placeholder="例: john_doe",
                help="3-50文字、英数字とハイフン・アンダースコアのみ"
            )
            
            email = st.text_input(
                "メールアドレス *",
                placeholder="例: john@example.com",
                help="有効なメールアドレスを入力してください"
            )
            
            full_name = st.text_input(
                "氏名 *",
                placeholder="例: 田中 太郎",
                help="フルネームを入力してください"
            )
        
        with col2:
            # 追加情報
            st.markdown("**追加情報**")
            age = st.number_input(
                "年齢",
                min_value=0,
                max_value=150,
                value=None,
                help="年齢を入力してください（任意）"
            )
            
            department = st.selectbox(
                "部署",
                options=[""] + get_valid_departments(),
                help="所属部署を選択してください（任意）"
            )
            
            is_active = st.checkbox(
                "アクティブ状態",
                value=True,
                help="ユーザーのアクティブ状態"
            )
        
        # 送信ボタン
        st.markdown("---")
        col_left, col_center, col_right = st.columns([1, 2, 1])
        
        with col_center:
            submitted = st.form_submit_button(
                "🚀 ユーザーを登録",
                use_container_width=True,
                type="primary"
            )
    
    # フォーム送信処理
    if submitted:
        # 入力データの準備
        user_data = {
            'username': username.strip() if username else '',
            'email': email.strip().lower() if email else '',
            'full_name': full_name.strip() if full_name else '',
            'age': age if age is not None and age > 0 else None,
            'department': department.strip() if department else None,
            'is_active': is_active
        }
        
        # バリデーション実行
        if StreamlitValidationHelper.validate_and_show_errors(user_data):
            # データベースに保存
            try:
                # セッション取得
                session_gen = get_db_session()
                session = next(session_gen)
                
                # ユーザー作成
                user_create = UserCreate(**user_data)
                created_user = user_crud.create_user(session, user_create)
                
                # 成功メッセージ
                st.success(f"✅ ユーザー '{created_user.username}' を正常に登録しました！")
                st.balloons()  # お祝いアニメーション
                
                # 登録済みユーザー情報を表示
                with st.expander("📋 登録されたユーザー情報", expanded=True):
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        st.write(f"**ユーザーID**: {created_user.id}")
                        st.write(f"**ユーザー名**: {created_user.username}")
                        st.write(f"**メールアドレス**: {created_user.email}")
                        st.write(f"**氏名**: {created_user.full_name}")
                    
                    with col2:
                        st.write(f"**年齢**: {created_user.age or '未設定'}")
                        st.write(f"**部署**: {created_user.department or '未設定'}")
                        st.write(f"**状態**: {'アクティブ' if created_user.is_active else '非アクティブ'}")
                        st.write(f"**登録日時**: {created_user.created_at.strftime('%Y-%m-%d %H:%M:%S')}")
                
                # セッション状態更新
                if 'registered_users_count' not in st.session_state:
                    st.session_state.registered_users_count = 0
                st.session_state.registered_users_count += 1
                
                session.close()
                
            except ValueError as e:
                st.error(f"❌ 登録エラー: {e}")
            except Exception as e:
                st.error(f"❌ 予期しないエラーが発生しました: {e}")
                if settings.DEBUG:
                    st.exception(e)

def show_registration_stats():
    """登録統計情報を表示"""
    try:
        session_gen = get_db_session()
        session = next(session_gen)
        
        stats = user_crud.get_user_stats(session)
        
        st.subheader("📊 登録統計")
        
        # メトリクス表示
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("総ユーザー数", stats.total_users)
        
        with col2:
            st.metric("アクティブユーザー", stats.active_users)
        
        with col3:
            st.metric("非アクティブユーザー", stats.inactive_users)
        
        with col4:
            avg_age_display = f"{stats.average_age:.1f}歳" if stats.average_age else "未設定"
            st.metric("平均年齢", avg_age_display)
        
        # 部署情報
        if stats.departments:
            st.markdown("**登録されている部署:**")
            for dept in stats.departments:
                st.badge(dept, outline=True)
        
        session.close()
        
    except Exception as e:
        st.error(f"❌ 統計情報の取得に失敗しました: {e}")

def show_quick_tips():
    """使用方法のヒント表示"""
    with st.expander("💡 使用方法のヒント"):
        st.markdown("""
        **ユーザー登録のポイント:**
        
        1. **ユーザー名**: 
           - 3-50文字で入力
           - 英数字、ハイフン（-）、アンダースコア（_）のみ使用可能
           - 英字で始まる必要があります
        
        2. **メールアドレス**: 
           - 有効なメールアドレス形式で入力
           - 重複は不可
        
        3. **氏名**: 
           - 必須項目
           - 100文字以下
        
        4. **年齢・部署**: 
           - 任意項目
           - 年齢は0-150歳の範囲
        """)

def main():
    """メインアプリケーション"""
    
    # ページ設定
    st.set_page_config(
        page_title=settings.APP_NAME,
        page_icon="👥",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # アプリケーション初期化
    initialize_app()
    
    # 初期化失敗時のエラー表示
    if not st.session_state.get('initialization_success', False):
        st.error("❌ データベースの初期化に失敗しました")
        if 'initialization_error' in st.session_state:
            st.error(f"エラー詳細: {st.session_state.initialization_error}")
        st.stop()
    
    # メインタイトル
    st.title(f"👥 {settings.APP_NAME}")
    st.markdown(f"**Version:** {settings.APP_VERSION}")
    
    # サイドバー
    with st.sidebar:
        st.header("📋 メニュー")
        
        # ナビゲーション
        page = st.radio(
            "ページを選択:",
            ["🏠 ホーム", "👤 ユーザー登録", "📊 統計情報"],
            index=1  # デフォルトでユーザー登録を選択
        )
        
        st.markdown("---")
        
        # システム情報
        st.subheader("🛠️ システム情報")
        st.write(f"**Database**: PostgreSQL")
        st.write(f"**Debug Mode**: {settings.DEBUG}")
        
        # 接続テスト
        if st.button("🔌 接続テスト"):
            if db_manager.test_connection():
                st.success("✅ 接続成功")
            else:
                st.error("❌ 接続失敗")
    
    # メインコンテンツ
    if page == "🏠 ホーム":
        st.header("🏠 ホーム")
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown("""
            ## 🎯 Streamlit + SQLModel チュートリアル
            
            このアプリケーションは、**Streamlit** と **SQLModel** を使用した
            モダンなユーザー管理システムのデモンストレーションです。
            
            ### 主な機能:
            - ✅ **ユーザー登録**: フォームバリデーション付きの新規登録
            - 📋 **データ管理**: PostgreSQLデータベースでの永続化
            - 🔒 **入力検証**: 包括的なバリデーション機能
            - 📊 **統計表示**: リアルタイムな統計情報
            """)
            
            show_quick_tips()
        
        with col2:
            st.subheader("📈 進行状況")
            
            progress_steps = [
                ("✅ Step 1: 環境構築", True),
                ("✅ Step 2: データベース設計", True),
                ("✅ Step 3: ユーザー登録機能", True),
                ("⏳ Step 4: ユーザー一覧表示", False),
                ("⏳ Step 5: CRUD操作", False),
                ("⏳ Step 6: セキュリティとデプロイ", False)
            ]
            
            for step, completed in progress_steps:
                if completed:
                    st.success(step)
                else:
                    st.info(step)
    
    elif page == "👤 ユーザー登録":
        show_user_registration_form()
        
    elif page == "📊 統計情報":
        show_registration_stats()
    
    # フッター
    st.markdown("---")
    st.markdown(
        "<div style='text-align: center; color: gray;'>"
        "Streamlit + SQLModel チュートリアル | Step 3: ユーザー登録機能実装完了 ✅"
        "</div>", 
        unsafe_allow_html=True
    )

if __name__ == "__main__":
    main()</code></pre>

                        <h6>必要な依存関係を追加</h6>
                        <pre><code># requirements.txtに追加
email-validator>=2.0.0</code></pre>

                        <h6>追加パッケージのインストール</h6>
                        <pre><code># 仮想環境がアクティブであることを確認
pip install email-validator

# または requirements.txtから再インストール
pip install -r requirements.txt</code></pre>

                        <h6>期待される結果</h6>
                        <p>ユーザー登録フォームが表示され、バリデーション機能が正常に動作することを確認してください。</p>
                    </div>

                    <!-- セクション4: アプリケーション実行 -->
                    <h3 class="section-title">3.4 アプリケーションの実行とテスト</h3>
                    
                    <p>作成したユーザー登録機能を実際に動作させて、全ての機能をテストします。</p>

                    <div class="exercise-container">
                        <h5>実習 3-3: ユーザー登録アプリケーションの動作確認</h5>
                        <p>実際にStreamlitアプリケーションを起動し、ユーザー登録機能をテストします。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>PostgreSQLコンテナの起動確認</li>
                            <li>Streamlitアプリケーションの起動</li>
                            <li>各種入力パターンのテスト</li>
                            <li>エラーハンドリングの確認</li>
                            <li>データベースでの保存確認</li>
                        </ol>

                        <h6>アプリケーション起動</h6>
                        <pre><code># 1. PostgreSQLコンテナの確認
docker-compose ps

# コンテナが停止している場合は起動
docker-compose up -d

# 2. Streamlitアプリケーション起動
# プロジェクトルートディレクトリから実行
streamlit run app/main.py

# WSL2環境の場合
streamlit run app/main.py --server.address 0.0.0.0

# カスタムポートで起動する場合
streamlit run app/main.py --server.port 8502</code></pre>

                        <h6>機能テストのチェックポイント</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>テスト項目</th>
                                        <th>入力値</th>
                                        <th>期待される結果</th>
                                        <th>確認ポイント</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>正常登録</td>
                                        <td>有効な全項目</td>
                                        <td>登録成功メッセージ</td>
                                        <td>バルーンアニメーション表示</td>
                                    </tr>
                                    <tr>
                                        <td>ユーザー名重複</td>
                                        <td>既存のユーザー名</td>
                                        <td>重複エラーメッセージ</td>
                                        <td>明確なエラー表示</td>
                                    </tr>
                                    <tr>
                                        <td>無効メール</td>
                                        <td>invalid-email</td>
                                        <td>メール形式エラー</td>
                                        <td>リアルタイムエラー表示</td>
                                    </tr>
                                    <tr>
                                        <td>予約語ユーザー名</td>
                                        <td>admin</td>
                                        <td>予約語エラー</td>
                                        <td>明確な禁止理由</td>
                                    </tr>
                                    <tr>
                                        <td>任意項目</td>
                                        <td>年齢・部署を空白</td>
                                        <td>登録成功</td>
                                        <td>必須項目のみで登録可能</td>
                                    </tr>
                                    <tr>
                                        <td>統計情報</td>
                                        <td>複数ユーザー登録後</td>
                                        <td>正確な統計表示</td>
                                        <td>リアルタイム更新</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h6>具体的なテストケース</h6>
                        <pre><code># テストケース 1: 正常な登録
ユーザー名: test_user_01
メールアドレス: test01@example.com
氏名: テスト ユーザー1
年齢: 25
部署: Engineering
期待結果: 登録成功、バルーンアニメーション表示

# テストケース 2: バリデーションエラー
ユーザー名: ab (短すぎる)
メールアドレス: invalid-email
氏名: (空白)
期待結果: 複数のエラーメッセージが表示

# テストケース 3: 重複エラー
ユーザー名: test_user_01 (既存)
メールアドレス: new@example.com
氏名: 新規ユーザー
期待結果: "ユーザー名は既に使用されています"エラー

# テストケース 4: 任意項目のテスト
ユーザー名: minimal_user
メールアドレス: minimal@example.com
氏名: 最小ユーザー
年齢: (未入力)
部署: (未選択)
期待結果: 登録成功、任意項目は空として保存</code></pre>

                        <h6>データベースでの確認</h6>
                        <pre><code># Adminerでの確認 (http://localhost:8080)
# 1. ログイン情報:
#    システム: PostgreSQL
#    サーバ: postgres
#    ユーザ名: postgres
#    パスワード: password
#    データベース: userdb

# 2. SQLクエリで確認
SELECT 
    id, username, email, full_name, age, department, 
    is_active, created_at, updated_at 
FROM users 
ORDER BY created_at DESC;

# 3. 統計確認
SELECT 
    COUNT(*) as total_users,
    COUNT(CASE WHEN is_active THEN 1 END) as active_users,
    AVG(age) as average_age
FROM users;</code></pre>

                        <h6>期待される結果</h6>
                        <p>以下の機能が全て正常に動作することを確認してください：</p>
                        <ul>
                            <li>フォームの表示と入力</li>
                            <li>リアルタイムバリデーション</li>
                            <li>データベースへの保存</li>
                            <li>エラーハンドリング</li>
                            <li>統計情報の表示</li>
                            <li>ユーザーフィードバック（成功・エラーメッセージ）</li>
                        </ul>
                    </div>

                    <!-- セクション5: セッション管理 -->
                    <h3 class="section-title">3.5 セッション状態管理の実装</h3>
                    
                    <p>Streamlitのセッション状態を活用して、アプリケーションの状態を管理します。</p>

                    <div class="exercise-container">
                        <h5>実習 3-4: セッション管理機能の追加</h5>
                        <p>ユーザー体験を向上させるためのセッション管理機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>セッション状態管理用のヘルパー関数作成</li>
                            <li>登録履歴の管理</li>
                            <li>フォーム状態の保持</li>
                            <li>ユーザーフィードバックの改善</li>
                        </ol>

                        <h6>app/utils/helpers.py作成</h6>
                        <pre><code>"""
ヘルパー関数とユーティリティ
セッション管理、UI補助機能など
"""

import streamlit as st
from datetime import datetime
from typing import Dict, Any, List, Optional

class SessionManager:
    """Streamlitセッション状態管理クラス"""
    
    @staticmethod
    def initialize_session():
        """セッション状態を初期化"""
        if 'registration_history' not in st.session_state:
            st.session_state.registration_history = []
        
        if 'form_data' not in st.session_state:
            st.session_state.form_data = {}
        
        if 'last_registration_time' not in st.session_state:
            st.session_state.last_registration_time = None
        
        if 'notification_queue' not in st.session_state:
            st.session_state.notification_queue = []
    
    @staticmethod
    def add_registration_record(user_data: Dict[str, Any], user_id: int):
        """登録記録をセッションに追加"""
        record = {
            'id': user_id,
            'username': user_data.get('username'),
            'email': user_data.get('email'),
            'full_name': user_data.get('full_name'),
            'timestamp': datetime.now(),
            'session_id': id(st.session_state)
        }
        
        st.session_state.registration_history.append(record)
        st.session_state.last_registration_time = datetime.now()
        
        # 履歴は最新10件まで保持
        if len(st.session_state.registration_history) > 10:
            st.session_state.registration_history = st.session_state.registration_history[-10:]
    
    @staticmethod
    def get_registration_history() -> List[Dict[str, Any]]:
        """登録履歴を取得"""
        return st.session_state.get('registration_history', [])
    
    @staticmethod
    def clear_form_data():
        """フォームデータをクリア"""
        st.session_state.form_data = {}
    
    @staticmethod
    def save_form_data(data: Dict[str, Any]):
        """フォームデータを保存"""
        st.session_state.form_data.update(data)
    
    @staticmethod
    def get_form_data(key: str, default: Any = None) -> Any:
        """フォームデータを取得"""
        return st.session_state.form_data.get(key, default)

class NotificationManager:
    """通知管理クラス"""
    
    @staticmethod
    def add_success(message: str):
        """成功通知を追加"""
        st.session_state.notification_queue.append({
            'type': 'success',
            'message': message,
            'timestamp': datetime.now()
        })
    
    @staticmethod
    def add_error(message: str):
        """エラー通知を追加"""
        st.session_state.notification_queue.append({
            'type': 'error',
            'message': message,
            'timestamp': datetime.now()
        })
    
    @staticmethod
    def add_info(message: str):
        """情報通知を追加"""
        st.session_state.notification_queue.append({
            'type': 'info',
            'message': message,
            'timestamp': datetime.now()
        })
    
    @staticmethod
    def show_notifications():
        """通知を表示"""
        if st.session_state.notification_queue:
            for notification in st.session_state.notification_queue:
                if notification['type'] == 'success':
                    st.success(notification['message'])
                elif notification['type'] == 'error':
                    st.error(notification['message'])
                elif notification['type'] == 'info':
                    st.info(notification['message'])
            
            # 通知をクリア
            st.session_state.notification_queue = []

class UIHelper:
    """UI補助機能クラス"""
    
    @staticmethod
    def show_registration_history():
        """登録履歴を表示"""
        history = SessionManager.get_registration_history()
        
        if not history:
            st.info("📝 登録履歴はありません")
            return
        
        st.subheader("📋 セッション中の登録履歴")
        
        for i, record in enumerate(reversed(history)):
            with st.expander(
                f"👤 {record['username']} ({record['timestamp'].strftime('%H:%M:%S')})",
                expanded=(i == 0)
            ):
                col1, col2 = st.columns(2)
                
                with col1:
                    st.write(f"**ID**: {record['id']}")
                    st.write(f"**ユーザー名**: {record['username']}")
                    st.write(f"**メール**: {record['email']}")
                
                with col2:
                    st.write(f"**氏名**: {record['full_name']}")
                    st.write(f"**登録時刻**: {record['timestamp'].strftime('%Y-%m-%d %H:%M:%S')}")
    
    @staticmethod
    def show_session_info():
        """セッション情報を表示"""
        with st.expander("🔍 セッション情報"):
            col1, col2 = st.columns(2)
            
            with col1:
                st.write(f"**セッションID**: {id(st.session_state)}")
                st.write(f"**登録件数**: {len(SessionManager.get_registration_history())}")
            
            with col2:
                last_time = st.session_state.get('last_registration_time')
                if last_time:
                    st.write(f"**最終登録**: {last_time.strftime('%H:%M:%S')}")
                else:
                    st.write("**最終登録**: なし")
    
    @staticmethod
    def create_user_card(user_data: Dict[str, Any]) -> str:
        """ユーザー情報カードのHTMLを生成"""
        return f"""
        <div style="
            padding: 1rem; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background-color: #f9f9f9;
            margin: 0.5rem 0;
        ">
            <h4>👤 {user_data.get('full_name', 'Unknown')}</h4>
            <p><strong>ユーザー名:</strong> {user_data.get('username', 'N/A')}</p>
            <p><strong>メール:</strong> {user_data.get('email', 'N/A')}</p>
            <p><strong>部署:</strong> {user_data.get('department', '未設定')}</p>
        </div>
        """
    
    @staticmethod
    def show_progress_indicator(current_step: int, total_steps: int = 6):
        """進行状況インジケーターを表示"""
        progress = current_step / total_steps
        st.progress(progress)
        st.caption(f"Step {current_step} / {total_steps} 完了")

def format_datetime(dt: datetime) -> str:
    """日時を読みやすい形式でフォーマット"""
    return dt.strftime("%Y年%m月%d日 %H:%M:%S")

def truncate_text(text: str, max_length: int = 50) -> str:
    """テキストを指定した長さで切り詰め"""
    if len(text) <= max_length:
        return text
    return text[:max_length - 3] + "..."

def get_user_display_name(user_data: Dict[str, Any]) -> str:
    """ユーザーの表示名を取得"""
    full_name = user_data.get('full_name')
    username = user_data.get('username')
    
    if full_name:
        return f"{full_name} ({username})"
    return username or "Unknown User"</code></pre>

                        <h6>main.pyにセッション管理機能を統合</h6>
                        <pre><code># app/main.pyの冒頭に追加
from utils.helpers import SessionManager, NotificationManager, UIHelper

# main()関数の最初に追加
def main():
    # セッション初期化
    SessionManager.initialize_session()
    
    # 既存のコード...
    
    # サイドバーにセッション情報を追加
    with st.sidebar:
        # 既存のコード...
        
        st.markdown("---")
        UIHelper.show_session_info()
        
        # 履歴表示ボタン
        if st.button("📋 登録履歴表示"):
            st.session_state.show_history = True

# ユーザー登録成功時の処理を更新
# show_user_registration_form()内の成功処理部分を以下に置き換え:

if submitted and StreamlitValidationHelper.validate_and_show_errors(user_data):
    try:
        # ... 既存のユーザー作成コード ...
        
        # セッションに記録追加
        SessionManager.add_registration_record(user_data, created_user.id)
        
        # 通知追加
        NotificationManager.add_success(
            f"✅ ユーザー '{created_user.username}' を正常に登録しました！"
        )
        
        # ... 既存のコード ...
        
    except ValueError as e:
        NotificationManager.add_error(f"❌ 登録エラー: {e}")
    except Exception as e:
        NotificationManager.add_error(f"❌ 予期しないエラーが発生しました: {e}")

# メインコンテンツの最後に履歴表示を追加
if page == "👤 ユーザー登録":
    show_user_registration_form()
    
    # 通知表示
    NotificationManager.show_notifications()
    
    # 履歴表示
    if st.session_state.get('show_history', False):
        UIHelper.show_registration_history()
        
        if st.button("履歴を閉じる"):
            st.session_state.show_history = False</code></pre>

                        <h6>期待される結果</h6>
                        <p>セッション管理機能が追加され、登録履歴の表示、通知管理、セッション情報の表示が正常に動作することを確認してください。</p>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>st.form()</strong>を使用する利点を3つ挙げてください。</li>
                            <li><strong>セッション状態（st.session_state）</strong>の主な用途を3つ挙げてください。</li>
                            <li><strong>Streamlitのリアクティブ性</strong>とは何ですか？</li>
                            <li><strong>st.columns()</strong>を使用する目的は何ですか？</li>
                            <li><strong>フォームバリデーション</strong>をクライアントサイドで行う利点は何ですか？</li>
                            <li><strong>st.balloons()</strong>や<strong>st.success()</strong>などのフィードバック機能の重要性は何ですか？</li>
                            <li><strong>エラーハンドリング</strong>でtry-except文を使用する際の注意点を2つ挙げてください。</li>
                            <li><strong>Streamlitアプリ</strong>と<strong>従来のWebアプリ</strong>の主な違いを3つ挙げてください。</li>
                        </ol>
                        
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>ユーザー入力の一括送信、ページ再読み込みの制御、複数入力の同期処理</li>
                                <li>ユーザー状態の保持、画面間でのデータ共有、アプリケーション設定の管理</li>
                                <li>コードが変更されると自動的にアプリケーションが再実行され、UIが更新される仕組み</li>
                                <li>画面を複数の列に分割し、レスポンシブなレイアウトを作成するため</li>
                                <li>ユーザー体験の向上、サーバー負荷の軽減、即座のフィードバック提供</li>
                                <li>ユーザーエンゲージメントの向上、操作結果の明確化、アプリケーションの使いやすさ向上</li>
                                <li>具体的な例外の種類を分けて処理する、デバッグ情報と本番情報を使い分ける</li>
                                <li>HTMLやCSSの知識不要、Pythonのみで開発可能、リアクティブな更新機能</li>
                            </ol>
                        </details>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">3.6 Step 3のまとめ</h3>
                    
                    <div class="highlight">
                        <h5>Step 3で習得したスキル</h5>
                        <ul>
                            <li>Streamlitフォームコンポーネントの活用</li>
                            <li>包括的な入力バリデーション機能</li>
                            <li>データベースとの連携によるデータ永続化</li>
                            <li>エラーハンドリングとユーザーフィードバック</li>
                            <li>セッション状態管理とアプリケーション状態</li>
                            <li>レスポンシブなUIレイアウト設計</li>
                            <li>リアルタイム統計情報の表示</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>次のStepに進む前に確認すること</h6>
                        <ul>
                            <li>✅ ユーザー登録フォームが正常に表示される</li>
                            <li>✅ 入力バリデーションが適切に動作する</li>
                            <li>✅ データベースにユーザーデータが保存される</li>
                            <li>✅ エラーメッセージが適切に表示される</li>
                            <li>✅ 統計情報がリアルタイムで更新される</li>
                            <li>✅ セッション状態が正しく管理される</li>
                            <li>✅ ユーザーフィードバックが機能する</li>
                        </ul>
                    </div>

                    <div class="info">
                        <h6>発展的な学習のヒント</h6>
                        <ul>
                            <li><strong>カスタムコンポーネント</strong>: Streamlitの拡張コンポーネント作成</li>
                            <li><strong>ファイルアップロード</strong>: プロフィール画像のアップロード機能</li>
                            <li><strong>データ可視化</strong>: Plotly、Matplotlibとの統合</li>
                            <li><strong>認証機能</strong>: streamlit-authenticatorライブラリの活用</li>
                            <li><strong>キャッシュ機能</strong>: @st.cacheデコレータによるパフォーマンス向上</li>
                        </ul>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step2-database-design.html" class="btn btn-secondary">← Step 2: データベース設計</a>
                        <a href="step4-user-list-display.html" class="btn btn-primary">Step 4: ユーザー一覧表示 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>