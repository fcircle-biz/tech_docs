<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel チュートリアル Step 5 - ユーザー詳細・編集・削除機能</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0066cc;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0066cc;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #3399ff;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0066cc;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .success {
            background-color: #d4edda;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #28a745;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0066cc !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e6f2ff;
        }

        /* コードブロック */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }

        .img-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* テーブルスタイル */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ユーザーカードスタイル */
        .user-card {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* アクションボタン */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-crud {
            min-width: 120px;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="../streamlit-sqlmodel/README.html">Streamlit + SQLModel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                        Streamlit + SQLModel チュートリアル
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: データベース設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">Step 3: ユーザー登録機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">Step 4: ユーザー一覧表示</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#step5">Step 5: CRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-security-deployment.html">Step 6: セキュリティとデプロイ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 5: ユーザー詳細・編集・削除機能</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="badge bg-info">所要時間: 3時間</span>
                        </div>
                    </div>
                </div>

                <div id="step5">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">完全なCRUD操作とトランザクション管理</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>サイドバーを使用したナビゲーション設計</li>
                            <li>ユーザー詳細表示画面の実装</li>
                            <li>編集機能とトランザクション管理</li>
                            <li>確認ダイアログ付き削除機能</li>
                            <li>状態管理とページ遷移</li>
                            <li>エラーハンドリングとユーザビリティ向上</li>
                        </ul>
                    </div>

                    <!-- セクション1: CRUD操作の概要 -->
                    <h3 class="section-title">5.1 CRUD操作の設計パターン</h3>
                    <p>完全なCRUD（Create, Read, Update, Delete）操作を実装し、ユーザーがデータを安全かつ直感的に操作できるインターフェースを作成します。</p>

                    <div class="info">
                        <h6>CRUD操作の設計原則</h6>
                        <ul>
                            <li><strong>一貫性</strong>: 各操作で統一されたUI/UXパターン</li>
                            <li><strong>安全性</strong>: 破壊的操作には確認プロセス</li>
                            <li><strong>フィードバック</strong>: 操作結果の明確な通知</li>
                            <li><strong>トランザクション</strong>: データ整合性の保証</li>
                            <li><strong>権限管理</strong>: 適切なアクセス制御</li>
                        </ul>
                    </div>

                    <h4>CRUD操作のユーザビリティ要件</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>操作</th>
                                    <th>主要機能</th>
                                    <th>安全要件</th>
                                    <th>フィードバック</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Create</strong></td>
                                    <td>バリデーション付きフォーム</td>
                                    <td>重複チェック、型検証</td>
                                    <td>成功・エラーメッセージ</td>
                                </tr>
                                <tr>
                                    <td><strong>Read</strong></td>
                                    <td>詳細表示、一覧表示</td>
                                    <td>アクセス権限確認</td>
                                    <td>データ存在確認</td>
                                </tr>
                                <tr>
                                    <td><strong>Update</strong></td>
                                    <td>部分更新、履歴管理</td>
                                    <td>競合検出、バックアップ</td>
                                    <td>変更内容の明示</td>
                                </tr>
                                <tr>
                                    <td><strong>Delete</strong></td>
                                    <td>確認ダイアログ</td>
                                    <td>関連データの整合性</td>
                                    <td>削除不可理由の説明</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- セクション2: 状態管理とナビゲーション -->
                    <h3 class="section-title">5.2 状態管理とナビゲーション設計</h3>
                    
                    <p>複雑なCRUD操作を管理するため、適切な状態管理とナビゲーション機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-1: 状態管理とナビゲーション機能の作成</h5>
                        <p>ユーザー操作のためのナビゲーション機能と状態管理を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>状態管理用のモジュール作成</li>
                            <li>ナビゲーション機能の実装</li>
                            <li>ページ遷移とデータ連携</li>
                            <li>操作履歴の管理</li>
                            <li>エラー状態とリカバリー機能</li>
                        </ol>

                        <h6>app/utils/state_manager.py作成</h6>
                        <pre><code>"""
状態管理機能
アプリケーション状態、ナビゲーション、操作履歴の管理
"""

import streamlit as st
from typing import Dict, Any, Optional, List, Literal
from datetime import datetime
from enum import Enum

class PageState(Enum):
    """ページ状態の定義"""
    HOME = "home"
    USER_LIST = "user_list"
    USER_DETAIL = "user_detail"
    USER_EDIT = "user_edit"
    USER_CREATE = "user_create"
    USER_DELETE = "user_delete"

class OperationType(Enum):
    """操作タイプの定義"""
    CREATE = "create"
    READ = "read"
    UPDATE = "update"
    DELETE = "delete"
    SEARCH = "search"

class AppStateManager:
    """アプリケーション状態管理クラス"""
    
    @staticmethod
    def initialize_state():
        """状態を初期化"""
        if 'current_page' not in st.session_state:
            st.session_state.current_page = PageState.HOME
        
        if 'selected_user_id' not in st.session_state:
            st.session_state.selected_user_id = None
        
        if 'operation_history' not in st.session_state:
            st.session_state.operation_history = []
        
        if 'current_operation' not in st.session_state:
            st.session_state.current_operation = None
        
        if 'form_data' not in st.session_state:
            st.session_state.form_data = {}
        
        if 'navigation_breadcrumb' not in st.session_state:
            st.session_state.navigation_breadcrumb = []
    
    @staticmethod
    def set_page(page: PageState, user_id: Optional[int] = None, **kwargs):
        """ページを設定"""
        # 前のページを履歴に追加
        if hasattr(st.session_state, 'current_page'):
            AppStateManager.add_to_breadcrumb(st.session_state.current_page, st.session_state.selected_user_id)
        
        st.session_state.current_page = page
        st.session_state.selected_user_id = user_id
        
        # 追加パラメータの設定
        for key, value in kwargs.items():
            setattr(st.session_state, key, value)
    
    @staticmethod
    def get_current_page() -> PageState:
        """現在のページを取得"""
        return st.session_state.get('current_page', PageState.HOME)
    
    @staticmethod
    def get_selected_user_id() -> Optional[int]:
        """選択されたユーザーIDを取得"""
        return st.session_state.get('selected_user_id')
    
    @staticmethod
    def add_operation_history(operation: OperationType, description: str, success: bool = True, **details):
        """操作履歴を追加"""
        history_item = {
            'operation': operation,
            'description': description,
            'success': success,
            'timestamp': datetime.now(),
            'user_id': st.session_state.get('selected_user_id'),
            'details': details
        }
        
        st.session_state.operation_history.append(history_item)
        
        # 履歴は最新50件まで保持
        if len(st.session_state.operation_history) > 50:
            st.session_state.operation_history = st.session_state.operation_history[-50:]
    
    @staticmethod
    def get_operation_history(limit: int = 10) -> List[Dict[str, Any]]:
        """操作履歴を取得"""
        history = st.session_state.get('operation_history', [])
        return history[-limit:] if history else []
    
    @staticmethod
    def add_to_breadcrumb(page: PageState, user_id: Optional[int] = None):
        """パンくずリストに追加"""
        breadcrumb_item = {
            'page': page,
            'user_id': user_id,
            'timestamp': datetime.now()
        }
        
        # 重複を避ける
        breadcrumb = st.session_state.get('navigation_breadcrumb', [])
        if not breadcrumb or breadcrumb[-1]['page'] != page:
            breadcrumb.append(breadcrumb_item)
        
        # パンくずは最新10件まで保持
        if len(breadcrumb) > 10:
            breadcrumb = breadcrumb[-10:]
        
        st.session_state.navigation_breadcrumb = breadcrumb
    
    @staticmethod
    def go_back():
        """前のページに戻る"""
        breadcrumb = st.session_state.get('navigation_breadcrumb', [])
        if len(breadcrumb) >= 2:
            # 現在のページを除く前のページに戻る
            previous_page = breadcrumb[-2]
            AppStateManager.set_page(previous_page['page'], previous_page['user_id'])
            # パンくずから現在のページを削除
            st.session_state.navigation_breadcrumb = breadcrumb[:-1]
        else:
            # デフォルトでホームに戻る
            AppStateManager.set_page(PageState.HOME)
    
    @staticmethod
    def clear_form_data():
        """フォームデータをクリア"""
        st.session_state.form_data = {}
    
    @staticmethod
    def save_form_data(data: Dict[str, Any]):
        """フォームデータを保存"""
        st.session_state.form_data.update(data)
    
    @staticmethod
    def get_form_data() -> Dict[str, Any]:
        """フォームデータを取得"""
        return st.session_state.get('form_data', {})

class NavigationManager:
    """ナビゲーション管理クラス"""
    
    @staticmethod
    def show_navigation_sidebar():
        """ナビゲーションサイドバーを表示"""
        current_page = AppStateManager.get_current_page()
        
        st.sidebar.header("📋 ナビゲーション")
        
        # メインメニュー
        main_menu_options = {
            "🏠 ホーム": PageState.HOME,
            "👤 ユーザー登録": PageState.USER_CREATE,
            "👥 ユーザー一覧": PageState.USER_LIST,
        }
        
        for label, page in main_menu_options.items():
            if st.sidebar.button(label, use_container_width=True, type="primary" if current_page == page else "secondary"):
                AppStateManager.set_page(page)
                st.rerun()
        
        st.sidebar.markdown("---")
        
        # 現在のページ情報
        NavigationManager._show_current_page_info()
        
        # パンくずナビゲーション
        NavigationManager._show_breadcrumb()
        
        # 操作履歴
        NavigationManager._show_operation_history()
    
    @staticmethod
    def _show_current_page_info():
        """現在のページ情報を表示"""
        current_page = AppStateManager.get_current_page()
        selected_user_id = AppStateManager.get_selected_user_id()
        
        st.sidebar.subheader("📍 現在の位置")
        
        page_names = {
            PageState.HOME: "ホーム",
            PageState.USER_LIST: "ユーザー一覧",
            PageState.USER_DETAIL: "ユーザー詳細",
            PageState.USER_EDIT: "ユーザー編集",
            PageState.USER_CREATE: "ユーザー登録",
            PageState.USER_DELETE: "ユーザー削除"
        }
        
        page_name = page_names.get(current_page, "不明")
        st.sidebar.write(f"**ページ**: {page_name}")
        
        if selected_user_id:
            st.sidebar.write(f"**ユーザーID**: {selected_user_id}")
    
    @staticmethod
    def _show_breadcrumb():
        """パンくずナビゲーションを表示"""
        breadcrumb = st.session_state.get('navigation_breadcrumb', [])
        
        if len(breadcrumb) > 1:
            st.sidebar.subheader("🧭 履歴")
            
            # 戻るボタン
            if st.sidebar.button("← 戻る", use_container_width=True):
                AppStateManager.go_back()
                st.rerun()
            
            # パンくずリスト
            for i, item in enumerate(breadcrumb[-3:]):  # 最新3件を表示
                page_names = {
                    PageState.HOME: "🏠 ホーム",
                    PageState.USER_LIST: "👥 一覧",
                    PageState.USER_DETAIL: "👤 詳細",
                    PageState.USER_EDIT: "✏️ 編集",
                    PageState.USER_CREATE: "➕ 登録",
                }
                
                page_name = page_names.get(item['page'], "📄 ページ")
                if item['user_id']:
                    page_name += f" (ID:{item['user_id']})"
                
                st.sidebar.caption(f"{i+1}. {page_name}")
    
    @staticmethod
    def _show_operation_history():
        """操作履歴を表示"""
        with st.sidebar.expander("📚 操作履歴"):
            history = AppStateManager.get_operation_history(5)
            
            if not history:
                st.write("履歴はありません")
                return
            
            for item in reversed(history):
                icon = "✅" if item['success'] else "❌"
                time_str = item['timestamp'].strftime("%H:%M")
                st.caption(f"{icon} {time_str} - {item['description']}")

class ConfirmationDialog:
    """確認ダイアログ管理クラス"""
    
    @staticmethod
    def show_delete_confirmation(user_data: Dict[str, Any]) -> bool:
        """削除確認ダイアログを表示"""
        st.warning("⚠️ 削除の確認")
        
        st.markdown(f"""
        以下のユーザーを削除しようとしています：
        
        **ユーザー情報**:
        - **ID**: {user_data.get('id', 'N/A')}
        - **ユーザー名**: {user_data.get('username', 'N/A')}
        - **氏名**: {user_data.get('full_name', 'N/A')}
        - **メールアドレス**: {user_data.get('email', 'N/A')}
        """)
        
        st.error("⚠️ この操作は取り消せません。本当に削除しますか？")
        
        col1, col2, col3 = st.columns([1, 1, 1])
        
        with col1:
            if st.button("❌ キャンセル", use_container_width=True):
                return False
        
        with col2:
            st.write("")  # スペース
        
        with col3:
            # 確認テキスト入力
            confirm_text = st.text_input(
                "削除を確認するため「DELETE」と入力してください:",
                placeholder="DELETE"
            )
            
            delete_confirmed = confirm_text.upper() == "DELETE"
            
            if st.button(
                "🗑️ 削除実行", 
                use_container_width=True, 
                disabled=not delete_confirmed,
                type="primary" if delete_confirmed else "secondary"
            ):
                return True
        
        return False
    
    @staticmethod
    def show_unsaved_changes_warning() -> Literal["save", "discard", "cancel"]:
        """未保存の変更に対する警告"""
        st.warning("⚠️ 未保存の変更があります")
        
        st.markdown("現在のページを離れると、未保存の変更は失われます。")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("💾 保存して続行", use_container_width=True):
                return "save"
        
        with col2:
            if st.button("🗑️ 破棄して続行", use_container_width=True):
                return "discard"
        
        with col3:
            if st.button("❌ キャンセル", use_container_width=True):
                return "cancel"
        
        return "cancel"

# 便利な関数
def initialize_app_state():
    """アプリケーション状態の初期化"""
    AppStateManager.initialize_state()

def navigate_to_user_detail(user_id: int):
    """ユーザー詳細ページへ遷移"""
    AppStateManager.set_page(PageState.USER_DETAIL, user_id)

def navigate_to_user_edit(user_id: int):
    """ユーザー編集ページへ遷移"""
    AppStateManager.set_page(PageState.USER_EDIT, user_id)

def navigate_to_user_list():
    """ユーザー一覧ページへ遷移"""
    AppStateManager.set_page(PageState.USER_LIST)</code></pre>

                        <h6>期待される結果</h6>
                        <p>状態管理とナビゲーション機能が実装され、アプリケーション内の画面遷移が管理されることを確認してください。</p>
                    </div>

                    <!-- セクション3: ユーザー詳細表示 -->
                    <h3 class="section-title">5.3 ユーザー詳細表示機能</h3>
                    
                    <p>選択されたユーザーの詳細情報を表示し、編集・削除のアクションを提供します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-2: ユーザー詳細表示機能の実装</h5>
                        <p>ユーザー詳細表示画面と関連するアクション機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>ユーザー詳細表示コンポーネントの作成</li>
                            <li>詳細情報のレイアウト設計</li>
                            <li>アクションボタンの実装</li>
                            <li>関連データの表示</li>
                            <li>権限に基づく表示制御</li>
                        </ol>

                        <h6>app/components/user_detail.py作成</h6>
                        <pre><code>"""
ユーザー詳細表示コンポーネント
"""

import streamlit as st
from typing import Optional, Dict, Any
from datetime import datetime

from app.database.connection import get_db_session
from app.database.crud import user_crud
from app.models.user import User
from app.utils.state_manager import (
    AppStateManager, NavigationManager, OperationType, PageState
)

class UserDetailView:
    """ユーザー詳細表示クラス"""
    
    @staticmethod
    def show(user_id: int):
        """ユーザー詳細画面を表示"""
        
        # ユーザーデータ取得
        user_data = UserDetailView._get_user_data(user_id)
        
        if not user_data:
            UserDetailView._show_user_not_found(user_id)
            return
        
        # ページヘッダー
        UserDetailView._show_page_header(user_data)
        
        # ユーザー情報表示
        UserDetailView._show_user_information(user_data)
        
        # アクションボタン
        UserDetailView._show_action_buttons(user_data)
        
        # 関連情報
        UserDetailView._show_related_information(user_data)
    
    @staticmethod
    def _get_user_data(user_id: int) -> Optional[User]:
        """ユーザーデータを取得"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            user = user_crud.get_user_by_id(session, user_id)
            session.close()
            
            if user:
                AppStateManager.add_operation_history(
                    OperationType.READ,
                    f"ユーザー詳細表示: {user.username}",
                    success=True
                )
            
            return user
            
        except Exception as e:
            st.error(f"❌ ユーザー情報の取得に失敗しました: {e}")
            AppStateManager.add_operation_history(
                OperationType.READ,
                f"ユーザー詳細表示失敗: ID {user_id}",
                success=False,
                error=str(e)
            )
            return None
    
    @staticmethod
    def _show_user_not_found(user_id: int):
        """ユーザーが見つからない場合の表示"""
        st.error(f"❌ ユーザー（ID: {user_id}）が見つかりません")
        
        col1, col2, col3 = st.columns([1, 2, 1])
        
        with col2:
            st.markdown("""
            **可能な原因:**
            - ユーザーが削除された
            - URLが正しくない
            - データベース接続エラー
            """)
            
            if st.button("👥 ユーザー一覧に戻る", use_container_width=True):
                AppStateManager.set_page(PageState.USER_LIST)
                st.rerun()
    
    @staticmethod
    def _show_page_header(user: User):
        """ページヘッダーを表示"""
        col1, col2 = st.columns([3, 1])
        
        with col1:
            st.title(f"👤 {user.full_name}")
            st.markdown(f"**ユーザー名**: `{user.username}` | **ID**: `{user.id}`")
        
        with col2:
            # ステータスバッジ
            if user.is_active:
                st.success("✅ アクティブ")
            else:
                st.error("❌ 非アクティブ")
    
    @staticmethod
    def _show_user_information(user: User):
        """ユーザー情報を表示"""
        st.markdown("---")
        st.subheader("📋 ユーザー情報")
        
        # 基本情報
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("**基本情報**")
            
            info_data = [
                ("👤 氏名", user.full_name),
                ("🏷️ ユーザー名", user.username),
                ("📧 メールアドレス", user.email),
                ("🎂 年齢", f"{user.age}歳" if user.age else "未設定"),
                ("🏢 部署", user.department or "未設定"),
            ]
            
            for label, value in info_data:
                st.markdown(f"**{label}**: {value}")
        
        with col2:
            st.markdown("**システム情報**")
            
            system_data = [
                ("🆔 ユーザーID", user.id),
                ("📅 作成日時", user.created_at.strftime("%Y-%m-%d %H:%M:%S")),
                ("🔄 更新日時", user.updated_at.strftime("%Y-%m-%d %H:%M:%S")),
                ("⚡ ステータス", "アクティブ" if user.is_active else "非アクティブ"),
            ]
            
            for label, value in system_data:
                st.markdown(f"**{label}**: {value}")
        
        # ユーザーカード表示
        UserDetailView._show_user_card(user)
    
    @staticmethod
    def _show_user_card(user: User):
        """ユーザーカードを表示"""
        with st.container():
            st.markdown("**👤 ユーザーカード**")
            
            card_html = f"""
            <div class="user-card">
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <div style="
                        width: 60px; 
                        height: 60px; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 1.5rem;
                        margin-right: 1rem;
                    ">
                        {user.full_name[0] if user.full_name else '?'}
                    </div>
                    <div>
                        <h3 style="margin: 0; color: #333;">{user.full_name}</h3>
                        <p style="margin: 0; color: #666;">@{user.username}</p>
                        <p style="margin: 0; color: #999; font-size: 0.9rem;">{user.email}</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">
                        <strong>部署:</strong> {user.department or '未設定'}
                    </div>
                    <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">
                        <strong>年齢:</strong> {user.age or '未設定'}
                    </div>
                    <div style="background: {'#d4edda' if user.is_active else '#f8d7da'}; padding: 0.5rem; border-radius: 4px;">
                        <strong>状態:</strong> {'アクティブ' if user.is_active else '非アクティブ'}
                    </div>
                </div>
            </div>
            """
            
            st.markdown(card_html, unsafe_allow_html=True)
    
    @staticmethod
    def _show_action_buttons(user: User):
        """アクションボタンを表示"""
        st.markdown("---")
        st.subheader("🔧 操作")
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            if st.button(
                "✏️ 編集", 
                use_container_width=True, 
                type="primary",
                help="ユーザー情報を編集します"
            ):
                AppStateManager.set_page(PageState.USER_EDIT, user.id)
                st.rerun()
        
        with col2:
            if st.button(
                "🗑️ 削除", 
                use_container_width=True,
                help="ユーザーを削除します（注意: 取り消せません）"
            ):
                AppStateManager.set_page(PageState.USER_DELETE, user.id)
                st.rerun()
        
        with col3:
            if st.button(
                "👥 一覧に戻る", 
                use_container_width=True,
                help="ユーザー一覧ページに戻ります"
            ):
                AppStateManager.set_page(PageState.USER_LIST)
                st.rerun()
        
        with col4:
            # アクティブ/非アクティブ切り替え
            new_status = not user.is_active
            status_text = "アクティブ化" if new_status else "非アクティブ化"
            
            if st.button(
                f"⚡ {status_text}",
                use_container_width=True,
                help=f"ユーザーを{status_text}します"
            ):
                UserDetailView._toggle_user_status(user.id, new_status)
    
    @staticmethod
    def _toggle_user_status(user_id: int, new_status: bool):
        """ユーザーのアクティブ状態を切り替え"""
        try:
            from app.models.user import UserUpdate
            
            session_gen = get_db_session()
            session = next(session_gen)
            
            update_data = UserUpdate(is_active=new_status)
            updated_user = user_crud.update_user(session, user_id, update_data)
            
            if updated_user:
                status_text = "アクティブ" if new_status else "非アクティブ"
                st.success(f"✅ ユーザーを{status_text}に変更しました")
                
                AppStateManager.add_operation_history(
                    OperationType.UPDATE,
                    f"ステータス変更: {updated_user.username} -> {status_text}",
                    success=True
                )
                
                # ページを再読み込み
                st.rerun()
            else:
                st.error("❌ ユーザーの更新に失敗しました")
            
            session.close()
            
        except Exception as e:
            st.error(f"❌ ステータス変更エラー: {e}")
            AppStateManager.add_operation_history(
                OperationType.UPDATE,
                f"ステータス変更失敗: ID {user_id}",
                success=False,
                error=str(e)
            )
    
    @staticmethod
    def _show_related_information(user: User):
        """関連情報を表示"""
        st.markdown("---")
        
        tab1, tab2, tab3 = st.tabs(["📊 統計情報", "📚 操作履歴", "🔗 関連データ"])
        
        with tab1:
            UserDetailView._show_user_statistics(user)
        
        with tab2:
            UserDetailView._show_user_operation_history(user)
        
        with tab3:
            UserDetailView._show_related_data(user)
    
    @staticmethod
    def _show_user_statistics(user: User):
        """ユーザー統計情報を表示"""
        col1, col2, col3 = st.columns(3)
        
        with col1:
            # アカウント作成からの日数
            days_since_creation = (datetime.now() - user.created_at.replace(tzinfo=None)).days
            st.metric("アカウント作成", f"{days_since_creation}日前")
        
        with col2:
            # 最終更新からの日数
            days_since_update = (datetime.now() - user.updated_at.replace(tzinfo=None)).days
            st.metric("最終更新", f"{days_since_update}日前")
        
        with col3:
            # アカウント状態
            st.metric("アカウント状態", "正常" if user.is_active else "停止中")
    
    @staticmethod
    def _show_user_operation_history(user: User):
        """ユーザーの操作履歴を表示"""
        # セッション内の操作履歴を表示
        history = AppStateManager.get_operation_history(10)
        user_history = [h for h in history if h.get('user_id') == user.id]
        
        if not user_history:
            st.info("📝 このセッションでの操作履歴はありません")
            return
        
        st.markdown("**このセッションでの操作:**")
        for item in reversed(user_history):
            icon = "✅" if item['success'] else "❌"
            time_str = item['timestamp'].strftime("%H:%M:%S")
            st.markdown(f"{icon} **{time_str}** - {item['description']}")
    
    @staticmethod
    def _show_related_data(user: User):
        """関連データを表示"""
        st.markdown("**🔗 関連情報**")
        
        # 今後の拡張用のプレースホルダー
        st.info("📋 関連データ機能は今後のステップで実装予定です")
        
        # 部署内の他のユーザーなどを表示予定
        if user.department:
            st.markdown(f"**同じ部署 ({user.department}) のユーザー**: 実装予定")
        
        # ユーザーアクティビティログなど
        st.markdown("**アクティビティログ**: 実装予定")</code></pre>

                        <h6>期待される結果</h6>
                        <p>ユーザー詳細表示機能が実装され、ユーザー情報の表示とアクションボタンが正常に動作することを確認してください。</p>
                    </div>

                    <!-- セクション4: ユーザー編集機能 -->
                    <h3 class="section-title">5.4 ユーザー編集機能の実装</h3>
                    
                    <p>既存ユーザーの情報を安全に編集するための機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-3: ユーザー編集機能の作成</h5>
                        <p>フォームバリデーション付きのユーザー編集機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>編集フォームコンポーネントの作成</li>
                            <li>既存データの事前入力</li>
                            <li>変更検出と差分表示</li>
                            <li>バリデーションとエラーハンドリング</li>
                            <li>トランザクション管理</li>
                        </ol>

                        <h6>app/components/user_edit.py作成</h6>
                        <pre><code>"""
ユーザー編集コンポーネント
"""

import streamlit as st
from typing import Optional, Dict, Any
import copy

from app.database.connection import get_db_session
from app.database.crud import user_crud
from app.models.user import User, UserUpdate
from app.utils.validators import (
    UserValidator, StreamlitValidationHelper, get_valid_departments
)
from app.utils.state_manager import (
    AppStateManager, OperationType, PageState, ConfirmationDialog
)

class UserEditView:
    """ユーザー編集表示クラス"""
    
    @staticmethod
    def show(user_id: int):
        """ユーザー編集画面を表示"""
        
        # ユーザーデータ取得
        user_data = UserEditView._get_user_data(user_id)
        
        if not user_data:
            UserEditView._show_user_not_found(user_id)
            return
        
        # ページヘッダー
        UserEditView._show_page_header(user_data)
        
        # 編集フォーム
        UserEditView._show_edit_form(user_data)
    
    @staticmethod
    def _get_user_data(user_id: int) -> Optional[User]:
        """ユーザーデータを取得"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            user = user_crud.get_user_by_id(session, user_id)
            session.close()
            
            return user
            
        except Exception as e:
            st.error(f"❌ ユーザー情報の取得に失敗しました: {e}")
            return None
    
    @staticmethod
    def _show_user_not_found(user_id: int):
        """ユーザーが見つからない場合の表示"""
        st.error(f"❌ 編集対象のユーザー（ID: {user_id}）が見つかりません")
        
        if st.button("👥 ユーザー一覧に戻る"):
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    
    @staticmethod
    def _show_page_header(user: User):
        """ページヘッダーを表示"""
        col1, col2 = st.columns([3, 1])
        
        with col1:
            st.title(f"✏️ ユーザー編集: {user.full_name}")
            st.markdown(f"**ユーザー名**: `{user.username}` | **ID**: `{user.id}`")
        
        with col2:
            if st.button("❌ キャンセル", use_container_width=True):
                AppStateManager.set_page(PageState.USER_DETAIL, user.id)
                st.rerun()
    
    @staticmethod
    def _show_edit_form(user: User):
        """編集フォームを表示"""
        st.markdown("---")
        st.subheader("📝 ユーザー情報編集")
        
        # 未保存の変更があるかチェック
        has_unsaved_changes = UserEditView._has_unsaved_changes(user)
        
        if has_unsaved_changes:
            st.warning("⚠️ 未保存の変更があります")
        
        # 元のデータを保持
        original_data = {
            'username': user.username,
            'email': user.email,
            'full_name': user.full_name,
            'age': user.age,
            'department': user.department,
            'is_active': user.is_active
        }
        
        # フォーム作成
        with st.form("user_edit_form", clear_on_submit=False):
            st.markdown("### 基本情報の編集")
            
            # 2カラムレイアウト
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("**基本情報**")
                
                username = st.text_input(
                    "ユーザー名 *",
                    value=user.username,
                    help="ユーザー名は一意である必要があります"
                )
                
                email = st.text_input(
                    "メールアドレス *",
                    value=user.email,
                    help="有効なメールアドレスを入力してください"
                )
                
                full_name = st.text_input(
                    "氏名 *",
                    value=user.full_name,
                    help="フルネームを入力してください"
                )
            
            with col2:
                st.markdown("**追加情報**")
                
                age = st.number_input(
                    "年齢",
                    min_value=0,
                    max_value=150,
                    value=user.age if user.age is not None else None,
                    help="年齢を入力してください（任意）"
                )
                
                departments = get_valid_departments()
                current_dept_index = 0
                if user.department and user.department in departments:
                    current_dept_index = departments.index(user.department) + 1
                
                department = st.selectbox(
                    "部署",
                    options=[""] + departments,
                    index=current_dept_index,
                    help="所属部署を選択してください（任意）"
                )
                
                is_active = st.checkbox(
                    "アクティブ状態",
                    value=user.is_active,
                    help="ユーザーのアクティブ状態"
                )
            
            # 変更内容の表示
            new_data = {
                'username': username.strip() if username else '',
                'email': email.strip().lower() if email else '',
                'full_name': full_name.strip() if full_name else '',
                'age': age if age is not None and age > 0 else None,
                'department': department.strip() if department else None,
                'is_active': is_active
            }
            
            # 変更検出
            changes = UserEditView._detect_changes(original_data, new_data)
            
            if changes:
                st.markdown("### 🔄 変更内容")
                UserEditView._show_changes(changes)
            
            # 送信ボタン
            st.markdown("---")
            col_left, col_center, col_right = st.columns([1, 2, 1])
            
            with col_center:
                submitted = st.form_submit_button(
                    "💾 変更を保存",
                    use_container_width=True,
                    type="primary",
                    disabled=not changes
                )
        
        # フォーム送信処理
        if submitted and changes:
            UserEditView._process_form_submission(user.id, new_data, changes)
    
    @staticmethod
    def _has_unsaved_changes(user: User) -> bool:
        """未保存の変更があるかチェック"""
        form_data = AppStateManager.get_form_data()
        return bool(form_data.get('has_changes', False))
    
    @staticmethod
    def _detect_changes(original: Dict[str, Any], new: Dict[str, Any]) -> Dict[str, Dict[str, Any]]:
        """変更を検出"""
        changes = {}
        
        for key, new_value in new.items():
            old_value = original.get(key)
            
            # None と空文字列の正規化
            if old_value == '' and new_value is None:
                continue
            if old_value is None and new_value == '':
                continue
            
            if old_value != new_value:
                changes[key] = {
                    'old': old_value,
                    'new': new_value
                }
        
        return changes
    
    @staticmethod
    def _show_changes(changes: Dict[str, Dict[str, Any]]):
        """変更内容を表示"""
        field_names = {
            'username': 'ユーザー名',
            'email': 'メールアドレス',
            'full_name': '氏名',
            'age': '年齢',
            'department': '部署',
            'is_active': 'ステータス'
        }
        
        for field, change in changes.items():
            field_name = field_names.get(field, field)
            old_value = change['old'] if change['old'] is not None else '未設定'
            new_value = change['new'] if change['new'] is not None else '未設定'
            
            if field == 'is_active':
                old_value = 'アクティブ' if change['old'] else '非アクティブ'
                new_value = 'アクティブ' if change['new'] else '非アクティブ'
            
            st.markdown(f"**{field_name}**: `{old_value}` → `{new_value}`")
    
    @staticmethod
    def _process_form_submission(user_id: int, form_data: Dict[str, Any], changes: Dict[str, Dict[str, Any]]):
        """フォーム送信処理"""
        
        # バリデーション実行
        if not StreamlitValidationHelper.validate_and_show_errors(form_data):
            return
        
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            # 更新データの準備（変更された項目のみ）
            update_data = {}
            for field, change in changes.items():
                update_data[field] = change['new']
            
            # UserUpdateモデルを作成
            user_update = UserUpdate(**update_data)
            
            # ユーザー更新
            updated_user = user_crud.update_user(session, user_id, user_update)
            
            if updated_user:
                # 成功メッセージ
                st.success(f"✅ ユーザー '{updated_user.username}' の情報を更新しました！")
                
                # 操作履歴に記録
                change_summary = ", ".join([
                    f"{k}: {v['old']} → {v['new']}" for k, v in changes.items()
                ])
                
                AppStateManager.add_operation_history(
                    OperationType.UPDATE,
                    f"ユーザー情報更新: {updated_user.username}",
                    success=True,
                    changes=change_summary
                )
                
                # フォームデータクリア
                AppStateManager.clear_form_data()
                
                # 詳細ページにリダイレクト
                st.info("💡 3秒後にユーザー詳細ページに移動します...")
                
                # JavaScript を使用した自動リダイレクト
                st.markdown("""
                <script>
                setTimeout(function(){
                    window.location.reload();
                }, 3000);
                </script>
                """, unsafe_allow_html=True)
                
                # 手動での遷移ボタン
                if st.button("📋 今すぐ詳細ページに移動"):
                    AppStateManager.set_page(PageState.USER_DETAIL, user_id)
                    st.rerun()
            
            session.close()
            
        except ValueError as e:
            st.error(f"❌ 更新エラー: {e}")
            AppStateManager.add_operation_history(
                OperationType.UPDATE,
                f"ユーザー更新失敗: ID {user_id}",
                success=False,
                error=str(e)
            )
        except Exception as e:
            st.error(f"❌ 予期しないエラーが発生しました: {e}")
            AppStateManager.add_operation_history(
                OperationType.UPDATE,
                f"ユーザー更新失敗: ID {user_id}",
                success=False,
                error=str(e)
            )

class UserDeleteView:
    """ユーザー削除表示クラス"""
    
    @staticmethod
    def show(user_id: int):
        """ユーザー削除確認画面を表示"""
        
        # ユーザーデータ取得
        user_data = UserDeleteView._get_user_data(user_id)
        
        if not user_data:
            UserDeleteView._show_user_not_found(user_id)
            return
        
        # ページヘッダー
        UserDeleteView._show_page_header(user_data)
        
        # 削除確認
        UserDeleteView._show_delete_confirmation(user_data)
    
    @staticmethod
    def _get_user_data(user_id: int) -> Optional[User]:
        """ユーザーデータを取得"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            user = user_crud.get_user_by_id(session, user_id)
            session.close()
            
            return user
            
        except Exception as e:
            st.error(f"❌ ユーザー情報の取得に失敗しました: {e}")
            return None
    
    @staticmethod
    def _show_user_not_found(user_id: int):
        """ユーザーが見つからない場合の表示"""
        st.error(f"❌ 削除対象のユーザー（ID: {user_id}）が見つかりません")
        
        if st.button("👥 ユーザー一覧に戻る"):
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    
    @staticmethod
    def _show_page_header(user: User):
        """ページヘッダーを表示"""
        st.title(f"🗑️ ユーザー削除確認")
        st.markdown(f"**対象ユーザー**: {user.full_name} (`{user.username}`)")
    
    @staticmethod
    def _show_delete_confirmation(user: User):
        """削除確認を表示"""
        st.markdown("---")
        
        # ユーザー情報を dict に変換
        user_dict = {
            'id': user.id,
            'username': user.username,
            'full_name': user.full_name,
            'email': user.email
        }
        
        # 確認ダイアログ表示
        if ConfirmationDialog.show_delete_confirmation(user_dict):
            UserDeleteView._process_delete(user)
        
        # キャンセルボタン（独立）
        st.markdown("---")
        if st.button("🔙 削除をキャンセルして詳細ページに戻る", use_container_width=True):
            AppStateManager.set_page(PageState.USER_DETAIL, user.id)
            st.rerun()
    
    @staticmethod
    def _process_delete(user: User):
        """削除処理を実行"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            # ユーザー削除
            delete_success = user_crud.delete_user(session, user.id)
            
            if delete_success:
                st.success(f"✅ ユーザー '{user.username}' を削除しました")
                
                # 操作履歴に記録
                AppStateManager.add_operation_history(
                    OperationType.DELETE,
                    f"ユーザー削除: {user.username}",
                    success=True
                )
                
                # 3秒後にユーザー一覧に移動
                st.info("💡 3秒後にユーザー一覧ページに移動します...")
                
                if st.button("👥 今すぐユーザー一覧に移動"):
                    AppStateManager.set_page(PageState.USER_LIST)
                    st.rerun()
            else:
                st.error("❌ ユーザーの削除に失敗しました")
            
            session.close()
            
        except Exception as e:
            st.error(f"❌ 削除処理中にエラーが発生しました: {e}")
            AppStateManager.add_operation_history(
                OperationType.DELETE,
                f"ユーザー削除失敗: {user.username}",
                success=False,
                error=str(e)
            )</code></pre>

                        <h6>期待される結果</h6>
                        <p>ユーザー編集機能と削除機能が実装され、適切なバリデーションと確認プロセスが動作することを確認してください。</p>
                    </div>

                    <!-- セクション5: メインアプリケーション統合 -->
                    <h3 class="section-title">5.5 メインアプリケーションへの統合</h3>
                    
                    <p>作成したCRUD機能をメインアプリケーションに統合します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-4: CRUD機能の統合とテスト</h5>
                        <p>すべてのCRUD機能をメインアプリケーションに統合し、動作確認を行います。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>メインアプリケーションの更新</li>
                            <li>ページルーティングの実装</li>
                            <li>状態管理の統合</li>
                            <li>エラーハンドリングの強化</li>
                            <li>総合テストの実行</li>
                        </ol>

                        <h6>app/main.py 最終更新版</h6>
                        <pre><code>"""
Modern User Management Dashboard
完全なCRUD機能付きメインアプリケーション
"""

import streamlit as st
import sys
import os

# プロジェクトルートをPythonパスに追加
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from config import settings
from database.connection import init_database
from utils.state_manager import (
    AppStateManager, NavigationManager, PageState, initialize_app_state
)
from components.user_detail import UserDetailView
from components.user_edit import UserEditView, UserDeleteView

# 既存のインポート
from utils.data_manager import DataManager, DisplayHelper
from utils.search_manager import SearchManager, AdvancedFilter
from utils.validators import get_valid_departments, StreamlitValidationHelper
from utils.helpers import UIHelper, SessionManager, NotificationManager
from database.crud import user_crud
from models.user import UserCreate
from database.connection import get_db_session

def initialize_app():
    """アプリケーションの初期化"""
    if 'app_initialized' not in st.session_state:
        try:
            # データベース初期化
            init_database()
            st.session_state.app_initialized = True
            st.session_state.initialization_success = True
        except Exception as e:
            st.session_state.app_initialized = True
            st.session_state.initialization_success = False
            st.session_state.initialization_error = str(e)

def main():
    """メインアプリケーション"""
    
    # ページ設定
    st.set_page_config(
        page_title=settings.APP_NAME,
        page_icon="👥",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # 状態管理初期化
    initialize_app_state()
    
    # アプリケーション初期化
    initialize_app()
    
    # セッション管理初期化
    SessionManager.initialize_session()
    
    # 初期化失敗時のエラー表示
    if not st.session_state.get('initialization_success', False):
        st.error("❌ データベースの初期化に失敗しました")
        if 'initialization_error' in st.session_state:
            st.error(f"エラー詳細: {st.session_state.initialization_error}")
        st.stop()
    
    # ナビゲーションサイドバー
    NavigationManager.show_navigation_sidebar()
    
    # メインコンテンツのルーティング
    current_page = AppStateManager.get_current_page()
    
    if current_page == PageState.HOME:
        show_home_page()
    elif current_page == PageState.USER_CREATE:
        show_user_registration_form()
    elif current_page == PageState.USER_LIST:
        show_user_list()
    elif current_page == PageState.USER_DETAIL:
        user_id = AppStateManager.get_selected_user_id()
        if user_id:
            UserDetailView.show(user_id)
        else:
            st.error("❌ ユーザーIDが指定されていません")
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    elif current_page == PageState.USER_EDIT:
        user_id = AppStateManager.get_selected_user_id()
        if user_id:
            UserEditView.show(user_id)
        else:
            st.error("❌ 編集対象のユーザーIDが指定されていません")
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    elif current_page == PageState.USER_DELETE:
        user_id = AppStateManager.get_selected_user_id()
        if user_id:
            UserDeleteView.show(user_id)
        else:
            st.error("❌ 削除対象のユーザーIDが指定されていません")
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    else:
        st.error(f"❌ 不明なページ: {current_page}")
        AppStateManager.set_page(PageState.HOME)
        st.rerun()
    
    # 通知表示
    NotificationManager.show_notifications()
    
    # フッター
    show_footer()

def show_home_page():
    """ホームページを表示"""
    st.title(f"👥 {settings.APP_NAME}")
    st.markdown(f"**Version:** {settings.APP_VERSION}")
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("""
        ## 🎯 Streamlit + SQLModel チュートリアル
        
        このアプリケーションは、**Streamlit** と **SQLModel** を使用した
        モダンなユーザー管理システムの完全な実装です。
        
        ### 実装済み機能:
        - ✅ **ユーザー登録**: バリデーション付きの新規登録
        - ✅ **ユーザー一覧**: 検索・フィルタリング機能
        - ✅ **ユーザー詳細**: 詳細情報表示
        - ✅ **ユーザー編集**: 安全な情報更新
        - ✅ **ユーザー削除**: 確認ダイアログ付き削除
        - ✅ **状態管理**: セッション管理とナビゲーション
        - ✅ **データ管理**: PostgreSQLでの永続化
        - ✅ **エラーハンドリング**: 包括的なエラー処理
        """)
        
        # クイックアクション
        st.markdown("### 🚀 クイックアクション")
        
        action_col1, action_col2, action_col3 = st.columns(3)
        
        with action_col1:
            if st.button("👤 新規ユーザー登録", use_container_width=True, type="primary"):
                AppStateManager.set_page(PageState.USER_CREATE)
                st.rerun()
        
        with action_col2:
            if st.button("👥 ユーザー一覧表示", use_container_width=True):
                AppStateManager.set_page(PageState.USER_LIST)
                st.rerun()
        
        with action_col3:
            # 統計情報表示
            stats = DataManager.get_user_statistics()
            total_users = stats.get('total_users', 0)
            st.metric("登録ユーザー数", total_users)
    
    with col2:
        st.subheader("📈 チュートリアル進行状況")
        
        progress_steps = [
            ("✅ Step 1: 環境構築", True),
            ("✅ Step 2: データベース設計", True),
            ("✅ Step 3: ユーザー登録機能", True),
            ("✅ Step 4: ユーザー一覧表示", True),
            ("✅ Step 5: CRUD操作", True),
            ("⏳ Step 6: セキュリティとデプロイ", False)
        ]
        
        for step, completed in progress_steps:
            if completed:
                st.success(step)
            else:
                st.info(step)
        
        # 進行率
        completed_count = sum(1 for _, completed in progress_steps if completed)
        progress_rate = completed_count / len(progress_steps)
        st.progress(progress_rate)
        st.caption(f"進行率: {progress_rate*100:.0f}% ({completed_count}/{len(progress_steps)})")

# 既存の関数（show_user_registration_form, show_user_list など）をそのまま使用
# ... [前回までのコードを継続使用]

def show_footer():
    """フッターを表示"""
    st.markdown("---")
    
    footer_col1, footer_col2, footer_col3 = st.columns(3)
    
    with footer_col1:
        st.markdown("**🔧 システム情報**")
        st.caption(f"Database: PostgreSQL")
        st.caption(f"Framework: Streamlit {st.__version__}")
    
    with footer_col2:
        st.markdown("**📊 統計**")
        # セッション統計
        history_count = len(AppStateManager.get_operation_history())
        st.caption(f"操作履歴: {history_count}件")
        
        reg_count = len(SessionManager.get_registration_history())
        st.caption(f"セッション登録: {reg_count}件")
    
    with footer_col3:
        st.markdown("**ℹ️ 情報**")
        st.caption("Streamlit + SQLModel チュートリアル")
        st.caption("Step 5: CRUD操作完了 ✅")

if __name__ == "__main__":
    main()</code></pre>

                        <h6>アプリケーションの動作確認</h6>
                        <pre><code># アプリケーション起動
streamlit run app/main.py

# または WSL2 環境
streamlit run app/main.py --server.address 0.0.0.0</code></pre>

                        <h6>総合テストチェックリスト</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>機能</th>
                                        <th>テスト項目</th>
                                        <th>確認ポイント</th>
                                        <th>期待される結果</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>ナビゲーション</strong></td>
                                        <td>ページ間の遷移</td>
                                        <td>サイドバーとボタン</td>
                                        <td>スムーズな画面遷移</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ユーザー登録</strong></td>
                                        <td>新規ユーザー作成</td>
                                        <td>バリデーションとエラー</td>
                                        <td>正常登録と適切なエラー表示</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ユーザー一覧</strong></td>
                                        <td>検索とフィルタリング</td>
                                        <td>データ表示とパフォーマンス</td>
                                        <td>高速な検索と正確な結果</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ユーザー詳細</strong></td>
                                        <td>詳細情報表示</td>
                                        <td>データの正確性</td>
                                        <td>完全な情報表示</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ユーザー編集</strong></td>
                                        <td>情報更新と変更検出</td>
                                        <td>トランザクション安全性</td>
                                        <td>確実な更新と履歴記録</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ユーザー削除</strong></td>
                                        <td>確認プロセス</td>
                                        <td>安全性とユーザビリティ</td>
                                        <td>安全な削除とキャンセル機能</td>
                                    </tr>
                                    <tr>
                                        <td><strong>状態管理</strong></td>
                                        <td>セッション永続性</td>
                                        <td>データの一貫性</td>
                                        <td>画面遷移でのデータ保持</td>
                                    </tr>
                                    <tr>
                                        <td><strong>エラーハンドリング</strong></td>
                                        <td>異常系の処理</td>
                                        <td>ユーザーフィードバック</td>
                                        <td>明確なエラーメッセージ</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h6>期待される結果</h6>
                        <p>完全なCRUD機能が統合され、すべての操作が安全かつ直感的に実行できることを確認してください。</p>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>CRUD操作</strong>における<strong>トランザクション管理</strong>の重要性を説明してください。</li>
                            <li><strong>状態管理</strong>で<strong>セッション状態</strong>と<strong>アプリケーション状態</strong>の違いを説明してください。</li>
                            <li><strong>確認ダイアログ</strong>が必要な操作の種類を3つ挙げ、その理由を説明してください。</li>
                            <li><strong>ナビゲーション設計</strong>でユーザビリティを向上させる要素を4つ挙げてください。</li>
                            <li><strong>編集機能</strong>で<strong>変更検出</strong>を実装する利点を3つ挙げてください。</li>
                            <li><strong>エラーハンドリング</strong>でユーザー体験を向上させる方法を3つ挙げてください。</li>
                            <li><strong>データベース操作</strong>で<strong>楽観的ロック</strong>と<strong>悲観的ロック</strong>の違いを説明してください。</li>
                            <li><strong>Streamlitアプリ</strong>で<strong>ページ遷移</strong>を実装する際の注意点を3つ挙げてください。</li>
                        </ol>
                        
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>データの整合性保証、部分更新の回避、エラー時の自動ロールバック、複数テーブル操作の一貫性</li>
                                <li>セッション状態はブラウザセッション内のデータ、アプリケーション状態は永続化された全体の状態</li>
                                <li>削除操作（取り消し不可）、大量データ変更（影響範囲が大きい）、設定変更（システム動作に影響）</li>
                                <li>パンくずナビゲーション、戻るボタン、現在位置表示、直感的なメニュー構造</li>
                                <li>不要な更新の回避、変更内容の明示、操作履歴の記録、ユーザー確認の促進</li>
                                <li>明確なエラーメッセージ、回復方法の提示、エラー発生箇所の特定、ログ記録による追跡</li>
                                <li>楽観的：競合チェックは更新時、悲観的：データ取得時にロック。パフォーマンスvsデータ安全性</li>
                                <li>状態の適切な管理、st.rerun()の適切な使用、ユーザーデータの保持、パフォーマンスの考慮</li>
                            </ol>
                        </details>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">5.6 Step 5のまとめ</h3>
                    
                    <div class="highlight">
                        <h5>Step 5で習得したスキル</h5>
                        <ul>
                            <li>完全なCRUD操作の実装パターン</li>
                            <li>状態管理とナビゲーション設計</li>
                            <li>ユーザー詳細表示とアクション機能</li>
                            <li>安全な編集機能とトランザクション管理</li>
                            <li>確認ダイアログ付きの削除機能</li>
                            <li>操作履歴とセッション管理</li>
                            <li>包括的なエラーハンドリング</li>
                            <li>エンタープライズレベルのUI/UX設計</li>
                        </ul>
                    </div>

                    <div class="success">
                        <h6>🎉 CRUD機能完成！</h6>
                        <p>これでStreamlit + SQLModelを使用した完全なユーザー管理システムのCRUD機能が完成しました。以下の機能が全て実装されています：</p>
                        <ul>
                            <li>✅ <strong>Create</strong>: バリデーション付きユーザー登録</li>
                            <li>✅ <strong>Read</strong>: 一覧表示・詳細表示・検索機能</li>
                            <li>✅ <strong>Update</strong>: 安全な編集機能</li>
                            <li>✅ <strong>Delete</strong>: 確認ダイアログ付き削除</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>次のStepに進む前に確認すること</h6>
                        <ul>
                            <li>✅ 全てのCRUD操作が正常に動作する</li>
                            <li>✅ ナビゲーションが適切に機能する</li>
                            <li>✅ 状態管理が正しく実装されている</li>
                            <li>✅ エラーハンドリングが適切である</li>
                            <li>✅ 確認ダイアログが機能する</li>
                            <li>✅ 操作履歴が記録される</li>
                            <li>✅ トランザクション管理が適切である</li>
                            <li>✅ ユーザビリティが良好である</li>
                        </ul>
                    </div>

                    <div class="info">
                        <h6>発展的な学習のヒント</h6>
                        <ul>
                            <li><strong>権限管理</strong>: ロールベースアクセス制御（RBAC）</li>
                            <li><strong>監査ログ</strong>: 操作履歴の永続化と分析</li>
                            <li><strong>バッチ操作</strong>: 複数レコードの一括処理</li>
                            <li><strong>データ検証</strong>: より高度なビジネスロジック検証</li>
                            <li><strong>パフォーマンス</strong>: 大量データ処理の最適化</li>
                        </ul>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step4-user-list-display.html" class="btn btn-secondary">← Step 4: ユーザー一覧表示</a>
                        <a href="step6-security-deployment.html" class="btn btn-primary">Step 6: セキュリティとデプロイ →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>