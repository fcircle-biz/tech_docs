<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« Step 5 - ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ»ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .navbar {
            background-color: #0066cc;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ« */
        .chapter-title {
            color: #0066cc;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #3399ff;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒœãƒƒã‚¯ã‚¹ */
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0066cc;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .success {
            background-color: #d4edda;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #28a745;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav-link.active {
            background-color: #0066cc !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e6f2ff;
        }

        /* ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }

        .img-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .user-card {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-crud {
            min-width: 120px;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ãƒ›ãƒ¼ãƒ </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="../streamlit-sqlmodel/README.html">Streamlit + SQLModel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                        Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: ç’°å¢ƒæ§‹ç¯‰</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#step5">Step 5: CRUDæ“ä½œ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-security-deployment.html">Step 6: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- ç« ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 5: ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ»ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="badge bg-info">æ‰€è¦æ™‚é–“: 3æ™‚é–“</span>
                        </div>
                    </div>
                </div>

                <div id="step5">
                    <!-- ç« ã‚¿ã‚¤ãƒˆãƒ« -->
                    <h2 class="chapter-title">å®Œå…¨ãªCRUDæ“ä½œã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</h2>
                    
                    <!-- å­¦ç¿’ç›®æ¨™ -->
                    <div class="highlight">
                        <h5>ã“ã®ç« ã§å­¦ã¶ã“ã¨</h5>
                        <ul>
                            <li>ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ä½¿ç”¨ã—ãŸãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ</li>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºç”»é¢ã®å®Ÿè£…</li>
                            <li>ç·¨é›†æ©Ÿèƒ½ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</li>
                            <li>ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãå‰Šé™¤æ©Ÿèƒ½</li>
                            <li>çŠ¶æ…‹ç®¡ç†ã¨ãƒšãƒ¼ã‚¸é·ç§»</li>
                            <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š</li>
                        </ul>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: CRUDæ“ä½œã®æ¦‚è¦ -->
                    <h3 class="section-title">5.1 CRUDæ“ä½œã®è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
                    <p>å®Œå…¨ãªCRUDï¼ˆCreate, Read, Update, Deleteï¼‰æ“ä½œã‚’å®Ÿè£…ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã‹ã¤ç›´æ„Ÿçš„ã«æ“ä½œã§ãã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚</p>

                    <div class="info">
                        <h6>CRUDæ“ä½œã®è¨­è¨ˆåŸå‰‡</h6>
                        <ul>
                            <li><strong>ä¸€è²«æ€§</strong>: å„æ“ä½œã§çµ±ä¸€ã•ã‚ŒãŸUI/UXãƒ‘ã‚¿ãƒ¼ãƒ³</li>
                            <li><strong>å®‰å…¨æ€§</strong>: ç ´å£Šçš„æ“ä½œã«ã¯ç¢ºèªãƒ—ãƒ­ã‚»ã‚¹</li>
                            <li><strong>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</strong>: æ“ä½œçµæœã®æ˜ç¢ºãªé€šçŸ¥</li>
                            <li><strong>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³</strong>: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼</li>
                            <li><strong>æ¨©é™ç®¡ç†</strong>: é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡</li>
                        </ul>
                    </div>

                    <h4>CRUDæ“ä½œã®ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£è¦ä»¶</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>æ“ä½œ</th>
                                    <th>ä¸»è¦æ©Ÿèƒ½</th>
                                    <th>å®‰å…¨è¦ä»¶</th>
                                    <th>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Create</strong></td>
                                    <td>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ããƒ•ã‚©ãƒ¼ãƒ </td>
                                    <td>é‡è¤‡ãƒã‚§ãƒƒã‚¯ã€å‹æ¤œè¨¼</td>
                                    <td>æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</td>
                                </tr>
                                <tr>
                                    <td><strong>Read</strong></td>
                                    <td>è©³ç´°è¡¨ç¤ºã€ä¸€è¦§è¡¨ç¤º</td>
                                    <td>ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèª</td>
                                    <td>ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèª</td>
                                </tr>
                                <tr>
                                    <td><strong>Update</strong></td>
                                    <td>éƒ¨åˆ†æ›´æ–°ã€å±¥æ­´ç®¡ç†</td>
                                    <td>ç«¶åˆæ¤œå‡ºã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</td>
                                    <td>å¤‰æ›´å†…å®¹ã®æ˜ç¤º</td>
                                </tr>
                                <tr>
                                    <td><strong>Delete</strong></td>
                                    <td>ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°</td>
                                    <td>é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§</td>
                                    <td>å‰Šé™¤ä¸å¯ç†ç”±ã®èª¬æ˜</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: çŠ¶æ…‹ç®¡ç†ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <h3 class="section-title">5.2 çŠ¶æ…‹ç®¡ç†ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ</h3>
                    
                    <p>è¤‡é›‘ãªCRUDæ“ä½œã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€é©åˆ‡ãªçŠ¶æ…‹ç®¡ç†ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 5-1: çŠ¶æ…‹ç®¡ç†ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®ä½œæˆ</h5>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ãŸã‚ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã¨çŠ¶æ…‹ç®¡ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>çŠ¶æ…‹ç®¡ç†ç”¨ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ</li>
                            <li>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>ãƒšãƒ¼ã‚¸é·ç§»ã¨ãƒ‡ãƒ¼ã‚¿é€£æº</li>
                            <li>æ“ä½œå±¥æ­´ã®ç®¡ç†</li>
                            <li>ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã¨ãƒªã‚«ãƒãƒªãƒ¼æ©Ÿèƒ½</li>
                        </ol>

                        <h6>app/utils/state_manager.pyä½œæˆ</h6>
                        <pre><code>"""
çŠ¶æ…‹ç®¡ç†æ©Ÿèƒ½
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€æ“ä½œå±¥æ­´ã®ç®¡ç†
"""

import streamlit as st
from typing import Dict, Any, Optional, List, Literal
from datetime import datetime
from enum import Enum

class PageState(Enum):
    """ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã®å®šç¾©"""
    HOME = "home"
    USER_LIST = "user_list"
    USER_DETAIL = "user_detail"
    USER_EDIT = "user_edit"
    USER_CREATE = "user_create"
    USER_DELETE = "user_delete"

class OperationType(Enum):
    """æ“ä½œã‚¿ã‚¤ãƒ—ã®å®šç¾©"""
    CREATE = "create"
    READ = "read"
    UPDATE = "update"
    DELETE = "delete"
    SEARCH = "search"

class AppStateManager:
    """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def initialize_state():
        """çŠ¶æ…‹ã‚’åˆæœŸåŒ–"""
        if 'current_page' not in st.session_state:
            st.session_state.current_page = PageState.HOME
        
        if 'selected_user_id' not in st.session_state:
            st.session_state.selected_user_id = None
        
        if 'operation_history' not in st.session_state:
            st.session_state.operation_history = []
        
        if 'current_operation' not in st.session_state:
            st.session_state.current_operation = None
        
        if 'form_data' not in st.session_state:
            st.session_state.form_data = {}
        
        if 'navigation_breadcrumb' not in st.session_state:
            st.session_state.navigation_breadcrumb = []
    
    @staticmethod
    def set_page(page: PageState, user_id: Optional[int] = None, **kwargs):
        """ãƒšãƒ¼ã‚¸ã‚’è¨­å®š"""
        # å‰ã®ãƒšãƒ¼ã‚¸ã‚’å±¥æ­´ã«è¿½åŠ 
        if hasattr(st.session_state, 'current_page'):
            AppStateManager.add_to_breadcrumb(st.session_state.current_page, st.session_state.selected_user_id)
        
        st.session_state.current_page = page
        st.session_state.selected_user_id = user_id
        
        # è¿½åŠ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­å®š
        for key, value in kwargs.items():
            setattr(st.session_state, key, value)
    
    @staticmethod
    def get_current_page() -> PageState:
        """ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—"""
        return st.session_state.get('current_page', PageState.HOME)
    
    @staticmethod
    def get_selected_user_id() -> Optional[int]:
        """é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—"""
        return st.session_state.get('selected_user_id')
    
    @staticmethod
    def add_operation_history(operation: OperationType, description: str, success: bool = True, **details):
        """æ“ä½œå±¥æ­´ã‚’è¿½åŠ """
        history_item = {
            'operation': operation,
            'description': description,
            'success': success,
            'timestamp': datetime.now(),
            'user_id': st.session_state.get('selected_user_id'),
            'details': details
        }
        
        st.session_state.operation_history.append(history_item)
        
        # å±¥æ­´ã¯æœ€æ–°50ä»¶ã¾ã§ä¿æŒ
        if len(st.session_state.operation_history) > 50:
            st.session_state.operation_history = st.session_state.operation_history[-50:]
    
    @staticmethod
    def get_operation_history(limit: int = 10) -> List[Dict[str, Any]]:
        """æ“ä½œå±¥æ­´ã‚’å–å¾—"""
        history = st.session_state.get('operation_history', [])
        return history[-limit:] if history else []
    
    @staticmethod
    def add_to_breadcrumb(page: PageState, user_id: Optional[int] = None):
        """ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã«è¿½åŠ """
        breadcrumb_item = {
            'page': page,
            'user_id': user_id,
            'timestamp': datetime.now()
        }
        
        # é‡è¤‡ã‚’é¿ã‘ã‚‹
        breadcrumb = st.session_state.get('navigation_breadcrumb', [])
        if not breadcrumb or breadcrumb[-1]['page'] != page:
            breadcrumb.append(breadcrumb_item)
        
        # ãƒ‘ãƒ³ããšã¯æœ€æ–°10ä»¶ã¾ã§ä¿æŒ
        if len(breadcrumb) > 10:
            breadcrumb = breadcrumb[-10:]
        
        st.session_state.navigation_breadcrumb = breadcrumb
    
    @staticmethod
    def go_back():
        """å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹"""
        breadcrumb = st.session_state.get('navigation_breadcrumb', [])
        if len(breadcrumb) >= 2:
            # ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’é™¤ãå‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
            previous_page = breadcrumb[-2]
            AppStateManager.set_page(previous_page['page'], previous_page['user_id'])
            # ãƒ‘ãƒ³ããšã‹ã‚‰ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤
            st.session_state.navigation_breadcrumb = breadcrumb[:-1]
        else:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            AppStateManager.set_page(PageState.HOME)
    
    @staticmethod
    def clear_form_data():
        """ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢"""
        st.session_state.form_data = {}
    
    @staticmethod
    def save_form_data(data: Dict[str, Any]):
        """ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜"""
        st.session_state.form_data.update(data)
    
    @staticmethod
    def get_form_data() -> Dict[str, Any]:
        """ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        return st.session_state.get('form_data', {})

class NavigationManager:
    """ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def show_navigation_sidebar():
        """ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’è¡¨ç¤º"""
        current_page = AppStateManager.get_current_page()
        
        st.sidebar.header("ğŸ“‹ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³")
        
        # ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        main_menu_options = {
            "ğŸ  ãƒ›ãƒ¼ãƒ ": PageState.HOME,
            "ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²": PageState.USER_CREATE,
            "ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§": PageState.USER_LIST,
        }
        
        for label, page in main_menu_options.items():
            if st.sidebar.button(label, use_container_width=True, type="primary" if current_page == page else "secondary"):
                AppStateManager.set_page(page)
                st.rerun()
        
        st.sidebar.markdown("---")
        
        # ç¾åœ¨ã®ãƒšãƒ¼ã‚¸æƒ…å ±
        NavigationManager._show_current_page_info()
        
        # ãƒ‘ãƒ³ããšãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        NavigationManager._show_breadcrumb()
        
        # æ“ä½œå±¥æ­´
        NavigationManager._show_operation_history()
    
    @staticmethod
    def _show_current_page_info():
        """ç¾åœ¨ã®ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’è¡¨ç¤º"""
        current_page = AppStateManager.get_current_page()
        selected_user_id = AppStateManager.get_selected_user_id()
        
        st.sidebar.subheader("ğŸ“ ç¾åœ¨ã®ä½ç½®")
        
        page_names = {
            PageState.HOME: "ãƒ›ãƒ¼ãƒ ",
            PageState.USER_LIST: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§",
            PageState.USER_DETAIL: "ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°",
            PageState.USER_EDIT: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†",
            PageState.USER_CREATE: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²",
            PageState.USER_DELETE: "ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤"
        }
        
        page_name = page_names.get(current_page, "ä¸æ˜")
        st.sidebar.write(f"**ãƒšãƒ¼ã‚¸**: {page_name}")
        
        if selected_user_id:
            st.sidebar.write(f"**ãƒ¦ãƒ¼ã‚¶ãƒ¼ID**: {selected_user_id}")
    
    @staticmethod
    def _show_breadcrumb():
        """ãƒ‘ãƒ³ããšãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º"""
        breadcrumb = st.session_state.get('navigation_breadcrumb', [])
        
        if len(breadcrumb) > 1:
            st.sidebar.subheader("ğŸ§­ å±¥æ­´")
            
            # æˆ»ã‚‹ãƒœã‚¿ãƒ³
            if st.sidebar.button("â† æˆ»ã‚‹", use_container_width=True):
                AppStateManager.go_back()
                st.rerun()
            
            # ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ
            for i, item in enumerate(breadcrumb[-3:]):  # æœ€æ–°3ä»¶ã‚’è¡¨ç¤º
                page_names = {
                    PageState.HOME: "ğŸ  ãƒ›ãƒ¼ãƒ ",
                    PageState.USER_LIST: "ğŸ‘¥ ä¸€è¦§",
                    PageState.USER_DETAIL: "ğŸ‘¤ è©³ç´°",
                    PageState.USER_EDIT: "âœï¸ ç·¨é›†",
                    PageState.USER_CREATE: "â• ç™»éŒ²",
                }
                
                page_name = page_names.get(item['page'], "ğŸ“„ ãƒšãƒ¼ã‚¸")
                if item['user_id']:
                    page_name += f" (ID:{item['user_id']})"
                
                st.sidebar.caption(f"{i+1}. {page_name}")
    
    @staticmethod
    def _show_operation_history():
        """æ“ä½œå±¥æ­´ã‚’è¡¨ç¤º"""
        with st.sidebar.expander("ğŸ“š æ“ä½œå±¥æ­´"):
            history = AppStateManager.get_operation_history(5)
            
            if not history:
                st.write("å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“")
                return
            
            for item in reversed(history):
                icon = "âœ…" if item['success'] else "âŒ"
                time_str = item['timestamp'].strftime("%H:%M")
                st.caption(f"{icon} {time_str} - {item['description']}")

class ConfirmationDialog:
    """ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def show_delete_confirmation(user_data: Dict[str, Any]) -> bool:
        """å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º"""
        st.warning("âš ï¸ å‰Šé™¤ã®ç¢ºèª")
        
        st.markdown(f"""
        ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ï¼š
        
        **ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±**:
        - **ID**: {user_data.get('id', 'N/A')}
        - **ãƒ¦ãƒ¼ã‚¶ãƒ¼å**: {user_data.get('username', 'N/A')}
        - **æ°å**: {user_data.get('full_name', 'N/A')}
        - **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**: {user_data.get('email', 'N/A')}
        """)
        
        st.error("âš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")
        
        col1, col2, col3 = st.columns([1, 1, 1])
        
        with col1:
            if st.button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", use_container_width=True):
                return False
        
        with col2:
            st.write("")  # ã‚¹ãƒšãƒ¼ã‚¹
        
        with col3:
            # ç¢ºèªãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
            confirm_text = st.text_input(
                "å‰Šé™¤ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ŒDELETEã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„:",
                placeholder="DELETE"
            )
            
            delete_confirmed = confirm_text.upper() == "DELETE"
            
            if st.button(
                "ğŸ—‘ï¸ å‰Šé™¤å®Ÿè¡Œ", 
                use_container_width=True, 
                disabled=not delete_confirmed,
                type="primary" if delete_confirmed else "secondary"
            ):
                return True
        
        return False
    
    @staticmethod
    def show_unsaved_changes_warning() -> Literal["save", "discard", "cancel"]:
        """æœªä¿å­˜ã®å¤‰æ›´ã«å¯¾ã™ã‚‹è­¦å‘Š"""
        st.warning("âš ï¸ æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™")
        
        st.markdown("ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨ã€æœªä¿å­˜ã®å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ã€‚")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("ğŸ’¾ ä¿å­˜ã—ã¦ç¶šè¡Œ", use_container_width=True):
                return "save"
        
        with col2:
            if st.button("ğŸ—‘ï¸ ç ´æ£„ã—ã¦ç¶šè¡Œ", use_container_width=True):
                return "discard"
        
        with col3:
            if st.button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", use_container_width=True):
                return "cancel"
        
        return "cancel"

# ä¾¿åˆ©ãªé–¢æ•°
def initialize_app_state():
    """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–"""
    AppStateManager.initialize_state()

def navigate_to_user_detail(user_id: int):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã¸é·ç§»"""
    AppStateManager.set_page(PageState.USER_DETAIL, user_id)

def navigate_to_user_edit(user_id: int):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒšãƒ¼ã‚¸ã¸é·ç§»"""
    AppStateManager.set_page(PageState.USER_EDIT, user_id)

def navigate_to_user_list():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸é·ç§»"""
    AppStateManager.set_page(PageState.USER_LIST)</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>çŠ¶æ…‹ç®¡ç†ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ç”»é¢é·ç§»ãŒç®¡ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤º -->
                    <h3 class="section-title">5.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½</h3>
                    
                    <p>é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã€ç·¨é›†ãƒ»å‰Šé™¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 5-2: ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½ã®å®Ÿè£…</h5>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºç”»é¢ã¨é–¢é€£ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ</li>
                            <li>è©³ç´°æƒ…å ±ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­è¨ˆ</li>
                            <li>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®å®Ÿè£…</li>
                            <li>é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º</li>
                            <li>æ¨©é™ã«åŸºã¥ãè¡¨ç¤ºåˆ¶å¾¡</li>
                        </ol>

                        <h6>app/components/user_detail.pyä½œæˆ</h6>
                        <pre><code>"""
ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
"""

import streamlit as st
from typing import Optional, Dict, Any
from datetime import datetime

from app.database.connection import get_db_session
from app.database.crud import user_crud
from app.models.user import User
from app.utils.state_manager import (
    AppStateManager, NavigationManager, OperationType, PageState
)

class UserDetailView:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def show(user_id: int):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ç”»é¢ã‚’è¡¨ç¤º"""
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
        user_data = UserDetailView._get_user_data(user_id)
        
        if not user_data:
            UserDetailView._show_user_not_found(user_id)
            return
        
        # ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼
        UserDetailView._show_page_header(user_data)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
        UserDetailView._show_user_information(user_data)
        
        # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
        UserDetailView._show_action_buttons(user_data)
        
        # é–¢é€£æƒ…å ±
        UserDetailView._show_related_information(user_data)
    
    @staticmethod
    def _get_user_data(user_id: int) -> Optional[User]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            user = user_crud.get_user_by_id(session, user_id)
            session.close()
            
            if user:
                AppStateManager.add_operation_history(
                    OperationType.READ,
                    f"ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤º: {user.username}",
                    success=True
                )
            
            return user
            
        except Exception as e:
            st.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
            AppStateManager.add_operation_history(
                OperationType.READ,
                f"ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºå¤±æ•—: ID {user_id}",
                success=False,
                error=str(e)
            )
            return None
    
    @staticmethod
    def _show_user_not_found(user_id: int):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®è¡¨ç¤º"""
        st.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆID: {user_id}ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        col1, col2, col3 = st.columns([1, 2, 1])
        
        with col2:
            st.markdown("""
            **å¯èƒ½ãªåŸå› :**
            - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã•ã‚ŒãŸ
            - URLãŒæ­£ã—ããªã„
            - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼
            """)
            
            if st.button("ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã«æˆ»ã‚‹", use_container_width=True):
                AppStateManager.set_page(PageState.USER_LIST)
                st.rerun()
    
    @staticmethod
    def _show_page_header(user: User):
        """ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤º"""
        col1, col2 = st.columns([3, 1])
        
        with col1:
            st.title(f"ğŸ‘¤ {user.full_name}")
            st.markdown(f"**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**: `{user.username}` | **ID**: `{user.id}`")
        
        with col2:
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
            if user.is_active:
                st.success("âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–")
            else:
                st.error("âŒ éã‚¢ã‚¯ãƒ†ã‚£ãƒ–")
    
    @staticmethod
    def _show_user_information(user: User):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º"""
        st.markdown("---")
        st.subheader("ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±")
        
        # åŸºæœ¬æƒ…å ±
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("**åŸºæœ¬æƒ…å ±**")
            
            info_data = [
                ("ğŸ‘¤ æ°å", user.full_name),
                ("ğŸ·ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼å", user.username),
                ("ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", user.email),
                ("ğŸ‚ å¹´é½¢", f"{user.age}æ­³" if user.age else "æœªè¨­å®š"),
                ("ğŸ¢ éƒ¨ç½²", user.department or "æœªè¨­å®š"),
            ]
            
            for label, value in info_data:
                st.markdown(f"**{label}**: {value}")
        
        with col2:
            st.markdown("**ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±**")
            
            system_data = [
                ("ğŸ†” ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", user.id),
                ("ğŸ“… ä½œæˆæ—¥æ™‚", user.created_at.strftime("%Y-%m-%d %H:%M:%S")),
                ("ğŸ”„ æ›´æ–°æ—¥æ™‚", user.updated_at.strftime("%Y-%m-%d %H:%M:%S")),
                ("âš¡ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–" if user.is_active else "éã‚¢ã‚¯ãƒ†ã‚£ãƒ–"),
            ]
            
            for label, value in system_data:
                st.markdown(f"**{label}**: {value}")
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        UserDetailView._show_user_card(user)
    
    @staticmethod
    def _show_user_card(user: User):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º"""
        with st.container():
            st.markdown("**ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰**")
            
            card_html = f"""
            <div class="user-card">
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <div style="
                        width: 60px; 
                        height: 60px; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 1.5rem;
                        margin-right: 1rem;
                    ">
                        {user.full_name[0] if user.full_name else '?'}
                    </div>
                    <div>
                        <h3 style="margin: 0; color: #333;">{user.full_name}</h3>
                        <p style="margin: 0; color: #666;">@{user.username}</p>
                        <p style="margin: 0; color: #999; font-size: 0.9rem;">{user.email}</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">
                        <strong>éƒ¨ç½²:</strong> {user.department or 'æœªè¨­å®š'}
                    </div>
                    <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">
                        <strong>å¹´é½¢:</strong> {user.age or 'æœªè¨­å®š'}
                    </div>
                    <div style="background: {'#d4edda' if user.is_active else '#f8d7da'}; padding: 0.5rem; border-radius: 4px;">
                        <strong>çŠ¶æ…‹:</strong> {'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' if user.is_active else 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–'}
                    </div>
                </div>
            </div>
            """
            
            st.markdown(card_html, unsafe_allow_html=True)
    
    @staticmethod
    def _show_action_buttons(user: User):
        """ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º"""
        st.markdown("---")
        st.subheader("ğŸ”§ æ“ä½œ")
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            if st.button(
                "âœï¸ ç·¨é›†", 
                use_container_width=True, 
                type="primary",
                help="ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç·¨é›†ã—ã¾ã™"
            ):
                AppStateManager.set_page(PageState.USER_EDIT, user.id)
                st.rerun()
        
        with col2:
            if st.button(
                "ğŸ—‘ï¸ å‰Šé™¤", 
                use_container_width=True,
                help="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆæ³¨æ„: å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰"
            ):
                AppStateManager.set_page(PageState.USER_DELETE, user.id)
                st.rerun()
        
        with col3:
            if st.button(
                "ğŸ‘¥ ä¸€è¦§ã«æˆ»ã‚‹", 
                use_container_width=True,
                help="ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™"
            ):
                AppStateManager.set_page(PageState.USER_LIST)
                st.rerun()
        
        with col4:
            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            new_status = not user.is_active
            status_text = "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–" if new_status else "éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–"
            
            if st.button(
                f"âš¡ {status_text}",
                use_container_width=True,
                help=f"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’{status_text}ã—ã¾ã™"
            ):
                UserDetailView._toggle_user_status(user.id, new_status)
    
    @staticmethod
    def _toggle_user_status(user_id: int, new_status: bool):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ"""
        try:
            from app.models.user import UserUpdate
            
            session_gen = get_db_session()
            session = next(session_gen)
            
            update_data = UserUpdate(is_active=new_status)
            updated_user = user_crud.update_user(session, user_id, update_data)
            
            if updated_user:
                status_text = "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–" if new_status else "éã‚¢ã‚¯ãƒ†ã‚£ãƒ–"
                st.success(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’{status_text}ã«å¤‰æ›´ã—ã¾ã—ãŸ")
                
                AppStateManager.add_operation_history(
                    OperationType.UPDATE,
                    f"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´: {updated_user.username} -> {status_text}",
                    success=True
                )
                
                # ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                st.rerun()
            else:
                st.error("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ")
            
            session.close()
            
        except Exception as e:
            st.error(f"âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚¨ãƒ©ãƒ¼: {e}")
            AppStateManager.add_operation_history(
                OperationType.UPDATE,
                f"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å¤±æ•—: ID {user_id}",
                success=False,
                error=str(e)
            )
    
    @staticmethod
    def _show_related_information(user: User):
        """é–¢é€£æƒ…å ±ã‚’è¡¨ç¤º"""
        st.markdown("---")
        
        tab1, tab2, tab3 = st.tabs(["ğŸ“Š çµ±è¨ˆæƒ…å ±", "ğŸ“š æ“ä½œå±¥æ­´", "ğŸ”— é–¢é€£ãƒ‡ãƒ¼ã‚¿"])
        
        with tab1:
            UserDetailView._show_user_statistics(user)
        
        with tab2:
            UserDetailView._show_user_operation_history(user)
        
        with tab3:
            UserDetailView._show_related_data(user)
    
    @staticmethod
    def _show_user_statistics(user: User):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º"""
        col1, col2, col3 = st.columns(3)
        
        with col1:
            # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã‹ã‚‰ã®æ—¥æ•°
            days_since_creation = (datetime.now() - user.created_at.replace(tzinfo=None)).days
            st.metric("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ", f"{days_since_creation}æ—¥å‰")
        
        with col2:
            # æœ€çµ‚æ›´æ–°ã‹ã‚‰ã®æ—¥æ•°
            days_since_update = (datetime.now() - user.updated_at.replace(tzinfo=None)).days
            st.metric("æœ€çµ‚æ›´æ–°", f"{days_since_update}æ—¥å‰")
        
        with col3:
            # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹
            st.metric("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹", "æ­£å¸¸" if user.is_active else "åœæ­¢ä¸­")
    
    @staticmethod
    def _show_user_operation_history(user: User):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œå±¥æ­´ã‚’è¡¨ç¤º"""
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®æ“ä½œå±¥æ­´ã‚’è¡¨ç¤º
        history = AppStateManager.get_operation_history(10)
        user_history = [h for h in history if h.get('user_id') == user.id]
        
        if not user_history:
            st.info("ğŸ“ ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã®æ“ä½œå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“")
            return
        
        st.markdown("**ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã®æ“ä½œ:**")
        for item in reversed(user_history):
            icon = "âœ…" if item['success'] else "âŒ"
            time_str = item['timestamp'].strftime("%H:%M:%S")
            st.markdown(f"{icon} **{time_str}** - {item['description']}")
    
    @staticmethod
    def _show_related_data(user: User):
        """é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º"""
        st.markdown("**ğŸ”— é–¢é€£æƒ…å ±**")
        
        # ä»Šå¾Œã®æ‹¡å¼µç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
        st.info("ğŸ“‹ é–¢é€£ãƒ‡ãƒ¼ã‚¿æ©Ÿèƒ½ã¯ä»Šå¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…äºˆå®šã§ã™")
        
        # éƒ¨ç½²å†…ã®ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã©ã‚’è¡¨ç¤ºäºˆå®š
        if user.department:
            st.markdown(f"**åŒã˜éƒ¨ç½² ({user.department}) ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼**: å®Ÿè£…äºˆå®š")
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ãªã©
        st.markdown("**ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°**: å®Ÿè£…äºˆå®š")</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è¡¨ç¤ºã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†æ©Ÿèƒ½ -->
                    <h3 class="section-title">5.4 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†æ©Ÿèƒ½ã®å®Ÿè£…</h3>
                    
                    <p>æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å®‰å…¨ã«ç·¨é›†ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 5-3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†æ©Ÿèƒ½ã®ä½œæˆ</h5>
                        <p>ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ</li>
                            <li>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®äº‹å‰å…¥åŠ›</li>
                            <li>å¤‰æ›´æ¤œå‡ºã¨å·®åˆ†è¡¨ç¤º</li>
                            <li>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</li>
                            <li>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</li>
                        </ol>

                        <h6>app/components/user_edit.pyä½œæˆ</h6>
                        <pre><code>"""
ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
"""

import streamlit as st
from typing import Optional, Dict, Any
import copy

from app.database.connection import get_db_session
from app.database.crud import user_crud
from app.models.user import User, UserUpdate
from app.utils.validators import (
    UserValidator, StreamlitValidationHelper, get_valid_departments
)
from app.utils.state_manager import (
    AppStateManager, OperationType, PageState, ConfirmationDialog
)

class UserEditView:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†è¡¨ç¤ºã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def show(user_id: int):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ç”»é¢ã‚’è¡¨ç¤º"""
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
        user_data = UserEditView._get_user_data(user_id)
        
        if not user_data:
            UserEditView._show_user_not_found(user_id)
            return
        
        # ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼
        UserEditView._show_page_header(user_data)
        
        # ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
        UserEditView._show_edit_form(user_data)
    
    @staticmethod
    def _get_user_data(user_id: int) -> Optional[User]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            user = user_crud.get_user_by_id(session, user_id)
            session.close()
            
            return user
            
        except Exception as e:
            st.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
            return None
    
    @staticmethod
    def _show_user_not_found(user_id: int):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®è¡¨ç¤º"""
        st.error(f"âŒ ç·¨é›†å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆID: {user_id}ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        if st.button("ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã«æˆ»ã‚‹"):
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    
    @staticmethod
    def _show_page_header(user: User):
        """ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤º"""
        col1, col2 = st.columns([3, 1])
        
        with col1:
            st.title(f"âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†: {user.full_name}")
            st.markdown(f"**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**: `{user.username}` | **ID**: `{user.id}`")
        
        with col2:
            if st.button("âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«", use_container_width=True):
                AppStateManager.set_page(PageState.USER_DETAIL, user.id)
                st.rerun()
    
    @staticmethod
    def _show_edit_form(user: User):
        """ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º"""
        st.markdown("---")
        st.subheader("ğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç·¨é›†")
        
        # æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        has_unsaved_changes = UserEditView._has_unsaved_changes(user)
        
        if has_unsaved_changes:
            st.warning("âš ï¸ æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™")
        
        # å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        original_data = {
            'username': user.username,
            'email': user.email,
            'full_name': user.full_name,
            'age': user.age,
            'department': user.department,
            'is_active': user.is_active
        }
        
        # ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ
        with st.form("user_edit_form", clear_on_submit=False):
            st.markdown("### åŸºæœ¬æƒ…å ±ã®ç·¨é›†")
            
            # 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("**åŸºæœ¬æƒ…å ±**")
                
                username = st.text_input(
                    "ãƒ¦ãƒ¼ã‚¶ãƒ¼å *",
                    value=user.username,
                    help="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ä¸€æ„ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
                )
                
                email = st.text_input(
                    "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *",
                    value=user.email,
                    help="æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                )
                
                full_name = st.text_input(
                    "æ°å *",
                    value=user.full_name,
                    help="ãƒ•ãƒ«ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                )
            
            with col2:
                st.markdown("**è¿½åŠ æƒ…å ±**")
                
                age = st.number_input(
                    "å¹´é½¢",
                    min_value=0,
                    max_value=150,
                    value=user.age if user.age is not None else None,
                    help="å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"
                )
                
                departments = get_valid_departments()
                current_dept_index = 0
                if user.department and user.department in departments:
                    current_dept_index = departments.index(user.department) + 1
                
                department = st.selectbox(
                    "éƒ¨ç½²",
                    options=[""] + departments,
                    index=current_dept_index,
                    help="æ‰€å±éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"
                )
                
                is_active = st.checkbox(
                    "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹",
                    value=user.is_active,
                    help="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹"
                )
            
            # å¤‰æ›´å†…å®¹ã®è¡¨ç¤º
            new_data = {
                'username': username.strip() if username else '',
                'email': email.strip().lower() if email else '',
                'full_name': full_name.strip() if full_name else '',
                'age': age if age is not None and age > 0 else None,
                'department': department.strip() if department else None,
                'is_active': is_active
            }
            
            # å¤‰æ›´æ¤œå‡º
            changes = UserEditView._detect_changes(original_data, new_data)
            
            if changes:
                st.markdown("### ğŸ”„ å¤‰æ›´å†…å®¹")
                UserEditView._show_changes(changes)
            
            # é€ä¿¡ãƒœã‚¿ãƒ³
            st.markdown("---")
            col_left, col_center, col_right = st.columns([1, 2, 1])
            
            with col_center:
                submitted = st.form_submit_button(
                    "ğŸ’¾ å¤‰æ›´ã‚’ä¿å­˜",
                    use_container_width=True,
                    type="primary",
                    disabled=not changes
                )
        
        # ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        if submitted and changes:
            UserEditView._process_form_submission(user.id, new_data, changes)
    
    @staticmethod
    def _has_unsaved_changes(user: User) -> bool:
        """æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
        form_data = AppStateManager.get_form_data()
        return bool(form_data.get('has_changes', False))
    
    @staticmethod
    def _detect_changes(original: Dict[str, Any], new: Dict[str, Any]) -> Dict[str, Dict[str, Any]]:
        """å¤‰æ›´ã‚’æ¤œå‡º"""
        changes = {}
        
        for key, new_value in new.items():
            old_value = original.get(key)
            
            # None ã¨ç©ºæ–‡å­—åˆ—ã®æ­£è¦åŒ–
            if old_value == '' and new_value is None:
                continue
            if old_value is None and new_value == '':
                continue
            
            if old_value != new_value:
                changes[key] = {
                    'old': old_value,
                    'new': new_value
                }
        
        return changes
    
    @staticmethod
    def _show_changes(changes: Dict[str, Dict[str, Any]]):
        """å¤‰æ›´å†…å®¹ã‚’è¡¨ç¤º"""
        field_names = {
            'username': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
            'email': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
            'full_name': 'æ°å',
            'age': 'å¹´é½¢',
            'department': 'éƒ¨ç½²',
            'is_active': 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        }
        
        for field, change in changes.items():
            field_name = field_names.get(field, field)
            old_value = change['old'] if change['old'] is not None else 'æœªè¨­å®š'
            new_value = change['new'] if change['new'] is not None else 'æœªè¨­å®š'
            
            if field == 'is_active':
                old_value = 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' if change['old'] else 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–'
                new_value = 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' if change['new'] else 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–'
            
            st.markdown(f"**{field_name}**: `{old_value}` â†’ `{new_value}`")
    
    @staticmethod
    def _process_form_submission(user_id: int, form_data: Dict[str, Any], changes: Dict[str, Dict[str, Any]]):
        """ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†"""
        
        # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        if not StreamlitValidationHelper.validate_and_show_errors(form_data):
            return
        
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            # æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ï¼ˆå¤‰æ›´ã•ã‚ŒãŸé …ç›®ã®ã¿ï¼‰
            update_data = {}
            for field, change in changes.items():
                update_data[field] = change['new']
            
            # UserUpdateãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ
            user_update = UserUpdate(**update_data)
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°
            updated_user = user_crud.update_user(session, user_id, user_update)
            
            if updated_user:
                # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                st.success(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ '{updated_user.username}' ã®æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼")
                
                # æ“ä½œå±¥æ­´ã«è¨˜éŒ²
                change_summary = ", ".join([
                    f"{k}: {v['old']} â†’ {v['new']}" for k, v in changes.items()
                ])
                
                AppStateManager.add_operation_history(
                    OperationType.UPDATE,
                    f"ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°: {updated_user.username}",
                    success=True,
                    changes=change_summary
                )
                
                # ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                AppStateManager.clear_form_data()
                
                # è©³ç´°ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                st.info("ğŸ’¡ 3ç§’å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...")
                
                # JavaScript ã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                st.markdown("""
                <script>
                setTimeout(function(){
                    window.location.reload();
                }, 3000);
                </script>
                """, unsafe_allow_html=True)
                
                # æ‰‹å‹•ã§ã®é·ç§»ãƒœã‚¿ãƒ³
                if st.button("ğŸ“‹ ä»Šã™ãè©³ç´°ãƒšãƒ¼ã‚¸ã«ç§»å‹•"):
                    AppStateManager.set_page(PageState.USER_DETAIL, user_id)
                    st.rerun()
            
            session.close()
            
        except ValueError as e:
            st.error(f"âŒ æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
            AppStateManager.add_operation_history(
                OperationType.UPDATE,
                f"ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°å¤±æ•—: ID {user_id}",
                success=False,
                error=str(e)
            )
        except Exception as e:
            st.error(f"âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            AppStateManager.add_operation_history(
                OperationType.UPDATE,
                f"ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°å¤±æ•—: ID {user_id}",
                success=False,
                error=str(e)
            )

class UserDeleteView:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤è¡¨ç¤ºã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def show(user_id: int):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ç¢ºèªç”»é¢ã‚’è¡¨ç¤º"""
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
        user_data = UserDeleteView._get_user_data(user_id)
        
        if not user_data:
            UserDeleteView._show_user_not_found(user_id)
            return
        
        # ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼
        UserDeleteView._show_page_header(user_data)
        
        # å‰Šé™¤ç¢ºèª
        UserDeleteView._show_delete_confirmation(user_data)
    
    @staticmethod
    def _get_user_data(user_id: int) -> Optional[User]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            user = user_crud.get_user_by_id(session, user_id)
            session.close()
            
            return user
            
        except Exception as e:
            st.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
            return None
    
    @staticmethod
    def _show_user_not_found(user_id: int):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®è¡¨ç¤º"""
        st.error(f"âŒ å‰Šé™¤å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆID: {user_id}ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        if st.button("ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã«æˆ»ã‚‹"):
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    
    @staticmethod
    def _show_page_header(user: User):
        """ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤º"""
        st.title(f"ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ç¢ºèª")
        st.markdown(f"**å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼**: {user.full_name} (`{user.username}`)")
    
    @staticmethod
    def _show_delete_confirmation(user: User):
        """å‰Šé™¤ç¢ºèªã‚’è¡¨ç¤º"""
        st.markdown("---")
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ dict ã«å¤‰æ›
        user_dict = {
            'id': user.id,
            'username': user.username,
            'full_name': user.full_name,
            'email': user.email
        }
        
        # ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        if ConfirmationDialog.show_delete_confirmation(user_dict):
            UserDeleteView._process_delete(user)
        
        # ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ï¼ˆç‹¬ç«‹ï¼‰
        st.markdown("---")
        if st.button("ğŸ”™ å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦è©³ç´°ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹", use_container_width=True):
            AppStateManager.set_page(PageState.USER_DETAIL, user.id)
            st.rerun()
    
    @staticmethod
    def _process_delete(user: User):
        """å‰Šé™¤å‡¦ç†ã‚’å®Ÿè¡Œ"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
            delete_success = user_crud.delete_user(session, user.id)
            
            if delete_success:
                st.success(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ '{user.username}' ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
                
                # æ“ä½œå±¥æ­´ã«è¨˜éŒ²
                AppStateManager.add_operation_history(
                    OperationType.DELETE,
                    f"ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤: {user.username}",
                    success=True
                )
                
                # 3ç§’å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã«ç§»å‹•
                st.info("ğŸ’¡ 3ç§’å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...")
                
                if st.button("ğŸ‘¥ ä»Šã™ããƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã«ç§»å‹•"):
                    AppStateManager.set_page(PageState.USER_LIST)
                    st.rerun()
            else:
                st.error("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ")
            
            session.close()
            
        except Exception as e:
            st.error(f"âŒ å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            AppStateManager.add_operation_history(
                OperationType.DELETE,
                f"ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å¤±æ•—: {user.username}",
                success=False,
                error=str(e)
            )</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†æ©Ÿèƒ½ã¨å‰Šé™¤æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã€é©åˆ‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ç¢ºèªãƒ—ãƒ­ã‚»ã‚¹ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³5: ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆ -->
                    <h3 class="section-title">5.5 ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®çµ±åˆ</h3>
                    
                    <p>ä½œæˆã—ãŸCRUDæ©Ÿèƒ½ã‚’ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«çµ±åˆã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 5-4: CRUDæ©Ÿèƒ½ã®çµ±åˆã¨ãƒ†ã‚¹ãƒˆ</h5>
                        <p>ã™ã¹ã¦ã®CRUDæ©Ÿèƒ½ã‚’ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«çµ±åˆã—ã€å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°</li>
                            <li>ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®Ÿè£…</li>
                            <li>çŠ¶æ…‹ç®¡ç†ã®çµ±åˆ</li>
                            <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–</li>
                            <li>ç·åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ</li>
                        </ol>

                        <h6>app/main.py æœ€çµ‚æ›´æ–°ç‰ˆ</h6>
                        <pre><code>"""
Modern User Management Dashboard
å®Œå…¨ãªCRUDæ©Ÿèƒ½ä»˜ããƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
"""

import streamlit as st
import sys
import os

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’Pythonãƒ‘ã‚¹ã«è¿½åŠ 
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from config import settings
from database.connection import init_database
from utils.state_manager import (
    AppStateManager, NavigationManager, PageState, initialize_app_state
)
from components.user_detail import UserDetailView
from components.user_edit import UserEditView, UserDeleteView

# æ—¢å­˜ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from utils.data_manager import DataManager, DisplayHelper
from utils.search_manager import SearchManager, AdvancedFilter
from utils.validators import get_valid_departments, StreamlitValidationHelper
from utils.helpers import UIHelper, SessionManager, NotificationManager
from database.crud import user_crud
from models.user import UserCreate
from database.connection import get_db_session

def initialize_app():
    """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–"""
    if 'app_initialized' not in st.session_state:
        try:
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
            init_database()
            st.session_state.app_initialized = True
            st.session_state.initialization_success = True
        except Exception as e:
            st.session_state.app_initialized = True
            st.session_state.initialization_success = False
            st.session_state.initialization_error = str(e)

def main():
    """ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"""
    
    # ãƒšãƒ¼ã‚¸è¨­å®š
    st.set_page_config(
        page_title=settings.APP_NAME,
        page_icon="ğŸ‘¥",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # çŠ¶æ…‹ç®¡ç†åˆæœŸåŒ–
    initialize_app_state()
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    initialize_app()
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†åˆæœŸåŒ–
    SessionManager.initialize_session()
    
    # åˆæœŸåŒ–å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    if not st.session_state.get('initialization_success', False):
        st.error("âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ")
        if 'initialization_error' in st.session_state:
            st.error(f"ã‚¨ãƒ©ãƒ¼è©³ç´°: {st.session_state.initialization_error}")
        st.stop()
    
    # ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚µã‚¤ãƒ‰ãƒãƒ¼
    NavigationManager.show_navigation_sidebar()
    
    # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    current_page = AppStateManager.get_current_page()
    
    if current_page == PageState.HOME:
        show_home_page()
    elif current_page == PageState.USER_CREATE:
        show_user_registration_form()
    elif current_page == PageState.USER_LIST:
        show_user_list()
    elif current_page == PageState.USER_DETAIL:
        user_id = AppStateManager.get_selected_user_id()
        if user_id:
            UserDetailView.show(user_id)
        else:
            st.error("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    elif current_page == PageState.USER_EDIT:
        user_id = AppStateManager.get_selected_user_id()
        if user_id:
            UserEditView.show(user_id)
        else:
            st.error("âŒ ç·¨é›†å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    elif current_page == PageState.USER_DELETE:
        user_id = AppStateManager.get_selected_user_id()
        if user_id:
            UserDeleteView.show(user_id)
        else:
            st.error("âŒ å‰Šé™¤å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            AppStateManager.set_page(PageState.USER_LIST)
            st.rerun()
    else:
        st.error(f"âŒ ä¸æ˜ãªãƒšãƒ¼ã‚¸: {current_page}")
        AppStateManager.set_page(PageState.HOME)
        st.rerun()
    
    # é€šçŸ¥è¡¨ç¤º
    NotificationManager.show_notifications()
    
    # ãƒ•ãƒƒã‚¿ãƒ¼
    show_footer()

def show_home_page():
    """ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º"""
    st.title(f"ğŸ‘¥ {settings.APP_NAME}")
    st.markdown(f"**Version:** {settings.APP_VERSION}")
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("""
        ## ğŸ¯ Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
        
        ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€**Streamlit** ã¨ **SQLModel** ã‚’ä½¿ç”¨ã—ãŸ
        ãƒ¢ãƒ€ãƒ³ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨ãªå®Ÿè£…ã§ã™ã€‚
        
        ### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½:
        - âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã®æ–°è¦ç™»éŒ²
        - âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§**: æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
        - âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°**: è©³ç´°æƒ…å ±è¡¨ç¤º
        - âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†**: å®‰å…¨ãªæƒ…å ±æ›´æ–°
        - âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤**: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãå‰Šé™¤
        - âœ… **çŠ¶æ…‹ç®¡ç†**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        - âœ… **ãƒ‡ãƒ¼ã‚¿ç®¡ç†**: PostgreSQLã§ã®æ°¸ç¶šåŒ–
        - âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: åŒ…æ‹¬çš„ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
        """)
        
        # ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        st.markdown("### ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³")
        
        action_col1, action_col2, action_col3 = st.columns(3)
        
        with action_col1:
            if st.button("ğŸ‘¤ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²", use_container_width=True, type="primary"):
                AppStateManager.set_page(PageState.USER_CREATE)
                st.rerun()
        
        with action_col2:
            if st.button("ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º", use_container_width=True):
                AppStateManager.set_page(PageState.USER_LIST)
                st.rerun()
        
        with action_col3:
            # çµ±è¨ˆæƒ…å ±è¡¨ç¤º
            stats = DataManager.get_user_statistics()
            total_users = stats.get('total_users', 0)
            st.metric("ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°", total_users)
    
    with col2:
        st.subheader("ğŸ“ˆ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é€²è¡ŒçŠ¶æ³")
        
        progress_steps = [
            ("âœ… Step 1: ç’°å¢ƒæ§‹ç¯‰", True),
            ("âœ… Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ", True),
            ("âœ… Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½", True),
            ("âœ… Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º", True),
            ("âœ… Step 5: CRUDæ“ä½œ", True),
            ("â³ Step 6: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤", False)
        ]
        
        for step, completed in progress_steps:
            if completed:
                st.success(step)
            else:
                st.info(step)
        
        # é€²è¡Œç‡
        completed_count = sum(1 for _, completed in progress_steps if completed)
        progress_rate = completed_count / len(progress_steps)
        st.progress(progress_rate)
        st.caption(f"é€²è¡Œç‡: {progress_rate*100:.0f}% ({completed_count}/{len(progress_steps)})")

# æ—¢å­˜ã®é–¢æ•°ï¼ˆshow_user_registration_form, show_user_list ãªã©ï¼‰ã‚’ãã®ã¾ã¾ä½¿ç”¨
# ... [å‰å›ã¾ã§ã®ã‚³ãƒ¼ãƒ‰ã‚’ç¶™ç¶šä½¿ç”¨]

def show_footer():
    """ãƒ•ãƒƒã‚¿ãƒ¼ã‚’è¡¨ç¤º"""
    st.markdown("---")
    
    footer_col1, footer_col2, footer_col3 = st.columns(3)
    
    with footer_col1:
        st.markdown("**ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±**")
        st.caption(f"Database: PostgreSQL")
        st.caption(f"Framework: Streamlit {st.__version__}")
    
    with footer_col2:
        st.markdown("**ğŸ“Š çµ±è¨ˆ**")
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆ
        history_count = len(AppStateManager.get_operation_history())
        st.caption(f"æ“ä½œå±¥æ­´: {history_count}ä»¶")
        
        reg_count = len(SessionManager.get_registration_history())
        st.caption(f"ã‚»ãƒƒã‚·ãƒ§ãƒ³ç™»éŒ²: {reg_count}ä»¶")
    
    with footer_col3:
        st.markdown("**â„¹ï¸ æƒ…å ±**")
        st.caption("Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«")
        st.caption("Step 5: CRUDæ“ä½œå®Œäº† âœ…")

if __name__ == "__main__":
    main()</code></pre>

                        <h6>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œç¢ºèª</h6>
                        <pre><code># ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
streamlit run app/main.py

# ã¾ãŸã¯ WSL2 ç’°å¢ƒ
streamlit run app/main.py --server.address 0.0.0.0</code></pre>

                        <h6>ç·åˆãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>æ©Ÿèƒ½</th>
                                        <th>ãƒ†ã‚¹ãƒˆé …ç›®</th>
                                        <th>ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</th>
                                        <th>æœŸå¾…ã•ã‚Œã‚‹çµæœ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</strong></td>
                                        <td>ãƒšãƒ¼ã‚¸é–“ã®é·ç§»</td>
                                        <td>ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ãƒœã‚¿ãƒ³</td>
                                        <td>ã‚¹ãƒ ãƒ¼ã‚ºãªç”»é¢é·ç§»</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</strong></td>
                                        <td>æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ</td>
                                        <td>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚¨ãƒ©ãƒ¼</td>
                                        <td>æ­£å¸¸ç™»éŒ²ã¨é©åˆ‡ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤º</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</strong></td>
                                        <td>æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</td>
                                        <td>ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</td>
                                        <td>é«˜é€Ÿãªæ¤œç´¢ã¨æ­£ç¢ºãªçµæœ</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</strong></td>
                                        <td>è©³ç´°æƒ…å ±è¡¨ç¤º</td>
                                        <td>ãƒ‡ãƒ¼ã‚¿ã®æ­£ç¢ºæ€§</td>
                                        <td>å®Œå…¨ãªæƒ…å ±è¡¨ç¤º</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†</strong></td>
                                        <td>æƒ…å ±æ›´æ–°ã¨å¤‰æ›´æ¤œå‡º</td>
                                        <td>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®‰å…¨æ€§</td>
                                        <td>ç¢ºå®Ÿãªæ›´æ–°ã¨å±¥æ­´è¨˜éŒ²</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤</strong></td>
                                        <td>ç¢ºèªãƒ—ãƒ­ã‚»ã‚¹</td>
                                        <td>å®‰å…¨æ€§ã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£</td>
                                        <td>å®‰å…¨ãªå‰Šé™¤ã¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½</td>
                                    </tr>
                                    <tr>
                                        <td><strong>çŠ¶æ…‹ç®¡ç†</strong></td>
                                        <td>ã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šæ€§</td>
                                        <td>ãƒ‡ãƒ¼ã‚¿ã®ä¸€è²«æ€§</td>
                                        <td>ç”»é¢é·ç§»ã§ã®ãƒ‡ãƒ¼ã‚¿ä¿æŒ</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</strong></td>
                                        <td>ç•°å¸¸ç³»ã®å‡¦ç†</td>
                                        <td>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</td>
                                        <td>æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>å®Œå…¨ãªCRUDæ©Ÿèƒ½ãŒçµ±åˆã•ã‚Œã€ã™ã¹ã¦ã®æ“ä½œãŒå®‰å…¨ã‹ã¤ç›´æ„Ÿçš„ã«å®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º -->
                    <div class="quiz-container">
                        <h5>ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º</h5>
                        <ol>
                            <li><strong>CRUDæ“ä½œ</strong>ã«ãŠã‘ã‚‹<strong>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</strong>ã®é‡è¦æ€§ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>çŠ¶æ…‹ç®¡ç†</strong>ã§<strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹</strong>ã¨<strong>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹</strong>ã®é•ã„ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°</strong>ãŒå¿…è¦ãªæ“ä½œã®ç¨®é¡ã‚’3ã¤æŒ™ã’ã€ãã®ç†ç”±ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ</strong>ã§ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹è¦ç´ ã‚’4ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ç·¨é›†æ©Ÿèƒ½</strong>ã§<strong>å¤‰æ›´æ¤œå‡º</strong>ã‚’å®Ÿè£…ã™ã‚‹åˆ©ç‚¹ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</strong>ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å‘ä¸Šã•ã›ã‚‹æ–¹æ³•ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ</strong>ã§<strong>æ¥½è¦³çš„ãƒ­ãƒƒã‚¯</strong>ã¨<strong>æ‚²è¦³çš„ãƒ­ãƒƒã‚¯</strong>ã®é•ã„ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>Streamlitã‚¢ãƒ—ãƒª</strong>ã§<strong>ãƒšãƒ¼ã‚¸é·ç§»</strong>ã‚’å®Ÿè£…ã™ã‚‹éš›ã®æ³¨æ„ç‚¹ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                        </ol>
                        
                        <details>
                            <summary>è§£ç­”ä¾‹</summary>
                            <ol>
                                <li>ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ä¿è¨¼ã€éƒ¨åˆ†æ›´æ–°ã®å›é¿ã€ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œã®ä¸€è²«æ€§</li>
                                <li>ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ãƒ‡ãƒ¼ã‚¿ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¯æ°¸ç¶šåŒ–ã•ã‚ŒãŸå…¨ä½“ã®çŠ¶æ…‹</li>
                                <li>å‰Šé™¤æ“ä½œï¼ˆå–ã‚Šæ¶ˆã—ä¸å¯ï¼‰ã€å¤§é‡ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ï¼ˆå½±éŸ¿ç¯„å›²ãŒå¤§ãã„ï¼‰ã€è¨­å®šå¤‰æ›´ï¼ˆã‚·ã‚¹ãƒ†ãƒ å‹•ä½œã«å½±éŸ¿ï¼‰</li>
                                <li>ãƒ‘ãƒ³ããšãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€æˆ»ã‚‹ãƒœã‚¿ãƒ³ã€ç¾åœ¨ä½ç½®è¡¨ç¤ºã€ç›´æ„Ÿçš„ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹é€ </li>
                                <li>ä¸è¦ãªæ›´æ–°ã®å›é¿ã€å¤‰æ›´å†…å®¹ã®æ˜ç¤ºã€æ“ä½œå±¥æ­´ã®è¨˜éŒ²ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªã®ä¿ƒé€²</li>
                                <li>æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€å›å¾©æ–¹æ³•ã®æç¤ºã€ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç®‡æ‰€ã®ç‰¹å®šã€ãƒ­ã‚°è¨˜éŒ²ã«ã‚ˆã‚‹è¿½è·¡</li>
                                <li>æ¥½è¦³çš„ï¼šç«¶åˆãƒã‚§ãƒƒã‚¯ã¯æ›´æ–°æ™‚ã€æ‚²è¦³çš„ï¼šãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã«ãƒ­ãƒƒã‚¯ã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹vsãƒ‡ãƒ¼ã‚¿å®‰å…¨æ€§</li>
                                <li>çŠ¶æ…‹ã®é©åˆ‡ãªç®¡ç†ã€st.rerun()ã®é©åˆ‡ãªä½¿ç”¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è€ƒæ…®</li>
                            </ol>
                        </details>
                    </div>

                    <!-- ã¾ã¨ã‚ -->
                    <h3 class="section-title">5.6 Step 5ã®ã¾ã¨ã‚</h3>
                    
                    <div class="highlight">
                        <h5>Step 5ã§ç¿’å¾—ã—ãŸã‚¹ã‚­ãƒ«</h5>
                        <ul>
                            <li>å®Œå…¨ãªCRUDæ“ä½œã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³</li>
                            <li>çŠ¶æ…‹ç®¡ç†ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ</li>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°è¡¨ç¤ºã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½</li>
                            <li>å®‰å…¨ãªç·¨é›†æ©Ÿèƒ½ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</li>
                            <li>ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãã®å‰Šé™¤æ©Ÿèƒ½</li>
                            <li>æ“ä½œå±¥æ­´ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</li>
                            <li>åŒ…æ‹¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</li>
                            <li>ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã®UI/UXè¨­è¨ˆ</li>
                        </ul>
                    </div>

                    <div class="success">
                        <h6>ğŸ‰ CRUDæ©Ÿèƒ½å®Œæˆï¼</h6>
                        <p>ã“ã‚Œã§Streamlit + SQLModelã‚’ä½¿ç”¨ã—ãŸå®Œå…¨ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®CRUDæ©Ÿèƒ½ãŒå®Œæˆã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒå…¨ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼š</p>
                        <ul>
                            <li>âœ… <strong>Create</strong>: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</li>
                            <li>âœ… <strong>Read</strong>: ä¸€è¦§è¡¨ç¤ºãƒ»è©³ç´°è¡¨ç¤ºãƒ»æ¤œç´¢æ©Ÿèƒ½</li>
                            <li>âœ… <strong>Update</strong>: å®‰å…¨ãªç·¨é›†æ©Ÿèƒ½</li>
                            <li>âœ… <strong>Delete</strong>: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãå‰Šé™¤</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>æ¬¡ã®Stepã«é€²ã‚€å‰ã«ç¢ºèªã™ã‚‹ã“ã¨</h6>
                        <ul>
                            <li>âœ… å…¨ã¦ã®CRUDæ“ä½œãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹</li>
                            <li>âœ… ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©åˆ‡ã«æ©Ÿèƒ½ã™ã‚‹</li>
                            <li>âœ… çŠ¶æ…‹ç®¡ç†ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹</li>
                            <li>âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã§ã‚ã‚‹</li>
                            <li>âœ… ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒæ©Ÿèƒ½ã™ã‚‹</li>
                            <li>âœ… æ“ä½œå±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã‚‹</li>
                            <li>âœ… ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ãŒé©åˆ‡ã§ã‚ã‚‹</li>
                            <li>âœ… ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ãŒè‰¯å¥½ã§ã‚ã‚‹</li>
                        </ul>
                    </div>

                    <div class="info">
                        <h6>ç™ºå±•çš„ãªå­¦ç¿’ã®ãƒ’ãƒ³ãƒˆ</h6>
                        <ul>
                            <li><strong>æ¨©é™ç®¡ç†</strong>: ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰</li>
                            <li><strong>ç›£æŸ»ãƒ­ã‚°</strong>: æ“ä½œå±¥æ­´ã®æ°¸ç¶šåŒ–ã¨åˆ†æ</li>
                            <li><strong>ãƒãƒƒãƒæ“ä½œ</strong>: è¤‡æ•°ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä¸€æ‹¬å‡¦ç†</li>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</strong>: ã‚ˆã‚Šé«˜åº¦ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼</li>
                            <li><strong>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</strong>: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®æœ€é©åŒ–</li>
                        </ul>
                    </div>

                    <!-- ç« é–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step4-user-list-display.html" class="btn btn-secondary">â† Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º</a>
                        <a href="step6-security-deployment.html" class="btn btn-primary">Step 6: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ â†’</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>