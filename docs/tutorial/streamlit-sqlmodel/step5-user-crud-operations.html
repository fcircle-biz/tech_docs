<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel チュートリアル Step 5 - ユーザー詳細・編集・削除機能</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: #2196f3;
        }

        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .chapter-title {
            color: #2196f3;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #1976d2;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e1f5fe;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #00bcd4;
        }

        .nav-link.active {
            background-color: #2196f3 !important;
            color: white !important;
        }

        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            color: #d63384;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }

        pre code {
            background-color: transparent;
            color: #212529;
            padding: 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Streamlit + SQLModel チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">チュートリアル目次</h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">
                                Step 2: データベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">
                                Step 3: ユーザー登録機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">
                                Step 4: ユーザー一覧表示
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step5-user-crud-operations.html">
                                Step 5: CRUD操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-dashboard-visualization.html">
                                Step 6: ダッシュボード
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-security-deployment.html">
                                Step 7: セキュリティ・デプロイ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 5: ユーザー詳細・編集・削除機能</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <span class="badge bg-primary">所要時間: 3時間</span>
                    </div>
                </div>

                <div id="step5">
                    <h2 class="chapter-title">ユーザー詳細・編集・削除機能</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>サイドバーでのナビゲーション機能の実装</li>
                            <li>ユーザー詳細情報の表示機能</li>
                            <li>インライン編集機能の設計と実装</li>
                            <li>確認ダイアログ付きの安全な削除機能</li>
                            <li>データベーストランザクション管理</li>
                            <li>Streamlitのセッション状態管理</li>
                        </ul>
                    </div>

                    <!-- CRUD操作の概念 -->
                    <h3 class="section-title">5.1 CRUD操作とは</h3>
                    <p>CRUD（Create、Read、Update、Delete）は、データベース操作の基本的な4つの操作です。前のステップでCreate（作成）とRead（読み取り）を実装しました。このステップでは、Update（更新）とDelete（削除）を実装します。</p>
                    
                    <div class="info">
                        <h6>CRUD操作の対応</h6>
                        <ul>
                            <li><strong>Create（作成）</strong>: ユーザー登録機能（Step 3で実装済み）</li>
                            <li><strong>Read（読み取り）</strong>: ユーザー一覧表示（Step 4で実装済み）</li>
                            <li><strong>Update（更新）</strong>: ユーザー情報編集機能（このステップで実装）</li>
                            <li><strong>Delete（削除）</strong>: ユーザー削除機能（このステップで実装）</li>
                        </ul>
                    </div>

                    <!-- ユーザー詳細表示 -->
                    <h3 class="section-title">5.2 ユーザー詳細表示機能</h3>
                    <p>個別ユーザーの詳細情報を表示し、編集や削除のベースとなる機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-1: ユーザー詳細表示機能の実装</h5>
                        <p>選択されたユーザーの詳細情報を表示するページを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>app/utils/user_details.py</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>import streamlit as st
from datetime import datetime
from typing import Optional

from app.models.user import User, UserStatus, Department
from app.database.crud import UserCRUD

class UserDetailManager:
    """ユーザー詳細管理クラス"""
    
    def __init__(self):
        self.setup_session_state()
    
    def setup_session_state(self):
        """セッション状態の初期化"""
        if 'selected_user_id' not in st.session_state:
            st.session_state.selected_user_id = None
        if 'edit_mode' not in st.session_state:
            st.session_state.edit_mode = False
        if 'delete_confirmation' not in st.session_state:
            st.session_state.delete_confirmation = False
    
    def display_user_selector(self) -> Optional[int]:
        """ユーザー選択UI"""
        users = UserCRUD.get_users(limit=1000)
        
        if not users:
            st.warning("ユーザーが登録されていません")
            return None
        
        # ユーザー選択ボックス
        user_options = {
            f"{user.id}": f"{user.username} ({user.full_name})"
            for user in users
        }
        
        selected_user_key = st.selectbox(
            "ユーザーを選択",
            options=list(user_options.keys()),
            format_func=lambda x: user_options[x],
            key="user_selector"
        )
        
        return int(selected_user_key) if selected_user_key else None
    
    def display_user_details(self, user: User):
        """ユーザー詳細情報の表示"""
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.subheader(f"👤 {user.full_name}")
            
            # 基本情報
            st.markdown("### 基本情報")
            
            info_data = {
                "ユーザーID": user.id,
                "ユーザー名": user.username,
                "メールアドレス": user.email,
                "フルネーム": user.full_name,
                "年齢": f"{user.age}歳" if user.age else "未設定",
                "部署": self.get_department_display(user.department),
                "ステータス": self.get_status_display(user.status),
                "アクティブ": "✅ はい" if user.is_active else "❌ いいえ"
            }
            
            for label, value in info_data.items():
                col_label, col_value = st.columns([1, 2])
                with col_label:
                    st.markdown(f"**{label}:**")
                with col_value:
                    st.markdown(str(value))
            
            # タイムスタンプ情報
            st.markdown("### タイムスタンプ")
            
            timestamp_data = {
                "作成日時": self.format_datetime(user.created_at),
                "更新日時": self.format_datetime(user.updated_at),
                "最終ログイン": self.format_datetime(user.last_login) if user.last_login else "未ログイン"
            }
            
            for label, value in timestamp_data.items():
                col_label, col_value = st.columns([1, 2])
                with col_label:
                    st.markdown(f"**{label}:**")
                with col_value:
                    st.markdown(value)
        
        with col2:
            # アクションボタン
            st.markdown("### アクション")
            
            if st.button("✏️ 編集", use_container_width=True, type="primary"):
                st.session_state.edit_mode = True
                st.rerun()
            
            if st.button("🗑️ 削除", use_container_width=True, type="secondary"):
                st.session_state.delete_confirmation = True
                st.rerun()
            
            if st.button("📄 プロフィール印刷", use_container_width=True):
                self.generate_user_profile_report(user)
            
            # ユーザー統計
            st.markdown("### 統計情報")
            
            # アカウント経過日数
            if user.created_at:
                days_since_creation = (datetime.utcnow() - user.created_at).days
                st.metric("アカウント作成から", f"{days_since_creation}日")
            
            # 最終ログインからの経過日数
            if user.last_login:
                days_since_login = (datetime.utcnow() - user.last_login).days
                st.metric("最終ログインから", f"{days_since_login}日")
            else:
                st.metric("最終ログインから", "未ログイン")
    
    def get_department_display(self, department: Department) -> str:
        """部署の表示名を取得"""
        if not department:
            return "未設定"
        
        department_map = {
            Department.ENGINEERING: "🔧 エンジニアリング",
            Department.MARKETING: "📢 マーケティング",
            Department.SALES: "💼 営業",
            Department.HR: "👥 人事",
            Department.FINANCE: "💰 財務",
            Department.OPERATIONS: "⚙️ 運営"
        }
        return department_map.get(department, department.value)
    
    def get_status_display(self, status: UserStatus) -> str:
        """ステータスの表示名を取得"""
        if not status:
            return "未設定"
        
        status_map = {
            UserStatus.ACTIVE: "🟢 アクティブ",
            UserStatus.INACTIVE: "🔴 非アクティブ",
            UserStatus.PENDING: "🟡 承認待ち",
            UserStatus.SUSPENDED: "🔴 停止中"
        }
        return status_map.get(status, status.value)
    
    def format_datetime(self, dt: Optional[datetime]) -> str:
        """日時のフォーマット"""
        if not dt:
            return "未設定"
        return dt.strftime("%Y年%m月%d日 %H:%M:%S")
    
    def generate_user_profile_report(self, user: User):
        """ユーザープロフィールレポートの生成"""
        report_content = f"""
# ユーザープロフィールレポート

**生成日時**: {datetime.now().strftime('%Y年%m月%d日 %H:%M:%S')}

## 基本情報
- **ユーザーID**: {user.id}
- **ユーザー名**: {user.username}
- **メールアドレス**: {user.email}
- **フルネーム**: {user.full_name}
- **年齢**: {user.age if user.age else '未設定'}
- **部署**: {self.get_department_display(user.department)}
- **ステータス**: {self.get_status_display(user.status)}
- **アクティブ**: {'はい' if user.is_active else 'いいえ'}

## タイムスタンプ
- **作成日時**: {self.format_datetime(user.created_at)}
- **更新日時**: {self.format_datetime(user.updated_at)}
- **最終ログイン**: {self.format_datetime(user.last_login) if user.last_login else '未ログイン'}
        """
        
        st.download_button(
            label="📄 レポートダウンロード",
            data=report_content,
            file_name=f"user_profile_{user.id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md",
            mime="text/markdown",
            use_container_width=True
        )</code></pre>

                        <ol start="2">
                            <li><code>app/pages/3_👤_User_Details.py</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>import streamlit as st
from typing import Optional

from app.utils.user_details import UserDetailManager
from app.database.crud import UserCRUD

def main():
    """ユーザー詳細ページのメイン関数"""
    st.set_page_config(
        page_title="ユーザー詳細",
        page_icon="👤",
        layout="wide"
    )
    
    st.title("👤 ユーザー詳細管理")
    st.markdown("---")
    
    detail_manager = UserDetailManager()
    
    # ユーザー選択
    selected_user_id = detail_manager.display_user_selector()
    
    if selected_user_id:
        user = UserCRUD.get_user(selected_user_id)
        
        if user:
            detail_manager.display_user_details(user)
        else:
            st.error("ユーザーが見つかりません")
    else:
        st.info("ユーザーを選択してください")

if __name__ == "__main__":
    main()</code></pre>

                        <h6>動作確認項目</h6>
                        <ul>
                            <li>ユーザー選択機能</li>
                            <li>詳細情報の表示</li>
                            <li>統計情報の計算</li>
                            <li>プロフィールレポート生成</li>
                        </ul>
                    </div>

                    <!-- ユーザー編集機能 -->
                    <h3 class="section-title">5.3 ユーザー編集機能</h3>
                    <p>既存ユーザーの情報を安全に更新する機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-2: インライン編集機能の実装</h5>
                        <p>ユーザー詳細画面からインライン編集を可能にする機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>app/utils/user_editor.py</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>import streamlit as st
from datetime import datetime
from typing import Optional, Dict, Any

from app.models.user import User, UserStatus, Department, UserUpdate
from app.database.crud import UserCRUD
from app.utils.validators import UserValidator

class UserEditor:
    """ユーザー編集管理クラス"""
    
    def __init__(self, user: User):
        self.user = user
        self.validator = UserValidator()
        self.setup_edit_state()
    
    def setup_edit_state(self):
        """編集状態の初期化"""
        if 'edit_form_data' not in st.session_state:
            st.session_state.edit_form_data = {
                'username': self.user.username,
                'email': self.user.email,
                'full_name': self.user.full_name,
                'age': self.user.age,
                'department': self.user.department.value if self.user.department else None,
                'status': self.user.status.value if self.user.status else None,
                'is_active': self.user.is_active
            }
    
    def render_edit_form(self) -> bool:
        """編集フォームの表示"""
        st.subheader("✏️ ユーザー情報編集")
        
        with st.form("user_edit_form"):
            col1, col2 = st.columns(2)
            
            with col1:
                # 基本情報
                st.markdown("#### 基本情報")
                
                username = st.text_input(
                    "ユーザー名",
                    value=st.session_state.edit_form_data['username'],
                    help="ログイン用のユーザー名（英数字、アンダースコア、ハイフンのみ）"
                )
                
                email = st.text_input(
                    "メールアドレス",
                    value=st.session_state.edit_form_data['email'],
                    help="有効なメールアドレスを入力してください"
                )
                
                full_name = st.text_input(
                    "フルネーム",
                    value=st.session_state.edit_form_data['full_name'],
                    help="表示用の氏名"
                )
                
                age = st.number_input(
                    "年齢",
                    min_value=0,
                    max_value=150,
                    value=st.session_state.edit_form_data['age'] or 0,
                    help="年齢を入力（0の場合は未設定として扱われます）"
                )
            
            with col2:
                # 追加情報
                st.markdown("#### 組織・ステータス")
                
                department_options = [None] + [dept.value for dept in Department]
                department_labels = {
                    None: "未設定",
                    'engineering': 'エンジニアリング',
                    'marketing': 'マーケティング',
                    'sales': '営業',
                    'hr': '人事',
                    'finance': '財務',
                    'operations': '運営'
                }
                
                department = st.selectbox(
                    "部署",
                    options=department_options,
                    format_func=lambda x: department_labels.get(x, x),
                    index=department_options.index(st.session_state.edit_form_data['department'])
                        if st.session_state.edit_form_data['department'] in department_options else 0
                )
                
                status_options = [status.value for status in UserStatus]
                status_labels = {
                    'active': 'アクティブ',
                    'inactive': '非アクティブ',
                    'pending': '承認待ち',
                    'suspended': '停止中'
                }
                
                status = st.selectbox(
                    "ステータス",
                    options=status_options,
                    format_func=lambda x: status_labels.get(x, x),
                    index=status_options.index(st.session_state.edit_form_data['status'])
                        if st.session_state.edit_form_data['status'] in status_options else 0
                )
                
                is_active = st.checkbox(
                    "アクティブ",
                    value=st.session_state.edit_form_data['is_active'],
                    help="チェックを外すとユーザーは非アクティブになります"
                )
                
                # 編集理由
                edit_reason = st.text_area(
                    "編集理由",
                    placeholder="編集の理由を入力してください（任意）",
                    help="変更履歴として記録されます"
                )
            
            # フォーム送信ボタン
            col1, col2, col3 = st.columns(3)
            
            with col1:
                submitted = st.form_submit_button("💾 更新", use_container_width=True, type="primary")
            
            with col2:
                preview = st.form_submit_button("👁️ プレビュー", use_container_width=True)
            
            with col3:
                cancel = st.form_submit_button("❌ キャンセル", use_container_width=True)
            
            if cancel:
                st.session_state.edit_mode = False
                st.rerun()
            
            if preview:
                self.show_edit_preview({
                    'username': username,
                    'email': email,
                    'full_name': full_name,
                    'age': age if age > 0 else None,
                    'department': department,
                    'status': status,
                    'is_active': is_active
                })
                return False
            
            if submitted:
                return self.process_user_update({
                    'username': username,
                    'email': email,
                    'full_name': full_name,
                    'age': age if age > 0 else None,
                    'department': department,
                    'status': status,
                    'is_active': is_active,
                    'edit_reason': edit_reason
                })
        
        return False
    
    def show_edit_preview(self, form_data: Dict[str, Any]):
        """編集内容のプレビュー表示"""
        st.markdown("---")
        st.subheader("👁️ 変更内容プレビュー")
        
        changes = []
        
        # 変更内容の検出
        if form_data['username'] != self.user.username:
            changes.append(f"ユーザー名: {self.user.username} → {form_data['username']}")
        
        if form_data['email'] != self.user.email:
            changes.append(f"メール: {self.user.email} → {form_data['email']}")
        
        if form_data['full_name'] != self.user.full_name:
            changes.append(f"フルネーム: {self.user.full_name} → {form_data['full_name']}")
        
        if form_data['age'] != self.user.age:
            old_age = self.user.age if self.user.age else "未設定"
            new_age = form_data['age'] if form_data['age'] else "未設定"
            changes.append(f"年齢: {old_age} → {new_age}")
        
        if form_data['department'] != (self.user.department.value if self.user.department else None):
            old_dept = self.user.department.value if self.user.department else "未設定"
            new_dept = form_data['department'] if form_data['department'] else "未設定"
            changes.append(f"部署: {old_dept} → {new_dept}")
        
        if form_data['status'] != (self.user.status.value if self.user.status else None):
            old_status = self.user.status.value if self.user.status else "未設定"
            new_status = form_data['status'] if form_data['status'] else "未設定"
            changes.append(f"ステータス: {old_status} → {new_status}")
        
        if form_data['is_active'] != self.user.is_active:
            changes.append(f"アクティブ: {self.user.is_active} → {form_data['is_active']}")
        
        if changes:
            st.info("以下の項目が変更されます:")
            for change in changes:
                st.write(f"• {change}")
        else:
            st.warning("変更はありません")
    
    def process_user_update(self, form_data: Dict[str, Any]) -> bool:
        """ユーザー更新処理"""
        try:
            # バリデーション
            validation_result = self.validator.validate_user_update(
                form_data, self.user.id
            )
            
            if not validation_result['is_valid']:
                for error in validation_result['errors']:
                    st.error(error)
                return False
            
            # 更新データの作成
            update_data = UserUpdate(
                username=form_data['username'],
                email=form_data['email'],
                full_name=form_data['full_name'],
                age=form_data['age'],
                department=Department(form_data['department']) if form_data['department'] else None,
                status=UserStatus(form_data['status']) if form_data['status'] else None,
                is_active=form_data['is_active'],
                updated_at=datetime.utcnow()
            )
            
            # データベース更新
            success = UserCRUD.update_user(self.user.id, update_data)
            
            if success:
                st.success("✅ ユーザー情報が正常に更新されました")
                
                # 編集履歴の記録（オプション）
                if form_data.get('edit_reason'):
                    st.info(f"編集理由: {form_data['edit_reason']}")
                
                # セッション状態のクリア
                st.session_state.edit_mode = False
                if 'edit_form_data' in st.session_state:
                    del st.session_state.edit_form_data
                
                # データキャッシュのクリア
                st.cache_data.clear()
                
                st.rerun()
                return True
            else:
                st.error("❌ ユーザー情報の更新に失敗しました")
                return False
                
        except Exception as e:
            st.error(f"❌ エラーが発生しました: {str(e)}")
            return False</code></pre>

                        <h6>編集機能の特徴</h6>
                        <ul>
                            <li><strong>プレビュー機能</strong>: 変更内容を事前確認</li>
                            <li><strong>バリデーション</strong>: 入力値の検証</li>
                            <li><strong>変更履歴</strong>: 編集理由の記録</li>
                            <li><strong>ロールバック</strong>: キャンセル機能</li>
                        </ul>
                    </div>

                    <!-- ユーザー削除機能 -->
                    <h3 class="section-title">5.4 安全なユーザー削除機能</h3>
                    <p>確認ダイアログと依存関係チェックを含む安全な削除機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-3: 確認ダイアログ付き削除機能</h5>
                        <p>誤操作を防ぐための確認ダイアログと依存関係チェックを含む削除機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>app/utils/user_deletion.py</code>ファイルを作成：</li>
                        </ol>
                        <pre><code>import streamlit as st
from datetime import datetime
from typing import Optional, List

from app.models.user import User
from app.database.crud import UserCRUD

class UserDeletionManager:
    """ユーザー削除管理クラス"""
    
    def __init__(self, user: User):
        self.user = user
        self.setup_deletion_state()
    
    def setup_deletion_state(self):
        """削除状態の初期化"""
        if 'deletion_step' not in st.session_state:
            st.session_state.deletion_step = 'initial'
        if 'deletion_confirmation_input' not in st.session_state:
            st.session_state.deletion_confirmation_input = ''
    
    def render_deletion_dialog(self) -> bool:
        """削除ダイアログの表示"""
        st.markdown("---")
        st.error("🗑️ ユーザー削除")
        
        if st.session_state.deletion_step == 'initial':
            return self.render_initial_warning()
        elif st.session_state.deletion_step == 'dependency_check':
            return self.render_dependency_check()
        elif st.session_state.deletion_step == 'final_confirmation':
            return self.render_final_confirmation()
        
        return False
    
    def render_initial_warning(self) -> bool:
        """初期警告の表示"""
        st.warning(f"""
        **⚠️ 重要な警告**
        
        ユーザー「{self.user.full_name}」({self.user.username})を削除しようとしています。
        
        この操作は取り消すことができません。削除されるデータ:
        - ユーザー基本情報
        - ログイン履歴
        - 関連するセッション情報
        """)
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("📋 依存関係確認", use_container_width=True):
                st.session_state.deletion_step = 'dependency_check'
                st.rerun()
        
        with col2:
            if st.button("❌ キャンセル", use_container_width=True):
                self.cancel_deletion()
                return False
        
        with col3:
            if st.button("⏭️ 削除続行", use_container_width=True, type="secondary"):
                st.session_state.deletion_step = 'final_confirmation'
                st.rerun()
        
        return False
    
    def render_dependency_check(self) -> bool:
        """依存関係チェックの表示"""
        st.info("🔍 依存関係チェック中...")
        
        # 依存関係の確認（実際のプロジェクトでは他のテーブルとの関連をチェック）
        dependencies = self.check_user_dependencies()
        
        if dependencies:
            st.warning("⚠️ 以下の関連データが見つかりました:")
            for dep in dependencies:
                st.write(f"• {dep}")
            
            st.error("""
            **削除の影響:**
            - 関連するデータも同時に削除されます
            - この操作は元に戻すことができません
            """)
        else:
            st.success("✅ 関連データは見つかりませんでした。安全に削除できます。")
        
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("⬅️ 戻る", use_container_width=True):
                st.session_state.deletion_step = 'initial'
                st.rerun()
        
        with col2:
            if st.button("🗑️ 削除実行", use_container_width=True, type="secondary"):
                st.session_state.deletion_step = 'final_confirmation'
                st.rerun()
        
        return False
    
    def render_final_confirmation(self) -> bool:
        """最終確認の表示"""
        st.error("""
        **🚨 最終確認**
        
        本当にこのユーザーを削除しますか？
        
        この操作は**絶対に取り消すことができません**。
        """)
        
        # 確認入力
        expected_input = f"DELETE {self.user.username}"
        confirmation_input = st.text_input(
            f"削除を確認するために「{expected_input}」と入力してください:",
            value=st.session_state.deletion_confirmation_input,
            placeholder=expected_input
        )
        
        st.session_state.deletion_confirmation_input = confirmation_input
        
        # 入力確認
        is_confirmed = confirmation_input == expected_input
        
        if not is_confirmed and confirmation_input:
            st.error("入力が正しくありません")
        
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("⬅️ 戻る", use_container_width=True):
                st.session_state.deletion_step = 'dependency_check'
                st.rerun()
        
        with col2:
            if st.button(
                "🗑️ 削除実行", 
                use_container_width=True, 
                type="secondary",
                disabled=not is_confirmed
            ):
                return self.execute_deletion()
        
        return False
    
    def check_user_dependencies(self) -> List[str]:
        """ユーザーの依存関係をチェック"""
        dependencies = []
        
        # ここでは例として簡単な依存関係チェックを実装
        # 実際のプロジェクトでは、他のテーブルとの外部キー関係などをチェック
        
        if self.user.last_login:
            dependencies.append(f"ログイン履歴: 最終ログイン {self.user.last_login.strftime('%Y-%m-%d %H:%M')}")
        
        if self.user.is_active:
            dependencies.append("アクティブなユーザーセッション")
        
        # 作成から7日以内の新規ユーザーの場合
        if self.user.created_at:
            days_since_creation = (datetime.utcnow() - self.user.created_at).days
            if days_since_creation < 7:
                dependencies.append(f"新規ユーザー（作成から{days_since_creation}日）")
        
        return dependencies
    
    def execute_deletion(self) -> bool:
        """削除実行"""
        try:
            # バックアップ情報の作成
            backup_info = {
                'id': self.user.id,
                'username': self.user.username,
                'email': self.user.email,
                'full_name': self.user.full_name,
                'deleted_at': datetime.utcnow()
            }
            
            # 削除実行
            success = UserCRUD.delete_user(self.user.id)
            
            if success:
                st.success(f"✅ ユーザー「{self.user.full_name}」が正常に削除されました")
                
                # 削除ログの記録（実際のプロジェクトではログシステムに記録）
                st.info(f"削除日時: {backup_info['deleted_at'].strftime('%Y-%m-%d %H:%M:%S')}")
                
                # セッション状態のクリア
                self.cancel_deletion()
                
                # データキャッシュのクリア
                st.cache_data.clear()
                
                # ページリダイレクト
                st.info("3秒後にユーザー一覧ページに戻ります...")
                st.balloons()
                
                return True
            else:
                st.error("❌ ユーザーの削除に失敗しました")
                return False
                
        except Exception as e:
            st.error(f"❌ 削除中にエラーが発生しました: {str(e)}")
            return False
    
    def cancel_deletion(self):
        """削除キャンセル"""
        st.session_state.deletion_step = 'initial'
        st.session_state.deletion_confirmation_input = ''
        st.session_state.delete_confirmation = False</code></pre>

                        <h6>削除機能の安全性対策</h6>
                        <ul>
                            <li><strong>多段階確認</strong>: 段階的な確認プロセス</li>
                            <li><strong>依存関係チェック</strong>: 関連データの確認</li>
                            <li><strong>テキスト確認</strong>: 手動入力による最終確認</li>
                            <li><strong>削除ログ</strong>: 削除操作の記録</li>
                        </ul>
                    </div>

                    <!-- トランザクション管理 -->
                    <h3 class="section-title">5.5 トランザクション管理</h3>
                    <p>データベース操作の整合性を保つためのトランザクション管理を実装します。</p>

                    <div class="info">
                        <h6>トランザクション管理の重要性</h6>
                        <ul>
                            <li><strong>原子性（Atomicity）</strong>: 操作が全て成功するか全て失敗するか</li>
                            <li><strong>一貫性（Consistency）</strong>: データの整合性を維持</li>
                            <li><strong>独立性（Isolation）</strong>: 同時実行操作の分離</li>
                            <li><strong>永続性（Durability）</strong>: 確定した変更の永続保存</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>CRUD操作での注意事項</h6>
                        <ul>
                            <li><strong>同時更新</strong>: 複数ユーザーの同時編集対策</li>
                            <li><strong>データ検証</strong>: 制約違反の事前チェック</li>
                            <li><strong>ロールバック</strong>: エラー時の安全な復旧</li>
                            <li><strong>監査ログ</strong>: 変更履歴の記録</li>
                        </ul>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>CRUD操作の4つの基本操作は何ですか？</li>
                            <li>Streamlitでセッション状態を管理するために使用するオブジェクトは？</li>
                            <li>データベース更新時にトランザクションを使用する理由は？</li>
                            <li>ユーザー削除時に確認ダイアログを表示する目的は？</li>
                            <li>インライン編集でプレビュー機能を提供する利点は？</li>
                        </ol>
                        
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>Create（作成）、Read（読み取り）、Update（更新）、Delete（削除）</li>
                                <li>st.session_state</li>
                                <li>データの整合性を保ち、エラー時のロールバックを可能にするため</li>
                                <li>誤操作による意図しないデータ削除を防ぐため</li>
                                <li>変更内容を事前確認でき、意図しない変更を防げるため</li>
                            </ol>
                        </details>
                    </div>

                    <!-- ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step4-user-list-display.html" class="btn btn-secondary">← 前のステップ: ユーザー一覧表示</a>
                        <a href="step6-dashboard-visualization.html" class="btn btn-primary">次のステップ: ダッシュボード →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>