<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET Core MVCå­¦ç¿’æ•™æ Step 7 - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æœ€é©åŒ–</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    
    <style>
        /* ASP.NETç”¨ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒ */
        :root {
            --primary-color: #512bd4;
            --secondary-color: #7c3aed;
            --background-color: #f8f9ff;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: var(--primary-color) !important;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .chapter-title {
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: var(--secondary-color);
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .success {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }
        
        .nav-link.active {
            background-color: var(--primary-color) !important;
            color: white !important;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .step-indicator {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ASP.NET Core MVC ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../">ãƒ›ãƒ¼ãƒ </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.html">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«æ¦‚è¦</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« ã‚¹ãƒ†ãƒƒãƒ—
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: ç’°å¢ƒæ§‹ç¯‰
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-mvc-architecture.html">
                                Step 2: MVCã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-database-design.html">
                                Step 3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-registration.html">
                                Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">
                                Step 5: ä¸€è¦§ãƒ»è©³ç´°è¡¨ç¤º
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">
                                Step 6: ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step7-security-optimization.html">
                                Step 7: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æœ€é©åŒ–
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Chapter Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 7: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æœ€é©åŒ–</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <small class="text-muted">æ‰€è¦æ™‚é–“: ç´„2æ™‚é–“</small>
                    </div>
                </div>

                <div id="step7">
                    <!-- Chapter Title -->
                    <h2 class="chapter-title">æœ¬ç•ªç’°å¢ƒå¯¾å¿œã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š</h2>
                    
                    <!-- Learning Objectives -->
                    <div class="highlight">
                        <h5>ã“ã®ç« ã§å­¦ã¶ã“ã¨</h5>
                        <ul>
                            <li>èªè¨¼ãƒ»èªå¯ã®åŸºç¤ï¼ˆIdentity Frameworkï¼‰</li>
                            <li>CSRFå¯¾ç­–ã¨AntiForgeryToken</li>
                            <li>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–</li>
                            <li>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</li>
                            <li>ãƒ­ã‚®ãƒ³ã‚°ã¨ã‚¨ãƒ©ãƒ¼å‡¦ç†</li>
                        </ul>
                    </div>

                    <!-- Section 7.1 -->
                    <h3 class="section-title">7.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®å®Ÿè£…</h3>
                    <p>Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <!-- Exercise 7-1 -->
                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-1: CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿè£…ç¢ºèª</h5>
                        <p>Cross-Site Request Forgery (CSRF) æ”»æ’ƒã‚’é˜²ãä»•çµ„ã¿ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>Program.vbã§Antiforgeryã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®šã‚’è¿½åŠ ï¼š</li>
                        </ol>

                        <h6>Program.vbï¼ˆCSRFå¯¾ç­–è¨­å®šï¼‰</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Dim builder = WebApplication.CreateBuilder(args)

' ã‚µãƒ¼ãƒ“ã‚¹ã®è¿½åŠ 
builder.Services.AddControllersWithViews()

' AntiForgeryè¨­å®šã®è¿½åŠ 
builder.Services.AddAntiforgery(Sub(options)
    options.HeaderName = "RequestVerificationToken"
    options.Cookie.Name = "__RequestVerificationToken"
    options.Cookie.HttpOnly = True
    options.Cookie.SecurePolicy = CookieSecurePolicy.SameAsRequest
    options.Cookie.SameSite = SameSiteMode.Strict
End Sub)

' æ—¢å­˜ã®DbContextè¨­å®š...

Dim app = builder.Build()

' æœ¬ç•ªç’°å¢ƒã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
If Not app.Environment.IsDevelopment() Then
    app.UseExceptionHandler("/Home/Error")
    app.UseHsts()
    
    ' ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ 
    app.Use(Async Function(context, nextDelegate)
        context.Response.Headers.Add("X-Content-Type-Options", "nosniff")
        context.Response.Headers.Add("X-Frame-Options", "DENY")
        context.Response.Headers.Add("X-XSS-Protection", "1; mode=block")
        context.Response.Headers.Add("Referrer-Policy", "strict-origin-when-cross-origin")
        Await nextDelegate()
    End Function)
End If

app.UseHttpsRedirection()
app.UseStaticFiles()
app.UseRouting()
app.UseAuthorization()

' ãã®ä»–ã®è¨­å®š...</code></pre>
                        </div>
                    </div>

                    <!-- Section 7.2 -->
                    <h3 class="section-title">7.2 å…¥åŠ›æ¤œè¨¼ã¨ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³</h3>
                    <p>XSSæ”»æ’ƒã‚„SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã‚’é˜²ããŸã‚ã®å¯¾ç­–ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="warning">
                        <h5>ä¸»è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨</h5>
                        <ul>
                            <li><strong>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³</strong>: æ‚ªæ„ã®ã‚ã‚‹SQLã‚³ãƒ¼ãƒ‰ã®æ³¨å…¥</li>
                            <li><strong>XSSï¼ˆCross-Site Scriptingï¼‰</strong>: æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ</li>
                            <li><strong>CSRFï¼ˆCross-Site Request Forgeryï¼‰</strong>: æ„å›³ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡</li>
                            <li><strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯</strong>: ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®ç›—ç”¨</li>
                        </ul>
                    </div>

                    <!-- Exercise 7-2 -->
                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-2: ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å±æ€§ã®å¼·åŒ–</h5>
                        <p>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>Models/ValidationAttributes/SafeStringAttribute.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports System.ComponentModel.DataAnnotations
Imports System.Text.RegularExpressions

Public Class SafeStringAttribute
    Inherits ValidationAttribute

    Private ReadOnly _allowHtml As Boolean

    Public Sub New(Optional allowHtml As Boolean = False)
        _allowHtml = allowHtml
    End Sub

    Protected Overrides Function IsValid(value As Object, validationContext As ValidationContext) As ValidationResult
        If value Is Nothing OrElse String.IsNullOrWhiteSpace(value.ToString()) Then
            Return ValidationResult.Success
        End If

        Dim input As String = value.ToString()

        ' HTMLã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯
        If Not _allowHtml AndAlso ContainsHtmlTags(input) Then
            Return New ValidationResult("HTMLã‚¿ã‚°ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚")
        End If

        ' SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        If ContainsSqlInjectionPatterns(input) Then
            Return New ValidationResult("ä¸æ­£ãªæ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚")
        End If

        ' ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯
        If ContainsScriptTags(input) Then
            Return New ValidationResult("ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚")
        End If

        Return ValidationResult.Success
    End Function

    Private Function ContainsHtmlTags(input As String) As Boolean
        Dim htmlTagPattern As String = "<[^>]+>"
        Return Regex.IsMatch(input, htmlTagPattern, RegexOptions.IgnoreCase)
    End Function

    Private Function ContainsSqlInjectionPatterns(input As String) As Boolean
        Dim sqlPatterns() As String = {
            "(\b(ALTER|CREATE|DELETE|DROP|EXEC(UTE){0,1}|INSERT( +INTO){0,1}|MERGE|SELECT|UPDATE|UNION( +ALL){0,1})\b)",
            "(\b(AND|OR)\b.+?(=|>|<|\!|<>|<=|>=))",
            "(\b(CHAR|NCHAR|VARCHAR|NVARCHAR)\s*\(\s*\d+\s*\))"
        }

        For Each pattern In sqlPatterns
            If Regex.IsMatch(input, pattern, RegexOptions.IgnoreCase) Then
                Return True
            End If
        Next

        Return False
    End Function

    Private Function ContainsScriptTags(input As String) As Boolean
        Dim scriptPattern As String = "<script[^>]*>.*?</script>"
        Return Regex.IsMatch(input, scriptPattern, RegexOptions.IgnoreCase Or RegexOptions.Singleline)
    End Function
End Class</code></pre>
                        </div>
                    </div>

                    <!-- Section 7.3 -->
                    <h3 class="section-title">7.3 ãƒ­ã‚®ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…</h3>
                    <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œã‚’ç›£è¦–ã—ã€å•é¡Œã‚’æ—©æœŸç™ºè¦‹ã™ã‚‹ãŸã‚ã®ãƒ­ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <!-- Exercise 7-3 -->
                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-3: æ§‹é€ åŒ–ãƒ­ã‚°ã®å®Ÿè£…</h5>
                        <p>Serilogã‚’ä½¿ç”¨ã—ãŸé«˜åº¦ãªãƒ­ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>Serilogãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š</li>
                        </ol>

                        <div class="code-block">
                            <pre><code class="language-powershell">Install-Package Serilog.AspNetCore
Install-Package Serilog.Sinks.File
Install-Package Serilog.Sinks.Console</code></pre>
                        </div>

                        <li><span class="step-indicator">2</span>Program.vbã§Serilogã‚’è¨­å®šï¼š</li>

                        <h6>Program.vbï¼ˆSerilogè¨­å®šï¼‰</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports Serilog

' Serilogã®è¨­å®š
Log.Logger = New LoggerConfiguration() _
    .MinimumLevel.Information() _
    .MinimumLevel.Override("Microsoft", LogEventLevel.Warning) _
    .MinimumLevel.Override("Microsoft.Hosting.Lifetime", LogEventLevel.Information) _
    .Enrich.FromLogContext() _
    .WriteTo.Console() _
    .WriteTo.File("logs/log-.txt", rollingInterval:=RollingInterval.Day) _
    .CreateLogger()

Try
    Log.Information("UserManagerPro ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™")

    Dim builder = WebApplication.CreateBuilder(args)

    ' Serilogã‚’ä½¿ç”¨
    builder.Host.UseSerilog()

    ' ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®š...
    builder.Services.AddControllersWithViews()

    ' ãã®ä»–ã®è¨­å®š...

    Dim app = builder.Build()

    ' ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°ã®è¿½åŠ 
    app.UseSerilogRequestLogging(Sub(options)
        options.MessageTemplate = "HTTP {RequestMethod} {RequestPath} responded {StatusCode} in {Elapsed:0.0000} ms"
        options.GetLevel = Function(httpContext, elapsed, ex)
            If ex IsNot Nothing Then
                Return LogEventLevel.Error
            ElseIf httpContext.Response.StatusCode > 499 Then
                Return LogEventLevel.Error
            ElseIf httpContext.Response.StatusCode > 399 Then
                Return LogEventLevel.Warning
            Else
                Return LogEventLevel.Information
            End If
        End Function
    End Sub)

    ' ãã®ä»–ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š...

    app.Run()

Catch ex As Exception
    Log.Fatal(ex, "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ")
Finally
    Log.CloseAndFlush()
End Try</code></pre>
                        </div>
                    </div>

                    <!-- Section 7.4 -->
                    <h3 class="section-title">7.4 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</h3>
                    <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€Ÿåº¦ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®æœ€é©åŒ–ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <!-- Exercise 7-4 -->
                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-4: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã®å®Ÿè£…</h5>
                        <p>é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>Program.vbã§ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ ï¼š</li>
                        </ol>

                        <h6>Program.vbï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šï¼‰</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">' ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¿½åŠ 
builder.Services.AddMemoryCache()

' ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¿½åŠ 
builder.Services.AddResponseCaching()

' ãƒ‡ãƒ¼ã‚¿åœ§ç¸®ã®è¿½åŠ 
builder.Services.AddResponseCompression(Sub(options)
    options.EnableForHttps = True
    options.Providers.Add(Of BrotliCompressionProvider)()
    options.Providers.Add(Of GzipCompressionProvider)()
End Sub)</code></pre>
                        </div>

                        <li><span class="step-indicator">2</span>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆï¼š</li>

                        <h6>Services/CacheService.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports Microsoft.Extensions.Caching.Memory
Imports UserManagerPro.Data
Imports UserManagerPro.Models

Public Interface ICacheService
    Function GetUsersAsync() As Task(Of List(Of User))
    Function GetUserByIdAsync(id As Integer) As Task(Of User)
    Sub ClearUserCache()
End Interface

Public Class CacheService
    Implements ICacheService

    Private ReadOnly _cache As IMemoryCache
    Private ReadOnly _context As ApplicationDbContext
    Private ReadOnly _logger As ILogger(Of CacheService)

    Private Const USERS_CACHE_KEY As String = "all_users"
    Private Const USER_CACHE_KEY_PREFIX As String = "user_"
    Private ReadOnly CACHE_EXPIRATION As TimeSpan = TimeSpan.FromMinutes(10)

    Public Sub New(cache As IMemoryCache, context As ApplicationDbContext, logger As ILogger(Of CacheService))
        _cache = cache
        _context = context
        _logger = logger
    End Sub

    Public Async Function GetUsersAsync() As Task(Of List(Of User)) Implements ICacheService.GetUsersAsync
        Return Await _cache.GetOrCreateAsync(USERS_CACHE_KEY, Async Function(entry)
            entry.AbsoluteExpirationRelativeToNow = CACHE_EXPIRATION
            _logger.LogInformation("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ä¸­...")
            Return Await _context.Users.OrderBy(Function(u) u.FullName).ToListAsync()
        End Function)
    End Function

    Public Async Function GetUserByIdAsync(id As Integer) As Task(Of User) Implements ICacheService.GetUserByIdAsync
        Dim cacheKey = USER_CACHE_KEY_PREFIX & id.ToString()
        Return Await _cache.GetOrCreateAsync(cacheKey, Async Function(entry)
            entry.AbsoluteExpirationRelativeToNow = CACHE_EXPIRATION
            _logger.LogInformation("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆID: {UserId}ï¼‰ã‚’å–å¾—ä¸­...", id)
            Return Await _context.Users.FindAsync(id)
        End Function)
    End Function

    Public Sub ClearUserCache() Implements ICacheService.ClearUserCache
        _cache.Remove(USERS_CACHE_KEY)
        _logger.LogInformation("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
    End Sub
End Class</code></pre>
                        </div>

                        <li><span class="step-indicator">3</span>Program.vbã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç™»éŒ²ï¼š</li>

                        <div class="code-block">
                            <pre><code class="language-vbnet">' ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒ“ã‚¹ã®ç™»éŒ²
builder.Services.AddScoped(Of ICacheService, CacheService)()</code></pre>
                        </div>
                    </div>

                    <!-- Section 7.5 -->
                    <h3 class="section-title">7.5 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–</h3>
                    <p>æœ¬ç•ªç’°å¢ƒã§ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <!-- Exercise 7-5 -->
                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-5: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</h5>
                        <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>Controllers/ErrorController.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports Microsoft.AspNetCore.Mvc
Imports System.Diagnostics

Public Class ErrorController
    Inherits Controller

    Private ReadOnly _logger As ILogger(Of ErrorController)

    Public Sub New(logger As ILogger(Of ErrorController))
        _logger = logger
    End Sub

    &lt;ResponseCache(Duration:=0, Location:=ResponseCacheLocation.None, NoStore:=True)&gt;
    Public Function Index() As IActionResult
        Dim requestId = Activity.Current?.Id OrElse HttpContext.TraceIdentifier
        
        _logger.LogError("ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚RequestId: {RequestId}", requestId)
        
        ViewData("RequestId") = requestId
        Return View()
    End Function

    &lt;Route("Error/{statusCode}")&gt;
    Public Function HttpStatusCodeHandler(statusCode As Integer) As IActionResult
        Select Case statusCode
            Case 404
                _logger.LogWarning("404ã‚¨ãƒ©ãƒ¼: ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Path: {Path}", Request.Path)
                ViewData("ErrorMessage") = "ãŠæ¢ã—ã®ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
                ViewData("ErrorCode") = "404"
                Return View("NotFound")
            Case 403
                _logger.LogWarning("403ã‚¨ãƒ©ãƒ¼: ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚Path: {Path}", Request.Path)
                ViewData("ErrorMessage") = "ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
                ViewData("ErrorCode") = "403"
                Return View("Forbidden")
            Case 500
                _logger.LogError("500ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼ã€‚Path: {Path}", Request.Path)
                ViewData("ErrorMessage") = "ã‚µãƒ¼ãƒãƒ¼ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
                ViewData("ErrorCode") = "500"
                Return View("ServerError")
            Case Else
                _logger.LogError("äºˆæœŸã—ãªã„HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: {StatusCode}ã€‚Path: {Path}", statusCode, Request.Path)
                ViewData("ErrorMessage") = "äºˆæœŸã—ãªã„å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
                ViewData("ErrorCode") = statusCode.ToString()
                Return View("GenericError")
        End Select
    End Function
End Class</code></pre>
                        </div>
                    </div>

                    <!-- Section 7.6 -->
                    <h3 class="section-title">7.6 æœ¬ç•ªç’°å¢ƒè¨­å®š</h3>
                    <p>æœ¬ç•ªç’°å¢ƒã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒæ…®ã—ãŸè¨­å®šã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="highlight">
                        <h5>æœ¬ç•ªç’°å¢ƒã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</h5>
                        <ol>
                            <li><strong>HTTPS ã®å¼·åˆ¶</strong>: ã™ã¹ã¦ã®é€šä¿¡ã‚’æš—å·åŒ–</li>
                            <li><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼</strong>: XSSã€ãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°æ”»æ’ƒã®é˜²æ­¢</li>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«</strong>: æ¥ç¶šç®¡ç†ã®æœ€é©åŒ–</li>
                            <li><strong>é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–</strong>: åœ§ç¸®ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥</li>
                            <li><strong>ãƒ­ã‚°ç®¡ç†</strong>: æ§‹é€ åŒ–ãƒ­ã‚°ã¨ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</li>
                        </ol>
                    </div>

                    <!-- Exercise 7-6 -->
                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 7-6: æœ¬ç•ªç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«</h5>
                        <p>æœ¬ç•ªç’°å¢ƒç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                        
                        <h6>appsettings.Production.json</h6>
                        <div class="code-block">
                            <pre><code class="language-json">{
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore.Database.Command": "Error",
      "UserManagerPro": "Information"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=prod-server;Database=UserManagerProDb;Integrated Security=true;TrustServerCertificate=true;Connection Timeout=30;Command Timeout=300;"
  },
  "Cache": {
    "DefaultExpirationMinutes": 30,
    "UserCacheExpirationMinutes": 15
  },
  "Security": {
    "RequireHttps": true,
    "UseSecurityHeaders": true,
    "EnableRequestSizeLimit": true,
    "MaxRequestSizeBytes": 10485760
  },
  "Performance": {
    "EnableResponseCompression": true,
    "EnableResponseCaching": true,
    "DatabaseCommandTimeout": 300
  }
}</code></pre>
                        </div>
                    </div>

                    <!-- Section 7.7 -->
                    <h3 class="section-title">7.7 ä»Šå¾Œã®ç™ºå±•å­¦ç¿’</h3>
                    <p>ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å®Œäº†ã—ãŸå¾Œã®å­¦ç¿’æ–¹å‘ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚</p>

                    <div class="quiz-container">
                        <h5>ç™ºå±•çš„ãªå­¦ç¿’ãƒˆãƒ”ãƒƒã‚¯</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>æŠ€è¡“çš„ãªæ‹¡å¼µ</h6>
                                <ul>
                                    <li><strong>ASP.NET Core Identity</strong>: æœ¬æ ¼çš„ãªèªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ </li>
                                    <li><strong>Web API</strong>: RESTful API ã®æ§‹ç¯‰</li>
                                    <li><strong>Blazor</strong>: SPAãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ´»ç”¨</li>
                                    <li><strong>SignalR</strong>: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡</li>
                                    <li><strong>Entity Framework Core Advanced</strong>: é«˜åº¦ãªORMæ©Ÿèƒ½</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ»DevOps</h6>
                                <ul>
                                    <li><strong>Azure App Service</strong>: ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤</li>
                                    <li><strong>Docker</strong>: ã‚³ãƒ³ãƒ†ãƒŠåŒ–</li>
                                    <li><strong>CI/CD</strong>: ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</li>
                                    <li><strong>Application Insights</strong>: ç›£è¦–ã¨ãƒ†ãƒ¬ãƒ¡ãƒˆãƒª</li>
                                    <li><strong>Redis Cache</strong>: åˆ†æ•£ã‚­ãƒ£ãƒƒã‚·ãƒ¥</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Final Success Message -->
                    <div class="success">
                        <h4><i class="fas fa-trophy"></i> ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</h4>
                        <p>ASP.NET Core MVC + Entity Framework Core + VB.NET ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚</p>
                        <p>ã‚ãªãŸã¯ä»¥ä¸‹ã®ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã¾ã—ãŸï¼š</p>
                        <ul>
                            <li>âœ… MVCã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç†è§£ã¨å®Ÿè£…</li>
                            <li>âœ… Entity Framework Coreã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ</li>
                            <li>âœ… å®Œå…¨ãªCRUDæ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®åŸºç¤</li>
                            <li>âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®åŸºç¤</li>
                            <li>âœ… æœ¬ç•ªç’°å¢ƒå¯¾å¿œã®çŸ¥è­˜</li>
                        </ul>
                        <p>ã“ã‚Œã‚‰ã®çŸ¥è­˜ã‚’åŸºç›¤ã¨ã—ã¦ã€ã•ã‚‰ã«é«˜åº¦ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ãã ã•ã„ï¼</p>
                    </div>

                    <!-- Understanding Check Quiz -->
                    <div class="quiz-container">
                        <h5>æœ€çµ‚ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º</h5>
                        <ol>
                            <li><strong>Question 1</strong>: CSRFæ”»æ’ƒã‚’é˜²ããŸã‚ã«ASP.NET Core MVCã§ä½¿ç”¨ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä½•ã§ã™ã‹ï¼Ÿ
                                <ul style="list-style-type: none;">
                                    <li>a) Authentication Token</li>
                                    <li>b) AntiForgery Token</li>
                                    <li>c) Session Token</li>
                                    <li>d) CSRF Token</li>
                                </ul>
                            </li>
                            <li><strong>Question 2</strong>: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã«é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚çš„ã«ä¿å­˜ã™ã‚‹ä»•çµ„ã¿ã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
                            <li><strong>Question 3</strong>: æœ¬ç•ªç’°å¢ƒã§ã®ãƒ­ã‚°ç®¡ç†ã«æ¨å¥¨ã•ã‚Œã‚‹æ§‹é€ åŒ–ãƒ­ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
                            <li><strong>Question 4</strong>: HTTPSã‚’å¼·åˆ¶ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§é˜²ã’ã‚‹ä¸»ãªæ”»æ’ƒã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>è§£ç­”ã‚’è¡¨ç¤º</summary>
                            <ol class="mt-2">
                                <li>b) AntiForgery Token - @Html.AntiForgeryToken()ã§ç”Ÿæˆã•ã‚Œã€CSRFæ”»æ’ƒã‚’é˜²ãã¾ã™</li>
                                <li>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆCacheï¼‰ - ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„åˆ†æ•£ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’é«˜é€ŸåŒ–ã—ã¾ã™</li>
                                <li>Serilog - æ§‹é€ åŒ–ãƒ­ã‚°ã‚’æä¾›ã—ã€æ§˜ã€…ãªå‡ºåŠ›å…ˆã«å¯¾å¿œã—ãŸé«˜æ©Ÿèƒ½ãªãƒ­ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™</li>
                                <li>XSSæ”»æ’ƒã€ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°ã€MITMæ”»æ’ƒãªã© - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã¨HTTPSåŒ–ã«ã‚ˆã‚Šå¤šãã®æ”»æ’ƒã‚’é˜²ã’ã¾ã™</li>
                            </ol>
                        </details>
                    </div>

                    <!-- Resources -->
                    <div class="highlight">
                        <h5>å‚è€ƒè³‡æ–™ã¨ãƒªãƒ³ã‚¯</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</h6>
                                <ul>
                                    <li><a href="https://docs.microsoft.com/ja-jp/aspnet/core/" target="_blank">ASP.NET Core å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a></li>
                                    <li><a href="https://docs.microsoft.com/ja-jp/ef/core/" target="_blank">Entity Framework Core å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a></li>
                                    <li><a href="https://docs.microsoft.com/ja-jp/dotnet/visual-basic/" target="_blank">Visual Basic è¨€èªãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</a></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ»å­¦ç¿’</h6>
                                <ul>
                                    <li><a href="https://github.com/dotnet" target="_blank">.NET GitHub ãƒªãƒã‚¸ãƒˆãƒª</a></li>
                                    <li><a href="https://docs.microsoft.com/ja-jp/learn/" target="_blank">Microsoft Learn</a></li>
                                    <li><a href="https://stackoverflow.com/questions/tagged/asp.net-core" target="_blank">Stack Overflow</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step6-user-update-delete.html" class="btn btn-secondary">â† Step 6: ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½</a>
                        <a href="README.html" class="btn btn-success">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº† ğŸ‰</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/vbnet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>