<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET Core MVC学習教材 Step 4 - ユーザー登録機能の実装</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    
    <style>
        /* ASP.NET用カラーテーマ */
        :root {
            --primary-color: #512bd4;
            --secondary-color: #7c3aed;
            --background-color: #f8f9ff;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: var(--primary-color) !important;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .chapter-title {
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: var(--secondary-color);
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .nav-link.active {
            background-color: var(--primary-color) !important;
            color: white !important;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .step-indicator {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ASP.NET Core MVC チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.html">チュートリアル概要</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        チュートリアル ステップ
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-mvc-architecture.html">
                                Step 2: MVCアーキテクチャ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-database-design.html">
                                Step 3: データベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step4-user-registration.html">
                                Step 4: ユーザー登録機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">
                                Step 5: 一覧・詳細表示
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">
                                Step 6: 編集・削除機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-security-optimization.html">
                                Step 7: セキュリティと最適化
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Chapter Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 4: ユーザー登録機能の実装</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <small class="text-muted">所要時間: 約2.5時間</small>
                    </div>
                </div>

                <div id="step4">
                    <!-- Chapter Title -->
                    <h2 class="chapter-title">フォーム処理とデータ保存の実装</h2>
                    
                    <!-- Learning Objectives -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>登録フォームの作成（Razor構文）</li>
                            <li>モデルバインディングの仕組み</li>
                            <li>データアノテーションによるバリデーション</li>
                            <li>POST処理とデータベース保存</li>
                            <li>エラーハンドリングとフィードバック表示</li>
                        </ul>
                    </div>

                    <!-- Section 4.1 -->
                    <h3 class="section-title">4.1 UsersControllerの作成</h3>
                    <p>ユーザー管理のメインコントローラーを作成し、CRUD操作の基盤を整備します。</p>

                    <!-- Exercise 4-1 -->
                    <div class="exercise-container">
                        <h5>実習 4-1: UsersControllerの作成</h5>
                        <p>ユーザー管理機能を担当するコントローラーを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>「Controllers」フォルダに「UsersController.vb」を作成</li>
                            <li><span class="step-indicator">2</span>以下のコードを記述：</li>
                        </ol>

                        <h6>Controllers/UsersController.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports Microsoft.AspNetCore.Mvc
Imports Microsoft.EntityFrameworkCore
Imports UserManagerPro.Data
Imports UserManagerPro.Models

Public Class UsersController
    Inherits Controller

    Private ReadOnly _context As ApplicationDbContext

    Public Sub New(context As ApplicationDbContext)
        _context = context
    End Sub

    ' GET: Users
    Public Async Function Index() As Task(Of IActionResult)
        Dim users = Await _context.Users.ToListAsync()
        Return View(users)
    End Function

    ' GET: Users/Details/5
    Public Async Function Details(id As Integer?) As Task(Of IActionResult)
        If id Is Nothing Then
            Return NotFound()
        End If

        Dim user = Await _context.Users.FirstOrDefaultAsync(Function(u) u.Id = id)
        If user Is Nothing Then
            Return NotFound()
        End If

        Return View(user)
    End Function

    ' GET: Users/Create
    Public Function Create() As IActionResult
        Return View()
    End Function

    ' POST: Users/Create
    &lt;HttpPost&gt;
    &lt;ValidateAntiForgeryToken&gt;
    Public Async Function Create(&lt;Bind("Username,Email,FullName,Age,Department,IsActive")&gt; user As User) As Task(Of IActionResult)
        If ModelState.IsValid Then
            Try
                ' 重複チェック
                Dim existingUserByUsername = Await _context.Users.FirstOrDefaultAsync(Function(u) u.Username = user.Username)
                If existingUserByUsername IsNot Nothing Then
                    ModelState.AddModelError("Username", "このユーザー名は既に使用されています。")
                    Return View(user)
                End If

                Dim existingUserByEmail = Await _context.Users.FirstOrDefaultAsync(Function(u) u.Email = user.Email)
                If existingUserByEmail IsNot Nothing Then
                    ModelState.AddModelError("Email", "このメールアドレスは既に使用されています。")
                    Return View(user)
                End If

                ' タイムスタンプ設定
                user.CreatedAt = DateTime.Now
                user.UpdatedAt = DateTime.Now

                _context.Add(user)
                Await _context.SaveChangesAsync()

                TempData("SuccessMessage") = $"ユーザー「{user.FullName}」を正常に登録しました。"
                Return RedirectToAction(NameOf(Index))

            Catch ex As Exception
                ModelState.AddModelError("", $"登録中にエラーが発生しました: {ex.Message}")
            End Try
        End If

        Return View(user)
    End Function

    ' プライベートヘルパーメソッド
    Private Function UserExists(id As Integer) As Boolean
        Return _context.Users.Any(Function(e) e.Id = id)
    End Function
End Class</code></pre>
                        </div>
                    </div>

                    <!-- Section 4.2 -->
                    <h3 class="section-title">4.2 ユーザー登録フォームの作成</h3>
                    <p>Razor構文を使用して、バリデーション機能付きの登録フォームを作成します。</p>

                    <!-- Exercise 4-2 -->
                    <div class="exercise-container">
                        <h5>実習 4-2: 登録フォームビューの作成</h5>
                        <p>ユーザー登録用のフォームを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>「Views」フォルダに「Users」フォルダを作成</li>
                            <li><span class="step-indicator">2</span>「Views/Users」フォルダに「Create.vbhtml」を作成</li>
                            <li><span class="step-indicator">3</span>以下のコードを記述：</li>
                        </ol>

                        <h6>Views/Users/Create.vbhtml</h6>
                        <div class="code-block">
                            <pre><code class="language-html">@ModelType UserManagerPro.Models.User
@{
    ViewData("Title") = "新規ユーザー登録"
}

&lt;div class="container mt-4"&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-md-8 offset-md-2"&gt;
            &lt;div class="card"&gt;
                &lt;div class="card-header"&gt;
                    &lt;h4&gt;&lt;i class="fas fa-user-plus"&gt;&lt;/i&gt; @ViewData("Title")&lt;/h4&gt;
                &lt;/div&gt;
                &lt;div class="card-body"&gt;
                    @Using Html.BeginForm("Create", "Users", FormMethod.Post, New With {.class = "needs-validation", .novalidate = ""})
                        @Html.AntiForgeryToken()
                        
                        @* バリデーションサマリー *@
                        @Html.ValidationSummary(True, "", New With {.class = "alert alert-danger"})

                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-md-6"&gt;
                                @Html.LabelFor(Function(model) model.Username, New With {.class = "form-label"})
                                @Html.EditorFor(Function(model) model.Username, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "ユーザー名を入力"}})
                                @Html.ValidationMessageFor(Function(model) model.Username, "", New With {.class = "invalid-feedback d-block"})
                            &lt;/div&gt;
                            &lt;div class="col-md-6"&gt;
                                @Html.LabelFor(Function(model) model.Email, New With {.class = "form-label"})
                                @Html.EditorFor(Function(model) model.Email, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "email@example.com", .type = "email"}})
                                @Html.ValidationMessageFor(Function(model) model.Email, "", New With {.class = "invalid-feedback d-block"})
                            &lt;/div&gt;
                        &lt;/div&gt;

                        &lt;div class="mb-3"&gt;
                            @Html.LabelFor(Function(model) model.FullName, New With {.class = "form-label"})
                            @Html.EditorFor(Function(model) model.FullName, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "氏名を入力"}})
                            @Html.ValidationMessageFor(Function(model) model.FullName, "", New With {.class = "invalid-feedback d-block"})
                        &lt;/div&gt;

                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-md-6"&gt;
                                @Html.LabelFor(Function(model) model.Age, New With {.class = "form-label"})
                                @Html.EditorFor(Function(model) model.Age, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "年齢（任意）", .type = "number", .min = "0", .max = "150"}})
                                @Html.ValidationMessageFor(Function(model) model.Age, "", New With {.class = "invalid-feedback d-block"})
                            &lt;/div&gt;
                            &lt;div class="col-md-6"&gt;
                                @Html.LabelFor(Function(model) model.Department, New With {.class = "form-label"})
                                @Html.EditorFor(Function(model) model.Department, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "部署名（任意）"}})
                                @Html.ValidationMessageFor(Function(model) model.Department, "", New With {.class = "invalid-feedback d-block"})
                            &lt;/div&gt;
                        &lt;/div&gt;

                        &lt;div class="mb-3"&gt;
                            &lt;div class="form-check"&gt;
                                @Html.EditorFor(Function(model) model.IsActive, New With {.htmlAttributes = New With {.class = "form-check-input"}})
                                @Html.LabelFor(Function(model) model.IsActive, "アクティブユーザーとして登録", New With {.class = "form-check-label"})
                            &lt;/div&gt;
                        &lt;/div&gt;

                        &lt;div class="d-grid gap-2 d-md-flex justify-content-md-end"&gt;
                            &lt;a href="@Url.Action("Index")" class="btn btn-secondary me-md-2"&gt;
                                &lt;i class="fas fa-arrow-left"&gt;&lt;/i&gt; キャンセル
                            &lt;/a&gt;
                            &lt;button type="submit" class="btn btn-primary"&gt;
                                &lt;i class="fas fa-save"&gt;&lt;/i&gt; 登録
                            &lt;/button&gt;
                        &lt;/div&gt;
                    End Using
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

@Section Scripts {
    @Html.Partial("_ValidationScriptsPartial")
    
    &lt;script&gt;
        // Bootstrap のバリデーション機能を有効化
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
    &lt;/script&gt;
}</code></pre>
                        </div>
                    </div>

                    <!-- Section 4.3 -->
                    <h3 class="section-title">4.3 ユーザー一覧ページの作成</h3>
                    <p>登録されたユーザーを一覧表示するページを作成します。</p>

                    <!-- Exercise 4-3 -->
                    <div class="exercise-container">
                        <h5>実習 4-3: ユーザー一覧ビューの作成</h5>
                        <p>登録済みユーザーの一覧を表示するビューを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>「Views/Users」フォルダに「Index.vbhtml」を作成</li>
                            <li><span class="step-indicator">2</span>以下のコードを記述：</li>
                        </ol>

                        <h6>Views/Users/Index.vbhtml</h6>
                        <div class="code-block">
                            <pre><code class="language-html">@ModelType IEnumerable(Of UserManagerPro.Models.User)
@{
    ViewData("Title") = "ユーザー一覧"
}

&lt;div class="container mt-4"&gt;
    &lt;div class="d-flex justify-content-between align-items-center mb-3"&gt;
        &lt;h2&gt;&lt;i class="fas fa-users"&gt;&lt;/i&gt; @ViewData("Title")&lt;/h2&gt;
        &lt;a href="@Url.Action("Create")" class="btn btn-primary"&gt;
            &lt;i class="fas fa-plus"&gt;&lt;/i&gt; 新規登録
        &lt;/a&gt;
    &lt;/div&gt;

    @* 成功メッセージの表示 *@
    @If TempData("SuccessMessage") IsNot Nothing Then
        @&lt;div class="alert alert-success alert-dismissible fade show" role="alert"&gt;
            &lt;i class="fas fa-check-circle"&gt;&lt;/i&gt; @TempData("SuccessMessage")
            &lt;button type="button" class="btn-close" data-bs-dismiss="alert"&gt;&lt;/button&gt;
        &lt;/div&gt;
    End If

    @If Model.Any() Then
        @&lt;div class="card"&gt;
            &lt;div class="card-body"&gt;
                &lt;div class="table-responsive"&gt;
                    &lt;table class="table table-hover"&gt;
                        &lt;thead class="table-dark"&gt;
                            &lt;tr&gt;
                                &lt;th&gt;@Html.DisplayNameFor(Function(model) model.Username)&lt;/th&gt;
                                &lt;th&gt;@Html.DisplayNameFor(Function(model) model.FullName)&lt;/th&gt;
                                &lt;th&gt;@Html.DisplayNameFor(Function(model) model.Email)&lt;/th&gt;
                                &lt;th&gt;@Html.DisplayNameFor(Function(model) model.Age)&lt;/th&gt;
                                &lt;th&gt;@Html.DisplayNameFor(Function(model) model.Department)&lt;/th&gt;
                                &lt;th&gt;@Html.DisplayNameFor(Function(model) model.IsActive)&lt;/th&gt;
                                &lt;th&gt;@Html.DisplayNameFor(Function(model) model.CreatedAt)&lt;/th&gt;
                                &lt;th&gt;操作&lt;/th&gt;
                            &lt;/tr&gt;
                        &lt;/thead&gt;
                        &lt;tbody&gt;
                            @For Each item In Model
                                @&lt;tr&gt;
                                    &lt;td&gt;
                                        &lt;span class="badge bg-primary"&gt;@Html.DisplayFor(Function(modelItem) item.Username)&lt;/span&gt;
                                    &lt;/td&gt;
                                    &lt;td&gt;@Html.DisplayFor(Function(modelItem) item.FullName)&lt;/td&gt;
                                    &lt;td&gt;@Html.DisplayFor(Function(modelItem) item.Email)&lt;/td&gt;
                                    &lt;td&gt;
                                        @If item.Age.HasValue Then
                                            @item.Age.Value
                                            @&lt;small class="text-muted"&gt;歳&lt;/small&gt;
                                        Else
                                            @&lt;span class="text-muted"&gt;-&lt;/span&gt;
                                        End If
                                    &lt;/td&gt;
                                    &lt;td&gt;
                                        @If Not String.IsNullOrEmpty(item.Department) Then
                                            @item.Department
                                        Else
                                            @&lt;span class="text-muted"&gt;-&lt;/span&gt;
                                        End If
                                    &lt;/td&gt;
                                    &lt;td&gt;
                                        @If item.IsActive Then
                                            @&lt;span class="badge bg-success"&gt;&lt;i class="fas fa-check"&gt;&lt;/i&gt; 有効&lt;/span&gt;
                                        Else
                                            @&lt;span class="badge bg-secondary"&gt;&lt;i class="fas fa-times"&gt;&lt;/i&gt; 無効&lt;/span&gt;
                                        End If
                                    &lt;/td&gt;
                                    &lt;td&gt;
                                        &lt;small class="text-muted"&gt;@item.CreatedAt.ToString("yyyy/MM/dd")&lt;/small&gt;
                                    &lt;/td&gt;
                                    &lt;td&gt;
                                        &lt;div class="btn-group" role="group"&gt;
                                            &lt;a href="@Url.Action("Details", New With {.id = item.Id})" class="btn btn-sm btn-outline-info" title="詳細"&gt;
                                                &lt;i class="fas fa-eye"&gt;&lt;/i&gt;
                                            &lt;/a&gt;
                                            &lt;a href="@Url.Action("Edit", New With {.id = item.Id})" class="btn btn-sm btn-outline-primary" title="編集"&gt;
                                                &lt;i class="fas fa-edit"&gt;&lt;/i&gt;
                                            &lt;/a&gt;
                                            &lt;a href="@Url.Action("Delete", New With {.id = item.Id})" class="btn btn-sm btn-outline-danger" title="削除"&gt;
                                                &lt;i class="fas fa-trash"&gt;&lt;/i&gt;
                                            &lt;/a&gt;
                                        &lt;/div&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                            Next
                        &lt;/tbody&gt;
                    &lt;/table&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    Else
        @&lt;div class="text-center py-5"&gt;
            &lt;i class="fas fa-users fa-3x text-muted mb-3"&gt;&lt;/i&gt;
            &lt;h4 class="text-muted"&gt;ユーザーが登録されていません&lt;/h4&gt;
            &lt;p class="text-muted"&gt;最初のユーザーを登録してみましょう。&lt;/p&gt;
            &lt;a href="@Url.Action("Create")" class="btn btn-primary btn-lg"&gt;
                &lt;i class="fas fa-plus"&gt;&lt;/i&gt; 新規登録
            &lt;/a&gt;
        &lt;/div&gt;
    End If
&lt;/div&gt;

@Section Scripts {
    &lt;script&gt;
        // テーブル行のホバーエフェクト
        document.addEventListener('DOMContentLoaded', function() {
            const tableRows = document.querySelectorAll('tbody tr');
            tableRows.forEach(row =&gt; {
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
        });
    &lt;/script&gt;
}</code></pre>
                        </div>
                    </div>

                    <!-- Section 4.4 -->
                    <h3 class="section-title">4.4 バリデーション機能の強化</h3>
                    <p>サーバーサイドとクライアントサイドの両方でバリデーションを実装します。</p>

                    <div class="highlight">
                        <h5>MVCにおけるバリデーションの仕組み</h5>
                        <ol>
                            <li><strong>データアノテーション</strong>: モデルクラスにバリデーション規則を定義</li>
                            <li><strong>ModelState</strong>: コントローラーでバリデーション結果を確認</li>
                            <li><strong>ValidationSummary</strong>: ビューでエラーメッセージを表示</li>
                            <li><strong>クライアントサイドバリデーション</strong>: JavaScriptによるリアルタイム検証</li>
                        </ol>
                    </div>

                    <!-- Exercise 4-4 -->
                    <div class="exercise-container">
                        <h5>実習 4-4: カスタムバリデーションの追加</h5>
                        <p>独自のバリデーション規則を作成して、より厳密なデータ検証を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>「Models」フォルダに「ValidationAttributes」フォルダを作成</li>
                            <li><span class="step-indicator">2</span>カスタムバリデーション属性を作成：</li>
                        </ol>

                        <h6>Models/ValidationAttributes/UniqueUsernameAttribute.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports System.ComponentModel.DataAnnotations
Imports Microsoft.Extensions.DependencyInjection
Imports UserManagerPro.Data

Public Class UniqueUsernameAttribute
    Inherits ValidationAttribute

    Protected Overrides Function IsValid(value As Object, validationContext As ValidationContext) As ValidationResult
        If value Is Nothing OrElse String.IsNullOrWhiteSpace(value.ToString()) Then
            Return ValidationResult.Success
        End If

        Dim username As String = value.ToString()

        ' DIコンテナからDbContextを取得
        Dim context = validationContext.GetService(Of ApplicationDbContext)()

        If context IsNot Nothing Then
            ' 既存のユーザー名をチェック
            Dim existingUser = context.Users.FirstOrDefault(Function(u) u.Username = username)
            
            If existingUser IsNot Nothing Then
                Return New ValidationResult("このユーザー名は既に使用されています。")
            End If
        End If

        Return ValidationResult.Success
    End Function
End Class</code></pre>
                        </div>

                        <li><span class="step-indicator">3</span>Userモデルにカスタムバリデーションを適用：</li>

                        <div class="code-block">
                            <pre><code class="language-vbnet">' Models/User.vb に追加する属性
Imports UserManagerPro.Models.ValidationAttributes

Public Class User
    ' 既存のプロパティ...

    ' カスタムバリデーション適用例
    &lt;Required(ErrorMessage:="ユーザー名は必須です。")&gt;
    &lt;StringLength(50, ErrorMessage:="ユーザー名は50文字以内で入力してください。")&gt;
    &lt;RegularExpression("^[a-zA-Z0-9_]+$", ErrorMessage:="ユーザー名は英数字とアンダースコアのみ使用できます。")&gt;
    Public Property Username As String

    ' その他のプロパティ...
End Class</code></pre>
                        </div>
                    </div>

                    <!-- Section 4.5 -->
                    <h3 class="section-title">4.5 エラーハンドリングとユーザーフィードバック</h3>
                    <p>適切なエラーハンドリングとユーザーへのフィードバック機能を実装します。</p>

                    <div class="quiz-container">
                        <h5>Web Forms vs MVC のフォーム処理比較</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>項目</th>
                                        <th>Web Forms</th>
                                        <th>ASP.NET Core MVC</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>フォーム処理</strong></td>
                                        <td>サーバーコントロール<br>（TextBox、Button等）</td>
                                        <td>HTML Helper<br>（EditorFor、LabelFor等）</td>
                                    </tr>
                                    <tr>
                                        <td><strong>バリデーション</strong></td>
                                        <td>Validator コントロール<br>（RequiredFieldValidator等）</td>
                                        <td>データアノテーション<br>（Required、StringLength等）</td>
                                    </tr>
                                    <tr>
                                        <td><strong>ポストバック</strong></td>
                                        <td>ViewState による状態管理</td>
                                        <td>ステートレス HTTP POST</td>
                                    </tr>
                                    <tr>
                                        <td><strong>エラー表示</strong></td>
                                        <td>ValidationSummary コントロール</td>
                                        <td>ValidationSummary Helper</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Understanding Check Quiz -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>Question 1</strong>: ASP.NET Core MVCにおいて、フォームからの入力データをモデルオブジェクトに自動的にマップする機能は何と呼ばれますか？
                                <ul style="list-style-type: none;">
                                    <li>a) ViewState</li>
                                    <li>b) Model Binding</li>
                                    <li>c) Data Binding</li>
                                    <li>d) Object Mapping</li>
                                </ul>
                            </li>
                            <li><strong>Question 2</strong>: CSRF攻撃を防ぐためにフォームに含めるべきトークンは何ですか？</li>
                            <li><strong>Question 3</strong>: コントローラーでバリデーションの結果を確認するために使用するプロパティは何ですか？</li>
                            <li><strong>Question 4</strong>: 一時的なメッセージ（成功通知など）をページ間で受け渡すために使用するオブジェクトは何ですか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を表示</summary>
                            <ol class="mt-2">
                                <li>b) Model Binding - HTTPリクエストのデータを自動的にモデルオブジェクトにマッピングします</li>
                                <li>AntiForgeryToken - @Html.AntiForgeryToken() で生成し、[ValidateAntiForgeryToken] 属性で検証します</li>
                                <li>ModelState - ModelState.IsValid でバリデーション結果を確認できます</li>
                                <li>TempData - リダイレクト後の次のリクエストまでデータを保持します</li>
                            </ol>
                        </details>
                    </div>

                    <!-- Next Steps -->
                    <div class="highlight">
                        <h5>次のステップの準備</h5>
                        <p>Step 4 が完了したら、以下を確認してください：</p>
                        <ul>
                            <li>✅ UsersControllerが正しく作成された</li>
                            <li>✅ ユーザー登録フォームが動作する</li>
                            <li>✅ バリデーション機能が正常に動作する</li>
                            <li>✅ データベースにユーザーが保存される</li>
                            <li>✅ ユーザー一覧ページでデータが表示される</li>
                            <li>✅ エラーハンドリングが適切に動作する</li>
                        </ul>
                        <p>これらが完了したら、<strong>Step 5: ユーザー一覧と詳細表示</strong>に進みましょう。</p>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step3-database-design.html" class="btn btn-secondary">← Step 3: データベース設計</a>
                        <a href="step5-user-list-detail.html" class="btn btn-primary">Step 5: 一覧・詳細表示 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/vbnet.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>