<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot + Gradle チュートリアル Step 5 - ユーザー登録機能の実装</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #4caf50;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #4caf50;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #4caf50;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #66bb6a;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #4caf50;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #4caf50 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Spring Boot + Gradle チュートリアル</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-docker-postgresql.html">
                                Step 2: PostgreSQL環境
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-spring-mvc-web.html">
                                Step 3: Webコントローラー
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-spring-data-jpa.html">
                                Step 4: データベースアクセス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step5-user-registration.html">
                                Step 5: ユーザー登録機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-thymeleaf-ui.html">
                                Step 6: 画面実装
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-user-list-detail.html">
                                Step 7: 一覧・詳細機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step8-user-update-delete.html">
                                Step 8: 更新・削除機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step9-security-error.html">
                                Step 9: セキュリティ基礎
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step10-deployment.html">
                                Step 10: デプロイメント
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 5: ユーザー登録機能の実装</h1>
                </div>

                <div id="step5">
                    <h2 class="chapter-title">ユーザー登録機能の実装</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>ユーザー登録フォームの作成</li>
                            <li>基本的なバリデーションの使用</li>
                            <li>サービス層の実装</li>
                            <li>フォーム送信処理の実装</li>
                            <li>エラーメッセージの表示</li>
                            <li>基本的なテストの作成</li>
                        </ul>
                    </div>

                    <h3 class="section-title">5.1 フォームデータを受け取るクラスの作成</h3>
                    <p>ユーザー登録フォームからのデータを受け取るためのクラス（フォームオブジェクト）を作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-1: UserFormクラスの作成</h5>
                        <p>フォームデータを受け取るためのクラスを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいディレクトリを作成：<code>src/main/java/com/example/usermanagement/form/</code></li>
                            <li>新しいファイルを作成：<code>src/main/java/com/example/usermanagement/form/UserForm.java</code></li>
                            <li>以下のコードを記述：</li>
                        </ol>
                        <h6>UserForm.java</h6>
                        <pre class="code-block"><code class="language-java">package com.example.usermanagement.form;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;

public class UserForm {
    
    @NotBlank(message = "名前は必須です")
    @Size(min = 1, max = 100, message = "名前は1文字以上100文字以下で入力してください")
    private String name;
    
    @NotBlank(message = "メールアドレスは必須です")
    @Email(message = "正しいメールアドレス形式で入力してください")
    @Size(max = 150, message = "メールアドレスは150文字以下で入力してください")
    private String email;
    
    @NotBlank(message = "パスワードは必須です")
    @Size(min = 6, max = 255, message = "パスワードは6文字以上255文字以下で入力してください")
    private String password;
    
    @NotBlank(message = "パスワード確認は必須です")
    private String passwordConfirm;
    
    // デフォルトコンストラクタ
    public UserForm() {}
    
    // コンストラクタ
    public UserForm(String name, String email, String password, String passwordConfirm) {
        this.name = name;
        this.email = email;
        this.password = password;
        this.passwordConfirm = passwordConfirm;
    }
    
    // Getter と Setter
    public String getName() {
        return name;
    }
    
    public void setName(String name) {
        this.name = name;
    }
    
    public String getEmail() {
        return email;
    }
    
    public void setEmail(String email) {
        this.email = email;
    }
    
    public String getPassword() {
        return password;
    }
    
    public void setPassword(String password) {
        this.password = password;
    }
    
    public String getPasswordConfirm() {
        return passwordConfirm;
    }
    
    public void setPasswordConfirm(String passwordConfirm) {
        this.passwordConfirm = passwordConfirm;
    }
    
    // パスワード確認のチェック
    public boolean isPasswordMatch() {
        if (password == null || passwordConfirm == null) {
            return false;
        }
        return password.equals(passwordConfirm);
    }
}</code></pre>
                        <h6>バリデーションアノテーションの説明</h6>
                        <ul>
                            <li><strong>@NotBlank:</strong> 空白文字や空文字列を許可しない</li>
                            <li><strong>@Size:</strong> 文字列の長さを制限</li>
                            <li><strong>@Email:</strong> メールアドレス形式をチェック</li>
                            <li><strong>message:</strong> バリデーションエラー時のメッセージ</li>
                        </ul>
                    </div>

                    <h3 class="section-title">5.2 ユーザー登録コントローラーの実装</h3>
                    <p>ユーザー登録専用のコントローラークラスを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-2: UserRegistrationControllerの作成</h5>
                        <p>ユーザー登録機能を担当するコントローラーを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいファイルを作成：<code>src/main/java/com/example/usermanagement/controller/UserRegistrationController.java</code></li>
                            <li>以下のコードを記述：</li>
                        </ol>
                        <h6>UserRegistrationController.java</h6>
                        <pre class="code-block"><code class="language-java">package com.example.usermanagement.controller;

import com.example.usermanagement.entity.User;
import com.example.usermanagement.form.UserForm;
import com.example.usermanagement.service.UserService;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

@Controller
@RequestMapping("/register")
public class UserRegistrationController {
    
    private final UserService userService;
    
    @Autowired
    public UserRegistrationController(UserService userService) {
        this.userService = userService;
    }
    
    // 登録フォーム表示
    @GetMapping
    public String showRegistrationForm(Model model) {
        model.addAttribute("userForm", new UserForm());
        return "register/form";
    }
    
    // ユーザー登録処理
    @PostMapping
    public String registerUser(@Valid @ModelAttribute UserForm userForm,
                             BindingResult bindingResult,
                             Model model,
                             RedirectAttributes redirectAttributes) {
        
        // バリデーションエラーがある場合
        if (bindingResult.hasErrors()) {
            return "register/form";
        }
        
        // パスワード確認チェック
        if (!userForm.isPasswordMatch()) {
            model.addAttribute("passwordError", "パスワードと確認用パスワードが一致しません");
            return "register/form";
        }
        
        // メールアドレス重複チェック
        if (userService.isEmailExists(userForm.getEmail())) {
            model.addAttribute("emailError", "このメールアドレスは既に登録されています");
            return "register/form";
        }
        
        try {
            // ユーザーを作成して保存
            User user = new User(userForm.getName(), userForm.getEmail(), userForm.getPassword());
            User savedUser = userService.saveUser(user);
            
            // 成功メッセージを設定
            redirectAttributes.addFlashAttribute("successMessage", 
                "ユーザー「" + savedUser.getName() + "」を登録しました");
            redirectAttributes.addAttribute("userId", savedUser.getId());
            
            return "redirect:/register/success";
            
        } catch (Exception e) {
            model.addAttribute("errorMessage", "登録中にエラーが発生しました: " + e.getMessage());
            return "register/form";
        }
    }
    
    // 登録成功ページ
    @GetMapping("/success")
    public String showSuccess(@RequestParam(required = false) Long userId, Model model) {
        if (userId != null) {
            userService.findUserById(userId).ifPresent(user -> {
                model.addAttribute("user", user);
            });
        }
        return "register/success";
    }
}</code></pre>
                        <h6>コントローラーの説明</h6>
                        <ul>
                            <li><strong>@Valid:</strong> バリデーション実行を指示</li>
                            <li><strong>BindingResult:</strong> バリデーション結果を受け取る</li>
                            <li><strong>@ModelAttribute:</strong> フォームデータをオブジェクトに変換</li>
                            <li><strong>RedirectAttributes:</strong> リダイレクト時にデータを引き継ぐ</li>
                        </ul>
                    </div>

                    <h3 class="section-title">5.3 ユーザー登録フォームの作成</h3>
                    <p>Bootstrap5を使用した美しいユーザー登録フォームを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-3: 登録フォームHTMLの作成</h5>
                        <p>ユーザー登録用のHTMLフォームを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいディレクトリを作成：<code>src/main/resources/templates/register/</code></li>
                            <li>新しいファイルを作成：<code>src/main/resources/templates/register/form.html</code></li>
                            <li>以下のHTMLを記述：</li>
                        </ol>
                        <h6>register/form.html</h6>
                        <pre class="code-block"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ユーザー登録&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-6"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-primary text-white"&gt;
                        &lt;h4 class="mb-0"&gt;新規ユーザー登録&lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;!-- エラーメッセージ表示 --&gt;
                        &lt;div th:if="${errorMessage}" class="alert alert-danger"&gt;
                            &lt;span th:text="${errorMessage}"&gt;&lt;/span&gt;
                        &lt;/div&gt;
                        
                        &lt;form th:action="@{/register}" th:object="${userForm}" method="post"&gt;
                            &lt;!-- 名前入力 --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="name" class="form-label"&gt;名前 &lt;span class="text-danger"&gt;*&lt;/span&gt;&lt;/label&gt;
                                &lt;input type="text" 
                                       class="form-control"
                                       th:class="${#fields.hasErrors('name')} ? 'form-control is-invalid' : 'form-control'"
                                       id="name" 
                                       th:field="*{name}"
                                       placeholder="山田太郎"&gt;
                                &lt;div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"&gt;&lt;/div&gt;
                            &lt;/div&gt;
                            
                            &lt;!-- メールアドレス入力 --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="email" class="form-label"&gt;メールアドレス &lt;span class="text-danger"&gt;*&lt;/span&gt;&lt;/label&gt;
                                &lt;input type="email" 
                                       class="form-control"
                                       th:class="${#fields.hasErrors('email')} ? 'form-control is-invalid' : 'form-control'"
                                       id="email" 
                                       th:field="*{email}"
                                       placeholder="example@email.com"&gt;
                                &lt;div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"&gt;&lt;/div&gt;
                                &lt;div class="invalid-feedback" th:if="${emailError}" th:text="${emailError}"&gt;&lt;/div&gt;
                            &lt;/div&gt;
                            
                            &lt;!-- パスワード入力 --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="password" class="form-label"&gt;パスワード &lt;span class="text-danger"&gt;*&lt;/span&gt;&lt;/label&gt;
                                &lt;input type="password" 
                                       class="form-control"
                                       th:class="${#fields.hasErrors('password')} ? 'form-control is-invalid' : 'form-control'"
                                       id="password" 
                                       th:field="*{password}"
                                       placeholder="6文字以上で入力してください"&gt;
                                &lt;div class="invalid-feedback" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"&gt;&lt;/div&gt;
                                &lt;div class="form-text"&gt;パスワードは6文字以上で入力してください&lt;/div&gt;
                            &lt;/div&gt;
                            
                            &lt;!-- パスワード確認入力 --&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="passwordConfirm" class="form-label"&gt;パスワード確認 &lt;span class="text-danger"&gt;*&lt;/span&gt;&lt;/label&gt;
                                &lt;input type="password" 
                                       class="form-control"
                                       th:class="${#fields.hasErrors('passwordConfirm')} ? 'form-control is-invalid' : 'form-control'"
                                       id="passwordConfirm" 
                                       th:field="*{passwordConfirm}"
                                       placeholder="上記と同じパスワードを入力してください"&gt;
                                &lt;div class="invalid-feedback" th:if="${#fields.hasErrors('passwordConfirm')}" th:errors="*{passwordConfirm}"&gt;&lt;/div&gt;
                                &lt;div class="invalid-feedback" th:if="${passwordError}" th:text="${passwordError}"&gt;&lt;/div&gt;
                            &lt;/div&gt;
                            
                            &lt;!-- 登録ボタン --&gt;
                            &lt;div class="d-grid gap-2"&gt;
                                &lt;button type="submit" class="btn btn-primary btn-lg"&gt;登録する&lt;/button&gt;
                            &lt;/div&gt;
                        &lt;/form&gt;
                    &lt;/div&gt;
                    &lt;div class="card-footer text-center"&gt;
                        &lt;a href="/users" class="btn btn-outline-secondary"&gt;ユーザー一覧に戻る&lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <h3 class="section-title">5.4 登録成功ページの作成</h3>
                    <p>ユーザー登録が成功した場合の画面を作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-4: 成功ページの作成</h5>
                        <p>登録成功を知らせるページを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいファイルを作成：<code>src/main/resources/templates/register/success.html</code></li>
                            <li>以下のHTMLを記述：</li>
                        </ol>
                        <h6>register/success.html</h6>
                        <pre class="code-block"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;登録完了&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-8"&gt;
                &lt;div class="card border-success"&gt;
                    &lt;div class="card-header bg-success text-white text-center"&gt;
                        &lt;h4 class="mb-0"&gt;
                            &lt;i class="bi bi-check-circle"&gt;&lt;/i&gt; 登録完了
                        &lt;/h4&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body text-center"&gt;
                        &lt;div class="alert alert-success" th:if="${successMessage}"&gt;
                            &lt;h5 th:text="${successMessage}"&gt;登録が完了しました&lt;/h5&gt;
                        &lt;/div&gt;
                        
                        &lt;div th:if="${user}" class="mt-4"&gt;
                            &lt;h6&gt;登録されたユーザー情報&lt;/h6&gt;
                            &lt;div class="card"&gt;
                                &lt;div class="card-body"&gt;
                                    &lt;p&gt;&lt;strong&gt;ID:&lt;/strong&gt; &lt;span th:text="${user.id}"&gt;1&lt;/span&gt;&lt;/p&gt;
                                    &lt;p&gt;&lt;strong&gt;名前:&lt;/strong&gt; &lt;span th:text="${user.name}"&gt;名前&lt;/span&gt;&lt;/p&gt;
                                    &lt;p&gt;&lt;strong&gt;メールアドレス:&lt;/strong&gt; &lt;span th:text="${user.email}"&gt;メール&lt;/span&gt;&lt;/p&gt;
                                    &lt;p&gt;&lt;strong&gt;登録日時:&lt;/strong&gt; &lt;span th:text="${#temporals.format(user.createdAt, 'yyyy-MM-dd HH:mm:ss')}"&gt;日時&lt;/span&gt;&lt;/p&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                        
                        &lt;div class="mt-4"&gt;
                            &lt;a href="/register" class="btn btn-primary me-2"&gt;続けて登録する&lt;/a&gt;
                            &lt;a href="/users" class="btn btn-success me-2"&gt;ユーザー一覧を見る&lt;/a&gt;
                            &lt;a href="/" class="btn btn-outline-secondary"&gt;ホームに戻る&lt;/a&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <h3 class="section-title">5.5 動作確認とテスト</h3>
                    <p>実装したユーザー登録機能の動作を確認します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-5: ユーザー登録機能のテスト</h5>
                        <p>様々なパターンでユーザー登録機能をテストします。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>アプリケーションを起動：</li>
                        </ol>
                        <pre class="code-block"><code class="language-bash">./gradlew bootRun</code></pre>
                        <h6>テストケース</h6>
                        <ol start="2">
                            <li><strong>正常系テスト:</strong>
                                <ul>
                                    <li><a href="http://localhost:8080/register" target="_blank">http://localhost:8080/register</a> にアクセス</li>
                                    <li>有効なデータを入力して登録</li>
                                    <li>成功ページが表示されることを確認</li>
                                </ul>
                            </li>
                            <li><strong>バリデーションテスト:</strong>
                                <ul>
                                    <li>名前を空白で登録 → エラーメッセージ表示確認</li>
                                    <li>無効なメールアドレス形式で登録 → エラーメッセージ表示確認</li>
                                    <li>5文字以下のパスワードで登録 → エラーメッセージ表示確認</li>
                                    <li>パスワードと確認が不一致で登録 → エラーメッセージ表示確認</li>
                                </ul>
                            </li>
                            <li><strong>重複チェックテスト:</strong>
                                <ul>
                                    <li>既存のメールアドレスで登録 → 重複エラー表示確認</li>
                                </ul>
                            </li>
                        </ol>
                        <h6>データベース確認</h6>
                        <ol start="5">
                            <li>pgAdminで新しく登録されたユーザーが正しく保存されていることを確認</li>
                            <li>created_atとupdated_atが自動設定されていることを確認</li>
                        </ol>
                    </div>

                    <h3 class="section-title">5.6 基本的な単体テストの作成</h3>
                    <p>ユーザー登録機能の基本的なテストを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-6: ユニットテストの作成</h5>
                        <p>UserServiceクラスの基本的なテストを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいファイルを作成：<code>src/test/java/com/example/usermanagement/service/UserServiceTest.java</code></li>
                            <li>以下のコードを記述：</li>
                        </ol>
                        <h6>UserServiceTest.java</h6>
                        <pre class="code-block"><code class="language-java">package com.example.usermanagement.service;

import com.example.usermanagement.entity.User;
import com.example.usermanagement.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private UserService userService;
    
    private User testUser;
    
    @BeforeEach
    void setUp() {
        testUser = new User("テストユーザー", "test@example.com", "password123");
        testUser.setId(1L);
    }
    
    @Test
    void saveUser_正常な場合_ユーザーが保存される() {
        // Arrange
        when(userRepository.save(any(User.class))).thenReturn(testUser);
        
        // Act
        User savedUser = userService.saveUser(testUser);
        
        // Assert
        assertNotNull(savedUser);
        assertEquals("テストユーザー", savedUser.getName());
        assertEquals("test@example.com", savedUser.getEmail());
        verify(userRepository, times(1)).save(testUser);
    }
    
    @Test
    void findUserById_存在するID_ユーザーが返される() {
        // Arrange
        when(userRepository.findById(1L)).thenReturn(Optional.of(testUser));
        
        // Act
        Optional&lt;User&gt; foundUser = userService.findUserById(1L);
        
        // Assert
        assertTrue(foundUser.isPresent());
        assertEquals("テストユーザー", foundUser.get().getName());
        verify(userRepository, times(1)).findById(1L);
    }
    
    @Test
    void findUserById_存在しないID_空のOptionalが返される() {
        // Arrange
        when(userRepository.findById(999L)).thenReturn(Optional.empty());
        
        // Act
        Optional&lt;User&gt; foundUser = userService.findUserById(999L);
        
        // Assert
        assertFalse(foundUser.isPresent());
        verify(userRepository, times(1)).findById(999L);
    }
    
    @Test
    void isEmailExists_存在するメール_trueが返される() {
        // Arrange
        when(userRepository.existsByEmail("test@example.com")).thenReturn(true);
        
        // Act
        boolean exists = userService.isEmailExists("test@example.com");
        
        // Assert
        assertTrue(exists);
        verify(userRepository, times(1)).existsByEmail("test@example.com");
    }
    
    @Test
    void isEmailExists_存在しないメール_falseが返される() {
        // Arrange
        when(userRepository.existsByEmail("notfound@example.com")).thenReturn(false);
        
        // Act
        boolean exists = userService.isEmailExists("notfound@example.com");
        
        // Assert
        assertFalse(exists);
        verify(userRepository, times(1)).existsByEmail("notfound@example.com");
    }
}</code></pre>
                        <h6>テスト実行</h6>
                        <ol start="3">
                            <li>テストを実行：</li>
                        </ol>
                        <pre class="code-block"><code class="language-bash">./gradlew test</code></pre>
                        <h6>テストの説明</h6>
                        <ul>
                            <li><strong>@ExtendWith(MockitoExtension.class):</strong> Mockitoを使用</li>
                            <li><strong>@Mock:</strong> モックオブジェクトを作成</li>
                            <li><strong>@InjectMocks:</strong> モックを注入してテスト対象を作成</li>
                            <li><strong>when().thenReturn():</strong> モックの動作を定義</li>
                            <li><strong>verify():</strong> メソッドが呼ばれたことを確認</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h5>トラブルシューティング</h5>
                        <ul>
                            <li><strong>バリデーションが動作しない場合:</strong> build.gradleにspring-boot-starter-validationが含まれているか確認してください。</li>
                            <li><strong>フォーム送信でエラー:</strong> th:objectとth:fieldの属性が正しく設定されているか確認してください。</li>
                            <li><strong>重複チェックが動作しない場合:</strong> データベース制約（UNIQUE）が正しく設定されているか確認してください。</li>
                            <li><strong>テストが失敗する場合:</strong> モックの設定と実際のメソッド呼び出しが一致しているか確認してください。</li>
                        </ul>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>@Validアノテーションの役割は何ですか？</li>
                            <li>BindingResultはどのような場合に使用しますか？</li>
                            <li>@NotBlankと@NotNullの違いは何ですか？</li>
                            <li>RedirectAttributesのaddFlashAttributeメソッドの用途は何ですか？</li>
                            <li>th:fieldとth:valueの違いは何ですか？</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>フォームオブジェクトに対してバリデーション（入力値検証）を実行するために使用</li>
                                <li>バリデーション結果を受け取り、エラーがあるかどうかを判定する場合に使用</li>
                                <li>@NotBlankは空白文字もチェックするが、@NotNullはnullのみをチェックする</li>
                                <li>リダイレクト後の画面に一時的なメッセージ（フラッシュメッセージ）を渡すために使用</li>
                                <li>th:fieldはフォームの双方向バインディング、th:valueは単方向の値設定</li>
                            </ol>
                        </details>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="step4-spring-data-jpa.html" class="btn btn-secondary">← 前の章 Step 4: データベースアクセス</a>
                        <a href="step6-thymeleaf-ui.html" class="btn btn-primary">次の章 → Step 6: 画面実装</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>