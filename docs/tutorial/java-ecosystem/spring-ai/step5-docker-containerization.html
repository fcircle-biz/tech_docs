<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI + Ollama チュートリアル ステップ5 - Dockerコンテナ化</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        :root { --primary-color: #f57c00; --secondary-color: #ff9800; --accent-color: #4caf50; }
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8f9fa; padding-top: 56px; }
        .navbar { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
        .sidebar { position: fixed; top: 56px; bottom: 0; left: 0; z-index: 100; padding: 48px 0 0; background-color: #f8f9fa; overflow-y: auto; }
        .sidebar .nav-link { font-weight: 500; color: #333; padding: 0.5rem 1rem; border-left: 3px solid transparent; }
        .sidebar .nav-link:hover { color: var(--primary-color); background-color: #fff3e0; border-left-color: var(--primary-color); }
        .sidebar .nav-link.active { color: var(--primary-color); background-color: #fff3e0; border-left-color: var(--primary-color); font-weight: 700; }
        .chapter-title { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 30px; font-weight: 700; }
        .section-title { color: var(--secondary-color); margin-top: 30px; margin-bottom: 20px; font-weight: 600; border-left: 4px solid var(--secondary-color); padding-left: 15px; }
        .highlight { background: linear-gradient(to right, #fff3e0, #ffe0b2); border-left: 4px solid var(--primary-color); padding: 20px; margin: 20px 0; border-radius: 5px; }
        .highlight h5 { color: var(--primary-color); font-weight: 700; margin-bottom: 15px; }
        .code-block { background-color: #282c34; border-radius: 5px; padding: 15px; margin: 15px 0; overflow-x: auto; }
        .code-block code { color: #abb2bf; font-family: 'Courier New', monospace; font-size: 0.9rem; }
        .exercise-container { background-color: #f0f7ff; border: 2px solid #2196F3; border-radius: 8px; padding: 25px; margin: 25px 0; }
        .exercise-container h5 { color: #1976D2; font-weight: 700; margin-bottom: 15px; }
        .quiz-container { background-color: #f1f8e9; border: 2px solid var(--accent-color); border-radius: 8px; padding: 25px; margin: 25px 0; }
        .quiz-container h5 { color: var(--accent-color); font-weight: 700; margin-bottom: 15px; }
        .alert-custom { border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
        footer { margin-top: 50px; padding: 30px 0; background-color: #212529; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: #e65100; border-color: #e65100; }
        .mermaid { background-color: white; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .concept-box { background-color: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .concept-box h6 { color: #2e7d32; font-weight: 700; margin-bottom: 10px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fab fa-java"></i> <strong>Spring AI + Ollama + Qwen3 実践チュートリアル</strong></a>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted"><span>チュートリアルステップ</span></h6>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="step1-environment-setup.html"><i class="fas fa-cog"></i> ステップ1: 環境構築</a></li>
                        <li class="nav-item"><a class="nav-link" href="step2-spring-ai-ollama-integration.html"><i class="fas fa-plug"></i> ステップ2: Spring AI統合</a></li>
                        <li class="nav-item"><a class="nav-link" href="step3-chat-implementation.html"><i class="fas fa-comments"></i> ステップ3: チャット機能実装</a></li>
                        <li class="nav-item"><a class="nav-link" href="step4-thymeleaf-view.html"><i class="fas fa-file-code"></i> ステップ4: Thymeleafビュー</a></li>
                        <li class="nav-item"><a class="nav-link active" href="step5-docker-containerization.html"><i class="fab fa-docker"></i> ステップ5: Dockerコンテナ化</a></li>
                        <li class="nav-item"><a class="nav-link" href="step6-docker-compose-integration.html"><i class="fas fa-layer-group"></i> ステップ6: docker-compose統合</a></li>
                        <li class="nav-item"><a class="nav-link" href="step7-testing-troubleshooting.html"><i class="fas fa-check-circle"></i> ステップ7: 動作確認</a></li>
                    </ul>
                </div>
            </nav>
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="fab fa-docker"></i> ステップ5: Dockerコンテナ化</h1>
                </div>
                <div id="step5">
                    <h2 class="chapter-title">マルチステージDockerfileによる最適化されたコンテナイメージ作成</h2>
                    <div class="highlight">
                        <h5><i class="fas fa-bullseye"></i> このステップで実装すること</h5>
                        <ul>
                            <li><strong>マルチステージDockerfile</strong> - ビルドとランタイムを分離した効率的なイメージ</li>
                            <li><strong>ビルドステージ</strong> - Gradleによるアプリケーションビルド</li>
                            <li><strong>ランタイムステージ</strong> - 軽量なJREベースイメージでサイズ削減</li>
                            <li><strong>イメージビルド</strong> - docker buildコマンドによるイメージ作成</li>
                            <li><strong>コンテナ実行</strong> - docker runによる動作確認</li>
                            <li><strong>最適化テクニック</strong> - レイヤーキャッシュとマルチステージビルド活用</li>
                        </ul>
                        <p><strong>所要時間：</strong> 約2時間</p>
                    </div>
                    <div class="alert alert-info alert-custom">
                        <h6><i class="fas fa-info-circle"></i> 前提条件</h6>
                        <ul class="mb-0">
                            <li>ステップ4が完了し、Webアプリケーションが動作すること</li>
                            <li>Docker Desktopが起動していること</li>
                            <li>dockerコマンドが実行可能なこと</li>
                        </ul>
                    </div>
                    <h3 class="section-title">5.1 マルチステージDockerfileの作成</h3>
                    <p>マルチステージビルドを使用して、ビルド環境とランタイム環境を分離し、最終イメージサイズを最小化します。</p>
                    <div class="concept-box">
                        <h6><i class="fas fa-lightbulb"></i> マルチステージビルドの利点</h6>
                        <ul class="mb-0">
                            <li><strong>イメージサイズ削減</strong>: ビルドツール（Gradle等）を含まない軽量なランタイムイメージ</li>
                            <li><strong>セキュリティ向上</strong>: 本番環境に不要なビルドツールを排除</li>
                            <li><strong>ビルド再現性</strong>: ローカル環境に依存しない一貫したビルド</li>
                            <li><strong>レイヤーキャッシュ</strong>: 依存関係の変更がない場合、キャッシュを活用して高速ビルド</li>
                        </ul>
                    </div>
                    <div class="exercise-container">
                        <h5><i class="fas fa-tasks"></i> 実装 5-1: Dockerfileの作成</h5>
                        <h6><i class="fas fa-list-ol"></i> 手順</h6>
                        <ol>
                            <li><strong>Dockerfileの作成</strong>:
                                <p>プロジェクトルート（ai-chat/）にDockerfileを作成：</p>
                                <pre class="code-block"><code class="language-dockerfile"># ========================================
# Stage 1: Build Stage (Gradle)
# ========================================
FROM gradle:8.5-jdk17 AS builder

# 作業ディレクトリ
WORKDIR /build

# Gradleキャッシュ最適化: 依存関係を先にダウンロード
COPY app/build.gradle app/settings.gradle ./app/
COPY settings.gradle ./
RUN gradle dependencies --no-daemon || true

# アプリケーションソースをコピー
COPY app/src ./app/src

# アプリケーションをビルド
RUN cd app && gradle bootJar --no-daemon

# ========================================
# Stage 2: Runtime Stage (JRE)
# ========================================
FROM eclipse-temurin:17-jre-alpine

# 作業ディレクトリ
WORKDIR /app

# 非rootユーザーの作成（セキュリティベストプラクティス）
RUN addgroup -S spring && adduser -S spring -G spring
USER spring:spring

# ビルドステージからJARをコピー
COPY --from=builder /build/app/build/libs/*.jar app.jar

# ポート8080を公開
EXPOSE 8080

# アプリケーション起動
ENTRYPOINT ["java", "-jar", "app.jar"]</code></pre>
                            </li>
                            <li><strong>Dockerfileの各ステージ説明</strong>:
                                <div class="concept-box mt-3">
                                    <h6>ビルドステージ（Stage 1）</h6>
                                    <ul>
                                        <li><code>FROM gradle:8.5-jdk17 AS builder</code>: Gradle公式イメージをビルドベースに使用</li>
                                        <li><code>COPY build.gradle ...</code>: 依存関係定義を先にコピー（キャッシュ最適化）</li>
                                        <li><code>RUN gradle dependencies</code>: 依存関係を事前ダウンロード</li>
                                        <li><code>COPY app/src ...</code>: ソースコードをコピー</li>
                                        <li><code>RUN gradle bootJar</code>: Spring Boot実行可能JARをビルド</li>
                                    </ul>
                                    <h6>ランタイムステージ（Stage 2）</h6>
                                    <ul class="mb-0">
                                        <li><code>FROM eclipse-temurin:17-jre-alpine</code>: 軽量なAlpine LinuxベースJREイメージ</li>
                                        <li><code>RUN adduser ...</code>: 非rootユーザーで実行（セキュリティ）</li>
                                        <li><code>COPY --from=builder ...</code>: ビルドステージからJARのみをコピー</li>
                                        <li><code>ENTRYPOINT</code>: コンテナ起動時にJavaアプリを実行</li>
                                    </ul>
                                </div>
                            </li>
                        </ol>
                        <h6><i class="fas fa-check-circle"></i> Dockerイメージのビルド</h6>
                        <p>プロジェクトルート（ai-chat/）でDockerイメージをビルドします：</p>
                        <pre class="code-block"><code class="language-bash"># イメージビルド（初回は5-10分かかる場合があります）
docker build -t ai-chat:latest .

# ビルド進行状況が表示される
# [1/2] STEP 1/6: FROM gradle:8.5-jdk17 AS builder
# [1/2] STEP 2/6: WORKDIR /build
# ...（省略）...
# Successfully built xxxxx
# Successfully tagged ai-chat:latest</code></pre>
                        <h6><i class="fas fa-thumbs-up"></i> 期待される結果</h6>
                        <div class="alert alert-success">
                            <p><strong>ビルド成功メッセージ:</strong></p>
                            <pre class="mb-3">Successfully built xxxxx
Successfully tagged ai-chat:latest</pre>
                            <p><strong>イメージ確認:</strong></p>
                            <pre class="mb-0">$ docker images ai-chat
REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
ai-chat      latest    xxxxx          2 minutes ago    300MB</pre>
                        </div>
                        <h6><i class="fas fa-exclamation-triangle"></i> トラブルシューティング</h6>
                        <div class="alert alert-warning">
                            <p><strong>エラー:</strong> COPY failed: file not found</p>
                            <p><strong>解決方法:</strong> Dockerfileがプロジェクトルート（ai-chat/）にあることを確認し、docker buildコマンドをそのディレクトリで実行してください。</p>
                        </div>
                    </div>
                    <h3 class="section-title">5.2 Dockerコンテナの実行と動作確認</h3>
                    <p>ビルドしたイメージからコンテナを起動し、アプリケーションが正常に動作するか確認します。</p>
                    <div class="exercise-container">
                        <h5><i class="fas fa-tasks"></i> 実装 5-2: コンテナの起動と動作確認</h5>
                        <h6><i class="fas fa-list-ol"></i> 手順</h6>
                        <ol>
                            <li><strong>Ollamaコンテナが起動していることを確認</strong>:
                                <pre class="code-block"><code class="language-bash">docker ps | grep ollama
# ollamaコンテナが表示されない場合は起動
docker start ollama</code></pre>
                            </li>
                            <li><strong>ai-chatコンテナを起動</strong>:
                                <pre class="code-block"><code class="language-bash"># コンテナ起動（バックグラウンド）
docker run -d \
  --name ai-chat-app \
  -p 8080:8080 \
  --network host \
  ai-chat:latest

# または、Ollamaコンテナと同じネットワークで起動
docker run -d \
  --name ai-chat-app \
  -p 8080:8080 \
  -e SPRING_AI_OLLAMA_BASE_URL=http://host.docker.internal:11434 \
  ai-chat:latest</code></pre>
                            </li>
                            <li><strong>ログ確認</strong>:
                                <pre class="code-block"><code class="language-bash"># コンテナログをリアルタイム表示
docker logs -f ai-chat-app</code></pre>
                            </li>
                            <li><strong>ブラウザでアクセス</strong>:
                                <p>ブラウザで <code>http://localhost:8080/chat</code> にアクセスして、チャット画面が表示されることを確認します。</p>
                            </li>
                        </ol>
                        <h6><i class="fas fa-thumbs-up"></i> 期待される結果</h6>
                        <div class="alert alert-success">
                            <p>チャット画面が表示され、メッセージを送信するとAI応答が返ってくることを確認できます。</p>
                        </div>
                        <h6><i class="fas fa-exclamation-triangle"></i> トラブルシューティング</h6>
                        <div class="alert alert-warning">
                            <p><strong>エラー:</strong> Connection refused: localhost/127.0.0.1:11434</p>
                            <p><strong>解決方法:</strong></p>
                            <ul class="mb-0">
                                <li>Windowsの場合: <code>-e SPRING_AI_OLLAMA_BASE_URL=http://host.docker.internal:11434</code>を使用</li>
                                <li>Linux/macOSの場合: <code>--network host</code>を使用、または同じDockerネットワークに配置</li>
                            </ul>
                        </div>
                    </div>
                    <h3 class="section-title">5.3 Dockerイメージ最適化テクニック</h3>
                    <p>イメージサイズをさらに削減し、ビルド時間を短縮するテクニックを学びます。</p>
                    <div class="concept-box">
                        <h6><i class="fas fa-rocket"></i> イメージ最適化のベストプラクティス</h6>
                        <ol>
                            <li><strong>Alpine Linuxベースイメージ</strong>: 一般的なDebianベースより約70%小さい</li>
                            <li><strong>.dockerignoreファイル</strong>: ビルドコンテキストから不要なファイルを除外</li>
                            <li><strong>レイヤーキャッシュ活用</strong>: 頻繁に変更されないファイルを先にCOPY</li>
                            <li><strong>マルチステージビルド</strong>: ビルドツールを最終イメージから除外</li>
                        </ol>
                    </div>
                    <div class="exercise-container">
                        <h5><i class="fas fa-tasks"></i> 実装 5-3: .dockerignoreファイルの作成</h5>
                        <p>プロジェクトルートに.dockerignoreを作成：</p>
                        <pre class="code-block"><code class="language-bash"># Gradle
.gradle/
build/
app/build/
app/.gradle/

# IDE
.idea/
.vscode/
*.iml

# Git
.git/
.gitignore

# ログ・一時ファイル
*.log
*.tmp

# ドキュメント
README.md
docs/</code></pre>
                    </div>
                    <div class="mermaid">
                        flowchart LR
                            subgraph Build["ビルドステージ"]
                                A1["Gradleベースイメージ<br/>約1GB"]
                                A2["依存関係ダウンロード"]
                                A3["ソースコンパイル"]
                                A4["JAR作成<br/>約30MB"]
                            end
                            subgraph Runtime["ランタイムステージ"]
                                B1["JREベースイメージ<br/>約200MB"]
                                B2["JARコピー<br/>約30MB"]
                                B3["最終イメージ<br/>約230MB"]
                            end
                            A1 --> A2 --> A3 --> A4
                            A4 --> |COPY --from=builder| B2
                            B1 --> B2 --> B3
                            style Build fill:#ffe0b2
                            style Runtime fill:#c8e6c9
                            style A4 fill:#f57c00,color:#fff
                            style B3 fill:#4caf50,color:#fff
                    </div>
                    <div class="quiz-container">
                        <h5><i class="fas fa-clipboard-check"></i> ステップ5完了チェックリスト</h5>
                        <p>以下の項目が完了していることを確認してください：</p>
                        <ul class="list-unstyled">
                            <li><input type="checkbox"> Dockerfileが作成されている</li>
                            <li><input type="checkbox"> マルチステージビルドが実装されている</li>
                            <li><input type="checkbox"> .dockerignoreファイルが作成されている</li>
                            <li><input type="checkbox"> <code>docker build -t ai-chat:latest .</code>が成功する</li>
                            <li><input type="checkbox"> <code>docker images ai-chat</code>でイメージが確認できる</li>
                            <li><input type="checkbox"> <code>docker run</code>でコンテナが起動する</li>
                            <li><input type="checkbox"> コンテナ内のアプリケーションが正常に動作する</li>
                            <li><input type="checkbox"> ブラウザで http://localhost:8080/chat にアクセスできる</li>
                        </ul>
                    </div>
                    <div class="alert alert-light alert-custom">
                        <h6><i class="fas fa-folder-tree"></i> 現在のプロジェクト構成</h6>
                        <pre class="code-block"><code class="language-bash">ai-chat/
├── Dockerfile                 # [新規] マルチステージDockerfile
├── .dockerignore              # [新規] ビルドコンテキスト除外設定
├── app/
│   ├── build.gradle
│   └── src/
│       └── (省略)
├── gradlew
└── settings.gradle</code></pre>
                    </div>
                    <div class="alert alert-info alert-custom">
                        <h6><i class="fas fa-forward"></i> 次のステップの予告</h6>
                        <p><strong>ステップ6: docker-composeによる統合環境構築</strong>では、以下を実装します：</p>
                        <ul class="mb-0">
                            <li>docker-compose.ymlの作成</li>
                            <li>ollamaサービスとappサービスの定義</li>
                            <li>サービス間依存関係とヘルスチェック</li>
                            <li>docker-compose up一発で全環境起動</li>
                        </ul>
                    </div>
                    <div class="d-flex justify-content-between mt-5 mb-4">
                        <a href="step4-thymeleaf-view.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> 前のステップ</a>
                        <a href="step6-docker-compose-integration.html" class="btn btn-primary">次のステップ <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'default' });</script>
</body>
</html>
