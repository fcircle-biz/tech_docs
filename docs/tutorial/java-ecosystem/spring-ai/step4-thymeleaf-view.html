<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI + Ollama チュートリアル ステップ4 - Thymeleafビューの作成</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <style>
        :root {
            --primary-color: #f57c00;
            --secondary-color: #ff9800;
            --accent-color: #4caf50;
            --background-color: #fff3e0;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
            padding-top: 56px;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #f8f9fa;
            overflow-y: auto;
        }

        .sidebar .nav-link {
            font-weight: 500;
            color: #333;
            padding: 0.5rem 1rem;
            border-left: 3px solid transparent;
        }

        .sidebar .nav-link:hover {
            color: var(--primary-color);
            background-color: var(--background-color);
            border-left-color: var(--primary-color);
        }

        .sidebar .nav-link.active {
            color: var(--primary-color);
            background-color: var(--background-color);
            border-left-color: var(--primary-color);
            font-weight: 700;
        }

        main {
            padding-top: 20px;
        }

        .chapter-title {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .section-title {
            color: var(--secondary-color);
            margin-top: 30px;
            margin-bottom: 20px;
            font-weight: 600;
            border-left: 4px solid var(--secondary-color);
            padding-left: 15px;
        }

        .highlight {
            background: linear-gradient(to right, #fff3e0, #ffe0b2);
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .highlight h5 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 15px;
        }

        .code-block {
            background-color: #282c34;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
        }

        .code-block code {
            color: #abb2bf;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .exercise-container {
            background-color: #f0f7ff;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
        }

        .exercise-container h5 {
            color: #1976D2;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .quiz-container {
            background-color: #f1f8e9;
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
        }

        .quiz-container h5 {
            color: var(--accent-color);
            font-weight: 700;
            margin-bottom: 15px;
        }

        .alert-custom {
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
        }

        footer {
            margin-top: 50px;
            padding: 30px 0;
            background-color: #212529;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #e65100;
            border-color: #e65100;
        }

        .mermaid {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .concept-box {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .concept-box h6 {
            color: #2e7d32;
            font-weight: 700;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fab fa-java"></i>
                <strong>Spring AI + Ollama + Qwen3 実践チュートリアル</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>チュートリアルステップ</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                <i class="fas fa-cog"></i> ステップ1: 環境構築とプロジェクト作成
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-spring-ai-ollama-integration.html">
                                <i class="fas fa-plug"></i> ステップ2: Spring AIとOllamaの統合設定
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-chat-implementation.html">
                                <i class="fas fa-comments"></i> ステップ3: チャット機能の実装
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step4-thymeleaf-view.html">
                                <i class="fas fa-file-code"></i> ステップ4: Thymeleafビューの作成
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-testing.html">
                                <i class="fas fa-check-circle"></i> ステップ5: 動作確認
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="fas fa-file-code"></i> ステップ4: Thymeleafビューの作成</h1>
                </div>

                <div id="step4">
                    <!-- ステップタイトル -->
                    <h2 class="chapter-title">Bootstrap統合とレスポンシブなチャット画面の実装</h2>

                    <!-- このステップの目標 -->
                    <div class="highlight">
                        <h5><i class="fas fa-bullseye"></i> このステップで実装すること</h5>
                        <ul>
                            <li><strong>templates/index.htmlの作成</strong> - Thymeleafテンプレートの作成</li>
                            <li><strong>Bootstrap 5.3.3統合</strong> - CDNを使用したレスポンシブデザイン</li>
                            <li><strong>入力フォームの実装</strong> - テキストエリアと送信ボタン</li>
                            <li><strong>Thymeleaf式言語</strong> - th:field、th:if、th:text、th:errorsの活用</li>
                            <li><strong>バリデーションエラー表示</strong> - フィールドエラーメッセージの表示</li>
                            <li><strong>AI応答の整形表示</strong> - preタグで改行を保持した表示</li>
                            <li><strong>処理中メッセージ表示</strong> - JavaScriptによるフォーム送信時のローディング表示</li>
                        </ul>
                        <p><strong>所要時間：</strong> 約2.5時間</p>
                    </div>

                    <!-- 前提条件 -->
                    <div class="alert alert-info alert-custom">
                        <h6><i class="fas fa-info-circle"></i> 前提条件</h6>
                        <ul class="mb-0">
                            <li>ステップ3が完了し、ChatControllerとChatFormが実装されていること</li>
                            <li>HTMLの基本的な理解</li>
                            <li>CSSの基本的な知識</li>
                        </ul>
                    </div>

                    <!-- セクション4.1: Thymeleafテンプレートの作成 -->
                    <h3 class="section-title">4.1 index.htmlテンプレートの作成</h3>
                    <p>app/src/main/resources/templates/ディレクトリにindex.htmlを作成します。</p>

                    <div class="exercise-container">
                        <h5><i class="fas fa-tasks"></i> 実装 4-1: index.htmlの完全実装</h5>

                        <h6><i class="fas fa-list-ol"></i> 手順</h6>
                        <ol>
                            <li><strong>templatesディレクトリの確認</strong>:
                                <p>Spring Initializrで生成したプロジェクトには既に <code>src/main/resources/templates</code> ディレクトリが存在しますが、存在しない場合は以下のコマンドで作成します：</p>
                                <pre class="code-block"><code class="language-bash"># Windows (コマンドプロンプト)
mkdir app\src\main\resources\templates

# Windows (PowerShell)
New-Item -ItemType Directory -Path app\src\main\resources\templates -Force

# macOS / Linux
mkdir -p app/src/main/resources/templates</code></pre>
                            </li>

                            <li><strong>index.htmlの作成</strong>:
                                <p>app/src/main/resources/templates/index.htmlを作成：</p>
                                <pre class="code-block"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="ja" xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;AI Chat - Spring AI + Ollama&lt;/title&gt;

    &lt;!-- Bootstrap 5.3.3 CDN --&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"&gt;

    &lt;!-- Font Awesome --&gt;
    &lt;link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"&gt;

    &lt;style&gt;
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .chat-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }

        .card-header h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .response-area {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }

        .response-area pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
        }

        .user-message {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .ai-response {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            border-radius: 5px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn-send {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 124, 0, 0.3);
        }

        .badge-ai {
            background-color: #4caf50;
            font-size: 0.75rem;
            padding: 5px 10px;
        }

        .loading-message {
            display: none;
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .loading-message.show {
            display: block;
        }

        .spinner-border {
            width: 2rem;
            height: 2rem;
            margin-right: 10px;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="chat-container"&gt;
        &lt;div class="card"&gt;
            &lt;!-- ヘッダー --&gt;
            &lt;div class="card-header text-center"&gt;
                &lt;h1&gt;&lt;i class="fas fa-robot"&gt;&lt;/i&gt; AI Chat&lt;/h1&gt;
                &lt;p class="mb-0"&gt;
                    &lt;span class="badge badge-ai"&gt;Powered by Qwen3:7b&lt;/span&gt;
                &lt;/p&gt;
            &lt;/div&gt;

            &lt;div class="card-body"&gt;
                &lt;!-- AI処理中メッセージ --&gt;
                &lt;div id="loadingMessage" class="loading-message"&gt;
                    &lt;div class="spinner-border text-warning" role="status"&gt;
                        &lt;span class="visually-hidden"&gt;処理中...&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;h5 class="mt-2"&gt;&lt;i class="fas fa-hourglass-half"&gt;&lt;/i&gt; AIが回答を生成しています...&lt;/h5&gt;
                    &lt;p class="mb-0"&gt;処理には数分程度かかる場合があります。しばらくお待ちください。&lt;/p&gt;
                &lt;/div&gt;

                &lt;!-- AI応答表示エリア --&gt;
                &lt;div class="response-area" th:if="${chatForm.response != null}"&gt;
                    &lt;!-- ユーザーメッセージ --&gt;
                    &lt;div class="user-message"&gt;
                        &lt;h6&gt;&lt;i class="fas fa-user"&gt;&lt;/i&gt; あなたの質問&lt;/h6&gt;
                        &lt;p th:text="${chatForm.message}" class="mb-0"&gt;&lt;/p&gt;
                    &lt;/div&gt;

                    &lt;!-- AI応答 --&gt;
                    &lt;div class="ai-response"&gt;
                        &lt;h6&gt;&lt;i class="fas fa-robot"&gt;&lt;/i&gt; AIの回答&lt;/h6&gt;
                        &lt;pre th:text="${chatForm.response}"&gt;&lt;/pre&gt;
                    &lt;/div&gt;
                &lt;/div&gt;

                &lt;!-- 初回表示メッセージ --&gt;
                &lt;div class="alert alert-info" th:if="${chatForm.response == null}"&gt;
                    &lt;i class="fas fa-info-circle"&gt;&lt;/i&gt;
                    下のテキストエリアに質問を入力して、「送信」ボタンをクリックしてください。
                &lt;/div&gt;

                &lt;!-- チャットフォーム --&gt;
                &lt;form th:action="@{/chat}" th:object="${chatForm}" method="post"&gt;
                    &lt;!-- メッセージ入力 --&gt;
                    &lt;div class="mb-3"&gt;
                        &lt;label for="message" class="form-label fw-bold"&gt;
                            &lt;i class="fas fa-comment-dots"&gt;&lt;/i&gt; メッセージ
                        &lt;/label&gt;
                        &lt;textarea
                            class="form-control"
                            id="message"
                            th:field="*{message}"
                            th:classappend="${#fields.hasErrors('message')} ? 'is-invalid' : ''"
                            placeholder="AIに質問してみましょう...（例: Javaの特徴を教えてください）"
                            rows="5"&gt;&lt;/textarea&gt;

                        &lt;!-- バリデーションエラー表示 --&gt;
                        &lt;div class="invalid-feedback" th:if="${#fields.hasErrors('message')}" th:errors="*{message}"&gt;
                            エラーメッセージ
                        &lt;/div&gt;
                    &lt;/div&gt;

                    &lt;!-- 送信ボタン --&gt;
                    &lt;div class="d-grid gap-2"&gt;
                        &lt;button type="submit" class="btn btn-primary btn-send btn-lg"&gt;
                            &lt;i class="fas fa-paper-plane"&gt;&lt;/i&gt; 送信
                        &lt;/button&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;

            &lt;!-- フッター --&gt;
            &lt;div class="card-footer text-center text-muted"&gt;
                &lt;small&gt;Spring Boot 3.4.0 + Spring AI 1.0.0-M6 + Ollama + Qwen3:7b&lt;/small&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Bootstrap JavaScript --&gt;
    &lt;script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;

    &lt;!-- フォーム送信時の処理中メッセージ表示 --&gt;
    &lt;script&gt;
        document.addEventListener('DOMContentLoaded', function() {
            const chatForm = document.querySelector('form');
            const submitButton = chatForm.querySelector('button[type="submit"]');
            const loadingMessage = document.getElementById('loadingMessage');

            chatForm.addEventListener('submit', function(event) {
                // バリデーションチェック（空の場合は送信しない）
                const messageField = chatForm.querySelector('#message');
                if (!messageField.value.trim()) {
                    return; // バリデーションエラーがあれば処理を続行
                }

                // 処理中メッセージを表示
                loadingMessage.classList.add('show');

                // 送信ボタンを無効化してテキスト変更
                submitButton.disabled = true;
                submitButton.innerHTML = '&lt;i class="fas fa-spinner fa-spin"&gt;&lt;/i&gt; 処理中...';

                // フォームを送信（preventDefault不要）
            });
        });
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                            </li>
                        </ol>

                        <h6><i class="fas fa-check-circle"></i> 動作確認</h6>
                        <p>アプリケーションを起動して、ブラウザでチャット画面にアクセスします：</p>
                        <pre class="code-block"><code class="language-bash"># Windows (コマンドプロンプト)
cd app
gradlew bootRun

# Windows (PowerShell)
cd app
.\gradlew bootRun

# macOS / Linux
cd app
./gradlew bootRun

# ブラウザで以下にアクセス
# http://localhost:8080/chat</code></pre>

                        <h6><i class="fas fa-thumbs-up"></i> 期待される結果</h6>
                        <div class="alert alert-success">
                            <p><strong>初期表示:</strong></p>
                            <ul>
                                <li>グラデーション背景のチャット画面が表示される</li>
                                <li>ヘッダーに「AI Chat」とQwen3:7bバッジが表示される</li>
                                <li>テキストエリアと送信ボタンが表示される</li>
                            </ul>

                            <p><strong>メッセージ送信後:</strong></p>
                            <ul class="mb-0">
                                <li>送信ボタンを押すと「AIが回答を生成しています...」というメッセージが表示される</li>
                                <li>送信ボタンが無効化され、「処理中...」というテキストとスピナーアイコンが表示される</li>
                                <li>AI処理完了後、ユーザーの質問が青い枠で表示される</li>
                                <li>AIの回答がオレンジの枠で表示される</li>
                                <li>改行が正しく保持されて表示される</li>
                            </ul>
                        </div>
                    </div>

                    <!-- セクション4.2: Thymeleaf式言語の解説 -->
                    <h3 class="section-title">4.2 Thymeleaf式言語の詳細解説</h3>
                    <p>実装したHTMLで使用されているThymeleaf式言語について詳しく解説します。</p>

                    <div class="concept-box">
                        <h6><i class="fas fa-code"></i> 主要なThymeleaf式言語</h6>
                        <table class="table table-bordered mt-3">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 30%;">式</th>
                                    <th>説明</th>
                                    <th>例</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>th:field="*{message}"</code></td>
                                    <td>フォームフィールドをバインド（name、id、valueを自動設定）</td>
                                    <td>ChatFormのmessageフィールドにバインド</td>
                                </tr>
                                <tr>
                                    <td><code>th:text="${value}"</code></td>
                                    <td>テキストコンテンツを設定（HTMLエスケープあり）</td>
                                    <td>変数の値をテキストとして表示</td>
                                </tr>
                                <tr>
                                    <td><code>th:if="${condition}"</code></td>
                                    <td>条件がtrueの場合のみ要素を表示</td>
                                    <td>応答がnullでない場合のみ表示</td>
                                </tr>
                                <tr>
                                    <td><code>th:object="${form}"</code></td>
                                    <td>フォームオブジェクトを指定</td>
                                    <td>ChatFormオブジェクトをバインド</td>
                                </tr>
                                <tr>
                                    <td><code>th:errors="*{field}"</code></td>
                                    <td>バリデーションエラーメッセージを表示</td>
                                    <td>@NotBlankエラーを表示</td>
                                </tr>
                                <tr>
                                    <td><code>th:classappend</code></td>
                                    <td>条件に応じてCSSクラスを追加</td>
                                    <td>エラー時にis-invalidクラスを追加</td>
                                </tr>
                                <tr>
                                    <td><code>@{/path}</code></td>
                                    <td>URLを生成（コンテキストパス自動追加）</td>
                                    <td>フォームのaction属性</td>
                                </tr>
                                <tr>
                                    <td><code>#fields.hasErrors()</code></td>
                                    <td>フィールドにエラーがあるかチェック</td>
                                    <td>バリデーションエラーの有無判定</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- セクション4.3: バリデーションエラー表示の仕組み -->
                    <h3 class="section-title">4.3 バリデーションエラー表示の実装</h3>
                    <p>@NotBlankバリデーションがトリガーされた場合のエラー表示の仕組みを理解します。</p>

                    <div class="concept-box">
                        <h6><i class="fas fa-exclamation-triangle"></i> バリデーションエラー処理フロー</h6>
                        <ol>
                            <li>ユーザーが空白のままフォーム送信</li>
                            <li>ChatFormの<code>@NotBlank</code>バリデーションが実行される</li>
                            <li><code>BindingResult</code>にエラーが記録される</li>
                            <li>コントローラーで<code>bindingResult.hasErrors()</code>がtrueを返す</li>
                            <li>同じビューを返す（index.html）</li>
                            <li>Thymeleafが<code>th:errors</code>でエラーメッセージを表示</li>
                            <li><code>th:classappend</code>で<code>is-invalid</code>クラスが追加される</li>
                            <li>Bootstrapの赤枠とエラーメッセージが表示される</li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5><i class="fas fa-tasks"></i> 実習 4-1: バリデーションエラーのテスト</h5>
                        <p>実際にバリデーションエラーをトリガーしてみましょう：</p>

                        <h6><i class="fas fa-list-ol"></i> 手順</h6>
                        <ol>
                            <li>ブラウザでhttp://localhost:8080/chatにアクセス</li>
                            <li>テキストエリアに何も入力せず「送信」ボタンをクリック</li>
                            <li>赤い枠とエラーメッセージ「メッセージを入力してください」が表示されることを確認</li>
                            <li>空白文字のみを入力して送信</li>
                            <li>同様にエラーが表示されることを確認（@NotBlankは空白のみも禁止）</li>
                        </ol>
                    </div>

                    <!-- セクション4.4: 処理中メッセージ表示の実装 -->
                    <h3 class="section-title">4.4 処理中メッセージ表示の実装</h3>
                    <p>AI処理には数分程度時間がかかるため、ユーザーに処理中であることを明示的に伝える必要があります。JavaScriptを使用して、フォーム送信時にローディングメッセージを表示します。</p>

                    <div class="concept-box">
                        <h6><i class="fas fa-lightbulb"></i> 処理中メッセージ表示の仕組み</h6>
                        <ol>
                            <li><strong>フォーム送信イベントのリスニング</strong>: JavaScriptでformのsubmitイベントを監視</li>
                            <li><strong>バリデーションチェック</strong>: 空白入力の場合はメッセージを表示しない</li>
                            <li><strong>ローディングメッセージ表示</strong>: 黄色の背景に警告アイコンとスピナーを表示</li>
                            <li><strong>送信ボタンの無効化</strong>: disabled属性を追加して二重送信を防止</li>
                            <li><strong>ボタンテキストの変更</strong>: 「送信」から「処理中...」に変更</li>
                            <li><strong>スピナーアイコン追加</strong>: Font Awesomeのfa-spinnerアイコンを回転表示</li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5><i class="fas fa-tasks"></i> 実習 4-2: 処理中メッセージのテスト</h5>
                        <p>実際に処理中メッセージが表示されることを確認しましょう：</p>

                        <h6><i class="fas fa-list-ol"></i> 手順</h6>
                        <ol>
                            <li>ブラウザでhttp://localhost:8080/chatにアクセス</li>
                            <li>テキストエリアに「Javaの特徴を教えてください」と入力</li>
                            <li>「送信」ボタンをクリック</li>
                            <li>以下が表示されることを確認：
                                <ul>
                                    <li>黄色い背景の「AIが回答を生成しています...」メッセージ</li>
                                    <li>回転するスピナーアイコン</li>
                                    <li>送信ボタンが「処理中...」に変わり無効化される</li>
                                </ul>
                            </li>
                            <li>数分程度待つとAI応答が表示され、処理中メッセージが消えることを確認</li>
                        </ol>
                    </div>

                    <div class="concept-box">
                        <h6><i class="fas fa-code"></i> JavaScriptコードの詳細解説</h6>
                        <pre class="code-block"><code class="language-javascript">// DOMContentLoadedイベント：HTML読み込み完了後に実行
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.querySelector('form');
    const submitButton = chatForm.querySelector('button[type="submit"]');
    const loadingMessage = document.getElementById('loadingMessage');

    // フォーム送信時のイベントリスナー
    chatForm.addEventListener('submit', function(event) {
        // 入力値が空白のみの場合はスキップ（バリデーションエラー）
        const messageField = chatForm.querySelector('#message');
        if (!messageField.value.trim()) {
            return; // 処理を中断してバリデーションに任せる
        }

        // 処理中メッセージを表示（CSSクラスを追加）
        loadingMessage.classList.add('show');

        // 送信ボタンを無効化して二重送信を防止
        submitButton.disabled = true;
        submitButton.innerHTML = '&lt;i class="fas fa-spinner fa-spin"&gt;&lt;/i&gt; 処理中...';
    });
});</code></pre>

                        <p><strong>重要なポイント：</strong></p>
                        <ul class="mb-0">
                            <li><code>event.preventDefault()</code>を呼ばない理由：フォーム送信を続行させる必要があるため</li>
                            <li><code>trim()</code>メソッド：空白のみの入力を検出してバリデーションに任せる</li>
                            <li><code>classList.add('show')</code>：CSSのdisplay:blockを適用してメッセージを表示</li>
                            <li><code>fa-spin</code>クラス：Font Awesomeのスピナーアイコンを回転させる</li>
                        </ul>
                    </div>

                    <!-- 画面レイアウト図 -->
                    <h3 class="section-title">4.5 チャット画面のレイアウト構成</h3>
                    <p>実装したチャット画面のレイアウト構造を図で確認します。</p>

                    <div class="mermaid">
                        flowchart TB
                            subgraph Card["Bootstrap Card"]
                                Header["ヘッダー<br/>AI Chat + バッジ"]
                                Body["カードボディ"]
                                Footer["フッター<br/>技術スタック情報"]
                            end

                            subgraph Body
                                LoadingMsg["処理中メッセージ<br/>（送信時のみ表示）"]
                                Condition{応答あり?}
                                ResponseArea["応答表示エリア"]
                                InfoAlert["初回表示メッセージ"]
                                Form["チャットフォーム"]
                            end

                            subgraph LoadingMsg
                                Spinner["スピナーアイコン"]
                                LoadText["AIが回答を生成中<br/>数分程度お待ちください"]
                            end

                            subgraph ResponseArea
                                UserMsg["ユーザーメッセージ<br/>（青枠）"]
                                AIRes["AI応答<br/>（オレンジ枠）"]
                            end

                            subgraph Form
                                TextArea["テキストエリア<br/>th:field"]
                                ErrorMsg["バリデーションエラー<br/>th:errors"]
                                SubmitBtn["送信ボタン<br/>（処理中は無効化）"]
                            end

                            Condition -- はい --> ResponseArea
                            Condition -- いいえ --> InfoAlert
                            ResponseArea --> UserMsg
                            ResponseArea --> AIRes
                            Form --> TextArea
                            Form --> ErrorMsg
                            Form --> SubmitBtn

                            style Header fill:#f57c00,color:#fff
                            style LoadingMsg fill:#fff3cd
                            style ResponseArea fill:#fff3e0
                            style UserMsg fill:#e3f2fd
                            style AIRes fill:#ffe0b2
                    </div>

                    <!-- ステップ完了チェック -->
                    <div class="quiz-container">
                        <h5><i class="fas fa-clipboard-check"></i> ステップ4完了チェックリスト</h5>
                        <p>以下の項目が完了していることを確認してください：</p>
                        <ul class="list-unstyled">
                            <li><input type="checkbox"> app/src/main/resources/templates/index.htmlが作成されている</li>
                            <li><input type="checkbox"> Bootstrap 5.3.3がCDNで読み込まれている</li>
                            <li><input type="checkbox"> Thymeleaf名前空間（xmlns:th）が宣言されている</li>
                            <li><input type="checkbox"> th:field="*{message}"でフォームフィールドがバインドされている</li>
                            <li><input type="checkbox"> th:if="${chatForm.response != null}"で条件表示が実装されている</li>
                            <li><input type="checkbox"> th:errorsでバリデーションエラーが表示される</li>
                            <li><input type="checkbox"> http://localhost:8080/chatでチャット画面が表示される</li>
                            <li><input type="checkbox"> メッセージを送信するとAI応答が表示される</li>
                            <li><input type="checkbox"> 空白で送信するとバリデーションエラーが表示される</li>
                            <li><input type="checkbox"> 送信ボタンを押すと処理中メッセージが表示される</li>
                            <li><input type="checkbox"> 送信ボタンが無効化され、スピナーアイコンが表示される</li>
                            <li><input type="checkbox"> レスポンシブデザインが適用されている</li>
                        </ul>
                    </div>

                    <!-- 現在のファイル構成 -->
                    <div class="alert alert-light alert-custom">
                        <h6><i class="fas fa-folder-tree"></i> 現在のプロジェクト構成</h6>
                        <pre class="code-block"><code class="language-bash">ai-chat/
├── app/
│   ├── build.gradle
│   └── src/
│       ├── main/
│       │   ├── java/com/example/aichat/
│       │   │   ├── AiChatApplication.java
│       │   │   ├── ChatForm.java
│       │   │   ├── ChatController.java
│       │   │   └── TestAiController.java
│       │   └── resources/
│       │       ├── application.yml
│       │       └── templates/
│       │           └── index.html          # [新規] チャット画面
│       └── test/
├── gradlew
└── settings.gradle</code></pre>
                    </div>

                    <!-- 次のステップ -->
                    <div class="alert alert-info alert-custom">
                        <h6><i class="fas fa-forward"></i> 次のステップの予告</h6>
                        <p><strong>ステップ5: 動作確認</strong>では、以下の内容を実施します：</p>
                        <ul class="mb-0">
                            <li>アプリケーションの起動と動作確認</li>
                            <li>チャット機能のテスト</li>
                            <li>バリデーションエラーの確認</li>
                            <li>AI応答の確認</li>
                            <li>基本的なトラブルシューティング</li>
                        </ul>
                    </div>

                    <!-- ステップ間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-5 mb-4">
                        <a href="step3-chat-implementation.html" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 前のステップ：チャット機能実装
                        </a>
                        <a href="step5-testing.html" class="btn btn-primary">
                            次のステップ：動作確認 <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>

    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>
