<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI + Ollama チュートリアル ステップ6 - docker-compose統合環境構築</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        :root { --primary-color: #f57c00; --secondary-color: #ff9800; --accent-color: #4caf50; }
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8f9fa; padding-top: 56px; }
        .navbar { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
        .sidebar { position: fixed; top: 56px; bottom: 0; left: 0; z-index: 100; padding: 48px 0 0; background-color: #f8f9fa; overflow-y: auto; }
        .sidebar .nav-link { font-weight: 500; color: #333; padding: 0.5rem 1rem; border-left: 3px solid transparent; }
        .sidebar .nav-link:hover { color: var(--primary-color); background-color: #fff3e0; border-left-color: var(--primary-color); }
        .sidebar .nav-link.active { color: var(--primary-color); background-color: #fff3e0; border-left-color: var(--primary-color); font-weight: 700; }
        .chapter-title { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 30px; font-weight: 700; }
        .section-title { color: var(--secondary-color); margin-top: 30px; margin-bottom: 20px; font-weight: 600; border-left: 4px solid var(--secondary-color); padding-left: 15px; }
        .highlight { background: linear-gradient(to right, #fff3e0, #ffe0b2); border-left: 4px solid var(--primary-color); padding: 20px; margin: 20px 0; border-radius: 5px; }
        .highlight h5 { color: var(--primary-color); font-weight: 700; margin-bottom: 15px; }
        .code-block { background-color: #282c34; border-radius: 5px; padding: 15px; margin: 15px 0; overflow-x: auto; }
        .code-block code { color: #abb2bf; font-family: 'Courier New', monospace; font-size: 0.9rem; }
        .exercise-container { background-color: #f0f7ff; border: 2px solid #2196F3; border-radius: 8px; padding: 25px; margin: 25px 0; }
        .exercise-container h5 { color: #1976D2; font-weight: 700; margin-bottom: 15px; }
        .quiz-container { background-color: #f1f8e9; border: 2px solid var(--accent-color); border-radius: 8px; padding: 25px; margin: 25px 0; }
        .quiz-container h5 { color: var(--accent-color); font-weight: 700; margin-bottom: 15px; }
        .alert-custom { border-radius: 8px; padding: 15px 20px; margin: 15px 0; }
        footer { margin-top: 50px; padding: 30px 0; background-color: #212529; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: #e65100; border-color: #e65100; }
        .mermaid { background-color: white; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .concept-box { background-color: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .concept-box h6 { color: #2e7d32; font-weight: 700; margin-bottom: 10px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fab fa-java"></i> <strong>Spring AI + Ollama + Qwen3 実践チュートリアル</strong></a>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted"><span>チュートリアルステップ</span></h6>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="step1-environment-setup.html"><i class="fas fa-cog"></i> ステップ1: 環境構築</a></li>
                        <li class="nav-item"><a class="nav-link" href="step2-spring-ai-ollama-integration.html"><i class="fas fa-plug"></i> ステップ2: Spring AI統合</a></li>
                        <li class="nav-item"><a class="nav-link" href="step3-chat-implementation.html"><i class="fas fa-comments"></i> ステップ3: チャット機能実装</a></li>
                        <li class="nav-item"><a class="nav-link" href="step4-thymeleaf-view.html"><i class="fas fa-file-code"></i> ステップ4: Thymeleafビュー</a></li>
                        <li class="nav-item"><a class="nav-link" href="step5-docker-containerization.html"><i class="fab fa-docker"></i> ステップ5: Dockerコンテナ化</a></li>
                        <li class="nav-item"><a class="nav-link active" href="step6-docker-compose-integration.html"><i class="fas fa-layer-group"></i> ステップ6: docker-compose統合</a></li>
                        <li class="nav-item"><a class="nav-link" href="step7-testing-troubleshooting.html"><i class="fas fa-check-circle"></i> ステップ7: 動作確認</a></li>
                    </ul>
                </div>
            </nav>
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="fas fa-layer-group"></i> ステップ6: docker-compose統合環境構築</h1>
                </div>
                <div id="step6">
                    <h2 class="chapter-title">マルチコンテナ管理とサービス連携の自動化</h2>
                    <div class="highlight">
                        <h5><i class="fas fa-bullseye"></i> このステップで実装すること</h5>
                        <ul>
                            <li><strong>docker-compose.yml作成</strong> - マルチコンテナ定義ファイル</li>
                            <li><strong>ollamaサービス</strong> - Qwen3:7bモデルの自動ダウンロード設定</li>
                            <li><strong>appサービス</strong> - Spring Bootアプリケーションコンテナ</li>
                            <li><strong>サービス間依存関係</strong> - depends_onとヘルスチェック</li>
                            <li><strong>ネットワーク設定</strong> - サービス間通信の自動設定</li>
                            <li><strong>ボリューム永続化</strong> - Ollamaモデルデータの保持</li>
                            <li><strong>一括起動</strong> - docker-compose up一発で全環境構築</li>
                        </ul>
                        <p><strong>所要時間：</strong> 約3時間（Qwen3モデルダウンロード含む）</p>
                    </div>
                    <div class="alert alert-info alert-custom">
                        <h6><i class="fas fa-info-circle"></i> 前提条件</h6>
                        <ul class="mb-0">
                            <li>ステップ5が完了し、ai-chatイメージがビルドされていること</li>
                            <li>docker-composeコマンドが利用可能なこと（Docker Desktop V2に含まれる）</li>
                            <li>既存のollamaとai-chat-appコンテナは停止・削除しておく</li>
                        </ul>
                    </div>
                    <h3 class="section-title">6.1 docker-compose.ymlの作成</h3>
                    <p>OllamaとSpring Bootアプリケーションを一括管理するdocker-compose.ymlを作成します。</p>
                    <div class="exercise-container">
                        <h5><i class="fas fa-tasks"></i> 実装 6-1: docker-compose.ymlの完全実装</h5>
                        <h6><i class="fas fa-list-ol"></i> 手順</h6>
                        <ol>
                            <li><strong>既存コンテナの停止と削除（クリーンアップ）</strong>:
                                <pre class="code-block"><code class="language-bash"># 既存のコンテナを停止・削除
docker stop ollama ai-chat-app 2>/dev/null || true
docker rm ollama ai-chat-app 2>/dev/null || true</code></pre>
                            </li>
                            <li><strong>docker-compose.ymlの作成</strong>:
                                <p>プロジェクトルート（ai-chat/）にdocker-compose.ymlを作成：</p>
                                <pre class="code-block"><code class="language-yaml">version: '3.8'

services:
  # ==========================================
  # Ollama サービス（LLMプロバイダー）
  # ==========================================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      # Ollamaモデルデータの永続化
      - ollama-data:/root/.ollama
    healthcheck:
      # Ollamaサービスが起動しているか確認
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ai-chat-network
    # Ollamaモデルの自動ダウンロード
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Ollamaサーバーをバックグラウンドで起動
        ollama serve &
        # サーバー起動を待機
        sleep 5
        # Qwen3:7bモデルをダウンロード（存在しない場合）
        if ! ollama list | grep -q qwen3:7b; then
          echo "Downloading Qwen3:7b model..."
          ollama pull qwen3:7b
        fi
        # メインプロセスをフォアグラウンドで維持
        wait

  # ==========================================
  # Spring Boot アプリケーション
  # ==========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-chat-app
    ports:
      - "8080:8080"
    environment:
      # Ollama接続URL（サービス名で解決）
      SPRING_AI_OLLAMA_BASE_URL: http://ollama:11434
      SPRING_AI_OLLAMA_CHAT_MODEL: qwen3:7b
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - ai-chat-network
    restart: unless-stopped

# ==========================================
# ネットワーク定義
# ==========================================
networks:
  ai-chat-network:
    driver: bridge

# ==========================================
# ボリューム定義
# ==========================================
volumes:
  ollama-data:
    # Ollamaモデルデータ（約4.7GB）を永続化</code></pre>
                            </li>
                            <li><strong>設定の詳細説明</strong>:
                                <div class="concept-box mt-3">
                                    <h6>ollamaサービスのポイント</h6>
                                    <ul>
                                        <li><code>healthcheck</code>: サービスの健全性を定期的にチェック</li>
                                        <li><code>entrypoint/command</code>: Qwen3:7bモデルの自動ダウンロード</li>
                                        <li><code>volumes</code>: モデルデータを永続化（再起動時にダウンロード不要）</li>
                                    </ul>
                                    <h6>appサービスのポイント</h6>
                                    <ul class="mb-0">
                                        <li><code>depends_on: service_healthy</code>: Ollamaのヘルスチェックが成功してから起動</li>
                                        <li><code>environment</code>: コンテナ内の環境変数でOllama接続先を指定</li>
                                        <li><code>restart: unless-stopped</code>: エラー時の自動再起動</li>
                                    </ul>
                                </div>
                            </li>
                        </ol>
                        <h6><i class="fas fa-check-circle"></i> docker-composeで起動</h6>
                        <p>プロジェクトルートでdocker-composeコマンドを実行します：</p>
                        <pre class="code-block"><code class="language-bash"># 全サービスを一括起動（初回は10-30分かかる場合あり）
docker-compose up -d

# ログをリアルタイム表示
docker-compose logs -f

# 特定のサービスのログのみ表示
docker-compose logs -f ollama
docker-compose logs -f app</code></pre>
                        <h6><i class="fas fa-thumbs-up"></i> 期待される結果</h6>
                        <div class="alert alert-success">
                            <p><strong>起動成功メッセージ:</strong></p>
                            <pre class="mb-3">Creating network "ai-chat_ai-chat-network" ... done
Creating volume "ai-chat_ollama-data" ... done
Creating ollama ... done
Creating ai-chat-app ... done</pre>
                            <p><strong>サービス状態確認:</strong></p>
                            <pre class="mb-0">$ docker-compose ps
NAME           IMAGE                  STATUS         PORTS
ollama         ollama/ollama:latest   Up (healthy)   0.0.0.0:11434->11434/tcp
ai-chat-app    ai-chat_app            Up             0.0.0.0:8080->8080/tcp</pre>
                        </div>
                        <h6><i class="fas fa-exclamation-triangle"></i> トラブルシューティング</h6>
                        <div class="alert alert-warning">
                            <p><strong>エラー:</strong> app service is unhealthy</p>
                            <p><strong>解決方法:</strong></p>
                            <ul>
                                <li>Ollamaのヘルスチェックが成功しているか確認: <code>docker-compose ps</code></li>
                                <li>Qwen3:7bモデルがダウンロードされているか確認: <code>docker exec ollama ollama list</code></li>
                                <li>ログを確認: <code>docker-compose logs app</code></li>
                            </ul>
                            <p><strong>エラー:</strong> Downloading Qwen3:7b model が長時間続く</p>
                            <p><strong>解決方法:</strong> ネットワーク速度に依存します。約4GBのダウンロードのため、10-30分かかることがあります。待機するか、既にダウンロード済みの場合はボリュームを再利用してください。</p>
                        </div>
                    </div>
                    <h3 class="section-title">6.2 docker-compose コマンド集</h3>
                    <p>docker-composeの主要なコマンドを理解します。</p>
                    <div class="concept-box">
                        <h6><i class="fas fa-terminal"></i> よく使うdocker-composeコマンド</h6>
                        <table class="table table-bordered mt-3">
                            <thead class="table-light">
                                <tr><th style="width: 40%;">コマンド</th><th>説明</th></tr>
                            </thead>
                            <tbody>
                                <tr><td><code>docker-compose up -d</code></td><td>全サービスをバックグラウンドで起動</td></tr>
                                <tr><td><code>docker-compose down</code></td><td>全サービスを停止・削除（ボリュームは保持）</td></tr>
                                <tr><td><code>docker-compose down -v</code></td><td>サービスとボリュームを削除（完全クリーンアップ）</td></tr>
                                <tr><td><code>docker-compose ps</code></td><td>サービスの状態確認</td></tr>
                                <tr><td><code>docker-compose logs -f</code></td><td>全サービスのログをリアルタイム表示</td></tr>
                                <tr><td><code>docker-compose restart app</code></td><td>appサービスのみ再起動</td></tr>
                                <tr><td><code>docker-compose build</code></td><td>イメージを再ビルド</td></tr>
                                <tr><td><code>docker-compose exec app sh</code></td><td>appコンテナ内でシェル起動</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <h3 class="section-title">6.3 サービス間通信とネットワーク構成</h3>
                    <p>docker-composeによって自動的に構成されるネットワークの仕組みを理解します。</p>
                    <div class="mermaid">
                        flowchart TB
                            subgraph DockerHost["Dockerホスト"]
                                subgraph Network["ai-chat-network<br/>（ブリッジネットワーク）"]
                                    Ollama["ollamaコンテナ<br/>ホスト名: ollama<br/>IP: 172.x.x.2"]
                                    App["ai-chat-appコンテナ<br/>ホスト名: app<br/>IP: 172.x.x.3"]
                                end
                                HostPort["ホスト<br/>localhost:8080<br/>localhost:11434"]
                            end
                            Browser["ブラウザ"] --> |http://localhost:8080| HostPort
                            HostPort --> |ポートマッピング| App
                            App --> |http://ollama:11434| Ollama
                            Ollama --> |モデルデータ| Volume["ollama-data<br/>ボリューム"]

                            style Ollama fill:#4caf50,color:#fff
                            style App fill:#f57c00,color:#fff
                            style Network fill:#e3f2fd
                            style Volume fill:#ffe0b2
                    </div>
                    <div class="concept-box">
                        <h6><i class="fas fa-network-wired"></i> サービス名解決の仕組み</h6>
                        <p>docker-composeは自動的にDNSを設定し、サービス名でコンテナ間通信が可能になります：</p>
                        <ul class="mb-0">
                            <li>appコンテナから <code>http://ollama:11434</code> でOllamaにアクセス可能</li>
                            <li>IPアドレスを直接指定する必要がない（サービス名でOK）</li>
                            <li>同じネットワーク内のコンテナのみ通信可能（セキュリティ）</li>
                        </ul>
                    </div>
                    <h3 class="section-title">6.4 application.ymlの環境変数対応</h3>
                    <p>docker-compose.ymlで設定した環境変数をSpring Bootで読み取れるようにします。</p>
                    <div class="exercise-container">
                        <h5><i class="fas fa-tasks"></i> 実装 6-2: application.ymlの環境変数対応</h5>
                        <p>app/src/main/resources/application.ymlを以下のように更新（環境変数をデフォルト値として使用）：</p>
                        <pre class="code-block"><code class="language-yaml">server:
  port: 8080

spring:
  application:
    name: ai-chat
  ai:
    ollama:
      # 環境変数SPRING_AI_OLLAMA_BASE_URLがあればそれを使用、なければlocalhost
      base-url: ${SPRING_AI_OLLAMA_BASE_URL:http://localhost:11434}
      chat:
        # 環境変数SPRING_AI_OLLAMA_CHAT_MODELがあればそれを使用
        model: ${SPRING_AI_OLLAMA_CHAT_MODEL:qwen3:7b}
        options:
          temperature: 0.7
          top-p: 0.9
          num-predict: 2000</code></pre>
                        <p><strong>設定の説明:</strong></p>
                        <ul>
                            <li><code>${ENV_VAR:default}</code>: 環境変数が設定されていればそれを使用、なければデフォルト値</li>
                            <li>Docker環境では<code>http://ollama:11434</code>を使用</li>
                            <li>ローカル開発では<code>http://localhost:11434</code>を使用</li>
                        </ul>
                    </div>
                    <div class="quiz-container">
                        <h5><i class="fas fa-clipboard-check"></i> ステップ6完了チェックリスト</h5>
                        <p>以下の項目が完了していることを確認してください：</p>
                        <ul class="list-unstyled">
                            <li><input type="checkbox"> docker-compose.ymlが作成されている</li>
                            <li><input type="checkbox"> ollamaサービスが定義されている</li>
                            <li><input type="checkbox"> appサービスが定義されている</li>
                            <li><input type="checkbox"> ヘルスチェックが設定されている</li>
                            <li><input type="checkbox"> ボリューム永続化が設定されている</li>
                            <li><input type="checkbox"> <code>docker-compose up -d</code>が成功する</li>
                            <li><input type="checkbox"> <code>docker-compose ps</code>で両サービスがUP状態</li>
                            <li><input type="checkbox"> Qwen3:7bモデルが自動ダウンロードされている</li>
                            <li><input type="checkbox"> ブラウザで http://localhost:8080/chat にアクセスできる</li>
                            <li><input type="checkbox"> チャット機能が正常に動作する</li>
                        </ul>
                    </div>
                    <div class="alert alert-light alert-custom">
                        <h6><i class="fas fa-folder-tree"></i> 現在のプロジェクト構成</h6>
                        <pre class="code-block"><code class="language-bash">ai-chat/
├── docker-compose.yml         # [新規] マルチコンテナ定義
├── Dockerfile
├── .dockerignore
├── app/
│   ├── build.gradle
│   └── src/
│       └── main/
│           └── resources/
│               └── application.yml  # [更新] 環境変数対応
├── gradlew
└── settings.gradle</code></pre>
                    </div>
                    <div class="alert alert-info alert-custom">
                        <h6><i class="fas fa-forward"></i> 次のステップの予告</h6>
                        <p><strong>ステップ7: 動作確認とトラブルシューティング</strong>では、以下を実施します：</p>
                        <ul class="mb-0">
                            <li>全体システムの動作確認</li>
                            <li>AIチャット機能のテスト</li>
                            <li>よくあるエラーと対処法</li>
                            <li>ログ確認とデバッグ手法</li>
                            <li>パフォーマンスチューニング</li>
                        </ul>
                    </div>
                    <div class="d-flex justify-content-between mt-5 mb-4">
                        <a href="step5-docker-containerization.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> 前のステップ</a>
                        <a href="step7-testing-troubleshooting.html" class="btn btn-primary">次のステップ <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'default' });</script>
</body>
</html>
