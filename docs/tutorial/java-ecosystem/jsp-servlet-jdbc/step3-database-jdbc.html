<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSP/Servlet/JDBC 実践チュートリアル Step 3 - データベース設計とJDBC接続</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #f57c00;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e !important;
            color: #ffffff;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        .db-diagram {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .table-structure {
            border: 2px solid #2196f3;
            border-radius: 10px;
            background-color: white;
            margin: 10px auto;
            padding: 10px;
            max-width: 400px;
        }

        .table-header {
            background-color: #2196f3;
            color: white;
            padding: 5px;
            border-radius: 5px 5px 0 0;
            margin: -10px -10px 10px -10px;
            font-weight: bold;
        }

        .field-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid #eee;
        }

        .field-row:last-child {
            border-bottom: none;
        }

        .pk {
            color: #ff6b35;
            font-weight: bold;
        }

        .jdbc-flow {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #4caf50;
        }

        .dao-pattern {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">JSP/Servlet/JDBC 実践チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-nav-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="README.html">JSP/Servlet/JDBC</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>チュートリアル目次</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 開発環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-mvc-architecture.html">Step 2: MVC概要</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step3-database-jdbc.html">Step 3: DB・JDBC</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-registration.html">Step 4: ユーザー登録</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">Step 5: 一覧・詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">Step 6: 更新・削除</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-search-finalization.html">Step 7: 検索・仕上げ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 3: データベース設計とJDBC接続</h1>
                </div>

                <div id="step3">
                    <h2 class="chapter-title">データベース設計とJDBC接続</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>PgAdminを使用したPostgreSQLデータベースとテーブルの作成</li>
                            <li>ユーザー管理システム用のusersテーブル設計</li>
                            <li>JDBCドライバーの配置と基本的な接続方法</li>
                            <li>PreparedStatementを使用した安全なSQL実行</li>
                            <li>DAOパターンの概念と基本的な実装</li>
                            <li>例外処理とリソース管理のベストプラクティス</li>
                        </ul>
                    </div>

                    <!-- データベース設計 -->
                    <h3 class="section-title">3.1 ユーザー管理システムのデータベース設計</h3>
                    <p>シンプルなユーザー管理システムで使用するusersテーブルを設計します。基本的なCRUD操作を学習するため、必要最小限のフィールドで構成します。</p>

                    <div class="db-diagram">
                        <h5>usersテーブル構造</h5>
                        <div class="table-structure">
                            <div class="table-header">users テーブル</div>
                            <div class="field-row">
                                <span class="pk">id (PK)</span>
                                <span>SERIAL / INTEGER</span>
                            </div>
                            <div class="field-row">
                                <span>username</span>
                                <span>VARCHAR(50) NOT NULL</span>
                            </div>
                            <div class="field-row">
                                <span>email</span>
                                <span>VARCHAR(100) NOT NULL</span>
                            </div>
                            <div class="field-row">
                                <span>full_name</span>
                                <span>VARCHAR(100)</span>
                            </div>
                            <div class="field-row">
                                <span>created_at</span>
                                <span>TIMESTAMP DEFAULT NOW()</span>
                            </div>
                            <div class="field-row">
                                <span>updated_at</span>
                                <span>TIMESTAMP DEFAULT NOW()</span>
                            </div>
                        </div>
                        <div style="margin-top: 20px; font-size: 14px;">
                            <p><strong>設計ポイント:</strong></p>
                            <ul style="text-align: left; display: inline-block;">
                                <li>id: 主キー、自動採番（SERIAL）</li>
                                <li>username: ユニーク制約、ログイン用</li>
                                <li>email: ユニーク制約、連絡先</li>
                                <li>full_name: 表示名（NULL許可）</li>
                                <li>created_at/updated_at: 作成・更新日時</li>
                            </ul>
                        </div>
                    </div>

                    <!-- PgAdminでのデータベース作成 -->
                    <h3 class="section-title">3.2 PgAdminでのデータベース作成</h3>
                    <p>PgAdmin 4を使用してデータベースとテーブルを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 3-1: データベースの作成</h5>
                        <p>PgAdminを使用してユーザー管理システム用のデータベースを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>PgAdmin 4を起動</li>
                            <li>左側のツリーでPostgreSQLサーバーを展開</li>
                            <li>「Databases」を右クリック→「Create」→「Database...」</li>
                            <li>データベース作成設定:
                                <ul>
                                    <li>Database: <code>user_management</code></li>
                                    <li>Owner: <code>postgres</code></li>
                                    <li>Encoding: <code>UTF8</code></li>
                                </ul>
                            </li>
                            <li>「Save」をクリックしてデータベースを作成</li>
                        </ol>

                        <h6>動作確認</h6>
                        <p>左側のツリーに「user_management」データベースが作成されることを確認してください。</p>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 3-2: usersテーブルの作成</h5>
                        <p>作成したデータベースに、ユーザー管理用のusersテーブルを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>PgAdminでuser_managementデータベースを選択</li>
                            <li>上部メニューの「Tools」→「Query Tool」を選択</li>
                            <li>Query Editorに以下のSQLを入力:</li>
                        </ol>

                        <h6>テーブル作成SQL</h6>
                        <pre class="code-block"><code class="language-sql">-- usersテーブルの作成
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    full_name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- インデックスの作成（検索パフォーマンス向上）
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);

-- テーブル作成確認用クエリ
SELECT 
    table_name,
    column_name,
    data_type,
    is_nullable,
    column_default
FROM information_schema.columns 
WHERE table_name = 'users' 
ORDER BY ordinal_position;</code></pre>

                        <h6>手順（続き）</h6>
                        <ol start="4">
                            <li>「Execute/Refresh (F5)」ボタンをクリックしてSQLを実行</li>
                            <li>Output panelで実行結果を確認</li>
                            <li>左側のツリーで「user_management」→「Schemas」→「public」→「Tables」を展開</li>
                            <li>「users」テーブルが作成されていることを確認</li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 3-3: サンプルデータの挿入</h5>
                        <p>作成したusersテーブルにサンプルデータを挿入して、動作確認とデータ取得テストを行います。</p>
                        
                        <h6>サンプルデータ挿入SQL</h6>
                        <pre class="code-block"><code class="language-sql">-- サンプルデータの挿入
INSERT INTO users (username, email, full_name) VALUES
('tanaka_taro', 'tanaka@example.com', '田中太郎'),
('sato_hanako', 'sato@example.com', '佐藤花子'),
('yamada_jiro', 'yamada@example.com', '山田次郎'),
('suzuki_yuki', 'suzuki@example.com', '鈴木雪'),
('watanabe_ken', 'watanabe@example.com', '渡辺健');

-- データ挿入確認
SELECT * FROM users ORDER BY id;

-- 件数確認
SELECT COUNT(*) as total_users FROM users;</code></pre>

                        <h6>動作確認</h6>
                        <p>クエリを実行して、5件のサンプルデータが正常に挿入されることを確認してください。</p>
                    </div>

                    <!-- JDBC接続の基本 -->
                    <h3 class="section-title">3.3 JDBCによるデータベース接続</h3>
                    <p>JavaアプリケーションからPostgreSQLデータベースに接続するためのJDBC実装を学習します。</p>

                    <div class="jdbc-flow">
                        <h5>JDBC接続の基本的な流れ</h5>
                        <ol>
                            <li><strong>JDBCドライバーの読み込み</strong>: Class.forName()でドライバーを登録</li>
                            <li><strong>データベース接続</strong>: DriverManager.getConnection()で接続取得</li>
                            <li><strong>SQL実行準備</strong>: PreparedStatementでSQLを準備</li>
                            <li><strong>パラメータ設定</strong>: setString()等でプレースホルダーに値を設定</li>
                            <li><strong>SQL実行</strong>: executeQuery()またはexecuteUpdate()でSQL実行</li>
                            <li><strong>結果処理</strong>: ResultSetから結果を取得・処理</li>
                            <li><strong>リソース解放</strong>: Connection、Statement、ResultSetを閉じる</li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 3-4: データベース接続ユーティリティクラスの作成</h5>
                        <p>データベース接続を管理するためのユーティリティクラスを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>Project Explorerで <code>src/main/java</code> を右クリック</li>
                            <li>「New」→「Package」を選択</li>
                            <li>Package name: <code>util</code></li>
                            <li>作成した <code>util</code> パッケージに新しいクラス <code>DatabaseUtil</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>DatabaseUtil.java</h6>
                        <pre class="code-block"><code class="language-java">package util;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

/**
 * データベース接続管理ユーティリティクラス
 * シングルトンパターンでDB接続情報を管理
 */
public class DatabaseUtil {
    
    // データベース接続情報
    private static final String DB_URL = "jdbc:postgresql://localhost:5432/user_management";
    private static final String DB_USERNAME = "postgres";
    private static final String DB_PASSWORD = "postgres123"; // 実際のパスワードに変更してください
    
    // JDBCドライバー名
    private static final String JDBC_DRIVER = "org.postgresql.Driver";
    
    /**
     * データベース接続を取得
     * @return Connection データベース接続オブジェクト
     * @throws SQLException データベース接続エラー
     * @throws ClassNotFoundException JDBCドライバーが見つからない
     */
    public static Connection getConnection() throws SQLException, ClassNotFoundException {
        // JDBCドライバーの読み込み
        Class.forName(JDBC_DRIVER);
        
        // データベース接続の取得
        Connection conn = DriverManager.getConnection(DB_URL, DB_USERNAME, DB_PASSWORD);
        
        // 自動コミットを無効化（トランザクション制御のため）
        conn.setAutoCommit(false);
        
        return conn;
    }
    
    /**
     * データベース接続のテスト
     * @return boolean 接続成功の場合true
     */
    public static boolean testConnection() {
        Connection conn = null;
        try {
            conn = getConnection();
            return !conn.isClosed();
        } catch (SQLException | ClassNotFoundException e) {
            System.err.println("データベース接続テストエラー: " + e.getMessage());
            return false;
        } finally {
            closeConnection(conn);
        }
    }
    
    /**
     * Connection、PreparedStatement、ResultSetの安全なクローズ
     * @param conn Connection
     * @param stmt PreparedStatement
     * @param rs ResultSet
     */
    public static void closeResources(Connection conn, PreparedStatement stmt, ResultSet rs) {
        // ResultSetのクローズ
        if (rs != null) {
            try {
                rs.close();
            } catch (SQLException e) {
                System.err.println("ResultSet close error: " + e.getMessage());
            }
        }
        
        // PreparedStatementのクローズ
        if (stmt != null) {
            try {
                stmt.close();
            } catch (SQLException e) {
                System.err.println("Statement close error: " + e.getMessage());
            }
        }
        
        // Connectionのクローズ
        closeConnection(conn);
    }
    
    /**
     * Connectionの安全なクローズ
     * @param conn Connection
     */
    public static void closeConnection(Connection conn) {
        if (conn != null) {
            try {
                // 未コミットのトランザクションがある場合はロールバック
                if (!conn.getAutoCommit()) {
                    conn.rollback();
                }
                conn.close();
            } catch (SQLException e) {
                System.err.println("Connection close error: " + e.getMessage());
            }
        }
    }
    
    /**
     * トランザクションのコミット
     * @param conn Connection
     * @throws SQLException コミットエラー
     */
    public static void commit(Connection conn) throws SQLException {
        if (conn != null) {
            conn.commit();
        }
    }
    
    /**
     * トランザクションのロールバック
     * @param conn Connection
     */
    public static void rollback(Connection conn) {
        if (conn != null) {
            try {
                conn.rollback();
            } catch (SQLException e) {
                System.err.println("Rollback error: " + e.getMessage());
            }
        }
    }
}</code></pre>
                    </div>

                    <!-- Userエンティティクラスの作成 -->
                    <h3 class="section-title">3.4 Userエンティティクラスの作成</h3>
                    <p>MVCパターンのModel層となるUserエンティティクラスを作成します。データベースのusersテーブルの1行に対応するJavaオブジェクトです。</p>

                    <div class="exercise-container">
                        <h5>実習 3-5: Userエンティティクラスの作成</h5>
                        <p>usersテーブルのデータを格納するためのJavaBeansクラスを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>src/main/java</code> に新しいパッケージ <code>model</code> を作成</li>
                            <li><code>model</code> パッケージに新しいクラス <code>User</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>User.java</h6>
                        <pre class="code-block"><code class="language-java">package model;

import java.sql.Timestamp;

/**
 * Userエンティティクラス
 * usersテーブルの1行に対応するJavaBeansクラス
 * MVCパターンのModel層を構成
 */
public class User {
    
    // フィールド（usersテーブルの列に対応）
    private int id;
    private String username;
    private String email;
    private String fullName;
    private Timestamp createdAt;
    private Timestamp updatedAt;
    
    // デフォルトコンストラクタ
    public User() {
    }
    
    // 全フィールドを受け取るコンストラクタ
    public User(int id, String username, String email, String fullName, 
                Timestamp createdAt, Timestamp updatedAt) {
        this.id = id;
        this.username = username;
        this.email = email;
        this.fullName = fullName;
        this.createdAt = createdAt;
        this.updatedAt = updatedAt;
    }
    
    // 新規作成用コンストラクタ（IDと日時は自動設定）
    public User(String username, String email, String fullName) {
        this.username = username;
        this.email = email;
        this.fullName = fullName;
    }
    
    // Getter/Setterメソッド
    
    public int getId() {
        return id;
    }
    
    public void setId(int id) {
        this.id = id;
    }
    
    public String getUsername() {
        return username;
    }
    
    public void setUsername(String username) {
        this.username = username;
    }
    
    public String getEmail() {
        return email;
    }
    
    public void setEmail(String email) {
        this.email = email;
    }
    
    public String getFullName() {
        return fullName;
    }
    
    public void setFullName(String fullName) {
        this.fullName = fullName;
    }
    
    public Timestamp getCreatedAt() {
        return createdAt;
    }
    
    public void setCreatedAt(Timestamp createdAt) {
        this.createdAt = createdAt;
    }
    
    public Timestamp getUpdatedAt() {
        return updatedAt;
    }
    
    public void setUpdatedAt(Timestamp updatedAt) {
        this.updatedAt = updatedAt;
    }
    
    // Object基本メソッドのオーバーライド
    
    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", username='" + username + '\'' +
                ", email='" + email + '\'' +
                ", fullName='" + fullName + '\'' +
                ", createdAt=" + createdAt +
                ", updatedAt=" + updatedAt +
                '}';
    }
    
    @Override
    public boolean equals(Object obj) {
        if (this == obj) return true;
        if (obj == null || getClass() != obj.getClass()) return false;
        
        User user = (User) obj;
        return id == user.id;
    }
    
    @Override
    public int hashCode() {
        return Integer.hashCode(id);
    }
}</code></pre>
                    </div>

                    <!-- DAOパターンの実装 -->
                    <h3 class="section-title">3.5 DAOパターンの実装</h3>
                    <p>DAO（Data Access Object）パターンは、データアクセスロジックを分離し、データベース操作を抽象化するデザインパターンです。</p>

                    <div class="dao-pattern">
                        <h5>DAOパターンの利点</h5>
                        <ul>
                            <li><strong>関心の分離</strong>: ビジネスロジックとデータアクセスロジックを分離</li>
                            <li><strong>再利用性</strong>: データアクセス処理を複数のコントローラで再利用</li>
                            <li><strong>テスト容易性</strong>: データアクセス層を独立してテスト可能</li>
                            <li><strong>保守性</strong>: データベース変更時の影響を局所化</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 3-6: UserDAOクラスの作成</h5>
                        <p>ユーザー情報に対するCRUD操作を提供するDAOクラスを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>model</code> パッケージに新しいクラス <code>UserDAO</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>UserDAO.java</h6>
                        <pre class="code-block"><code class="language-java">package model;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.List;

import util.DatabaseUtil;

/**
 * UserDAO (Data Access Object)
 * ユーザー情報に対するCRUD操作を提供
 * MVCパターンのModel層を構成
 */
public class UserDAO {
    
    // SQL文の定義
    private static final String SELECT_ALL_USERS = 
        "SELECT id, username, email, full_name, created_at, updated_at FROM users ORDER BY id";
    
    private static final String SELECT_USER_BY_ID = 
        "SELECT id, username, email, full_name, created_at, updated_at FROM users WHERE id = ?";
        
    private static final String SELECT_USER_BY_USERNAME = 
        "SELECT id, username, email, full_name, created_at, updated_at FROM users WHERE username = ?";
    
    private static final String INSERT_USER = 
        "INSERT INTO users (username, email, full_name) VALUES (?, ?, ?)";
    
    private static final String UPDATE_USER = 
        "UPDATE users SET username = ?, email = ?, full_name = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?";
    
    private static final String DELETE_USER = 
        "DELETE FROM users WHERE id = ?";
    
    private static final String COUNT_USERS = 
        "SELECT COUNT(*) FROM users";
    
    /**
     * 全ユーザーを取得
     * @return List&lt;User&gt; 全ユーザーのリスト
     * @throws SQLException データベースアクセスエラー
     */
    public List&lt;User&gt; findAll() throws SQLException {
        List&lt;User&gt; users = new ArrayList&lt;&gt;();
        Connection conn = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        
        try {
            conn = DatabaseUtil.getConnection();
            stmt = conn.prepareStatement(SELECT_ALL_USERS);
            rs = stmt.executeQuery();
            
            while (rs.next()) {
                User user = createUserFromResultSet(rs);
                users.add(user);
            }
            
            DatabaseUtil.commit(conn);
            
        } catch (ClassNotFoundException | SQLException e) {
            DatabaseUtil.rollback(conn);
            throw new SQLException("全ユーザー取得エラー: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, rs);
        }
        
        return users;
    }
    
    /**
     * IDによるユーザー検索
     * @param id ユーザーID
     * @return User ユーザーオブジェクト、見つからない場合はnull
     * @throws SQLException データベースアクセスエラー
     */
    public User findById(int id) throws SQLException {
        User user = null;
        Connection conn = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        
        try {
            conn = DatabaseUtil.getConnection();
            stmt = conn.prepareStatement(SELECT_USER_BY_ID);
            stmt.setInt(1, id);
            rs = stmt.executeQuery();
            
            if (rs.next()) {
                user = createUserFromResultSet(rs);
            }
            
            DatabaseUtil.commit(conn);
            
        } catch (ClassNotFoundException | SQLException e) {
            DatabaseUtil.rollback(conn);
            throw new SQLException("ユーザー検索エラー (ID: " + id + "): " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, rs);
        }
        
        return user;
    }
    
    /**
     * ユーザー名によるユーザー検索
     * @param username ユーザー名
     * @return User ユーザーオブジェクト、見つからない場合はnull
     * @throws SQLException データベースアクセスエラー
     */
    public User findByUsername(String username) throws SQLException {
        User user = null;
        Connection conn = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        
        try {
            conn = DatabaseUtil.getConnection();
            stmt = conn.prepareStatement(SELECT_USER_BY_USERNAME);
            stmt.setString(1, username);
            rs = stmt.executeQuery();
            
            if (rs.next()) {
                user = createUserFromResultSet(rs);
            }
            
            DatabaseUtil.commit(conn);
            
        } catch (ClassNotFoundException | SQLException e) {
            DatabaseUtil.rollback(conn);
            throw new SQLException("ユーザー検索エラー (Username: " + username + "): " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, rs);
        }
        
        return user;
    }
    
    /**
     * 新規ユーザーの挿入
     * @param user 挿入するユーザーオブジェクト
     * @return boolean 挿入成功の場合true
     * @throws SQLException データベースアクセスエラー
     */
    public boolean insert(User user) throws SQLException {
        Connection conn = null;
        PreparedStatement stmt = null;
        
        try {
            conn = DatabaseUtil.getConnection();
            stmt = conn.prepareStatement(INSERT_USER, Statement.RETURN_GENERATED_KEYS);
            
            stmt.setString(1, user.getUsername());
            stmt.setString(2, user.getEmail());
            stmt.setString(3, user.getFullName());
            
            int affectedRows = stmt.executeUpdate();
            
            if (affectedRows > 0) {
                // 自動生成されたIDを取得してuserオブジェクトに設定
                ResultSet generatedKeys = stmt.getGeneratedKeys();
                if (generatedKeys.next()) {
                    user.setId(generatedKeys.getInt(1));
                }
                DatabaseUtil.commit(conn);
                return true;
            }
            
        } catch (ClassNotFoundException | SQLException e) {
            DatabaseUtil.rollback(conn);
            throw new SQLException("ユーザー挿入エラー: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, null);
        }
        
        return false;
    }
    
    /**
     * ユーザー情報の更新
     * @param user 更新するユーザーオブジェクト
     * @return boolean 更新成功の場合true
     * @throws SQLException データベースアクセスエラー
     */
    public boolean update(User user) throws SQLException {
        Connection conn = null;
        PreparedStatement stmt = null;
        
        try {
            conn = DatabaseUtil.getConnection();
            stmt = conn.prepareStatement(UPDATE_USER);
            
            stmt.setString(1, user.getUsername());
            stmt.setString(2, user.getEmail());
            stmt.setString(3, user.getFullName());
            stmt.setInt(4, user.getId());
            
            int affectedRows = stmt.executeUpdate();
            
            if (affectedRows > 0) {
                DatabaseUtil.commit(conn);
                return true;
            }
            
        } catch (ClassNotFoundException | SQLException e) {
            DatabaseUtil.rollback(conn);
            throw new SQLException("ユーザー更新エラー: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, null);
        }
        
        return false;
    }
    
    /**
     * ユーザーの削除
     * @param id 削除するユーザーのID
     * @return boolean 削除成功の場合true
     * @throws SQLException データベースアクセスエラー
     */
    public boolean delete(int id) throws SQLException {
        Connection conn = null;
        PreparedStatement stmt = null;
        
        try {
            conn = DatabaseUtil.getConnection();
            stmt = conn.prepareStatement(DELETE_USER);
            stmt.setInt(1, id);
            
            int affectedRows = stmt.executeUpdate();
            
            if (affectedRows > 0) {
                DatabaseUtil.commit(conn);
                return true;
            }
            
        } catch (ClassNotFoundException | SQLException e) {
            DatabaseUtil.rollback(conn);
            throw new SQLException("ユーザー削除エラー: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, null);
        }
        
        return false;
    }
    
    /**
     * ユーザー数の取得
     * @return int ユーザー総数
     * @throws SQLException データベースアクセスエラー
     */
    public int count() throws SQLException {
        int count = 0;
        Connection conn = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        
        try {
            conn = DatabaseUtil.getConnection();
            stmt = conn.prepareStatement(COUNT_USERS);
            rs = stmt.executeQuery();
            
            if (rs.next()) {
                count = rs.getInt(1);
            }
            
            DatabaseUtil.commit(conn);
            
        } catch (ClassNotFoundException | SQLException e) {
            DatabaseUtil.rollback(conn);
            throw new SQLException("ユーザー数取得エラー: " + e.getMessage(), e);
        } finally {
            DatabaseUtil.closeResources(conn, stmt, rs);
        }
        
        return count;
    }
    
    /**
     * ResultSetからUserオブジェクトを作成するヘルパーメソッド
     * @param rs ResultSet
     * @return User ユーザーオブジェクト
     * @throws SQLException データベースアクセスエラー
     */
    private User createUserFromResultSet(ResultSet rs) throws SQLException {
        User user = new User();
        user.setId(rs.getInt("id"));
        user.setUsername(rs.getString("username"));
        user.setEmail(rs.getString("email"));
        user.setFullName(rs.getString("full_name"));
        user.setCreatedAt(rs.getTimestamp("created_at"));
        user.setUpdatedAt(rs.getTimestamp("updated_at"));
        return user;
    }
}</code></pre>
                    </div>

                    <!-- DAOテスト用Servletの作成 -->
                    <div class="exercise-container">
                        <h5>実習 3-7: DAO動作確認用Servletの作成</h5>
                        <p>作成したUserDAOの動作をテストするためのServletを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>controller</code> パッケージに新しいクラス <code>UserTestServlet</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>UserTestServlet.java</h6>
                        <pre class="code-block"><code class="language-java">package controller;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.SQLException;
import java.util.List;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.User;
import model.UserDAO;
import util.DatabaseUtil;

/**
 * UserDAOの動作確認用Servlet
 * データベース接続とCRUD操作をテスト
 */
@WebServlet("/user-test")
public class UserTestServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    
    private UserDAO userDAO = new UserDAO();

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        response.setContentType("text/html; charset=UTF-8");
        response.setCharacterEncoding("UTF-8");
        
        PrintWriter out = response.getWriter();
        
        out.println("&lt;!DOCTYPE html&gt;");
        out.println("&lt;html&gt;");
        out.println("&lt;head&gt;");
        out.println("    &lt;meta charset='UTF-8'&gt;");
        out.println("    &lt;title&gt;UserDAO テスト結果&lt;/title&gt;");
        out.println("    &lt;style&gt;");
        out.println("        body { font-family: Arial, sans-serif; margin: 20px; }");
        out.println("        .success { color: green; background-color: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; }");
        out.println("        .error { color: red; background-color: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0; }");
        out.println("        .test-section { background-color: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px; }");
        out.println("        table { width: 100%; border-collapse: collapse; margin: 10px 0; }");
        out.println("        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }");
        out.println("        th { background-color: #007bff; color: white; }");
        out.println("    &lt;/style&gt;");
        out.println("&lt;/head&gt;");
        out.println("&lt;body&gt;");
        out.println("    &lt;h1&gt;UserDAO・データベース接続テスト&lt;/h1&gt;");
        
        // データベース接続テスト
        out.println("    &lt;div class='test-section'&gt;");
        out.println("        &lt;h3&gt;1. データベース接続テスト&lt;/h3&gt;");
        if (DatabaseUtil.testConnection()) {
            out.println("        &lt;div class='success'&gt;✓ データベース接続成功&lt;/div&gt;");
        } else {
            out.println("        &lt;div class='error'&gt;✗ データベース接続失敗&lt;/div&gt;");
            out.println("    &lt;/div&gt;");
            out.println("&lt;/body&gt;&lt;/html&gt;");
            return;
        }
        out.println("    &lt;/div&gt;");
        
        // ユーザー一覧取得テスト
        out.println("    &lt;div class='test-section'&gt;");
        out.println("        &lt;h3&gt;2. 全ユーザー取得テスト&lt;/h3&gt;");
        try {
            List&lt;User&gt; users = userDAO.findAll();
            out.println("        &lt;div class='success'&gt;✓ ユーザー一覧取得成功 (" + users.size() + "件)&lt;/div&gt;");
            
            if (!users.isEmpty()) {
                out.println("        &lt;table&gt;");
                out.println("            &lt;thead&gt;");
                out.println("                &lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;ユーザー名&lt;/th&gt;&lt;th&gt;メール&lt;/th&gt;&lt;th&gt;氏名&lt;/th&gt;&lt;th&gt;作成日時&lt;/th&gt;&lt;/tr&gt;");
                out.println("            &lt;/thead&gt;");
                out.println("            &lt;tbody&gt;");
                for (User user : users) {
                    out.println("                &lt;tr&gt;");
                    out.println("                    &lt;td&gt;" + user.getId() + "&lt;/td&gt;");
                    out.println("                    &lt;td&gt;" + user.getUsername() + "&lt;/td&gt;");
                    out.println("                    &lt;td&gt;" + user.getEmail() + "&lt;/td&gt;");
                    out.println("                    &lt;td&gt;" + user.getFullName() + "&lt;/td&gt;");
                    out.println("                    &lt;td&gt;" + user.getCreatedAt() + "&lt;/td&gt;");
                    out.println("                &lt;/tr&gt;");
                }
                out.println("            &lt;/tbody&gt;");
                out.println("        &lt;/table&gt;");
            }
        } catch (SQLException e) {
            out.println("        &lt;div class='error'&gt;✗ ユーザー一覧取得エラー: " + e.getMessage() + "&lt;/div&gt;");
        }
        out.println("    &lt;/div&gt;");
        
        // ユーザー数取得テスト
        out.println("    &lt;div class='test-section'&gt;");
        out.println("        &lt;h3&gt;3. ユーザー数取得テスト&lt;/h3&gt;");
        try {
            int count = userDAO.count();
            out.println("        &lt;div class='success'&gt;✓ ユーザー数取得成功: " + count + "件&lt;/div&gt;");
        } catch (SQLException e) {
            out.println("        &lt;div class='error'&gt;✗ ユーザー数取得エラー: " + e.getMessage() + "&lt;/div&gt;");
        }
        out.println("    &lt;/div&gt;");
        
        // ID検索テスト
        out.println("    &lt;div class='test-section'&gt;");
        out.println("        &lt;h3&gt;4. ID検索テスト (ID=1)&lt;/h3&gt;");
        try {
            User user = userDAO.findById(1);
            if (user != null) {
                out.println("        &lt;div class='success'&gt;✓ ユーザー検索成功&lt;/div&gt;");
                out.println("        &lt;p&gt;&lt;strong&gt;検索結果:&lt;/strong&gt; " + user.toString() + "&lt;/p&gt;");
            } else {
                out.println("        &lt;div class='error'&gt;✗ ID=1のユーザーが見つかりません&lt;/div&gt;");
            }
        } catch (SQLException e) {
            out.println("        &lt;div class='error'&gt;✗ ユーザー検索エラー: " + e.getMessage() + "&lt;/div&gt;");
        }
        out.println("    &lt;/div&gt;");
        
        // ユーザー名検索テスト
        out.println("    &lt;div class='test-section'&gt;");
        out.println("        &lt;h3&gt;5. ユーザー名検索テスト (tanaka_taro)&lt;/h3&gt;");
        try {
            User user = userDAO.findByUsername("tanaka_taro");
            if (user != null) {
                out.println("        &lt;div class='success'&gt;✓ ユーザー名検索成功&lt;/div&gt;");
                out.println("        &lt;p&gt;&lt;strong&gt;検索結果:&lt;/strong&gt; " + user.toString() + "&lt;/p&gt;");
            } else {
                out.println("        &lt;div class='error'&gt;✗ ユーザー名'tanaka_taro'が見つかりません&lt;/div&gt;");
            }
        } catch (SQLException e) {
            out.println("        &lt;div class='error'&gt;✗ ユーザー名検索エラー: " + e.getMessage() + "&lt;/div&gt;");
        }
        out.println("    &lt;/div&gt;");
        
        out.println("    &lt;hr&gt;");
        out.println("    &lt;p&gt;&lt;a href='data'&gt;Servlet-JSP連携テスト&lt;/a&gt; | &lt;a href='hello'&gt;Hello Servlet&lt;/a&gt; | &lt;a href='index.jsp'&gt;トップページ&lt;/a&gt;&lt;/p&gt;");
        out.println("&lt;/body&gt;");
        out.println("&lt;/html&gt;");
    }
}</code></pre>

                        <h6>動作確認</h6>
                        <ol>
                            <li>プロジェクトを保存（Ctrl+S）</li>
                            <li>ブラウザで <code>http://localhost:8080/SimpleUserManagementSystem/user-test</code> にアクセス</li>
                            <li>以下の項目が成功していることを確認:
                                <ul>
                                    <li>データベース接続テスト</li>
                                    <li>全ユーザー取得（5件のサンプルデータ表示）</li>
                                    <li>ユーザー数取得（5件）</li>
                                    <li>ID検索（ID=1のユーザー情報表示）</li>
                                    <li>ユーザー名検索（tanaka_taroの情報表示）</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>JDBCによるデータベース接続の基本的な手順を順番に記述してください。</strong></li>
                            <li><strong>PreparedStatementを使用する利点を3つ挙げてください。</strong></li>
                            <li><strong>DAOパターンの役割と利点を説明してください。</strong></li>
                            <li><strong>以下のSQL文の意味を説明してください:</strong>
                                <pre><code>SELECT id, username, email FROM users WHERE username = ?</code></pre>
                            </li>
                            <li><strong>データベースリソース（Connection、Statement、ResultSet）を適切に解放する理由と方法を説明してください。</strong></li>
                            <li><strong>トランザクション制御（commit、rollback）が必要な理由を説明してください。</strong></li>
                        </ol>
                        
                        <details style="margin-top: 20px;">
                            <summary>解答例を表示</summary>
                            <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                <ol>
                                    <li>①JDBCドライバー読み込み →②データベース接続 →③SQL準備 →④パラメータ設定 →⑤SQL実行 →⑥結果処理 →⑦リソース解放</li>
                                    <li>①SQLインジェクション攻撃の防止 ②SQL文の事前コンパイルによる性能向上 ③型安全なパラメータ設定</li>
                                    <li>データアクセスロジックを分離し、ビジネスロジックから独立させることで、保守性・再利用性・テスト容易性を向上させる</li>
                                    <li>usersテーブルからid、username、emailカラムを取得し、username列の値がパラメータ（?）と一致する行を検索する</li>
                                    <li>メモリリーク防止とデータベース接続プールの枯渇防止のため、finally節またはtry-with-resourcesでclose()を呼び出す</li>
                                    <li>データの整合性を保つため。エラー発生時にrollbackで変更を取り消し、正常完了時にcommitで変更を確定する</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">3.6 まとめ</h3>
                    <p>このステップでは、データベース設計からJDBCによるデータアクセス層の実装まで学習しました：</p>
                    <ul>
                        <li><strong>データベース設計</strong>: usersテーブル設計、PgAdminでのDB・テーブル作成</li>
                        <li><strong>JDBC基礎</strong>: データベース接続、PreparedStatement、ResultSet</li>
                        <li><strong>エンティティクラス</strong>: Userクラスによるデータ表現</li>
                        <li><strong>DAOパターン</strong>: UserDAOによるデータアクセス層の分離</li>
                        <li><strong>例外処理</strong>: SQLExceptionの適切な処理</li>
                        <li><strong>リソース管理</strong>: Connection・Statement・ResultSetの適切な解放</li>
                        <li><strong>トランザクション</strong>: commit・rollbackによるデータ整合性管理</li>
                    </ul>
                    
                    <p>次のステップでは、作成したDAOを活用してユーザー登録機能を実装し、フォーム処理とデータ挿入の実践的な方法を学習します。</p>

                    <!-- ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step2-mvc-architecture.html" class="btn btn-secondary">← 前の章: MVCアーキテクチャ</a>
                        <a href="step4-user-registration.html" class="btn btn-primary">次の章: ユーザー登録機能の実装 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>