<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSP/Servlet/JDBC 実践チュートリアル Step 6 - ユーザー更新・削除機能</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #f57c00;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e !important;
            color: #ffffff;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        .crud-flow {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .crud-step {
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            background-color: #f8d7da;
            display: inline-block;
            min-width: 120px;
        }

        .update-step {
            border-color: #ffc107;
            background-color: #fff3cd;
        }

        .flow-arrow {
            font-size: 1.5em;
            color: #666;
            margin: 0 10px;
        }

        .transaction-info {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }

        .security-note {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #ff9800;
        }

        .form-comparison {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .form-example {
            flex: 1;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }

        .danger-zone {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">JSP/Servlet/JDBC 実践チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-nav-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="README.html">JSP/Servlet/JDBC</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>チュートリアル目次</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 開発環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-mvc-architecture.html">Step 2: MVC概要</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-database-jdbc.html">Step 3: DB・JDBC</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-registration.html">Step 4: ユーザー登録</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">Step 5: 一覧・詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step6-user-update-delete.html">Step 6: 更新・削除</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-search-finalization.html">Step 7: 検索・仕上げ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 6: ユーザー更新・削除機能</h1>
                </div>

                <div id="step6">
                    <h2 class="chapter-title">ユーザー更新・削除機能</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>既存データを編集フォームに表示する方法</li>
                            <li>UserDAOのupdateメソッドを使用したデータ更新</li>
                            <li>削除確認画面の実装と安全な削除処理</li>
                            <li>トランザクション処理の基本概念</li>
                            <li>楽観的排他制御の考え方</li>
                            <li>エラーハンドリングとロールバック処理</li>
                        </ul>
                    </div>

                    <!-- 更新・削除の処理フロー -->
                    <h3 class="section-title">6.1 更新・削除の処理フロー</h3>
                    <p>CRUDのU（Update）とD（Delete）操作の処理フローを理解し、安全なデータ操作の方法を学習します。</p>

                    <div class="crud-flow">
                        <h5>ユーザー更新の処理フロー</h5>
                        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin: 20px 0;">
                            <div class="crud-step update-step">
                                <strong>1. 編集要求</strong><br>
                                <small>GET /user-edit?id=N</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="crud-step update-step">
                                <strong>2. データ取得</strong><br>
                                <small>DAO.findById()</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="crud-step update-step">
                                <strong>3. フォーム表示</strong><br>
                                <small>現在値を設定</small>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin: 20px 0;">
                            <div class="crud-step update-step">
                                <strong>4. データ送信</strong><br>
                                <small>POST /user-update</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="crud-step update-step">
                                <strong>5. バリデーション</strong><br>
                                <small>検証・重複チェック</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="crud-step update-step">
                                <strong>6. データ更新</strong><br>
                                <small>DAO.update()</small>
                            </div>
                        </div>

                        <h5 style="margin-top: 30px;">ユーザー削除の処理フロー</h5>
                        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin: 20px 0;">
                            <div class="crud-step">
                                <strong>1. 削除要求</strong><br>
                                <small>GET /user-delete?id=N</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="crud-step">
                                <strong>2. 確認画面</strong><br>
                                <small>削除対象表示</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="crud-step">
                                <strong>3. 削除実行</strong><br>
                                <small>POST /user-delete</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="crud-step">
                                <strong>4. データ削除</strong><br>
                                <small>DAO.delete()</small>
                            </div>
                        </div>
                    </div>

                    <!-- ユーザー編集Servletの作成 -->
                    <h3 class="section-title">6.2 ユーザー編集Servlet（表示）の作成</h3>
                    <p>指定されたIDのユーザー情報を取得し、編集フォームに表示するServletを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-1: ユーザー編集表示Servletの作成</h5>
                        <p>既存ユーザーの情報を編集フォームに表示するServletを実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>controller</code> パッケージに新しいクラス <code>UserEditServlet</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>UserEditServlet.java</h6>
                        <pre class="code-block"><code class="language-java">package controller;

import java.io.IOException;
import java.sql.SQLException;

import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.User;
import model.UserDAO;

/**
 * ユーザー編集フォーム表示Servlet
 * GET: 編集フォーム表示
 * Controller層（MVCパターン）
 */
@WebServlet("/user-edit")
public class UserEditServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    
    private UserDAO userDAO = new UserDAO();

    /**
     * GETリクエスト: ユーザー編集フォームの表示
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // IDパラメータの取得
        String idParam = request.getParameter("id");
        
        // IDパラメータの検証
        if (idParam == null || idParam.trim().isEmpty()) {
            request.setAttribute("errorMessage", "ユーザーIDが指定されていません。");
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        int userId;
        try {
            userId = Integer.parseInt(idParam);
        } catch (NumberFormatException e) {
            request.setAttribute("errorMessage", "無効なユーザーIDです: " + idParam);
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        try {
            // 指定されたIDのユーザーを取得
            User user = userDAO.findById(userId);
            
            if (user != null) {
                // ユーザーが見つかった場合、編集フォームに現在の値を設定
                request.setAttribute("user", user);
                request.setAttribute("username", user.getUsername());
                request.setAttribute("email", user.getEmail());
                request.setAttribute("fullName", user.getFullName());
                request.setAttribute("mode", "edit"); // 編集モードを示すフラグ
            } else {
                // ユーザーが見つからなかった場合
                request.setAttribute("errorMessage", "ID " + userId + " のユーザーが見つかりません。");
            }
            
            // 編集フォーム用JSPにフォワード
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
            dispatcher.forward(request, response);
            
        } catch (SQLException e) {
            // データベースエラーの場合
            request.setAttribute("errorMessage", "データベースエラーが発生しました: " + e.getMessage());
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
            dispatcher.forward(request, response);
        }
    }
}</code></pre>
                    </div>

                    <!-- ユーザー編集JSPの作成 -->
                    <h3 class="section-title">6.3 ユーザー編集JSPの作成</h3>
                    <p>登録フォームを基に、既存データを表示する編集フォームを作成します。</p>

                    <div class="form-comparison">
                        <div class="form-example">
                            <h6>新規登録フォーム</h6>
                            <ul style="font-size: 12px;">
                                <li>空のフォーム</li>
                                <li>POST /user-register</li>
                                <li>「登録」ボタン</li>
                                <li>ID不要</li>
                            </ul>
                        </div>
                        <div class="form-example">
                            <h6>編集フォーム</h6>
                            <ul style="font-size: 12px;">
                                <li>現在値表示</li>
                                <li>POST /user-update</li>
                                <li>「更新」ボタン</li>
                                <li>隠しIDフィールド</li>
                            </ul>
                        </div>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 6-2: ユーザー編集JSPの作成</h5>
                        <p>既存ユーザー情報を表示し、編集可能なフォームを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>src/main/webapp/jsp</code> フォルダに新しいファイル <code>user-edit.jsp</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>user-edit.jsp</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;%@ page import="java.util.List" %&gt;
&lt;%@ page import="model.User" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ユーザー編集 - Simple User Management System&lt;/title&gt;
    &lt;style&gt;
        body {
            font-family: 'Meiryo', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], input[type="email"], input[type="hidden"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }
        input:focus {
            border-color: #ffc107;
            outline: none;
            box-shadow: 0 0 5px rgba(255,193,7,0.3);
        }
        .btn {
            background-color: #ffc107;
            color: #212529;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #e0a800;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        .field-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
        .required {
            color: #dc3545;
        }
        .form-info {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        .user-info {
            background-color: #e2e3e5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #d6d8db;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;h1&gt;ユーザー情報編集&lt;/h1&gt;
        
        &lt;%
            // エラーメッセージの表示
            String errorMessage = (String) request.getAttribute("errorMessage");
            if (errorMessage != null && !errorMessage.isEmpty()) {
        %&gt;
        &lt;div class="error-message"&gt;
            &lt;strong&gt;エラー:&lt;/strong&gt; &lt;%= errorMessage %&gt;
        &lt;/div&gt;
        &lt;%
            }
            
            // 成功メッセージの表示
            String successMessage = (String) request.getAttribute("successMessage");
            if (successMessage != null && !successMessage.isEmpty()) {
        %&gt;
        &lt;div class="success-message"&gt;
            &lt;strong&gt;成功:&lt;/strong&gt; &lt;%= successMessage %&gt;
        &lt;/div&gt;
        &lt;%
            }
            
            // ユーザー情報とモードの取得
            User user = (User) request.getAttribute("user");
            String mode = (String) request.getAttribute("mode");
            
            // フィールドエラーリストの取得
            @SuppressWarnings("unchecked")
            List&lt;String&gt; fieldErrors = (List&lt;String&gt;) request.getAttribute("fieldErrors");
            
            // 入力値の復元（エラー時に入力内容を保持）
            String username = (String) request.getAttribute("username");
            String email = (String) request.getAttribute("email");
            String fullName = (String) request.getAttribute("fullName");
            
            if (user != null && "edit".equals(mode)) {
                // 編集モードの場合は、エラー時の値がなければDBからの値を使用
                if (username == null) username = user.getUsername();
                if (email == null) email = user.getEmail();
                if (fullName == null) fullName = user.getFullName();
        %&gt;
        
        &lt;div class="user-info"&gt;
            &lt;h4&gt;編集対象ユーザー情報&lt;/h4&gt;
            &lt;p&gt;&lt;strong&gt;ユーザーID:&lt;/strong&gt; &lt;%= user.getId() %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;登録日時:&lt;/strong&gt; 
                &lt;%
                    if (user.getCreatedAt() != null) {
                        java.text.SimpleDateFormat sdf = new java.text.SimpleDateFormat("yyyy/MM/dd HH:mm");
                %&gt;
                    &lt;%= sdf.format(user.getCreatedAt()) %&gt;
                &lt;%
                    } else {
                %&gt;
                    （不明）
                &lt;%
                    }
                %&gt;
            &lt;/p&gt;
        &lt;/div&gt;
        
        &lt;div class="form-info"&gt;
            &lt;h4&gt;編集フォームの使い方&lt;/h4&gt;
            &lt;ul&gt;
                &lt;li&gt;現在の値が入力欄に表示されています&lt;/li&gt;
                &lt;li&gt;変更したい項目のみ修正してください&lt;/li&gt;
                &lt;li&gt;ユーザー名とメールアドレスは他のユーザーと重複できません&lt;/li&gt;
                &lt;li&gt;すべての項目は必須入力です&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
        
        &lt;form action="../user-update" method="post"&gt;
            &lt;!-- 隠しフィールドでユーザーIDを送信 --&gt;
            &lt;input type="hidden" name="id" value="&lt;%= user.getId() %&gt;"&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label for="username"&gt;ユーザー名 &lt;span class="required"&gt;*&lt;/span&gt;&lt;/label&gt;
                &lt;input type="text" id="username" name="username" value="&lt;%= username != null ? username : "" %&gt;" 
                       placeholder="例: tanaka_taro" maxlength="50" required&gt;
                &lt;%
                    if (fieldErrors != null) {
                        for (String error : fieldErrors) {
                            if (error.contains("ユーザー名")) {
                %&gt;
                &lt;div class="field-error"&gt;&lt;%= error %&gt;&lt;/div&gt;
                &lt;%
                            }
                        }
                    }
                %&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label for="email"&gt;メールアドレス &lt;span class="required"&gt;*&lt;/span&gt;&lt;/label&gt;
                &lt;input type="email" id="email" name="email" value="&lt;%= email != null ? email : "" %&gt;" 
                       placeholder="例: tanaka@example.com" maxlength="100" required&gt;
                &lt;%
                    if (fieldErrors != null) {
                        for (String error : fieldErrors) {
                            if (error.contains("メール")) {
                %&gt;
                &lt;div class="field-error"&gt;&lt;%= error %&gt;&lt;/div&gt;
                &lt;%
                            }
                        }
                    }
                %&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label for="fullName"&gt;氏名 &lt;span class="required"&gt;*&lt;/span&gt;&lt;/label&gt;
                &lt;input type="text" id="fullName" name="fullName" value="&lt;%= fullName != null ? fullName : "" %&gt;" 
                       placeholder="例: 田中太郎" maxlength="100" required&gt;
                &lt;%
                    if (fieldErrors != null) {
                        for (String error : fieldErrors) {
                            if (error.contains("氏名")) {
                %&gt;
                &lt;div class="field-error"&gt;&lt;%= error %&gt;&lt;/div&gt;
                &lt;%
                            }
                        }
                    }
                %&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;button type="submit" class="btn"&gt;ユーザー情報を更新&lt;/button&gt;
                &lt;button type="reset" class="btn btn-secondary"&gt;リセット&lt;/button&gt;
                &lt;a href="../user-detail?id=&lt;%= user.getId() %&gt;" class="btn btn-secondary"&gt;キャンセル&lt;/a&gt;
            &lt;/div&gt;
        &lt;/form&gt;
        
        &lt;hr&gt;
        &lt;div style="text-align: center;"&gt;
            &lt;a href="../user-delete?id=&lt;%= user.getId() %&gt;" class="btn btn-danger" 
               onclick="return confirm('ユーザー「&lt;%= user.getFullName() != null ? user.getFullName() : user.getUsername() %&gt;」を削除しますか？\\n\\n削除したデータは復元できません。')"&gt;
               このユーザーを削除&lt;/a&gt;
        &lt;/div&gt;
        
        &lt;%
            } else {
        %&gt;
        &lt;div class="form-info"&gt;
            &lt;h3&gt;編集対象のユーザーが見つかりません&lt;/h3&gt;
            &lt;p&gt;指定されたユーザーIDのユーザーが存在しないか、削除された可能性があります。&lt;/p&gt;
        &lt;/div&gt;
        &lt;%
            }
        %&gt;
        
        &lt;hr&gt;
        &lt;p&gt;
            &lt;a href="../user-list"&gt;ユーザー一覧へ&lt;/a&gt; | 
            &lt;a href="../user-form"&gt;新規ユーザー登録&lt;/a&gt; | 
            &lt;a href="../index.jsp"&gt;トップページ&lt;/a&gt;
        &lt;/p&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <!-- ユーザー更新処理Servletの作成 -->
                    <h3 class="section-title">6.4 ユーザー更新処理Servletの作成</h3>
                    <p>編集フォームから送信されたデータを受信し、データベースを更新するServletを作成します。</p>

                    <div class="transaction-info">
                        <h5>トランザクション処理の重要性</h5>
                        <ul>
                            <li><strong>原子性</strong>: 更新処理は全て成功するか、全て失敗するか</li>
                            <li><strong>一貫性</strong>: データベースの整合性を保つ</li>
                            <li><strong>分離性</strong>: 他の処理からの影響を受けない</li>
                            <li><strong>永続性</strong>: 正常完了した変更は永続化される</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 6-3: ユーザー更新処理Servletの作成</h5>
                        <p>編集フォームのデータを受信し、バリデーション後にデータベースを更新するServletを実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>controller</code> パッケージに新しいクラス <code>UserUpdateServlet</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>UserUpdateServlet.java</h6>
                        <pre class="code-block"><code class="language-java">package controller;

import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Pattern;

import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.User;
import model.UserDAO;

/**
 * ユーザー更新処理Servlet
 * POST: フォームデータの受信と更新処理
 * Controller層（MVCパターン）
 */
@WebServlet("/user-update")
public class UserUpdateServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    
    private UserDAO userDAO = new UserDAO();
    
    // 正規表現パターン
    private static final Pattern USERNAME_PATTERN = Pattern.compile("^[a-zA-Z0-9_]{3,50}$");
    private static final Pattern EMAIL_PATTERN = Pattern.compile("^[\\w\\.-]+@[\\w\\.-]+\\.[a-zA-Z]{2,}$");

    /**
     * POSTリクエスト: ユーザー更新処理
     */
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // リクエストパラメータの取得
        String idParam = request.getParameter("id");
        String username = request.getParameter("username");
        String email = request.getParameter("email");
        String fullName = request.getParameter("fullName");
        
        // 入力値の前後空白除去
        if (username != null) username = username.trim();
        if (email != null) email = email.trim();
        if (fullName != null) fullName = fullName.trim();
        
        // IDパラメータの検証
        if (idParam == null || idParam.trim().isEmpty()) {
            request.setAttribute("errorMessage", "ユーザーIDが指定されていません。");
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        int userId;
        try {
            userId = Integer.parseInt(idParam);
        } catch (NumberFormatException e) {
            request.setAttribute("errorMessage", "無効なユーザーIDです: " + idParam);
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        // 入力値をリクエストに設定（エラー時の値復元用）
        request.setAttribute("username", username);
        request.setAttribute("email", email);
        request.setAttribute("fullName", fullName);
        
        try {
            // 更新対象のユーザーが存在するかチェック
            User existingUser = userDAO.findById(userId);
            if (existingUser == null) {
                request.setAttribute("errorMessage", "更新対象のユーザー（ID: " + userId + "）が見つかりません。");
                RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
                dispatcher.forward(request, response);
                return;
            }
            
            // ユーザー情報を設定（フォーム再表示用）
            request.setAttribute("user", existingUser);
            request.setAttribute("mode", "edit");
            
            // バリデーション実行
            List&lt;String&gt; errors = validateInput(username, email, fullName);
            
            // バリデーションエラーがある場合
            if (!errors.isEmpty()) {
                request.setAttribute("fieldErrors", errors);
                request.setAttribute("errorMessage", "入力内容にエラーがあります。確認してください。");
                
                RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
                dispatcher.forward(request, response);
                return;
            }
            
            // 重複チェック（自分以外での重複）
            User userByUsername = userDAO.findByUsername(username);
            if (userByUsername != null && userByUsername.getId() != userId) {
                errors.add("ユーザー名 '" + username + "' は既に他のユーザーによって使用されています。");
            }
            
            // メールアドレスの重複チェック（簡易版）
            List&lt;User&gt; allUsers = userDAO.findAll();
            for (User user : allUsers) {
                if (email.equals(user.getEmail()) && user.getId() != userId) {
                    errors.add("メールアドレス '" + email + "' は既に他のユーザーによって使用されています。");
                    break;
                }
            }
            
            // 重複エラーがある場合
            if (!errors.isEmpty()) {
                request.setAttribute("fieldErrors", errors);
                request.setAttribute("errorMessage", "入力されたユーザー名またはメールアドレスは既に使用されています。");
                
                RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
                dispatcher.forward(request, response);
                return;
            }
            
            // ユーザーオブジェクトの更新と保存
            existingUser.setUsername(username);
            existingUser.setEmail(email);
            existingUser.setFullName(fullName);
            
            boolean success = userDAO.update(existingUser);
            
            if (success) {
                // 更新成功 - 詳細ページにリダイレクト
                response.sendRedirect("user-detail?id=" + userId + "&message=ユーザー情報を更新しました。");
            } else {
                // 更新失敗
                request.setAttribute("errorMessage", "ユーザー情報の更新に失敗しました。再度お試しください。");
                RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
                dispatcher.forward(request, response);
            }
            
        } catch (SQLException e) {
            // データベースエラー
            try {
                // エラー時でもユーザー情報を再取得してフォーム表示
                User user = userDAO.findById(userId);
                request.setAttribute("user", user);
                request.setAttribute("mode", "edit");
            } catch (SQLException ex) {
                // 再取得も失敗した場合は何もしない
            }
            
            request.setAttribute("errorMessage", "データベースエラーが発生しました: " + e.getMessage());
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-edit.jsp");
            dispatcher.forward(request, response);
        }
    }
    
    /**
     * 入力値の検証
     * @param username ユーザー名
     * @param email メールアドレス
     * @param fullName 氏名
     * @return List&lt;String&gt; エラーメッセージリスト
     */
    private List&lt;String&gt; validateInput(String username, String email, String fullName) {
        List&lt;String&gt; errors = new ArrayList&lt;&gt;();
        
        // ユーザー名の検証
        if (username == null || username.isEmpty()) {
            errors.add("ユーザー名は必須です。");
        } else if (username.length() &lt; 3) {
            errors.add("ユーザー名は3文字以上で入力してください。");
        } else if (username.length() &gt; 50) {
            errors.add("ユーザー名は50文字以内で入力してください。");
        } else if (!USERNAME_PATTERN.matcher(username).matches()) {
            errors.add("ユーザー名は半角英数字とアンダースコアのみ使用できます。");
        }
        
        // メールアドレスの検証
        if (email == null || email.isEmpty()) {
            errors.add("メールアドレスは必須です。");
        } else if (email.length() &gt; 100) {
            errors.add("メールアドレスは100文字以内で入力してください。");
        } else if (!EMAIL_PATTERN.matcher(email).matches()) {
            errors.add("メールアドレスの形式が正しくありません。");
        }
        
        // 氏名の検証
        if (fullName == null || fullName.isEmpty()) {
            errors.add("氏名は必須です。");
        } else if (fullName.length() &gt; 100) {
            errors.add("氏名は100文字以内で入力してください。");
        }
        
        return errors;
    }
}</code></pre>
                    </div>

                    <!-- ユーザー削除Servletの作成 -->
                    <h3 class="section-title">6.5 ユーザー削除Servletの作成</h3>
                    <p>削除確認と実際の削除処理を行うServletを作成します。</p>

                    <div class="danger-zone">
                        <h5>削除処理での注意点</h5>
                        <ul>
                            <li><strong>確認画面必須</strong>: 誤削除を防ぐため確認画面を必ず表示</li>
                            <li><strong>物理削除</strong>: このチュートリアルでは実際にデータを削除（本番では論理削除推奨）</li>
                            <li><strong>参照整合性</strong>: 他テーブルから参照されていないかチェック</li>
                            <li><strong>ロールバック</strong>: エラー時は削除をキャンセル</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 6-4: ユーザー削除Servletの作成</h5>
                        <p>GET（確認画面表示）とPOST（削除実行）の両方を処理するServletを実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>controller</code> パッケージに新しいクラス <code>UserDeleteServlet</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>UserDeleteServlet.java</h6>
                        <pre class="code-block"><code class="language-java">package controller;

import java.io.IOException;
import java.sql.SQLException;

import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.User;
import model.UserDAO;

/**
 * ユーザー削除処理Servlet
 * GET: 削除確認画面表示
 * POST: 削除実行
 * Controller層（MVCパターン）
 */
@WebServlet("/user-delete")
public class UserDeleteServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    
    private UserDAO userDAO = new UserDAO();

    /**
     * GETリクエスト: 削除確認画面の表示
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // IDパラメータの取得
        String idParam = request.getParameter("id");
        
        // IDパラメータの検証
        if (idParam == null || idParam.trim().isEmpty()) {
            request.setAttribute("errorMessage", "ユーザーIDが指定されていません。");
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-delete.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        int userId;
        try {
            userId = Integer.parseInt(idParam);
        } catch (NumberFormatException e) {
            request.setAttribute("errorMessage", "無効なユーザーIDです: " + idParam);
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-delete.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        try {
            // 指定されたIDのユーザーを取得
            User user = userDAO.findById(userId);
            
            if (user != null) {
                // ユーザーが見つかった場合、削除確認画面に情報を設定
                request.setAttribute("user", user);
                request.setAttribute("mode", "confirm"); // 確認モードを示すフラグ
            } else {
                // ユーザーが見つからなかった場合
                request.setAttribute("errorMessage", "ID " + userId + " のユーザーが見つかりません。");
            }
            
            // 削除確認画面用JSPにフォワード
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-delete.jsp");
            dispatcher.forward(request, response);
            
        } catch (SQLException e) {
            // データベースエラーの場合
            request.setAttribute("errorMessage", "データベースエラーが発生しました: " + e.getMessage());
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-delete.jsp");
            dispatcher.forward(request, response);
        }
    }

    /**
     * POSTリクエスト: ユーザー削除実行
     */
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // IDパラメータの取得
        String idParam = request.getParameter("id");
        
        // IDパラメータの検証
        if (idParam == null || idParam.trim().isEmpty()) {
            request.setAttribute("errorMessage", "ユーザーIDが指定されていません。");
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-delete.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        int userId;
        try {
            userId = Integer.parseInt(idParam);
        } catch (NumberFormatException e) {
            request.setAttribute("errorMessage", "無効なユーザーIDです: " + idParam);
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-delete.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        try {
            // 削除前に対象ユーザーの情報を取得（削除完了メッセージ用）
            User userToDelete = userDAO.findById(userId);
            
            if (userToDelete == null) {
                request.setAttribute("errorMessage", "削除対象のユーザー（ID: " + userId + "）が見つかりません。");
                RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-delete.jsp");
                dispatcher.forward(request, response);
                return;
            }
            
            // ユーザー削除実行
            boolean success = userDAO.delete(userId);
            
            if (success) {
                // 削除成功 - ユーザー一覧ページにリダイレクト
                String deletedUserName = userToDelete.getFullName() != null ? 
                    userToDelete.getFullName() : userToDelete.getUsername();
                response.sendRedirect("user-list?message=ユーザー「" + deletedUserName + "」を削除しました。");
            } else {
                // 削除失敗
                request.setAttribute("errorMessage", "ユーザーの削除に失敗しました。再度お試しください。");
                request.setAttribute("user", userToDelete);
                request.setAttribute("mode", "confirm");
                
                RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-delete.jsp");
                dispatcher.forward(request, response);
            }
            
        } catch (SQLException e) {
            // データベースエラー
            request.setAttribute("errorMessage", "データベースエラーが発生しました: " + e.getMessage());
            
            // エラー時でもユーザー情報を再取得して表示
            try {
                User user = userDAO.findById(userId);
                request.setAttribute("user", user);
                request.setAttribute("mode", "confirm");
            } catch (SQLException ex) {
                // 再取得も失敗した場合は何もしない
            }
            
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-delete.jsp");
            dispatcher.forward(request, response);
        }
    }
}</code></pre>
                    </div>

                    <!-- ユーザー削除確認JSPの作成 -->
                    <div class="exercise-container">
                        <h5>実習 6-5: ユーザー削除確認JSPの作成</h5>
                        <p>削除対象のユーザー情報を表示し、削除確認を行うJSPを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>src/main/webapp/jsp</code> フォルダに新しいファイル <code>user-delete.jsp</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>user-delete.jsp</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;%@ page import="model.User" %&gt;
&lt;%@ page import="java.text.SimpleDateFormat" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ユーザー削除確認 - Simple User Management System&lt;/title&gt;
    &lt;style&gt;
        body {
            font-family: 'Meiryo', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 700px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        .danger-header {
            background-color: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin: -30px -30px 20px -30px;
            text-align: center;
        }
        .user-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            border: 2px solid #dc3545;
            margin: 20px 0;
        }
        .info-group {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .info-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .info-label {
            font-weight: bold;
            color: #495057;
            display: inline-block;
            width: 120px;
        }
        .info-value {
            color: #212529;
        }
        .warning-message {
            background-color: #fff3cd;
            color: #856404;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
            text-align: center;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px 10px 0;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
            color: white;
            text-decoration: none;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
            color: white;
            text-decoration: none;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .action-buttons {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #dc3545;
        }
        .confirm-form {
            display: inline;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;div class="danger-header"&gt;
            &lt;h1&gt;⚠️ ユーザー削除確認&lt;/h1&gt;
            &lt;p&gt;以下のユーザーを完全に削除します&lt;/p&gt;
        &lt;/div&gt;
        
        &lt;%
            // エラーメッセージの表示
            String errorMessage = (String) request.getAttribute("errorMessage");
            if (errorMessage != null && !errorMessage.isEmpty()) {
        %&gt;
        &lt;div class="error-message"&gt;
            &lt;strong&gt;エラー:&lt;/strong&gt; &lt;%= errorMessage %&gt;
        &lt;/div&gt;
        &lt;%
            }
            
            // ユーザー情報とモードの取得
            User user = (User) request.getAttribute("user");
            String mode = (String) request.getAttribute("mode");
            
            if (user != null && "confirm".equals(mode)) {
        %&gt;
        
        &lt;div class="warning-message"&gt;
            &lt;h3&gt;🚨 重要な警告 🚨&lt;/h3&gt;
            &lt;p&gt;&lt;strong&gt;この操作は取り消すことができません！&lt;/strong&gt;&lt;/p&gt;
            &lt;p&gt;削除されたユーザーデータは完全に失われ、復元することはできません。&lt;/p&gt;
            &lt;p&gt;本当に削除してもよろしいですか？&lt;/p&gt;
        &lt;/div&gt;
        
        &lt;div class="user-info"&gt;
            &lt;h4&gt;削除対象ユーザー情報&lt;/h4&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;ユーザーID:&lt;/span&gt;
                &lt;span class="info-value"&gt;&lt;%= user.getId() %&gt;&lt;/span&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;ユーザー名:&lt;/span&gt;
                &lt;span class="info-value"&gt;&lt;%= user.getUsername() %&gt;&lt;/span&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;メールアドレス:&lt;/span&gt;
                &lt;span class="info-value"&gt;&lt;%= user.getEmail() %&gt;&lt;/span&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;氏名:&lt;/span&gt;
                &lt;span class="info-value"&gt;
                    &lt;%
                        String fullName = user.getFullName();
                        if (fullName != null && !fullName.trim().isEmpty()) {
                    %&gt;
                        &lt;%= fullName %&gt;
                    &lt;%
                        } else {
                    %&gt;
                        &lt;span style="color: #6c757d; font-style: italic;"&gt;（未設定）&lt;/span&gt;
                    &lt;%
                        }
                    %&gt;
                &lt;/span&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;登録日時:&lt;/span&gt;
                &lt;span class="info-value"&gt;
                    &lt;%
                        if (user.getCreatedAt() != null) {
                            SimpleDateFormat sdf = new SimpleDateFormat("yyyy年MM月dd日 HH時mm分");
                    %&gt;
                        &lt;%= sdf.format(user.getCreatedAt()) %&gt;
                    &lt;%
                        } else {
                    %&gt;
                        &lt;span style="color: #6c757d; font-style: italic;"&gt;（不明）&lt;/span&gt;
                    &lt;%
                        }
                    %&gt;
                &lt;/span&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;最終更新:&lt;/span&gt;
                &lt;span class="info-value"&gt;
                    &lt;%
                        if (user.getUpdatedAt() != null) {
                            SimpleDateFormat sdf = new SimpleDateFormat("yyyy年MM月dd日 HH時mm分");
                    %&gt;
                        &lt;%= sdf.format(user.getUpdatedAt()) %&gt;
                    &lt;%
                        } else {
                    %&gt;
                        &lt;span style="color: #6c757d; font-style: italic;"&gt;（不明）&lt;/span&gt;
                    &lt;%
                        }
                    %&gt;
                &lt;/span&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div class="action-buttons"&gt;
            &lt;form method="post" action="../user-delete" class="confirm-form"&gt;
                &lt;input type="hidden" name="id" value="&lt;%= user.getId() %&gt;"&gt;
                &lt;button type="submit" class="btn btn-danger" 
                        onclick="return confirm('最終確認\\n\\nユーザー「&lt;%= user.getFullName() != null ? user.getFullName() : user.getUsername() %&gt;」を本当に削除しますか？\\n\\nこの操作は取り消すことができません。')"&gt;
                    🗑️ 削除を実行する
                &lt;/button&gt;
            &lt;/form&gt;
            &lt;a href="../user-detail?id=&lt;%= user.getId() %&gt;" class="btn btn-secondary"&gt;❌ キャンセル&lt;/a&gt;
        &lt;/div&gt;
        
        &lt;%
            } else {
        %&gt;
        &lt;div class="no-data"&gt;
            &lt;h3&gt;削除対象のユーザーが見つかりません&lt;/h3&gt;
            &lt;p&gt;指定されたユーザーIDのユーザーが存在しないか、既に削除された可能性があります。&lt;/p&gt;
            &lt;a href="../user-list" class="btn btn-secondary"&gt;ユーザー一覧に戻る&lt;/a&gt;
        &lt;/div&gt;
        &lt;%
            }
        %&gt;
        
        &lt;hr&gt;
        &lt;p&gt;
            &lt;a href="../user-list"&gt;ユーザー一覧へ&lt;/a&gt; | 
            &lt;a href="../user-form"&gt;新規ユーザー登録&lt;/a&gt; | 
            &lt;a href="../index.jsp"&gt;トップページ&lt;/a&gt;
        &lt;/p&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <!-- 動作確認 -->
                    <h3 class="section-title">6.6 更新・削除機能の動作確認</h3>
                    <p>作成したユーザー更新・削除機能が正常に動作することを確認します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-6: 更新・削除機能の動作確認</h5>
                        <p>様々なケースで更新・削除機能をテストし、正常に動作することを確認します。</p>
                        
                        <h6>動作確認手順</h6>
                        <ol>
                            <li><strong>ユーザー編集の確認</strong>
                                <ul>
                                    <li>ユーザー一覧から任意のユーザーの「編集」ボタンをクリック</li>
                                    <li>編集フォームに現在の値が表示されることを確認</li>
                                    <li>氏名を変更して「ユーザー情報を更新」をクリック</li>
                                    <li>詳細画面にリダイレクトされ、更新成功メッセージが表示されることを確認</li>
                                    <li>変更内容が正しく反映されていることを確認</li>
                                </ul>
                            </li>
                            
                            <li><strong>更新時のバリデーション確認</strong>
                                <ul>
                                    <li>編集フォームで全ての項目を空にして更新を試行</li>
                                    <li>適切なエラーメッセージが表示されることを確認</li>
                                    <li>既存の他ユーザーと同じユーザー名に変更を試行</li>
                                    <li>重複エラーが表示されることを確認</li>
                                </ul>
                            </li>
                            
                            <li><strong>削除確認画面の確認</strong>
                                <ul>
                                    <li>一覧またはユーザー詳細から「削除」ボタンをクリック</li>
                                    <li>削除確認画面が表示されることを確認</li>
                                    <li>削除対象ユーザーの情報が正しく表示されることを確認</li>
                                    <li>警告メッセージが適切に表示されることを確認</li>
                                </ul>
                            </li>
                            
                            <li><strong>削除実行の確認</strong>
                                <ul>
                                    <li>削除確認画面から「削除を実行する」ボタンをクリック</li>
                                    <li>最終確認ダイアログが表示されることを確認</li>
                                    <li>「OK」をクリックして削除を実行</li>
                                    <li>ユーザー一覧にリダイレクトされ、削除成功メッセージが表示されることを確認</li>
                                    <li>削除されたユーザーが一覧から消えていることを確認</li>
                                </ul>
                            </li>
                            
                            <li><strong>エラーケースの確認</strong>
                                <ul>
                                    <li>存在しないIDで編集・削除を試行</li>
                                    <li>適切なエラーメッセージが表示されることを確認</li>
                                    <li>無効なIDパラメータでアクセス</li>
                                    <li>パラメータエラーが適切に処理されることを確認</li>
                                </ul>
                            </li>
                        </ol>

                        <h6>期待される結果</h6>
                        <ul>
                            <li>編集フォームに現在の値が正しく表示される</li>
                            <li>更新処理が正常に動作し、変更が反映される</li>
                            <li>削除確認画面で十分な警告が表示される</li>
                            <li>削除処理が正常に動作し、データが削除される</li>
                            <li>エラー時に適切なメッセージが表示される</li>
                            <li>バリデーション・重複チェックが正常に動作する</li>
                        </ul>
                    </div>

                    <!-- セキュリティとベストプラクティス -->
                    <div class="security-note">
                        <h5>セキュリティとベストプラクティス</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>実装済みのセキュリティ対策</h6>
                                <ul>
                                    <li>IDパラメータの検証</li>
                                    <li>入力値のバリデーション</li>
                                    <li>重複チェック</li>
                                    <li>エラー時の適切な処理</li>
                                    <li>削除確認画面の実装</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>本番環境で追加すべき対策</h6>
                                <ul>
                                    <li>認証・認可チェック</li>
                                    <li>CSRF対策</li>
                                    <li>論理削除の実装</li>
                                    <li>楽観的排他制御</li>
                                    <li>操作ログの記録</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>編集フォームで既存のデータを表示するために必要な処理を説明してください。</strong></li>
                            <li><strong>更新処理で他のユーザーとの重複チェックを行う際の注意点は何ですか？</strong></li>
                            <li><strong>削除処理でGETとPOSTを分けている理由を説明してください。</strong></li>
                            <li><strong>以下のHTMLコードの役割を説明してください:</strong>
                                <pre><code>&lt;input type="hidden" name="id" value="&lt;%= user.getId() %&gt;"&gt;</code></pre>
                            </li>
                            <li><strong>物理削除と論理削除の違いとそれぞれのメリット・デメリットを説明してください。</strong></li>
                            <li><strong>トランザクション処理のACID特性について説明してください。</strong></li>
                        </ol>
                        
                        <details style="margin-top: 20px;">
                            <summary>解答例を表示</summary>
                            <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                <ol>
                                    <li>①IDでユーザーを検索 ②取得したユーザー情報をリクエストスコープに設定 ③JSPで各フィールドのvalue属性に現在値を設定</li>
                                    <li>更新対象の自分自身は除外して重複チェックを行う必要がある（user.getId() != userId の条件）</li>
                                    <li>GET（確認画面表示）は冪等性があり、POST（削除実行）は副作用があるため、HTTPメソッドの意味に従って分離</li>
                                    <li>更新対象のユーザーIDを隠しフィールドで送信するためのHTML要素（画面には表示されない）</li>
                                    <li>物理削除：実際にデータを削除（完全削除、容量節約）／論理削除：削除フラグ設定（復元可能、履歴保持）</li>
                                    <li>A（原子性）：全て成功か全て失敗 ／ C（一貫性）：整合性保持 ／ I（分離性）：他処理から独立 ／ D（永続性）：変更の永続化</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">6.7 まとめ</h3>
                    <p>このステップでは、ユーザー更新・削除機能の実装を通じてCRUDのU（Update）とD（Delete）操作を学習しました：</p>
                    <ul>
                        <li><strong>編集フォーム</strong>: 既存データの表示、隠しフィールドでのID送信</li>
                        <li><strong>更新処理</strong>: バリデーション、重複チェック（自分除外）、データ更新</li>
                        <li><strong>削除確認</strong>: 安全な削除のための確認画面実装</li>
                        <li><strong>削除処理</strong>: GET（確認）とPOST（実行）の適切な分離</li>
                        <li><strong>エラー処理</strong>: 存在チェック、パラメータ検証、例外処理</li>
                        <li><strong>ユーザビリティ</strong>: 確認ダイアログ、成功メッセージ、適切な画面遷移</li>
                    </ul>
                    
                    <p>次のステップでは、検索機能を追加し、共通レイアウトの作成やエラーページの実装を行って、アプリケーション全体を仕上げます。</p>

                    <!-- ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step5-user-list-detail.html" class="btn btn-secondary">← 前の章: ユーザー一覧・詳細表示機能</a>
                        <a href="step7-search-finalization.html" class="btn btn-primary">次の章: 検索機能とアプリケーション仕上げ →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>