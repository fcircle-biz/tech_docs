<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next.jsチュートリアル ステップ4 - ユーザーモデル設計とCRUD基盤構築</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
            padding-top: 56px;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #f8f9fa;
            overflow-y: auto;
        }

        .sidebar-heading {
            font-size: .75rem;
            text-transform: uppercase;
        }

        .sidebar .nav-link {
            font-weight: 500;
            color: #333;
            padding: 0.5rem 1rem;
            margin: 0.2rem 0;
            border-radius: 0.25rem;
        }

        .sidebar .nav-link:hover {
            color: #667eea;
            background-color: rgba(102, 126, 234, 0.1);
        }

        .sidebar .nav-link.active {
            color: #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        main {
            margin-top: 20px;
        }

        .chapter-title {
            color: #667eea;
            font-weight: bold;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }

        .section-title {
            color: #764ba2;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .highlight {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 5px solid #667eea;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0.5rem;
        }

        .code-block {
            background-color: #282c34;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .code-block code {
            color: #abb2bf;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
        }

        .exercise-container {
            background-color: #fff;
            border: 2px solid #667eea;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .quiz-container {
            background-color: #f0f4ff;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        footer {
            margin-top: 3rem;
            padding: 2rem 0;
            background-color: #343a40;
            color: white;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>Next.js実践チュートリアル</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>チュートリアルステップ</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                ステップ1: 開発環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-setup.html">
                                ステップ2: DB環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-components-architecture.html">
                                ステップ3: コンポーネント設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step4-user-model-crud.html">
                                ステップ4: ユーザーモデルとCRUD
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-registration.html">
                                ステップ5: ユーザー登録機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-list-detail.html">
                                ステップ6: 一覧・詳細表示
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-user-update-delete.html">
                                ステップ7: 編集・削除機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step8-authentication-security.html">
                                ステップ8: 認証とセキュリティ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step9-ui-ux-improvement.html">
                                ステップ9: UI/UX向上
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step10-testing-deployment.html">
                                ステップ10: テストとデプロイ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">ステップ4: ユーザーモデル設計とCRUD基盤構築</h1>
                </div>

                <div id="step4">
                    <h2 class="chapter-title">Server ActionsとデータアクセスLayer</h2>

                    <div class="highlight">
                        <h5>このステップで実装すること</h5>
                        <ul>
                            <li>Prismaスキーマの拡張とバリデーション設計</li>
                            <li>Server Actionsの基本実装とエラーハンドリング</li>
                            <li>Zodを使用した型安全なバリデーション</li>
                            <li>データアクセス層の構築とリポジトリパターン</li>
                            <li>revalidatePathによるキャッシュ管理</li>
                            <li>シードデータの投入と初期データ準備</li>
                        </ul>
                    </div>

                    <div class="alert alert-info">
                        <h6>前提条件</h6>
                        <ul>
                            <li>ステップ3が完了し、コンポーネント設計が理解できていること</li>
                            <li>TypeScriptの型定義の基本を理解していること</li>
                            <li>async/awaitとエラーハンドリングの基本を理解していること</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.1 Zodによるバリデーションスキーマの定義</h3>
                    <p>型安全なバリデーションを実現するために、Zodライブラリを導入します。</p>

                    <div class="exercise-container">
                        <h5>実装 4-1: Zodのインストールとスキーマ定義</h5>
                        <p>Zodをインストールし、ユーザーデータのバリデーションスキーマを作成します。</p>

                        <h6>手順</h6>
                        <ol>
                            <li><strong>Zodのインストール</strong>: ライブラリを追加
                                <pre class="code-block"><code class="language-bash">pnpm add zod</code></pre>
                            </li>
                            <li><strong>バリデーションスキーマの作成</strong>: lib/validations/user.tsを作成
                                <pre class="code-block"><code class="language-typescript">// lib/validations/user.ts
import { z } from 'zod'

export const userSchema = z.object({
  username: z
    .string()
    .min(3, 'ユーザー名は3文字以上である必要があります')
    .max(20, 'ユーザー名は20文字以内である必要があります')
    .regex(/^[a-zA-Z0-9_]+$/, 'ユーザー名は英数字とアンダースコアのみ使用できます'),
  email: z
    .string()
    .email('有効なメールアドレスを入力してください'),
  fullName: z
    .string()
    .min(1, '氏名を入力してください')
    .max(50, '氏名は50文字以内である必要があります'),
  bio: z
    .string()
    .max(200, '自己紹介は200文字以内である必要があります')
    .optional(),
})

export const userUpdateSchema = userSchema.partial()

export type UserInput = z.infer&lt;typeof userSchema&gt;
export type UserUpdateInput = z.infer&lt;typeof userUpdateSchema&gt;</code></pre>
                            </li>
                        </ol>

                        <h6>期待される結果</h6>
                        <div class="alert alert-success">
                            <p>✓ lib/validations/user.tsが作成される</p>
                            <p>✓ TypeScriptの型推論が正しく動作する</p>
                            <p>✓ バリデーションルールが定義される</p>
                        </div>

                        <h6>Zodのメリット</h6>
                        <ul>
                            <li><strong>型安全性</strong>: TypeScript型が自動的に推論される</li>
                            <li><strong>ランタイムバリデーション</strong>: 実行時にデータの妥当性を検証</li>
                            <li><strong>エラーメッセージ</strong>: わかりやすいエラーメッセージを提供</li>
                            <li><strong>再利用性</strong>: スキーマを複数の場所で再利用可能</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.2 Server Actionsの実装</h3>
                    <p>Next.js 14のServer Actionsを使用して、サーバーサイドのデータ操作を実装します。</p>

                    <div class="exercise-container">
                        <h5>実装 4-2: CRUD操作のServer Actions</h5>
                        <p>ユーザーデータの作成、読み取り、更新、削除を行うServer Actionsを作成します。</p>

                        <h6>手順</h6>
                        <ol>
                            <li><strong>Server Actionsファイルの作成</strong>: app/users/actions.tsを作成
                                <pre class="code-block"><code class="language-typescript">// app/users/actions.ts
'use server'

import { prisma } from '@/lib/prisma'
import { userSchema, type UserInput } from '@/lib/validations/user'
import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'

// ユーザー作成
export async function createUser(data: UserInput) {
  try {
    // バリデーション
    const validated = userSchema.parse(data)

    // データベースに保存
    const user = await prisma.user.create({
      data: validated,
    })

    // キャッシュを再検証
    revalidatePath('/users')

    return { success: true, user }
  } catch (error) {
    if (error instanceof Error) {
      return { success: false, error: error.message }
    }
    return { success: false, error: '予期しないエラーが発生しました' }
  }
}

// ユーザー更新
export async function updateUser(id: string, data: Partial&lt;UserInput&gt;) {
  try {
    const user = await prisma.user.update({
      where: { id },
      data,
    })

    revalidatePath('/users')
    revalidatePath(`/users/${id}`)

    return { success: true, user }
  } catch (error) {
    if (error instanceof Error) {
      return { success: false, error: error.message }
    }
    return { success: false, error: '更新に失敗しました' }
  }
}

// ユーザー削除
export async function deleteUser(id: string) {
  try {
    await prisma.user.delete({
      where: { id },
    })

    revalidatePath('/users')

    return { success: true }
  } catch (error) {
    if (error instanceof Error) {
      return { success: false, error: error.message }
    }
    return { success: false, error: '削除に失敗しました' }
  }
}

// ユーザー取得
export async function getUser(id: string) {
  try {
    const user = await prisma.user.findUnique({
      where: { id },
    })

    if (!user) {
      return { success: false, error: 'ユーザーが見つかりません' }
    }

    return { success: true, user }
  } catch (error) {
    return { success: false, error: 'ユーザーの取得に失敗しました' }
  }
}</code></pre>
                            </li>
                            <li><strong>型定義ファイルの作成</strong>: lib/types/user.tsを作成
                                <pre class="code-block"><code class="language-typescript">// lib/types/user.ts
import { User } from '@prisma/client'

export type { User }

export type UserWithoutDates = Omit&lt;User, 'createdAt' | 'updatedAt'&gt;

export type ActionResult&lt;T = void&gt; =
  | { success: true; data?: T }
  | { success: false; error: string }</code></pre>
                            </li>
                        </ol>

                        <h6>期待される結果</h6>
                        <div class="alert alert-success">
                            <p>✓ Server Actionsが正しく定義される</p>
                            <p>✓ エラーハンドリングが実装される</p>
                            <p>✓ TypeScriptの型チェックが通る</p>
                        </div>

                        <h6>Server Actionsのフロー</h6>
                        <div class="mermaid">
sequenceDiagram
    participant C as Client Component
    participant SA as Server Action
    participant V as Validation (Zod)
    participant P as Prisma
    participant DB as Database

    C->>SA: createUser(data)
    SA->>V: validate(data)
    V-->>SA: validated data
    SA->>P: prisma.user.create()
    P->>DB: INSERT INTO users
    DB-->>P: created user
    P-->>SA: user object
    SA->>SA: revalidatePath()
    SA-->>C: { success: true, user }
</div>
                    </div>

                    <h3 class="section-title">4.3 データアクセス層の構築</h3>
                    <p>リポジトリパターンを使用して、データアクセスロジックを分離します。</p>

                    <div class="exercise-container">
                        <h5>実装 4-3: ユーザーリポジトリの作成</h5>
                        <p>データベースアクセスを抽象化するリポジトリを実装します。</p>

                        <h6>手順</h6>
                        <ol>
                            <li><strong>リポジトリファイルの作成</strong>: lib/repositories/user-repository.tsを作成
                                <pre class="code-block"><code class="language-typescript">// lib/repositories/user-repository.ts
import { prisma } from '@/lib/prisma'
import type { User } from '@prisma/client'

export class UserRepository {
  // 全ユーザー取得
  async findAll(): Promise&lt;User[]&gt; {
    return prisma.user.findMany({
      orderBy: { createdAt: 'desc' },
    })
  }

  // ID検索
  async findById(id: string): Promise&lt;User | null&gt; {
    return prisma.user.findUnique({
      where: { id },
    })
  }

  // ユーザー名検索
  async findByUsername(username: string): Promise&lt;User | null&gt; {
    return prisma.user.findUnique({
      where: { username },
    })
  }

  // メールアドレス検索
  async findByEmail(email: string): Promise&lt;User | null&gt; {
    return prisma.user.findUnique({
      where: { email },
    })
  }

  // ページネーション付き取得
  async findManyWithPagination(page: number, limit: number) {
    const skip = (page - 1) * limit

    const [users, total] = await Promise.all([
      prisma.user.findMany({
        skip,
        take: limit,
        orderBy: { createdAt: 'desc' },
      }),
      prisma.user.count(),
    ])

    return {
      users,
      total,
      page,
      totalPages: Math.ceil(total / limit),
    }
  }

  // 検索
  async search(query: string): Promise&lt;User[]&gt; {
    return prisma.user.findMany({
      where: {
        OR: [
          { username: { contains: query, mode: 'insensitive' } },
          { fullName: { contains: query, mode: 'insensitive' } },
          { email: { contains: query, mode: 'insensitive' } },
        ],
      },
      orderBy: { createdAt: 'desc' },
    })
  }

  // 作成
  async create(data: Omit&lt;User, 'id' | 'createdAt' | 'updatedAt'&gt;): Promise&lt;User&gt; {
    return prisma.user.create({
      data,
    })
  }

  // 更新
  async update(id: string, data: Partial&lt;Omit&lt;User, 'id' | 'createdAt' | 'updatedAt'&gt;&gt;): Promise&lt;User&gt; {
    return prisma.user.update({
      where: { id },
      data,
    })
  }

  // 削除
  async delete(id: string): Promise&lt;User&gt; {
    return prisma.user.delete({
      where: { id },
    })
  }

  // ユーザー名の重複チェック
  async isUsernameTaken(username: string, excludeId?: string): Promise&lt;boolean&gt; {
    const user = await prisma.user.findUnique({
      where: { username },
      select: { id: true },
    })

    if (!user) return false
    if (excludeId && user.id === excludeId) return false

    return true
  }

  // メールアドレスの重複チェック
  async isEmailTaken(email: string, excludeId?: string): Promise&lt;boolean&gt; {
    const user = await prisma.user.findUnique({
      where: { email },
      select: { id: true },
    })

    if (!user) return false
    if (excludeId && user.id === excludeId) return false

    return true
  }
}

// シングルトンインスタンス
export const userRepository = new UserRepository()</code></pre>
                            </li>
                            <li><strong>Server Actionsの更新</strong>: リポジトリを使用するように変更
                                <pre class="code-block"><code class="language-typescript">// app/users/actions.ts（更新版）
'use server'

import { userRepository } from '@/lib/repositories/user-repository'
import { userSchema, type UserInput } from '@/lib/validations/user'
import { revalidatePath } from 'next/cache'

export async function createUser(data: UserInput) {
  try {
    const validated = userSchema.parse(data)

    // 重複チェック
    const usernameTaken = await userRepository.isUsernameTaken(validated.username)
    if (usernameTaken) {
      return { success: false, error: 'このユーザー名は既に使用されています' }
    }

    const emailTaken = await userRepository.isEmailTaken(validated.email)
    if (emailTaken) {
      return { success: false, error: 'このメールアドレスは既に使用されています' }
    }

    const user = await userRepository.create(validated)

    revalidatePath('/users')

    return { success: true, user }
  } catch (error) {
    if (error instanceof Error) {
      return { success: false, error: error.message }
    }
    return { success: false, error: '予期しないエラーが発生しました' }
  }
}</code></pre>
                            </li>
                        </ol>

                        <h6>期待される結果</h6>
                        <div class="alert alert-success">
                            <p>✓ リポジトリパターンが実装される</p>
                            <p>✓ データアクセスロジックが分離される</p>
                            <p>✓ 再利用可能なメソッドが提供される</p>
                        </div>
                    </div>

                    <h3 class="section-title">4.4 シードデータの投入</h3>
                    <p>開発・テスト用のサンプルデータを自動投入する仕組みを作成します。</p>

                    <div class="exercise-container">
                        <h5>実装 4-4: Prisma Seedの作成</h5>
                        <p>package.jsonとseedスクリプトを設定します。</p>

                        <h6>手順</h6>
                        <ol>
                            <li><strong>Seedファイルの作成</strong>: prisma/seed.tsを作成
                                <pre class="code-block"><code class="language-typescript">// prisma/seed.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  console.log('Seeding database...')

  // 既存のユーザーを削除
  await prisma.user.deleteMany()

  // サンプルユーザーを作成
  const users = await Promise.all([
    prisma.user.create({
      data: {
        username: 'johndoe',
        email: 'john@example.com',
        fullName: 'John Doe',
        bio: 'ソフトウェアエンジニア。Web開発が専門です。',
      },
    }),
    prisma.user.create({
      data: {
        username: 'janedoe',
        email: 'jane@example.com',
        fullName: 'Jane Doe',
        bio: 'UXデザイナー。ユーザー体験の向上に情熱を注いでいます。',
      },
    }),
    prisma.user.create({
      data: {
        username: 'bobsmith',
        email: 'bob@example.com',
        fullName: 'Bob Smith',
        bio: 'プロダクトマネージャー。アジャイル開発を推進しています。',
      },
    }),
  ])

  console.log(`Created ${users.length} users`)
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })</code></pre>
                            </li>
                            <li><strong>package.jsonの更新</strong>: prismaセクションを追加
                                <pre class="code-block"><code class="language-json">{
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  },
  "scripts": {
    "seed": "tsx prisma/seed.ts"
  }
}</code></pre>
                            </li>
                            <li><strong>tsxのインストール</strong>: TypeScriptランナーを追加
                                <pre class="code-block"><code class="language-bash">pnpm add -D tsx</code></pre>
                            </li>
                            <li><strong>Seedの実行</strong>: シードデータを投入
                                <pre class="code-block"><code class="language-bash">pnpm seed</code></pre>
                            </li>
                        </ol>

                        <h6>期待される結果</h6>
                        <div class="alert alert-success">
                            <p>✓ シードスクリプトが正常に実行される</p>
                            <p>✓ 3つのサンプルユーザーが作成される</p>
                            <p>✓ Prisma Studioで確認できる</p>
                        </div>
                    </div>

                    <div class="mermaid">
flowchart TB
    subgraph Application["アプリケーション層"]
        A[Server Actions]
        B[API Routes]
    end

    subgraph Business["ビジネスロジック層"]
        C[Validation<br/>Zod]
        D[Repository<br/>Pattern]
    end

    subgraph Data["データアクセス層"]
        E[Prisma Client]
        F[PostgreSQL]
    end

    A --> C
    B --> C
    C --> D
    D --> E
    E --> F
</div>

                    <div class="quiz-container">
                        <h5>ステップ完了チェック</h5>
                        <p>以下の項目が完了していることを確認してください：</p>
                        <ul class="list-unstyled">
                            <li>☐ Zodがインストールされ、バリデーションスキーマが定義されている</li>
                            <li>☐ Server Actionsが実装され、CRUD操作が可能</li>
                            <li>☐ リポジトリパターンが実装されている</li>
                            <li>☐ エラーハンドリングが適切に実装されている</li>
                            <li>☐ revalidatePathによるキャッシュ管理が実装されている</li>
                            <li>☐ シードデータが正常に投入される</li>
                            <li>☐ TypeScriptの型安全性が確保されている</li>
                        </ul>
                    </div>

                    <div class="alert alert-info">
                        <h6>次のステップの準備</h6>
                        <p>ステップ5では、このステップで構築したServer Actionsとバリデーションスキーマを使用して、実際のユーザー登録フォームを実装します。react-hook-formを使用したフォーム管理と、Zodとの統合を学びます。</p>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="step3-components-architecture.html" class="btn btn-secondary">← 前のステップ</a>
                        <a href="step5-user-registration.html" class="btn btn-primary">次のステップ →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>

    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>
