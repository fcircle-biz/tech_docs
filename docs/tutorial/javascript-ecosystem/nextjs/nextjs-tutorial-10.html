<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next.js実践チュートリアル ステップ10 - デプロイメントと本番環境への準備</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --nextjs-primary: #000000;
            --nextjs-accent: #F7DF1E;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
        }

        .sidebar {
            height: calc(100vh - 64px);
        }

        .sidebar .nav-link {
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover {
            background-color: #f3f4f6;
            border-left-color: var(--nextjs-accent);
        }

        .sidebar .nav-link.active {
            background-color: #fffbeb;
            color: var(--nextjs-primary);
            border-left-color: var(--nextjs-accent);
            font-weight: 600;
        }

        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .code-block code {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        pre code.hljs {
            background-color: #1e1e1e;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="fixed top-0 w-full bg-black shadow-md z-50"><div class="flex pt-16"><a class="text-yellow-400 font-bold text-xl"><i class="fas fa-react"></i> Next.js実践チュートリアル</a></div></aside>
        <nav class="hidden md:block w-64 bg-white border-r border-gray-200 fixed sidebar overflow-y-auto" style="padding: 1rem 0;">
            <div class="p-4">
                <h6 style="font-weight:700; padding:0 1.5rem; margin:1rem 0;">チュートリアルステップ</h6>
                <ul class="flex flex-col space-y-1">
                    <a class="nav-link block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-1.html">ステップ1: 環境構築</a>
                    <a class="nav-link block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-2.html">ステップ2: App Routerの基礎</a>
                    <a class="nav-link block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-3.html">ステップ3: DB設計とPrisma</a>
                    <a class="nav-link block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-4.html">ステップ4: ユーザー登録</a>
                    <a class="nav-link block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-5.html">ステップ5: 一覧・詳細表示</a>
                    <a class="nav-link block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-6.html">ステップ6: 更新・削除機能</a>
                    <a class="nav-link block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-7.html">ステップ7: 認証・セキュリティ</a>
                    <a class="nav-link block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-8.html">ステップ8: バリデーション</a>
                    <a class="nav-link block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-9.html">ステップ9: テスト・デバッグ</a>
                    <a class="nav-link active block px-4 py-2 text-sm text-gray-600 border-l-3 border-transparent" href="nextjs-tutorial-10.html">ステップ10: デプロイ</a>
                </ul>
            </div>
        </aside>

        <main class="flex-1 md:ml-64 p-6">
            <div class="max-w-5xl mx-auto">
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900" style="margin-bottom: 2rem; padding-top: 1rem;">ステップ10: デプロイメントと本番環境への準備</h1>

            <div id="step10">
                <h2 class="chapter-title">Vercelへのデプロイと本番環境設定</h2>

                <div class="highlight">
                    <h5>このステップで実装すること</h5>
                    <ul>
                        <li>本番環境用の設定と環境変数管理
                        <li>Vercelへのデプロイ手順
                        <li>Supabase PostgreSQLへの接続設定
                        <li>ドメイン設定とカスタムドメイン
                        <li>環境変数の本番設定
                        <li>ビルド最適化とパフォーマンスチューニング
                        <li>エラー監視とロギング（Sentry）
                        <li>CI/CDパイプラインの基礎
                        <li>セキュリティチェックリスト
                        <li>運用時のベストプラクティス
                    </ul>
                </div>

                <h3 class="section-title">10.1 本番環境用の設定</h3>

                <div class="exercise-container">
                    <h5>実装 10-1: 本番環境変数の設定</h5>
                    <pre class="code-block"><code class="language-bash"># .env.production.local を作成
DATABASE_URL=postgresql://user:password@host:5432/dbname
NEXTAUTH_SECRET=$(openssl rand -base64 32)
NEXTAUTH_URL=https://yourdomain.com

# ビルド確認
npm run build
npm run start</code></pre>
                </div>

                <h3 class="section-title">10.2 Vercelへのデプロイ</h3>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 my-4">
                    <h6>デプロイ手順</h6>
                    <ol style="padding-left: 1.5rem;">
                        <li>Vercelアカウント作成（https://vercel.com）
                        <li>GitHub リポジトリと連携
                        <li>environment variables を設定
                        <li>自動デプロイを有効化
                    </ol>

                    <h6>Vercelへの接続コマンド</h6>
                    <pre class="code-block"><code class="language-bash"># Vercel CLIをインストール
npm i -g vercel

# Vercelにデプロイ
vercel

# 本番環境にデプロイ
vercel --prod</code></pre>
                </div>

                <h3 class="section-title">10.3 Supabase PostgreSQL設定</h3>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 my-4">
                    <h6>Supabaseの接続設定</h6>
                    <pre class="code-block"><code class="language-bash"># Supabase でプロジェクト作成後、DATABASE_URL を取得
DATABASE_URL="postgresql://[user]:[password]@[host]:5432/[database]"

# マイグレーション実行
npx prisma migrate deploy

# Seed データ投入
npx prisma db seed</code></pre>

                    <h6>prisma/seed.ts の例</h6>
                    <pre class="code-block"><code class="language-typescript">import { prisma } from '../src/lib/prisma';
import bcrypt from 'bcryptjs';

async function main() {
  const hashedPassword = await bcrypt.hash('Demo123', 10);

  const user = await prisma.user.create({
    data: {
      name: 'デモユーザー',
      email: 'demo@example.com',
      password: hashedPassword,
    },
  });

  console.log('Seed user created:', user);
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });</code></pre>
                </div>

                <h3 class="section-title">10.4 ビルド最適化</h3>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 my-4">
                    <h6>next.config.js の最適化設定</h6>
                    <pre class="code-block"><code class="language-javascript">// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 画像最適化
  images: {
    unoptimized: false,
  },
  // ビルドサイズ削減
  experimental: {
    optimizePackageImports: [
      '@mui/material',
      '@mui/icons-material',
    ],
  },
  // ヘッダー設定
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
    ];
  },
};

module.exports = nextConfig;</code></pre>
                </div>

                <h3 class="section-title">10.5 Sentryによるエラー監視</h3>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 my-4">
                    <h6>Sentry セットアップ</h6>
                    <pre class="code-block"><code class="language-bash">npm install @sentry/nextjs</code></pre>

                    <h6>sentry.server.config.ts</h6>
                    <pre class="code-block"><code class="language-typescript">import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
  debug: false,
});</code></pre>
                </div>

                <h3 class="section-title">10.6 セキュリティチェックリスト</h3>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 my-4">
                    <h6>本番環境セキュリティチェックリスト</h6>
                    <ul style="padding-left: 1.5rem;">
                        <li>☐ すべての環境変数を安全に管理（.env.local をgitignoreに含める）
                        <li>☐ パスワードは bcrypt でハッシュ化
                        <li>☐ HTTPS通信を使用
                        <li>☐ CORS ヘッダーを適切に設定
                        <li>☐ CSP（Content Security Policy）を設定
                        <li>☐ SQL injection 対策（Prisma のパラメータ化クエリを使用）
                        <li>☐ CSRF トークンを実装
                        <li>☐ レート制限を実装
                        <li>☐ 定期的なセキュリティ監査を実施
                        <li>☐ 依存パッケージの脆弱性をチェック（npm audit）
                    </ul>
                </div>

                <h3 class="section-title">10.7 CI/CDパイプライン</h3>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 my-4">
                    <h6>GitHub Actions での自動デプロイ例</h6>
                    <pre class="code-block"><code class="language-yaml"># .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches: [ main ]

jobs:
  Deploy-Production:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Run Tests
        run: npm test
      - name: Deploy to Vercel
        run: npx vercel --prod --token ${{ secrets.VERCEL_TOKEN }}</code></pre>
                </div>

                <h3 class="section-title">10.8 運用時のモニタリング</h3>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 my-4">
                    <h6>監視すべきメトリクス</h6>
                    <ul style="padding-left: 1.5rem;">
                        <li><strong>パフォーマンス</strong>: TTFB (Time to First Byte)、FCP (First Contentful Paint)
                        <li><strong>可用性</strong>: アップタイム、エラー率
                        <li><strong>セキュリティ</strong>: 不正アクセス試行、SQL インジェクション試行
                        <li><strong>リソース使用</strong>: データベース接続数、API レスポンス時間
                    </ul>
                </div>

                <div class="quiz-container">
                    <h5>チュートリアル完了チェック</h5>
                    <ul class="space-y-2">
                        <li>☐ Vercelアカウントを作成した
                        <li>☐ GitHub リポジトリをVercelに接続した
                        <li>☐ Supabase PostgreSQL を本番データベースとして設定した
                        <li>☐ 環境変数を Vercel ダッシュボードで設定した
                        <li>☐ npm run build で本番ビルドが成功する
                        <li>☐ npm run start で本番サーバーが起動できる
                        <li>☐ Vercel にデプロイされたアプリが動作する
                        <li>☐ Sentry でエラー監視が機能している
                        <li>☐ CI/CD パイプラインが自動デプロイを実行している
                        <li>☐ セキュリティチェックリストをすべてクリアした
                    </ul>
                </div>

                <div style="background-color: #f0fdf4; border-radius: 8px; padding: 2rem; margin: 2rem 0; border-left: 4px solid var(--success);">
                    <h3 style="color: #15803d; margin-bottom: 1rem;">Next.jsチュートリアル完了</h3>
                    <p style="color: #166534; font-size: 1.1rem;">おめでとうございます！このチュートリアルを完了することで、以下のスキルが身につきました：</p>
                    <ul style="color: #166534; padding-left: 1.5rem;">
                        <li><strong>Next.js App Router</strong>: モダンなNext.js開発手法
                        <li><strong>TypeScript</strong>: 型安全なコード記述能力
                        <li><strong>Prisma ORM</strong>: データベース操作の効率化
                        <li><strong>認証・認可</strong>: NextAuth.jsを使用したセキュアな実装
                        <li><strong>フルスタック開発</strong>: フロントエンドからバックエンドまでの一貫した開発
                        <li><strong>テスト・デバッグ</strong>: 品質を保証するテスト手法
                        <li><strong>本番デプロイ</strong>: Vercelへのデプロイと本番環境管理
                    </ul>
                </div>

                <div class="nav-buttons">
                    <a href="nextjs-tutorial-9.html" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">← 前のステップ</a>
                    <button class="px-6 py-3 bg-yellow-400 text-black font-semibold rounded-lg hover:bg-yellow-500 transition" disabled style="opacity: 0.5; cursor: not-allowed;">完了 ✓</button>
                </div>
            </div>
                        </div>
            </div>
        </main>
    </div></div>

    <footer class="bg-black text-white mt-12 py-8 text-center">
        <p>© 2025 F-Circle. All rights reserved.<br>本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。<br><br><strong>Happy Next.js Coding!</strong></p>
    </footer>

    <script>hljs.highlightAll();</script>
</body>
</html>
