<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI + SQLAlchemy チュートリアル Step 5 - ユーザー一覧と詳細表示</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #009688;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #009688;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #009688;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #00695c;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e0f2f1;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #009688;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #009688 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">FastAPI + SQLAlchemy チュートリアル</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: データベース設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-routing-templates.html">Step 3: ルーティングとテンプレート</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-registration.html">Step 4: ユーザー登録機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step5-user-list-detail.html">Step 5: ユーザー一覧と詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">Step 6: 編集と削除</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-search-summary.html">Step 7: 検索機能とまとめ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 5: ユーザー一覧と詳細表示</h1>
                </div>

                <div id="step5">
                    <h2 class="chapter-title">5. ユーザー一覧と詳細表示</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>SQLAlchemyを使ったデータの取得方法</li>
                            <li>Jinja2テンプレートでのループ処理</li>
                            <li>テーブル形式でのデータ表示</li>
                            <li>URLパラメータの処理</li>
                            <li>基本的なCSSスタイリング</li>
                        </ul>
                    </div>

                    <p>この章では、データベースに保存されたユーザー情報を取得し、一覧表示と詳細表示を実装します。データの読み取りとテンプレートでのデータ表示の基本を学習します。</p>

                    <h3 class="section-title">5.1 ユーザー一覧テンプレートの作成</h3>
                    
                    <p>登録されたユーザーを一覧表示するためのテンプレートを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-1: ユーザー一覧テンプレートの作成</h5>
                        <p>テーブル形式でユーザー情報を表示するテンプレートを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>templates/user_list.html</code>ファイルを作成</li>
                            <li>以下のコードを入力して保存</li>
                        </ol>
                        
                        <h6>コード例</h6>
                        <pre class="code-block"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;ユーザー一覧 - Simple User Manager&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row"&gt;
            &lt;div class="col-12"&gt;
                &lt;div class="d-flex justify-content-between align-items-center mb-4"&gt;
                    &lt;h2&gt;ユーザー一覧&lt;/h2&gt;
                    &lt;div&gt;
                        &lt;a href="/register" class="btn btn-primary"&gt;新規登録&lt;/a&gt;
                        &lt;a href="/" class="btn btn-secondary"&gt;トップページ&lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;

                {% if users %}
                    &lt;div class="table-responsive"&gt;
                        &lt;table class="table table-striped table-hover"&gt;
                            &lt;thead class="table-primary"&gt;
                                &lt;tr&gt;
                                    &lt;th&gt;ID&lt;/th&gt;
                                    &lt;th&gt;ユーザー名&lt;/th&gt;
                                    &lt;th&gt;メールアドレス&lt;/th&gt;
                                    &lt;th&gt;氏名&lt;/th&gt;
                                    &lt;th&gt;登録日時&lt;/th&gt;
                                    &lt;th&gt;操作&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/thead&gt;
                            &lt;tbody&gt;
                                {% for user in users %}
                                &lt;tr&gt;
                                    &lt;td&gt;{{ user.id }}&lt;/td&gt;
                                    &lt;td&gt;{{ user.username }}&lt;/td&gt;
                                    &lt;td&gt;{{ user.email }}&lt;/td&gt;
                                    &lt;td&gt;{{ user.full_name }}&lt;/td&gt;
                                    &lt;td&gt;{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}&lt;/td&gt;
                                    &lt;td&gt;
                                        &lt;a href="/users/{{ user.id }}" class="btn btn-sm btn-outline-primary"&gt;詳細&lt;/a&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                                {% endfor %}
                            &lt;/tbody&gt;
                        &lt;/table&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="mt-3"&gt;
                        &lt;p class="text-muted"&gt;総ユーザー数: {{ users|length }}人&lt;/p&gt;
                    &lt;/div&gt;
                {% else %}
                    &lt;div class="alert alert-info text-center" role="alert"&gt;
                        &lt;h4&gt;ユーザーが登録されていません&lt;/h4&gt;
                        &lt;p&gt;最初のユーザーを登録してみましょう！&lt;/p&gt;
                        &lt;a href="/register" class="btn btn-primary"&gt;ユーザー登録&lt;/a&gt;
                    &lt;/div&gt;
                {% endif %}
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        
                        <h6>ポイント解説</h6>
                        <ul>
                            <li><strong>{% for %}</strong>: Jinja2のループ処理でユーザーリストを展開</li>
                            <li><strong>{{ user.created_at.strftime() }}</strong>: 日時フォーマット</li>
                            <li><strong>{% if users %}</strong>: データ存在チェック</li>
                            <li><strong>{{ users|length }}</strong>: Jinja2フィルターで配列長を取得</li>
                        </ul>
                    </div>

                    <h3 class="section-title">5.2 ユーザー詳細テンプレートの作成</h3>
                    
                    <p>個別ユーザーの詳細情報を表示するテンプレートを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-2: ユーザー詳細テンプレートの作成</h5>
                        <p>1人のユーザーの詳細情報を見やすく表示するテンプレートを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>templates/user_detail.html</code>ファイルを作成</li>
                            <li>以下のコードを入力して保存</li>
                        </ol>
                        
                        <h6>コード例</h6>
                        <pre class="code-block"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;{{ user.username }}の詳細 - Simple User Manager&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-8"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header bg-primary text-white"&gt;
                        &lt;h3 class="card-title mb-0"&gt;ユーザー詳細情報&lt;/h3&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-sm-4"&gt;&lt;strong&gt;ユーザーID:&lt;/strong&gt;&lt;/div&gt;
                            &lt;div class="col-sm-8"&gt;{{ user.id }}&lt;/div&gt;
                        &lt;/div&gt;
                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-sm-4"&gt;&lt;strong&gt;ユーザー名:&lt;/strong&gt;&lt;/div&gt;
                            &lt;div class="col-sm-8"&gt;{{ user.username }}&lt;/div&gt;
                        &lt;/div&gt;
                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-sm-4"&gt;&lt;strong&gt;メールアドレス:&lt;/strong&gt;&lt;/div&gt;
                            &lt;div class="col-sm-8"&gt;{{ user.email }}&lt;/div&gt;
                        &lt;/div&gt;
                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-sm-4"&gt;&lt;strong&gt;氏名:&lt;/strong&gt;&lt;/div&gt;
                            &lt;div class="col-sm-8"&gt;{{ user.full_name }}&lt;/div&gt;
                        &lt;/div&gt;
                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-sm-4"&gt;&lt;strong&gt;登録日時:&lt;/strong&gt;&lt;/div&gt;
                            &lt;div class="col-sm-8"&gt;{{ user.created_at.strftime('%Y年%m月%d日 %H:%M:%S') }}&lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class="card-footer"&gt;
                        &lt;div class="d-flex justify-content-between"&gt;
                            &lt;a href="/users" class="btn btn-secondary"&gt;← 一覧に戻る&lt;/a&gt;
                            &lt;div&gt;
                                &lt;a href="/users/{{ user.id }}/edit" class="btn btn-warning disabled"&gt;編集（次章で実装）&lt;/a&gt;
                                &lt;button class="btn btn-danger disabled"&gt;削除（次章で実装）&lt;/button&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <h3 class="section-title">5.3 FastAPIルートの実装</h3>
                    
                    <p><code>main.py</code>にユーザー一覧と詳細表示のルートを追加します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-3: データ取得ルートの実装</h5>
                        <p>データベースからユーザー情報を取得して表示するルートを実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>main.py</code>に必要なインポートを追加</li>
                            <li>ユーザー一覧表示のルートを追加</li>
                            <li>ユーザー詳細表示のルートを追加</li>
                        </ol>
                        
                        <h6>コード例 - main.pyに追加</h6>
                        <pre class="code-block"><code class="language-python"># 既存のインポートに追加
from fastapi import FastAPI, Request, Form, Depends, HTTPException
from fastapi.responses import HTMLResponse
# ... 他のインポート

# ユーザー一覧表示
@app.get("/users", response_class=HTMLResponse)
async def list_users(request: Request, db: Session = Depends(get_db)):
    """登録されているすべてのユーザーを一覧表示"""
    users = db.query(User).order_by(User.created_at.desc()).all()
    return templates.TemplateResponse(
        "user_list.html",
        {"request": request, "users": users}
    )

# ユーザー詳細表示
@app.get("/users/{user_id}", response_class=HTMLResponse)
async def show_user(request: Request, user_id: int, db: Session = Depends(get_db)):
    """指定されたIDのユーザー詳細を表示"""
    user = db.query(User).filter(User.id == user_id).first()
    
    # ユーザーが見つからない場合は404エラー
    if user is None:
        raise HTTPException(status_code=404, detail="ユーザーが見つかりません")
    
    return templates.TemplateResponse(
        "user_detail.html",
        {"request": request, "user": user}
    )</code></pre>
                        
                        <h6>ポイント解説</h6>
                        <ul>
                            <li><strong>db.query(User).all()</strong>: 全てのユーザーを取得</li>
                            <li><strong>order_by(User.created_at.desc())</strong>: 登録日時の降順でソート</li>
                            <li><strong>filter(User.id == user_id)</strong>: 特定のIDでフィルタリング</li>
                            <li><strong>HTTPException</strong>: 404エラーの処理</li>
                        </ul>
                    </div>

                    <h3 class="section-title">5.4 トップページのリンク有効化</h3>
                    
                    <p>Step 4で作成したトップページの「ユーザー一覧」ボタンを有効化します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-4: トップページのナビゲーション更新</h5>
                        <p><code>templates/index.html</code>を更新してユーザー一覧へのリンクを有効にします。</p>
                        
                        <h6>変更箇所</h6>
                        <pre class="code-block"><code class="language-html">&lt;!-- 変更前 --&gt;
&lt;a href="/users" class="btn btn-secondary disabled"&gt;次章で実装&lt;/a&gt;

&lt;!-- 変更後 --&gt;
&lt;a href="/users" class="btn btn-success"&gt;ユーザー一覧を見る&lt;/a&gt;</code></pre>
                    </div>

                    <h3 class="section-title">5.5 基本的なスタイリングの追加</h3>
                    
                    <p>見た目を改善するための基本的なCSSスタイルを追加します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-5: CSSファイルの作成</h5>
                        <p>アプリケーション用の基本的なスタイルファイルを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>static/css</code>ディレクトリを作成</li>
                            <li><code>static/css/style.css</code>ファイルを作成</li>
                            <li>以下のスタイルを記述</li>
                        </ol>
                        
                        <h6>コード例 - style.css</h6>
                        <pre class="code-block"><code class="language-css">/* Simple User Manager カスタムスタイル */
body {
    background-color: #f8f9fa;
}

.navbar {
    box-shadow: 0 2px 4px rgba(0,0,0,.1);
}

.card {
    box-shadow: 0 4px 6px rgba(0,0,0,.1);
    border: none;
}

.table-hover tbody tr:hover {
    background-color: #f1f8ff;
}

.btn {
    border-radius: 6px;
}

.alert {
    border: none;
    border-radius: 8px;
}

/* テーブルのレスポンシブ対応 */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.9rem;
    }
    
    .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}</code></pre>
                        
                        <h6>テンプレートでのCSS読み込み</h6>
                        <p>各テンプレートの<code>&lt;head&gt;</code>セクションに以下を追加：</p>
                        <pre class="code-block"><code class="language-html">&lt;link href="/static/css/style.css" rel="stylesheet"&gt;</code></pre>
                    </div>

                    <h3 class="section-title">5.6 動作確認とテスト</h3>
                    
                    <div class="exercise-container">
                        <h5>実習 5-6: 一覧・詳細表示機能の動作確認</h5>
                        <p>実装した機能が正常に動作することを確認します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>FastAPIサーバーを起動: <code>uvicorn main:app --reload</code></li>
                            <li>数名のユーザーを登録（Step 4の機能を使用）</li>
                            <li>トップページから「ユーザー一覧」をクリック</li>
                            <li>登録したユーザーが表示されることを確認</li>
                            <li>「詳細」ボタンをクリックして詳細ページを確認</li>
                            <li>存在しないユーザーID（例：/users/999）でアクセスして404エラーを確認</li>
                        </ol>
                        
                        <h6>確認ポイント</h6>
                        <ul>
                            <li><strong>一覧表示</strong>: 全ユーザーが表示され、日時順にソートされている</li>
                            <li><strong>詳細表示</strong>: 選択したユーザーの情報が正しく表示される</li>
                            <li><strong>エラーハンドリング</strong>: 存在しないIDで404エラーが表示される</li>
                            <li><strong>ナビゲーション</strong>: 各ページ間の移動が正常</li>
                        </ul>
                    </div>

                    <h3 class="section-title">5.7 SQLAlchemyクエリの応用</h3>
                    
                    <div class="highlight">
                        <h6>発展的な内容</h6>
                        <p>SQLAlchemyではより複雑なクエリも記述できます。以下は応用例です：</p>
                        
                        <pre class="code-block"><code class="language-python"># 最新の5人を取得
recent_users = db.query(User).order_by(User.created_at.desc()).limit(5).all()

# 特定の文字を含むユーザー名で検索
users = db.query(User).filter(User.username.like('%admin%')).all()

# ユーザー数をカウント
user_count = db.query(User).count()

# 複数条件での検索
users = db.query(User).filter(
    User.username.like('%john%'),
    User.email.like('%@example.com')
).all()</code></pre>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>SQLAlchemyで全てのユーザーを取得するクエリを書いてください。</li>
                            <li>Jinja2テンプレートでリストをループ処理する構文は何ですか？</li>
                            <li>FastAPIでURLパラメータを受け取る方法を説明してください。</li>
                            <li>データが存在しない場合に404エラーを返すために使用するFastAPIの例外クラスは何ですか？</li>
                            <li>Jinja2で日時をフォーマットして表示する方法を書いてください。</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答例</summary>
                            <ol>
                                <li><code>db.query(User).all()</code></li>
                                <li><code>{% for item in items %} ... {% endfor %}</code></li>
                                <li>関数のパラメータとして定義: <code>async def show_user(user_id: int)</code></li>
                                <li><code>HTTPException</code></li>
                                <li><code>{{ user.created_at.strftime('%Y-%m-%d') }}</code></li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step4-user-registration.html" class="btn btn-secondary">← Step 4: ユーザー登録機能</a>
                        <a href="step6-user-update-delete.html" class="btn btn-primary">Step 6: 編集と削除 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>