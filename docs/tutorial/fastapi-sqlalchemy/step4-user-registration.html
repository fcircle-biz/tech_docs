<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI + SQLAlchemy チュートリアル Step 4 - ユーザー登録機能の実装</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #009688;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #009688;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #009688;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #00695c;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e0f2f1;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #009688;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #009688 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">FastAPI + SQLAlchemy チュートリアル</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: データベース設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-routing-templates.html">Step 3: ルーティングとテンプレート</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step4-user-registration.html">Step 4: ユーザー登録機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">Step 5: ユーザー一覧と詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">Step 6: 編集と削除</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-search-summary.html">Step 7: 検索機能とまとめ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 4: ユーザー登録機能の実装</h1>
                </div>

                <div id="step4">
                    <h2 class="chapter-title">4. ユーザー登録機能の実装</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>HTMLフォームからのPOSTリクエスト処理</li>
                            <li>FastAPIでのフォームデータの受け取り方</li>
                            <li>SQLAlchemyを使ったデータベースへの保存</li>
                            <li>基本的なバリデーション機能</li>
                            <li>成功・エラーメッセージの表示方法</li>
                        </ul>
                    </div>

                    <p>この章では、ユーザー登録フォームを作成し、入力されたデータをデータベースに保存する機能を実装します。フォーム処理とデータ保存の基本パターンを学習します。</p>

                    <h3 class="section-title">4.1 登録フォームのHTMLテンプレート作成</h3>
                    
                    <p>まず、ユーザー登録用のHTMLフォームを作成します。<code>templates/user_form.html</code>を作成しましょう。</p>

                    <div class="exercise-container">
                        <h5>実習 4-1: 登録フォームテンプレートの作成</h5>
                        <p>ユーザー情報を入力するためのフォームテンプレートを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>templates/user_form.html</code>ファイルを作成</li>
                            <li>以下のコードを入力して保存</li>
                        </ol>
                        
                        <h6>コード例</h6>
                        <pre class="code-block"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;ユーザー登録 - Simple User Manager&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-6"&gt;
                &lt;div class="card"&gt;
                    &lt;div class="card-header"&gt;
                        &lt;h3 class="card-title"&gt;ユーザー登録&lt;/h3&gt;
                    &lt;/div&gt;
                    &lt;div class="card-body"&gt;
                        {% if message %}
                            {% if error %}
                                &lt;div class="alert alert-danger" role="alert"&gt;
                                    {{ message }}
                                &lt;/div&gt;
                            {% else %}
                                &lt;div class="alert alert-success" role="alert"&gt;
                                    {{ message }}
                                &lt;/div&gt;
                            {% endif %}
                        {% endif %}

                        &lt;form method="post" action="/register"&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="username" class="form-label"&gt;ユーザー名&lt;/label&gt;
                                &lt;input type="text" class="form-control" id="username" name="username" required&gt;
                            &lt;/div&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="email" class="form-label"&gt;メールアドレス&lt;/label&gt;
                                &lt;input type="email" class="form-control" id="email" name="email" required&gt;
                            &lt;/div&gt;
                            &lt;div class="mb-3"&gt;
                                &lt;label for="full_name" class="form-label"&gt;氏名&lt;/label&gt;
                                &lt;input type="text" class="form-control" id="full_name" name="full_name" required&gt;
                            &lt;/div&gt;
                            &lt;div class="d-grid"&gt;
                                &lt;button type="submit" class="btn btn-primary"&gt;登録&lt;/button&gt;
                            &lt;/div&gt;
                        &lt;/form&gt;
                        
                        &lt;div class="mt-3 text-center"&gt;
                            &lt;a href="/" class="btn btn-secondary"&gt;トップページに戻る&lt;/a&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                        
                        <h6>ポイント解説</h6>
                        <ul>
                            <li><strong>Jinja2テンプレート記法</strong>: <code>{% if %}</code>でメッセージ表示を制御</li>
                            <li><strong>フォーム送信</strong>: <code>method="post" action="/register"</code>でPOST送信</li>
                            <li><strong>Bootstrap活用</strong>: レスポンシブなフォームデザイン</li>
                            <li><strong>必須入力</strong>: <code>required</code>属性でHTML5バリデーション</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.2 FastAPIでのフォーム処理実装</h3>
                    
                    <p>次に、フォームからのPOSTリクエストを処理するFastAPIのルートを実装します。<code>main.py</code>にユーザー登録機能を追加しましょう。</p>

                    <div class="exercise-container">
                        <h5>実習 4-2: ユーザー登録ルートの実装</h5>
                        <p>フォームデータを受け取り、データベースに保存する機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>main.py</code>に必要なインポートを追加</li>
                            <li>フォーム表示用のGETルートを追加</li>
                            <li>フォーム処理用のPOSTルートを追加</li>
                        </ol>
                        
                        <h6>コード例 - main.pyの更新</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, Request, Form, Depends
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from fastapi.staticfiles import StaticFiles
from sqlalchemy.orm import Session
from sqlalchemy.exc import IntegrityError
from database import SessionLocal, engine
from models import Base, User
import models

# テーブル作成
models.Base.metadata.create_all(bind=engine)

app = FastAPI()

# 静的ファイルとテンプレートの設定
app.mount("/static", StaticFiles(directory="static"), name="static")
templates = Jinja2Templates(directory="templates")

# データベースセッション取得
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# トップページ
@app.get("/", response_class=HTMLResponse)
async def read_root(request: Request):
    return templates.TemplateResponse("index.html", {"request": request})

# ユーザー登録フォーム表示
@app.get("/register", response_class=HTMLResponse)
async def show_register_form(request: Request):
    return templates.TemplateResponse(
        "user_form.html", 
        {"request": request}
    )

# ユーザー登録処理
@app.post("/register", response_class=HTMLResponse)
async def register_user(
    request: Request,
    username: str = Form(...),
    email: str = Form(...),
    full_name: str = Form(...),
    db: Session = Depends(get_db)
):
    try:
        # 基本的なバリデーション
        if len(username.strip()) < 3:
            return templates.TemplateResponse(
                "user_form.html",
                {
                    "request": request,
                    "message": "ユーザー名は3文字以上で入力してください",
                    "error": True
                }
            )
        
        if "@" not in email:
            return templates.TemplateResponse(
                "user_form.html",
                {
                    "request": request,
                    "message": "正しいメールアドレスを入力してください",
                    "error": True
                }
            )
        
        # 新しいユーザーを作成
        new_user = User(
            username=username.strip(),
            email=email.strip(),
            full_name=full_name.strip()
        )
        
        # データベースに保存
        db.add(new_user)
        db.commit()
        db.refresh(new_user)
        
        return templates.TemplateResponse(
            "user_form.html",
            {
                "request": request,
                "message": f"ユーザー「{username}」を正常に登録しました！",
                "error": False
            }
        )
        
    except IntegrityError:
        # 重複エラー処理
        db.rollback()
        return templates.TemplateResponse(
            "user_form.html",
            {
                "request": request,
                "message": "そのユーザー名またはメールアドレスは既に使用されています",
                "error": True
            }
        )
    except Exception as e:
        # その他のエラー処理
        db.rollback()
        return templates.TemplateResponse(
            "user_form.html",
            {
                "request": request,
                "message": f"登録中にエラーが発生しました: {str(e)}",
                "error": True
            }
        )</code></pre>
                        
                        <h6>ポイント解説</h6>
                        <ul>
                            <li><strong>Form(...)</strong>: FastAPIでフォームデータを受け取る方法</li>
                            <li><strong>Depends(get_db)</strong>: データベースセッションの依存性注入</li>
                            <li><strong>IntegrityError</strong>: UNIQUE制約違反などのデータベースエラー処理</li>
                            <li><strong>db.rollback()</strong>: エラー時のトランザクションロールバック</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.3 トップページのナビゲーション更新</h3>
                    
                    <p>ユーザー登録ページへのリンクを追加するため、<code>templates/index.html</code>を更新します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-3: トップページにナビゲーション追加</h5>
                        <p>トップページから登録ページへのリンクを追加します。</p>
                        
                        <h6>コード例 - index.htmlの更新</h6>
                        <pre class="code-block"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;Simple User Manager&lt;/title&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container mt-5"&gt;
        &lt;div class="row justify-content-center"&gt;
            &lt;div class="col-md-8"&gt;
                &lt;div class="jumbotron bg-primary text-white p-5 rounded"&gt;
                    &lt;h1 class="display-4"&gt;Simple User Manager&lt;/h1&gt;
                    &lt;p class="lead"&gt;FastAPI + SQLAlchemy + Jinja2で作るユーザー管理システム&lt;/p&gt;
                &lt;/div&gt;
                
                &lt;div class="row mt-4"&gt;
                    &lt;div class="col-md-6 mb-3"&gt;
                        &lt;div class="card"&gt;
                            &lt;div class="card-body text-center"&gt;
                                &lt;h5 class="card-title"&gt;ユーザー登録&lt;/h5&gt;
                                &lt;p class="card-text"&gt;新しいユーザーを登録します&lt;/p&gt;
                                &lt;a href="/register" class="btn btn-primary"&gt;登録ページへ&lt;/a&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class="col-md-6 mb-3"&gt;
                        &lt;div class="card"&gt;
                            &lt;div class="card-body text-center"&gt;
                                &lt;h5 class="card-title"&gt;ユーザー一覧&lt;/h5&gt;
                                &lt;p class="card-text"&gt;登録済みユーザーを確認します&lt;/p&gt;
                                &lt;a href="/users" class="btn btn-secondary disabled"&gt;次章で実装&lt;/a&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <h3 class="section-title">4.4 動作確認とテスト</h3>
                    
                    <div class="exercise-container">
                        <h5>実習 4-4: ユーザー登録機能の動作確認</h5>
                        <p>実装した機能が正常に動作することを確認します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>FastAPIサーバーを起動: <code>uvicorn main:app --reload</code></li>
                            <li>ブラウザで <code>http://localhost:8000</code> にアクセス</li>
                            <li>「登録ページへ」ボタンをクリック</li>
                            <li>フォームに適切な値を入力して送信</li>
                            <li>成功メッセージが表示されることを確認</li>
                            <li>同じユーザー名で再度登録を試し、エラーメッセージを確認</li>
                        </ol>
                        
                        <h6>テストケース</h6>
                        <ul>
                            <li><strong>正常ケース</strong>: 有効なデータでの登録成功</li>
                            <li><strong>重複エラー</strong>: 同じユーザー名/メールでの登録</li>
                            <li><strong>バリデーションエラー</strong>: 短すぎるユーザー名</li>
                            <li><strong>必須チェック</strong>: 空フィールドでの送信</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.5 エラーハンドリングの改善</h3>
                    
                    <div class="warning">
                        <h6>注意事項</h6>
                        <p>実際のアプリケーションでは、より詳細なバリデーション（メールアドレス形式、文字数制限など）やセキュリティ対策（CSRF保護、SQLインジェクション対策など）が必要です。</p>
                    </div>

                    <p>このステップでは基本的なエラーハンドリングを実装しましたが、より堅牢なアプリケーションのためには以下の改善が推奨されます：</p>
                    
                    <ul>
                        <li><strong>詳細なバリデーション</strong>: 正規表現を使った入力チェック</li>
                        <li><strong>ログ出力</strong>: エラー内容の記録</li>
                        <li><strong>ユーザビリティ</strong>: フィールド単位のエラー表示</li>
                        <li><strong>セキュリティ</strong>: CSRF トークンの実装</li>
                    </ul>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>FastAPIでフォームデータを受け取るために使用するデコレータは何ですか？</li>
                            <li>SQLAlchemyでデータベースにレコードを追加する際に必要な3つのステップを順番に答えてください。</li>
                            <li>IntegrityErrorが発生する主な原因は何ですか？</li>
                            <li>データベース操作でエラーが発生した際に実行すべき処理は何ですか？</li>
                            <li>Jinja2テンプレートで条件分岐を行う際の記法は何ですか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答例</summary>
                            <ol>
                                <li><code>Form(...)</code></li>
                                <li>1. <code>db.add(オブジェクト)</code> 2. <code>db.commit()</code> 3. <code>db.refresh(オブジェクト)</code></li>
                                <li>UNIQUE制約やPRIMARY KEY制約の違反</li>
                                <li><code>db.rollback()</code></li>
                                <li><code>{% if 条件 %} ... {% endif %}</code></li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step3-routing-templates.html" class="btn btn-secondary">← Step 3: ルーティングとテンプレート</a>
                        <a href="step5-user-list-detail.html" class="btn btn-primary">Step 5: ユーザー一覧と詳細表示 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>