<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI + SQLAlchemy チュートリアル Step 2 - データベース設計とSQLAlchemy基礎</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #009688;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #009688;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #009688;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #00695c;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e0f2f1;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #009688;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #009688 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">FastAPI + SQLAlchemy チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.md">チュートリアル概要</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h5>チュートリアル目次</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step2-database-design.html">Step 2: データベース設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-routing-templates.html">Step 3: ルーティング</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-registration.html">Step 4: ユーザー登録</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">Step 5: 一覧・詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">Step 6: 編集・削除</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-search-summary.html">Step 7: 検索・まとめ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 2: データベース設計とSQLAlchemy基礎</h1>
                </div>

                <div id="step2">
                    <h2 class="chapter-title">データベース設計とSQLAlchemy基礎</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>SQLAlchemyの基本概念とORM（Object-Relational Mapping）の理解</li>
                            <li>Userモデルの設計と作成</li>
                            <li>データベース接続の設定方法</li>
                            <li>テーブルの自動作成（マイグレーション）</li>
                            <li>基本的なCRUD操作の実装</li>
                        </ul>
                    </div>

                    <!-- 所要時間と前提条件 -->
                    <div class="warning">
                        <h6>所要時間: 約2時間</h6>
                        <h6>前提条件:</h6>
                        <ul>
                            <li>Step 1の環境構築が完了していること</li>
                            <li>PostgreSQLが起動していること</li>
                            <li>基本的なSQLの知識（SELECT、INSERT程度）</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.1 SQLAlchemyの基本概念</h3>
                    <p>SQLAlchemyは、PythonでのORM（Object-Relational Mapping）ライブラリです。データベースのテーブルをPythonクラスとして表現し、SQLを直接書くことなくデータベース操作を行えます。</p>

                    <div class="highlight">
                        <h6>ORMの利点</h6>
                        <ul>
                            <li><strong>型安全性:</strong> Pythonの型システムを活用</li>
                            <li><strong>保守性:</strong> SQLクエリがコードとして管理される</li>
                            <li><strong>可読性:</strong> データベース操作が直感的</li>
                            <li><strong>移植性:</strong> 異なるデータベース間での移植が容易</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.2 データベース接続の設定</h3>
                    <p>まず、PostgreSQLデータベースへの接続設定を行います。</p>

                    <div class="exercise-container">
                        <h5>実習 2-1: database.py の作成</h5>
                        <p>データベース接続とセッション管理を行うファイルを作成します。</p>
                        
                        <h6>database.py</h6>
                        <pre class="code-block"><code class="language-python">from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

# データベースURL（環境に応じて変更してください）
SQLALCHEMY_DATABASE_URL = "postgresql://postgres:password@localhost/simple_user_manager"

# データベースエンジンの作成
engine = create_engine(SQLALCHEMY_DATABASE_URL)

# セッションファクトリの作成
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# ベースクラスの作成
Base = declarative_base()

# データベースセッションを取得する関数
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()</code></pre>
                        
                        <h6>設定の説明</h6>
                        <ul>
                            <li><strong>create_engine:</strong> データベース接続エンジンを作成</li>
                            <li><strong>SessionLocal:</strong> データベースセッションのファクトリ</li>
                            <li><strong>Base:</strong> すべてのモデルクラスの基底クラス</li>
                            <li><strong>get_db:</strong> FastAPIの依存性注入で使用するセッション取得関数</li>
                        </ul>
                        
                        <h6>期待される結果</h6>
                        <p>database.pyファイルが作成され、データベース接続の基盤が整います。</p>
                    </div>

                    <h3 class="section-title">2.3 Userモデルの作成</h3>
                    <p>ユーザー情報を格納するためのSQLAlchemyモデルを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-2: models.py の作成</h5>
                        <p>Userテーブルに対応するSQLAlchemyモデルを定義します。</p>
                        
                        <h6>models.py</h6>
                        <pre class="code-block"><code class="language-python">from sqlalchemy import Column, Integer, String, DateTime
from sqlalchemy.sql import func
from database import Base

class User(Base):
    """ユーザーモデル"""
    __tablename__ = "users"
    
    # プライマリキー
    id = Column(Integer, primary_key=True, index=True)
    
    # ユーザー名（ユニーク制約付き）
    username = Column(String(50), unique=True, index=True, nullable=False)
    
    # メールアドレス（ユニーク制約付き）
    email = Column(String(100), unique=True, index=True, nullable=False)
    
    # フルネーム
    full_name = Column(String(100), nullable=False)
    
    # 作成日時（自動設定）
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    
    # 更新日時（自動更新）
    updated_at = Column(
        DateTime(timezone=True), 
        server_default=func.now(), 
        onupdate=func.now()
    )
    
    def __repr__(self):
        return f"<User(id={self.id}, username='{self.username}', email='{self.email}')>"</code></pre>
                        
                        <h6>モデル定義の詳細</h6>
                        <ul>
                            <li><strong>__tablename__:</strong> データベーステーブル名を指定</li>
                            <li><strong>Column:</strong> テーブルのカラムを定義</li>
                            <li><strong>primary_key=True:</strong> プライマリキーとして設定</li>
                            <li><strong>unique=True:</strong> ユニーク制約を追加</li>
                            <li><strong>index=True:</strong> インデックスを作成</li>
                            <li><strong>nullable=False:</strong> NOT NULL制約を追加</li>
                        </ul>
                        
                        <h6>期待される結果</h6>
                        <p>Userモデルが定義され、データベーステーブルの構造が決まります。</p>
                    </div>

                    <h3 class="section-title">2.4 テーブルの作成</h3>
                    <p>定義したモデルを使用して、実際のデータベーステーブルを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-3: テーブル作成スクリプト</h5>
                        <p>main.pyを更新してテーブルを作成し、動作確認を行います。</p>
                        
                        <h6>main.py の更新</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, Depends
from sqlalchemy.orm import Session
from database import engine, get_db
import models

# データベーステーブルの作成
models.Base.metadata.create_all(bind=engine)

app = FastAPI()

@app.get("/")
async def read_root():
    return {"message": "Simple User Manager API"}

@app.get("/health")
async def health_check(db: Session = Depends(get_db)):
    """データベース接続確認エンドポイント"""
    try:
        # 簡単なクエリでデータベース接続を確認
        result = db.execute("SELECT 1")
        return {"status": "healthy", "database": "connected"}
    except Exception as e:
        return {"status": "error", "message": str(e)}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)</code></pre>
                        
                        <h6>動作確認</h6>
                        <pre class="code-block"><code class="language-bash"># アプリケーションの起動
python main.py

# 別のターミナルで動作確認
curl http://localhost:8000/
curl http://localhost:8000/health</code></pre>
                        
                        <h6>PostgreSQLでテーブル確認</h6>
                        <pre class="code-block"><code class="language-sql">-- PostgreSQLに接続
psql -U postgres -d simple_user_manager

-- テーブル一覧の確認
\dt

-- usersテーブルの構造確認
\d users

-- 終了
\q</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>usersテーブルが作成され、/healthエンドポイントで接続確認ができます。</p>
                    </div>

                    <h3 class="section-title">2.5 基本的なCRUD操作</h3>
                    <p>Create、Read、Update、Delete操作の基本関数を作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-4: CRUD操作関数の作成</h5>
                        <p>crud.pyファイルを作成し、基本的なデータベース操作関数を実装します。</p>
                        
                        <h6>crud.py の作成</h6>
                        <pre class="code-block"><code class="language-python">from sqlalchemy.orm import Session
from models import User

def create_user(db: Session, username: str, email: str, full_name: str) -> User:
    """新しいユーザーを作成"""
    db_user = User(
        username=username,
        email=email,
        full_name=full_name
    )
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user

def get_user(db: Session, user_id: int) -> User:
    """IDでユーザーを取得"""
    return db.query(User).filter(User.id == user_id).first()

def get_user_by_username(db: Session, username: str) -> User:
    """ユーザー名でユーザーを取得"""
    return db.query(User).filter(User.username == username).first()

def get_user_by_email(db: Session, email: str) -> User:
    """メールアドレスでユーザーを取得"""
    return db.query(User).filter(User.email == email).first()

def get_users(db: Session, skip: int = 0, limit: int = 100) -> list[User]:
    """ユーザー一覧を取得"""
    return db.query(User).offset(skip).limit(limit).all()

def update_user(db: Session, user_id: int, username: str = None, 
                email: str = None, full_name: str = None) -> User:
    """ユーザー情報を更新"""
    db_user = get_user(db, user_id)
    if db_user:
        if username:
            db_user.username = username
        if email:
            db_user.email = email
        if full_name:
            db_user.full_name = full_name
        db.commit()
        db.refresh(db_user)
    return db_user

def delete_user(db: Session, user_id: int) -> bool:
    """ユーザーを削除"""
    db_user = get_user(db, user_id)
    if db_user:
        db.delete(db_user)
        db.commit()
        return True
    return False</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>基本的なCRUD操作関数が作成され、データベース操作の基盤が整います。</p>
                    </div>

                    <h3 class="section-title">2.6 CRUD操作のテスト</h3>
                    <p>作成したCRUD操作をテストするAPIエンドポイントを追加します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-5: テスト用APIエンドポイント</h5>
                        <p>main.pyにCRUD操作をテストするエンドポイントを追加します。</p>
                        
                        <h6>main.py の更新（追加部分）</h6>
                        <pre class="code-block"><code class="language-python">from fastapi import FastAPI, Depends, HTTPException
from sqlalchemy.orm import Session
from database import engine, get_db
import models
import crud

# （既存のコードは省略）

@app.post("/users/")
async def create_user(
    username: str, 
    email: str, 
    full_name: str, 
    db: Session = Depends(get_db)
):
    """ユーザー作成（テスト用）"""
    # 既存ユーザーチェック
    if crud.get_user_by_username(db, username):
        raise HTTPException(status_code=400, detail="Username already exists")
    if crud.get_user_by_email(db, email):
        raise HTTPException(status_code=400, detail="Email already exists")
    
    # ユーザー作成
    user = crud.create_user(db, username, email, full_name)
    return {"message": "User created", "user": user.__dict__}

@app.get("/users/")
async def get_all_users(db: Session = Depends(get_db)):
    """全ユーザー取得"""
    users = crud.get_users(db)
    return {"users": [user.__dict__ for user in users]}

@app.get("/users/{user_id}")
async def get_user(user_id: int, db: Session = Depends(get_db)):
    """特定ユーザー取得"""
    user = crud.get_user(db, user_id)
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return {"user": user.__dict__}</code></pre>
                        
                        <h6>動作テスト</h6>
                        <pre class="code-block"><code class="language-bash"># アプリケーション再起動
python main.py

# ユーザー作成テスト
curl -X POST "http://localhost:8000/users/?username=testuser&email=test@example.com&full_name=Test User"

# ユーザー一覧取得
curl http://localhost:8000/users/

# 特定ユーザー取得
curl http://localhost:8000/users/1</code></pre>
                        
                        <h6>期待される結果</h6>
                        <p>ユーザーの作成、取得ができ、データがPostgreSQLに正しく保存されます。</p>
                    </div>

                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>SQLAlchemyのORMとは何の略語ですか？また、その利点を2つ挙げてください。</li>
                            <li>SQLAlchemyモデルでプライマリキーを定義するためのパラメータは何ですか？</li>
                            <li>データベースセッションを取得する関数名は何ですか？</li>
                            <li>ユニーク制約を追加するためのColumnパラメータは何ですか？</li>
                            <li>作成したUserモデルに含まれるカラムを5つ挙げてください。</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答例</summary>
                            <ol>
                                <li>Object-Relational Mapping。利点：型安全性、保守性、可読性、移植性など（任意の2つ）</li>
                                <li><code>primary_key=True</code></li>
                                <li><code>get_db</code></li>
                                <li><code>unique=True</code></li>
                                <li>id, username, email, full_name, created_at, updated_at</li>
                            </ol>
                        </details>
                    </div>

                    <!-- トラブルシューティング -->
                    <h3 class="section-title">2.7 よくある問題と解決方法</h3>
                    
                    <div class="warning">
                        <h6>データベース接続エラー</h6>
                        <p><strong>症状:</strong> "could not connect to server" エラー</p>
                        <p><strong>解決方法:</strong></p>
                        <ul>
                            <li>PostgreSQLサービスが起動しているか確認</li>
                            <li>database.pyのDATABASE_URLを環境に合わせて修正</li>
                            <li>データベース名、ユーザー名、パスワードを確認</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>テーブル作成エラー</h6>
                        <p><strong>症状:</strong> "relation already exists" エラー</p>
                        <p><strong>解決方法:</strong></p>
                        <ul>
                            <li>既存のテーブルをDropして再作成</li>
                            <li><code>models.Base.metadata.drop_all(bind=engine)</code> を一時的に追加</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>ユニーク制約エラー</h6>
                        <p><strong>症状:</strong> "duplicate key value violates unique constraint" エラー</p>
                        <p><strong>解決方法:</strong></p>
                        <ul>
                            <li>既存データの重複確認</li>
                            <li>CRUD関数での事前チェック実装</li>
                        </ul>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">2.8 この章のまとめ</h3>
                    <div class="highlight">
                        <h6>習得したスキル</h6>
                        <ul>
                            <li>SQLAlchemyによるORM基礎</li>
                            <li>データベース接続の設定</li>
                            <li>モデル定義とテーブル作成</li>
                            <li>基本的なCRUD操作の実装</li>
                            <li>FastAPIでのデータベース統合</li>
                        </ul>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step1-environment-setup.html" class="btn btn-secondary">← Step 1: 環境構築</a>
                        <a href="step3-routing-templates.html" class="btn btn-primary">Step 3: ルーティングとテンプレート →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>