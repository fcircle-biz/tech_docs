<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET Core MVC学習教材 Step 6 - ユーザー編集・削除機能</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    
    <style>
        /* ASP.NET用カラーテーマ */
        :root {
            --primary-color: #512bd4;
            --secondary-color: #7c3aed;
            --background-color: #f8f9ff;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: var(--primary-color) !important;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .chapter-title {
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: var(--secondary-color);
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .nav-link.active {
            background-color: var(--primary-color) !important;
            color: white !important;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .step-indicator {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ASP.NET Core MVC チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.html">チュートリアル概要</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        チュートリアル ステップ
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-mvc-architecture.html">
                                Step 2: MVCアーキテクチャ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-database-design.html">
                                Step 3: データベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-registration.html">
                                Step 4: ユーザー登録機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">
                                Step 5: 一覧・詳細表示
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step6-user-update-delete.html">
                                Step 6: 編集・削除機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-security-optimization.html">
                                Step 7: セキュリティと最適化
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Chapter Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 6: ユーザー編集・削除機能</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <small class="text-muted">所要時間: 約3時間</small>
                    </div>
                </div>

                <div id="step6">
                    <!-- Chapter Title -->
                    <h2 class="chapter-title">CRUD操作の完成と同時実行制御</h2>
                    
                    <!-- Learning Objectives -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>編集フォームの実装</li>
                            <li>既存データの読み込みと表示</li>
                            <li>更新処理と楽観的同時実行制御</li>
                            <li>削除確認画面と削除処理</li>
                            <li>トランザクション管理</li>
                        </ul>
                    </div>

                    <!-- Section 6.1 -->
                    <h3 class="section-title">6.1 編集機能の実装</h3>
                    <p>ユーザー情報の編集機能を実装し、同時実行制御も含めた堅牢なシステムを構築します。</p>

                    <!-- Exercise 6-1 -->
                    <div class="exercise-container">
                        <h5>実習 6-1: 編集アクションの実装</h5>
                        <p>UsersControllerに編集機能を追加します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>UsersController.vbに以下の編集アクションを追加：</li>
                        </ol>

                        <h6>UsersController.vb（編集機能追加）</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">' GET: Users/Edit/5
Public Async Function Edit(id As Integer?) As Task(Of IActionResult)
    If id Is Nothing Then
        Return NotFound()
    End If

    Dim user = Await _context.Users.FindAsync(id)
    If user Is Nothing Then
        Return NotFound()
    End If

    Return View(user)
End Function

' POST: Users/Edit/5
&lt;HttpPost&gt;
&lt;ValidateAntiForgeryToken&gt;
Public Async Function Edit(id As Integer, &lt;Bind("Id,Username,Email,FullName,Age,Department,IsActive,CreatedAt,UpdatedAt")&gt; user As User) As Task(Of IActionResult)
    If id &lt;&gt; user.Id Then
        Return NotFound()
    End If

    If ModelState.IsValid Then
        Try
            ' 重複チェック（自分以外のユーザー）
            Dim existingUserByUsername = Await _context.Users.FirstOrDefaultAsync(Function(u) u.Username = user.Username AndAlso u.Id &lt;&gt; user.Id)
            If existingUserByUsername IsNot Nothing Then
                ModelState.AddModelError("Username", "このユーザー名は既に使用されています。")
                Return View(user)
            End If

            Dim existingUserByEmail = Await _context.Users.FirstOrDefaultAsync(Function(u) u.Email = user.Email AndAlso u.Id &lt;&gt; user.Id)
            If existingUserByEmail IsNot Nothing Then
                ModelState.AddModelError("Email", "このメールアドレスは既に使用されています。")
                Return View(user)
            End If

            ' 更新日時の設定
            user.UpdatedAt = DateTime.Now

            _context.Update(user)
            Await _context.SaveChangesAsync()

            TempData("SuccessMessage") = $"ユーザー「{user.FullName}」の情報を更新しました。"
            Return RedirectToAction(NameOf(Index))

        Catch ex As DbUpdateConcurrencyException
            If Not UserExists(user.Id) Then
                Return NotFound()
            Else
                ModelState.AddModelError("", "このユーザーは他のユーザーによって変更されています。最新の情報を確認してください。")
            End If
        Catch ex As Exception
            ModelState.AddModelError("", $"更新中にエラーが発生しました: {ex.Message}")
        End Try
    End If

    Return View(user)
End Function</code></pre>
                        </div>
                    </div>

                    <!-- Section 6.2 -->
                    <h3 class="section-title">6.2 編集フォームビューの作成</h3>
                    <p>既存データを表示し、編集できるフォームを作成します。</p>

                    <!-- Exercise 6-2 -->
                    <div class="exercise-container">
                        <h5>実習 6-2: 編集ビューの作成</h5>
                        <p>ユーザー編集用のフォームビューを作成します。</p>
                        
                        <h6>Views/Users/Edit.vbhtml</h6>
                        <div class="code-block">
                            <pre><code class="language-html">@ModelType UserManagerPro.Models.User
@{
    ViewData("Title") = "ユーザー編集"
}

&lt;div class="container mt-4"&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-md-8 offset-md-2"&gt;
            &lt;div class="card"&gt;
                &lt;div class="card-header"&gt;
                    &lt;h4&gt;&lt;i class="fas fa-user-edit"&gt;&lt;/i&gt; @ViewData("Title")&lt;/h4&gt;
                    &lt;small class="text-muted"&gt;ユーザーID: @Model.Id&lt;/small&gt;
                &lt;/div&gt;
                &lt;div class="card-body"&gt;
                    @Using Html.BeginForm("Edit", "Users", FormMethod.Post, New With {.class = "needs-validation", .novalidate = ""})
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(Function(model) model.Id)
                        @Html.HiddenFor(Function(model) model.CreatedAt)
                        
                        @* バリデーションサマリー *@
                        @Html.ValidationSummary(True, "", New With {.class = "alert alert-danger"})

                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-md-6"&gt;
                                @Html.LabelFor(Function(model) model.Username, New With {.class = "form-label"})
                                @Html.EditorFor(Function(model) model.Username, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "ユーザー名を入力"}})
                                @Html.ValidationMessageFor(Function(model) model.Username, "", New With {.class = "invalid-feedback d-block"})
                            &lt;/div&gt;
                            &lt;div class="col-md-6"&gt;
                                @Html.LabelFor(Function(model) model.Email, New With {.class = "form-label"})
                                @Html.EditorFor(Function(model) model.Email, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "email@example.com", .type = "email"}})
                                @Html.ValidationMessageFor(Function(model) model.Email, "", New With {.class = "invalid-feedback d-block"})
                            &lt;/div&gt;
                        &lt;/div&gt;

                        &lt;div class="mb-3"&gt;
                            @Html.LabelFor(Function(model) model.FullName, New With {.class = "form-label"})
                            @Html.EditorFor(Function(model) model.FullName, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "氏名を入力"}})
                            @Html.ValidationMessageFor(Function(model) model.FullName, "", New With {.class = "invalid-feedback d-block"})
                        &lt;/div&gt;

                        &lt;div class="row mb-3"&gt;
                            &lt;div class="col-md-6"&gt;
                                @Html.LabelFor(Function(model) model.Age, New With {.class = "form-label"})
                                @Html.EditorFor(Function(model) model.Age, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "年齢（任意）", .type = "number", .min = "0", .max = "150"}})
                                @Html.ValidationMessageFor(Function(model) model.Age, "", New With {.class = "invalid-feedback d-block"})
                            &lt;/div&gt;
                            &lt;div class="col-md-6"&gt;
                                @Html.LabelFor(Function(model) model.Department, New With {.class = "form-label"})
                                @Html.EditorFor(Function(model) model.Department, New With {.htmlAttributes = New With {.class = "form-control", .placeholder = "部署名（任意）"}})
                                @Html.ValidationMessageFor(Function(model) model.Department, "", New With {.class = "invalid-feedback d-block"})
                            &lt;/div&gt;
                        &lt;/div&gt;

                        &lt;div class="mb-3"&gt;
                            &lt;div class="form-check"&gt;
                                @Html.EditorFor(Function(model) model.IsActive, New With {.htmlAttributes = New With {.class = "form-check-input"}})
                                @Html.LabelFor(Function(model) model.IsActive, "アクティブユーザー", New With {.class = "form-check-label"})
                            &lt;/div&gt;
                        &lt;/div&gt;

                        &lt;div class="mb-3"&gt;
                            &lt;div class="row text-muted small"&gt;
                                &lt;div class="col-md-6"&gt;
                                    &lt;i class="fas fa-calendar-plus"&gt;&lt;/i&gt; 作成日時: @Model.CreatedAt.ToString("yyyy/MM/dd HH:mm")
                                &lt;/div&gt;
                                &lt;div class="col-md-6"&gt;
                                    &lt;i class="fas fa-calendar-edit"&gt;&lt;/i&gt; 最終更新: @Model.UpdatedAt.ToString("yyyy/MM/dd HH:mm")
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;

                        &lt;div class="d-grid gap-2 d-md-flex justify-content-md-end"&gt;
                            &lt;a href="@Url.Action("Details", New With {.id = Model.Id})" class="btn btn-info me-md-2"&gt;
                                &lt;i class="fas fa-eye"&gt;&lt;/i&gt; 詳細表示
                            &lt;/a&gt;
                            &lt;a href="@Url.Action("Index")" class="btn btn-secondary me-md-2"&gt;
                                &lt;i class="fas fa-arrow-left"&gt;&lt;/i&gt; キャンセル
                            &lt;/a&gt;
                            &lt;button type="submit" class="btn btn-primary"&gt;
                                &lt;i class="fas fa-save"&gt;&lt;/i&gt; 更新
                            &lt;/button&gt;
                        &lt;/div&gt;
                    End Using
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

@Section Scripts {
    @Html.Partial("_ValidationScriptsPartial")
    
    &lt;script&gt;
        // Bootstrap のバリデーション機能を有効化
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // 変更確認ダイアログ
        let formChanged = false;
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input =&gt; {
            input.addEventListener('change', () =&gt; {
                formChanged = true;
            });
        });

        window.addEventListener('beforeunload', function(e) {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        form.addEventListener('submit', () =&gt; {
            formChanged = false;
        });
    &lt;/script&gt;
}</code></pre>
                        </div>
                    </div>

                    <!-- Section 6.3 -->
                    <h3 class="section-title">6.3 削除機能の実装</h3>
                    <p>確認画面付きの安全な削除機能を実装します。</p>

                    <!-- Exercise 6-3 -->
                    <div class="exercise-container">
                        <h5>実習 6-3: 削除アクションの実装</h5>
                        <p>削除確認と削除処理のアクションを実装します。</p>
                        
                        <h6>UsersController.vb（削除機能追加）</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">' GET: Users/Delete/5
Public Async Function Delete(id As Integer?) As Task(Of IActionResult)
    If id Is Nothing Then
        Return NotFound()
    End If

    Dim user = Await _context.Users.FirstOrDefaultAsync(Function(u) u.Id = id)
    If user Is Nothing Then
        Return NotFound()
    End If

    Return View(user)
End Function

' POST: Users/Delete/5
&lt;HttpPost, ActionName("Delete")&gt;
&lt;ValidateAntiForgeryToken&gt;
Public Async Function DeleteConfirmed(id As Integer) As Task(Of IActionResult)
    Try
        Dim user = Await _context.Users.FindAsync(id)
        If user IsNot Nothing Then
            ' ソフト削除（IsActiveをFalseに設定）または物理削除を選択
            ' ここでは物理削除を実装
            _context.Users.Remove(user)
            Await _context.SaveChangesAsync()
            
            TempData("SuccessMessage") = $"ユーザー「{user.FullName}」を削除しました。"
        End If
    Catch ex As Exception
        TempData("ErrorMessage") = $"削除中にエラーが発生しました: {ex.Message}"
    End Try

    Return RedirectToAction(NameOf(Index))
End Function

' ソフト削除の代替実装
&lt;HttpPost&gt;
&lt;ValidateAntiForgeryToken&gt;
Public Async Function SoftDelete(id As Integer) As Task(Of IActionResult)
    Try
        Dim user = Await _context.Users.FindAsync(id)
        If user IsNot Nothing Then
            user.IsActive = False
            user.UpdatedAt = DateTime.Now
            _context.Update(user)
            Await _context.SaveChangesAsync()
            
            TempData("SuccessMessage") = $"ユーザー「{user.FullName}」を無効化しました。"
        End If
    Catch ex As Exception
        TempData("ErrorMessage") = $"無効化中にエラーが発生しました: {ex.Message}"
    End Try

    Return RedirectToAction(NameOf(Index))
End Function</code></pre>
                        </div>
                    </div>

                    <!-- Section 6.4 -->
                    <h3 class="section-title">6.4 削除確認ビューの作成</h3>
                    <p>削除前の確認画面を作成します。</p>

                    <!-- Exercise 6-4 -->
                    <div class="exercise-container">
                        <h5>実習 6-4: 削除確認ビューの作成</h5>
                        <p>削除確認画面のビューを作成します。</p>
                        
                        <h6>Views/Users/Delete.vbhtml</h6>
                        <div class="code-block">
                            <pre><code class="language-html">@ModelType UserManagerPro.Models.User
@{
    ViewData("Title") = "ユーザー削除確認"
}

&lt;div class="container mt-4"&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-md-8 offset-md-2"&gt;
            &lt;div class="card border-danger"&gt;
                &lt;div class="card-header bg-danger text-white"&gt;
                    &lt;h4&gt;&lt;i class="fas fa-exclamation-triangle"&gt;&lt;/i&gt; @ViewData("Title")&lt;/h4&gt;
                &lt;/div&gt;
                &lt;div class="card-body"&gt;
                    &lt;div class="alert alert-warning" role="alert"&gt;
                        &lt;h5&gt;&lt;i class="fas fa-exclamation-triangle"&gt;&lt;/i&gt; 削除の確認&lt;/h5&gt;
                        &lt;p&gt;以下のユーザーを&lt;strong&gt;完全に削除&lt;/strong&gt;します。この操作は&lt;strong&gt;元に戻すことができません&lt;/strong&gt;。&lt;/p&gt;
                        &lt;p class="mb-0"&gt;本当に削除してもよろしいですか？&lt;/p&gt;
                    &lt;/div&gt;

                    &lt;div class="row"&gt;
                        &lt;div class="col-md-6"&gt;
                            &lt;h5 class="text-danger"&gt;削除対象ユーザー情報&lt;/h5&gt;
                            &lt;table class="table table-borderless"&gt;
                                &lt;tr&gt;
                                    &lt;td class="fw-bold text-muted"&gt;ユーザーID:&lt;/td&gt;
                                    &lt;td&gt;&lt;code&gt;@Html.DisplayFor(Function(model) model.Id)&lt;/code&gt;&lt;/td&gt;
                                &lt;/tr&gt;
                                &lt;tr&gt;
                                    &lt;td class="fw-bold text-muted"&gt;@Html.DisplayNameFor(Function(model) model.FullName):&lt;/td&gt;
                                    &lt;td&gt;&lt;strong class="fs-5"&gt;@Html.DisplayFor(Function(model) model.FullName)&lt;/strong&gt;&lt;/td&gt;
                                &lt;/tr&gt;
                                &lt;tr&gt;
                                    &lt;td class="fw-bold text-muted"&gt;@Html.DisplayNameFor(Function(model) model.Username):&lt;/td&gt;
                                    &lt;td&gt;&lt;span class="badge bg-primary"&gt;@Html.DisplayFor(Function(model) model.Username)&lt;/span&gt;&lt;/td&gt;
                                &lt;/tr&gt;
                                &lt;tr&gt;
                                    &lt;td class="fw-bold text-muted"&gt;@Html.DisplayNameFor(Function(model) model.Email):&lt;/td&gt;
                                    &lt;td&gt;@Html.DisplayFor(Function(model) model.Email)&lt;/td&gt;
                                &lt;/tr&gt;
                                &lt;tr&gt;
                                    &lt;td class="fw-bold text-muted"&gt;@Html.DisplayNameFor(Function(model) model.Department):&lt;/td&gt;
                                    &lt;td&gt;
                                        @If Not String.IsNullOrEmpty(Model.Department) Then
                                            @&lt;span class="badge bg-info"&gt;@Html.DisplayFor(Function(model) model.Department)&lt;/span&gt;
                                        Else
                                            @&lt;span class="text-muted"&gt;未設定&lt;/span&gt;
                                        End If
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                                &lt;tr&gt;
                                    &lt;td class="fw-bold text-muted"&gt;ステータス:&lt;/td&gt;
                                    &lt;td&gt;
                                        @If Model.IsActive Then
                                            @&lt;span class="badge bg-success"&gt;&lt;i class="fas fa-check"&gt;&lt;/i&gt; 有効&lt;/span&gt;
                                        Else
                                            @&lt;span class="badge bg-secondary"&gt;&lt;i class="fas fa-times"&gt;&lt;/i&gt; 無効&lt;/span&gt;
                                        End If
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                            &lt;/table&gt;
                        &lt;/div&gt;
                        
                        &lt;div class="col-md-6"&gt;
                            &lt;h5 class="text-info"&gt;削除の影響&lt;/h5&gt;
                            &lt;ul class="list-group list-group-flush"&gt;
                                &lt;li class="list-group-item"&gt;
                                    &lt;i class="fas fa-database text-danger"&gt;&lt;/i&gt; データベースから完全に削除されます
                                &lt;/li&gt;
                                &lt;li class="list-group-item"&gt;
                                    &lt;i class="fas fa-history text-warning"&gt;&lt;/i&gt; 履歴データも失われます
                                &lt;/li&gt;
                                &lt;li class="list-group-item"&gt;
                                    &lt;i class="fas fa-undo text-muted"&gt;&lt;/i&gt; この操作は元に戻せません
                                &lt;/li&gt;
                            &lt;/ul&gt;
                            
                            &lt;div class="mt-3"&gt;
                                &lt;h6 class="text-success"&gt;代替案&lt;/h6&gt;
                                &lt;p class="small text-muted"&gt;
                                    完全削除の代わりに、ユーザーを無効化することをお勧めします。
                                    無効化では、データを保持したままアクセスを制限できます。
                                &lt;/p&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="card-footer"&gt;
                    &lt;div class="d-flex justify-content-between align-items-center"&gt;
                        &lt;div&gt;
                            &lt;a href="@Url.Action("Details", New With {.id = Model.Id})" class="btn btn-outline-info me-2"&gt;
                                &lt;i class="fas fa-eye"&gt;&lt;/i&gt; 詳細確認
                            &lt;/a&gt;
                            &lt;a href="@Url.Action("Index")" class="btn btn-secondary"&gt;
                                &lt;i class="fas fa-arrow-left"&gt;&lt;/i&gt; キャンセル
                            &lt;/a&gt;
                        &lt;/div&gt;
                        &lt;div&gt;
                            @Using Html.BeginForm("SoftDelete", "Users", FormMethod.Post, New With {.class = "d-inline"})
                                @Html.AntiForgeryToken()
                                @Html.Hidden("id", Model.Id)
                                &lt;button type="submit" class="btn btn-warning me-2" onclick="return confirm('このユーザーを無効化しますか？')"&gt;
                                    &lt;i class="fas fa-user-slash"&gt;&lt;/i&gt; 無効化
                                &lt;/button&gt;
                            End Using
                            
                            @Using Html.BeginForm("Delete", "Users", FormMethod.Post, New With {.class = "d-inline"})
                                @Html.AntiForgeryToken()
                                @Html.Hidden("id", Model.Id)
                                &lt;button type="submit" class="btn btn-danger" id="deleteButton"&gt;
                                    &lt;i class="fas fa-trash"&gt;&lt;/i&gt; 完全削除
                                &lt;/button&gt;
                            End Using
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

@Section Scripts {
    &lt;script&gt;
        document.getElementById('deleteButton').addEventListener('click', function(e) {
            e.preventDefault();
            
            // カスタム確認ダイアログ
            if (confirm('本当に削除してもよろしいですか？\n\nこの操作は元に戻すことができません。\n\n削除対象: @Model.FullName (@Model.Username)')) {
                // 二重確認
                if (confirm('最終確認: 本当に「@Model.FullName」を完全に削除しますか？')) {
                    this.closest('form').submit();
                }
            }
        });
    &lt;/script&gt;
}</code></pre>
                        </div>
                    </div>

                    <!-- Section 6.5 -->
                    <h3 class="section-title">6.5 同時実行制御の実装</h3>
                    <p>複数のユーザーが同じデータを同時に編集する際の競合状態を防ぐ仕組みを実装します。</p>

                    <div class="highlight">
                        <h5>楽観的同時実行制御とは</h5>
                        <p>楽観的同時実行制御は、データの競合が発生することは稀であると仮定し、データを読み取り時にロックしない方式です。</p>
                        <ol>
                            <li><strong>RowVersion/Timestamp</strong>: データの更新時に自動的に変更されるカラム</li>
                            <li><strong>競合検出</strong>: 更新時に元のRowVersionと比較</li>
                            <li><strong>例外処理</strong>: 競合が検出された場合の処理</li>
                        </ol>
                    </div>

                    <!-- Exercise 6-5 -->
                    <div class="exercise-container">
                        <h5>実習 6-5: RowVersionによる同時実行制御</h5>
                        <p>Userモデルにバージョン管理機能を追加します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>Userモデルにバージョンプロパティを追加：</li>
                        </ol>

                        <h6>Models/User.vb（RowVersion追加）</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports System.ComponentModel.DataAnnotations

Public Class User
    ' 既存のプロパティ...

    ' 同時実行制御用のRowVersion
    &lt;Timestamp&gt;
    Public Property RowVersion As Byte()

    ' その他のプロパティ...
End Class</code></pre>
                        </div>

                        <li><span class="step-indicator">2</span>マイグレーションを作成して実行：</li>

                        <div class="code-block">
                            <pre><code class="language-powershell">Add-Migration AddRowVersionToUser
Update-Database</code></pre>
                        </div>

                        <li><span class="step-indicator">3</span>編集ビューにRowVersionを追加：</li>

                        <div class="code-block">
                            <pre><code class="language-html">@* Views/Users/Edit.vbhtml の隠しフィールドに追加 *@
@Html.HiddenFor(Function(model) model.RowVersion)</code></pre>
                        </div>
                    </div>

                    <!-- Understanding Check Quiz -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>Question 1</strong>: Entity Framework Coreで楽観的同時実行制御を実装するために使用するデータアノテーションは何ですか？
                                <ul style="list-style-type: none;">
                                    <li>a) [Concurrency]</li>
                                    <li>b) [Timestamp]</li>
                                    <li>c) [Version]</li>
                                    <li>d) [RowLock]</li>
                                </ul>
                            </li>
                            <li><strong>Question 2</strong>: ソフト削除と物理削除の違いは何ですか？</li>
                            <li><strong>Question 3</strong>: MVCで編集フォームに変更前のデータを保持するために使用するHTML Helperは何ですか？</li>
                            <li><strong>Question 4</strong>: 同時実行制御の競合が発生した場合にスローされる例外は何ですか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を表示</summary>
                            <ol class="mt-2">
                                <li>b) [Timestamp] - 自動的にバージョン管理を行うためのアノテーションです</li>
                                <li>ソフト削除：データを物理的に削除せず、フラグで無効化。物理削除：データベースからレコードを完全に除去</li>
                                <li>@Html.HiddenFor() - 画面に表示しないデータを保持するために使用します</li>
                                <li>DbUpdateConcurrencyException - データの同時更新競合が発生した際にスローされます</li>
                            </ol>
                        </details>
                    </div>

                    <!-- Next Steps -->
                    <div class="highlight">
                        <h5>次のステップの準備</h5>
                        <p>Step 6 が完了したら、以下を確認してください：</p>
                        <ul>
                            <li>✅ 編集機能が正常に動作する</li>
                            <li>✅ 削除確認画面が表示される</li>
                            <li>✅ 物理削除とソフト削除が実装された</li>
                            <li>✅ 同時実行制御が動作する</li>
                            <li>✅ エラーハンドリングが適切に動作する</li>
                            <li>✅ ユーザーフィードバックが適切に表示される</li>
                        </ul>
                        <p>これらが完了したら、<strong>Step 7: セキュリティと最適化</strong>に進みましょう。</p>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step5-user-list-detail.html" class="btn btn-secondary">← Step 5: 一覧・詳細表示</a>
                        <a href="step7-security-optimization.html" class="btn btn-primary">Step 7: セキュリティと最適化 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/vbnet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>