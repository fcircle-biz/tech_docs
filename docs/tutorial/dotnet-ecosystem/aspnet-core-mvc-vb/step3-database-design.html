<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET Core MVC学習教材 Step 3 - Entity Framework Core とデータベース設計</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
    
    <style>
        /* ASP.NET用カラーテーマ */
        :root {
            --primary-color: #512bd4;
            --secondary-color: #7c3aed;
            --background-color: #f8f9ff;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: var(--primary-color) !important;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .chapter-title {
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: var(--secondary-color);
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .nav-link.active {
            background-color: var(--primary-color) !important;
            color: white !important;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .step-indicator {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        .db-table {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .db-table-header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ASP.NET Core MVC チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="README.html">チュートリアル概要</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        チュートリアル ステップ
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-mvc-architecture.html">
                                Step 2: MVCアーキテクチャ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step3-database-design.html">
                                Step 3: データベース設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-registration.html">
                                Step 4: ユーザー登録機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">
                                Step 5: 一覧・詳細表示
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">
                                Step 6: 編集・削除機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-security-optimization.html">
                                Step 7: セキュリティと最適化
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Chapter Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 3: Entity Framework Core とデータベース設計</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <small class="text-muted">所要時間: 約2.5時間</small>
                    </div>
                </div>

                <div id="step3">
                    <!-- Chapter Title -->
                    <h2 class="chapter-title">コードファーストによるデータベース開発</h2>
                    
                    <!-- Learning Objectives -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Entity Framework Coreの基本概念</li>
                            <li>コードファーストアプローチによるモデル作成</li>
                            <li>DbContextの作成と設定</li>
                            <li>マイグレーションによるデータベース作成</li>
                            <li>初期データの投入（シード処理）</li>
                        </ul>
                    </div>

                    <!-- Section 3.1 -->
                    <h3 class="section-title">3.1 Entity Framework Core とは</h3>
                    <p>Entity Framework Core (EF Core) は、.NETアプリケーション用のオブジェクトリレーショナルマッピング（ORM）フレームワークです。</p>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5>従来のデータアクセス</h5>
                                </div>
                                <div class="card-body">
                                    <ul>
                                        <li>ADO.NET での直接SQL実行</li>
                                        <li>SqlConnection、SqlCommand</li>
                                        <li>手動でのオブジェクトマッピング</li>
                                        <li>SQLインジェクションのリスク</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h5>Entity Framework Core</h5>
                                </div>
                                <div class="card-body">
                                    <ul>
                                        <li>オブジェクト指向でのデータ操作</li>
                                        <li>LINQ to Entities</li>
                                        <li>自動マッピング</li>
                                        <li>自動的なSQLインジェクション対策</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3.2 -->
                    <h3 class="section-title">3.2 Userモデルの作成</h3>
                    <p>ユーザー管理システムの核となるUserモデルを作成します。</p>

                    <!-- Exercise 3-1 -->
                    <div class="exercise-container">
                        <h5>実習 3-1: Userエンティティクラスの作成</h5>
                        <p>データベースのUsersテーブルに対応するUserクラスを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>「Models」フォルダを右クリック → 「追加」→「クラス」</li>
                            <li><span class="step-indicator">2</span>クラス名を「User.vb」として作成</li>
                            <li><span class="step-indicator">3</span>以下のコードを記述：</li>
                        </ol>

                        <h6>Models/User.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports System.ComponentModel.DataAnnotations

Public Class User
    ' プライマリキー
    Public Property Id As Integer
    
    ' ユーザー名（必須、最大50文字）
    &lt;Required(ErrorMessage:="ユーザー名は必須です。")&gt;
    &lt;StringLength(50, ErrorMessage:="ユーザー名は50文字以内で入力してください。")&gt;
    Public Property Username As String
    
    ' メールアドレス（必須、メール形式）
    &lt;Required(ErrorMessage:="メールアドレスは必須です。")&gt;
    &lt;EmailAddress(ErrorMessage:="正しいメール形式で入力してください。")&gt;
    Public Property Email As String
    
    ' フルネーム（必須、最大100文字）
    &lt;Required(ErrorMessage:="氏名は必須です。")&gt;
    &lt;StringLength(100, ErrorMessage:="氏名は100文字以内で入力してください。")&gt;
    &lt;Display(Name:="氏名")&gt;
    Public Property FullName As String
    
    ' 年齢（0〜150の範囲、NULL許可）
    &lt;Range(0, 150, ErrorMessage:="年齢は0〜150の範囲で入力してください。")&gt;
    &lt;Display(Name:="年齢")&gt;
    Public Property Age As Integer?
    
    ' 部署（最大50文字、NULL許可）
    &lt;StringLength(50, ErrorMessage:="部署名は50文字以内で入力してください。")&gt;
    &lt;Display(Name:="部署")&gt;
    Public Property Department As String
    
    ' アクティブフラグ
    &lt;Display(Name:="有効")&gt;
    Public Property IsActive As Boolean = True
    
    ' 作成日時
    &lt;Display(Name:="作成日時")&gt;
    Public Property CreatedAt As DateTime = DateTime.Now
    
    ' 更新日時
    &lt;Display(Name:="更新日時")&gt;
    Public Property UpdatedAt As DateTime = DateTime.Now
End Class</code></pre>
                        </div>

                        <h6>データアノテーション解説</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>アノテーション</th>
                                        <th>用途</th>
                                        <th>例</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>Required</code></td>
                                        <td>必須入力項目</td>
                                        <td>空文字やNullを許可しない</td>
                                    </tr>
                                    <tr>
                                        <td><code>StringLength</code></td>
                                        <td>文字列長制限</td>
                                        <td>最大文字数を指定</td>
                                    </tr>
                                    <tr>
                                        <td><code>EmailAddress</code></td>
                                        <td>メール形式検証</td>
                                        <td>@マークを含む正しい形式</td>
                                    </tr>
                                    <tr>
                                        <td><code>Range</code></td>
                                        <td>数値範囲制限</td>
                                        <td>最小値〜最大値の範囲</td>
                                    </tr>
                                    <tr>
                                        <td><code>Display</code></td>
                                        <td>表示名指定</td>
                                        <td>UI上での表示文字</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Section 3.3 -->
                    <h3 class="section-title">3.3 DbContextの作成</h3>
                    <p>Entity Framework CoreでデータベースとやりとりするためのDbContextクラスを作成します。</p>

                    <!-- Exercise 3-2 -->
                    <div class="exercise-container">
                        <h5>実習 3-2: ApplicationDbContextの作成</h5>
                        <p>データベースアクセスを統括するDbContextクラスを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>プロジェクトルートに「Data」フォルダを作成</li>
                            <li><span class="step-indicator">2</span>「Data」フォルダ内に「ApplicationDbContext.vb」を作成</li>
                            <li><span class="step-indicator">3</span>以下のコードを記述：</li>
                        </ol>

                        <h6>Data/ApplicationDbContext.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports Microsoft.EntityFrameworkCore
Imports UserManagerPro.Models

Public Class ApplicationDbContext
    Inherits DbContext

    ' コンストラクタ（依存性注入で設定を受け取る）
    Public Sub New(options As DbContextOptions(Of ApplicationDbContext))
        MyBase.New(options)
    End Sub

    ' Usersテーブルに対応するDbSet
    Public Property Users As DbSet(Of User)

    ' モデル設定のカスタマイズ
    Protected Overrides Sub OnModelCreating(modelBuilder As ModelBuilder)
        MyBase.OnModelCreating(modelBuilder)

        ' Userエンティティの詳細設定
        modelBuilder.Entity(Of User)(Sub(entity)
            ' テーブル名の明示的指定
            entity.ToTable("Users")
            
            ' プライマリキーの設定
            entity.HasKey(Function(u) u.Id)
            
            ' プロパティの詳細設定
            entity.Property(Function(u) u.Id) _
                  .ValueGeneratedOnAdd() ' 自動採番
            
            entity.Property(Function(u) u.Username) _
                  .IsRequired() _
                  .HasMaxLength(50)
            
            entity.Property(Function(u) u.Email) _
                  .IsRequired() _
                  .HasMaxLength(255)
            
            entity.Property(Function(u) u.FullName) _
                  .IsRequired() _
                  .HasMaxLength(100)
            
            entity.Property(Function(u) u.Department) _
                  .HasMaxLength(50)
            
            entity.Property(Function(u) u.CreatedAt) _
                  .HasDefaultValueSql("GETDATE()")
            
            entity.Property(Function(u) u.UpdatedAt) _
                  .HasDefaultValueSql("GETDATE()")
            
            ' インデックスの作成
            entity.HasIndex(Function(u) u.Username) _
                  .IsUnique() _
                  .HasDatabaseName("IX_Users_Username")
            
            entity.HasIndex(Function(u) u.Email) _
                  .IsUnique() _
                  .HasDatabaseName("IX_Users_Email")
        End Sub)
    End Sub
End Class</code></pre>
                        </div>
                    </div>

                    <!-- Section 3.4 -->
                    <h3 class="section-title">3.4 データベース接続の設定</h3>
                    <p>アプリケーションの設定ファイルとDIコンテナーにデータベース接続を設定します。</p>

                    <!-- Exercise 3-3 -->
                    <div class="exercise-container">
                        <h5>実習 3-3: 接続文字列の設定とサービス登録</h5>
                        <p>appsettings.jsonとProgram.vbで、データベース接続を設定します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>「appsettings.json」を編集して接続文字列を追加：</li>
                        </ol>

                        <h6>appsettings.json</h6>
                        <div class="code-block">
                            <pre><code class="language-json">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=UserManagerProDb;Trusted_Connection=true;MultipleActiveResultSets=true;TrustServerCertificate=true"
  }
}</code></pre>
                        </div>

                        <li><span class="step-indicator">2</span>「appsettings.Development.json」も同様に編集：</li>

                        <h6>appsettings.Development.json</h6>
                        <div class="code-block">
                            <pre><code class="language-json">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore.Database.Command": "Information"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=UserManagerProDb_Dev;Trusted_Connection=true;MultipleActiveResultSets=true;TrustServerCertificate=true"
  }
}</code></pre>
                        </div>

                        <li><span class="step-indicator">3</span>「Program.vb」を編集してDbContextをDIコンテナに登録：</li>

                        <h6>Program.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports Microsoft.EntityFrameworkCore
Imports UserManagerPro.Data

Dim builder = WebApplication.CreateBuilder(args)

' サービスの追加
builder.Services.AddControllersWithViews()

' Entity Framework Coreの設定
builder.Services.AddDbContext(Of ApplicationDbContext)(
    Sub(options)
        options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection"))
        
        ' 開発環境では詳細なログを出力
        If builder.Environment.IsDevelopment() Then
            options.EnableSensitiveDataLogging()
            options.EnableDetailedErrors()
        End If
    End Sub)

Dim app = builder.Build()

' ミドルウェアパイプラインの設定
If Not app.Environment.IsDevelopment() Then
    app.UseExceptionHandler("/Home/Error")
    app.UseHsts()
End If

app.UseHttpsRedirection()
app.UseStaticFiles()

app.UseRouting()

app.UseAuthorization()

app.MapControllerRoute(
    name:="default",
    pattern:="{controller=Home}/{action=Index}/{id?}")

app.Run()</code></pre>
                        </div>
                    </div>

                    <!-- Section 3.5 -->
                    <h3 class="section-title">3.5 マイグレーションの実行</h3>
                    <p>コードファーストアプローチでは、モデルクラスからデータベーススキーマを生成します。</p>

                    <!-- Exercise 3-4 -->
                    <div class="exercise-container">
                        <h5>実習 3-4: 初回マイグレーションの作成と実行</h5>
                        <p>パッケージマネージャーコンソールを使用してマイグレーションを作成・実行します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>Visual Studioで「ツール」→「NuGetパッケージマネージャー」→「パッケージマネージャーコンソール」を開く</li>
                            <li><span class="step-indicator">2</span>初回マイグレーションを作成：</li>
                        </ol>

                        <div class="code-block">
                            <pre><code class="language-powershell">Add-Migration InitialCreate</code></pre>
                        </div>

                        <li><span class="step-indicator">3</span>データベースにマイグレーションを適用：</li>

                        <div class="code-block">
                            <pre><code class="language-powershell">Update-Database</code></pre>
                        </div>

                        <h6>期待される結果</h6>
                        <ul>
                            <li>「Migrations」フォルダが作成される</li>
                            <li>「YYYYMMDDHHMMSS_InitialCreate.vb」ファイルが生成される</li>
                            <li>SQL Server LocalDBに「UserManagerProDb_Dev」データベースが作成される</li>
                            <li>「Users」テーブルが作成される</li>
                        </ul>

                        <div class="warning">
                            <h6>トラブルシューティング</h6>
                            <ul>
                                <li><strong>「LocalDBに接続できない」</strong>: SQL Server Express LocalDBがインストールされているか確認</li>
                                <li><strong>「マイグレーションエラー」</strong>: ビルドエラーがないか確認し、プロジェクトをリビルド</li>
                                <li><strong>「接続文字列エラー」</strong>: appsettings.jsonの接続文字列を確認</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Database Table Visualization -->
                    <div class="quiz-container">
                        <h5>作成されるUsersテーブル構造</h5>
                        <div class="db-table">
                            <div class="db-table-header">Users テーブル</div>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th>カラム名</th>
                                            <th>データ型</th>
                                            <th>NULL許可</th>
                                            <th>制約</th>
                                            <th>説明</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Id</strong></td>
                                            <td>int</td>
                                            <td>×</td>
                                            <td>PK, IDENTITY</td>
                                            <td>主キー（自動採番）</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Username</strong></td>
                                            <td>nvarchar(50)</td>
                                            <td>×</td>
                                            <td>UNIQUE</td>
                                            <td>ユーザー名</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Email</strong></td>
                                            <td>nvarchar(255)</td>
                                            <td>×</td>
                                            <td>UNIQUE</td>
                                            <td>メールアドレス</td>
                                        </tr>
                                        <tr>
                                            <td><strong>FullName</strong></td>
                                            <td>nvarchar(100)</td>
                                            <td>×</td>
                                            <td>-</td>
                                            <td>氏名</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Age</strong></td>
                                            <td>int</td>
                                            <td>○</td>
                                            <td>-</td>
                                            <td>年齢</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Department</strong></td>
                                            <td>nvarchar(50)</td>
                                            <td>○</td>
                                            <td>-</td>
                                            <td>部署</td>
                                        </tr>
                                        <tr>
                                            <td><strong>IsActive</strong></td>
                                            <td>bit</td>
                                            <td>×</td>
                                            <td>DEFAULT 1</td>
                                            <td>有効フラグ</td>
                                        </tr>
                                        <tr>
                                            <td><strong>CreatedAt</strong></td>
                                            <td>datetime2</td>
                                            <td>×</td>
                                            <td>DEFAULT GETDATE()</td>
                                            <td>作成日時</td>
                                        </tr>
                                        <tr>
                                            <td><strong>UpdatedAt</strong></td>
                                            <td>datetime2</td>
                                            <td>×</td>
                                            <td>DEFAULT GETDATE()</td>
                                            <td>更新日時</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3.6 -->
                    <h3 class="section-title">3.6 初期データの投入（シード処理）</h3>
                    <p>アプリケーションテスト用の初期データを自動的に投入する仕組みを作成します。</p>

                    <!-- Exercise 3-5 -->
                    <div class="exercise-container">
                        <h5>実習 3-5: DbInitializerクラスの作成</h5>
                        <p>初期データを投入するためのDbInitializerクラスを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>「Data」フォルダに「DbInitializer.vb」を作成</li>
                            <li><span class="step-indicator">2</span>以下のコードを記述：</li>
                        </ol>

                        <h6>Data/DbInitializer.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports UserManagerPro.Models

Public Class DbInitializer
    Public Shared Sub Initialize(context As ApplicationDbContext)
        ' データベースが作成されていることを確認
        context.Database.EnsureCreated()

        ' 既にデータが存在する場合は何もしない
        If context.Users.Any() Then
            Return
        End If

        ' 初期ユーザーデータの作成
        Dim users() As User = {
            New User With {
                .Username = "admin",
                .Email = "admin@example.com",
                .FullName = "管理者 太郎",
                .Age = 35,
                .Department = "システム部",
                .IsActive = True,
                .CreatedAt = DateTime.Now.AddDays(-30),
                .UpdatedAt = DateTime.Now.AddDays(-30)
            },
            New User With {
                .Username = "tanaka",
                .Email = "tanaka@example.com",
                .FullName = "田中 花子",
                .Age = 28,
                .Department = "営業部",
                .IsActive = True,
                .CreatedAt = DateTime.Now.AddDays(-20),
                .UpdatedAt = DateTime.Now.AddDays(-5)
            },
            New User With {
                .Username = "sato",
                .Email = "sato@example.com",
                .FullName = "佐藤 次郎",
                .Age = 42,
                .Department = "開発部",
                .IsActive = True,
                .CreatedAt = DateTime.Now.AddDays(-15),
                .UpdatedAt = DateTime.Now.AddDays(-2)
            },
            New User With {
                .Username = "yamada",
                .Email = "yamada@example.com",
                .FullName = "山田 三郎",
                .Age = 31,
                .Department = "開発部",
                .IsActive = False,
                .CreatedAt = DateTime.Now.AddDays(-10),
                .UpdatedAt = DateTime.Now.AddDays(-1)
            },
            New User With {
                .Username = "suzuki",
                .Email = "suzuki@example.com",
                .FullName = "鈴木 恵美",
                .Age = 26,
                .Department = "人事部",
                .IsActive = True,
                .CreatedAt = DateTime.Now.AddDays(-5),
                .UpdatedAt = DateTime.Now
            }
        }

        ' データベースにユーザーを追加
        For Each user In users
            context.Users.Add(user)
        Next

        ' 変更を保存
        context.SaveChanges()
    End Sub
End Class</code></pre>
                        </div>

                        <li><span class="step-indicator">3</span>「Program.vb」を編集してアプリケーション起動時にシード処理を実行：</li>

                        <h6>Program.vb（シード処理追加部分）</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">' 既存のコードの後に追加

' データベースシード処理の実行
Using scope = app.Services.CreateScope()
    Dim services = scope.ServiceProvider
    Try
        Dim context = services.GetRequiredService(Of ApplicationDbContext)()
        DbInitializer.Initialize(context)
    Catch ex As Exception
        Dim logger = services.GetRequiredService(Of ILogger(Of Program))()
        logger.LogError(ex, "データベースシード処理中にエラーが発生しました。")
    End Try
End Using

app.Run()</code></pre>
                        </div>
                    </div>

                    <!-- Section 3.7 -->
                    <h3 class="section-title">3.7 データベース操作の動作確認</h3>
                    <p>作成したDbContextが正しく動作することを確認します。</p>

                    <!-- Exercise 3-6 -->
                    <div class="exercise-container">
                        <h5>実習 3-6: データベース接続テスト</h5>
                        <p>簡単なコントローラーを作成してデータベースからデータを取得します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><span class="step-indicator">1</span>「Controllers」フォルダに「TestController.vb」を作成：</li>
                        </ol>

                        <h6>Controllers/TestController.vb</h6>
                        <div class="code-block">
                            <pre><code class="language-vbnet">Imports Microsoft.AspNetCore.Mvc
Imports UserManagerPro.Data

Public Class TestController
    Inherits Controller

    Private ReadOnly _context As ApplicationDbContext

    Public Sub New(context As ApplicationDbContext)
        _context = context
    End Sub

    ' データベース接続テスト
    Public Function Index() As IActionResult
        Try
            ' ユーザー数を取得
            Dim userCount = _context.Users.Count()
            
            ' アクティブユーザー数を取得
            Dim activeUserCount = _context.Users.Where(Function(u) u.IsActive).Count()
            
            ' 最新のユーザーを取得
            Dim latestUser = _context.Users.OrderByDescending(Function(u) u.CreatedAt).FirstOrDefault()
            
            ViewBag.UserCount = userCount
            ViewBag.ActiveUserCount = activeUserCount
            ViewBag.LatestUser = latestUser
            ViewBag.TestResult = "データベース接続成功"
            
        Catch ex As Exception
            ViewBag.TestResult = $"データベース接続エラー: {ex.Message}"
        End Try

        Return View()
    End Function
End Class</code></pre>
                        </div>

                        <li><span class="step-indicator">2</span>対応するビュー「Views/Test/Index.vbhtml」を作成：</li>

                        <h6>Views/Test/Index.vbhtml</h6>
                        <div class="code-block">
                            <pre><code class="language-html">@{
    ViewData("Title") = "データベース接続テスト"
}

&lt;div class="container mt-4"&gt;
    &lt;h2&gt;@ViewData("Title")&lt;/h2&gt;
    
    &lt;div class="alert alert-info"&gt;
        &lt;h5&gt;@ViewBag.TestResult&lt;/h5&gt;
    &lt;/div&gt;
    
    @If ViewBag.TestResult.ToString().Contains("成功") Then
        @&lt;div class="row"&gt;
            &lt;div class="col-md-4"&gt;
                &lt;div class="card bg-primary text-white"&gt;
                    &lt;div class="card-body"&gt;
                        &lt;h5 class="card-title"&gt;総ユーザー数&lt;/h5&gt;
                        &lt;p class="card-text display-4"&gt;@ViewBag.UserCount&lt;/p&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="col-md-4"&gt;
                &lt;div class="card bg-success text-white"&gt;
                    &lt;div class="card-body"&gt;
                        &lt;h5 class="card-title"&gt;アクティブユーザー数&lt;/h5&gt;
                        &lt;p class="card-text display-4"&gt;@ViewBag.ActiveUserCount&lt;/p&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="col-md-4"&gt;
                &lt;div class="card bg-info text-white"&gt;
                    &lt;div class="card-body"&gt;
                        &lt;h5 class="card-title"&gt;最新ユーザー&lt;/h5&gt;
                        @If ViewBag.LatestUser IsNot Nothing Then
                            @&lt;p class="card-text"&gt;@ViewBag.LatestUser.FullName&lt;/p&gt;
                        Else
                            @&lt;p class="card-text"&gt;なし&lt;/p&gt;
                        End If
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    End If
    
    &lt;div class="mt-3"&gt;
        &lt;a href="@Url.Action("Index", "Home")" class="btn btn-primary"&gt;ホームに戻る&lt;/a&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
                        </div>

                        <li><span class="step-indicator">3</span>アプリケーションを実行し、「/Test」にアクセスして動作確認</li>
                    </div>

                    <!-- Understanding Check Quiz -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>Question 1</strong>: Entity Framework Coreにおいて、データベースとのやりとりを担当するクラスは何ですか？
                                <ul style="list-style-type: none;">
                                    <li>a) Entity</li>
                                    <li>b) DbContext</li>
                                    <li>c) Model</li>
                                    <li>d) Repository</li>
                                </ul>
                            </li>
                            <li><strong>Question 2</strong>: コードファーストアプローチで、モデルクラスからデータベーススキーマを生成する機能は何と呼ばれますか？</li>
                            <li><strong>Question 3</strong>: データアノテーション「Required」の主な用途は何ですか？</li>
                            <li><strong>Question 4</strong>: パッケージマネージャーコンソールで初回マイグレーションを作成するコマンドは何ですか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を表示</summary>
                            <ol class="mt-2">
                                <li>b) DbContext - データベースセッションを表し、エンティティの変更追跡とデータベース操作を提供します</li>
                                <li>マイグレーション（Migration） - モデルの変更をデータベーススキーマに反映する仕組みです</li>
                                <li>必須入力項目の指定 - null値や空文字列を許可しない制約を設定します</li>
                                <li>Add-Migration [マイグレーション名] - 例: Add-Migration InitialCreate</li>
                            </ol>
                        </details>
                    </div>

                    <!-- Next Steps -->
                    <div class="highlight">
                        <h5>次のステップの準備</h5>
                        <p>Step 3 が完了したら、以下を確認してください：</p>
                        <ul>
                            <li>✅ Userモデルクラスが正しく作成された</li>
                            <li>✅ ApplicationDbContextが設定された</li>
                            <li>✅ データベース接続文字列が設定された</li>
                            <li>✅ マイグレーションが正常に実行された</li>
                            <li>✅ 初期データが投入された</li>
                            <li>✅ データベース接続テストが成功した</li>
                        </ul>
                        <p>これらが完了したら、<strong>Step 4: ユーザー登録機能の実装</strong>に進みましょう。</p>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step2-mvc-architecture.html" class="btn btn-secondary">← Step 2: MVCアーキテクチャ</a>
                        <a href="step4-user-registration.html" class="btn btn-primary">Step 4: ユーザー登録機能 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/vbnet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>