<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struts 1.x学習教材 第5章 - ユーザー管理機能の拡張（UPDATE, DELETE）</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション - Java生態系テーマ */
        .navbar {
            background-color: #f57c00;
        }

        .navbar-brand, .navbar-nav .nav-link {
            color: white !important;
        }

        .navbar-nav .nav-link:hover {
            color: #fff3e0 !important;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }

        .sidebar .nav-link {
            color: #495057;
            font-weight: 500;
        }

        .sidebar .nav-link:hover {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .sidebar .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        /* コードブロック */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Struts 1.x チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://fcircle-biz.github.io/tech_docs/">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">チュートリアル概要</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#section5-1">5.1 ユーザー詳細表示</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#section5-2">5.2 ユーザー編集機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#section5-3">5.3 ユーザー更新処理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#section5-4">5.4 ユーザー削除機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#section5-5">5.5 確認ダイアログ実装</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#section5-6">5.6 CRUD統合確認</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#quiz">理解度確認</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第5章: ユーザー管理機能の拡張（UPDATE, DELETE）</h1>
                </div>

                <div id="chapter5">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">ユーザー情報の更新・削除機能の実装</h2>
                    
                    <!-- 学習目標（必須） -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>ユーザー詳細表示機能の実装</li>
                            <li>ユーザー情報編集フォームの作成</li>
                            <li>ユーザー情報更新処理の実装</li>
                            <li>ユーザー削除機能と確認機能</li>
                            <li>JavaScriptによる動的UI改善</li>
                            <li>CRUD機能の統合とナビゲーション改善</li>
                        </ul>
                    </div>

                    <!-- セクション5.1 -->
                    <h3 class="section-title" id="section5-1">5.1 ユーザー詳細表示機能</h3>
                    <p>個別ユーザーの詳細情報を表示する機能を実装します。</p>

                    <!-- 実習（必須） -->
                    <div class="exercise-container">
                        <h5>実習 5-1: UserViewAction実装</h5>
                        <p>ユーザー詳細表示のActionクラスを作成します。</p>
                        
                        <h6>UserViewAction.java</h6>
                        <p>src/main/java/com/example/struts/action/UserViewAction.java:</p>
                        <pre><code>package com.example.struts.action;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.action.ActionMessages;

import com.example.struts.model.User;
import com.example.struts.service.UserService;

public class UserViewAction extends Action {
    
    private UserService userService = new UserService();
    
    @Override
    public ActionForward execute(ActionMapping mapping,
                                ActionForm form,
                                HttpServletRequest request,
                                HttpServletResponse response) {
        
        try {
            // リクエストパラメータからユーザーIDを取得
            String userIdParam = request.getParameter("userId");
            
            if (userIdParam == null || userIdParam.trim().isEmpty()) {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.view.error.noid"));
                saveErrors(request, errors);
                return mapping.findForward("error");
            }
            
            int userId = Integer.parseInt(userIdParam);
            
            // ユーザー情報取得
            User user = userService.getUserById(userId);
            
            if (user == null) {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.view.error.notfound", userIdParam));
                saveErrors(request, errors);
                return mapping.findForward("error");
            }
            
            // リクエストスコープに設定
            request.setAttribute("user", user);
            
            return mapping.findForward("success");
            
        } catch (NumberFormatException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE,
                new ActionMessage("user.view.error.invalidid"));
            saveErrors(request, errors);
            return mapping.findForward("error");
            
        } catch (Exception e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE,
                new ActionMessage("user.view.error.system"));
            saveErrors(request, errors);
            return mapping.findForward("error");
        }
    }
}</code></pre>

                        <h6>userView.jsp</h6>
                        <p>src/main/webapp/userView.jsp:</p>
                        <pre><code>&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
&lt;%@ taglib uri="http://struts.apache.org/tags-html" prefix="html" %&gt;
&lt;%@ taglib uri="http://struts.apache.org/tags-bean" prefix="bean" %&gt;
&lt;%@ taglib uri="http://struts.apache.org/tags-logic" prefix="logic" %&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;ユーザー詳細&lt;/title&gt;
    &lt;style&gt;
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .user-info {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .info-row {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .info-label {
            font-weight: bold;
            min-width: 120px;
            color: #333;
        }
        .info-value {
            flex: 1;
            color: #555;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn-primary {
            background-color: #f57c00;
            color: white;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .actions {
            margin-top: 30px;
            text-align: center;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;h2&gt;ユーザー詳細&lt;/h2&gt;
        
        &lt;logic:present name="user"&gt;
            &lt;div class="user-info"&gt;
                &lt;div class="info-row"&gt;
                    &lt;div class="info-label"&gt;ユーザーID:&lt;/div&gt;
                    &lt;div class="info-value"&gt;
                        &lt;bean:write name="user" property="userId"/&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="info-row"&gt;
                    &lt;div class="info-label"&gt;ユーザー名:&lt;/div&gt;
                    &lt;div class="info-value"&gt;
                        &lt;bean:write name="user" property="username"/&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="info-row"&gt;
                    &lt;div class="info-label"&gt;メールアドレス:&lt;/div&gt;
                    &lt;div class="info-value"&gt;
                        &lt;bean:write name="user" property="email"/&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="info-row"&gt;
                    &lt;div class="info-label"&gt;フルネーム:&lt;/div&gt;
                    &lt;div class="info-value"&gt;
                        &lt;bean:write name="user" property="fullName"/&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="info-row"&gt;
                    &lt;div class="info-label"&gt;生年月日:&lt;/div&gt;
                    &lt;div class="info-value"&gt;
                        &lt;logic:present name="user" property="birthDate"&gt;
                            &lt;bean:write name="user" property="birthDate" format="yyyy-MM-dd"/&gt;
                        &lt;/logic:present&gt;
                        &lt;logic:notPresent name="user" property="birthDate"&gt;
                            未設定
                        &lt;/logic:notPresent&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="info-row"&gt;
                    &lt;div class="info-label"&gt;登録日時:&lt;/div&gt;
                    &lt;div class="info-value"&gt;
                        &lt;bean:write name="user" property="createdAt" format="yyyy-MM-dd HH:mm:ss"/&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                &lt;div class="info-row"&gt;
                    &lt;div class="info-label"&gt;更新日時:&lt;/div&gt;
                    &lt;div class="info-value"&gt;
                        &lt;bean:write name="user" property="updatedAt" format="yyyy-MM-dd HH:mm:ss"/&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="actions"&gt;
                &lt;a href="userEdit.do?userId=&lt;bean:write name="user" property="userId"/&gt;" 
                   class="btn btn-primary"&gt;編集&lt;/a&gt;
                &lt;a href="javascript:void(0)" 
                   onclick="confirmDelete(&lt;bean:write name="user" property="userId"/&gt;)"
                   class="btn btn-danger"&gt;削除&lt;/a&gt;
                &lt;a href="userList.do" class="btn btn-secondary"&gt;一覧に戻る&lt;/a&gt;
            &lt;/div&gt;
        &lt;/logic:present&gt;
    &lt;/div&gt;
    
    &lt;script&gt;
        function confirmDelete(userId) {
            if (confirm('このユーザーを削除してもよろしいですか？\n削除したデータは元に戻せません。')) {
                location.href = 'userDelete.do?userId=' + userId;
            }
        }
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <!-- セクション5.2 -->
                    <h3 class="section-title" id="section5-2">5.2 ユーザー編集機能</h3>
                    <p>既存ユーザーの情報を編集するフォームを実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-2: UserEditAction実装</h5>
                        <p>ユーザー編集フォーム表示のActionクラスを作成します。</p>
                        
                        <h6>UserEditAction.java</h6>
                        <p>src/main/java/com/example/struts/action/UserEditAction.java:</p>
                        <pre><code>package com.example.struts.action;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.text.SimpleDateFormat;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.action.ActionMessages;

import com.example.struts.form.UserForm;
import com.example.struts.model.User;
import com.example.struts.service.UserService;

public class UserEditAction extends Action {
    
    private UserService userService = new UserService();
    private SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
    
    @Override
    public ActionForward execute(ActionMapping mapping,
                                ActionForm form,
                                HttpServletRequest request,
                                HttpServletResponse response) {
        
        UserForm userForm = (UserForm) form;
        
        try {
            String userIdParam = request.getParameter("userId");
            
            if (userIdParam == null || userIdParam.trim().isEmpty()) {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.edit.error.noid"));
                saveErrors(request, errors);
                return mapping.findForward("error");
            }
            
            int userId = Integer.parseInt(userIdParam);
            User user = userService.getUserById(userId);
            
            if (user == null) {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.edit.error.notfound", userIdParam));
                saveErrors(request, errors);
                return mapping.findForward("error");
            }
            
            // UserオブジェクトからUserFormに値をコピー
            userForm.setUserId(String.valueOf(user.getUserId()));
            userForm.setUsername(user.getUsername());
            userForm.setEmail(user.getEmail());
            userForm.setFullName(user.getFullName());
            
            if (user.getBirthDate() != null) {
                userForm.setBirthDate(dateFormat.format(user.getBirthDate()));
            }
            
            return mapping.findForward("success");
            
        } catch (Exception e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE,
                new ActionMessage("user.edit.error.system"));
            saveErrors(request, errors);
            return mapping.findForward("error");
        }
    }
}</code></pre>

                        <h6>userEdit.jsp</h6>
                        <p>src/main/webapp/userEdit.jsp:</p>
                        <pre><code>&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
&lt;%@ taglib uri="http://struts.apache.org/tags-html" prefix="html" %&gt;
&lt;%@ taglib uri="http://struts.apache.org/tags-bean" prefix="bean" %&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;ユーザー編集&lt;/title&gt;
    &lt;style&gt;
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #333;
        }
        input[type="text"], input[type="email"], input[type="date"] { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #ddd; 
            border-radius: 4px;
            font-size: 14px;
        }
        input:focus {
            border-color: #f57c00;
            outline: none;
        }
        .error { 
            color: #f44336; 
            font-size: 12px; 
            margin-top: 5px;
        }
        .message { 
            color: #4caf50; 
            font-weight: bold; 
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e8f5e8;
            border-radius: 4px;
        }
        .submit-btn { 
            background-color: #f57c00; 
            color: white; 
            padding: 12px 30px; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .submit-btn:hover {
            background-color: #ff9800;
        }
        .cancel-btn {
            background-color: #6c757d;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }
        .cancel-btn:hover {
            background-color: #5a6268;
        }
        .readonly {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;h2&gt;ユーザー編集&lt;/h2&gt;
        
        &lt;!-- エラーメッセージ表示 --&gt;
        &lt;html:errors/&gt;
        
        &lt;!-- ユーザー編集フォーム --&gt;
        &lt;html:form action="/userUpdate"&gt;
            &lt;!-- ユーザーIDを隠しフィールドとして送信 --&gt;
            &lt;html:hidden property="userId"/&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label&gt;ユーザーID&lt;/label&gt;
                &lt;input type="text" value="&lt;bean:write name="userForm" property="userId"/&gt;" 
                       class="readonly" readonly&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label for="username"&gt;ユーザー名 *&lt;/label&gt;
                &lt;html:text property="username" styleId="username" 
                          placeholder="3-20文字の英数字とアンダースコア"/&gt;
                &lt;html:errors property="username" styleClass="error"/&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label for="email"&gt;メールアドレス *&lt;/label&gt;
                &lt;html:text property="email" styleId="email"
                          placeholder="例: user@example.com"/&gt;
                &lt;html:errors property="email" styleClass="error"/&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label for="fullName"&gt;フルネーム *&lt;/label&gt;
                &lt;html:text property="fullName" styleId="fullName"
                          placeholder="例: 田中太郎"/&gt;
                &lt;html:errors property="fullName" styleClass="error"/&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label for="birthDate"&gt;生年月日（任意）&lt;/label&gt;
                &lt;html:text property="birthDate" styleId="birthDate"
                          placeholder="YYYY-MM-DD 形式"/&gt;
                &lt;html:errors property="birthDate" styleClass="error"/&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;html:submit styleClass="submit-btn"&gt;更新&lt;/html:submit&gt;
                &lt;a href="userView.do?userId=&lt;bean:write name="userForm" property="userId"/&gt;" 
                   class="cancel-btn"&gt;キャンセル&lt;/a&gt;
            &lt;/div&gt;
        &lt;/html:form&gt;
        
        &lt;p&gt;&lt;small&gt;* は必須項目です&lt;/small&gt;&lt;/p&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <!-- セクション5.3 -->
                    <h3 class="section-title" id="section5-3">5.3 ユーザー更新処理</h3>
                    <p>ユーザー情報の更新処理を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-3: UserUpdateAction実装</h5>
                        <p>ユーザー情報更新処理のActionクラスを作成します。</p>
                        
                        <h6>UserUpdateAction.java</h6>
                        <p>src/main/java/com/example/struts/action/UserUpdateAction.java:</p>
                        <pre><code>package com.example.struts.action;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.sql.Date;
import java.text.ParseException;
import java.text.SimpleDateFormat;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.action.ActionMessages;

import com.example.struts.form.UserForm;
import com.example.struts.model.User;
import com.example.struts.service.UserService;

public class UserUpdateAction extends Action {
    
    private UserService userService = new UserService();
    private SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
    
    @Override
    public ActionForward execute(ActionMapping mapping,
                                ActionForm form,
                                HttpServletRequest request,
                                HttpServletResponse response) {
        
        UserForm userForm = (UserForm) form;
        
        try {
            // フォームデータをUserオブジェクトに変換
            User user = new User();
            user.setUserId(Integer.parseInt(userForm.getUserId()));
            user.setUsername(userForm.getUsername().trim());
            user.setEmail(userForm.getEmail().trim());
            user.setFullName(userForm.getFullName().trim());
            
            // 生年月日の変換（任意）
            if (userForm.getBirthDate() != null && 
                !userForm.getBirthDate().trim().isEmpty()) {
                try {
                    java.util.Date parsedDate = dateFormat.parse(userForm.getBirthDate());
                    user.setBirthDate(new Date(parsedDate.getTime()));
                } catch (ParseException e) {
                    ActionMessages errors = new ActionMessages();
                    errors.add("birthDate", 
                        new ActionMessage("error.birthdate.format"));
                    saveErrors(request, errors);
                    return mapping.getInputForward();
                }
            }
            
            // ユーザー更新処理
            boolean success = userService.updateUser(user);
            
            if (success) {
                // 成功メッセージ設定
                ActionMessages messages = new ActionMessages();
                messages.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.update.success", user.getUsername()));
                saveMessages(request, messages);
                
                // 詳細画面にリダイレクト
                return new ActionForward("/userView.do?userId=" + user.getUserId(), true);
            } else {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.update.error.failed"));
                saveErrors(request, errors);
                return mapping.getInputForward();
            }
            
        } catch (Exception e) {
            // エラーハンドリング
            ActionMessages errors = new ActionMessages();
            
            if (e.getMessage() != null && 
                e.getMessage().contains("存在しません")) {
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.update.error.notfound"));
            } else {
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.update.error.system"));
            }
            
            saveErrors(request, errors);
            return mapping.getInputForward();
        }
    }
}</code></pre>
                    </div>

                    <!-- セクション5.4 -->
                    <h3 class="section-title" id="section5-4">5.4 ユーザー削除機能</h3>
                    <p>ユーザーの削除処理を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-4: UserDeleteAction実装</h5>
                        <p>ユーザー削除処理のActionクラスを作成します。</p>
                        
                        <h6>UserDeleteAction.java</h6>
                        <p>src/main/java/com/example/struts/action/UserDeleteAction.java:</p>
                        <pre><code>package com.example.struts.action;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.action.ActionMessages;

import com.example.struts.model.User;
import com.example.struts.service.UserService;

public class UserDeleteAction extends Action {
    
    private UserService userService = new UserService();
    
    @Override
    public ActionForward execute(ActionMapping mapping,
                                ActionForm form,
                                HttpServletRequest request,
                                HttpServletResponse response) {
        
        try {
            String userIdParam = request.getParameter("userId");
            
            if (userIdParam == null || userIdParam.trim().isEmpty()) {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.delete.error.noid"));
                saveErrors(request, errors);
                return mapping.findForward("error");
            }
            
            int userId = Integer.parseInt(userIdParam);
            
            // 削除前にユーザー情報を取得（ログ用）
            User user = userService.getUserById(userId);
            if (user == null) {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.delete.error.notfound", userIdParam));
                saveErrors(request, errors);
                return mapping.findForward("error");
            }
            
            // ユーザー削除処理
            boolean success = userService.deleteUser(userId);
            
            if (success) {
                // 成功メッセージ設定
                ActionMessages messages = new ActionMessages();
                messages.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.delete.success", user.getUsername()));
                saveMessages(request, messages);
                
                return mapping.findForward("success");
            } else {
                ActionMessages errors = new ActionMessages();
                errors.add(ActionMessages.GLOBAL_MESSAGE,
                    new ActionMessage("user.delete.error.failed"));
                saveErrors(request, errors);
                return mapping.findForward("error");
            }
            
        } catch (NumberFormatException e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE,
                new ActionMessage("user.delete.error.invalidid"));
            saveErrors(request, errors);
            return mapping.findForward("error");
            
        } catch (Exception e) {
            ActionMessages errors = new ActionMessages();
            errors.add(ActionMessages.GLOBAL_MESSAGE,
                new ActionMessage("user.delete.error.system"));
            saveErrors(request, errors);
            return mapping.findForward("error");
        }
    }
}</code></pre>
                    </div>

                    <!-- セクション5.5 -->
                    <h3 class="section-title" id="section5-5">5.5 設定ファイルの更新</h3>
                    <p>新しく作成したActionのマッピングとメッセージを追加します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-5: struts-config.xml とメッセージ追加</h5>
                        
                        <h6>struts-config.xml 追加設定</h6>
                        <pre><code>&lt;!-- action-mappings要素に追加 --&gt;
&lt;action-mappings&gt;
    &lt;!-- ユーザー詳細表示 --&gt;
    &lt;action path="/userView"
            type="com.example.struts.action.UserViewAction"&gt;
        &lt;forward name="success" path="/userView.jsp"/&gt;
        &lt;forward name="error" path="/error.jsp"/&gt;
    &lt;/action&gt;
    
    &lt;!-- ユーザー編集フォーム表示 --&gt;
    &lt;action path="/userEdit"
            type="com.example.struts.action.UserEditAction"
            name="userForm"
            scope="request"&gt;
        &lt;forward name="success" path="/userEdit.jsp"/&gt;
        &lt;forward name="error" path="/error.jsp"/&gt;
    &lt;/action&gt;
    
    &lt;!-- ユーザー更新処理 --&gt;
    &lt;action path="/userUpdate"
            type="com.example.struts.action.UserUpdateAction"
            name="userForm"
            scope="request"
            validate="true"
            input="/userEdit.jsp"&gt;
    &lt;/action&gt;
    
    &lt;!-- ユーザー削除処理 --&gt;
    &lt;action path="/userDelete"
            type="com.example.struts.action.UserDeleteAction"&gt;
        &lt;forward name="success" path="/userList.do" redirect="true"/&gt;
        &lt;forward name="error" path="/error.jsp"/&gt;
    &lt;/action&gt;
&lt;/action-mappings&gt;</code></pre>

                        <h6>ApplicationResources.properties 追加</h6>
                        <pre><code># ユーザー詳細関連
user.view.error.noid=ユーザーIDが指定されていません
user.view.error.notfound=指定されたユーザー(ID: {0})が見つかりません
user.view.error.invalidid=不正なユーザーIDです
user.view.error.system=ユーザー情報の取得に失敗しました

# ユーザー編集関連
user.edit.error.noid=編集対象のユーザーIDが指定されていません
user.edit.error.notfound=編集対象のユーザー(ID: {0})が見つかりません
user.edit.error.system=ユーザー編集画面の表示に失敗しました

# ユーザー更新関連
user.update.success=ユーザー「{0}」の情報を更新しました
user.update.error.failed=ユーザー情報の更新に失敗しました
user.update.error.notfound=更新対象のユーザーが見つかりません
user.update.error.system=システムエラーが発生しました

# ユーザー削除関連
user.delete.success=ユーザー「{0}」を削除しました
user.delete.error.noid=削除対象のユーザーIDが指定されていません
user.delete.error.notfound=削除対象のユーザー(ID: {0})が見つかりません
user.delete.error.invalidid=不正なユーザーIDです
user.delete.error.failed=ユーザーの削除に失敗しました
user.delete.error.system=システムエラーが発生しました</code></pre>
                    </div>

                    <!-- セクション5.6 -->
                    <h3 class="section-title" id="section5-6">5.6 CRUD統合の確認</h3>
                    <p>実装した全ての機能が正しく動作することを確認します。</p>

                    <div class="highlight">
                        <h5>完成したCRUD機能</h5>
                        <ul>
                            <li><strong>Create</strong>: userForm.do → userCreate.do</li>
                            <li><strong>Read</strong>: userList.do → userView.do</li>
                            <li><strong>Update</strong>: userEdit.do → userUpdate.do</li>
                            <li><strong>Delete</strong>: userDelete.do（確認ダイアログ付き）</li>
                        </ul>
                        
                        <h5>画面遷移フロー</h5>
                        <p>ユーザー一覧 ← → ユーザー詳細 ← → ユーザー編集<br>
                        ↓<br>
                        ユーザー登録フォーム</p>
                    </div>

                    <!-- 注意点 -->
                    <div class="warning">
                        <h5>⚠️ 実装完了後のチェック項目</h5>
                        <ul>
                            <li>全てのAction クラスがstruts-config.xmlに正しくマッピングされていること</li>
                            <li>フォームバリデーションが適切に機能すること</li>
                            <li>エラーメッセージが正しく表示されること</li>
                            <li>削除時の確認ダイアログが動作すること</li>
                            <li>成功メッセージがリダイレクト後も表示されること</li>
                            <li>各画面間のナビゲーションが正しく機能すること</li>
                        </ul>
                    </div>

                    <!-- 理解度確認（必須） -->
                    <div class="quiz-container" id="quiz">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>ユーザー詳細画面でUserオブジェクトをJSPで表示するために使用するスコープは何ですか？</li>
                            <li>編集フォームでUserオブジェクトからUserFormに値をコピーする処理はどこで行いますか？</li>
                            <li>更新処理後に詳細画面にリダイレクトするActionForwardの書き方は？</li>
                            <li>JavaScriptでの削除確認ダイアログの実装に使用する関数は何ですか？</li>
                            <li>hiddenフィールドでユーザーIDを送信するStrutsタグは何ですか？</li>
                            <li>数値型のパラメータをintに変換する際に発生する可能性がある例外は何ですか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を確認</summary>
                            <ol>
                                <li>リクエストスコープ（request.setAttribute）</li>
                                <li>UserEditActionのexecute()メソッド内</li>
                                <li>new ActionForward("/userView.do?userId=" + userId, true)</li>
                                <li>confirm()</li>
                                <li>&lt;html:hidden property="userId"/&gt;</li>
                                <li>NumberFormatException</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション（必須） -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step4-user-create-read.html" class="btn btn-secondary">← 前の章: ユーザー管理機能（CREATE, READ）</a>
                        <a href="step6-ui-security.html" class="btn btn-primary">次の章: UI改善とセキュリティ対策 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // スムーススクロール
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // サイドバーのアクティブリンク更新
        window.addEventListener('scroll', function() {
            let current = '';
            const sections = document.querySelectorAll('h3[id], div[id]');
            
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (pageYOffset >= sectionTop - 200) {
                    current = section.getAttribute('id');
                }
            });

            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>