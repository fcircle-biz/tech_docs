<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struts 1.x学習教材 第6章 - UI改善とセキュリティ対策</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション - Java生態系テーマ */
        .navbar {
            background-color: #f57c00;
        }

        .navbar-brand, .navbar-nav .nav-link {
            color: white !important;
        }

        .navbar-nav .nav-link:hover {
            color: #fff3e0 !important;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }

        .sidebar .nav-link {
            color: #495057;
            font-weight: 500;
        }

        .sidebar .nav-link:hover {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .sidebar .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        /* タイトル */
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        /* コードブロック */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Struts 1.x チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://fcircle-biz.github.io/tech_docs/">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">チュートリアル概要</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#section6-1">6.1 CSS改善</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#section6-2">6.2 JavaScript機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#section6-3">6.3 セッション管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#section6-4">6.4 CSRF対策</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#section6-5">6.5 入力サニタイゼーション</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#quiz">理解度確認</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">第6章: UI改善とセキュリティ対策</h1>
                </div>

                <div id="chapter6">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">ユーザビリティとセキュリティの向上</h2>
                    
                    <!-- 学習目標（必須） -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>CSSによるUIデザインの改善とレスポンシブ対応</li>
                            <li>JavaScriptによる動的機能の実装</li>
                            <li>セッション管理によるユーザー状態管理</li>
                            <li>CSRF攻撃に対する基本的な対策</li>
                            <li>入力値のサニタイゼーションとXSS対策</li>
                            <li>セキュアなWebアプリケーションの基本概念</li>
                        </ul>
                    </div>

                    <!-- セクション6.1 -->
                    <h3 class="section-title" id="section6-1">6.1 CSS改善とレスポンシブデザイン</h3>
                    <p>既存のCSSを改善し、より洗練されたUIとレスポンシブデザインを実装します。</p>

                    <!-- 実習（必須） -->
                    <div class="exercise-container">
                        <h5>実習 6-1: 共通CSS作成</h5>
                        <p>全画面で使用する共通CSSファイルを作成します。</p>
                        
                        <h6>common.css</h6>
                        <p>src/main/webapp/css/common.css:</p>
                        <pre><code>/* ベースレイアウト */
* {
    box-sizing: border-box;
}

body {
    font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
    line-height: 1.6;
    color: #333;
    background-color: #f8f9fa;
    margin: 0;
    padding: 0;
}

/* ヘッダー */
.header {
    background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
    color: white;
    padding: 1rem 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header h1 {
    margin: 0;
    text-align: center;
    font-size: 1.8rem;
    font-weight: 300;
}

/* コンテナ */
.container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 0 20px;
}

.content-wrapper {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* ナビゲーションバー */
.navbar {
    background-color: #fff;
    border-bottom: 1px solid #dee2e6;
    padding: 1rem 0;
}

.navbar-nav {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    justify-content: center;
}

.navbar-nav li {
    margin: 0 15px;
}

.navbar-nav a {
    text-decoration: none;
    color: #f57c00;
    font-weight: 500;
    padding: 8px 16px;
    border-radius: 20px;
    transition: all 0.3s ease;
}

.navbar-nav a:hover {
    background-color: #fff3e0;
    color: #e65100;
}

/* フォームスタイル */
.form-container {
    padding: 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #495057;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ced4da;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #f57c00;
    box-shadow: 0 0 0 3px rgba(245, 124, 0, 0.1);
}

.form-control.is-invalid {
    border-color: #dc3545;
}

/* ボタンスタイル */
.btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 500;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 0.25rem;
}

.btn-primary {
    background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #e65100 0%, #f57c00 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 124, 0, 0.3);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
}

/* テーブルスタイル */
.table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: white;
}

.table th,
.table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.table th {
    background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
}

.table tbody tr:hover {
    background-color: #fff3e0;
}

/* アラート */
.alert {
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 6px;
    border-left: 4px solid;
}

.alert-success {
    background-color: #e8f5e8;
    border-left-color: #28a745;
    color: #155724;
}

.alert-danger {
    background-color: #f8d7da;
    border-left-color: #dc3545;
    color: #721c24;
}

.alert-info {
    background-color: #d1ecf1;
    border-left-color: #17a2b8;
    color: #0c5460;
}

/* ローディング */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #f57c00;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* レスポンシブ */
@media (max-width: 768px) {
    .container {
        margin: 10px;
        padding: 0 10px;
    }
    
    .form-container {
        padding: 1rem;
    }
    
    .navbar-nav {
        flex-direction: column;
        align-items: center;
    }
    
    .navbar-nav li {
        margin: 5px 0;
    }
    
    .table {
        font-size: 0.9rem;
    }
    
    .table th,
    .table td {
        padding: 0.5rem;
    }
    
    .btn {
        width: 100%;
        margin: 0.25rem 0;
    }
}

@media (max-width: 480px) {
    .header h1 {
        font-size: 1.4rem;
    }
    
    .table {
        font-size: 0.8rem;
    }
}</code></pre>

                        <h6>改良されたuserList.jsp（抜粋）</h6>
                        <pre><code>&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
&lt;%@ taglib uri="http://struts.apache.org/tags-html" prefix="html" %&gt;
&lt;%@ taglib uri="http://struts.apache.org/tags-bean" prefix="bean" %&gt;
&lt;%@ taglib uri="http://struts.apache.org/tags-logic" prefix="logic" %&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;ユーザー一覧&lt;/title&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;link rel="stylesheet" href="css/common.css"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="header"&gt;
        &lt;h1&gt;ユーザー管理システム&lt;/h1&gt;
    &lt;/div&gt;
    
    &lt;nav class="navbar"&gt;
        &lt;ul class="navbar-nav"&gt;
            &lt;li&gt;&lt;a href="userList.do"&gt;ユーザー一覧&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href="userForm.do"&gt;新規登録&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/nav&gt;
    
    &lt;div class="container"&gt;
        &lt;div class="content-wrapper"&gt;
            &lt;div class="form-container"&gt;
                &lt;h2&gt;ユーザー一覧 (&lt;bean:write name="userCount"/&gt; 人)&lt;/h2&gt;
                
                &lt;!-- 改良されたテーブル --&gt;
                &lt;logic:notEmpty name="userList"&gt;
                    &lt;table class="table"&gt;
                        &lt;thead&gt;
                            &lt;tr&gt;
                                &lt;th&gt;ID&lt;/th&gt;
                                &lt;th&gt;ユーザー名&lt;/th&gt;
                                &lt;th&gt;メール&lt;/th&gt;
                                &lt;th&gt;フルネーム&lt;/th&gt;
                                &lt;th&gt;操作&lt;/th&gt;
                            &lt;/tr&gt;
                        &lt;/thead&gt;
                        &lt;tbody&gt;
                            &lt;logic:iterate name="userList" id="user"&gt;
                                &lt;tr&gt;
                                    &lt;td&gt;&lt;bean:write name="user" property="userId"/&gt;&lt;/td&gt;
                                    &lt;td&gt;&lt;bean:write name="user" property="username"/&gt;&lt;/td&gt;
                                    &lt;td&gt;&lt;bean:write name="user" property="email"/&gt;&lt;/td&gt;
                                    &lt;td&gt;&lt;bean:write name="user" property="fullName"/&gt;&lt;/td&gt;
                                    &lt;td&gt;
                                        &lt;a href="userView.do?userId=&lt;bean:write name="user" property="userId"/&gt;" 
                                           class="btn btn-secondary"&gt;詳細&lt;/a&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                            &lt;/logic:iterate&gt;
                        &lt;/tbody&gt;
                    &lt;/table&gt;
                &lt;/logic:notEmpty&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <!-- セクション6.2 -->
                    <h3 class="section-title" id="section6-2">6.2 JavaScriptによる動的機能</h3>
                    <p>フォームバリデーション、確認ダイアログ、非同期処理などのJavaScript機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-2: JavaScript機能実装</h5>
                        <p>ユーザビリティを向上させるJavaScript機能を追加します。</p>
                        
                        <h6>common.js</h6>
                        <p>src/main/webapp/js/common.js:</p>
                        <pre><code>// ページ読み込み完了時の初期化
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    initializeTable();
    initializeAlerts();
});

// フォーム初期化
function initializeForm() {
    // リアルタイムバリデーション
    const inputs = document.querySelectorAll('input[type="text"], input[type="email"]');
    inputs.forEach(function(input) {
        input.addEventListener('blur', function() {
            validateField(this);
        });
    });
    
    // フォーム送信前のバリデーション
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            if (!validateForm(this)) {
                e.preventDefault();
                showAlert('入力内容を確認してください。', 'danger');
            } else {
                showLoadingButton(this);
            }
        });
    });
}

// フィールドバリデーション
function validateField(field) {
    const value = field.value.trim();
    const fieldName = field.name;
    let isValid = true;
    let errorMessage = '';
    
    // 必須チェック
    if (field.hasAttribute('required') && !value) {
        isValid = false;
        errorMessage = 'この項目は必須です。';
    }
    
    // メールアドレス形式チェック
    if (fieldName === 'email' && value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
            isValid = false;
            errorMessage = 'メールアドレスの形式が正しくありません。';
        }
    }
    
    // ユーザー名形式チェック
    if (fieldName === 'username' && value) {
        const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
        if (!usernameRegex.test(value)) {
            isValid = false;
            errorMessage = 'ユーザー名は3-20文字の英数字とアンダースコアのみ使用できます。';
        }
    }
    
    // エラー表示の更新
    updateFieldError(field, isValid, errorMessage);
    
    return isValid;
}

// フォーム全体のバリデーション
function validateForm(form) {
    const inputs = form.querySelectorAll('input[type="text"], input[type="email"]');
    let isFormValid = true;
    
    inputs.forEach(function(input) {
        if (!validateField(input)) {
            isFormValid = false;
        }
    });
    
    return isFormValid;
}

// フィールドエラー表示の更新
function updateFieldError(field, isValid, errorMessage) {
    // 既存のエラーメッセージを削除
    const existingError = field.parentNode.querySelector('.field-error');
    if (existingError) {
        existingError.remove();
    }
    
    if (isValid) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
    } else {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        
        // エラーメッセージを追加
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        errorDiv.style.color = '#dc3545';
        errorDiv.style.fontSize = '0.875rem';
        errorDiv.style.marginTop = '0.25rem';
        errorDiv.textContent = errorMessage;
        field.parentNode.appendChild(errorDiv);
    }
}

// テーブル初期化
function initializeTable() {
    // ソート機能
    const headers = document.querySelectorAll('.table th[data-sort]');
    headers.forEach(function(header) {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            sortTable(this);
        });
    });
    
    // 行の選択機能
    const rows = document.querySelectorAll('.table tbody tr');
    rows.forEach(function(row) {
        row.addEventListener('click', function() {
            selectRow(this);
        });
    });
}

// テーブルソート
function sortTable(header) {
    const table = header.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const columnIndex = Array.from(header.parentNode.children).indexOf(header);
    const sortDirection = header.getAttribute('data-sort') === 'asc' ? 'desc' : 'asc';
    
    rows.sort(function(a, b) {
        const aText = a.children[columnIndex].textContent.trim();
        const bText = b.children[columnIndex].textContent.trim();
        
        if (sortDirection === 'asc') {
            return aText.localeCompare(bText, 'ja');
        } else {
            return bText.localeCompare(aText, 'ja');
        }
    });
    
    // テーブルを再構築
    rows.forEach(function(row) {
        tbody.appendChild(row);
    });
    
    // ソート方向を更新
    header.setAttribute('data-sort', sortDirection);
    
    // ソートインジケーターを更新
    headers.forEach(function(h) {
        h.classList.remove('sort-asc', 'sort-desc');
    });
    header.classList.add('sort-' + sortDirection);
}

// 行選択
function selectRow(row) {
    // 既存の選択を解除
    const selectedRows = document.querySelectorAll('.table tbody tr.selected');
    selectedRows.forEach(function(r) {
        r.classList.remove('selected');
    });
    
    // 新しい行を選択
    row.classList.add('selected');
}

// 削除確認ダイアログ
function confirmDelete(userId, username) {
    return new Promise(function(resolve) {
        const modal = createModal({
            title: '削除確認',
            message: `ユーザー「${username}」を削除してもよろしいですか？\n削除したデータは元に戻せません。`,
            buttons: [
                {
                    text: 'キャンセル',
                    class: 'btn-secondary',
                    onClick: function() {
                        resolve(false);
                    }
                },
                {
                    text: '削除',
                    class: 'btn-danger',
                    onClick: function() {
                        resolve(true);
                    }
                }
            ]
        });
        
        document.body.appendChild(modal);
        modal.style.display = 'block';
    });
}

// モーダル作成
function createModal(options) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        &lt;div class="modal-content"&gt;
            &lt;h4&gt;${options.title}&lt;/h4&gt;
            &lt;p&gt;${options.message.replace(/\n/g, '&lt;br&gt;')}&lt;/p&gt;
            &lt;div class="modal-buttons"&gt;
                ${options.buttons.map(function(btn) {
                    return `&lt;button class="btn ${btn.class}" data-action="${btn.text}"&gt;${btn.text}&lt;/button&gt;`;
                }).join('')}
            &lt;/div&gt;
        &lt;/div&gt;
    `;
    
    // ボタンイベントの設定
    options.buttons.forEach(function(btn) {
        const button = modal.querySelector(`[data-action="${btn.text}"]`);
        button.addEventListener('click', function() {
            modal.remove();
            btn.onClick();
        });
    });
    
    return modal;
}

// アラート表示
function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        ${message}
        &lt;button type="button" class="alert-close" onclick="this.parentElement.remove()"&gt;×&lt;/button&gt;
    `;
    
    // アラートをページ上部に挿入
    const container = document.querySelector('.container');
    if (container) {
        container.insertBefore(alert, container.firstChild);
        
        // 3秒後に自動で消去
        setTimeout(function() {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 3000);
    }
}

// ローディングボタン
function showLoadingButton(form) {
    const submitButton = form.querySelector('input[type="submit"], button[type="submit"]');
    if (submitButton) {
        submitButton.disabled = true;
        const originalText = submitButton.textContent || submitButton.value;
        submitButton.innerHTML = '&lt;span class="loading"&gt;&lt;/span&gt; 処理中...';
        
        // 10秒後にリセット（万が一のため）
        setTimeout(function() {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        }, 10000);
    }
}

// アラート初期化
function initializeAlerts() {
    // 既存のアラートに閉じるボタンを追加
    const alerts = document.querySelectorAll('.alert:not([data-initialized])');
    alerts.forEach(function(alert) {
        alert.setAttribute('data-initialized', 'true');
        
        if (!alert.querySelector('.alert-close')) {
            const closeButton = document.createElement('button');
            closeButton.type = 'button';
            closeButton.className = 'alert-close';
            closeButton.innerHTML = '×';
            closeButton.onclick = function() {
                alert.remove();
            };
            alert.appendChild(closeButton);
        }
        
        // 5秒後に自動で消去
        setTimeout(function() {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    });
}

// ユーティリティ関数
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(date) {
    const options = { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    };
    return new Date(date).toLocaleDateString('ja-JP', options);
}</code></pre>
                    </div>

                    <!-- セクション6.3 -->
                    <h3 class="section-title" id="section6-3">6.3 セッション管理</h3>
                    <p>ユーザーセッションの管理とセッションベースの認証機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-3: セッション管理実装</h5>
                        <p>基本的なセッション管理機能を追加します。</p>
                        
                        <h6>SessionUtil.java</h6>
                        <p>src/main/java/com/example/struts/util/SessionUtil.java:</p>
                        <pre><code>package com.example.struts.util;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import com.example.struts.model.User;

public class SessionUtil {
    
    public static final String USER_KEY = "user";
    public static final String USERNAME_KEY = "username";
    public static final String LOGIN_TIME_KEY = "loginTime";
    
    /**
     * ユーザーをセッションに保存
     */
    public static void setUser(HttpServletRequest request, User user) {
        HttpSession session = request.getSession();
        session.setAttribute(USER_KEY, user);
        session.setAttribute(USERNAME_KEY, user.getUsername());
        session.setAttribute(LOGIN_TIME_KEY, System.currentTimeMillis());
    }
    
    /**
     * セッションからユーザーを取得
     */
    public static User getUser(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            return (User) session.getAttribute(USER_KEY);
        }
        return null;
    }
    
    /**
     * セッションからユーザー名を取得
     */
    public static String getUsername(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            return (String) session.getAttribute(USERNAME_KEY);
        }
        return null;
    }
    
    /**
     * ユーザーがログインしているかチェック
     */
    public static boolean isLoggedIn(HttpServletRequest request) {
        return getUser(request) != null;
    }
    
    /**
     * セッションからユーザー情報を削除（ログアウト）
     */
    public static void logout(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.removeAttribute(USER_KEY);
            session.removeAttribute(USERNAME_KEY);
            session.removeAttribute(LOGIN_TIME_KEY);
            session.invalidate();
        }
    }
    
    /**
     * セッションタイムアウトチェック
     */
    public static boolean isSessionExpired(HttpServletRequest request, long timeoutMinutes) {
        HttpSession session = request.getSession(false);
        if (session == null) {
            return true;
        }
        
        Long loginTime = (Long) session.getAttribute(LOGIN_TIME_KEY);
        if (loginTime == null) {
            return true;
        }
        
        long currentTime = System.currentTimeMillis();
        long timeoutMillis = timeoutMinutes * 60 * 1000;
        
        return (currentTime - loginTime) > timeoutMillis;
    }
    
    /**
     * セッション情報をリフレッシュ
     */
    public static void refreshSession(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.setAttribute(LOGIN_TIME_KEY, System.currentTimeMillis());
        }
    }
}</code></pre>

                        <h6>セッションフィルター実装</h6>
                        <p>src/main/java/com/example/struts/filter/SessionFilter.java:</p>
                        <pre><code>package com.example.struts.filter;

import java.io.IOException;
import javax.servlet.*;
import javax.servlet.http.*;

import com.example.struts.util.SessionUtil;

public class SessionFilter implements Filter {
    
    private static final long SESSION_TIMEOUT_MINUTES = 30;
    
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        // フィルター初期化
    }
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        String requestURI = httpRequest.getRequestURI();
        
        // ログインページや静的リソースはチェック対象外
        if (isPublicResource(requestURI)) {
            chain.doFilter(request, response);
            return;
        }
        
        // セッションタイムアウトチェック
        if (SessionUtil.isSessionExpired(httpRequest, SESSION_TIMEOUT_MINUTES)) {
            SessionUtil.logout(httpRequest);
            httpResponse.sendRedirect(httpRequest.getContextPath() + "/login.jsp");
            return;
        }
        
        // セッション情報を更新
        if (SessionUtil.isLoggedIn(httpRequest)) {
            SessionUtil.refreshSession(httpRequest);
        }
        
        chain.doFilter(request, response);
    }
    
    private boolean isPublicResource(String requestURI) {
        return requestURI.endsWith(".css") ||
               requestURI.endsWith(".js") ||
               requestURI.endsWith(".png") ||
               requestURI.endsWith(".jpg") ||
               requestURI.endsWith(".gif") ||
               requestURI.contains("login") ||
               requestURI.contains("error");
    }
    
    @Override
    public void destroy() {
        // フィルター終了処理
    }
}</code></pre>
                    </div>

                    <!-- セクション6.4 -->
                    <h3 class="section-title" id="section6-4">6.4 CSRF対策の基本実装</h3>
                    <p>Cross-Site Request Forgery攻撃に対する基本的な対策を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-4: CSRFトークン実装</h5>
                        <p>フォームベースのCSRF対策を追加します。</p>
                        
                        <h6>CSRFUtil.java</h6>
                        <p>src/main/java/com/example/struts/util/CSRFUtil.java:</p>
                        <pre><code>package com.example.struts.util;

import java.security.SecureRandom;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

public class CSRFUtil {
    
    private static final String CSRF_TOKEN_KEY = "csrfToken";
    private static final SecureRandom secureRandom = new SecureRandom();
    
    /**
     * CSRFトークンを生成してセッションに保存
     */
    public static String generateToken(HttpServletRequest request) {
        String token = generateRandomToken();
        HttpSession session = request.getSession();
        session.setAttribute(CSRF_TOKEN_KEY, token);
        return token;
    }
    
    /**
     * CSRFトークンを検証
     */
    public static boolean validateToken(HttpServletRequest request, String token) {
        if (token == null || token.trim().isEmpty()) {
            return false;
        }
        
        HttpSession session = request.getSession(false);
        if (session == null) {
            return false;
        }
        
        String sessionToken = (String) session.getAttribute(CSRF_TOKEN_KEY);
        return token.equals(sessionToken);
    }
    
    /**
     * セッションからCSRFトークンを取得
     */
    public static String getToken(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            return (String) session.getAttribute(CSRF_TOKEN_KEY);
        }
        return null;
    }
    
    /**
     * CSRFトークンを削除
     */
    public static void removeToken(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.removeAttribute(CSRF_TOKEN_KEY);
        }
    }
    
    /**
     * ランダムトークン生成
     */
    private static String generateRandomToken() {
        byte[] bytes = new byte[32];
        secureRandom.nextBytes(bytes);
        StringBuilder sb = new StringBuilder();
        for (byte b : bytes) {
            sb.append(String.format("%02x", b));
        }
        return sb.toString();
    }
}</code></pre>

                        <h6>フォームにCSRFトークンを追加</h6>
                        <p>userForm.jsp（改良版抜粋）:</p>
                        <pre><code>&lt;%
    // CSRFトークン生成
    String csrfToken = com.example.struts.util.CSRFUtil.generateToken(request);
%&gt;

&lt;html:form action="/userCreate"&gt;
    &lt;!-- CSRFトークン --&gt;
    &lt;input type="hidden" name="csrfToken" value="&lt;%= csrfToken %&gt;"/&gt;
    
    &lt;!-- 既存のフォームフィールド --&gt;
    &lt;div class="form-group"&gt;
        &lt;label for="username" class="form-label"&gt;ユーザー名 *&lt;/label&gt;
        &lt;html:text property="username" styleId="username" 
                  styleClass="form-control" required="true"
                  placeholder="3-20文字の英数字とアンダースコア"/&gt;
        &lt;html:errors property="username" styleClass="text-danger"/&gt;
    &lt;/div&gt;
    
    &lt;!-- その他のフィールド... --&gt;
    
    &lt;div class="form-group"&gt;
        &lt;html:submit styleClass="btn btn-primary"&gt;登録&lt;/html:submit&gt;
        &lt;a href="userList.do" class="btn btn-secondary"&gt;キャンセル&lt;/a&gt;
    &lt;/div&gt;
&lt;/html:form&gt;</code></pre>

                        <h6>ActionでのCSRF検証</h6>
                        <p>UserCreateAction.java（改良版抜粋）:</p>
                        <pre><code>@Override
public ActionForward execute(ActionMapping mapping,
                            ActionForm form,
                            HttpServletRequest request,
                            HttpServletResponse response) {
    
    // CSRFトークン検証
    String csrfToken = request.getParameter("csrfToken");
    if (!CSRFUtil.validateToken(request, csrfToken)) {
        ActionMessages errors = new ActionMessages();
        errors.add(ActionMessages.GLOBAL_MESSAGE,
            new ActionMessage("error.csrf.invalid"));
        saveErrors(request, errors);
        return mapping.getInputForward();
    }
    
    // 使用済みトークンを削除
    CSRFUtil.removeToken(request);
    
    // 既存の処理...
}</code></pre>
                    </div>

                    <!-- セクション6.5 -->
                    <h3 class="section-title" id="section6-5">6.5 入力値サニタイゼーション</h3>
                    <p>XSS攻撃対策として入力値のサニタイゼーション機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-5: サニタイゼーション実装</h5>
                        <p>入力値の無害化処理を追加します。</p>
                        
                        <h6>SecurityUtil.java</h6>
                        <p>src/main/java/com/example/struts/util/SecurityUtil.java:</p>
                        <pre><code>package com.example.struts.util;

import java.util.regex.Pattern;

public class SecurityUtil {
    
    // HTMLタグを無害化するためのパターン
    private static final Pattern SCRIPT_TAG_PATTERN = 
        Pattern.compile("&lt;script[^&gt;]*&gt;.*?&lt;/script&gt;", Pattern.CASE_INSENSITIVE | Pattern.DOTALL);
    
    private static final Pattern HTML_TAG_PATTERN = 
        Pattern.compile("&lt;[^&gt;]+&gt;");
    
    // SQLインジェクション対策用パターン
    private static final Pattern SQL_INJECTION_PATTERN = 
        Pattern.compile("('.+(\\s)*(or|and|union|select|insert|update|delete|drop|create|alter)\\s)", 
                       Pattern.CASE_INSENSITIVE);
    
    /**
     * HTMLエスケープ処理
     */
    public static String escapeHtml(String input) {
        if (input == null) {
            return null;
        }
        
        return input.replace("&amp;", "&amp;amp;")
                   .replace("&lt;", "&amp;lt;")
                   .replace("&gt;", "&amp;gt;")
                   .replace("\"", "&amp;quot;")
                   .replace("'", "&amp;#x27;")
                   .replace("/", "&amp;#x2F;");
    }
    
    /**
     * JavaScriptエスケープ処理
     */
    public static String escapeJavaScript(String input) {
        if (input == null) {
            return null;
        }
        
        return input.replace("\\", "\\\\")
                   .replace("\"", "\\\"")
                   .replace("'", "\\'")
                   .replace("\n", "\\n")
                   .replace("\r", "\\r")
                   .replace("\t", "\\t");
    }
    
    /**
     * スクリプトタグを除去
     */
    public static String removeScriptTags(String input) {
        if (input == null) {
            return null;
        }
        
        return SCRIPT_TAG_PATTERN.matcher(input).replaceAll("");
    }
    
    /**
     * HTMLタグを除去
     */
    public static String removeHtmlTags(String input) {
        if (input == null) {
            return null;
        }
        
        return HTML_TAG_PATTERN.matcher(input).replaceAll("");
    }
    
    /**
     * SQLインジェクションパターンをチェック
     */
    public static boolean containsSqlInjection(String input) {
        if (input == null) {
            return false;
        }
        
        return SQL_INJECTION_PATTERN.matcher(input).find();
    }
    
    /**
     * 包括的なサニタイゼーション
     */
    public static String sanitize(String input) {
        if (input == null) {
            return null;
        }
        
        // 1. スクリプトタグを除去
        String sanitized = removeScriptTags(input);
        
        // 2. HTMLエスケープ
        sanitized = escapeHtml(sanitized);
        
        // 3. 前後の空白を除去
        sanitized = sanitized.trim();
        
        return sanitized;
    }
    
    /**
     * ファイル名のサニタイゼーション
     */
    public static String sanitizeFileName(String fileName) {
        if (fileName == null) {
            return null;
        }
        
        // 危険な文字を除去
        return fileName.replaceAll("[^a-zA-Z0-9._-]", "_");
    }
    
    /**
     * パスワード強度チェック
     */
    public static boolean isStrongPassword(String password) {
        if (password == null || password.length() &lt; 8) {
            return false;
        }
        
        boolean hasUppercase = password.matches(".*[A-Z].*");
        boolean hasLowercase = password.matches(".*[a-z].*");
        boolean hasDigit = password.matches(".*\\d.*");
        boolean hasSpecialChar = password.matches(".*[!@#$%^&amp;*(),.?\":{}|&lt;&gt;].*");
        
        return hasUppercase &amp;&amp; hasLowercase &amp;&amp; hasDigit &amp;&amp; hasSpecialChar;
    }
}</code></pre>

                        <h6>JSPでのサニタイゼーション適用</h6>
                        <p>userView.jsp（改良版抜粋）:</p>
                        <pre><code>&lt;%@ page import="com.example.struts.util.SecurityUtil" %&gt;

&lt;div class="info-row"&gt;
    &lt;div class="info-label"&gt;ユーザー名:&lt;/div&gt;
    &lt;div class="info-value"&gt;
        &lt;%= SecurityUtil.escapeHtml((String)request.getAttribute("username")) %&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
                    </div>

                    <!-- 注意点 -->
                    <div class="warning">
                        <h5>⚠️ セキュリティ実装の注意点</h5>
                        <ul>
                            <li>入力値のサニタイゼーションは出力時にも適用してください</li>
                            <li>CSRFトークンはフォーム送信後に必ず削除してください</li>
                            <li>セッションタイムアウトは環境に応じて適切に設定してください</li>
                            <li>パスワードは適切にハッシュ化して保存してください</li>
                            <li>HTTPSの使用を強く推奨します</li>
                            <li>これらは基本的な対策であり、本格的なセキュリティ対策には専門知識が必要です</li>
                        </ul>
                    </div>

                    <!-- 理解度確認（必須） -->
                    <div class="quiz-container" id="quiz">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>XSS攻撃を防ぐために入力値に対して行う処理は何ですか？</li>
                            <li>CSRF攻撃対策として一般的に使用される仕組みは何ですか？</li>
                            <li>セッションタイムアウトをチェックするタイミングはいつですか？</li>
                            <li>HTMLエスケープで「&lt;」を変換した結果は何ですか？</li>
                            <li>JavaScriptでフォームバリデーションを行う際に防ぐべき処理は何ですか？</li>
                            <li>レスポンシブデザインでよく使用されるCSSのメディアクエリは何ですか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答を確認</summary>
                            <ol>
                                <li>HTMLエスケープ（サニタイゼーション）</li>
                                <li>CSRFトークン</li>
                                <li>リクエスト処理前（フィルターなど）</li>
                                <li>&amp;lt;</li>
                                <li>フォーム送信（サーバーサイドのバリデーションが必須）</li>
                                <li>@media (max-width: XXXpx)</li>
                            </ol>
                        </details>
                    </div>

                    <!-- 章間ナビゲーション（必須） -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step5-user-update-delete.html" class="btn btn-secondary">← 前の章: ユーザー管理機能の拡張</a>
                        <a href="step7-testing-debug.html" class="btn btn-primary">次の章: テストとデバッグ →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // スムーススクロール
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // サイドバーのアクティブリンク更新
        window.addEventListener('scroll', function() {
            let current = '';
            const sections = document.querySelectorAll('h3[id], div[id]');
            
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (pageYOffset >= sectionTop - 200) {
                    current = section.getAttribute('id');
                }
            });

            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>