<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI + SQLAlchemy チュートリアル Step 7 - 基本的な検索機能とまとめ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #009688;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #009688;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #009688;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #00695c;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e0f2f1;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #009688;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .success {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #009688 !important;
            color: white !important;
        }
        
        .summary-card {
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,.1);
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">FastAPI + SQLAlchemy チュートリアル</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: データベース設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-routing-templates.html">Step 3: ルーティングとテンプレート</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-registration.html">Step 4: ユーザー登録機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">Step 5: ユーザー一覧と詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">Step 6: 編集と削除</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step7-search-summary.html">Step 7: 検索機能とまとめ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 7: 基本的な検索機能とまとめ</h1>
                </div>

                <div id="step7">
                    <h2 class="chapter-title">7. 基本的な検索機能とまとめ</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>検索フォームの実装方法</li>
                            <li>LIKE演算子を使った曖昧検索</li>
                            <li>検索結果の表示とハイライト</li>
                            <li>チュートリアルの総復習</li>
                            <li>今後の学習ロードマップ</li>
                        </ul>
                    </div>

                    <p>最後の章では、ユーザー名による検索機能を実装し、これまで学習した内容を総復習します。また、今後の発展的な学習についても解説します。</p>

                    <h3 class="section-title">7.1 検索機能の実装</h3>
                    
                    <p>ユーザー名による検索機能をユーザー一覧ページに追加します。</p>

                    <div class="exercise-container">
                        <h5>実習 7-1: 検索フォームの追加</h5>
                        <p><code>templates/user_list.html</code>に検索フォームを追加します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>ユーザー一覧ページのヘッダー部分に検索フォームを追加</li>
                            <li>検索キーワードのハイライト機能を実装</li>
                        </ol>
                        
                        <h6>コード例 - user_list.htmlの更新</h6>
                        <pre class="code-block"><code class="language-html">&lt;!-- ページタイトルの後、メッセージ表示の後に追加 --&gt;
&lt;div class="row mb-4"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;form method="get" action="/users"&gt;
            &lt;div class="input-group"&gt;
                &lt;input type="text" class="form-control" name="search" 
                       placeholder="ユーザー名で検索..." 
                       value="{{ search_query or '' }}"&gt;
                &lt;button class="btn btn-outline-primary" type="submit"&gt;
                    &lt;i class="bi bi-search"&gt;&lt;/i&gt; 検索
                &lt;/button&gt;
                {% if search_query %}
                    &lt;a href="/users" class="btn btn-outline-secondary"&gt;クリア&lt;/a&gt;
                {% endif %}
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/div&gt;
    &lt;div class="col-md-6 text-end"&gt;
        &lt;a href="/register" class="btn btn-primary"&gt;新規登録&lt;/a&gt;
        &lt;a href="/" class="btn btn-secondary"&gt;トップページ&lt;/a&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- 検索結果の表示 --&gt;
{% if search_query %}
    &lt;div class="alert alert-info"&gt;
        &lt;strong&gt;検索結果:&lt;/strong&gt; 「{{ search_query }}」で検索しました
        {% if users %}
            （{{ users|length }}件見つかりました）
        {% else %}
            （該当するユーザーが見つかりませんでした）
        {% endif %}
    &lt;/div&gt;
{% endif %}</code></pre>
                        
                        <h6>ポイント解説</h6>
                        <ul>
                            <li><strong>GETメソッド</strong>: 検索はGETリクエストで実装</li>
                            <li><strong>value="{{ search_query or '' }}"</strong>: 検索キーワードを維持</li>
                            <li><strong>条件表示</strong>: 検索時のみクリアボタンと検索結果を表示</li>
                        </ul>
                    </div>

                    <h3 class="section-title">7.2 検索ルートの実装</h3>
                    
                    <p><code>main.py</code>のユーザー一覧ルートを更新して検索機能を追加します。</p>

                    <div class="exercise-container">
                        <h5>実習 7-2: 検索機能付きユーザー一覧の実装</h5>
                        <p>既存のユーザー一覧ルートに検索機能を追加します。</p>
                        
                        <h6>コード例 - main.pyの更新</h6>
                        <pre class="code-block"><code class="language-python"># 既存のインポートに追加
from typing import Optional

# ユーザー一覧表示（検索機能付き）を更新
@app.get("/users", response_class=HTMLResponse)
async def list_users(
    request: Request, 
    search: Optional[str] = None,
    db: Session = Depends(get_db)
):
    """ユーザー一覧を表示（検索機能付き）"""
    
    # 基本クエリ
    query = db.query(User)
    
    # 検索クエリがある場合はフィルタリング
    if search and search.strip():
        search_term = f"%{search.strip()}%"
        query = query.filter(
            User.username.like(search_term) |
            User.full_name.like(search_term) |
            User.email.like(search_term)
        )
    
    # 結果を取得（作成日時の降順）
    users = query.order_by(User.created_at.desc()).all()
    
    return templates.TemplateResponse(
        "user_list.html",
        {
            "request": request, 
            "users": users,
            "search_query": search.strip() if search else None
        }
    )</code></pre>
                        
                        <h6>ポイント解説</h6>
                        <ul>
                            <li><strong>Optional[str]</strong>: 検索パラメータは任意</li>
                            <li><strong>LIKE演算子</strong>: 部分一致検索</li>
                            <li><strong>OR条件（|）</strong>: 複数フィールドでの検索</li>
                            <li><strong>%ワイルドカード</strong>: 前後に任意の文字を許可</li>
                        </ul>
                    </div>

                    <h3 class="section-title">7.3 検索結果のハイライト機能</h3>
                    
                    <p>検索キーワードを結果内でハイライト表示する機能を追加します。</p>

                    <div class="exercise-container">
                        <h5>実習 7-3: 検索結果ハイライトの実装</h5>
                        <p>Jinja2フィルターを使って検索キーワードをハイライト表示します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>カスタムフィルター関数を作成</li>
                            <li>テンプレートでハイライト機能を使用</li>
                        </ol>
                        
                        <h6>コード例 - main.pyにカスタムフィルター追加</h6>
                        <pre class="code-block"><code class="language-python">import re
from markupsafe import Markup

def highlight_search(text, search_term):
    """検索キーワードをハイライト表示するフィルター"""
    if not search_term or not text:
        return text
    
    # 大文字小文字を無視して検索・置換
    pattern = re.compile(re.escape(search_term), re.IGNORECASE)
    highlighted = pattern.sub(
        lambda m: f'&lt;mark class="bg-warning"&gt;{m.group()}&lt;/mark&gt;',
        str(text)
    )
    return Markup(highlighted)

# Jinja2にカスタムフィルターを追加
templates.env.filters['highlight'] = highlight_search</code></pre>
                        
                        <h6>コード例 - user_list.htmlでのハイライト使用</h6>
                        <pre class="code-block"><code class="language-html">&lt;!-- テーブル内のユーザー情報表示部分を更新 --&gt;
&lt;td&gt;{{ user.username|highlight(search_query)|safe }}&lt;/td&gt;
&lt;td&gt;{{ user.email|highlight(search_query)|safe }}&lt;/td&gt;
&lt;td&gt;{{ user.full_name|highlight(search_query)|safe }}&lt;/td&gt;</code></pre>
                        
                        <h6>スタイル追加 - CSSでハイライト色を調整</h6>
                        <pre class="code-block"><code class="language-css">mark.bg-warning {
    background-color: #fff3cd !important;
    color: #856404;
    padding: 0.1em 0.2em;
    border-radius: 0.2em;
}</code></pre>
                    </div>

                    <h3 class="section-title">7.4 検索機能の動作確認</h3>
                    
                    <div class="exercise-container">
                        <h5>実習 7-4: 検索機能のテスト</h5>
                        <p>実装した検索機能が正常に動作することを確認します。</p>
                        
                        <h6>テスト手順</h6>
                        <ol>
                            <li>複数のユーザーを登録（異なる名前、メールアドレス）</li>
                            <li>ユーザー一覧ページで検索フォームを確認</li>
                            <li>部分的なユーザー名で検索</li>
                            <li>メールアドレスの一部で検索</li>
                            <li>氏名の一部で検索</li>
                            <li>存在しないキーワードで検索</li>
                            <li>検索結果のハイライト表示を確認</li>
                            <li>「クリア」ボタンで検索をリセット</li>
                        </ol>
                        
                        <h6>確認ポイント</h6>
                        <ul>
                            <li><strong>部分一致</strong>: キーワードの一部でも検索される</li>
                            <li><strong>複数フィールド</strong>: ユーザー名、メール、氏名すべてで検索</li>
                            <li><strong>ハイライト表示</strong>: 検索キーワードが強調表示される</li>
                            <li><strong>検索結果数</strong>: 適切な件数が表示される</li>
                        </ul>
                    </div>

                    <h3 class="section-title">7.5 チュートリアル総まとめ</h3>
                    
                    <div class="success">
                        <h5>🎉 チュートリアル完了！</h5>
                        <p>おめでとうございます！FastAPI + SQLAlchemy + Jinja2を使用したWebアプリケーション開発の基礎を習得しました。</p>
                    </div>

                    <h4>習得した技術スキル</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card summary-card">
                                <div class="card-header bg-primary text-white">
                                    <h6>🐍 Python Web開発</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>FastAPIフレームワーク</li>
                                        <li>非同期プログラミング基礎</li>
                                        <li>依存性注入パターン</li>
                                        <li>HTTPメソッドの使い分け</li>
                                        <li>エラーハンドリング</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card summary-card">
                                <div class="card-header bg-success text-white">
                                    <h6>🗄️ データベース操作</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>SQLAlchemy ORM</li>
                                        <li>モデル定義とマイグレーション</li>
                                        <li>CRUD操作の実装</li>
                                        <li>クエリ操作とフィルタリング</li>
                                        <li>PostgreSQL連携</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card summary-card">
                                <div class="card-header bg-info text-white">
                                    <h6>🎨 フロントエンド開発</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>Jinja2テンプレートエンジン</li>
                                        <li>Bootstrap 5レスポンシブデザイン</li>
                                        <li>フォーム処理とバリデーション</li>
                                        <li>動的コンテンツ表示</li>
                                        <li>ユーザーインターフェース設計</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card summary-card">
                                <div class="card-header bg-warning text-dark">
                                    <h6>⚙️ アプリケーション開発</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>プロジェクト構造設計</li>
                                        <li>環境構築と依存関係管理</li>
                                        <li>静的ファイル配信</li>
                                        <li>検索機能の実装</li>
                                        <li>ユーザビリティ向上</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="section-title">7.6 今後の学習ロードマップ</h3>
                    
                    <p>このチュートリアルで基礎を習得したあとは、以下の分野に進むことを推奨します：</p>

                    <div class="exercise-container">
                        <h5>📈 レベル2: 中級スキル</h5>
                        <h6>セキュリティと認証</h6>
                        <ul>
                            <li><strong>JWT認証</strong>: ユーザー認証システムの実装</li>
                            <li><strong>OAuth 2.0</strong>: GoogleやGitHubログインの実装</li>
                            <li><strong>CSRF保護</strong>: セキュリティ対策の強化</li>
                            <li><strong>パスワードハッシュ化</strong>: bcryptによる安全なパスワード管理</li>
                        </ul>
                        
                        <h6>API開発</h6>
                        <ul>
                            <li><strong>RESTful API</strong>: JSON APIの設計と実装</li>
                            <li><strong>OpenAPI/Swagger</strong>: API仕様書の自動生成</li>
                            <li><strong>API認証</strong>: APIキーやトークン認証</li>
                            <li><strong>レート制限</strong>: API使用量の制御</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>🚀 レベル3: 上級スキル</h5>
                        <h6>パフォーマンスと最適化</h6>
                        <ul>
                            <li><strong>非同期処理</strong>: async/awaitの活用</li>
                            <li><strong>データベース最適化</strong>: インデックスとクエリチューニング</li>
                            <li><strong>キャッシュ</strong>: RedisやMemcachedの活用</li>
                            <li><strong>負荷分散</strong>: 複数サーバでの運用</li>
                        </ul>
                        
                        <h6>テストとCI/CD</h6>
                        <ul>
                            <li><strong>単体テスト</strong>: pytestによる自動テスト</li>
                            <li><strong>統合テスト</strong>: APIエンドポイントのテスト</li>
                            <li><strong>GitHub Actions</strong>: 継続的インテグレーション</li>
                            <li><strong>Docker</strong>: コンテナ化と運用</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>☁️ レベル4: 本格運用</h5>
                        <h6>デプロイとインフラ</h6>
                        <ul>
                            <li><strong>AWS/GCP</strong>: クラウドサービスでのデプロイ</li>
                            <li><strong>Kubernetes</strong>: コンテナオーケストレーション</li>
                            <li><strong>監視とログ</strong>: アプリケーション監視システム</li>
                            <li><strong>スケーリング</strong>: 負荷に応じた自動スケーリング</li>
                        </ul>
                        
                        <h6>高度な機能</h6>
                        <ul>
                            <li><strong>WebSocket</strong>: リアルタイム通信</li>
                            <li><strong>タスクキュー</strong>: CeleryやRQによる非同期処理</li>
                            <li><strong>マイクロサービス</strong>: サービス分割アーキテクチャ</li>
                            <li><strong>GraphQL</strong>: 柔軟なAPI設計</li>
                        </ul>
                    </div>

                    <h3 class="section-title">7.7 推奨学習リソース</h3>
                    
                    <div class="highlight">
                        <h6>📚 公式ドキュメント</h6>
                        <ul>
                            <li><a href="https://fastapi.tiangolo.com/" target="_blank">FastAPI公式ドキュメント</a> - 最新機能と詳細な説明</li>
                            <li><a href="https://docs.sqlalchemy.org/" target="_blank">SQLAlchemy公式ドキュメント</a> - 高度なORM機能</li>
                            <li><a href="https://jinja.palletsprojects.com/" target="_blank">Jinja2公式ドキュメント</a> - テンプレートの高度な機能</li>
                        </ul>
                        
                        <h6>🛠️ 実践プロジェクト例</h6>
                        <ul>
                            <li><strong>ブログシステム</strong>: 記事の投稿・編集・コメント機能</li>
                            <li><strong>ECサイト</strong>: 商品管理・ショッピングカート・決済</li>
                            <li><strong>SNSアプリ</strong>: ユーザーフォロー・投稿・いいね機能</li>
                            <li><strong>API サービス</strong>: 外部システム連携のAPI開発</li>
                        </ul>
                    </div>

                    <h3 class="section-title">7.8 完成したアプリケーションの確認</h3>
                    
                    <div class="success">
                        <h6>✨ 完成したSimple User Manager</h6>
                        <p>このチュートリアルで以下の機能を持つアプリケーションが完成しました：</p>
                        <ol>
                            <li><strong>ユーザー登録</strong> - 新規ユーザーの作成</li>
                            <li><strong>ユーザー一覧</strong> - 登録済みユーザーの表示</li>
                            <li><strong>ユーザー詳細</strong> - 個別ユーザー情報の表示</li>
                            <li><strong>ユーザー編集</strong> - 既存情報の更新</li>
                            <li><strong>ユーザー削除</strong> - 安全な削除機能</li>
                            <li><strong>検索機能</strong> - キーワードによる検索</li>
                        </ol>
                    </div>

                    <!-- 最終確認クイズ -->
                    <div class="quiz-container">
                        <h5>🎯 最終確認クイズ</h5>
                        <ol>
                            <li>FastAPIでクエリパラメータを受け取る際に使用する型アノテーションは何ですか？</li>
                            <li>SQLAlchemyでLIKE検索を行う際のメソッド名は何ですか？</li>
                            <li>Jinja2でカスタムフィルターを適用する記法を書いてください。</li>
                            <li>このチュートリアルで実装したCRUD操作を4つ挙げてください。</li>
                            <li>検索結果をハイライト表示するために使用したHTMLタグは何ですか？</li>
                        </ol>
                        
                        <details class="mt-3">
                            <summary>解答例</summary>
                            <ol>
                                <li><code>Optional[str]</code></li>
                                <li><code>like()</code></li>
                                <li><code>{{ variable|filter_name(parameter) }}</code></li>
                                <li>Create（登録）、Read（読み取り）、Update（更新）、Delete（削除）</li>
                                <li><code>&lt;mark&gt;</code></li>
                            </ol>
                        </details>
                    </div>

                    <div class="success">
                        <h5>🏆 チュートリアル完了証明</h5>
                        <p><strong>あなたはFastAPI + SQLAlchemy + Jinja2チュートリアルを完了しました！</strong></p>
                        <p>15時間の学習を通じて、モダンなPython Webアプリケーション開発の基礎をしっかりと習得されました。この知識を活かして、さらに高度なアプリケーション開発にチャレンジしてください。</p>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step6-user-update-delete.html" class="btn btn-secondary">← Step 6: 編集と削除</a>
                        <a href="../../../README.md" class="btn btn-success">メインページに戻る 🎉</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>