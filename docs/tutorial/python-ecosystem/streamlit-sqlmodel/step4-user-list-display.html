<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel チュートリアル Step 4 - ユーザー一覧とデータ表示</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0066cc;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0066cc;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #3399ff;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0066cc;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0066cc !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e6f2ff;
        }

        /* コードブロック */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }
        
        .code-block {
            background-color: #1e1e1e !important;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            border: none !important;
        }
        
        .code-block code {
            background-color: transparent !important;
            color: #ffffff;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }

        .img-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* テーブルスタイル */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* データフレームスタイル */
        .dataframe-container {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #dee2e6;
            margin: 1rem 0;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="../streamlit-sqlmodel/README.html">Streamlit + SQLModel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                        Streamlit + SQLModel チュートリアル
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: データベース設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">Step 3: ユーザー登録機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#step4">Step 4: ユーザー一覧表示</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">Step 5: CRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-security-deployment.html">Step 6: セキュリティとデプロイ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 4: ユーザー一覧とデータ表示</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="badge bg-info">所要時間: 2.5時間</span>
                        </div>
                    </div>
                </div>

                <div id="step4">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">データフレーム表示と検索機能の実装</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Streamlitデータフレーム表示機能の活用</li>
                            <li>検索・フィルタリング機能の実装</li>
                            <li>Pandasとの連携によるデータ処理</li>
                            <li>リアルタイムデータ更新とキャッシュ機能</li>
                            <li>レスポンシブなテーブル表示</li>
                            <li>ユーザー体験を向上させるUI設計</li>
                        </ul>
                    </div>

                    <!-- セクション1: Streamlitデータ表示 -->
                    <h3 class="section-title">4.1 Streamlitのデータ表示機能</h3>
                    <p>Streamlitは、Pandasデータフレームを美しく表示するための豊富な機能を提供しています。インタラクティブなテーブル、フィルタリング、ソート機能を簡単に実装できます。</p>

                    <div class="info">
                        <h6>Streamlitデータ表示コンポーネント</h6>
                        <ul>
                            <li><strong>st.dataframe()</strong>: インタラクティブなデータフレーム表示</li>
                            <li><strong>st.table()</strong>: 静的なテーブル表示</li>
                            <li><strong>st.data_editor()</strong>: 編集可能なデータテーブル</li>
                            <li><strong>st.column_config</strong>: カラム設定とカスタマイズ</li>
                            <li><strong>st.metric()</strong>: メトリクス表示</li>
                        </ul>
                    </div>

                    <h4>データ表示コンポーネントの比較</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>コンポーネント</th>
                                    <th>特徴</th>
                                    <th>用途</th>
                                    <th>インタラクティブ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>st.dataframe()</td>
                                    <td>スクロール、ソート、フィルタ対応</td>
                                    <td>大量データの表示</td>
                                    <td>✅ あり</td>
                                </tr>
                                <tr>
                                    <td>st.table()</td>
                                    <td>シンプルな静的表示</td>
                                    <td>小さなデータセット</td>
                                    <td>❌ なし</td>
                                </tr>
                                <tr>
                                    <td>st.data_editor()</td>
                                    <td>セル編集、行の追加・削除</td>
                                    <td>データの直接編集</td>
                                    <td>✅ あり（編集可能）</td>
                                </tr>
                                <tr>
                                    <td>st.column_config</td>
                                    <td>カラムタイプとスタイル設定</td>
                                    <td>表示のカスタマイズ</td>
                                    <td>✅ あり（設定）</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- セクション2: データ取得とキャッシュ -->
                    <h3 class="section-title">4.2 データ取得とキャッシュ機能</h3>
                    
                    <p>効率的なデータ取得とキャッシュ機能を実装し、パフォーマンスを向上させます。</p>

                    <div class="exercise-container">
                        <h5>実習 4-1: データ取得機能とキャッシュの実装</h5>
                        <p>ユーザーデータの効率的な取得とキャッシュ機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>データ取得用のヘルパー関数作成</li>
                            <li>Streamlitキャッシュ機能の実装</li>
                            <li>Pandasデータフレーム変換</li>
                            <li>データ更新とキャッシュクリア機能</li>
                            <li>エラーハンドリングとフォールバック</li>
                        </ol>

                        <h6>app/utils/data_manager.py作成</h6>
                        <pre><code>"""
データ管理機能
データ取得、キャッシュ、Pandas変換など
"""

import streamlit as st
import pandas as pd
from typing import List, Optional, Dict, Any
from datetime import datetime, timedelta
import logging

from app.database.connection import get_db_session
from app.database.crud import user_crud
from app.models.user import User, UserSearch

logger = logging.getLogger(__name__)

class DataManager:
    """データ管理クラス"""
    
    @staticmethod
    @st.cache_data(ttl=300)  # 5分間キャッシュ
    def get_users_cached(
        limit: int = 100,
        search_params: Optional[Dict[str, Any]] = None
    ) -> pd.DataFrame:
        """
        ユーザーデータを取得（キャッシュ付き）
        
        Args:
            limit: 取得件数上限
            search_params: 検索パラメータ
            
        Returns:
            ユーザーデータのDataFrame
        """
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            # 検索条件の準備
            search = None
            if search_params:
                search = UserSearch(**search_params)
            
            # ユーザーデータ取得
            users = user_crud.get_users(
                session=session,
                limit=limit,
                search=search
            )
            
            # DataFrameに変換
            if not users:
                # 空のDataFrameを返す
                return pd.DataFrame(columns=[
                    'ID', 'ユーザー名', 'メールアドレス', '氏名', 
                    '年齢', '部署', 'ステータス', '作成日時', '更新日時'
                ])
            
            # データ変換
            data = []
            for user in users:
                data.append({
                    'ID': user.id,
                    'ユーザー名': user.username,
                    'メールアドレス': user.email,
                    '氏名': user.full_name,
                    '年齢': user.age if user.age is not None else '',
                    '部署': user.department or '',
                    'ステータス': 'アクティブ' if user.is_active else '非アクティブ',
                    '作成日時': user.created_at.strftime('%Y-%m-%d %H:%M'),
                    '更新日時': user.updated_at.strftime('%Y-%m-%d %H:%M'),
                    '_raw_data': user  # 元データを保持（内部使用）
                })
            
            df = pd.DataFrame(data)
            session.close()
            
            logger.info(f"✅ ユーザーデータ取得成功: {len(df)}件")
            return df
            
        except Exception as e:
            logger.error(f"❌ ユーザーデータ取得エラー: {e}")
            # エラー時は空のDataFrameを返す
            return pd.DataFrame(columns=[
                'ID', 'ユーザー名', 'メールアドレス', '氏名', 
                '年齢', '部署', 'ステータス', '作成日時', '更新日時'
            ])
    
    @staticmethod
    @st.cache_data(ttl=60)  # 1分間キャッシュ
    def get_user_statistics() -> Dict[str, Any]:
        """
        ユーザー統計情報を取得（キャッシュ付き）
        
        Returns:
            統計情報辞書
        """
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            stats = user_crud.get_user_stats(session)
            
            # 辞書形式に変換
            stats_dict = {
                'total_users': stats.total_users,
                'active_users': stats.active_users,
                'inactive_users': stats.inactive_users,
                'average_age': stats.average_age,
                'departments': stats.departments,
                'last_updated': datetime.now()
            }
            
            session.close()
            logger.info("✅ 統計情報取得成功")
            return stats_dict
            
        except Exception as e:
            logger.error(f"❌ 統計情報取得エラー: {e}")
            return {
                'total_users': 0,
                'active_users': 0,
                'inactive_users': 0,
                'average_age': None,
                'departments': [],
                'last_updated': datetime.now()
            }
    
    @staticmethod
    def clear_cache():
        """キャッシュをクリア"""
        DataManager.get_users_cached.clear()
        DataManager.get_user_statistics.clear()
        st.cache_data.clear()
        logger.info("✅ キャッシュクリア完了")
    
    @staticmethod
    def filter_dataframe(
        df: pd.DataFrame, 
        filters: Dict[str, Any]
    ) -> pd.DataFrame:
        """
        DataFrameをフィルタリング
        
        Args:
            df: 元のDataFrame
            filters: フィルター条件
            
        Returns:
            フィルターされたDataFrame
        """
        if df.empty:
            return df
        
        filtered_df = df.copy()
        
        try:
            # テキスト検索（複数列対象）
            if filters.get('search_text'):
                search_text = filters['search_text'].lower()
                mask = (
                    filtered_df['ユーザー名'].str.lower().str.contains(search_text, na=False) |
                    filtered_df['メールアドレス'].str.lower().str.contains(search_text, na=False) |
                    filtered_df['氏名'].str.lower().str.contains(search_text, na=False) |
                    filtered_df['部署'].str.lower().str.contains(search_text, na=False)
                )
                filtered_df = filtered_df[mask]
            
            # 部署フィルター
            if filters.get('department') and filters['department'] != '全て':
                filtered_df = filtered_df[
                    filtered_df['部署'] == filters['department']
                ]
            
            # ステータスフィルター
            if filters.get('status') and filters['status'] != '全て':
                filtered_df = filtered_df[
                    filtered_df['ステータス'] == filters['status']
                ]
            
            # 年齢範囲フィルター
            if filters.get('min_age') is not None:
                # 空文字列を除外
                age_mask = filtered_df['年齢'] != ''
                if age_mask.any():
                    filtered_df = filtered_df[
                        age_mask & (pd.to_numeric(filtered_df['年齢'], errors='coerce') >= filters['min_age'])
                    ]
            
            if filters.get('max_age') is not None:
                age_mask = filtered_df['年齢'] != ''
                if age_mask.any():
                    filtered_df = filtered_df[
                        age_mask & (pd.to_numeric(filtered_df['年齢'], errors='coerce') <= filters['max_age'])
                    ]
            
            return filtered_df
            
        except Exception as e:
            logger.error(f"❌ DataFrameフィルタリングエラー: {e}")
            return df
    
    @staticmethod
    def get_unique_departments(df: pd.DataFrame) -> List[str]:
        """DataFrameから一意の部署リストを取得"""
        if df.empty:
            return []
        
        departments = df['部署'].dropna().unique()
        departments = [dept for dept in departments if dept.strip()]
        return sorted(departments)
    
    @staticmethod
    def export_to_csv(df: pd.DataFrame) -> bytes:
        """DataFrameをCSV形式でエクスポート"""
        try:
            # 内部データ列を除外
            export_df = df.drop(columns=['_raw_data'], errors='ignore')
            
            # CSV形式でエンコード
            csv_data = export_df.to_csv(index=False, encoding='utf-8-sig')
            return csv_data.encode('utf-8-sig')
            
        except Exception as e:
            logger.error(f"❌ CSVエクスポートエラー: {e}")
            raise

class DisplayHelper:
    """表示用ヘルパークラス"""
    
    @staticmethod
    def configure_dataframe_display() -> Dict[str, Any]:
        """
        データフレーム表示設定を取得
        
        Returns:
            カラム設定辞書
        """
        return {
            "ID": st.column_config.NumberColumn(
                "ID",
                help="ユーザーID",
                format="%d",
                width="small"
            ),
            "ユーザー名": st.column_config.TextColumn(
                "ユーザー名",
                help="ユーザーの識別名",
                width="medium"
            ),
            "メールアドレス": st.column_config.TextColumn(
                "メールアドレス",
                help="ユーザーのメールアドレス",
                width="large"
            ),
            "氏名": st.column_config.TextColumn(
                "氏名",
                help="ユーザーの本名",
                width="medium"
            ),
            "年齢": st.column_config.NumberColumn(
                "年齢",
                help="ユーザーの年齢",
                format="%d歳",
                width="small"
            ),
            "部署": st.column_config.TextColumn(
                "部署",
                help="所属部署",
                width="medium"
            ),
            "ステータス": st.column_config.TextColumn(
                "ステータス",
                help="アカウント状態",
                width="small"
            ),
            "作成日時": st.column_config.DatetimeColumn(
                "作成日時",
                help="アカウント作成日時",
                format="YYYY-MM-DD HH:mm",
                width="medium"
            ),
            "更新日時": st.column_config.DatetimeColumn(
                "更新日時",
                help="最終更新日時",
                format="YYYY-MM-DD HH:mm",
                width="medium"
            )
        }
    
    @staticmethod
    def style_dataframe(df: pd.DataFrame) -> pd.DataFrame:
        """
        DataFrameにスタイルを適用
        
        Args:
            df: 元のDataFrame
            
        Returns:
            スタイル適用済みDataFrame
        """
        if df.empty:
            return df
        
        # 表示用のコピーを作成
        styled_df = df.copy()
        
        # 内部データ列を除外
        if '_raw_data' in styled_df.columns:
            styled_df = styled_df.drop(columns=['_raw_data'])
        
        return styled_df</code></pre>

                        <h6>期待される結果</h6>
                        <p>データ取得とキャッシュ機能が実装され、効率的なデータ処理が可能になることを確認してください。</p>
                    </div>

                    <!-- セクション3: ユーザー一覧画面 -->
                    <h3 class="section-title">4.3 ユーザー一覧画面の実装</h3>
                    
                    <p>検索・フィルタリング機能付きのユーザー一覧画面を作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-2: ユーザー一覧画面の作成</h5>
                        <p>インタラクティブなユーザー一覧表示機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>検索・フィルター UI の作成</li>
                            <li>データフレーム表示の実装</li>
                            <li>リアルタイム検索機能</li>
                            <li>統計情報ダッシュボード</li>
                            <li>データエクスポート機能</li>
                        </ol>

                        <h6>メインアプリケーションの更新</h6>
                        <pre><code># app/main.pyに以下の機能を追加

from utils.data_manager import DataManager, DisplayHelper
from utils.validators import get_valid_departments

def show_user_list():
    """ユーザー一覧表示画面"""
    
    st.header("👥 ユーザー一覧")
    st.markdown("登録されたユーザーの一覧表示と検索機能")
    
    # 統計情報の表示
    show_user_dashboard()
    
    st.markdown("---")
    
    # 検索・フィルター セクション
    with st.expander("🔍 検索・フィルター", expanded=True):
        search_col1, search_col2, search_col3 = st.columns(3)
        
        with search_col1:
            # テキスト検索
            search_text = st.text_input(
                "🔍 キーワード検索",
                placeholder="ユーザー名、メール、氏名、部署で検索...",
                help="複数の項目を横断して検索します"
            )
        
        with search_col2:
            # 部署フィルター
            departments = get_valid_departments()
            department_filter = st.selectbox(
                "🏢 部署",
                options=['全て'] + departments,
                help="特定の部署でフィルター"
            )
        
        with search_col3:
            # ステータスフィルター
            status_filter = st.selectbox(
                "📊 ステータス",
                options=['全て', 'アクティブ', '非アクティブ'],
                help="アカウント状態でフィルター"
            )
        
        # 年齢範囲フィルター
        age_col1, age_col2 = st.columns(2)
        with age_col1:
            min_age = st.number_input(
                "最小年齢",
                min_value=0,
                max_value=150,
                value=None,
                help="年齢の下限"
            )
        
        with age_col2:
            max_age = st.number_input(
                "最大年齢",
                min_value=0,
                max_value=150,
                value=None,
                help="年齢の上限"
            )
    
    # フィルター条件の準備
    filters = {
        'search_text': search_text,
        'department': department_filter,
        'status': status_filter,
        'min_age': min_age,
        'max_age': max_age
    }
    
    # データ取得とフィルタリング
    with st.spinner("データを読み込み中..."):
        # 全ユーザーデータを取得
        all_users_df = DataManager.get_users_cached(limit=1000)
        
        # フィルタリング適用
        filtered_df = DataManager.filter_dataframe(all_users_df, filters)
    
    # 結果情報の表示
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric(
            "表示件数",
            len(filtered_df),
            delta=len(filtered_df) - len(all_users_df) if len(all_users_df) > 0 else 0
        )
    
    with col2:
        st.metric(
            "総登録数",
            len(all_users_df)
        )
    
    with col3:
        if st.button("🔄 データ更新"):
            DataManager.clear_cache()
            st.rerun()
    
    # データ表示
    if not filtered_df.empty:
        # カラム設定
        column_config = DisplayHelper.configure_dataframe_display()
        
        # データフレーム表示
        st.subheader("📋 ユーザーデータ")
        
        # スタイル適用
        display_df = DisplayHelper.style_dataframe(filtered_df)
        
        # インタラクティブデータフレーム
        st.dataframe(
            display_df,
            column_config=column_config,
            hide_index=True,
            use_container_width=True,
            height=400
        )
        
        # データエクスポート
        st.markdown("---")
        export_col1, export_col2 = st.columns([3, 1])
        
        with export_col2:
            if st.button("📥 CSVダウンロード", use_container_width=True):
                try:
                    csv_data = DataManager.export_to_csv(display_df)
                    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                    filename = f"user_list_{timestamp}.csv"
                    
                    st.download_button(
                        label="📥 ダウンロード開始",
                        data=csv_data,
                        file_name=filename,
                        mime="text/csv",
                        use_container_width=True
                    )
                    st.success("✅ CSVファイル準備完了")
                    
                except Exception as e:
                    st.error(f"❌ エクスポートエラー: {e}")
        
        with export_col1:
            st.info(f"💡 現在のフィルター条件で {len(display_df)} 件のデータを表示中")
    
    else:
        # データが見つからない場合
        st.warning("🔍 検索条件に一致するユーザーが見つかりませんでした")
        
        if any(filters.values()):
            st.info("💡 検索条件を変更して再度お試しください")
            
            if st.button("🗑️ フィルターをリセット"):
                st.rerun()
        else:
            st.info("👤 まずはユーザーを登録してください")

def show_user_dashboard():
    """ユーザー統計ダッシュボード"""
    
    # 統計データ取得
    stats = DataManager.get_user_statistics()
    
    st.subheader("📊 ユーザー統計ダッシュボード")
    
    # メトリクス表示
    metric_col1, metric_col2, metric_col3, metric_col4 = st.columns(4)
    
    with metric_col1:
        st.metric(
            "総ユーザー数",
            stats['total_users'],
            help="登録されているユーザーの総数"
        )
    
    with metric_col2:
        st.metric(
            "アクティブユーザー",
            stats['active_users'],
            delta=f"{stats['active_users'] / max(stats['total_users'], 1) * 100:.1f}%"
        )
    
    with metric_col3:
        st.metric(
            "非アクティブユーザー",
            stats['inactive_users'],
            delta=f"{stats['inactive_users'] / max(stats['total_users'], 1) * 100:.1f}%"
        )
    
    with metric_col4:
        avg_age_display = f"{stats['average_age']:.1f}歳" if stats['average_age'] else "未設定"
        st.metric(
            "平均年齢",
            avg_age_display,
            help="年齢を入力したユーザーの平均年齢"
        )
    
    # 部署情報
    if stats['departments']:
        st.markdown("**📂 登録されている部署:**")
        dept_cols = st.columns(min(len(stats['departments']), 4))
        
        for i, dept in enumerate(stats['departments']):
            with dept_cols[i % 4]:
                st.info(f"🏢 {dept}")
    
    # 最終更新時刻
    st.caption(f"最終更新: {stats['last_updated'].strftime('%Y-%m-%d %H:%M:%S')}")

# main()関数内のページ選択を更新
def main():
    # ... 既存のコード ...
    
    # サイドバーのページ選択を更新
    with st.sidebar:
        st.header("📋 メニュー")
        
        page = st.radio(
            "ページを選択:",
            ["🏠 ホーム", "👤 ユーザー登録", "👥 ユーザー一覧", "📊 統計情報"],
            index=0  # デフォルトでホームを選択
        )
    
    # メインコンテンツのページ分岐を更新
    if page == "👥 ユーザー一覧":
        show_user_list()
    elif page == "📊 統計情報":
        show_user_dashboard()
    # ... 既存のページ処理 ...</code></pre>

                        <h6>期待される結果</h6>
                        <p>検索・フィルタリング機能付きのユーザー一覧画面が正常に動作し、インタラクティブなデータ表示が実現されることを確認してください。</p>
                    </div>

                    <!-- セクション4: 検索機能の詳細実装 -->
                    <h3 class="section-title">4.4 高度な検索機能の実装</h3>
                    
                    <p>より使いやすい検索機能とリアルタイムフィルタリングを実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-3: 高度な検索機能の追加</h5>
                        <p>リアルタイム検索、ファセット検索、保存された検索条件などの高度な機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>リアルタイム検索の実装</li>
                            <li>検索条件の保存・復元機能</li>
                            <li>検索履歴の管理</li>
                            <li>高度な検索オプション</li>
                            <li>検索パフォーマンスの最適化</li>
                        </ol>

                        <h6>app/utils/search_manager.py作成</h6>
                        <pre><code>"""
検索管理機能
高度な検索、フィルタリング、検索履歴管理
"""

import streamlit as st
import pandas as pd
from typing import Dict, Any, List, Optional
from datetime import datetime
import json

class SearchManager:
    """検索機能管理クラス"""
    
    @staticmethod
    def initialize_search_state():
        """検索状態を初期化"""
        if 'search_history' not in st.session_state:
            st.session_state.search_history = []
        
        if 'saved_searches' not in st.session_state:
            st.session_state.saved_searches = {}
        
        if 'current_search' not in st.session_state:
            st.session_state.current_search = {}
    
    @staticmethod
    def save_search_condition(name: str, conditions: Dict[str, Any]):
        """検索条件を保存"""
        st.session_state.saved_searches[name] = {
            'conditions': conditions,
            'created_at': datetime.now(),
            'description': SearchManager._generate_search_description(conditions)
        }
    
    @staticmethod
    def load_search_condition(name: str) -> Optional[Dict[str, Any]]:
        """検索条件を読み込み"""
        return st.session_state.saved_searches.get(name, {}).get('conditions')
    
    @staticmethod
    def delete_search_condition(name: str):
        """検索条件を削除"""
        if name in st.session_state.saved_searches:
            del st.session_state.saved_searches[name]
    
    @staticmethod
    def add_search_history(conditions: Dict[str, Any]):
        """検索履歴に追加"""
        # 空の条件は履歴に追加しない
        if not any(v for v in conditions.values() if v):
            return
        
        history_item = {
            'conditions': conditions,
            'timestamp': datetime.now(),
            'description': SearchManager._generate_search_description(conditions)
        }
        
        # 重複する検索は履歴に追加しない
        for item in st.session_state.search_history:
            if item['conditions'] == conditions:
                return
        
        st.session_state.search_history.insert(0, history_item)
        
        # 履歴は最新20件まで保持
        if len(st.session_state.search_history) > 20:
            st.session_state.search_history = st.session_state.search_history[:20]
    
    @staticmethod
    def _generate_search_description(conditions: Dict[str, Any]) -> str:
        """検索条件の説明文を生成"""
        descriptions = []
        
        if conditions.get('search_text'):
            descriptions.append(f"キーワード: {conditions['search_text']}")
        
        if conditions.get('department') and conditions['department'] != '全て':
            descriptions.append(f"部署: {conditions['department']}")
        
        if conditions.get('status') and conditions['status'] != '全て':
            descriptions.append(f"ステータス: {conditions['status']}")
        
        if conditions.get('min_age') is not None:
            descriptions.append(f"最小年齢: {conditions['min_age']}歳")
        
        if conditions.get('max_age') is not None:
            descriptions.append(f"最大年齢: {conditions['max_age']}歳")
        
        return " | ".join(descriptions) if descriptions else "全ての条件"
    
    @staticmethod
    def show_search_management():
        """検索管理UIを表示"""
        st.subheader("🔍 検索管理")
        
        # タブで機能を分割
        tab1, tab2, tab3 = st.tabs(["💾 検索条件保存", "📋 保存済み検索", "📚 検索履歴"])
        
        with tab1:
            SearchManager._show_save_search_ui()
        
        with tab2:
            SearchManager._show_saved_searches_ui()
        
        with tab3:
            SearchManager._show_search_history_ui()
    
    @staticmethod
    def _show_save_search_ui():
        """検索条件保存UIを表示"""
        st.markdown("**現在の検索条件を保存**")
        
        current_search = st.session_state.get('current_search', {})
        
        if not any(v for v in current_search.values() if v):
            st.info("💡 検索条件を設定してから保存してください")
            return
        
        # 現在の検索条件表示
        description = SearchManager._generate_search_description(current_search)
        st.write(f"**条件:** {description}")
        
        # 保存名入力
        save_name = st.text_input(
            "保存名",
            placeholder="例: 営業部のアクティブユーザー",
            help="検索条件を識別するための名前"
        )
        
        if st.button("💾 保存", disabled=not save_name):
            SearchManager.save_search_condition(save_name, current_search)
            st.success(f"✅ 検索条件 '{save_name}' を保存しました")
            st.rerun()
    
    @staticmethod
    def _show_saved_searches_ui():
        """保存済み検索UIを表示"""
        saved_searches = st.session_state.get('saved_searches', {})
        
        if not saved_searches:
            st.info("💡 保存された検索条件はありません")
            return
        
        st.markdown("**保存済み検索条件**")
        
        for name, search_data in saved_searches.items():
            with st.expander(f"🔍 {name}"):
                st.write(f"**条件:** {search_data['description']}")
                st.write(f"**保存日:** {search_data['created_at'].strftime('%Y-%m-%d %H:%M')}")
                
                col1, col2 = st.columns(2)
                
                with col1:
                    if st.button(f"🔄 適用", key=f"apply_{name}"):
                        # 検索条件を現在の条件として設定
                        st.session_state.current_search = search_data['conditions']
                        st.success(f"✅ 検索条件 '{name}' を適用しました")
                        st.rerun()
                
                with col2:
                    if st.button(f"🗑️ 削除", key=f"delete_{name}"):
                        SearchManager.delete_search_condition(name)
                        st.success(f"✅ 検索条件 '{name}' を削除しました")
                        st.rerun()
    
    @staticmethod
    def _show_search_history_ui():
        """検索履歴UIを表示"""
        history = st.session_state.get('search_history', [])
        
        if not history:
            st.info("💡 検索履歴はありません")
            return
        
        st.markdown("**最近の検索**")
        
        for i, item in enumerate(history[:10]):  # 最新10件のみ表示
            with st.expander(f"🕐 {item['timestamp'].strftime('%m/%d %H:%M')} - {item['description'][:50]}..."):
                st.write(f"**検索条件:** {item['description']}")
                st.write(f"**検索時刻:** {item['timestamp'].strftime('%Y-%m-%d %H:%M:%S')}")
                
                if st.button(f"🔄 再実行", key=f"history_{i}"):
                    st.session_state.current_search = item['conditions']
                    st.success("✅ 検索条件を再適用しました")
                    st.rerun()
        
        # 履歴クリアボタン
        if st.button("🗑️ 履歴をクリア"):
            st.session_state.search_history = []
            st.success("✅ 検索履歴をクリアしました")
            st.rerun()

class AdvancedFilter:
    """高度なフィルタリング機能"""
    
    @staticmethod
    def create_dynamic_filters(df: pd.DataFrame) -> Dict[str, Any]:
        """
        データに基づいて動的なフィルターを作成
        
        Args:
            df: 対象のDataFrame
            
        Returns:
            フィルター設定辞書
        """
        if df.empty:
            return {}
        
        filters = {}
        
        # 部署の動的リスト
        unique_departments = df['部署'].dropna().unique()
        unique_departments = [dept for dept in unique_departments if dept.strip()]
        filters['departments'] = sorted(unique_departments)
        
        # 年齢の範囲
        ages = pd.to_numeric(df['年齢'], errors='coerce').dropna()
        if not ages.empty:
            filters['age_range'] = {
                'min': int(ages.min()),
                'max': int(ages.max()),
                'avg': float(ages.mean())
            }
        
        # 作成日の範囲
        if '作成日時' in df.columns:
            dates = pd.to_datetime(df['作成日時'], errors='coerce').dropna()
            if not dates.empty:
                filters['date_range'] = {
                    'start': dates.min(),
                    'end': dates.max()
                }
        
        return filters
    
    @staticmethod
    def show_advanced_search_options():
        """高度な検索オプションを表示"""
        with st.expander("⚙️ 高度な検索オプション"):
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("**検索モード**")
                search_mode = st.radio(
                    "検索方法",
                    ["部分一致", "完全一致", "前方一致", "後方一致"],
                    help="キーワード検索の一致方法を選択"
                )
                
                case_sensitive = st.checkbox(
                    "大文字小文字を区別",
                    help="検索時の大文字小文字の扱い"
                )
            
            with col2:
                st.markdown("**表示オプション**")
                show_inactive = st.checkbox(
                    "非アクティブユーザーを表示",
                    value=True,
                    help="非アクティブなユーザーも表示"
                )
                
                items_per_page = st.selectbox(
                    "表示件数",
                    [10, 25, 50, 100, "全て"],
                    index=3,
                    help="一度に表示する件数"
                )
            
            return {
                'search_mode': search_mode,
                'case_sensitive': case_sensitive,
                'show_inactive': show_inactive,
                'items_per_page': items_per_page
            }</code></pre>

                        <h6>検索機能の統合更新</h6>
                        <pre><code># main.pyのshow_user_list()関数を更新

from utils.search_manager import SearchManager, AdvancedFilter

def show_user_list():
    """ユーザー一覧表示画面（検索機能強化版）"""
    
    # 検索状態初期化
    SearchManager.initialize_search_state()
    
    st.header("👥 ユーザー一覧")
    st.markdown("登録されたユーザーの一覧表示と高度な検索機能")
    
    # 統計情報の表示
    show_user_dashboard()
    
    st.markdown("---")
    
    # 検索管理UI
    with st.expander("⚙️ 検索管理", expanded=False):
        SearchManager.show_search_management()
    
    # メイン検索セクション
    with st.container():
        st.subheader("🔍 検索・フィルター")
        
        # 基本検索
        search_col1, search_col2 = st.columns([3, 1])
        
        with search_col1:
            search_text = st.text_input(
                "キーワード検索",
                value=st.session_state.current_search.get('search_text', ''),
                placeholder="ユーザー名、メール、氏名、部署で検索...",
                help="複数の項目を横断して検索します"
            )
        
        with search_col2:
            if st.button("🔍 検索実行", use_container_width=True):
                # 現在の検索条件を履歴に追加
                current_conditions = {
                    'search_text': search_text,
                    'department': st.session_state.current_search.get('department', '全て'),
                    'status': st.session_state.current_search.get('status', '全て'),
                    'min_age': st.session_state.current_search.get('min_age'),
                    'max_age': st.session_state.current_search.get('max_age')
                }
                SearchManager.add_search_history(current_conditions)
        
        # フィルター設定
        filter_col1, filter_col2, filter_col3 = st.columns(3)
        
        with filter_col1:
            departments = get_valid_departments()
            department_filter = st.selectbox(
                "部署",
                options=['全て'] + departments,
                index=0 if not st.session_state.current_search.get('department') 
                      else (['全て'] + departments).index(st.session_state.current_search.get('department', '全て'))
            )
        
        with filter_col2:
            status_options = ['全て', 'アクティブ', '非アクティブ']
            status_filter = st.selectbox(
                "ステータス",
                options=status_options,
                index=status_options.index(st.session_state.current_search.get('status', '全て'))
            )
        
        with filter_col3:
            # リセットボタン
            if st.button("🗑️ フィルターリセット"):
                st.session_state.current_search = {}
                st.rerun()
        
        # 年齢範囲
        age_col1, age_col2 = st.columns(2)
        with age_col1:
            min_age = st.number_input(
                "最小年齢",
                min_value=0,
                max_value=150,
                value=st.session_state.current_search.get('min_age'),
                help="年齢の下限"
            )
        
        with age_col2:
            max_age = st.number_input(
                "最大年齢", 
                min_value=0,
                max_value=150,
                value=st.session_state.current_search.get('max_age'),
                help="年齢の上限"
            )
        
        # 高度な検索オプション
        advanced_options = AdvancedFilter.show_advanced_search_options()
    
    # 現在の検索条件を保存
    st.session_state.current_search = {
        'search_text': search_text,
        'department': department_filter,
        'status': status_filter,
        'min_age': min_age,
        'max_age': max_age,
        **advanced_options
    }
    
    # データ取得とフィルタリング
    with st.spinner("データを読み込み中..."):
        all_users_df = DataManager.get_users_cached(limit=1000)
        filtered_df = DataManager.filter_dataframe(all_users_df, st.session_state.current_search)
    
    # 結果表示
    st.markdown("---")
    display_search_results(all_users_df, filtered_df)

def display_search_results(all_df: pd.DataFrame, filtered_df: pd.DataFrame):
    """検索結果を表示"""
    
    # 結果サマリー
    result_col1, result_col2, result_col3, result_col4 = st.columns(4)
    
    with result_col1:
        st.metric("表示件数", len(filtered_df))
    
    with result_col2:
        st.metric("総登録数", len(all_df))
    
    with result_col3:
        if len(all_df) > 0:
            match_rate = len(filtered_df) / len(all_df) * 100
            st.metric("一致率", f"{match_rate:.1f}%")
    
    with result_col4:
        if st.button("🔄 データ更新"):
            DataManager.clear_cache()
            st.rerun()
    
    # データ表示
    if not filtered_df.empty:
        # データフレーム表示
        st.subheader("📋 検索結果")
        
        column_config = DisplayHelper.configure_dataframe_display()
        display_df = DisplayHelper.style_dataframe(filtered_df)
        
        # ページネーション対応
        items_per_page = st.session_state.current_search.get('items_per_page', 100)
        if items_per_page != "全て" and len(display_df) > items_per_page:
            page = st.selectbox(
                "ページ",
                range(1, (len(display_df) // items_per_page) + 2),
                format_func=lambda x: f"ページ {x}"
            )
            start_idx = (page - 1) * items_per_page
            end_idx = start_idx + items_per_page
            display_df = display_df.iloc[start_idx:end_idx]
        
        st.dataframe(
            display_df,
            column_config=column_config,
            hide_index=True,
            use_container_width=True,
            height=400
        )
        
        # エクスポート機能
        show_export_options(display_df)
    
    else:
        st.warning("🔍 検索条件に一致するユーザーが見つかりませんでした")
        
        if st.button("💡 検索のヒントを表示"):
            show_search_tips()

def show_export_options(df: pd.DataFrame):
    """エクスポートオプションを表示"""
    st.markdown("---")
    st.subheader("📥 データエクスポート")
    
    export_col1, export_col2, export_col3 = st.columns(3)
    
    with export_col1:
        if st.button("📄 CSV形式", use_container_width=True):
            try:
                csv_data = DataManager.export_to_csv(df)
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                filename = f"user_list_{timestamp}.csv"
                
                st.download_button(
                    label="📥 CSVダウンロード",
                    data=csv_data,
                    file_name=filename,
                    mime="text/csv",
                    use_container_width=True
                )
                st.success("✅ CSVファイル準備完了")
            except Exception as e:
                st.error(f"❌ エクスポートエラー: {e}")
    
    with export_col2:
        st.info("📊 Excel形式（今後実装予定）")
    
    with export_col3:
        st.info("📋 PDF形式（今後実装予定）")

def show_search_tips():
    """検索のヒントを表示"""
    with st.expander("💡 検索のヒント", expanded=True):
        st.markdown("""
        **効果的な検索方法:**
        
        1. **キーワード検索**:
           - 部分一致で検索されます
           - 複数の項目（ユーザー名、メール、氏名、部署）を同時に検索
           - 大文字小文字は区別されません
        
        2. **フィルターの組み合わせ**:
           - 複数のフィルターを組み合わせて絞り込み可能
           - 年齢範囲とステータスを組み合わせると効果的
        
        3. **保存機能の活用**:
           - よく使う検索条件は保存して再利用
           - 検索履歴から過去の検索を再実行
        
        4. **データの更新**:
           - 新しく登録されたユーザーが表示されない場合は「データ更新」を実行
        """)
</code></pre>

                        <h6>期待される結果</h6>
                        <p>高度な検索機能が実装され、検索条件の保存・復元、検索履歴、ページネーションなどが正常に動作することを確認してください。</p>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>st.dataframe()</strong>と<strong>st.table()</strong>の違いを3つ挙げてください。</li>
                            <li><strong>@st.cache_data</strong>デコレータの目的と注意点を説明してください。</li>
                            <li><strong>Pandasデータフレーム</strong>をStreamlitで表示する際の最適化方法を3つ挙げてください。</li>
                            <li><strong>検索機能</strong>でユーザビリティを向上させる要素を4つ挙げてください。</li>
                            <li><strong>st.column_config</strong>を使用する利点を説明してください。</li>
                            <li><strong>データフィルタリング</strong>でパフォーマンスを考慮すべき点を3つ挙げてください。</li>
                            <li><strong>CSVエクスポート機能</strong>で考慮すべきセキュリティ要素を2つ挙げてください。</li>
                            <li><strong>リアルタイム更新</strong>と<strong>キャッシュ機能</strong>のバランスの取り方を説明してください。</li>
                        </ol>
                        
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>st.dataframe()はインタラクティブ、大量データ対応、カスタマイズ可能。st.table()は静的、小データ向け、シンプル表示</li>
                                <li>データベースアクセスの負荷軽減が目的。データ更新時のキャッシュクリア、TTL設定、メモリ使用量に注意</li>
                                <li>適切なTTL設定、列の型指定、不要な列の除外、ページネーション実装</li>
                                <li>リアルタイム検索、複数条件フィルター、検索履歴、保存機能、検索結果ハイライト</li>
                                <li>列の表示制御、データ型の適切な表示、幅調整、ヘルプテキスト追加、ユーザビリティ向上</li>
                                <li>インデックス活用、適切なクエリ設計、フィルター順序の最適化、データ量の制限</li>
                                <li>個人情報の除外、アクセス権限の確認、ファイル名の適切な設定、ダウンロード履歴の記録</li>
                                <li>データの更新頻度とキャッシュTTLの適切な設定、手動更新オプションの提供、ユーザーへの更新状況の通知</li>
                            </ol>
                        </details>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">4.5 Step 4のまとめ</h3>
                    
                    <div class="highlight">
                        <h5>Step 4で習得したスキル</h5>
                        <ul>
                            <li>Streamlitデータフレーム表示機能の活用</li>
                            <li>高度な検索・フィルタリング機能の実装</li>
                            <li>キャッシュ機能によるパフォーマンス最適化</li>
                            <li>Pandasとの連携データ処理</li>
                            <li>検索条件の保存・復元機能</li>
                            <li>ユーザビリティを重視したUI設計</li>
                            <li>データエクスポート機能の実装</li>
                            <li>検索履歴とセッション管理</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>次のStepに進む前に確認すること</h6>
                        <ul>
                            <li>✅ ユーザー一覧が正常に表示される</li>
                            <li>✅ 検索・フィルタリング機能が動作する</li>
                            <li>✅ キャッシュ機能が適切に動作する</li>
                            <li>✅ 検索条件の保存・復元ができる</li>
                            <li>✅ 検索履歴が管理される</li>
                            <li>✅ データエクスポートが可能である</li>
                            <li>✅ 統計情報ダッシュボードが表示される</li>
                            <li>✅ パフォーマンスが適切である</li>
                        </ul>
                    </div>

                    <div class="info">
                        <h6>発展的な学習のヒント</h6>
                        <ul>
                            <li><strong>データ可視化</strong>: Plotly、Altairを使用したグラフ表示</li>
                            <li><strong>高度なフィルタリング</strong>: 範囲選択、日付フィルター</li>
                            <li><strong>バッチ操作</strong>: 複数ユーザーの一括操作</li>
                            <li><strong>データ分析</strong>: 統計分析、トレンド表示</li>
                            <li><strong>リアルタイム機能</strong>: WebSocketを使用した自動更新</li>
                        </ul>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step3-user-registration.html" class="btn btn-secondary">← Step 3: ユーザー登録機能</a>
                        <a href="step5-user-crud-operations.html" class="btn btn-primary">Step 5: CRUD操作 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>