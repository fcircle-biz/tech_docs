<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« Step 4 - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .navbar {
            background-color: #0066cc;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ« */
        .chapter-title {
            color: #0066cc;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #3399ff;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒœãƒƒã‚¯ã‚¹ */
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0066cc;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav-link.active {
            background-color: #0066cc !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e6f2ff;
        }

        /* ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }
        
        .code-block {
            background-color: #1e1e1e !important;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            border: none !important;
        }
        
        .code-block code {
            background-color: transparent !important;
            color: #ffffff;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }

        .img-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .dataframe-container {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #dee2e6;
            margin: 1rem 0;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ãƒ›ãƒ¼ãƒ </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="../streamlit-sqlmodel/README.html">Streamlit + SQLModel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                        Streamlit + SQLModel ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: ç’°å¢ƒæ§‹ç¯‰</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#step4">Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">Step 5: CRUDæ“ä½œ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-security-deployment.html">Step 6: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‡ãƒ—ãƒ­ã‚¤</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- ç« ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="badge bg-info">æ‰€è¦æ™‚é–“: 2.5æ™‚é–“</span>
                        </div>
                    </div>
                </div>

                <div id="step4">
                    <!-- ç« ã‚¿ã‚¤ãƒˆãƒ« -->
                    <h2 class="chapter-title">ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤ºã¨æ¤œç´¢æ©Ÿèƒ½ã®å®Ÿè£…</h2>
                    
                    <!-- å­¦ç¿’ç›®æ¨™ -->
                    <div class="highlight">
                        <h5>ã“ã®ç« ã§å­¦ã¶ã“ã¨</h5>
                        <ul>
                            <li>Streamlitãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤ºæ©Ÿèƒ½ã®æ´»ç”¨</li>
                            <li>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>Pandasã¨ã®é€£æºã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å‡¦ç†</li>
                            <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½</li>
                            <li>ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º</li>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å‘ä¸Šã•ã›ã‚‹UIè¨­è¨ˆ</li>
                        </ul>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: Streamlitãƒ‡ãƒ¼ã‚¿è¡¨ç¤º -->
                    <h3 class="section-title">4.1 Streamlitã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºæ©Ÿèƒ½</h3>
                    <p>Streamlitã¯ã€Pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ç¾ã—ãè¡¨ç¤ºã™ã‚‹ãŸã‚ã®è±Šå¯Œãªæ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ãƒ¼ãƒ–ãƒ«ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚</p>

                    <div class="info">
                        <h6>Streamlitãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</h6>
                        <ul>
                            <li><strong>st.dataframe()</strong>: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤º</li>
                            <li><strong>st.table()</strong>: é™çš„ãªãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º</li>
                            <li><strong>st.data_editor()</strong>: ç·¨é›†å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«</li>
                            <li><strong>st.column_config</strong>: ã‚«ãƒ©ãƒ è¨­å®šã¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</li>
                            <li><strong>st.metric()</strong>: ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º</li>
                        </ul>
                    </div>

                    <h4>ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ¯”è¼ƒ</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</th>
                                    <th>ç‰¹å¾´</th>
                                    <th>ç”¨é€”</th>
                                    <th>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>st.dataframe()</td>
                                    <td>ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã€ã‚½ãƒ¼ãƒˆã€ãƒ•ã‚£ãƒ«ã‚¿å¯¾å¿œ</td>
                                    <td>å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º</td>
                                    <td>âœ… ã‚ã‚Š</td>
                                </tr>
                                <tr>
                                    <td>st.table()</td>
                                    <td>ã‚·ãƒ³ãƒ—ãƒ«ãªé™çš„è¡¨ç¤º</td>
                                    <td>å°ã•ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ</td>
                                    <td>âŒ ãªã—</td>
                                </tr>
                                <tr>
                                    <td>st.data_editor()</td>
                                    <td>ã‚»ãƒ«ç·¨é›†ã€è¡Œã®è¿½åŠ ãƒ»å‰Šé™¤</td>
                                    <td>ãƒ‡ãƒ¼ã‚¿ã®ç›´æ¥ç·¨é›†</td>
                                    <td>âœ… ã‚ã‚Šï¼ˆç·¨é›†å¯èƒ½ï¼‰</td>
                                </tr>
                                <tr>
                                    <td>st.column_config</td>
                                    <td>ã‚«ãƒ©ãƒ ã‚¿ã‚¤ãƒ—ã¨ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š</td>
                                    <td>è¡¨ç¤ºã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</td>
                                    <td>âœ… ã‚ã‚Šï¼ˆè¨­å®šï¼‰</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ -->
                    <h3 class="section-title">4.2 ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½</h3>
                    
                    <p>åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 4-1: ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å®Ÿè£…</h5>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åŠ¹ç‡çš„ãªå–å¾—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ä½œæˆ</li>
                            <li>Streamlitã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>Pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ å¤‰æ›</li>
                            <li>ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ©Ÿèƒ½</li>
                            <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯</li>
                        </ol>

                        <h6>app/utils/data_manager.pyä½œæˆ</h6>
                        <pre><code>"""
ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½
ãƒ‡ãƒ¼ã‚¿å–å¾—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€Pandaså¤‰æ›ãªã©
"""

import streamlit as st
import pandas as pd
from typing import List, Optional, Dict, Any
from datetime import datetime, timedelta
import logging

from app.database.connection import get_db_session
from app.database.crud import user_crud
from app.models.user import User, UserSearch

logger = logging.getLogger(__name__)

class DataManager:
    """ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    @st.cache_data(ttl=300)  # 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    def get_users_cached(
        limit: int = 100,
        search_params: Optional[Dict[str, Any]] = None
    ) -> pd.DataFrame:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãï¼‰
        
        Args:
            limit: å–å¾—ä»¶æ•°ä¸Šé™
            search_params: æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            
        Returns:
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®DataFrame
        """
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            # æ¤œç´¢æ¡ä»¶ã®æº–å‚™
            search = None
            if search_params:
                search = UserSearch(**search_params)
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
            users = user_crud.get_users(
                session=session,
                limit=limit,
                search=search
            )
            
            # DataFrameã«å¤‰æ›
            if not users:
                # ç©ºã®DataFrameã‚’è¿”ã™
                return pd.DataFrame(columns=[
                    'ID', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'æ°å', 
                    'å¹´é½¢', 'éƒ¨ç½²', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'ä½œæˆæ—¥æ™‚', 'æ›´æ–°æ—¥æ™‚'
                ])
            
            # ãƒ‡ãƒ¼ã‚¿å¤‰æ›
            data = []
            for user in users:
                data.append({
                    'ID': user.id,
                    'ãƒ¦ãƒ¼ã‚¶ãƒ¼å': user.username,
                    'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹': user.email,
                    'æ°å': user.full_name,
                    'å¹´é½¢': user.age if user.age is not None else '',
                    'éƒ¨ç½²': user.department or '',
                    'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' if user.is_active else 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–',
                    'ä½œæˆæ—¥æ™‚': user.created_at.strftime('%Y-%m-%d %H:%M'),
                    'æ›´æ–°æ—¥æ™‚': user.updated_at.strftime('%Y-%m-%d %H:%M'),
                    '_raw_data': user  # å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
                })
            
            df = pd.DataFrame(data)
            session.close()
            
            logger.info(f"âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: {len(df)}ä»¶")
            return df
            
        except Exception as e:
            logger.error(f"âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºã®DataFrameã‚’è¿”ã™
            return pd.DataFrame(columns=[
                'ID', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'æ°å', 
                'å¹´é½¢', 'éƒ¨ç½²', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'ä½œæˆæ—¥æ™‚', 'æ›´æ–°æ—¥æ™‚'
            ])
    
    @staticmethod
    @st.cache_data(ttl=60)  # 1åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    def get_user_statistics() -> Dict[str, Any]:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãï¼‰
        
        Returns:
            çµ±è¨ˆæƒ…å ±è¾æ›¸
        """
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            stats = user_crud.get_user_stats(session)
            
            # è¾æ›¸å½¢å¼ã«å¤‰æ›
            stats_dict = {
                'total_users': stats.total_users,
                'active_users': stats.active_users,
                'inactive_users': stats.inactive_users,
                'average_age': stats.average_age,
                'departments': stats.departments,
                'last_updated': datetime.now()
            }
            
            session.close()
            logger.info("âœ… çµ±è¨ˆæƒ…å ±å–å¾—æˆåŠŸ")
            return stats_dict
            
        except Exception as e:
            logger.error(f"âŒ çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return {
                'total_users': 0,
                'active_users': 0,
                'inactive_users': 0,
                'average_age': None,
                'departments': [],
                'last_updated': datetime.now()
            }
    
    @staticmethod
    def clear_cache():
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢"""
        DataManager.get_users_cached.clear()
        DataManager.get_user_statistics.clear()
        st.cache_data.clear()
        logger.info("âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†")
    
    @staticmethod
    def filter_dataframe(
        df: pd.DataFrame, 
        filters: Dict[str, Any]
    ) -> pd.DataFrame:
        """
        DataFrameã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        
        Args:
            df: å…ƒã®DataFrame
            filters: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
            
        Returns:
            ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚ŒãŸDataFrame
        """
        if df.empty:
            return df
        
        filtered_df = df.copy()
        
        try:
            # ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ï¼ˆè¤‡æ•°åˆ—å¯¾è±¡ï¼‰
            if filters.get('search_text'):
                search_text = filters['search_text'].lower()
                mask = (
                    filtered_df['ãƒ¦ãƒ¼ã‚¶ãƒ¼å'].str.lower().str.contains(search_text, na=False) |
                    filtered_df['ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹'].str.lower().str.contains(search_text, na=False) |
                    filtered_df['æ°å'].str.lower().str.contains(search_text, na=False) |
                    filtered_df['éƒ¨ç½²'].str.lower().str.contains(search_text, na=False)
                )
                filtered_df = filtered_df[mask]
            
            # éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if filters.get('department') and filters['department'] != 'å…¨ã¦':
                filtered_df = filtered_df[
                    filtered_df['éƒ¨ç½²'] == filters['department']
                ]
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if filters.get('status') and filters['status'] != 'å…¨ã¦':
                filtered_df = filtered_df[
                    filtered_df['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] == filters['status']
                ]
            
            # å¹´é½¢ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if filters.get('min_age') is not None:
                # ç©ºæ–‡å­—åˆ—ã‚’é™¤å¤–
                age_mask = filtered_df['å¹´é½¢'] != ''
                if age_mask.any():
                    filtered_df = filtered_df[
                        age_mask & (pd.to_numeric(filtered_df['å¹´é½¢'], errors='coerce') >= filters['min_age'])
                    ]
            
            if filters.get('max_age') is not None:
                age_mask = filtered_df['å¹´é½¢'] != ''
                if age_mask.any():
                    filtered_df = filtered_df[
                        age_mask & (pd.to_numeric(filtered_df['å¹´é½¢'], errors='coerce') <= filters['max_age'])
                    ]
            
            return filtered_df
            
        except Exception as e:
            logger.error(f"âŒ DataFrameãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: {e}")
            return df
    
    @staticmethod
    def get_unique_departments(df: pd.DataFrame) -> List[str]:
        """DataFrameã‹ã‚‰ä¸€æ„ã®éƒ¨ç½²ãƒªã‚¹ãƒˆã‚’å–å¾—"""
        if df.empty:
            return []
        
        departments = df['éƒ¨ç½²'].dropna().unique()
        departments = [dept for dept in departments if dept.strip()]
        return sorted(departments)
    
    @staticmethod
    def export_to_csv(df: pd.DataFrame) -> bytes:
        """DataFrameã‚’CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
        try:
            # å†…éƒ¨ãƒ‡ãƒ¼ã‚¿åˆ—ã‚’é™¤å¤–
            export_df = df.drop(columns=['_raw_data'], errors='ignore')
            
            # CSVå½¢å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
            csv_data = export_df.to_csv(index=False, encoding='utf-8-sig')
            return csv_data.encode('utf-8-sig')
            
        except Exception as e:
            logger.error(f"âŒ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
            raise

class DisplayHelper:
    """è¡¨ç¤ºç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def configure_dataframe_display() -> Dict[str, Any]:
        """
        ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤ºè¨­å®šã‚’å–å¾—
        
        Returns:
            ã‚«ãƒ©ãƒ è¨­å®šè¾æ›¸
        """
        return {
            "ID": st.column_config.NumberColumn(
                "ID",
                help="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID",
                format="%d",
                width="small"
            ),
            "ãƒ¦ãƒ¼ã‚¶ãƒ¼å": st.column_config.TextColumn(
                "ãƒ¦ãƒ¼ã‚¶ãƒ¼å",
                help="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­˜åˆ¥å",
                width="medium"
            ),
            "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹": st.column_config.TextColumn(
                "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
                help="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
                width="large"
            ),
            "æ°å": st.column_config.TextColumn(
                "æ°å",
                help="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ¬å",
                width="medium"
            ),
            "å¹´é½¢": st.column_config.NumberColumn(
                "å¹´é½¢",
                help="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¹´é½¢",
                format="%dæ­³",
                width="small"
            ),
            "éƒ¨ç½²": st.column_config.TextColumn(
                "éƒ¨ç½²",
                help="æ‰€å±éƒ¨ç½²",
                width="medium"
            ),
            "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": st.column_config.TextColumn(
                "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
                help="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹",
                width="small"
            ),
            "ä½œæˆæ—¥æ™‚": st.column_config.DatetimeColumn(
                "ä½œæˆæ—¥æ™‚",
                help="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ—¥æ™‚",
                format="YYYY-MM-DD HH:mm",
                width="medium"
            ),
            "æ›´æ–°æ—¥æ™‚": st.column_config.DatetimeColumn(
                "æ›´æ–°æ—¥æ™‚",
                help="æœ€çµ‚æ›´æ–°æ—¥æ™‚",
                format="YYYY-MM-DD HH:mm",
                width="medium"
            )
        }
    
    @staticmethod
    def style_dataframe(df: pd.DataFrame) -> pd.DataFrame:
        """
        DataFrameã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
        
        Args:
            df: å…ƒã®DataFrame
            
        Returns:
            ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨æ¸ˆã¿DataFrame
        """
        if df.empty:
            return df
        
        # è¡¨ç¤ºç”¨ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
        styled_df = df.copy()
        
        # å†…éƒ¨ãƒ‡ãƒ¼ã‚¿åˆ—ã‚’é™¤å¤–
        if '_raw_data' in styled_df.columns:
            styled_df = styled_df.drop(columns=['_raw_data'])
        
        return styled_df</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã€åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å‡¦ç†ãŒå¯èƒ½ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ -->
                    <h3 class="section-title">4.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ã®å®Ÿè£…</h3>
                    
                    <p>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ä»˜ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ã‚’ä½œæˆã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 4-2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ã®ä½œæˆ</h5>
                        <p>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ UI ã®ä½œæˆ</li>
                            <li>ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤ºã®å®Ÿè£…</li>
                            <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢æ©Ÿèƒ½</li>
                            <li>çµ±è¨ˆæƒ…å ±ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
                            <li>ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½</li>
                        </ol>

                        <h6>ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°</h6>
                        <pre><code># app/main.pyã«ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’è¿½åŠ 

from utils.data_manager import DataManager, DisplayHelper
from utils.validators import get_valid_departments

def show_user_list():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºç”»é¢"""
    
    st.header("ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§")
    st.markdown("ç™»éŒ²ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§è¡¨ç¤ºã¨æ¤œç´¢æ©Ÿèƒ½")
    
    # çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
    show_user_dashboard()
    
    st.markdown("---")
    
    # æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    with st.expander("ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼", expanded=True):
        search_col1, search_col2, search_col3 = st.columns(3)
        
        with search_col1:
            # ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
            search_text = st.text_input(
                "ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢",
                placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã€æ°åã€éƒ¨ç½²ã§æ¤œç´¢...",
                help="è¤‡æ•°ã®é …ç›®ã‚’æ¨ªæ–­ã—ã¦æ¤œç´¢ã—ã¾ã™"
            )
        
        with search_col2:
            # éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            departments = get_valid_departments()
            department_filter = st.selectbox(
                "ğŸ¢ éƒ¨ç½²",
                options=['å…¨ã¦'] + departments,
                help="ç‰¹å®šã®éƒ¨ç½²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
            )
        
        with search_col3:
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            status_filter = st.selectbox(
                "ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
                options=['å…¨ã¦', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–'],
                help="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
            )
        
        # å¹´é½¢ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        age_col1, age_col2 = st.columns(2)
        with age_col1:
            min_age = st.number_input(
                "æœ€å°å¹´é½¢",
                min_value=0,
                max_value=150,
                value=None,
                help="å¹´é½¢ã®ä¸‹é™"
            )
        
        with age_col2:
            max_age = st.number_input(
                "æœ€å¤§å¹´é½¢",
                min_value=0,
                max_value=150,
                value=None,
                help="å¹´é½¢ã®ä¸Šé™"
            )
    
    # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã®æº–å‚™
    filters = {
        'search_text': search_text,
        'department': department_filter,
        'status': status_filter,
        'min_age': min_age,
        'max_age': max_age
    }
    
    # ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    with st.spinner("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­..."):
        # å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        all_users_df = DataManager.get_users_cached(limit=1000)
        
        # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é©ç”¨
        filtered_df = DataManager.filter_dataframe(all_users_df, filters)
    
    # çµæœæƒ…å ±ã®è¡¨ç¤º
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric(
            "è¡¨ç¤ºä»¶æ•°",
            len(filtered_df),
            delta=len(filtered_df) - len(all_users_df) if len(all_users_df) > 0 else 0
        )
    
    with col2:
        st.metric(
            "ç·ç™»éŒ²æ•°",
            len(all_users_df)
        )
    
    with col3:
        if st.button("ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°"):
            DataManager.clear_cache()
            st.rerun()
    
    # ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
    if not filtered_df.empty:
        # ã‚«ãƒ©ãƒ è¨­å®š
        column_config = DisplayHelper.configure_dataframe_display()
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤º
        st.subheader("ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿")
        
        # ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
        display_df = DisplayHelper.style_dataframe(filtered_df)
        
        # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
        st.dataframe(
            display_df,
            column_config=column_config,
            hide_index=True,
            use_container_width=True,
            height=400
        )
        
        # ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        st.markdown("---")
        export_col1, export_col2 = st.columns([3, 1])
        
        with export_col2:
            if st.button("ğŸ“¥ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", use_container_width=True):
                try:
                    csv_data = DataManager.export_to_csv(display_df)
                    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                    filename = f"user_list_{timestamp}.csv"
                    
                    st.download_button(
                        label="ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹",
                        data=csv_data,
                        file_name=filename,
                        mime="text/csv",
                        use_container_width=True
                    )
                    st.success("âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†")
                    
                except Exception as e:
                    st.error(f"âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        
        with export_col1:
            st.info(f"ğŸ’¡ ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã§ {len(display_df)} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­")
    
    else:
        # ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        st.warning("ğŸ” æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
        
        if any(filters.values()):
            st.info("ğŸ’¡ æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„")
            
            if st.button("ğŸ—‘ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ"):
                st.rerun()
        else:
            st.info("ğŸ‘¤ ã¾ãšã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„")

def show_user_dashboard():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"""
    
    # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—
    stats = DataManager.get_user_statistics()
    
    st.subheader("ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰")
    
    # ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
    metric_col1, metric_col2, metric_col3, metric_col4 = st.columns(4)
    
    with metric_col1:
        st.metric(
            "ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°",
            stats['total_users'],
            help="ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·æ•°"
        )
    
    with metric_col2:
        st.metric(
            "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼",
            stats['active_users'],
            delta=f"{stats['active_users'] / max(stats['total_users'], 1) * 100:.1f}%"
        )
    
    with metric_col3:
        st.metric(
            "éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼",
            stats['inactive_users'],
            delta=f"{stats['inactive_users'] / max(stats['total_users'], 1) * 100:.1f}%"
        )
    
    with metric_col4:
        avg_age_display = f"{stats['average_age']:.1f}æ­³" if stats['average_age'] else "æœªè¨­å®š"
        st.metric(
            "å¹³å‡å¹´é½¢",
            avg_age_display,
            help="å¹´é½¢ã‚’å…¥åŠ›ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¹³å‡å¹´é½¢"
        )
    
    # éƒ¨ç½²æƒ…å ±
    if stats['departments']:
        st.markdown("**ğŸ“‚ ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹éƒ¨ç½²:**")
        dept_cols = st.columns(min(len(stats['departments']), 4))
        
        for i, dept in enumerate(stats['departments']):
            with dept_cols[i % 4]:
                st.info(f"ğŸ¢ {dept}")
    
    # æœ€çµ‚æ›´æ–°æ™‚åˆ»
    st.caption(f"æœ€çµ‚æ›´æ–°: {stats['last_updated'].strftime('%Y-%m-%d %H:%M:%S')}")

# main()é–¢æ•°å†…ã®ãƒšãƒ¼ã‚¸é¸æŠã‚’æ›´æ–°
def main():
    # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
    
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒšãƒ¼ã‚¸é¸æŠã‚’æ›´æ–°
    with st.sidebar:
        st.header("ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼")
        
        page = st.radio(
            "ãƒšãƒ¼ã‚¸ã‚’é¸æŠ:",
            ["ğŸ  ãƒ›ãƒ¼ãƒ ", "ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²", "ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§", "ğŸ“Š çµ±è¨ˆæƒ…å ±"],
            index=0  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ›ãƒ¼ãƒ ã‚’é¸æŠ
        )
    
    # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒšãƒ¼ã‚¸åˆ†å²ã‚’æ›´æ–°
    if page == "ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§":
        show_user_list()
    elif page == "ğŸ“Š çµ±è¨ˆæƒ…å ±":
        show_user_dashboard()
    # ... æ—¢å­˜ã®ãƒšãƒ¼ã‚¸å‡¦ç† ...</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ä»˜ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ç”»é¢ãŒæ­£å¸¸ã«å‹•ä½œã—ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãŒå®Ÿç¾ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: æ¤œç´¢æ©Ÿèƒ½ã®è©³ç´°å®Ÿè£… -->
                    <h3 class="section-title">4.4 é«˜åº¦ãªæ¤œç´¢æ©Ÿèƒ½ã®å®Ÿè£…</h3>
                    
                    <p>ã‚ˆã‚Šä½¿ã„ã‚„ã™ã„æ¤œç´¢æ©Ÿèƒ½ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>

                    <div class="exercise-container">
                        <h5>å®Ÿç¿’ 4-3: é«˜åº¦ãªæ¤œç´¢æ©Ÿèƒ½ã®è¿½åŠ </h5>
                        <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ã€ãƒ•ã‚¡ã‚»ãƒƒãƒˆæ¤œç´¢ã€ä¿å­˜ã•ã‚ŒãŸæ¤œç´¢æ¡ä»¶ãªã©ã®é«˜åº¦ãªæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ã®å®Ÿè£…</li>
                            <li>æ¤œç´¢æ¡ä»¶ã®ä¿å­˜ãƒ»å¾©å…ƒæ©Ÿèƒ½</li>
                            <li>æ¤œç´¢å±¥æ­´ã®ç®¡ç†</li>
                            <li>é«˜åº¦ãªæ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³</li>
                            <li>æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–</li>
                        </ol>

                        <h6>app/utils/search_manager.pyä½œæˆ</h6>
                        <pre><code>"""
æ¤œç´¢ç®¡ç†æ©Ÿèƒ½
é«˜åº¦ãªæ¤œç´¢ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€æ¤œç´¢å±¥æ­´ç®¡ç†
"""

import streamlit as st
import pandas as pd
from typing import Dict, Any, List, Optional
from datetime import datetime
import json

class SearchManager:
    """æ¤œç´¢æ©Ÿèƒ½ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    @staticmethod
    def initialize_search_state():
        """æ¤œç´¢çŠ¶æ…‹ã‚’åˆæœŸåŒ–"""
        if 'search_history' not in st.session_state:
            st.session_state.search_history = []
        
        if 'saved_searches' not in st.session_state:
            st.session_state.saved_searches = {}
        
        if 'current_search' not in st.session_state:
            st.session_state.current_search = {}
    
    @staticmethod
    def save_search_condition(name: str, conditions: Dict[str, Any]):
        """æ¤œç´¢æ¡ä»¶ã‚’ä¿å­˜"""
        st.session_state.saved_searches[name] = {
            'conditions': conditions,
            'created_at': datetime.now(),
            'description': SearchManager._generate_search_description(conditions)
        }
    
    @staticmethod
    def load_search_condition(name: str) -> Optional[Dict[str, Any]]:
        """æ¤œç´¢æ¡ä»¶ã‚’èª­ã¿è¾¼ã¿"""
        return st.session_state.saved_searches.get(name, {}).get('conditions')
    
    @staticmethod
    def delete_search_condition(name: str):
        """æ¤œç´¢æ¡ä»¶ã‚’å‰Šé™¤"""
        if name in st.session_state.saved_searches:
            del st.session_state.saved_searches[name]
    
    @staticmethod
    def add_search_history(conditions: Dict[str, Any]):
        """æ¤œç´¢å±¥æ­´ã«è¿½åŠ """
        # ç©ºã®æ¡ä»¶ã¯å±¥æ­´ã«è¿½åŠ ã—ãªã„
        if not any(v for v in conditions.values() if v):
            return
        
        history_item = {
            'conditions': conditions,
            'timestamp': datetime.now(),
            'description': SearchManager._generate_search_description(conditions)
        }
        
        # é‡è¤‡ã™ã‚‹æ¤œç´¢ã¯å±¥æ­´ã«è¿½åŠ ã—ãªã„
        for item in st.session_state.search_history:
            if item['conditions'] == conditions:
                return
        
        st.session_state.search_history.insert(0, history_item)
        
        # å±¥æ­´ã¯æœ€æ–°20ä»¶ã¾ã§ä¿æŒ
        if len(st.session_state.search_history) > 20:
            st.session_state.search_history = st.session_state.search_history[:20]
    
    @staticmethod
    def _generate_search_description(conditions: Dict[str, Any]) -> str:
        """æ¤œç´¢æ¡ä»¶ã®èª¬æ˜æ–‡ã‚’ç”Ÿæˆ"""
        descriptions = []
        
        if conditions.get('search_text'):
            descriptions.append(f"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {conditions['search_text']}")
        
        if conditions.get('department') and conditions['department'] != 'å…¨ã¦':
            descriptions.append(f"éƒ¨ç½²: {conditions['department']}")
        
        if conditions.get('status') and conditions['status'] != 'å…¨ã¦':
            descriptions.append(f"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {conditions['status']}")
        
        if conditions.get('min_age') is not None:
            descriptions.append(f"æœ€å°å¹´é½¢: {conditions['min_age']}æ­³")
        
        if conditions.get('max_age') is not None:
            descriptions.append(f"æœ€å¤§å¹´é½¢: {conditions['max_age']}æ­³")
        
        return " | ".join(descriptions) if descriptions else "å…¨ã¦ã®æ¡ä»¶"
    
    @staticmethod
    def show_search_management():
        """æ¤œç´¢ç®¡ç†UIã‚’è¡¨ç¤º"""
        st.subheader("ğŸ” æ¤œç´¢ç®¡ç†")
        
        # ã‚¿ãƒ–ã§æ©Ÿèƒ½ã‚’åˆ†å‰²
        tab1, tab2, tab3 = st.tabs(["ğŸ’¾ æ¤œç´¢æ¡ä»¶ä¿å­˜", "ğŸ“‹ ä¿å­˜æ¸ˆã¿æ¤œç´¢", "ğŸ“š æ¤œç´¢å±¥æ­´"])
        
        with tab1:
            SearchManager._show_save_search_ui()
        
        with tab2:
            SearchManager._show_saved_searches_ui()
        
        with tab3:
            SearchManager._show_search_history_ui()
    
    @staticmethod
    def _show_save_search_ui():
        """æ¤œç´¢æ¡ä»¶ä¿å­˜UIã‚’è¡¨ç¤º"""
        st.markdown("**ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã‚’ä¿å­˜**")
        
        current_search = st.session_state.get('current_search', {})
        
        if not any(v for v in current_search.values() if v):
            st.info("ğŸ’¡ æ¤œç´¢æ¡ä»¶ã‚’è¨­å®šã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„")
            return
        
        # ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶è¡¨ç¤º
        description = SearchManager._generate_search_description(current_search)
        st.write(f"**æ¡ä»¶:** {description}")
        
        # ä¿å­˜åå…¥åŠ›
        save_name = st.text_input(
            "ä¿å­˜å",
            placeholder="ä¾‹: å–¶æ¥­éƒ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼",
            help="æ¤œç´¢æ¡ä»¶ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®åå‰"
        )
        
        if st.button("ğŸ’¾ ä¿å­˜", disabled=not save_name):
            SearchManager.save_search_condition(save_name, current_search)
            st.success(f"âœ… æ¤œç´¢æ¡ä»¶ '{save_name}' ã‚’ä¿å­˜ã—ã¾ã—ãŸ")
            st.rerun()
    
    @staticmethod
    def _show_saved_searches_ui():
        """ä¿å­˜æ¸ˆã¿æ¤œç´¢UIã‚’è¡¨ç¤º"""
        saved_searches = st.session_state.get('saved_searches', {})
        
        if not saved_searches:
            st.info("ğŸ’¡ ä¿å­˜ã•ã‚ŒãŸæ¤œç´¢æ¡ä»¶ã¯ã‚ã‚Šã¾ã›ã‚“")
            return
        
        st.markdown("**ä¿å­˜æ¸ˆã¿æ¤œç´¢æ¡ä»¶**")
        
        for name, search_data in saved_searches.items():
            with st.expander(f"ğŸ” {name}"):
                st.write(f"**æ¡ä»¶:** {search_data['description']}")
                st.write(f"**ä¿å­˜æ—¥:** {search_data['created_at'].strftime('%Y-%m-%d %H:%M')}")
                
                col1, col2 = st.columns(2)
                
                with col1:
                    if st.button(f"ğŸ”„ é©ç”¨", key=f"apply_{name}"):
                        # æ¤œç´¢æ¡ä»¶ã‚’ç¾åœ¨ã®æ¡ä»¶ã¨ã—ã¦è¨­å®š
                        st.session_state.current_search = search_data['conditions']
                        st.success(f"âœ… æ¤œç´¢æ¡ä»¶ '{name}' ã‚’é©ç”¨ã—ã¾ã—ãŸ")
                        st.rerun()
                
                with col2:
                    if st.button(f"ğŸ—‘ï¸ å‰Šé™¤", key=f"delete_{name}"):
                        SearchManager.delete_search_condition(name)
                        st.success(f"âœ… æ¤œç´¢æ¡ä»¶ '{name}' ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
                        st.rerun()
    
    @staticmethod
    def _show_search_history_ui():
        """æ¤œç´¢å±¥æ­´UIã‚’è¡¨ç¤º"""
        history = st.session_state.get('search_history', [])
        
        if not history:
            st.info("ğŸ’¡ æ¤œç´¢å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“")
            return
        
        st.markdown("**æœ€è¿‘ã®æ¤œç´¢**")
        
        for i, item in enumerate(history[:10]):  # æœ€æ–°10ä»¶ã®ã¿è¡¨ç¤º
            with st.expander(f"ğŸ• {item['timestamp'].strftime('%m/%d %H:%M')} - {item['description'][:50]}..."):
                st.write(f"**æ¤œç´¢æ¡ä»¶:** {item['description']}")
                st.write(f"**æ¤œç´¢æ™‚åˆ»:** {item['timestamp'].strftime('%Y-%m-%d %H:%M:%S')}")
                
                if st.button(f"ğŸ”„ å†å®Ÿè¡Œ", key=f"history_{i}"):
                    st.session_state.current_search = item['conditions']
                    st.success("âœ… æ¤œç´¢æ¡ä»¶ã‚’å†é©ç”¨ã—ã¾ã—ãŸ")
                    st.rerun()
        
        # å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
        if st.button("ğŸ—‘ï¸ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢"):
            st.session_state.search_history = []
            st.success("âœ… æ¤œç´¢å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
            st.rerun()

class AdvancedFilter:
    """é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½"""
    
    @staticmethod
    def create_dynamic_filters(df: pd.DataFrame) -> Dict[str, Any]:
        """
        ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦å‹•çš„ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½œæˆ
        
        Args:
            df: å¯¾è±¡ã®DataFrame
            
        Returns:
            ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šè¾æ›¸
        """
        if df.empty:
            return {}
        
        filters = {}
        
        # éƒ¨ç½²ã®å‹•çš„ãƒªã‚¹ãƒˆ
        unique_departments = df['éƒ¨ç½²'].dropna().unique()
        unique_departments = [dept for dept in unique_departments if dept.strip()]
        filters['departments'] = sorted(unique_departments)
        
        # å¹´é½¢ã®ç¯„å›²
        ages = pd.to_numeric(df['å¹´é½¢'], errors='coerce').dropna()
        if not ages.empty:
            filters['age_range'] = {
                'min': int(ages.min()),
                'max': int(ages.max()),
                'avg': float(ages.mean())
            }
        
        # ä½œæˆæ—¥ã®ç¯„å›²
        if 'ä½œæˆæ—¥æ™‚' in df.columns:
            dates = pd.to_datetime(df['ä½œæˆæ—¥æ™‚'], errors='coerce').dropna()
            if not dates.empty:
                filters['date_range'] = {
                    'start': dates.min(),
                    'end': dates.max()
                }
        
        return filters
    
    @staticmethod
    def show_advanced_search_options():
        """é«˜åº¦ãªæ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º"""
        with st.expander("âš™ï¸ é«˜åº¦ãªæ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³"):
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("**æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰**")
                search_mode = st.radio(
                    "æ¤œç´¢æ–¹æ³•",
                    ["éƒ¨åˆ†ä¸€è‡´", "å®Œå…¨ä¸€è‡´", "å‰æ–¹ä¸€è‡´", "å¾Œæ–¹ä¸€è‡´"],
                    help="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã®ä¸€è‡´æ–¹æ³•ã‚’é¸æŠ"
                )
                
                case_sensitive = st.checkbox(
                    "å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥",
                    help="æ¤œç´¢æ™‚ã®å¤§æ–‡å­—å°æ–‡å­—ã®æ‰±ã„"
                )
            
            with col2:
                st.markdown("**è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³**")
                show_inactive = st.checkbox(
                    "éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤º",
                    value=True,
                    help="éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚è¡¨ç¤º"
                )
                
                items_per_page = st.selectbox(
                    "è¡¨ç¤ºä»¶æ•°",
                    [10, 25, 50, 100, "å…¨ã¦"],
                    index=3,
                    help="ä¸€åº¦ã«è¡¨ç¤ºã™ã‚‹ä»¶æ•°"
                )
            
            return {
                'search_mode': search_mode,
                'case_sensitive': case_sensitive,
                'show_inactive': show_inactive,
                'items_per_page': items_per_page
            }</code></pre>

                        <h6>æ¤œç´¢æ©Ÿèƒ½ã®çµ±åˆæ›´æ–°</h6>
                        <pre><code># main.pyã®show_user_list()é–¢æ•°ã‚’æ›´æ–°

from utils.search_manager import SearchManager, AdvancedFilter

def show_user_list():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºç”»é¢ï¼ˆæ¤œç´¢æ©Ÿèƒ½å¼·åŒ–ç‰ˆï¼‰"""
    
    # æ¤œç´¢çŠ¶æ…‹åˆæœŸåŒ–
    SearchManager.initialize_search_state()
    
    st.header("ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§")
    st.markdown("ç™»éŒ²ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§è¡¨ç¤ºã¨é«˜åº¦ãªæ¤œç´¢æ©Ÿèƒ½")
    
    # çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
    show_user_dashboard()
    
    st.markdown("---")
    
    # æ¤œç´¢ç®¡ç†UI
    with st.expander("âš™ï¸ æ¤œç´¢ç®¡ç†", expanded=False):
        SearchManager.show_search_management()
    
    # ãƒ¡ã‚¤ãƒ³æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    with st.container():
        st.subheader("ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼")
        
        # åŸºæœ¬æ¤œç´¢
        search_col1, search_col2 = st.columns([3, 1])
        
        with search_col1:
            search_text = st.text_input(
                "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢",
                value=st.session_state.current_search.get('search_text', ''),
                placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã€æ°åã€éƒ¨ç½²ã§æ¤œç´¢...",
                help="è¤‡æ•°ã®é …ç›®ã‚’æ¨ªæ–­ã—ã¦æ¤œç´¢ã—ã¾ã™"
            )
        
        with search_col2:
            if st.button("ğŸ” æ¤œç´¢å®Ÿè¡Œ", use_container_width=True):
                # ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã‚’å±¥æ­´ã«è¿½åŠ 
                current_conditions = {
                    'search_text': search_text,
                    'department': st.session_state.current_search.get('department', 'å…¨ã¦'),
                    'status': st.session_state.current_search.get('status', 'å…¨ã¦'),
                    'min_age': st.session_state.current_search.get('min_age'),
                    'max_age': st.session_state.current_search.get('max_age')
                }
                SearchManager.add_search_history(current_conditions)
        
        # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
        filter_col1, filter_col2, filter_col3 = st.columns(3)
        
        with filter_col1:
            departments = get_valid_departments()
            department_filter = st.selectbox(
                "éƒ¨ç½²",
                options=['å…¨ã¦'] + departments,
                index=0 if not st.session_state.current_search.get('department') 
                      else (['å…¨ã¦'] + departments).index(st.session_state.current_search.get('department', 'å…¨ã¦'))
            )
        
        with filter_col2:
            status_options = ['å…¨ã¦', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–']
            status_filter = st.selectbox(
                "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
                options=status_options,
                index=status_options.index(st.session_state.current_search.get('status', 'å…¨ã¦'))
            )
        
        with filter_col3:
            # ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
            if st.button("ğŸ—‘ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ"):
                st.session_state.current_search = {}
                st.rerun()
        
        # å¹´é½¢ç¯„å›²
        age_col1, age_col2 = st.columns(2)
        with age_col1:
            min_age = st.number_input(
                "æœ€å°å¹´é½¢",
                min_value=0,
                max_value=150,
                value=st.session_state.current_search.get('min_age'),
                help="å¹´é½¢ã®ä¸‹é™"
            )
        
        with age_col2:
            max_age = st.number_input(
                "æœ€å¤§å¹´é½¢", 
                min_value=0,
                max_value=150,
                value=st.session_state.current_search.get('max_age'),
                help="å¹´é½¢ã®ä¸Šé™"
            )
        
        # é«˜åº¦ãªæ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        advanced_options = AdvancedFilter.show_advanced_search_options()
    
    # ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã‚’ä¿å­˜
    st.session_state.current_search = {
        'search_text': search_text,
        'department': department_filter,
        'status': status_filter,
        'min_age': min_age,
        'max_age': max_age,
        **advanced_options
    }
    
    # ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    with st.spinner("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­..."):
        all_users_df = DataManager.get_users_cached(limit=1000)
        filtered_df = DataManager.filter_dataframe(all_users_df, st.session_state.current_search)
    
    # çµæœè¡¨ç¤º
    st.markdown("---")
    display_search_results(all_users_df, filtered_df)

def display_search_results(all_df: pd.DataFrame, filtered_df: pd.DataFrame):
    """æ¤œç´¢çµæœã‚’è¡¨ç¤º"""
    
    # çµæœã‚µãƒãƒªãƒ¼
    result_col1, result_col2, result_col3, result_col4 = st.columns(4)
    
    with result_col1:
        st.metric("è¡¨ç¤ºä»¶æ•°", len(filtered_df))
    
    with result_col2:
        st.metric("ç·ç™»éŒ²æ•°", len(all_df))
    
    with result_col3:
        if len(all_df) > 0:
            match_rate = len(filtered_df) / len(all_df) * 100
            st.metric("ä¸€è‡´ç‡", f"{match_rate:.1f}%")
    
    with result_col4:
        if st.button("ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°"):
            DataManager.clear_cache()
            st.rerun()
    
    # ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
    if not filtered_df.empty:
        # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤º
        st.subheader("ğŸ“‹ æ¤œç´¢çµæœ")
        
        column_config = DisplayHelper.configure_dataframe_display()
        display_df = DisplayHelper.style_dataframe(filtered_df)
        
        # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
        items_per_page = st.session_state.current_search.get('items_per_page', 100)
        if items_per_page != "å…¨ã¦" and len(display_df) > items_per_page:
            page = st.selectbox(
                "ãƒšãƒ¼ã‚¸",
                range(1, (len(display_df) // items_per_page) + 2),
                format_func=lambda x: f"ãƒšãƒ¼ã‚¸ {x}"
            )
            start_idx = (page - 1) * items_per_page
            end_idx = start_idx + items_per_page
            display_df = display_df.iloc[start_idx:end_idx]
        
        st.dataframe(
            display_df,
            column_config=column_config,
            hide_index=True,
            use_container_width=True,
            height=400
        )
        
        # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        show_export_options(display_df)
    
    else:
        st.warning("ğŸ” æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
        
        if st.button("ğŸ’¡ æ¤œç´¢ã®ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º"):
            show_search_tips()

def show_export_options(df: pd.DataFrame):
    """ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º"""
    st.markdown("---")
    st.subheader("ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ")
    
    export_col1, export_col2, export_col3 = st.columns(3)
    
    with export_col1:
        if st.button("ğŸ“„ CSVå½¢å¼", use_container_width=True):
            try:
                csv_data = DataManager.export_to_csv(df)
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                filename = f"user_list_{timestamp}.csv"
                
                st.download_button(
                    label="ğŸ“¥ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=csv_data,
                    file_name=filename,
                    mime="text/csv",
                    use_container_width=True
                )
                st.success("âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†")
            except Exception as e:
                st.error(f"âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    
    with export_col2:
        st.info("ğŸ“Š Excelå½¢å¼ï¼ˆä»Šå¾Œå®Ÿè£…äºˆå®šï¼‰")
    
    with export_col3:
        st.info("ğŸ“‹ PDFå½¢å¼ï¼ˆä»Šå¾Œå®Ÿè£…äºˆå®šï¼‰")

def show_search_tips():
    """æ¤œç´¢ã®ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º"""
    with st.expander("ğŸ’¡ æ¤œç´¢ã®ãƒ’ãƒ³ãƒˆ", expanded=True):
        st.markdown("""
        **åŠ¹æœçš„ãªæ¤œç´¢æ–¹æ³•:**
        
        1. **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢**:
           - éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢ã•ã‚Œã¾ã™
           - è¤‡æ•°ã®é …ç›®ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã€æ°åã€éƒ¨ç½²ï¼‰ã‚’åŒæ™‚ã«æ¤œç´¢
           - å¤§æ–‡å­—å°æ–‡å­—ã¯åŒºåˆ¥ã•ã‚Œã¾ã›ã‚“
        
        2. **ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®çµ„ã¿åˆã‚ã›**:
           - è¤‡æ•°ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’çµ„ã¿åˆã‚ã›ã¦çµã‚Šè¾¼ã¿å¯èƒ½
           - å¹´é½¢ç¯„å›²ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨åŠ¹æœçš„
        
        3. **ä¿å­˜æ©Ÿèƒ½ã®æ´»ç”¨**:
           - ã‚ˆãä½¿ã†æ¤œç´¢æ¡ä»¶ã¯ä¿å­˜ã—ã¦å†åˆ©ç”¨
           - æ¤œç´¢å±¥æ­´ã‹ã‚‰éå»ã®æ¤œç´¢ã‚’å†å®Ÿè¡Œ
        
        4. **ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°**:
           - æ–°ã—ãç™»éŒ²ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€Œãƒ‡ãƒ¼ã‚¿æ›´æ–°ã€ã‚’å®Ÿè¡Œ
        """)
</code></pre>

                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <p>é«˜åº¦ãªæ¤œç´¢æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã€æ¤œç´¢æ¡ä»¶ã®ä¿å­˜ãƒ»å¾©å…ƒã€æ¤œç´¢å±¥æ­´ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãªã©ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <!-- ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º -->
                    <div class="quiz-container">
                        <h5>ç†è§£åº¦ç¢ºèªã‚¯ã‚¤ã‚º</h5>
                        <ol>
                            <li><strong>st.dataframe()</strong>ã¨<strong>st.table()</strong>ã®é•ã„ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>@st.cache_data</strong>ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã®ç›®çš„ã¨æ³¨æ„ç‚¹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>Pandasãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ </strong>ã‚’Streamlitã§è¡¨ç¤ºã™ã‚‹éš›ã®æœ€é©åŒ–æ–¹æ³•ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>æ¤œç´¢æ©Ÿèƒ½</strong>ã§ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹è¦ç´ ã‚’4ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>st.column_config</strong>ã‚’ä½¿ç”¨ã™ã‚‹åˆ©ç‚¹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</strong>ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒæ…®ã™ã¹ãç‚¹ã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½</strong>ã§è€ƒæ…®ã™ã¹ãã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ç´ ã‚’2ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚</li>
                            <li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</strong>ã¨<strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½</strong>ã®ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚Šæ–¹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚</li>
                        </ol>
                        
                        <details>
                            <summary>è§£ç­”ä¾‹</summary>
                            <ol>
                                <li>st.dataframe()ã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã€å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã€‚st.table()ã¯é™çš„ã€å°ãƒ‡ãƒ¼ã‚¿å‘ã‘ã€ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤º</li>
                                <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã®è² è·è»½æ¸›ãŒç›®çš„ã€‚ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ™‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã€TTLè¨­å®šã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã«æ³¨æ„</li>
                                <li>é©åˆ‡ãªTTLè¨­å®šã€åˆ—ã®å‹æŒ‡å®šã€ä¸è¦ãªåˆ—ã®é™¤å¤–ã€ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…</li>
                                <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ã€è¤‡æ•°æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€æ¤œç´¢å±¥æ­´ã€ä¿å­˜æ©Ÿèƒ½ã€æ¤œç´¢çµæœãƒã‚¤ãƒ©ã‚¤ãƒˆ</li>
                                <li>åˆ—ã®è¡¨ç¤ºåˆ¶å¾¡ã€ãƒ‡ãƒ¼ã‚¿å‹ã®é©åˆ‡ãªè¡¨ç¤ºã€å¹…èª¿æ•´ã€ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š</li>
                                <li>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ã€é©åˆ‡ãªã‚¯ã‚¨ãƒªè¨­è¨ˆã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é †åºã®æœ€é©åŒ–ã€ãƒ‡ãƒ¼ã‚¿é‡ã®åˆ¶é™</li>
                                <li>å€‹äººæƒ…å ±ã®é™¤å¤–ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ç¢ºèªã€ãƒ•ã‚¡ã‚¤ãƒ«åã®é©åˆ‡ãªè¨­å®šã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±¥æ­´ã®è¨˜éŒ²</li>
                                <li>ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°é »åº¦ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥TTLã®é©åˆ‡ãªè¨­å®šã€æ‰‹å‹•æ›´æ–°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æä¾›ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ›´æ–°çŠ¶æ³ã®é€šçŸ¥</li>
                            </ol>
                        </details>
                    </div>

                    <!-- ã¾ã¨ã‚ -->
                    <h3 class="section-title">4.5 Step 4ã®ã¾ã¨ã‚</h3>
                    
                    <div class="highlight">
                        <h5>Step 4ã§ç¿’å¾—ã—ãŸã‚¹ã‚­ãƒ«</h5>
                        <ul>
                            <li>Streamlitãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤ºæ©Ÿèƒ½ã®æ´»ç”¨</li>
                            <li>é«˜åº¦ãªæ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</li>
                            <li>Pandasã¨ã®é€£æºãƒ‡ãƒ¼ã‚¿å‡¦ç†</li>
                            <li>æ¤œç´¢æ¡ä»¶ã®ä¿å­˜ãƒ»å¾©å…ƒæ©Ÿèƒ½</li>
                            <li>ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã‚’é‡è¦–ã—ãŸUIè¨­è¨ˆ</li>
                            <li>ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®å®Ÿè£…</li>
                            <li>æ¤œç´¢å±¥æ­´ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>æ¬¡ã®Stepã«é€²ã‚€å‰ã«ç¢ºèªã™ã‚‹ã“ã¨</h6>
                        <ul>
                            <li>âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹</li>
                            <li>âœ… æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹</li>
                            <li>âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ãŒé©åˆ‡ã«å‹•ä½œã™ã‚‹</li>
                            <li>âœ… æ¤œç´¢æ¡ä»¶ã®ä¿å­˜ãƒ»å¾©å…ƒãŒã§ãã‚‹</li>
                            <li>âœ… æ¤œç´¢å±¥æ­´ãŒç®¡ç†ã•ã‚Œã‚‹</li>
                            <li>âœ… ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå¯èƒ½ã§ã‚ã‚‹</li>
                            <li>âœ… çµ±è¨ˆæƒ…å ±ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹</li>
                            <li>âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒé©åˆ‡ã§ã‚ã‚‹</li>
                        </ul>
                    </div>

                    <div class="info">
                        <h6>ç™ºå±•çš„ãªå­¦ç¿’ã®ãƒ’ãƒ³ãƒˆ</h6>
                        <ul>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–</strong>: Plotlyã€Altairã‚’ä½¿ç”¨ã—ãŸã‚°ãƒ©ãƒ•è¡¨ç¤º</li>
                            <li><strong>é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</strong>: ç¯„å›²é¸æŠã€æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</li>
                            <li><strong>ãƒãƒƒãƒæ“ä½œ</strong>: è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ‹¬æ“ä½œ</li>
                            <li><strong>ãƒ‡ãƒ¼ã‚¿åˆ†æ</strong>: çµ±è¨ˆåˆ†æã€ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¤º</li>
                            <li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½</strong>: WebSocketã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•æ›´æ–°</li>
                        </ul>
                    </div>

                    <!-- ç« é–“ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step3-user-registration.html" class="btn btn-secondary">â† Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½</a>
                        <a href="step5-user-crud-operations.html" class="btn btn-primary">Step 5: CRUDæ“ä½œ â†’</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js åˆæœŸåŒ– -->
    <script>hljs.highlightAll();</script>
</body>
</html>