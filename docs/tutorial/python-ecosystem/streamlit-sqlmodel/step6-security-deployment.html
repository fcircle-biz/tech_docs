<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlit + SQLModel チュートリアル Step 6 - セキュリティとデプロイ準備</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション */
        .navbar {
            background-color: #0066cc;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        /* タイトル */
        .chapter-title {
            color: #0066cc;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #3399ff;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e6f2ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #0066cc;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        .success {
            background-color: #d4edda;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #28a745;
        }

        .security-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #fdcb6e;
        }

        /* ナビゲーション */
        .nav-link.active {
            background-color: #0066cc !important;
            color: white !important;
        }

        .nav-link {
            color: #495057;
        }

        .nav-link:hover {
            background-color: #e6f2ff;
        }

        /* コードブロック */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }
        
        .code-block {
            background-color: #1e1e1e !important;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            border: none !important;
        }
        
        .code-block code {
            background-color: transparent !important;
            color: #ffffff;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }

        .img-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* テーブルスタイル */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* セキュリティチェックリスト */
        .security-checklist {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
        }

        .checklist-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">Tech Docs</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="../streamlit-sqlmodel/README.html">Streamlit + SQLModel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">
                        Streamlit + SQLModel チュートリアル
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-design.html">Step 2: データベース設計</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-user-registration.html">Step 3: ユーザー登録機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-display.html">Step 4: ユーザー一覧表示</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-crud-operations.html">Step 5: CRUD操作</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#step6">Step 6: セキュリティとデプロイ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 章ヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 6: セキュリティとデプロイ準備</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="badge bg-info">所要時間: 2時間</span>
                        </div>
                    </div>
                </div>

                <div id="step6">
                    <!-- 章タイトル -->
                    <h2 class="chapter-title">本番環境対応とセキュリティ強化</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>環境変数による設定管理とセキュリティ</li>
                            <li>SQLインジェクション対策とデータ検証</li>
                            <li>認証機能の基本実装</li>
                            <li>ロギングとエラートラッキング</li>
                            <li>パフォーマンス最適化とモニタリング</li>
                            <li>本番環境でのPostgreSQL設定</li>
                            <li>デプロイ準備とベストプラクティス</li>
                        </ul>
                    </div>

                    <!-- セクション1: セキュリティ基礎 -->
                    <h3 class="section-title">6.1 Webアプリケーションセキュリティの基礎</h3>
                    <p>本番環境で安全にアプリケーションを運用するために、基本的なセキュリティ対策を実装します。</p>

                    <div class="security-box">
                        <h6>🔒 重要なセキュリティ原則</h6>
                        <ul>
                            <li><strong>最小権限の原則</strong>: 必要最小限の権限のみ付与</li>
                            <li><strong>多層防御</strong>: 複数のセキュリティ層で保護</li>
                            <li><strong>入力検証</strong>: すべての入力データを検証</li>
                            <li><strong>機密情報の保護</strong>: パスワードや設定の適切な管理</li>
                            <li><strong>ログとモニタリング</strong>: セキュリティイベントの追跡</li>
                        </ul>
                    </div>

                    <h4>Webアプリケーションの主要脅威</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>脅威</th>
                                    <th>説明</th>
                                    <th>対策</th>
                                    <th>実装レベル</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>SQLインジェクション</strong></td>
                                    <td>不正なSQL文の挿入</td>
                                    <td>ORM使用、パラメータ化クエリ</td>
                                    <td>✅ 対応済み</td>
                                </tr>
                                <tr>
                                    <td><strong>XSS攻撃</strong></td>
                                    <td>不正スクリプトの実行</td>
                                    <td>入力サニタイズ、CSP</td>
                                    <td>⚡ 部分対応</td>
                                </tr>
                                <tr>
                                    <td><strong>認証・認可</strong></td>
                                    <td>不正アクセス</td>
                                    <td>適切な認証システム</td>
                                    <td>🔄 実装予定</td>
                                </tr>
                                <tr>
                                    <td><strong>機密情報漏洩</strong></td>
                                    <td>設定情報の露出</td>
                                    <td>環境変数、暗号化</td>
                                    <td>🔄 実装予定</td>
                                </tr>
                                <tr>
                                    <td><strong>CSRF攻撃</strong></td>
                                    <td>偽造リクエスト</td>
                                    <td>CSRFトークン</td>
                                    <td>💡 今後実装</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- セクション2: 環境変数管理 -->
                    <h3 class="section-title">6.2 環境変数による設定管理</h3>
                    
                    <p>機密情報と環境固有の設定を安全に管理するシステムを実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-1: セキュアな設定管理の実装</h5>
                        <p>環境変数による設定管理とシークレット管理を強化します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>環境固有の設定ファイル作成</li>
                            <li>シークレット管理の強化</li>
                            <li>設定検証機能の実装</li>
                            <li>ログレベルの環境別設定</li>
                            <li>セキュリティヘッダーの追加</li>
                        </ol>

                        <h6>app/config.py セキュリティ強化版</h6>
                        <pre><code>"""
セキュリティ強化されたアプリケーション設定管理
環境変数とシークレット管理を含む
"""

import os
import secrets
import logging
from typing import Optional, List, Dict, Any
from dotenv import load_dotenv
from pathlib import Path

# 環境に応じた.envファイルを読み込み
env_file = f".env.{os.getenv('ENVIRONMENT', 'development')}"
if Path(env_file).exists():
    load_dotenv(env_file)
else:
    load_dotenv()  # デフォルトの.envファイル

class SecuritySettings:
    """セキュリティ関連設定"""
    
    # セッション管理
    SECRET_KEY: str = os.getenv("SECRET_KEY", secrets.token_urlsafe(32))
    SESSION_TIMEOUT: int = int(os.getenv("SESSION_TIMEOUT", "3600"))  # 1時間
    
    # パスワード設定
    PASSWORD_MIN_LENGTH: int = int(os.getenv("PASSWORD_MIN_LENGTH", "8"))
    PASSWORD_REQUIRE_UPPERCASE: bool = os.getenv("PASSWORD_REQUIRE_UPPERCASE", "True").lower() == "true"
    PASSWORD_REQUIRE_NUMBERS: bool = os.getenv("PASSWORD_REQUIRE_NUMBERS", "True").lower() == "true"
    PASSWORD_REQUIRE_SPECIAL: bool = os.getenv("PASSWORD_REQUIRE_SPECIAL", "True").lower() == "true"
    
    # レート制限
    RATE_LIMIT_ENABLED: bool = os.getenv("RATE_LIMIT_ENABLED", "True").lower() == "true"
    RATE_LIMIT_REQUESTS: int = int(os.getenv("RATE_LIMIT_REQUESTS", "100"))
    RATE_LIMIT_WINDOW: int = int(os.getenv("RATE_LIMIT_WINDOW", "3600"))  # 1時間
    
    # セキュリティヘッダー
    SECURITY_HEADERS: Dict[str, str] = {
        "X-Content-Type-Options": "nosniff",
        "X-Frame-Options": "DENY",
        "X-XSS-Protection": "1; mode=block",
        "Strict-Transport-Security": "max-age=31536000; includeSubDomains",
        "Content-Security-Policy": "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
    }

class DatabaseSettings:
    """データベース設定（セキュリティ強化版）"""
    
    # 基本接続情報
    POSTGRES_HOST: str = os.getenv("POSTGRES_HOST", "localhost")
    POSTGRES_PORT: int = int(os.getenv("POSTGRES_PORT", "5432"))
    POSTGRES_DB: str = os.getenv("POSTGRES_DB", "userdb")
    POSTGRES_USER: str = os.getenv("POSTGRES_USER", "postgres")
    POSTGRES_PASSWORD: str = os.getenv("POSTGRES_PASSWORD", "password")
    
    # SSL設定
    POSTGRES_SSL_MODE: str = os.getenv("POSTGRES_SSL_MODE", "prefer")
    POSTGRES_SSL_CERT: Optional[str] = os.getenv("POSTGRES_SSL_CERT")
    POSTGRES_SSL_KEY: Optional[str] = os.getenv("POSTGRES_SSL_KEY")
    POSTGRES_SSL_CA: Optional[str] = os.getenv("POSTGRES_SSL_CA")
    
    # 接続プール設定
    CONNECTION_POOL_SIZE: int = int(os.getenv("CONNECTION_POOL_SIZE", "20"))
    CONNECTION_POOL_MAX_OVERFLOW: int = int(os.getenv("CONNECTION_POOL_MAX_OVERFLOW", "30"))
    CONNECTION_POOL_TIMEOUT: int = int(os.getenv("CONNECTION_POOL_TIMEOUT", "30"))
    CONNECTION_POOL_RECYCLE: int = int(os.getenv("CONNECTION_POOL_RECYCLE", "3600"))
    
    # クエリタイムアウト
    QUERY_TIMEOUT: int = int(os.getenv("QUERY_TIMEOUT", "30"))
    
    @property
    def database_url(self) -> str:
        """セキュアなデータベースURL を構築"""
        url = (
            f"postgresql://{self.POSTGRES_USER}:{self.POSTGRES_PASSWORD}"
            f"@{self.POSTGRES_HOST}:{self.POSTGRES_PORT}/{self.POSTGRES_DB}"
        )
        
        # SSL設定を追加
        ssl_params = []
        if self.POSTGRES_SSL_MODE:
            ssl_params.append(f"sslmode={self.POSTGRES_SSL_MODE}")
        if self.POSTGRES_SSL_CERT:
            ssl_params.append(f"sslcert={self.POSTGRES_SSL_CERT}")
        if self.POSTGRES_SSL_KEY:
            ssl_params.append(f"sslkey={self.POSTGRES_SSL_KEY}")
        if self.POSTGRES_SSL_CA:
            ssl_params.append(f"sslrootcert={self.POSTGRES_SSL_CA}")
        
        if ssl_params:
            url += "?" + "&".join(ssl_params)
        
        return url

class LoggingSettings:
    """ログ設定"""
    
    LOG_LEVEL: str = os.getenv("LOG_LEVEL", "INFO")
    LOG_FORMAT: str = os.getenv(
        "LOG_FORMAT", 
        "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    )
    LOG_FILE: Optional[str] = os.getenv("LOG_FILE")
    LOG_MAX_BYTES: int = int(os.getenv("LOG_MAX_BYTES", "10485760"))  # 10MB
    LOG_BACKUP_COUNT: int = int(os.getenv("LOG_BACKUP_COUNT", "5"))
    
    # セキュリティログ
    SECURITY_LOG_ENABLED: bool = os.getenv("SECURITY_LOG_ENABLED", "True").lower() == "true"
    SECURITY_LOG_FILE: Optional[str] = os.getenv("SECURITY_LOG_FILE", "security.log")

class Settings:
    """統合アプリケーション設定クラス"""
    
    # 環境設定
    ENVIRONMENT: str = os.getenv("ENVIRONMENT", "development")
    DEBUG: bool = os.getenv("DEBUG", "False").lower() == "true"
    
    # アプリケーション基本設定
    APP_NAME: str = os.getenv("APP_NAME", "Modern User Management Dashboard")
    APP_VERSION: str = os.getenv("APP_VERSION", "1.0.0")
    APP_DESCRIPTION: str = os.getenv("APP_DESCRIPTION", "Streamlit + SQLModel Tutorial Application")
    
    # Streamlit設定
    STREAMLIT_PORT: int = int(os.getenv("STREAMLIT_PORT", "8501"))
    STREAMLIT_HOST: str = os.getenv("STREAMLIT_HOST", "0.0.0.0")
    
    # 各種設定クラスのインスタンス
    security = SecuritySettings()
    database = DatabaseSettings()
    logging = LoggingSettings()
    
    def __init__(self):
        """設定の初期化と検証"""
        self.validate_settings()
        self.setup_logging()
    
    def validate_settings(self):
        """設定の検証"""
        errors = []
        
        # 必須環境変数のチェック
        required_vars = {
            "POSTGRES_HOST": self.database.POSTGRES_HOST,
            "POSTGRES_DB": self.database.POSTGRES_DB,
            "POSTGRES_USER": self.database.POSTGRES_USER,
            "POSTGRES_PASSWORD": self.database.POSTGRES_PASSWORD,
        }
        
        for var_name, var_value in required_vars.items():
            if not var_value:
                errors.append(f"必須環境変数 {var_name} が設定されていません")
        
        # 本番環境でのセキュリティチェック
        if self.ENVIRONMENT == "production":
            if self.DEBUG:
                errors.append("本番環境でDEBUGモードが有効になっています")
            
            if self.security.SECRET_KEY == "your-secret-key-here":
                errors.append("本番環境でデフォルトのSECRET_KEYが使用されています")
            
            if self.database.POSTGRES_PASSWORD == "password":
                errors.append("本番環境でデフォルトのデータベースパスワードが使用されています")
        
        if errors:
            error_msg = "\n".join(f"- {error}" for error in errors)
            raise ValueError(f"設定エラー:\n{error_msg}")
    
    def setup_logging(self):
        """ログ設定のセットアップ"""
        # 基本ログ設定
        log_level = getattr(logging, self.logging.LOG_LEVEL.upper())
        logging.basicConfig(
            level=log_level,
            format=self.logging.LOG_FORMAT,
            handlers=self._get_log_handlers()
        )
        
        # セキュリティログの設定
        if self.logging.SECURITY_LOG_ENABLED:
            self._setup_security_logging()
    
    def _get_log_handlers(self) -> List[logging.Handler]:
        """ログハンドラーを取得"""
        handlers = [logging.StreamHandler()]  # コンソール出力
        
        if self.logging.LOG_FILE:
            from logging.handlers import RotatingFileHandler
            file_handler = RotatingFileHandler(
                self.logging.LOG_FILE,
                maxBytes=self.logging.LOG_MAX_BYTES,
                backupCount=self.logging.LOG_BACKUP_COUNT
            )
            file_handler.setFormatter(
                logging.Formatter(self.logging.LOG_FORMAT)
            )
            handlers.append(file_handler)
        
        return handlers
    
    def _setup_security_logging(self):
        """セキュリティログの設定"""
        security_logger = logging.getLogger("security")
        
        if self.logging.SECURITY_LOG_FILE:
            from logging.handlers import RotatingFileHandler
            security_handler = RotatingFileHandler(
                self.logging.SECURITY_LOG_FILE,
                maxBytes=self.logging.LOG_MAX_BYTES,
                backupCount=self.logging.LOG_BACKUP_COUNT
            )
            security_handler.setFormatter(
                logging.Formatter(
                    "%(asctime)s - SECURITY - %(levelname)s - %(message)s"
                )
            )
            security_logger.addHandler(security_handler)
    
    def get_safe_config(self) -> Dict[str, Any]:
        """機密情報を除いた設定を取得（ログ出力用）"""
        return {
            "app_name": self.APP_NAME,
            "app_version": self.APP_VERSION,
            "environment": self.ENVIRONMENT,
            "debug": self.DEBUG,
            "database_host": self.database.POSTGRES_HOST,
            "database_port": self.database.POSTGRES_PORT,
            "database_name": self.database.POSTGRES_DB,
            "streamlit_port": self.STREAMLIT_PORT,
            "log_level": self.logging.LOG_LEVEL,
        }
    
    def __repr__(self) -> str:
        safe_config = self.get_safe_config()
        return f"Settings({safe_config})"

# 設定インスタンスを作成
try:
    settings = Settings()
    logger = logging.getLogger(__name__)
    logger.info(f"アプリケーション設定を初期化しました: {settings.get_safe_config()}")
except Exception as e:
    print(f"設定初期化エラー: {e}")
    raise

# 設定検証用の関数
def validate_production_config() -> List[str]:
    """本番環境設定の検証"""
    warnings = []
    
    if settings.ENVIRONMENT == "production":
        # SSL設定チェック
        if settings.database.POSTGRES_SSL_MODE == "disable":
            warnings.append("本番環境でSSLが無効になっています")
        
        # パスワード強度チェック
        if len(settings.database.POSTGRES_PASSWORD) < 12:
            warnings.append("データベースパスワードが短すぎます（12文字以上推奨）")
        
        # セキュリティ設定チェック
        if not settings.security.RATE_LIMIT_ENABLED:
            warnings.append("レート制限が無効になっています")
    
    return warnings

if __name__ == "__main__":
    print("設定情報:")
    print(settings)
    
    # 本番環境チェック
    warnings = validate_production_config()
    if warnings:
        print("\n⚠️  本番環境の警告:")
        for warning in warnings:
            print(f"- {warning}")
</code></pre>

                        <h6>.env.production サンプル</h6>
                        <pre><code># 本番環境設定ファイル (.env.production)
ENVIRONMENT=production
DEBUG=False

# アプリケーション設定
APP_NAME=Modern User Management Dashboard
APP_VERSION=1.0.0
SECRET_KEY=your-production-secret-key-here

# データベース設定 (本番環境)
POSTGRES_HOST=your-production-db-host
POSTGRES_PORT=5432
POSTGRES_DB=userdb_prod
POSTGRES_USER=app_user
POSTGRES_PASSWORD=your-strong-production-password

# SSL設定
POSTGRES_SSL_MODE=require
POSTGRES_SSL_CERT=/path/to/client-cert.pem
POSTGRES_SSL_KEY=/path/to/client-key.pem
POSTGRES_SSL_CA=/path/to/ca-cert.pem

# セキュリティ設定
SESSION_TIMEOUT=1800
PASSWORD_MIN_LENGTH=12
RATE_LIMIT_ENABLED=True
RATE_LIMIT_REQUESTS=50
RATE_LIMIT_WINDOW=3600

# ログ設定
LOG_LEVEL=INFO
LOG_FILE=/var/log/app/application.log
SECURITY_LOG_ENABLED=True
SECURITY_LOG_FILE=/var/log/app/security.log

# Streamlit設定
STREAMLIT_HOST=0.0.0.0
STREAMLIT_PORT=8501</code></pre>

                        <h6>期待される結果</h6>
                        <p>環境変数による設定管理が強化され、セキュリティ設定と本番環境対応が実装されることを確認してください。</p>
                    </div>

                    <!-- セクション3: 認証機能 -->
                    <h3 class="section-title">6.3 基本認証機能の実装</h3>
                    
                    <p>Streamlitアプリケーションに基本的な認証機能を追加します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-2: 認証機能の実装</h5>
                        <p>ユーザー認証とセッション管理を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>認証モデルの作成</li>
                            <li>パスワードハッシュ化</li>
                            <li>ログイン・ログアウト機能</li>
                            <li>セッション管理強化</li>
                            <li>権限ベースアクセス制御</li>
                        </ol>

                        <h6>app/models/auth.py作成</h6>
                        <pre><code>"""
認証関連モデル
ユーザー認証、セッション管理
"""

from typing import Optional, List
from datetime import datetime, timedelta
from sqlmodel import SQLModel, Field, Relationship
from passlib.context import CryptContext
from pydantic import EmailStr
import secrets
import hashlib

# パスワードハッシュ化設定
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

class AuthUser(SQLModel, table=True):
    """認証ユーザーモデル"""
    __tablename__ = "auth_users"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(unique=True, index=True, min_length=3, max_length=50)
    email: EmailStr = Field(unique=True, index=True)
    hashed_password: str = Field(min_length=8)
    full_name: str = Field(max_length=100)
    
    # 権限とステータス
    is_active: bool = Field(default=True)
    is_superuser: bool = Field(default=False)
    role: str = Field(default="user")  # user, admin, moderator
    
    # セキュリティ関連
    last_login: Optional[datetime] = None
    login_attempts: int = Field(default=0)
    locked_until: Optional[datetime] = None
    password_changed_at: datetime = Field(default_factory=datetime.utcnow)
    
    # メタデータ
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    
    def verify_password(self, password: str) -> bool:
        """パスワードを検証"""
        return pwd_context.verify(password, self.hashed_password)
    
    def set_password(self, password: str):
        """パスワードをハッシュ化して設定"""
        self.hashed_password = pwd_context.hash(password)
        self.password_changed_at = datetime.utcnow()
    
    def is_locked(self) -> bool:
        """アカウントがロックされているかチェック"""
        if self.locked_until is None:
            return False
        return datetime.utcnow() < self.locked_until
    
    def lock_account(self, duration_minutes: int = 30):
        """アカウントをロック"""
        self.locked_until = datetime.utcnow() + timedelta(minutes=duration_minutes)
    
    def unlock_account(self):
        """アカウントのロックを解除"""
        self.locked_until = None
        self.login_attempts = 0
    
    def record_login_attempt(self, success: bool):
        """ログイン試行を記録"""
        if success:
            self.last_login = datetime.utcnow()
            self.login_attempts = 0
        else:
            self.login_attempts += 1
            # 5回失敗でアカウントロック
            if self.login_attempts >= 5:
                self.lock_account()

class UserSession(SQLModel, table=True):
    """ユーザーセッションモデル"""
    __tablename__ = "user_sessions"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    session_token: str = Field(unique=True, index=True)
    user_id: int = Field(foreign_key="auth_users.id")
    
    # セッション情報
    created_at: datetime = Field(default_factory=datetime.utcnow)
    last_accessed: datetime = Field(default_factory=datetime.utcnow)
    expires_at: datetime
    
    # クライアント情報
    ip_address: Optional[str] = None
    user_agent: Optional[str] = None
    
    # セッション状態
    is_active: bool = Field(default=True)
    
    @classmethod
    def create_session(
        cls, 
        user_id: int, 
        duration_hours: int = 24,
        ip_address: Optional[str] = None,
        user_agent: Optional[str] = None
    ) -> "UserSession":
        """新しいセッションを作成"""
        session_token = secrets.token_urlsafe(32)
        expires_at = datetime.utcnow() + timedelta(hours=duration_hours)
        
        return cls(
            session_token=session_token,
            user_id=user_id,
            expires_at=expires_at,
            ip_address=ip_address,
            user_agent=user_agent
        )
    
    def is_expired(self) -> bool:
        """セッションが期限切れかチェック"""
        return datetime.utcnow() > self.expires_at
    
    def extend_session(self, hours: int = 24):
        """セッションを延長"""
        self.expires_at = datetime.utcnow() + timedelta(hours=hours)
        self.last_accessed = datetime.utcnow()

class LoginAttempt(SQLModel, table=True):
    """ログイン試行履歴"""
    __tablename__ = "login_attempts"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(index=True)
    ip_address: Optional[str] = None
    user_agent: Optional[str] = None
    success: bool
    failure_reason: Optional[str] = None
    attempted_at: datetime = Field(default_factory=datetime.utcnow)

# 認証関連の型定義
class LoginRequest(SQLModel):
    """ログインリクエスト"""
    username: str
    password: str
    remember_me: bool = False

class LoginResponse(SQLModel):
    """ログインレスポンス"""
    success: bool
    message: str
    session_token: Optional[str] = None
    user_info: Optional[dict] = None

class PasswordChangeRequest(SQLModel):
    """パスワード変更リクエスト"""
    current_password: str
    new_password: str
    confirm_password: str

class UserRole:
    """ユーザー権限定義"""
    USER = "user"
    MODERATOR = "moderator"
    ADMIN = "admin"
    SUPERUSER = "superuser"
    
    @classmethod
    def get_permissions(cls, role: str) -> List[str]:
        """ロールに基づく権限を取得"""
        permissions = {
            cls.USER: ["read_own", "update_own"],
            cls.MODERATOR: ["read_own", "update_own", "read_users", "moderate_content"],
            cls.ADMIN: ["read_own", "update_own", "read_users", "update_users", "delete_users", "manage_system"],
            cls.SUPERUSER: ["all"]
        }
        return permissions.get(role, [])</code></pre>

                        <h6>app/auth/auth_manager.py作成</h6>
                        <pre><code>"""
認証管理機能
ログイン、ログアウト、セッション管理
"""

import streamlit as st
from typing import Optional, Dict, Any
from datetime import datetime
import logging

from app.database.connection import get_db_session
from app.models.auth import AuthUser, UserSession, LoginAttempt, LoginRequest, LoginResponse
from app.config import settings

logger = logging.getLogger(__name__)
security_logger = logging.getLogger("security")

class AuthManager:
    """認証管理クラス"""
    
    @staticmethod
    def initialize_auth():
        """認証システムの初期化"""
        if 'authenticated' not in st.session_state:
            st.session_state.authenticated = False
        
        if 'current_user' not in st.session_state:
            st.session_state.current_user = None
        
        if 'session_token' not in st.session_state:
            st.session_state.session_token = None
    
    @staticmethod
    def login(username: str, password: str, remember_me: bool = False) -> LoginResponse:
        """ユーザーログイン"""
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            # ユーザー取得
            from sqlmodel import select
            statement = select(AuthUser).where(AuthUser.username == username)
            user = session.exec(statement).first()
            
            # ログイン試行を記録
            AuthManager._record_login_attempt(session, username, user is not None and user.verify_password(password))
            
            if not user:
                security_logger.warning(f"存在しないユーザーでのログイン試行: {username}")
                return LoginResponse(success=False, message="ユーザー名またはパスワードが正しくありません")
            
            if not user.is_active:
                security_logger.warning(f"非アクティブユーザーでのログイン試行: {username}")
                return LoginResponse(success=False, message="アカウントが無効化されています")
            
            if user.is_locked():
                security_logger.warning(f"ロックされたアカウントでのログイン試行: {username}")
                return LoginResponse(success=False, message="アカウントがロックされています。しばらく待ってから再試行してください")
            
            if not user.verify_password(password):
                user.record_login_attempt(False)
                session.add(user)
                session.commit()
                
                security_logger.warning(f"パスワード不正でのログイン試行: {username}")
                return LoginResponse(success=False, message="ユーザー名またはパスワードが正しくありません")
            
            # ログイン成功
            user.record_login_attempt(True)
            
            # セッション作成
            duration = 24 * 7 if remember_me else 24  # Remember me の場合は1週間
            user_session = UserSession.create_session(
                user_id=user.id,
                duration_hours=duration,
                ip_address=AuthManager._get_client_ip(),
                user_agent=AuthManager._get_user_agent()
            )
            
            session.add(user)
            session.add(user_session)
            session.commit()
            
            # Streamlitセッションに保存
            st.session_state.authenticated = True
            st.session_state.current_user = {
                'id': user.id,
                'username': user.username,
                'email': user.email,
                'full_name': user.full_name,
                'role': user.role,
                'is_superuser': user.is_superuser
            }
            st.session_state.session_token = user_session.session_token
            
            security_logger.info(f"ユーザーログイン成功: {username}")
            
            return LoginResponse(
                success=True,
                message="ログインに成功しました",
                session_token=user_session.session_token,
                user_info=st.session_state.current_user
            )
            
        except Exception as e:
            logger.error(f"ログインエラー: {e}")
            return LoginResponse(success=False, message="ログイン処理中にエラーが発生しました")
        finally:
            session.close()
    
    @staticmethod
    def logout():
        """ユーザーログアウト"""
        try:
            if st.session_state.get('session_token'):
                session_gen = get_db_session()
                session = next(session_gen)
                
                # セッションを無効化
                from sqlmodel import select
                statement = select(UserSession).where(UserSession.session_token == st.session_state.session_token)
                user_session = session.exec(statement).first()
                
                if user_session:
                    user_session.is_active = False
                    session.add(user_session)
                    session.commit()
                
                session.close()
            
            # Streamlitセッションをクリア
            st.session_state.authenticated = False
            st.session_state.current_user = None
            st.session_state.session_token = None
            
            security_logger.info("ユーザーログアウト")
            
        except Exception as e:
            logger.error(f"ログアウトエラー: {e}")
    
    @staticmethod
    def check_session() -> bool:
        """セッション有効性をチェック"""
        if not st.session_state.get('authenticated') or not st.session_state.get('session_token'):
            return False
        
        try:
            session_gen = get_db_session()
            session = next(session_gen)
            
            from sqlmodel import select
            statement = select(UserSession).where(
                UserSession.session_token == st.session_state.session_token,
                UserSession.is_active == True
            )
            user_session = session.exec(statement).first()
            
            if not user_session or user_session.is_expired():
                AuthManager.logout()
                return False
            
            # セッションを延長
            user_session.extend_session()
            session.add(user_session)
            session.commit()
            
            session.close()
            return True
            
        except Exception as e:
            logger.error(f"セッションチェックエラー: {e}")
            return False
    
    @staticmethod
    def require_auth(func):
        """認証が必要な関数のデコレータ"""
        def wrapper(*args, **kwargs):
            if not AuthManager.check_session():
                st.error("この機能を使用するにはログインが必要です")
                AuthManager.show_login_form()
                return None
            return func(*args, **kwargs)
        return wrapper
    
    @staticmethod
    def require_role(required_role: str):
        """特定のロールが必要な関数のデコレータ"""
        def decorator(func):
            def wrapper(*args, **kwargs):
                if not AuthManager.check_session():
                    st.error("この機能を使用するにはログインが必要です")
                    return None
                
                user = st.session_state.get('current_user')
                if not user or not AuthManager.has_permission(user['role'], required_role):
                    st.error("この機能を使用する権限がありません")
                    return None
                
                return func(*args, **kwargs)
            return wrapper
        return decorator
    
    @staticmethod
    def has_permission(user_role: str, required_role: str) -> bool:
        """権限チェック"""
        role_hierarchy = {
            'user': 1,
            'moderator': 2,
            'admin': 3,
            'superuser': 4
        }
        
        user_level = role_hierarchy.get(user_role, 0)
        required_level = role_hierarchy.get(required_role, 999)
        
        return user_level >= required_level
    
    @staticmethod
    def show_login_form():
        """ログインフォームを表示"""
        st.subheader("🔐 ログイン")
        
        with st.form("login_form"):
            username = st.text_input("ユーザー名")
            password = st.text_input("パスワード", type="password")
            remember_me = st.checkbox("ログイン状態を保持")
            
            submitted = st.form_submit_button("ログイン")
            
            if submitted:
                if username and password:
                    response = AuthManager.login(username, password, remember_me)
                    
                    if response.success:
                        st.success(response.message)
                        st.rerun()
                    else:
                        st.error(response.message)
                else:
                    st.error("ユーザー名とパスワードを入力してください")
    
    @staticmethod
    def _record_login_attempt(session, username: str, success: bool):
        """ログイン試行を記録"""
        attempt = LoginAttempt(
            username=username,
            ip_address=AuthManager._get_client_ip(),
            user_agent=AuthManager._get_user_agent(),
            success=success,
            failure_reason=None if success else "Invalid credentials"
        )
        session.add(attempt)
    
    @staticmethod
    def _get_client_ip() -> str:
        """クライアントIPアドレスを取得"""
        # Streamlitでは直接取得できないため、プレースホルダー
        return "127.0.0.1"
    
    @staticmethod
    def _get_user_agent() -> str:
        """ユーザーエージェントを取得"""
        # Streamlitでは直接取得できないため、プレースホルダー
        return "Streamlit App"</code></pre>

                        <h6>期待される結果</h6>
                        <p>基本的な認証機能が実装され、ユーザーログイン・ログアウト・セッション管理が動作することを確認してください。</p>
                    </div>

                    <!-- セクション4: ログ機能とモニタリング -->
                    <h3 class="section-title">6.4 ログ機能とセキュリティモニタリング</h3>
                    
                    <p>セキュリティイベントの追跡とモニタリング機能を実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-3: ログ機能とモニタリングの実装</h5>
                        <p>包括的なログ機能とセキュリティモニタリングを実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>構造化ログの実装</li>
                            <li>セキュリティイベントの追跡</li>
                            <li>パフォーマンスモニタリング</li>
                            <li>エラートラッキング</li>
                            <li>ログ分析ダッシュボード</li>
                        </ol>

                        <h6>app/utils/monitoring.py作成</h6>
                        <pre><code>"""
モニタリングとログ機能
セキュリティイベント、パフォーマンス、エラートラッキング
"""

import logging
import time
import traceback
from datetime import datetime, timedelta
from typing import Dict, Any, List, Optional
from functools import wraps
import streamlit as st
import psutil
import threading

from app.config import settings

# 専用ロガーの設定
app_logger = logging.getLogger("app")
security_logger = logging.getLogger("security")
performance_logger = logging.getLogger("performance")
error_logger = logging.getLogger("error")

class SecurityMonitor:
    """セキュリティモニタリングクラス"""
    
    @staticmethod
    def log_security_event(
        event_type: str,
        user_id: Optional[int] = None,
        username: Optional[str] = None,
        description: str = "",
        severity: str = "INFO",
        additional_data: Optional[Dict[str, Any]] = None
    ):
        """セキュリティイベントをログに記録"""
        event_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "event_type": event_type,
            "user_id": user_id,
            "username": username,
            "description": description,
            "severity": severity,
            "session_id": id(st.session_state),
            "additional_data": additional_data or {}
        }
        
        log_level = getattr(logging, severity.upper(), logging.INFO)
        security_logger.log(log_level, f"SECURITY_EVENT: {event_data}")
        
        # 重要なイベントの場合はアラート
        if severity in ["WARNING", "ERROR", "CRITICAL"]:
            SecurityMonitor._trigger_security_alert(event_data)
    
    @staticmethod
    def _trigger_security_alert(event_data: Dict[str, Any]):
        """セキュリティアラートをトリガー"""
        # 実際の実装では、メール送信やSlack通知などを行う
        app_logger.critical(f"SECURITY_ALERT: {event_data}")
    
    @staticmethod
    def track_login_attempt(username: str, success: bool, ip_address: str = "unknown"):
        """ログイン試行を追跡"""
        event_type = "LOGIN_SUCCESS" if success else "LOGIN_FAILURE"
        severity = "INFO" if success else "WARNING"
        description = f"ログイン{'成功' if success else '失敗'}: {username}"
        
        SecurityMonitor.log_security_event(
            event_type=event_type,
            username=username,
            description=description,
            severity=severity,
            additional_data={"ip_address": ip_address}
        )
    
    @staticmethod
    def track_data_access(
        operation: str, 
        table_name: str, 
        record_id: Optional[int] = None,
        user_id: Optional[int] = None
    ):
        """データアクセスを追跡"""
        SecurityMonitor.log_security_event(
            event_type="DATA_ACCESS",
            user_id=user_id,
            description=f"データ操作: {operation} on {table_name}",
            additional_data={
                "operation": operation,
                "table_name": table_name,
                "record_id": record_id
            }
        )
    
    @staticmethod
    def track_permission_violation(
        user_id: int,
        attempted_action: str,
        required_permission: str
    ):
        """権限違反を追跡"""
        SecurityMonitor.log_security_event(
            event_type="PERMISSION_VIOLATION",
            user_id=user_id,
            description=f"権限不足: {attempted_action} (必要権限: {required_permission})",
            severity="WARNING",
            additional_data={
                "attempted_action": attempted_action,
                "required_permission": required_permission
            }
        )

class PerformanceMonitor:
    """パフォーマンスモニタリングクラス"""
    
    def __init__(self):
        self.metrics = {}
        self.start_time = time.time()
    
    @staticmethod
    def measure_execution_time(func_name: str = None):
        """実行時間を測定するデコレータ"""
        def decorator(func):
            @wraps(func)
            def wrapper(*args, **kwargs):
                start_time = time.time()
                try:
                    result = func(*args, **kwargs)
                    execution_time = time.time() - start_time
                    
                    # パフォーマンスログ
                    performance_logger.info(
                        f"PERFORMANCE: {func_name or func.__name__} "
                        f"executed in {execution_time:.4f}s"
                    )
                    
                    # 閾値チェック
                    if execution_time > 5.0:  # 5秒以上
                        performance_logger.warning(
                            f"SLOW_QUERY: {func_name or func.__name__} "
                            f"took {execution_time:.4f}s"
                        )
                    
                    return result
                except Exception as e:
                    execution_time = time.time() - start_time
                    error_logger.error(
                        f"ERROR_WITH_TIMING: {func_name or func.__name__} "
                        f"failed after {execution_time:.4f}s: {e}"
                    )
                    raise
            return wrapper
        return decorator
    
    @staticmethod
    def get_system_metrics() -> Dict[str, Any]:
        """システムメトリクスを取得"""
        try:
            cpu_percent = psutil.cpu_percent(interval=1)
            memory = psutil.virtual_memory()
            disk = psutil.disk_usage('/')
            
            return {
                "timestamp": datetime.utcnow().isoformat(),
                "cpu_percent": cpu_percent,
                "memory_percent": memory.percent,
                "memory_available_mb": memory.available // (1024 * 1024),
                "disk_percent": disk.percent,
                "disk_free_gb": disk.free // (1024 ** 3)
            }
        except Exception as e:
            app_logger.error(f"システムメトリクス取得エラー: {e}")
            return {}
    
    @staticmethod
    def log_database_metrics(query_count: int, connection_pool_size: int):
        """データベースメトリクスをログ"""
        performance_logger.info(
            f"DB_METRICS: queries={query_count}, "
            f"pool_size={connection_pool_size}"
        )

class ErrorTracker:
    """エラートラッキングクラス"""
    
    @staticmethod
    def track_error(
        error: Exception,
        context: str = "",
        user_id: Optional[int] = None,
        additional_data: Optional[Dict[str, Any]] = None
    ):
        """エラーを追跡"""
        error_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "error_type": type(error).__name__,
            "error_message": str(error),
            "context": context,
            "user_id": user_id,
            "traceback": traceback.format_exc(),
            "additional_data": additional_data or {}
        }
        
        error_logger.error(f"ERROR_TRACKED: {error_data}")
        
        # 重要なエラーの場合はセキュリティログにも記録
        if isinstance(error, (PermissionError, ValueError)):
            SecurityMonitor.log_security_event(
                event_type="APPLICATION_ERROR",
                user_id=user_id,
                description=f"アプリケーションエラー: {error}",
                severity="ERROR",
                additional_data=error_data
            )
    
    @staticmethod
    def track_streamlit_error(func):
        """Streamlit関数のエラートラッキングデコレータ"""
        @wraps(func)
        def wrapper(*args, **kwargs):
            try:
                return func(*args, **kwargs)
            except Exception as e:
                ErrorTracker.track_error(
                    error=e,
                    context=f"Streamlit function: {func.__name__}",
                    user_id=st.session_state.get('current_user', {}).get('id')
                )
                # エラーを再発生させる
                raise
        return wrapper

class LogAnalyzer:
    """ログ分析クラス"""
    
    @staticmethod
    def get_security_summary(hours: int = 24) -> Dict[str, Any]:
        """セキュリティサマリーを取得"""
        # 実際の実装では、ログファイルやデータベースから集計
        return {
            "login_attempts": 45,
            "successful_logins": 42,
            "failed_logins": 3,
            "security_events": 8,
            "period_hours": hours
        }
    
    @staticmethod
    def get_performance_summary(hours: int = 24) -> Dict[str, Any]:
        """パフォーマンスサマリーを取得"""
        return {
            "avg_response_time": 1.2,
            "slow_queries": 3,
            "total_requests": 156,
            "error_rate": 0.02,
            "period_hours": hours
        }
    
    @staticmethod
    def get_error_summary(hours: int = 24) -> Dict[str, Any]:
        """エラーサマリーを取得"""
        return {
            "total_errors": 5,
            "critical_errors": 0,
            "warning_errors": 2,
            "info_errors": 3,
            "period_hours": hours
        }

class MonitoringDashboard:
    """モニタリングダッシュボード"""
    
    @staticmethod
    def show_security_dashboard():
        """セキュリティダッシュボードを表示"""
        st.subheader("🔒 セキュリティダッシュボード")
        
        # セキュリティサマリー
        summary = LogAnalyzer.get_security_summary()
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("総ログイン試行", summary["login_attempts"])
        
        with col2:
            st.metric("成功ログイン", summary["successful_logins"])
        
        with col3:
            failed_logins = summary["failed_logins"]
            st.metric(
                "失敗ログイン", 
                failed_logins,
                delta=f"警戒レベル: {'高' if failed_logins > 10 else '低'}"
            )
        
        with col4:
            st.metric("セキュリティイベント", summary["security_events"])
        
        # セキュリティイベント履歴
        with st.expander("🔍 セキュリティイベント履歴"):
            # 実際の実装では、データベースから取得
            st.info("セキュリティイベントの詳細履歴機能は実装予定です")
    
    @staticmethod
    def show_performance_dashboard():
        """パフォーマンスダッシュボードを表示"""
        st.subheader("⚡ パフォーマンスダッシュボード")
        
        # システムメトリクス
        metrics = PerformanceMonitor.get_system_metrics()
        
        if metrics:
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric("CPU使用率", f"{metrics.get('cpu_percent', 0):.1f}%")
            
            with col2:
                st.metric("メモリ使用率", f"{metrics.get('memory_percent', 0):.1f}%")
            
            with col3:
                st.metric("ディスク使用率", f"{metrics.get('disk_percent', 0):.1f}%")
        
        # パフォーマンスサマリー
        perf_summary = LogAnalyzer.get_performance_summary()
        
        with st.expander("📊 パフォーマンス詳細"):
            col1, col2 = st.columns(2)
            
            with col1:
                st.metric("平均応答時間", f"{perf_summary['avg_response_time']:.2f}秒")
                st.metric("遅いクエリ", perf_summary['slow_queries'])
            
            with col2:
                st.metric("総リクエスト数", perf_summary['total_requests'])
                st.metric("エラー率", f"{perf_summary['error_rate']:.1%}")
    
    @staticmethod
    def show_error_dashboard():
        """エラーダッシュボードを表示"""
        st.subheader("🚨 エラーダッシュボード")
        
        error_summary = LogAnalyzer.get_error_summary()
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("総エラー数", error_summary["total_errors"])
        
        with col2:
            critical = error_summary["critical_errors"]
            st.metric(
                "クリティカルエラー", 
                critical,
                delta="🚨" if critical > 0 else "✅"
            )
        
        with col3:
            st.metric("警告エラー", error_summary["warning_errors"])
        
        with col4:
            st.metric("情報エラー", error_summary["info_errors"])
        
        # エラー詳細
        with st.expander("📋 エラー詳細"):
            st.info("エラー詳細の表示機能は実装予定です")

# 使用例とヘルパー関数
def log_user_action(action: str, details: Dict[str, Any] = None):
    """ユーザーアクションをログ"""
    user = st.session_state.get('current_user', {})
    
    app_logger.info(
        f"USER_ACTION: user_id={user.get('id')}, "
        f"username={user.get('username')}, "
        f"action={action}, "
        f"details={details or {}}"
    )

def monitor_database_operation(operation: str):
    """データベース操作の監視デコレータ"""
    def decorator(func):
        @wraps(func)
        @PerformanceMonitor.measure_execution_time(f"db_{operation}")
        def wrapper(*args, **kwargs):
            user = st.session_state.get('current_user', {})
            
            try:
                result = func(*args, **kwargs)
                
                # 成功をログ
                SecurityMonitor.track_data_access(
                    operation=operation,
                    table_name="users",  # 実際のテーブル名に置き換え
                    user_id=user.get('id')
                )
                
                return result
            
            except Exception as e:
                # エラーをトラッキング
                ErrorTracker.track_error(
                    error=e,
                    context=f"Database operation: {operation}",
                    user_id=user.get('id')
                )
                raise
        
        return wrapper
    return decorator</code></pre>

                        <h6>期待される結果</h6>
                        <p>包括的なログ機能とモニタリング機能が実装され、セキュリティイベントやパフォーマンス情報が適切に追跡されることを確認してください。</p>
                    </div>

                    <!-- セクション5: 本番環境設定 -->
                    <h3 class="section-title">6.5 本番環境PostgreSQL設定</h3>
                    
                    <p>本番環境での PostgreSQL の最適化とセキュリティ設定を行います。</p>

                    <div class="exercise-container">
                        <h5>実習 6-4: 本番環境PostgreSQL設定</h5>
                        <p>本番環境向けのPostgreSQL設定とセキュリティ強化を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>本番用Docker Compose設定</li>
                            <li>PostgreSQL設定の最適化</li>
                            <li>SSL/TLS設定</li>
                            <li>バックアップとリストア</li>
                            <li>接続プール最適化</li>
                        </ol>

                        <h6>docker-compose.prod.yml作成</h6>
                        <pre><code># 本番環境用Docker Compose設定
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: streamlit_postgres_prod
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      # データ永続化
      - postgres_prod_data:/var/lib/postgresql/data
      # 設定ファイル
      - ./docker/postgres/prod/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./docker/postgres/prod/pg_hba.conf:/etc/postgresql/pg_hba.conf
      # 初期化スクリプト
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
      # SSL証明書（本番環境）
      - ./docker/postgres/ssl:/etc/ssl/postgres:ro
      # バックアップ用ディレクトリ
      - ./backups:/backups
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
    networks:
      - streamlit_prod_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Redis for session management (optional)
  redis:
    image: redis:7-alpine
    container_name: streamlit_redis_prod
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_prod_data:/data
      - ./docker/redis/redis.conf:/etc/redis/redis.conf
    command: redis-server /etc/redis/redis.conf
    networks:
      - streamlit_prod_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx reverse proxy (optional)
  nginx:
    image: nginx:alpine
    container_name: streamlit_nginx_prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - postgres
    networks:
      - streamlit_prod_network

volumes:
  postgres_prod_data:
    driver: local
  redis_prod_data:
    driver: local

networks:
  streamlit_prod_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16</code></pre>

                        <h6>docker/postgres/prod/postgresql.conf作成</h6>
                        <pre><code># PostgreSQL 本番環境設定

# 接続設定
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# メモリ設定
shared_buffers = 512MB
effective_cache_size = 2GB
maintenance_work_mem = 256MB
work_mem = 8MB

# WAL設定
wal_level = replica
max_wal_size = 2GB
min_wal_size = 256MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB

# ログ設定
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_statement = 'mod'

# セキュリティ設定
ssl = on
ssl_cert_file = '/etc/ssl/postgres/server.crt'
ssl_key_file = '/etc/ssl/postgres/server.key'
ssl_ca_file = '/etc/ssl/postgres/ca.crt'
ssl_ciphers = 'HIGH:MEDIUM:!aNULL:!MD5:!3DES'
ssl_prefer_server_ciphers = on

# 認証設定
password_encryption = scram-sha-256

# パフォーマンス設定
random_page_cost = 1.1
effective_io_concurrency = 200
max_worker_processes = 8
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4

# 統計情報設定
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
stats_temp_directory = '/var/run/postgresql/stats_temp'

# オートバキューム設定
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1

# タイムゾーン
timezone = 'Asia/Tokyo'
log_timezone = 'Asia/Tokyo'</code></pre>

                        <h6>docker/postgres/prod/pg_hba.conf作成</h6>
                        <pre><code># PostgreSQL Host-Based Authentication 本番環境設定

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" は Unix domain socket 接続用
local   all             postgres                                peer
local   all             all                                     scram-sha-256

# IPv4 local connections:
host    all             postgres        127.0.0.1/32            scram-sha-256
host    all             all             127.0.0.1/32            scram-sha-256

# IPv6 local connections:
host    all             postgres        ::1/128                 scram-sha-256
host    all             all             ::1/128                 scram-sha-256

# 本番環境のアプリケーションからの接続
host    all             app_user        172.20.0.0/16           scram-sha-256

# SSL接続必須
hostssl all             all             0.0.0.0/0               scram-sha-256

# レプリケーション接続（必要に応じて）
# host    replication     replicator      192.168.1.0/24          scram-sha-256</code></pre>

                        <h6>バックアップスクリプト (backup.sh)</h6>
                        <pre><code>#!/bin/bash
# PostgreSQL バックアップスクリプト

set -e

# 設定
BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="${POSTGRES_DB:-userdb}"
DB_USER="${POSTGRES_USER:-postgres}"
CONTAINER_NAME="streamlit_postgres_prod"

# バックアップディレクトリ作成
mkdir -p ${BACKUP_DIR}

echo "Starting backup at $(date)"

# SQLダンプの作成
docker exec ${CONTAINER_NAME} pg_dump \
    -U ${DB_USER} \
    -d ${DB_NAME} \
    --verbose \
    --clean \
    --no-owner \
    --no-privileges \
    --format=custom \
    > ${BACKUP_DIR}/backup_${DB_NAME}_${DATE}.dump

# 圧縮
gzip ${BACKUP_DIR}/backup_${DB_NAME}_${DATE}.dump

echo "Backup completed: backup_${DB_NAME}_${DATE}.dump.gz"

# 古いバックアップの削除（7日以上前）
find ${BACKUP_DIR} -name "backup_*.dump.gz" -mtime +7 -delete

echo "Old backups cleaned up"

# バックアップ検証
gunzip -c ${BACKUP_DIR}/backup_${DB_NAME}_${DATE}.dump.gz | head -n 20

echo "Backup verification completed"</code></pre>

                        <h6>リストアスクリプト (restore.sh)</h6>
                        <pre><code>#!/bin/bash
# PostgreSQL リストアスクリプト

set -e

if [ $# -ne 1 ]; then
    echo "Usage: $0 <backup_file>"
    echo "Example: $0 backup_userdb_20231201_120000.dump.gz"
    exit 1
fi

BACKUP_FILE=$1
DB_NAME="${POSTGRES_DB:-userdb}"
DB_USER="${POSTGRES_USER:-postgres}"
CONTAINER_NAME="streamlit_postgres_prod"

if [ ! -f "/backups/${BACKUP_FILE}" ]; then
    echo "Backup file not found: /backups/${BACKUP_FILE}"
    exit 1
fi

echo "Starting restore from ${BACKUP_FILE} at $(date)"

# バックアップファイルを展開
if [[ ${BACKUP_FILE} == *.gz ]]; then
    gunzip -c /backups/${BACKUP_FILE} > /tmp/restore.dump
    DUMP_FILE="/tmp/restore.dump"
else
    DUMP_FILE="/backups/${BACKUP_FILE}"
fi

# データベースをリストア
docker exec -i ${CONTAINER_NAME} pg_restore \
    -U ${DB_USER} \
    -d ${DB_NAME} \
    --verbose \
    --clean \
    --no-owner \
    --no-privileges \
    < ${DUMP_FILE}

# 一時ファイル削除
if [ -f "/tmp/restore.dump" ]; then
    rm /tmp/restore.dump
fi

echo "Restore completed at $(date)"</code></pre>

                        <h6>期待される結果</h6>
                        <p>本番環境向けのPostgreSQL設定が完了し、SSL接続、バックアップ・リストア機能、パフォーマンス最適化が実装されることを確認してください。</p>
                    </div>

                    <!-- セクション6: デプロイ準備 -->
                    <h3 class="section-title">6.6 デプロイ準備とベストプラクティス</h3>
                    
                    <p>本番環境でのデプロイに向けた最終的な準備と設定を行います。</p>

                    <div class="exercise-container">
                        <h5>実習 6-5: デプロイ準備とセキュリティチェック</h5>
                        <p>本番環境デプロイ前の最終チェックと設定を実施します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>セキュリティチェックリストの作成</li>
                            <li>環境設定の検証</li>
                            <li>パフォーマンステスト</li>
                            <li>ヘルスチェック機能</li>
                            <li>デプロイスクリプト作成</li>
                        </ol>

                        <h6>セキュリティチェックリスト</h6>
                        <div class="security-checklist">
                            <h6>🔒 本番環境セキュリティチェックリスト</h6>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check1">
                                <label for="check1">環境変数でのシークレット管理</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check2">
                                <label for="check2">PostgreSQL SSL/TLS 有効化</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check3">
                                <label for="check3">デフォルトパスワードの変更</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check4">
                                <label for="check4">デバッグモードの無効化</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check5">
                                <label for="check5">ログ設定の適切な構成</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check6">
                                <label for="check6">レート制限の有効化</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check7">
                                <label for="check7">セキュリティヘッダーの設定</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check8">
                                <label for="check8">バックアップ機能の確認</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check9">
                                <label for="check9">モニタリング機能の動作確認</label>
                            </div>
                            
                            <div class="checklist-item">
                                <input type="checkbox" id="check10">
                                <label for="check10">エラーハンドリングの検証</label>
                            </div>
                        </div>

                        <h6>app/utils/health_check.py作成</h6>
                        <pre><code>"""
ヘルスチェック機能
アプリケーションとデータベースの健全性チェック
"""

import streamlit as st
from typing import Dict, Any, List
from datetime import datetime
import time
import psutil

from app.database.connection import db_manager
from app.config import settings
from app.utils.monitoring import PerformanceMonitor

class HealthChecker:
    """ヘルスチェッククラス"""
    
    @staticmethod
    def run_all_checks() -> Dict[str, Any]:
        """全ての健全性チェックを実行"""
        checks = {
            "database": HealthChecker.check_database(),
            "configuration": HealthChecker.check_configuration(),
            "system_resources": HealthChecker.check_system_resources(),
            "security": HealthChecker.check_security_settings(),
            "performance": HealthChecker.check_performance()
        }
        
        # 全体的な健全性判定
        overall_status = "healthy"
        critical_issues = []
        
        for check_name, check_result in checks.items():
            if check_result["status"] == "critical":
                overall_status = "critical"
                critical_issues.append(check_name)
            elif check_result["status"] == "warning" and overall_status == "healthy":
                overall_status = "warning"
        
        return {
            "overall_status": overall_status,
            "timestamp": datetime.utcnow().isoformat(),
            "critical_issues": critical_issues,
            "checks": checks
        }
    
    @staticmethod
    def check_database() -> Dict[str, Any]:
        """データベース接続チェック"""
        try:
            start_time = time.time()
            
            # 接続テスト
            connection_ok = db_manager.test_connection()
            connection_time = time.time() - start_time
            
            if not connection_ok:
                return {
                    "status": "critical",
                    "message": "データベース接続失敗",
                    "details": {"connection_time": connection_time}
                }
            
            # 接続時間チェック
            if connection_time > 5.0:
                status = "warning"
                message = f"データベース接続が遅い ({connection_time:.2f}秒)"
            else:
                status = "healthy"
                message = "データベース接続正常"
            
            return {
                "status": status,
                "message": message,
                "details": {
                    "connection_time": connection_time,
                    "database_url_masked": settings.database.POSTGRES_HOST
                }
            }
            
        except Exception as e:
            return {
                "status": "critical",
                "message": f"データベースチェックエラー: {e}",
                "details": {"error": str(e)}
            }
    
    @staticmethod
    def check_configuration() -> Dict[str, Any]:
        """設定チェック"""
        issues = []
        warnings = []
        
        # 本番環境チェック
        if settings.ENVIRONMENT == "production":
            if settings.DEBUG:
                issues.append("本番環境でDEBUGモードが有効")
            
            if settings.security.SECRET_KEY == "your-secret-key-here":
                issues.append("デフォルトのSECRET_KEYが使用されている")
            
            if settings.database.POSTGRES_PASSWORD == "password":
                issues.append("デフォルトのデータベースパスワード")
            
            if not settings.security.RATE_LIMIT_ENABLED:
                warnings.append("レート制限が無効")
        
        # SSL設定チェック
        if settings.database.POSTGRES_SSL_MODE == "disable":
            warnings.append("データベースSSLが無効")
        
        if issues:
            return {
                "status": "critical",
                "message": f"{len(issues)}個の重要な設定問題",
                "details": {"issues": issues, "warnings": warnings}
            }
        elif warnings:
            return {
                "status": "warning",
                "message": f"{len(warnings)}個の設定警告",
                "details": {"warnings": warnings}
            }
        else:
            return {
                "status": "healthy",
                "message": "設定正常",
                "details": {"environment": settings.ENVIRONMENT}
            }
    
    @staticmethod
    def check_system_resources() -> Dict[str, Any]:
        """システムリソースチェック"""
        try:
            metrics = PerformanceMonitor.get_system_metrics()
            
            if not metrics:
                return {
                    "status": "warning",
                    "message": "システムメトリクス取得失敗",
                    "details": {}
                }
            
            issues = []
            warnings = []
            
            # CPU使用率チェック
            cpu_percent = metrics.get("cpu_percent", 0)
            if cpu_percent > 90:
                issues.append(f"CPU使用率が高い ({cpu_percent}%)")
            elif cpu_percent > 70:
                warnings.append(f"CPU使用率が高め ({cpu_percent}%)")
            
            # メモリ使用率チェック
            memory_percent = metrics.get("memory_percent", 0)
            if memory_percent > 90:
                issues.append(f"メモリ使用率が高い ({memory_percent}%)")
            elif memory_percent > 80:
                warnings.append(f"メモリ使用率が高め ({memory_percent}%)")
            
            # ディスク使用率チェック
            disk_percent = metrics.get("disk_percent", 0)
            if disk_percent > 95:
                issues.append(f"ディスク容量不足 ({disk_percent}%)")
            elif disk_percent > 85:
                warnings.append(f"ディスク容量少なめ ({disk_percent}%)")
            
            if issues:
                status = "critical"
                message = f"{len(issues)}個のリソース問題"
            elif warnings:
                status = "warning"
                message = f"{len(warnings)}個のリソース警告"
            else:
                status = "healthy"
                message = "システムリソース正常"
            
            return {
                "status": status,
                "message": message,
                "details": {
                    "metrics": metrics,
                    "issues": issues,
                    "warnings": warnings
                }
            }
            
        except Exception as e:
            return {
                "status": "warning",
                "message": f"システムリソースチェックエラー: {e}",
                "details": {"error": str(e)}
            }
    
    @staticmethod
    def check_security_settings() -> Dict[str, Any]:
        """セキュリティ設定チェック"""
        issues = []
        warnings = []
        
        # セキュリティヘッダーチェック
        if not settings.security.SECURITY_HEADERS:
            warnings.append("セキュリティヘッダーが設定されていない")
        
        # セッション設定チェック
        if settings.security.SESSION_TIMEOUT > 24 * 3600:  # 24時間
            warnings.append("セッションタイムアウトが長い")
        
        # パスワード設定チェック
        if settings.security.PASSWORD_MIN_LENGTH < 8:
            issues.append("パスワード最小長が短い")
        
        # ログ設定チェック
        if not settings.logging.SECURITY_LOG_ENABLED:
            warnings.append("セキュリティログが無効")
        
        if issues:
            return {
                "status": "critical",
                "message": f"{len(issues)}個のセキュリティ問題",
                "details": {"issues": issues, "warnings": warnings}
            }
        elif warnings:
            return {
                "status": "warning",
                "message": f"{len(warnings)}個のセキュリティ警告",
                "details": {"warnings": warnings}
            }
        else:
            return {
                "status": "healthy",
                "message": "セキュリティ設定正常",
                "details": {}
            }
    
    @staticmethod
    def check_performance() -> Dict[str, Any]:
        """パフォーマンスチェック"""
        try:
            # データベース接続プール情報を取得（実装が必要）
            # 実際の実装では、接続プールのメトリクスを取得
            
            warnings = []
            
            # 仮のチェック項目
            if settings.database.CONNECTION_POOL_SIZE < 10:
                warnings.append("接続プールサイズが小さい")
            
            if warnings:
                return {
                    "status": "warning",
                    "message": f"{len(warnings)}個のパフォーマンス警告",
                    "details": {"warnings": warnings}
                }
            else:
                return {
                    "status": "healthy",
                    "message": "パフォーマンス設定正常",
                    "details": {}
                }
                
        except Exception as e:
            return {
                "status": "warning",
                "message": f"パフォーマンスチェックエラー: {e}",
                "details": {"error": str(e)}
            }

def show_health_dashboard():
    """ヘルスチェックダッシュボードを表示"""
    st.subheader("🏥 システムヘルスチェック")
    
    if st.button("🔄 ヘルスチェック実行", type="primary"):
        with st.spinner("ヘルスチェック実行中..."):
            health_status = HealthChecker.run_all_checks()
        
        # 全体ステータス表示
        if health_status["overall_status"] == "healthy":
            st.success("✅ システム全体が正常です")
        elif health_status["overall_status"] == "warning":
            st.warning("⚠️ システムに警告があります")
        else:
            st.error("🚨 システムに重要な問題があります")
        
        # 詳細チェック結果
        for check_name, result in health_status["checks"].items():
            with st.expander(f"{check_name.title()} チェック"):
                if result["status"] == "healthy":
                    st.success(f"✅ {result['message']}")
                elif result["status"] == "warning":
                    st.warning(f"⚠️ {result['message']}")
                else:
                    st.error(f"🚨 {result['message']}")
                
                if result.get("details"):
                    st.json(result["details"])</code></pre>

                        <h6>デプロイスクリプト (deploy.sh)</h6>
                        <pre><code>#!/bin/bash
# 本番環境デプロイスクリプト

set -e

echo "🚀 Starting deployment process..."

# 環境設定チェック
if [ ! -f ".env.production" ]; then
    echo "❌ .env.production file not found"
    exit 1
fi

# バックアップ作成
echo "📦 Creating backup..."
./backup.sh

# Git更新
echo "📥 Pulling latest changes..."
git pull origin main

# Docker Compose停止
echo "🛑 Stopping current services..."
docker-compose -f docker-compose.prod.yml down

# イメージ更新
echo "🐳 Updating Docker images..."
docker-compose -f docker-compose.prod.yml pull

# 新しいサービス起動
echo "🎯 Starting services..."
docker-compose -f docker-compose.prod.yml up -d

# ヘルスチェック
echo "🏥 Running health checks..."
sleep 30

# サービス状態確認
docker-compose -f docker-compose.prod.yml ps

echo "✅ Deployment completed successfully!"

# ログ確認（オプション）
echo "📋 Recent logs:"
docker-compose -f docker-compose.prod.yml logs --tail=20</code></pre>

                        <h6>期待される結果</h6>
                        <p>本番環境へのデプロイ準備が完了し、セキュリティチェック、ヘルスチェック機能、自動デプロイスクリプトが正常に動作することを確認してください。</p>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>Webアプリケーション</strong>の主要なセキュリティ脅威を5つ挙げ、それぞれの対策を説明してください。</li>
                            <li><strong>環境変数管理</strong>でシークレット情報を安全に扱う方法を3つ挙げてください。</li>
                            <li><strong>SQLインジェクション攻撃</strong>をORMで防ぐ仕組みを説明してください。</li>
                            <li><strong>本番環境でのログ管理</strong>で重要な要素を4つ挙げてください。</li>
                            <li><strong>PostgreSQL</strong>のSSL/TLS設定が重要な理由を説明してください。</li>
                            <li><strong>パフォーマンスモニタリング</strong>で監視すべきメトリクスを5つ挙げてください。</li>
                            <li><strong>データベースバックアップ</strong>のベストプラクティスを3つ挙げてください。</li>
                            <li><strong>ヘルスチェック機能</strong>が本番環境で重要な理由を説明してください。</li>
                        </ol>
                        
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>SQLインジェクション（ORM使用）、XSS（サニタイズ）、CSRF（トークン）、認証・認可（適切な設計）、機密情報漏洩（環境変数管理）</li>
                                <li>環境変数での管理、暗号化ストレージ、シークレット管理サービス（AWS Secrets Manager等）の利用</li>
                                <li>ORMはSQLクエリを自動生成し、パラメータ化クエリを使用することで、ユーザー入力が直接SQL文に挿入されることを防ぐ</li>
                                <li>ログレベルの適切な設定、機密情報の除外、ローテーション設定、集約とモニタリング</li>
                                <li>データ通信の暗号化、中間者攻撃の防止、認証情報の保護、コンプライアンス要件への対応</li>
                                <li>CPU使用率、メモリ使用率、ディスク使用率、応答時間、エラー率、データベース接続数</li>
                                <li>定期的な自動バックアップ、複数世代の保持、リストアテストの実施、オフサイト保存</li>
                                <li>システム障害の早期発見、自動復旧の実現、サービス品質の維持、インシデント対応の迅速化</li>
                            </ol>
                        </details>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">6.7 Step 6のまとめ</h3>
                    
                    <div class="success">
                        <h5>🎉 チュートリアル完了！</h5>
                        <p>Streamlit + SQLModelを使用したモダンなユーザー管理システムが完成しました！</p>
                    </div>

                    <div class="highlight">
                        <h5>Step 6で習得したスキル</h5>
                        <ul>
                            <li>環境変数による安全な設定管理</li>
                            <li>基本認証機能とセッション管理</li>
                            <li>包括的なログ機能とモニタリング</li>
                            <li>SQLインジェクション対策とセキュリティ強化</li>
                            <li>本番環境PostgreSQL設定と最適化</li>
                            <li>SSL/TLS設定とデータ暗号化</li>
                            <li>バックアップ・リストア機能</li>
                            <li>ヘルスチェックとパフォーマンス監視</li>
                            <li>本番環境デプロイ準備</li>
                        </ul>
                    </div>

                    <div class="warning">
                        <h6>本番環境運用前の最終チェック</h6>
                        <ul>
                            <li>✅ 全てのセキュリティ設定が適切に構成されている</li>
                            <li>✅ SSL/TLS証明書が正しく設定されている</li>
                            <li>✅ デフォルトパスワードが全て変更されている</li>
                            <li>✅ ログ機能が正常に動作している</li>
                            <li>✅ バックアップ機能が動作確認済み</li>
                            <li>✅ ヘルスチェック機能が実装されている</li>
                            <li>✅ モニタリング体制が整っている</li>
                            <li>✅ インシデント対応手順が準備されている</li>
                        </ul>
                    </div>

                    <div class="info">
                        <h6>さらなる発展学習</h6>
                        <ul>
                            <li><strong>コンテナオーケストレーション</strong>: Kubernetes、Docker Swarm</li>
                            <li><strong>CI/CD</strong>: GitHub Actions、GitLab CI/CD</li>
                            <li><strong>クラウド展開</strong>: AWS、GCP、Azureでのデプロイ</li>
                            <li><strong>マイクロサービス</strong>: FastAPI + Streamlit構成</li>
                            <li><strong>高可用性</strong>: ロードバランサー、レプリケーション</li>
                            <li><strong>セキュリティ強化</strong>: OAuth2、JWT、WAF</li>
                            <li><strong>監視・分析</strong>: Prometheus、Grafana、ELK Stack</li>
                        </ul>
                    </div>

                    <!-- 最終的な成果物 -->
                    <h3 class="section-title">6.8 完成したアプリケーションの特徴</h3>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>カテゴリ</th>
                                    <th>実装機能</th>
                                    <th>技術スタック</th>
                                    <th>品質レベル</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>フロントエンド</strong></td>
                                    <td>レスポンシブUI、リアルタイム更新</td>
                                    <td>Streamlit、Bootstrap</td>
                                    <td>プロダクション品質</td>
                                </tr>
                                <tr>
                                    <td><strong>バックエンド</strong></td>
                                    <td>型安全なAPI、完全CRUD</td>
                                    <td>SQLModel、Pydantic</td>
                                    <td>エンタープライズ品質</td>
                                </tr>
                                <tr>
                                    <td><strong>データベース</strong></td>
                                    <td>正規化設計、インデックス最適化</td>
                                    <td>PostgreSQL 15</td>
                                    <td>本番環境対応</td>
                                </tr>
                                <tr>
                                    <td><strong>セキュリティ</strong></td>
                                    <td>認証、暗号化、監査ログ</td>
                                    <td>SSL/TLS、scram-sha-256</td>
                                    <td>セキュア設計</td>
                                </tr>
                                <tr>
                                    <td><strong>運用</strong></td>
                                    <td>監視、バックアップ、ヘルスチェック</td>
                                    <td>Docker、シェルスクリプト</td>
                                    <td>運用保守対応</td>
                                </tr>
                                <tr>
                                    <td><strong>開発体験</strong></td>
                                    <td>型ヒント、バリデーション、エラーハンドリング</td>
                                    <td>Python 3.11+、現代的開発手法</td>
                                    <td>開発者フレンドリー</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 章間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step5-user-crud-operations.html" class="btn btn-secondary">← Step 5: CRUD操作</a>
                        <a href="../streamlit-sqlmodel/README.html" class="btn btn-success">🎉 チュートリアル完了！</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>