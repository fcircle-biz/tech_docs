<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Djangoå®Ÿè·µãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« ã‚¹ãƒ†ãƒƒãƒ—9 - ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒãƒƒã‚°</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #4caf50; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #4caf50; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #4caf50; padding-bottom: 0.5rem; }
        .section-title { color: #66bb6a; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container { background-color: #e8f5e8; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #4caf50; }
        .exercise-container { background-color: #f3e5f5; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #9c27b0; }
        .highlight { background-color: #ffecb3; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #ffc107; }
        .code-block { background-color: #1e1e1e; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #4caf50 !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand"><strong>Djangoå®Ÿè·µãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</strong></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚¹ãƒ†ãƒƒãƒ—</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="step1-environment-setup.html">ã‚¹ãƒ†ãƒƒãƒ—1: é–‹ç™ºç’°å¢ƒæ§‹ç¯‰</a></li>
                        <li class="nav-item"><a class="nav-link" href="step2-docker-postgresql.html">ã‚¹ãƒ†ãƒƒãƒ—2: Dockerãƒ»PostgreSQL</a></li>
                        <li class="nav-item"><a class="nav-link" href="step3-django-project-init.html">ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–</a></li>
                        <li class="nav-item"><a class="nav-link" href="step4-models-migration.html">ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¢ãƒ‡ãƒ«ãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</a></li>
                        <li class="nav-item"><a class="nav-link" href="step5-views-templates-urls.html">ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»URL</a></li>
                        <li class="nav-item"><a class="nav-link" href="step6-admin-interface.html">ã‚¹ãƒ†ãƒƒãƒ—6: ç®¡ç†ã‚µã‚¤ãƒˆ</a></li>
                        <li class="nav-item"><a class="nav-link" href="step7-crud-operations.html">ã‚¹ãƒ†ãƒƒãƒ—7: CRUDæ“ä½œ</a></li>
                        <li class="nav-item"><a class="nav-link" href="step8-validation-security.html">ã‚¹ãƒ†ãƒƒãƒ—8: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</a></li>
                        <li class="nav-item"><a class="nav-link active" href="step9-testing-debugging.html">ã‚¹ãƒ†ãƒƒãƒ—9: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">ã‚¹ãƒ†ãƒƒãƒ—9: ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒãƒƒã‚°</h1>
                </div>

                <div id="step9">
                    <div class="highlight">
                        <h5>ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…ã™ã‚‹ã“ã¨</h5>
                        <ul>
                            <li>Djangoãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®åŸºç¤</li>
                            <li>ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆã®ä½œæˆ</li>
                            <li>ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚¹ãƒˆã®å®Ÿè£…</li>
                            <li>ãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆã®ä½œæˆ</li>
                            <li>ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç®¡ç†</li>
                            <li>ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ã®æ´»ç”¨</li>
                            <li>ãƒ­ã‚°è¨­å®šã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</li>
                        </ul>
                    </div>

                    <h2 class="chapter-title">å“è³ªä¿è¨¼ã¨ãƒ‡ãƒãƒƒã‚°æŠ€è¡“</h2>

                    <div class="exercise-container">
                        <h5>å®Ÿè£… 9-1: ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆã®ä½œæˆ</h5>
                        <p>ã‚«ã‚¹ã‚¿ãƒ Userãƒ¢ãƒ‡ãƒ«ã®æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><strong>users/tests/test_models.pyä½œæˆ</strong>:
                                <pre class="code-block"><code class="language-python"># users/tests/test_models.py (æ–°è¦ä½œæˆ)
from django.test import TestCase
from django.core.exceptions import ValidationError
from django.db import IntegrityError
from datetime import date, timedelta
from users.models import User

class UserModelTest(TestCase):
    """Userãƒ¢ãƒ‡ãƒ«ã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹"""
    
    def setUp(self):
        """å„ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œå‰ã®æº–å‚™"""
        self.valid_user_data = {
            'username': 'testuser',
            'email': 'test@example.com',
            'first_name': 'å¤ªéƒ',
            'last_name': 'ç”°ä¸­',
            'phone_number': '090-1234-5678',
            'birth_date': date(1990, 5, 15)
        }
    
    def test_user_creation_with_valid_data(self):
        """æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ†ã‚¹ãƒˆ"""
        user = User.objects.create_user(**self.valid_user_data)
        self.assertEqual(user.username, 'testuser')
        self.assertEqual(user.email, 'test@example.com')
        self.assertTrue(user.is_active)
        self.assertIsNotNone(user.created_at)
    
    def test_user_str_representation(self):
        """__str__ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆ"""
        user = User.objects.create_user(**self.valid_user_data)
        expected = f"{user.username} ({user.get_full_name()})"
        self.assertEqual(str(user), expected)
    
    def test_get_full_name_method(self):
        """get_full_nameãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆ"""
        user = User.objects.create_user(**self.valid_user_data)
        self.assertEqual(user.get_full_name(), 'å¤ªéƒ ç”°ä¸­')
        
        # åå‰ãŒç©ºã®å ´åˆ
        user.first_name = ''
        user.last_name = ''
        self.assertEqual(user.get_full_name(), '')
    
    def test_get_age_method(self):
        """get_ageãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆ"""
        # 30æ­³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
        birth_date = date.today() - timedelta(days=30*365)
        user = User.objects.create_user(
            username='testuser',
            birth_date=birth_date
        )
        self.assertAlmostEqual(user.get_age(), 30, delta=1)
        
        # ç”Ÿå¹´æœˆæ—¥ãŒæœªè¨­å®šã®å ´åˆ
        user.birth_date = None
        self.assertIsNone(user.get_age())
    
    def test_email_uniqueness(self):
        """ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¸€æ„æ€§åˆ¶ç´„ãƒ†ã‚¹ãƒˆ"""
        User.objects.create_user(**self.valid_user_data)
        
        # åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§2äººç›®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚’è©¦è¡Œ
        with self.assertRaises(IntegrityError):
            User.objects.create_user(
                username='testuser2',
                email='test@example.com'  # åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            )
    
    def test_phone_number_validation(self):
        """é›»è©±ç•ªå·ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ"""
        # æœ‰åŠ¹ãªé›»è©±ç•ªå·
        user_data = self.valid_user_data.copy()
        user_data['phone_number'] = '090-1234-5678'
        user = User(**user_data)
        user.full_clean()  # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        
        # ç„¡åŠ¹ãªé›»è©±ç•ªå·
        user_data['phone_number'] = '090-12345678'  # ãƒã‚¤ãƒ•ãƒ³ãªã—
        user = User(**user_data)
        with self.assertRaises(ValidationError):
            user.full_clean()
    
    def test_username_validation(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ"""
        user_data = self.valid_user_data.copy()
        
        # ç„¡åŠ¹ãªæ–‡å­—ã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼å
        user_data['username'] = 'test@user'  # @ã‚’å«ã‚€
        user = User(**user_data)
        with self.assertRaises(ValidationError):
            user.full_clean()
    
    def test_age_validation(self):
        """å¹´é½¢ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ"""
        user_data = self.valid_user_data.copy()
        
        # å¹´é½¢ãŒè‹¥ã™ãã‚‹ï¼ˆ12æ­³ï¼‰
        user_data['birth_date'] = date.today() - timedelta(days=12*365)
        user = User(**user_data)
        with self.assertRaises(ValidationError):
            user.full_clean()
        
        # å¹´é½¢ãŒé«˜ã™ãã‚‹ï¼ˆ101æ­³ï¼‰
        user_data['birth_date'] = date.today() - timedelta(days=101*365)
        user = User(**user_data)
        with self.assertRaises(ValidationError):
            user.full_clean()
    
    def test_email_normalization(self):
        """ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ­£è¦åŒ–ã®ãƒ†ã‚¹ãƒˆ"""
        user_data = self.valid_user_data.copy()
        user_data['email'] = 'TEST@EXAMPLE.COM'  # å¤§æ–‡å­—
        user = User.objects.create_user(**user_data)
        self.assertEqual(user.email, 'test@example.com')  # å°æ–‡å­—ã«å¤‰æ›ã•ã‚Œã‚‹</code></pre>
                            </li>
                            <li><strong>tests/__init__.pyä½œæˆ</strong>:
                                <pre class="code-block"><code class="language-bash">mkdir users/tests
touch users/tests/__init__.py</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>å®Ÿè£… 9-2: ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚¹ãƒˆã®ä½œæˆ</h5>
                        <p>ãƒ“ãƒ¥ãƒ¼ã®å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆã—ã€é©åˆ‡ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><strong>users/tests/test_views.pyä½œæˆ</strong>:
                                <pre class="code-block"><code class="language-python"># users/tests/test_views.py (æ–°è¦ä½œæˆ)
from django.test import TestCase, Client
from django.urls import reverse
from django.contrib.auth import get_user_model
from users.models import User

class UserViewTest(TestCase):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ“ãƒ¥ãƒ¼ã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹"""
    
    def setUp(self):
        """ãƒ†ã‚¹ãƒˆæº–å‚™"""
        self.client = Client()
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com',
            first_name='å¤ªéƒ',
            last_name='ç”°ä¸­',
            password='testpass123'
        )
    
    def test_user_list_view(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ"""
        url = reverse('users:user_list')
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'testuser')
        self.assertContains(response, 'å¤ªéƒ ç”°ä¸­')
    
    def test_user_detail_view(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ"""
        url = reverse('users:user_detail', args=[self.user.pk])
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, self.user.username)
        self.assertContains(response, self.user.email)
    
    def test_user_detail_view_nonexistent_user(self):
        """å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ"""
        url = reverse('users:user_detail', args=[9999])
        response = self.client.get(url)
        self.assertEqual(response.status_code, 404)
    
    def test_user_create_view_get(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒšãƒ¼ã‚¸ï¼ˆGETï¼‰ã®ãƒ†ã‚¹ãƒˆ"""
        url = reverse('users:user_create')
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²')
    
    def test_user_create_view_post_valid(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆPOSTãƒ»æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ï¼‰ã®ãƒ†ã‚¹ãƒˆ"""
        url = reverse('users:user_create')
        data = {
            'username': 'newuser',
            'email': 'new@example.com',
            'first_name': 'æ¬¡éƒ',
            'last_name': 'ä½è—¤',
            'password1': 'NewPass123!',
            'password2': 'NewPass123!',
        }
        response = self.client.post(url, data)
        
        # ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        self.assertEqual(response.status_code, 302)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        self.assertTrue(User.objects.filter(username='newuser').exists())
    
    def test_user_create_view_post_invalid(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆPOSTãƒ»ç„¡åŠ¹ãƒ‡ãƒ¼ã‚¿ï¼‰ã®ãƒ†ã‚¹ãƒˆ"""
        url = reverse('users:user_create')
        data = {
            'username': '',  # ç©ºã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å
            'email': 'invalid-email',  # ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«
            'password1': '123',  # å¼±ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
            'password2': '456',  # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãªã„
        }
        response = self.client.post(url, data)
        
        # ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ã§ãƒšãƒ¼ã‚¸ãŒå†è¡¨ç¤ºã•ã‚Œã‚‹
        self.assertEqual(response.status_code, 200)
        self.assertFormError(response, 'form', 'username', 'This field is required.')
    
    def test_user_update_view(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ã®ãƒ†ã‚¹ãƒˆ"""
        url = reverse('users:user_update', args=[self.user.pk])
        data = {
            'username': 'updateduser',
            'email': 'updated@example.com',
            'first_name': 'æ›´æ–°',
            'last_name': 'å¤ªéƒ',
            'is_active': True,
        }
        response = self.client.post(url, data)
        
        # ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        self.assertEqual(response.status_code, 302)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        self.user.refresh_from_db()
        self.assertEqual(self.user.username, 'updateduser')
        self.assertEqual(self.user.first_name, 'æ›´æ–°')
    
    def test_user_delete_view(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã®ãƒ†ã‚¹ãƒˆ"""
        user_id = self.user.pk
        url = reverse('users:user_delete', args=[user_id])
        
        # DELETEç¢ºèªãƒšãƒ¼ã‚¸
        response = self.client.get(url)
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'å‰Šé™¤ç¢ºèª')
        
        # å®Ÿéš›ã®å‰Šé™¤å®Ÿè¡Œ
        response = self.client.post(url)
        self.assertEqual(response.status_code, 302)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        self.assertFalse(User.objects.filter(pk=user_id).exists())
    
    def test_dashboard_view(self):
        """ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ"""
        url = reverse('users:dashboard')
        response = self.client.get(url)
        
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰')
        self.assertContains(response, 'ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°')
    
    def test_user_search(self):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
        # æ¤œç´¢å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ä½œæˆ
        User.objects.create_user(
            username='searchuser',
            email='search@example.com',
            first_name='æ¤œç´¢',
            last_name='å¯¾è±¡'
        )
        
        url = reverse('users:user_list')
        response = self.client.get(url, {'search': 'æ¤œç´¢'})
        
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'searchuser')
        self.assertNotContains(response, 'testuser')  # æ¤œç´¢ã«ãƒ’ãƒƒãƒˆã—ãªã„</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>å®Ÿè£… 9-3: ãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆã®ä½œæˆ</h5>
                        <p>ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><strong>users/tests/test_forms.pyä½œæˆ</strong>:
                                <pre class="code-block"><code class="language-python"># users/tests/test_forms.py (æ–°è¦ä½œæˆ)
from django.test import TestCase
from users.forms import CustomUserCreationForm, UserUpdateForm
from users.models import User

class CustomUserCreationFormTest(TestCase):
    """ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ†ã‚¹ãƒˆ"""
    
    def test_form_valid_data(self):
        """æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ"""
        form_data = {
            'username': 'testuser',
            'email': 'test@example.com',
            'first_name': 'å¤ªéƒ',
            'last_name': 'ç”°ä¸­',
            'password1': 'TestPass123!',
            'password2': 'TestPass123!',
        }
        form = CustomUserCreationForm(data=form_data)
        self.assertTrue(form.is_valid())
    
    def test_form_invalid_email_duplicate(self):
        """é‡è¤‡ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ†ã‚¹ãƒˆ"""
        # æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
        User.objects.create_user(
            username='existing',
            email='test@example.com'
        )
        
        form_data = {
            'username': 'testuser',
            'email': 'test@example.com',  # é‡è¤‡
            'first_name': 'å¤ªéƒ',
            'last_name': 'ç”°ä¸­',
            'password1': 'TestPass123!',
            'password2': 'TestPass123!',
        }
        form = CustomUserCreationForm(data=form_data)
        self.assertFalse(form.is_valid())
        self.assertIn('email', form.errors)
    
    def test_form_password_mismatch(self):
        """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸ä¸€è‡´ã®ãƒ†ã‚¹ãƒˆ"""
        form_data = {
            'username': 'testuser',
            'email': 'test@example.com',
            'first_name': 'å¤ªéƒ',
            'last_name': 'ç”°ä¸­',
            'password1': 'TestPass123!',
            'password2': 'DifferentPass123!',  # ç•°ãªã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        }
        form = CustomUserCreationForm(data=form_data)
        self.assertFalse(form.is_valid())
    
    def test_form_required_fields(self):
        """å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ†ã‚¹ãƒˆ"""
        form_data = {}  # ç©ºãƒ‡ãƒ¼ã‚¿
        form = CustomUserCreationForm(data=form_data)
        self.assertFalse(form.is_valid())
        
        required_fields = ['username', 'email', 'first_name', 'last_name']
        for field in required_fields:
            self.assertIn(field, form.errors)

class UserUpdateFormTest(TestCase):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ†ã‚¹ãƒˆ"""
    
    def setUp(self):
        """ãƒ†ã‚¹ãƒˆæº–å‚™"""
        self.user = User.objects.create_user(
            username='testuser',
            email='test@example.com'
        )
    
    def test_form_valid_data(self):
        """æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°ãƒ†ã‚¹ãƒˆ"""
        form_data = {
            'username': 'updateduser',
            'email': 'updated@example.com',
            'first_name': 'æ›´æ–°',
            'last_name': 'å¤ªéƒ',
            'phone_number': '090-1234-5678',
            'is_active': True,
        }
        form = UserUpdateForm(data=form_data, instance=self.user)
        self.assertTrue(form.is_valid())
    
    def test_form_email_duplicate_different_user(self):
        """ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¡ãƒ¼ãƒ«é‡è¤‡ã®ãƒ†ã‚¹ãƒˆ"""
        # åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
        User.objects.create_user(
            username='otheruser',
            email='other@example.com'
        )
        
        form_data = {
            'username': 'testuser',
            'email': 'other@example.com',  # ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«
            'first_name': 'å¤ªéƒ',
            'last_name': 'ç”°ä¸­',
            'is_active': True,
        }
        form = UserUpdateForm(data=form_data, instance=self.user)
        self.assertFalse(form.is_valid())
        self.assertIn('email', form.errors)
    
    def test_form_same_email_same_user(self):
        """åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å­˜ãƒ¡ãƒ¼ãƒ«ä½¿ç”¨ã®ãƒ†ã‚¹ãƒˆï¼ˆOKï¼‰"""
        form_data = {
            'username': 'testuser',
            'email': 'test@example.com',  # è‡ªåˆ†ã®æ—¢å­˜ãƒ¡ãƒ¼ãƒ«
            'first_name': 'å¤ªéƒ',
            'last_name': 'ç”°ä¸­',
            'is_active': True,
        }
        form = UserUpdateForm(data=form_data, instance=self.user)
        self.assertTrue(form.is_valid())</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>å®Ÿè£… 9-4: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª</h5>
                        <p>ä½œæˆã—ãŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><strong>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</strong>:
                                <pre class="code-block"><code class="language-bash"># ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python manage.py test

# ç‰¹å®šã®ã‚¢ãƒ—ãƒªã®ãƒ†ã‚¹ãƒˆã®ã¿
python manage.py test users

# è©³ç´°å‡ºåŠ›ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python manage.py test --verbosity=2

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ã¿
python manage.py test users.tests.test_models.UserModelTest</code></pre>
                            </li>
                            <li><strong>ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</strong>:
                                <pre class="code-block"><code class="language-bash">pip install coverage</code></pre>
                            </li>
                            <li><strong>ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆå®Ÿè¡Œ</strong>:
                                <pre class="code-block"><code class="language-bash"># ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿åé›†
coverage run --source='.' manage.py test

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
coverage report

# HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
coverage html</code></pre>
                            </li>
                        </ol>
                        
                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <div class="alert alert-success">
                            <p>ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ã€é©åˆ‡ãªã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹</p>
                        </div>
                    </div>

                    <div class="exercise-container">
                        <h5>å®Ÿè£… 9-5: ãƒ­ã‚°è¨­å®šã¨ãƒ‡ãƒãƒƒã‚°</h5>
                        <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°æ©Ÿèƒ½ã‚’è¨­å®šã—ã€ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ã¾ã™ã€‚</p>
                        
                        <h6>æ‰‹é †</h6>
                        <ol>
                            <li><strong>è©³ç´°ãªãƒ­ã‚°è¨­å®š</strong>:
                                <pre class="code-block"><code class="language-python"># myproject/settings.py ã®LOGGINGè¨­å®šã‚’æ‹¡å¼µ
import os

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'django.log'),
            'formatter': 'verbose',
        },
        'error_file': {
            'level': 'ERROR',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'error.log'),
            'formatter': 'verbose',
        },
        'console': {
            'level': 'DEBUG' if DEBUG else 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'simple',
        },
    },
    'root': {
        'handlers': ['console'],
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': False,
        },
        'django.request': {
            'handlers': ['error_file'],
            'level': 'ERROR',
            'propagate': False,
        },
        'users': {
            'handlers': ['file', 'console'],
            'level': 'DEBUG' if DEBUG else 'INFO',
            'propagate': False,
        },
    },
}</code></pre>
                            </li>
                            <li><strong>ãƒ­ã‚°ã®æ´»ç”¨ä¾‹</strong>:
                                <pre class="code-block"><code class="language-python"># users/views.py ã§ã®ãƒ­ã‚°ä½¿ç”¨ä¾‹
import logging

logger = logging.getLogger(__name__)

class UserCreateView(CreateView):
    def form_valid(self, form):
        user = form.save(commit=False)
        user.set_password(form.cleaned_data['password1'])
        user.save()
        
        # ãƒ­ã‚°å‡ºåŠ›
        logger.info(f'New user created: {user.username} ({user.email})')
        
        messages.success(self.request, f'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ{user.username}ã€ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚')
        return super().form_valid(form)
    
    def form_invalid(self, form):
        # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
        logger.warning(f'User creation failed: {form.errors}')
        return super().form_invalid(form)</code></pre>
                            </li>
                            <li><strong>ãƒ‡ãƒãƒƒã‚°ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®ä½œæˆ</strong>:
                                <pre class="code-block"><code class="language-python"># users/debug.py (æ–°è¦ä½œæˆ)
import logging
from django.conf import settings
from functools import wraps

def debug_view(func):
    """ãƒ“ãƒ¥ãƒ¼ã®ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿"""
    @wraps(func)
    def wrapper(request, *args, **kwargs):
        if settings.DEBUG:
            logger = logging.getLogger(__name__)
            logger.debug(f'View called: {func.__name__}')
            logger.debug(f'Request method: {request.method}')
            logger.debug(f'Request user: {request.user}')
            logger.debug(f'Args: {args}, Kwargs: {kwargs}')
        
        result = func(request, *args, **kwargs)
        
        if settings.DEBUG:
            logger.debug(f'View completed: {func.__name__}')
        
        return result
    return wrapper</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>å®Ÿè£… 9-6: æœ¬ç•ªç’°å¢ƒã¸ã®æº–å‚™</h5>
                        <p>æœ¬ç•ªç’°å¢ƒã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å‘ã‘ãŸæœ€çµ‚è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚</p>
                        
                        <h6>ãƒã‚§ãƒƒã‚¯é …ç›®</h6>
                        <ol>
                            <li><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯</strong>:
                                <pre class="code-block"><code class="language-bash"># Djangoã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
python manage.py check --deploy</code></pre>
                            </li>
                            <li><strong>é™çš„ãƒ•ã‚¡ã‚¤ãƒ«åé›†</strong>:
                                <pre class="code-block"><code class="language-bash"># é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬ç•ªç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åé›†
python manage.py collectstatic --noinput</code></pre>
                            </li>
                            <li><strong>ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª</strong>:
                                <pre class="code-block"><code class="language-bash"># æœªé©ç”¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª
python manage.py showmigrations --list</code></pre>
                            </li>
                            <li><strong>requirements.txtæ›´æ–°</strong>:
                                <pre class="code-block"><code class="language-bash"># ä¾å­˜é–¢ä¿‚ã‚’æœ€æ–°ã®çŠ¶æ…‹ã§è¨˜éŒ²
pip freeze > requirements.txt</code></pre>
                            </li>
                        </ol>
                        
                        <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ</h6>
                        <div class="alert alert-success">
                            <p>æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™ãŒæ•´ã„ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã«ãƒ‘ã‚¹ã™ã‚‹</p>
                        </div>
                    </div>

                    <div class="quiz-container">
                        <h5>ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ãƒã‚§ãƒƒã‚¯</h5>
                        <ul class="list-unstyled">
                            <li>â˜ åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹</li>
                            <li>â˜ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹</li>
                            <li>â˜ é©åˆ‡ãªã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹</li>
                            <li>â˜ ãƒ­ã‚°æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹</li>
                            <li>â˜ ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ãŒæ´»ç”¨ã§ãã¦ã„ã‚‹</li>
                            <li>â˜ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™ãŒå®Œäº†ã—ã¦ã„ã‚‹</li>
                        </ul>
                    </div>

                    <div class="alert alert-success mt-4">
                        <h4>ğŸ‰ Djangoå®Ÿè·µãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ï¼</h4>
                        <p>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ä»¥ä¸‹ã®ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã¾ã—ãŸï¼š</p>
                        <ul>
                            <li>Djangoé–‹ç™ºç’°å¢ƒã®æ§‹ç¯‰</li>
                            <li>PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº</li>
                            <li>ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…</li>
                            <li>ãƒ•ãƒ«CRUDæ©Ÿèƒ½ã®é–‹ç™º</li>
                            <li>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®å®Ÿè£…</li>
                            <li>ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã®å®Ÿè·µ</li>
                        </ul>
                        <p><strong>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:</strong> ã‚ˆã‚Šé«˜åº¦ãªæ©Ÿèƒ½ï¼ˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã€APIé–‹ç™ºã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç­‰ï¼‰ã«æŒ‘æˆ¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼</p>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="step8-validation-security.html" class="btn btn-secondary">â† å‰ã®ã‚¹ãƒ†ãƒƒãƒ—: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</a>
                        <span class="text-muted">å®Œäº†ï¼</span>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">Â© 2025 F-Circle. All rights reserved.<br>
æœ¬è³‡æ–™ã¯AIãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ã€äººé–“ã«ã‚ˆã‚‹ç·¨é›†ãƒ»ç›£ä¿®ã®ã‚‚ã¨ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ç„¡æ–­è»¢è¼‰ãƒ»å†é…å¸ƒã‚’ç¦ã˜ã¾ã™ã€‚</p>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'default' });</script>
</body>
</html>