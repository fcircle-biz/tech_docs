<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django + PostgreSQL チュートリアル Step 4 - モデル設計とマイグレーション</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #2e7d33;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #2e7d33;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d33;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #4caf50;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d33;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #2e7d33 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Django + PostgreSQL チュートリアル</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-docker-postgresql.html">
                                Step 2: PostgreSQL環境
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-django-project-init.html">
                                Step 3: プロジェクト初期化
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step4-models-migration.html">
                                Step 4: モデル設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-views-templates-urls.html">
                                Step 5: ビュー・テンプレート
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-admin-interface.html">
                                Step 6: 管理サイト
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-crud-operations.html">
                                Step 7: CRUD操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step8-validation-security.html">
                                Step 8: バリデーション・セキュリティ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step9-testing-debugging.html">
                                Step 9: テスト・デバッグ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 4: モデル設計とマイグレーション</h1>
                </div>

                <div id="step4">
                    <h2 class="chapter-title">DjangoモデルとPostgreSQLデータベース設計</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Djangoモデルの基本概念とORMの理解</li>
                            <li>ユーザー管理システム用のモデル設計</li>
                            <li>フィールドタイプと制約の適切な選択</li>
                            <li>マイグレーションシステムの理解と操作</li>
                            <li>モデルのメタオプションとカスタマイズ</li>
                            <li>Django ORMを使用した基本的なデータベース操作</li>
                        </ul>
                    </div>

                    <h3 class="section-title">4.1 Djangoモデルの基本概念</h3>
                    <p>DjangoのORM（Object-Relational Mapping）システムを理解し、Pythonクラスとデータベーステーブルの関係を学習します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-1: 新しいアプリケーション「users」の作成</h5>
                        <p>ユーザー管理機能を実装するための専用アプリケーションを作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>usersアプリケーションを作成</li>
                            <li>settings.pyにアプリケーションを登録</li>
                            <li>アプリケーションの基本構造を確認</li>
                            <li>URL設定を準備</li>
                        </ol>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-bash"># 仮想環境が有効化されていることを確認
venv\Scripts\activate

# 新しいアプリケーションを作成
python manage.py startapp users

# アプリケーション構造の確認
tree users /F</code></pre>
                        
                        <h6>settings.py更新（INSTALLED_APPS）</h6>
                        <pre class="code-block"><code class="language-python"># myproject/settings.py

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # Local applications
    'hello.apps.HelloConfig',
    'users.apps.UsersConfig',  # 新しく追加
]</code></pre>

                        <h6>期待されるディレクトリ構造</h6>
                        <pre class="code-block"><code class="language-bash">users/
│   admin.py       # 管理サイト設定
│   apps.py        # アプリケーション設定
│   models.py      # データモデル定義（これから作成）
│   tests.py       # テストコード
│   urls.py        # URL設定（これから作成）
│   views.py       # ビュー関数（これから作成）
│   __init__.py
└───migrations/    # マイグレーションファイル
        __init__.py</code></pre>
                    </div>

                    <h3 class="section-title">4.2 ユーザーモデルの設計と実装</h3>
                    <p>実用的なユーザー管理システムのためのモデルクラスを設計・実装します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-2: Userモデルの詳細設計と実装</h5>
                        <p>ユーザー情報を管理するためのモデルクラスを作成し、適切なフィールドと制約を定義します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>ユーザーモデルの要件を分析</li>
                            <li>フィールドタイプとオプションを選択</li>
                            <li>モデルクラスを実装</li>
                            <li>メタオプションを設定</li>
                        </ol>
                        <h6>Userモデル実装（users/models.py）</h6>
                        <pre class="code-block"><code class="language-python">from django.db import models
from django.core.validators import RegexValidator
from django.utils import timezone


class User(models.Model):
    """
    ユーザー情報を管理するモデル
    
    カスタムユーザーモデルの代替として、
    Django標準のUser拡張として設計
    """
    
    # 基本情報フィールド
    username = models.CharField(
        max_length=150,
        unique=True,
        validators=[
            RegexValidator(
                regex=r'^[a-zA-Z0-9_]+$',
                message='ユーザー名は英数字とアンダースコアのみ使用可能です。'
            )
        ],
        verbose_name='ユーザー名',
        help_text='英数字とアンダースコアのみ。150文字以下。'
    )
    
    email = models.EmailField(
        unique=True,
        verbose_name='メールアドレス',
        help_text='有効なメールアドレスを入力してください。'
    )
    
    first_name = models.CharField(
        max_length=100,
        verbose_name='名'
    )
    
    last_name = models.CharField(
        max_length=100,
        verbose_name='姓'
    )
    
    # 追加情報フィールド
    phone_number = models.CharField(
        max_length=15,
        blank=True,
        null=True,
        validators=[
            RegexValidator(
                regex=r'^\+?1?\d{9,15}$',
                message='有効な電話番号を入力してください。'
            )
        ],
        verbose_name='電話番号',
        help_text='例: 090-1234-5678'
    )
    
    birth_date = models.DateField(
        blank=True,
        null=True,
        verbose_name='生年月日'
    )
    
    GENDER_CHOICES = [
        ('M', '男性'),
        ('F', '女性'),
        ('O', 'その他'),
    ]
    
    gender = models.CharField(
        max_length=1,
        choices=GENDER_CHOICES,
        blank=True,
        null=True,
        verbose_name='性別'
    )
    
    # 住所情報
    postal_code = models.CharField(
        max_length=10,
        blank=True,
        null=True,
        validators=[
            RegexValidator(
                regex=r'^\d{3}-\d{4}$',
                message='郵便番号は xxx-xxxx の形式で入力してください。'
            )
        ],
        verbose_name='郵便番号',
        help_text='例: 123-4567'
    )
    
    address = models.TextField(
        blank=True,
        null=True,
        verbose_name='住所'
    )
    
    # 状態管理フィールド
    is_active = models.BooleanField(
        default=True,
        verbose_name='アクティブ状態',
        help_text='このユーザーがアクティブかどうか。削除の代わりに非選択にしてください。'
    )
    
    # タイムスタンプフィールド
    created_at = models.DateTimeField(
        default=timezone.now,
        verbose_name='作成日時'
    )
    
    updated_at = models.DateTimeField(
        auto_now=True,
        verbose_name='更新日時'
    )
    
    class Meta:
        """モデルのメタオプション"""
        verbose_name = 'ユーザー'
        verbose_name_plural = 'ユーザー'
        ordering = ['-created_at']  # 作成日時の降順でソート
        db_table = 'users_user'  # データベーステーブル名を明示
        
        indexes = [
            models.Index(fields=['username']),
            models.Index(fields=['email']),
            models.Index(fields=['created_at']),
        ]
    
    def __str__(self):
        """文字列表現"""
        return f"{self.username} ({self.last_name} {self.first_name})"
    
    def get_full_name(self):
        """フルネーム取得"""
        return f"{self.last_name} {self.first_name}".strip()
    
    def get_age(self):
        """年齢計算"""
        if self.birth_date:
            today = timezone.now().date()
            return today.year - self.birth_date.year - (
                (today.month, today.day) < (self.birth_date.month, self.birth_date.day)
            )
        return None
    
    def save(self, *args, **kwargs):
        """保存時の前処理"""
        # ユーザー名を小文字に統一
        self.username = self.username.lower()
        super().save(*args, **kwargs)</code></pre>
                    </div>

                    <h3 class="section-title">4.3 関連モデルの設計</h3>
                    <p>ユーザーに関連する追加情報を管理するためのモデルを設計します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-3: UserProfileモデルとCategoryモデルの追加</h5>
                        <p>ユーザーの詳細プロフィール情報とカテゴリ分類を管理するモデルを作成します。</p>
                        <h6>UserProfileモデル追加（users/models.py に追加）</h6>
                        <pre class="code-block"><code class="language-python"># users/models.py に追加

class Category(models.Model):
    """ユーザーカテゴリ（部署、グループ等）"""
    
    name = models.CharField(
        max_length=100,
        unique=True,
        verbose_name='カテゴリ名'
    )
    
    description = models.TextField(
        blank=True,
        null=True,
        verbose_name='説明'
    )
    
    color = models.CharField(
        max_length=7,
        default='#007bff',
        validators=[
            RegexValidator(
                regex=r'^#[0-9A-Fa-f]{6}$',
                message='カラーコードは #RRGGBB の形式で入力してください。'
            )
        ],
        verbose_name='カラーコード',
        help_text='例: #007bff'
    )
    
    is_active = models.BooleanField(
        default=True,
        verbose_name='アクティブ状態'
    )
    
    created_at = models.DateTimeField(
        default=timezone.now,
        verbose_name='作成日時'
    )
    
    class Meta:
        verbose_name = 'カテゴリ'
        verbose_name_plural = 'カテゴリ'
        ordering = ['name']
    
    def __str__(self):
        return self.name


class UserProfile(models.Model):
    """ユーザーの詳細プロフィール情報"""
    
    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name='profile',
        verbose_name='ユーザー'
    )
    
    category = models.ForeignKey(
        Category,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='users',
        verbose_name='カテゴリ'
    )
    
    bio = models.TextField(
        blank=True,
        null=True,
        max_length=500,
        verbose_name='自己紹介',
        help_text='500文字以内で入力してください。'
    )
    
    website = models.URLField(
        blank=True,
        null=True,
        verbose_name='ウェブサイト'
    )
    
    avatar = models.ImageField(
        upload_to='avatars/',
        blank=True,
        null=True,
        verbose_name='アバター画像'
    )
    
    # 設定項目
    receive_notifications = models.BooleanField(
        default=True,
        verbose_name='通知受信'
    )
    
    receive_email_updates = models.BooleanField(
        default=True,
        verbose_name='メール更新受信'
    )
    
    # 統計情報
    login_count = models.PositiveIntegerField(
        default=0,
        verbose_name='ログイン回数'
    )
    
    last_login_ip = models.GenericIPAddressField(
        blank=True,
        null=True,
        verbose_name='最終ログインIP'
    )
    
    updated_at = models.DateTimeField(
        auto_now=True,
        verbose_name='更新日時'
    )
    
    class Meta:
        verbose_name = 'ユーザープロフィール'
        verbose_name_plural = 'ユーザープロフィール'
    
    def __str__(self):
        return f"{self.user.username}のプロフィール"</code></pre>

                        <h6>画像ファイル処理のためのパッケージインストール</h6>
                        <pre class="code-block"><code class="language-bash"># PIL（Python Imaging Library）をインストール
pip install Pillow

# requirements.txtを更新
pip freeze > requirements.txt</code></pre>
                    </div>

                    <h3 class="section-title">4.4 マイグレーションの作成と実行</h3>
                    <p>作成したモデルをデータベースのテーブル構造に反映するためのマイグレーション操作を実行します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-4: マイグレーションファイルの生成と実行</h5>
                        <p>モデル定義からマイグレーションファイルを生成し、データベースに適用します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>モデル定義の確認</li>
                            <li>マイグレーションファイルの生成</li>
                            <li>マイグレーションの内容確認</li>
                            <li>データベースへの適用</li>
                            <li>マイグレーション状況の確認</li>
                        </ol>
                        <h6>実行例</h6>
                        <pre class="code-block"><code class="language-bash"># マイグレーションファイルの生成
python manage.py makemigrations users

# 生成されたマイグレーションファイルの確認
python manage.py showmigrations users

# マイグレーションの詳細内容を確認（SQL表示）
python manage.py sqlmigrate users 0001

# データベースにマイグレーションを適用
python manage.py migrate

# 全体のマイグレーション状況を確認
python manage.py showmigrations</code></pre>

                        <h6>期待される出力例</h6>
                        <pre class="code-block"><code class="language-bash"># makemigrations の出力
Migrations for 'users':
  users\migrations\0001_initial.py
    - Create model Category
    - Create model User
    - Create model UserProfile
    - Add index users_user_username_idx on field(s) username of model user
    - Add index users_user_email_idx on field(s) email of model user
    - Add index users_user_created_at_idx on field(s) created_at of model user

# migrate の出力
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, users
Running migrations:
  Applying users.0001_initial... OK</code></pre>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 4-5: pgAdmin4でのテーブル構造確認</h5>
                        <p>作成されたテーブル構造をpgAdmin4を使用して視覚的に確認します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>pgAdmin4にアクセス（http://localhost:5050）</li>
                            <li>django_dbデータベースに接続</li>
                            <li>Tablesセクションで新しいテーブルを確認</li>
                            <li>テーブル構造とインデックスを確認</li>
                        </ol>
                        <h6>確認するテーブル</h6>
                        <ul>
                            <li><strong>users_user</strong>: ユーザーメインテーブル</li>
                            <li><strong>users_category</strong>: カテゴリテーブル</li>
                            <li><strong>users_userprofile</strong>: ユーザープロフィールテーブル</li>
                        </ul>

                        <h6>SQLでのテーブル確認</h6>
                        <pre class="code-block"><code class="language-sql">-- テーブル一覧の確認
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name LIKE 'users_%';

-- users_userテーブルの構造確認
\d users_user

-- インデックス確認
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'users_user';</code></pre>
                    </div>

                    <h3 class="section-title">4.5 Django ORMによる基本的なデータベース操作</h3>
                    <p>Django ORMを使用してデータベースの基本的なCRUD操作を実習します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-6: Django ShellでのORM操作</h5>
                        <p>Django Shellを使用してモデルの基本的な操作方法を学習します。</p>
                        <h6>Django Shell起動</h6>
                        <pre class="code-block"><code class="language-bash"># Django Shell を起動
python manage.py shell

# または、IPython拡張があれば
python manage.py shell_plus</code></pre>

                        <h6>基本的なORM操作例</h6>
                        <pre class="code-block"><code class="language-python"># モデルのインポート
from users.models import User, Category, UserProfile
from django.utils import timezone

# === CREATE（作成）操作 ===

# カテゴリの作成
category1 = Category.objects.create(
    name="開発部",
    description="システム開発を担当",
    color="#007bff"
)

category2 = Category.objects.create(
    name="営業部",
    description="営業活動を担当",
    color="#28a745"
)

# ユーザーの作成方法1: create()
user1 = User.objects.create(
    username="tanaka_taro",
    email="tanaka@example.com",
    first_name="太郎",
    last_name="田中",
    phone_number="090-1234-5678",
    birth_date="1990-05-15"
)

# ユーザーの作成方法2: インスタンス作成 + save()
user2 = User(
    username="sato_hanako",
    email="sato@example.com",
    first_name="花子",
    last_name="佐藤"
)
user2.save()

# === READ（読み取り）操作 ===

# 全ユーザーの取得
all_users = User.objects.all()
print(f"総ユーザー数: {all_users.count()}")

# 特定ユーザーの取得
user = User.objects.get(username="tanaka_taro")
print(f"ユーザー: {user.get_full_name()}")

# 複数条件での検索
active_users = User.objects.filter(is_active=True)
print(f"アクティブユーザー数: {active_users.count()}")

# === UPDATE（更新）操作 ===

# 単一オブジェクトの更新
user1.phone_number = "090-9876-5432"
user1.save()

# 複数オブジェクトの一括更新
User.objects.filter(last_name="田中").update(is_active=True)

# === DELETE（削除）操作 ===

# 論理削除（推奨）
user_to_deactivate = User.objects.get(username="sato_hanako")
user_to_deactivate.is_active = False
user_to_deactivate.save()

# 物理削除（注意が必要）
# user_to_delete.delete()

# === リレーション操作 ===

# プロフィールの作成
profile1 = UserProfile.objects.create(
    user=user1,
    category=category1,
    bio="Pythonとウェブ開発が専門です。",
    receive_notifications=True
)

# リレーション経由でのアクセス
print(f"プロフィール: {user1.profile.bio}")
print(f"カテゴリのユーザー: {category1.users.count()}")
</code></pre>

                        <h6>クエリセットとパフォーマンス最適化</h6>
                        <pre class="code-block"><code class="language-python"># N+1問題の回避: select_related（1対1、多対1）
users_with_profiles = User.objects.select_related('profile').all()

# N+1問題の回避: prefetch_related（1対多、多対多）
categories_with_users = Category.objects.prefetch_related('users').all()

# 複雑なクエリの例
from django.db.models import Q, Count

# OR条件での検索
users_or_condition = User.objects.filter(
    Q(first_name="太郎") | Q(first_name="花子")
)

# 集約関数の使用
category_stats = Category.objects.annotate(
    user_count=Count('users')
).filter(user_count__gt=0)

# 日付範囲での検索
from datetime import datetime, timedelta
recent_users = User.objects.filter(
    created_at__gte=timezone.now() - timedelta(days=30)
)

print(f"最近30日のユーザー: {recent_users.count()}")
</code></pre>
                    </div>

                    <h3 class="section-title">4.6 モデルのテストとバリデーション</h3>
                    <p>作成したモデルの動作を検証するためのテストコードを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-7: モデルテストの作成</h5>
                        <p>モデルの機能と制約が正しく動作することを確認するテストコードを作成します。</p>
                        <h6>モデルテスト実装（users/tests.py）</h6>
                        <pre class="code-block"><code class="language-python">from django.test import TestCase
from django.core.exceptions import ValidationError
from django.db import IntegrityError
from users.models import User, Category, UserProfile
from django.utils import timezone


class UserModelTest(TestCase):
    """Userモデルのテストクラス"""

    def setUp(self):
        """各テストの前に実行される初期化"""
        self.test_user_data = {
            'username': 'testuser',
            'email': 'test@example.com',
            'first_name': '太郎',
            'last_name': 'テスト'
        }

    def test_user_creation(self):
        """ユーザー作成のテスト"""
        user = User.objects.create(**self.test_user_data)
        self.assertEqual(user.username, 'testuser')
        self.assertEqual(user.email, 'test@example.com')
        self.assertTrue(user.is_active)
        self.assertIsNotNone(user.created_at)

    def test_user_str_representation(self):
        """ユーザーの文字列表現のテスト"""
        user = User.objects.create(**self.test_user_data)
        expected_str = "testuser (テスト 太郎)"
        self.assertEqual(str(user), expected_str)

    def test_user_get_full_name(self):
        """フルネーム取得のテスト"""
        user = User.objects.create(**self.test_user_data)
        self.assertEqual(user.get_full_name(), "テスト 太郎")

    def test_user_age_calculation(self):
        """年齢計算のテスト"""
        user = User.objects.create(
            **self.test_user_data,
            birth_date='1990-01-01'
        )
        age = user.get_age()
        self.assertIsInstance(age, int)
        self.assertGreater(age, 30)

    def test_username_uniqueness(self):
        """ユーザー名の一意制約のテスト"""
        User.objects.create(**self.test_user_data)
        
        # 同じユーザー名でのユーザー作成はエラーになる
        with self.assertRaises(IntegrityError):
            User.objects.create(
                username='testuser',  # 重複
                email='different@example.com',
                first_name='別の',
                last_name='ユーザー'
            )

    def test_email_uniqueness(self):
        """メールアドレスの一意制約のテスト"""
        User.objects.create(**self.test_user_data)
        
        with self.assertRaises(IntegrityError):
            User.objects.create(
                username='different_user',
                email='test@example.com',  # 重複
                first_name='別の',
                last_name='ユーザー'
            )


class CategoryModelTest(TestCase):
    """Categoryモデルのテストクラス"""

    def test_category_creation(self):
        """カテゴリ作成のテスト"""
        category = Category.objects.create(
            name="テストカテゴリ",
            description="テスト用のカテゴリです",
            color="#ff0000"
        )
        self.assertEqual(category.name, "テストカテゴリ")
        self.assertTrue(category.is_active)

    def test_category_str_representation(self):
        """カテゴリの文字列表現のテスト"""
        category = Category.objects.create(name="開発部")
        self.assertEqual(str(category), "開発部")


class UserProfileModelTest(TestCase):
    """UserProfileモデルのテストクラス"""

    def setUp(self):
        self.user = User.objects.create(
            username='profileuser',
            email='profile@example.com',
            first_name='プロフィール',
            last_name='テスト'
        )
        self.category = Category.objects.create(name="テスト部門")

    def test_user_profile_creation(self):
        """ユーザープロフィール作成のテスト"""
        profile = UserProfile.objects.create(
            user=self.user,
            category=self.category,
            bio="テスト用のプロフィールです"
        )
        self.assertEqual(profile.user, self.user)
        self.assertEqual(profile.category, self.category)
        self.assertTrue(profile.receive_notifications)

    def test_one_to_one_relationship(self):
        """1対1関係のテスト"""
        profile = UserProfile.objects.create(user=self.user)
        
        # ユーザーからプロフィールへのアクセス
        self.assertEqual(self.user.profile, profile)
        
        # プロフィールからユーザーへのアクセス
        self.assertEqual(profile.user, self.user)
</code></pre>

                        <h6>テストの実行</h6>
                        <pre class="code-block"><code class="language-bash"># 全テストの実行
python manage.py test

# 特定アプリのテストのみ実行
python manage.py test users

# 詳細出力でテスト実行
python manage.py test users --verbosity=2

# テストカバレッジの確認（coverageパッケージが必要）
pip install coverage
coverage run --source='.' manage.py test users
coverage report
coverage html</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>Djangoモデルフィールド</strong>: 
                                <p>Q. CharField、TextField、EmailFieldの違いと使い分けを説明してください。</p>
                                <p>A. CharField（固定長文字列、max_length必須）、TextField（可変長文字列、長文用）、EmailField（メール形式バリデーション付きCharField）</p>
                            </li>
                            <li><strong>リレーションシップ</strong>:
                                <p>Q. OneToOneField、ForeignKey、ManyToManyFieldの違いを説明してください。</p>
                                <p>A. OneToOneField（1対1関係）、ForeignKey（多対1関係）、ManyToManyField（多対多関係）で、それぞれデータベースの関係性を定義</p>
                            </li>
                            <li><strong>マイグレーション</strong>:
                                <p>Q. makemigrationsとmigrateコマンドの役割の違いは何ですか？</p>
                                <p>A. makemigrationsはモデル変更からマイグレーションファイルを生成、migrateは生成されたマイグレーションをデータベースに適用</p>
                            </li>
                        </ol>
                    </div>

                    <div class="highlight">
                        <h5>次のステップの準備</h5>
                        <p>Step 4が完了しました！次のStep 5では、ビュー、テンプレート、URLルーティングの実装を行います。以下を確認してから進んでください：</p>
                        <ul>
                            <li>usersアプリケーションが作成され、settings.pyに登録されている</li>
                            <li>User、Category、UserProfileモデルが正しく定義されている</li>
                            <li>マイグレーションが正常に適用され、データベーステーブルが作成されている</li>
                            <li>Django ShellでのORM操作が確認できている</li>
                            <li>モデルテストが正常に実行され、全てパスしている</li>
                        </ul>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step3-django-project-init.html" class="btn btn-secondary">← 前の章: プロジェクト初期化</a>
                        <a href="step5-views-templates-urls.html" class="btn btn-primary">次の章: ビュー・テンプレート →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>