<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django実践チュートリアル ステップ6 - Django管理サイトのセットアップ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        .navbar {
            background-color: #4caf50;
        }
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        .chapter-title {
            color: #4caf50;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #4caf50;
            padding-bottom: 0.5rem;
        }
        .section-title {
            color: #66bb6a;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #4caf50;
        }
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .nav-link.active {
            background-color: #4caf50 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand">
                <strong>Django実践チュートリアル</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>チュートリアルステップ</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                ステップ1: 開発環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-docker-postgresql.html">
                                ステップ2: Docker・PostgreSQL
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-django-project-init.html">
                                ステップ3: プロジェクト初期化
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-models-migration.html">
                                ステップ4: モデル・マイグレーション
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-views-templates-urls.html">
                                ステップ5: ビュー・テンプレート・URL
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step6-admin-interface.html">
                                ステップ6: 管理サイト
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-crud-operations.html">
                                ステップ7: CRUD操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step8-validation-security.html">
                                ステップ8: バリデーション・セキュリティ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step9-testing-debugging.html">
                                ステップ9: テスト・デバッグ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- ステップヘッダー -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">ステップ6: Django管理サイトのセットアップ</h1>
                </div>

                <div id="step6">
                    <!-- このステップの目標 -->
                    <div class="highlight">
                        <h5>このステップで実装すること</h5>
                        <ul>
                            <li>管理サイトの有効化</li>
                            <li>スーパーユーザーの作成</li>
                            <li>モデルの管理サイト登録</li>
                            <li>管理画面のカスタマイズ</li>
                            <li>リスト表示と検索機能</li>
                            <li>インライン編集の実装</li>
                        </ul>
                    </div>

                    <!-- 前提条件・準備 -->
                    <div class="alert alert-info">
                        <h6>前提条件</h6>
                        <ul>
                            <li>ステップ1〜5が完了していること</li>
                            <li>カスタムUserモデルが実装済み</li>
                            <li>UserAdminが基本設定済み</li>
                            <li>PostgreSQLデータベースが動作中</li>
                        </ul>
                    </div>

                    <h2 class="chapter-title">Django管理サイトの活用と最適化</h2>

                    <!-- セクション1: 管理サイトカスタマイズ -->
                    <h3 class="section-title">6.1 管理サイト全体のカスタマイズ</h3>
                    <p>Django管理サイトの見た目とタイトルをプロジェクトに合わせてカスタマイズします。</p>

                    <!-- 実装手順1 -->
                    <div class="exercise-container">
                        <h5>実装 6-1: 管理サイトのタイトルとヘッダーカスタマイズ</h5>
                        <p>管理サイトのタイトルとヘッダーをプロジェクト固有の名称に変更します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>myproject/urls.pyで管理サイトの設定</strong>:
                                <pre class="code-block"><code class="language-python"># myproject/urls.py に追加
from django.contrib import admin

# 管理サイトのカスタマイズ
admin.site.site_header = "ユーザー管理システム"
admin.site.site_title = "管理サイト"
admin.site.index_title = "ユーザー管理システム 管理画面"

urlpatterns = [
    path('admin/', admin.site.urls),
    path('users/', include('users.urls')),
    path('', redirect_to_users, name='home'),
]</code></pre>
                            </li>
                            <li><strong>管理サイトのCSSカスタマイズ（オプション）</strong>:
                                <pre class="code-block"><code class="language-bash"># 管理サイト用のCSS格納ディレクトリ作成
mkdir static\admin
mkdir static\admin\css</code></pre>
                                <pre class="code-block"><code class="language-css">/* static/admin/css/admin_custom.css */
/* Django管理サイトのカスタムスタイル */
#header {
    background-color: #4caf50;
}

#branding h1 {
    color: #ffffff;
}

.module h2, .module caption, .inline-group h2 {
    background-color: #66bb6a;
}

.button, input[type=submit], input[type=button], .submit-row input {
    background-color: #4caf50;
    border: 1px solid #4caf50;
}

.button:hover, input[type=submit]:hover, input[type=button]:hover {
    background-color: #388e3c;
}</code></pre>
                            </li>
                        </ol>
                        
                        <h6>動作確認</h6>
                        <p>管理サイトにアクセスしてカスタマイズ確認:</p>
                        <pre class="code-block"><code class="language-bash"># 開発サーバー起動
python manage.py runserver

# ブラウザで http://127.0.0.1:8000/admin/ にアクセス</code></pre>
                        
                        <h6>期待される結果</h6>
                        <div class="alert alert-success">
                            <p>管理サイトのヘッダーが「ユーザー管理システム」に変更され、カスタマイズが適用されている</p>
                        </div>
                    </div>

                    <!-- セクション2: 詳細なUserAdmin設定 -->
                    <h3 class="section-title">6.2 UserAdmin詳細カスタマイズ</h3>
                    <p>ユーザー管理をより効率的に行うため、詳細な管理画面設定を行います。</p>

                    <!-- 実装手順2 -->
                    <div class="exercise-container">
                        <h5>実装 6-2: 高度なUserAdmin機能実装</h5>
                        <p>フィルタリング、検索、一括操作などの高度な管理機能を追加します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>users/admin.pyの拡張</strong>: 既存のUserAdminクラスに機能を追加
                                <pre class="code-block"><code class="language-python"># users/admin.py に追加機能
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from django.utils.html import format_html
from django.urls import reverse
from django.utils.safestring import mark_safe
from .models import User


@admin.register(User)
class UserAdmin(BaseUserAdmin):
    """カスタムユーザー管理画面設定"""
    
    # リスト表示設定（拡張版）
    list_display = (
        'username', 'email', 'get_full_name_display', 
        'phone_number', 'get_age_display', 'is_active', 
        'is_staff', 'date_joined', 'last_login', 'get_actions_display'
    )
    
    list_filter = (
        'is_active', 'is_staff', 'is_superuser', 'date_joined', 
        'last_login', 'birth_date'
    )
    
    search_fields = (
        'username', 'email', 'first_name', 'last_name', 'phone_number'
    )
    
    ordering = ('-date_joined',)
    
    # 詳細表示設定（拡張版）
    fieldsets = (
        (None, {
            'fields': ('username', 'password')
        }),
        ('個人情報', {
            'fields': ('first_name', 'last_name', 'email', 'phone_number', 'birth_date'),
            'classes': ('wide',),
            'description': 'ユーザーの基本的な個人情報を設定します。'
        }),
        ('権限設定', {
            'fields': ('is_active', 'is_staff', 'is_superuser', 'groups', 'user_permissions'),
            'classes': ('collapse',),
            'description': 'ユーザーの権限とグループを設定します。'
        }),
        ('重要な日付', {
            'fields': ('last_login', 'date_joined'),
            'classes': ('collapse',),
            'description': 'システムで自動管理される日付情報です。'
        }),
    )
    
    # ユーザー追加時のフィールド設定
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('username', 'email', 'password1', 'password2'),
        }),
        ('個人情報', {
            'classes': ('wide',),
            'fields': ('first_name', 'last_name', 'phone_number', 'birth_date'),
        }),
        ('権限設定', {
            'classes': ('wide',),
            'fields': ('is_active', 'is_staff'),
        }),
    )
    
    # 一覧表示でのアイテム数
    list_per_page = 20
    list_max_show_all = 100
    
    # 日付でのドリルダウンナビゲーション
    date_hierarchy = 'date_joined'
    
    # カスタム表示メソッド
    def get_full_name_display(self, obj):
        """フルネーム表示"""
        full_name = obj.get_full_name()
        if full_name:
            return full_name
        return format_html('<span style="color: #999;">-</span>')
    get_full_name_display.short_description = 'フルネーム'
    get_full_name_display.admin_order_field = 'first_name'
    
    def get_age_display(self, obj):
        """年齢表示"""
        age = obj.get_age()
        if age is not None:
            if age < 20:
                return format_html('<span style="color: #2196f3;">{} 歳</span>', age)
            elif age >= 65:
                return format_html('<span style="color: #ff9800;">{} 歳</span>', age)
            else:
                return f"{age} 歳"
        return format_html('<span style="color: #999;">-</span>')
    get_age_display.short_description = '年齢'
    
    def get_actions_display(self, obj):
        """アクションリンク表示"""
        detail_url = reverse('users:user_detail', args=[obj.pk])
        edit_url = reverse('users:user_update', args=[obj.pk])
        return format_html(
            '<a href="{}" target="_blank" class="button">詳細</a> '
            '<a href="{}" target="_blank" class="button">編集</a>',
            detail_url, edit_url
        )
    get_actions_display.short_description = '操作'
    
    # 高度なカスタムアクション
    def make_active_with_notification(self, request, queryset):
        """ユーザーをアクティブにし、メール通知を送信（模擬）"""
        count = queryset.update(is_active=True)
        # 実際の実装では、ここでメール送信処理を行う
        self.message_user(
            request,
            f'{count}人のユーザーをアクティブにしました。通知メールを送信しました。'
        )
    make_active_with_notification.short_description = "選択されたユーザーをアクティブにして通知送信"
    
    def export_user_data(self, request, queryset):
        """ユーザーデータのエクスポート（CSV形式）"""
        import csv
        from django.http import HttpResponse
        
        response = HttpResponse(content_type='text/csv')
        response['Content-Disposition'] = 'attachment; filename="users.csv"'
        
        writer = csv.writer(response)
        writer.writerow(['ユーザー名', 'メール', '姓', '名', '電話番号', '生年月日', '登録日'])
        
        for user in queryset:
            writer.writerow([
                user.username, user.email, user.first_name, user.last_name,
                user.phone_number, user.birth_date, user.date_joined.strftime('%Y-%m-%d')
            ])
        
        return response
    export_user_data.short_description = "選択されたユーザーデータをCSVでエクスポート"
    
    actions = ['make_active_with_notification', 'export_user_data', 'make_inactive', 'make_active']
    
    # インライン編集の設定（将来の拡張用）
    # inlines = [ProfileInline]  # プロフィール関連モデルがある場合</code></pre>
                            </li>
                        </ol>
                        
                        <h6>動作確認</h6>
                        <p>拡張された管理画面の機能確認:</p>
                        <ol>
                            <li>ユーザー一覧でのフィルタリング</li>
                            <li>検索機能のテスト</li>
                            <li>カスタムアクションの実行</li>
                            <li>CSVエクスポート機能</li>
                            <li>日付ヒエラルキーナビゲーション</li>
                        </ol>
                        
                        <h6>期待される結果</h6>
                        <div class="alert alert-success">
                            <p>管理サイトでユーザー管理が効率的に行え、CSVエクスポート等の高度な機能が利用できる</p>
                        </div>
                    </div>

                    <!-- セクション3: 管理サイトセキュリティ設定 -->
                    <h3 class="section-title">6.3 管理サイトセキュリティ設定</h3>
                    <p>管理サイトのセキュリティを向上させるための設定を行います。</p>

                    <!-- 実装手順3 -->
                    <div class="exercise-container">
                        <h5>実装 6-3: 管理サイトセキュリティ強化</h5>
                        <p>アクセス制限とセキュリティ設定を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>IP制限設定（開発環境用）</strong>:
                                <pre class="code-block"><code class="language-python"># myproject/settings.py に追加
# 管理サイトアクセス制限（開発環境）
if DEBUG:
    ALLOWED_ADMIN_IPS = ['127.0.0.1', 'localhost']
else:
    # 本番環境では具体的なIPアドレスを指定
    ALLOWED_ADMIN_IPS = ['10.0.0.1']  # 例</code></pre>
                            </li>
                            <li><strong>管理サイト用のミドルウェア作成</strong>:
                                <pre class="code-block"><code class="language-python"># users/middleware.py (新規作成)
from django.conf import settings
from django.core.exceptions import PermissionDenied
from django.utils.deprecation import MiddlewareMixin


class AdminAccessMiddleware(MiddlewareMixin):
    """管理サイトアクセス制限ミドルウェア"""
    
    def process_request(self, request):
        if request.path.startswith('/admin/'):
            # 開発環境では制限を緩くする
            if settings.DEBUG:
                return None
            
            # 本番環境ではIP制限を適用
            remote_ip = self.get_client_ip(request)
            allowed_ips = getattr(settings, 'ALLOWED_ADMIN_IPS', [])
            
            if remote_ip not in allowed_ips:
                raise PermissionDenied("管理サイトへのアクセスが制限されています。")
        
        return None
    
    def get_client_ip(self, request):
        """クライアントIPアドレスを取得"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0]
        else:
            ip = request.META.get('REMOTE_ADDR')
        return ip</code></pre>
                            </li>
                            <li><strong>ログ設定の追加</strong>:
                                <pre class="code-block"><code class="language-python"># myproject/settings.py のLOGGING設定
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': 'logs/admin_access.log',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django.contrib.admin': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}</code></pre>
                                <pre class="code-block"><code class="language-bash"># ログディレクトリ作成
mkdir logs</code></pre>
                            </li>
                        </ol>
                        
                        <h6>動作確認</h6>
                        <p>セキュリティ設定の確認:</p>
                        <ol>
                            <li>管理サイトアクセスログの確認</li>
                            <li>不正アクセス時の動作確認</li>
                        </ol>
                        
                        <h6>期待される結果</h6>
                        <div class="alert alert-success">
                            <p>管理サイトへのアクセスが適切に制限され、アクセスログが記録される</p>
                        </div>
                    </div>

                    <!-- ステップ完了チェック -->
                    <div class="quiz-container">
                        <h5>ステップ完了チェック</h5>
                        <p>以下の項目が完了していることを確認してください：</p>
                        <ul class="list-unstyled">
                            <li>☐ 管理サイトのタイトルとヘッダーがカスタマイズされている</li>
                            <li>☐ UserAdminの詳細機能が実装されている</li>
                            <li>☐ 検索・フィルタリング機能が動作する</li>
                            <li>☐ カスタムアクション（CSVエクスポート等）が実装されている</li>
                            <li>☐ セキュリティ設定が適用されている</li>
                            <li>☐ アクセスログが記録される</li>
                        </ul>
                    </div>

                    <!-- ステップ間ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step5-views-templates-urls.html" class="btn btn-secondary">← 前のステップ: ビュー・テンプレート・URL</a>
                        <a href="step7-crud-operations.html" class="btn btn-primary">次のステップ: CRUD操作 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- フッター -->
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
    
    <!-- Mermaid.js 初期化 -->
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>