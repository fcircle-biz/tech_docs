<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django + PostgreSQL チュートリアル Step 6 - Django管理サイトのセットアップ</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #2e7d33;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #2e7d33;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2e7d33;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #4caf50;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2e7d33;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #2e7d33 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Django + PostgreSQL チュートリアル</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-docker-postgresql.html">
                                Step 2: PostgreSQL環境
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-django-project-init.html">
                                Step 3: プロジェクト初期化
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-models-migration.html">
                                Step 4: モデル設計
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-views-templates-urls.html">
                                Step 5: ビュー・テンプレート
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step6-admin-interface.html">
                                Step 6: 管理サイト
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-crud-operations.html">
                                Step 7: CRUD操作
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step8-validation-security.html">
                                Step 8: バリデーション・セキュリティ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step9-testing-debugging.html">
                                Step 9: テスト・デバッグ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 6: Django管理サイトのセットアップ</h1>
                </div>

                <div id="step6">
                    <h2 class="chapter-title">Django Admin インターフェースの活用</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Django管理サイトの基本的な有効化と設定</li>
                            <li>モデルの管理サイトへの登録とカスタマイズ</li>
                            <li>管理画面の表示カスタマイズ（リスト表示、検索、フィルター）</li>
                            <li>インライン編集機能の実装</li>
                            <li>カスタムアクションの追加</li>
                            <li>管理サイトのセキュリティ設定</li>
                        </ul>
                    </div>

                    <h3 class="section-title">6.1 管理サイト用モデル登録</h3>
                    <p>作成したモデルをDjango管理サイトで管理できるように登録します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-1: Adminクラスの作成と登録</h5>
                        <p>User、Category、UserProfileモデルの管理画面をカスタマイズして登録します。</p>
                        
                        <h6>admin.py実装（users/admin.py）</h6>
                        <pre class="code-block"><code class="language-python">from django.contrib import admin
from django.utils.html import format_html
from .models import User, Category, UserProfile


@admin.register(Category)
class CategoryAdmin(admin.ModelAdmin):
    """カテゴリ管理画面の設定"""
    
    list_display = ['name', 'user_count', 'color_preview', 'is_active', 'created_at']
    list_filter = ['is_active', 'created_at']
    search_fields = ['name', 'description']
    list_editable = ['is_active']
    ordering = ['name']
    
    fieldsets = (
        ('基本情報', {
            'fields': ('name', 'description')
        }),
        ('表示設定', {
            'fields': ('color', 'is_active')
        }),
    )
    
    def color_preview(self, obj):
        """カラーコードのプレビュー表示"""
        return format_html(
            '&lt;div style="width: 20px; height: 20px; background-color: {}; border: 1px solid #ccc; display: inline-block;"&gt;&lt;/div&gt; {}',
            obj.color, obj.color
        )
    color_preview.short_description = 'カラープレビュー'
    
    def user_count(self, obj):
        """このカテゴリのアクティブユーザー数"""
        return obj.users.filter(is_active=True).count()
    user_count.short_description = 'ユーザー数'


class UserProfileInline(admin.StackedInline):
    """ユーザープロフィールのインライン編集"""
    model = UserProfile
    can_delete = False
    extra = 0
    fieldsets = (
        ('プロフィール情報', {
            'fields': ('category', 'bio', 'website')
        }),
        ('設定', {
            'fields': ('receive_notifications', 'receive_email_updates'),
            'classes': ('collapse',)
        }),
        ('統計情報', {
            'fields': ('login_count', 'last_login_ip'),
            'classes': ('collapse',),
        }),
    )


@admin.register(User)
class UserAdmin(admin.ModelAdmin):
    """ユーザー管理画面の設定"""
    
    list_display = [
        'username', 'get_full_name', 'email', 'get_category', 
        'is_active', 'created_at', 'get_age'
    ]
    list_filter = [
        'is_active', 'gender', 'created_at', 
        'profile__category', 'profile__receive_notifications'
    ]
    search_fields = [
        'username', 'first_name', 'last_name', 'email', 
        'phone_number'
    ]
    list_editable = ['is_active']
    ordering = ['-created_at']
    list_per_page = 25
    
    fieldsets = (
        ('基本情報', {
            'fields': ('username', 'email')
        }),
        ('個人情報', {
            'fields': (('first_name', 'last_name'), 'birth_date', 'gender')
        }),
        ('連絡先情報', {
            'fields': ('phone_number', ('postal_code', 'address'))
        }),
        ('システム情報', {
            'fields': ('is_active', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    readonly_fields = ['created_at', 'updated_at']
    inlines = [UserProfileInline]
    
    actions = ['make_active', 'make_inactive', 'reset_login_count']
    
    def get_full_name(self, obj):
        """フルネーム表示"""
        return obj.get_full_name()
    get_full_name.short_description = '氏名'
    get_full_name.admin_order_field = 'last_name'
    
    def get_category(self, obj):
        """カテゴリ表示"""
        if hasattr(obj, 'profile') and obj.profile.category:
            return format_html(
                '&lt;span style="background-color: {}; color: white; padding: 2px 8px; border-radius: 3px;"&gt;{}&lt;/span&gt;',
                obj.profile.category.color,
                obj.profile.category.name
            )
        return '-'
    get_category.short_description = 'カテゴリ'
    
    def get_age(self, obj):
        """年齢表示"""
        age = obj.get_age()
        return f'{age}歳' if age else '-'
    get_age.short_description = '年齢'
    
    # カスタムアクション
    def make_active(self, request, queryset):
        """ユーザーをアクティブにする"""
        updated = queryset.update(is_active=True)
        self.message_user(request, f'{updated}件のユーザーをアクティブにしました。')
    make_active.short_description = '選択したユーザーをアクティブにする'
    
    def make_inactive(self, request, queryset):
        """ユーザーを非アクティブにする"""
        updated = queryset.update(is_active=False)
        self.message_user(request, f'{updated}件のユーザーを非アクティブにしました。')
    make_inactive.short_description = '選択したユーザーを非アクティブにする'
    
    def reset_login_count(self, request, queryset):
        """ログイン回数をリセット"""
        for user in queryset:
            if hasattr(user, 'profile'):
                user.profile.login_count = 0
                user.profile.save()
        self.message_user(request, f'{queryset.count()}件のログイン回数をリセットしました。')
    reset_login_count.short_description = '選択したユーザーのログイン回数をリセット'


@admin.register(UserProfile)
class UserProfileAdmin(admin.ModelAdmin):
    """ユーザープロフィール管理画面の設定"""
    
    list_display = [
        'user', 'category', 'has_bio', 'receive_notifications', 
        'login_count', 'updated_at'
    ]
    list_filter = [
        'category', 'receive_notifications', 'receive_email_updates', 
        'updated_at'
    ]
    search_fields = ['user__username', 'user__first_name', 'user__last_name', 'bio']
    
    fieldsets = (
        ('ユーザー情報', {
            'fields': ('user', 'category')
        }),
        ('プロフィール', {
            'fields': ('bio', 'website', 'avatar')
        }),
        ('設定', {
            'fields': ('receive_notifications', 'receive_email_updates')
        }),
        ('統計', {
            'fields': ('login_count', 'last_login_ip', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    readonly_fields = ['updated_at']
    
    def has_bio(self, obj):
        """自己紹介の有無"""
        return bool(obj.bio)
    has_bio.boolean = True
    has_bio.short_description = '自己紹介あり'</code></pre>
                    </div>

                    <h3 class="section-title">6.2 管理サイトのカスタマイズ</h3>
                    <p>管理サイトの外観と動作をより使いやすくカスタマイズします。</p>

                    <div class="exercise-container">
                        <h5>実習 6-2: 管理サイトの全体カスタマイズ</h5>
                        <p>Django管理サイトのタイトルやテーマを変更し、使いやすい環境を構築します。</p>
                        
                        <h6>管理サイト設定（users/apps.py更新）</h6>
                        <pre class="code-block"><code class="language-python">from django.apps import AppConfig
from django.contrib import admin

class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'users'
    verbose_name = 'ユーザー管理'
    
    def ready(self):
        """アプリケーション初期化時の設定"""
        # 管理サイトのカスタマイズ
        admin.site.site_header = 'Django Tutorial 管理サイト'
        admin.site.site_title = 'Django Tutorial Admin'
        admin.site.index_title = 'アプリケーション管理'
        
        # カスタムCSS（オプション）
        admin.site.site_url = '/users/'  # 「サイトを表示」リンク先</code></pre>

                        <h6>カスタム管理画面CSS（static/admin/css/custom_admin.css作成）</h6>
                        <pre class="code-block"><code class="language-bash"># 管理画面用CSS格納ディレクトリの作成
mkdir static\admin
mkdir static\admin\css</code></pre>

                        <pre class="code-block"><code class="language-css">/* カスタム管理画面CSS */

/* ヘッダーの色変更 */
#header {
    background: linear-gradient(135deg, #2e7d32, #4caf50);
    border-bottom: 3px solid #1b5e20;
}

/* ダッシュボードのモジュールスタイル */
.module h2, .module caption, .inline-group h2 {
    background: #2e7d32;
    color: white;
}

/* ボタンのスタイル */
.button, input[type=submit], input[type=button], .submit-row input, a.button {
    background: #2e7d32;
    border: none;
}

.button:hover, input[type=submit]:hover, input[type=button]:hover, .submit-row input:hover, a.button:hover {
    background: #1b5e20;
}

/* リンクの色 */
a:link, a:visited {
    color: #2e7d32;
}

/* テーブル行のホバー効果 */
.results tbody tr:hover {
    background-color: #e8f5e8;
}

/* カスタムフィールドのスタイル */
.color-preview {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}</code></pre>

                        <h6>settings.py でのCSS読み込み設定</h6>
                        <pre class="code-block"><code class="language-python"># settings.py に追加

# Admin site customization
ADMIN_SITE_HEADER = "Django Tutorial 管理サイト"

# 管理画面の静的ファイル
STATICFILES_DIRS = [
    BASE_DIR / 'static',
    BASE_DIR / 'static/admin',  # 管理画面用静的ファイル
]</code></pre>
                    </div>

                    <h3 class="section-title">6.3 データ投入とテスト</h3>
                    <p>管理サイトの機能をテストするためのテストデータを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 6-3: 管理データフィクスチャの作成</h5>
                        <p>テスト用のデータを作成し、管理サイトの各機能を確認します。</p>
                        
                        <h6>Django Shellでのテストデータ作成</h6>
                        <pre class="code-block"><code class="language-python"># Django Shell起動
python manage.py shell

# テストデータ作成スクリプト
from users.models import User, Category, UserProfile
from django.utils import timezone
import random

# カテゴリの作成
categories = [
    Category.objects.create(name="開発部", description="システム開発担当", color="#007bff"),
    Category.objects.create(name="営業部", description="営業活動担当", color="#28a745"),
    Category.objects.create(name="人事部", description="人事管理担当", color="#ffc107"),
    Category.objects.create(name="総務部", description="総務業務担当", color="#6c757d"),
]

# ユーザーの作成
users_data = [
    {"username": "tanaka_taro", "email": "tanaka@example.com", "first_name": "太郎", "last_name": "田中", "birth_date": "1985-03-15"},
    {"username": "sato_hanako", "email": "sato@example.com", "first_name": "花子", "last_name": "佐藤", "birth_date": "1990-07-22"},
    {"username": "yamada_jiro", "email": "yamada@example.com", "first_name": "次郎", "last_name": "山田", "birth_date": "1988-12-03"},
    {"username": "watanabe_yuki", "email": "watanabe@example.com", "first_name": "雪", "last_name": "渡辺", "birth_date": "1992-01-18"},
    {"username": "ito_hiroshi", "email": "ito@example.com", "first_name": "寛", "last_name": "伊藤", "birth_date": "1987-09-11"},
]

for user_data in users_data:
    user = User.objects.create(**user_data)
    
    # プロフィールの作成
    UserProfile.objects.create(
        user=user,
        category=random.choice(categories),
        bio=f"{user.get_full_name()}です。{user_data['first_name']}と呼んでください。",
        login_count=random.randint(1, 100),
        receive_notifications=random.choice([True, False])
    )

print("テストデータの作成が完了しました。")</code></pre>

                        <h6>管理画面へのアクセスと確認</h6>
                        <pre class="code-block"><code class="language-bash"># 開発サーバーの起動
python manage.py runserver

# 管理画面アクセス
# http://127.0.0.1:8000/admin/

# 確認項目:
# 1. ユーザー一覧での検索・フィルター機能
# 2. ユーザー詳細でのインライン編集
# 3. カテゴリ管理機能
# 4. カスタムアクションの動作
# 5. 一括操作の実行</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>Django Admin</strong>: 
                                <p>Q. Django管理サイトの主な機能と利点を説明してください。</p>
                                <p>A. CRUD操作の自動生成、検索・フィルター機能、一括操作、認証・権限管理が標準で提供され、開発効率が向上</p>
                            </li>
                            <li><strong>AdminクラスとInline</strong>:
                                <p>Q. InlineクラスとStackedInlineの使用目的は何ですか？</p>
                                <p>A. 関連モデルを親モデルと同じ画面で編集可能にし、1対1や1対多の関係を効率的に管理</p>
                            </li>
                            <li><strong>カスタムアクション</strong>:
                                <p>Q. Django管理サイトでカスタムアクションを作成する利点は何ですか？</p>
                                <p>A. 複数レコードに対する一括処理を簡単に実装でき、運用業務を効率化できる</p>
                            </li>
                        </ol>
                    </div>

                    <div class="highlight">
                        <h5>次のステップの準備</h5>
                        <p>Step 6が完了しました！次のStep 7では、基本的なCRUD操作の実装を行います。以下を確認してから進んでください：</p>
                        <ul>
                            <li>Django管理サイトに全モデルが正しく登録されている</li>
                            <li>リスト表示、検索、フィルター機能が動作している</li>
                            <li>インライン編集機能が正しく設定されている</li>
                            <li>カスタムアクションが実装され、動作している</li>
                            <li>テストデータが作成され、管理画面で操作可能な状態</li>
                        </ul>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step5-views-templates-urls.html" class="btn btn-secondary">← 前の章: ビュー・テンプレート</a>
                        <a href="step7-crud-operations.html" class="btn btn-primary">次の章: CRUD操作 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>