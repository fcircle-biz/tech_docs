<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django実践チュートリアル ステップ8 - フォームバリデーションとセキュリティ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #4caf50; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #4caf50; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #4caf50; padding-bottom: 0.5rem; }
        .section-title { color: #66bb6a; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container { background-color: #e8f5e8; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #4caf50; }
        .exercise-container { background-color: #f3e5f5; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #9c27b0; }
        .highlight { background-color: #ffecb3; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #ffc107; }
        .code-block { background-color: #1e1e1e; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #4caf50 !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand"><strong>Django実践チュートリアル</strong></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>チュートリアルステップ</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="step1-environment-setup.html">ステップ1: 開発環境構築</a></li>
                        <li class="nav-item"><a class="nav-link" href="step2-docker-postgresql.html">ステップ2: Docker・PostgreSQL</a></li>
                        <li class="nav-item"><a class="nav-link" href="step3-django-project-init.html">ステップ3: プロジェクト初期化</a></li>
                        <li class="nav-item"><a class="nav-link" href="step4-models-migration.html">ステップ4: モデル・マイグレーション</a></li>
                        <li class="nav-item"><a class="nav-link" href="step5-views-templates-urls.html">ステップ5: ビュー・テンプレート・URL</a></li>
                        <li class="nav-item"><a class="nav-link" href="step6-admin-interface.html">ステップ6: 管理サイト</a></li>
                        <li class="nav-item"><a class="nav-link" href="step7-crud-operations.html">ステップ7: CRUD操作</a></li>
                        <li class="nav-item"><a class="nav-link active" href="step8-validation-security.html">ステップ8: バリデーション・セキュリティ</a></li>
                        <li class="nav-item"><a class="nav-link" href="step9-testing-debugging.html">ステップ9: テスト・デバッグ</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">ステップ8: フォームバリデーションとセキュリティ</h1>
                </div>

                <div id="step8">
                    <div class="highlight">
                        <h5>このステップで実装すること</h5>
                        <ul>
                            <li>Djangoフォームの作成</li>
                            <li>フィールドバリデーション</li>
                            <li>カスタムバリデータの実装</li>
                            <li>CSRF対策の理解と実装</li>
                            <li>XSS対策とテンプレートエスケープ</li>
                            <li>SQLインジェクション対策</li>
                            <li>セキュアなパスワード管理</li>
                        </ul>
                    </div>

                    <h2 class="chapter-title">セキュアなWebアプリケーションの構築</h2>

                    <div class="exercise-container">
                        <h5>実装 8-1: 高度なフォームバリデーション</h5>
                        <p>カスタムバリデータとクリーンメソッドを実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>users/validators.py作成</strong>:
                                <pre class="code-block"><code class="language-python"># users/validators.py (新規作成)
import re
from django.core.exceptions import ValidationError
from django.utils.translation import gettext as _

def validate_phone_number(value):
    """電話番号の詳細バリデーション"""
    if not value:
        return
    
    # 基本パターンチェック
    pattern = r'^\d{2,4}-\d{2,4}-\d{4}$'
    if not re.match(pattern, value):
        raise ValidationError(
            _('電話番号は「090-1234-5678」の形式で入力してください。'),
            code='invalid_phone'
        )
    
    # 無効な番号パターンをチェック
    invalid_patterns = [
        r'^000-0000-0000$',  # すべて0
        r'^(\d)\1{2}-\1{4}-\1{4}$',  # 同じ数字の繰り返し
    ]
    
    for pattern in invalid_patterns:
        if re.match(pattern, value):
            raise ValidationError(
                _('有効な電話番号を入力してください。'),
                code='invalid_phone'
            )

def validate_username_chars(value):
    """ユーザー名の文字制限バリデーション"""
    if not re.match(r'^[a-zA-Z0-9_-]+$', value):
        raise ValidationError(
            _('ユーザー名には英数字、ハイフン、アンダースコアのみ使用できます。'),
            code='invalid_username_chars'
        )

def validate_password_strength(password):
    """パスワード強度のバリデーション"""
    if len(password) < 8:
        raise ValidationError(_('パスワードは8文字以上である必要があります。'))
    
    if not re.search(r'[A-Z]', password):
        raise ValidationError(_('パスワードには大文字を1文字以上含める必要があります。'))
    
    if not re.search(r'[a-z]', password):
        raise ValidationError(_('パスワードには小文字を1文字以上含める必要があります。'))
    
    if not re.search(r'[0-9]', password):
        raise ValidationError(_('パスワードには数字を1文字以上含める必要があります。'))
    
    if not re.search(r'[!@#$%^&*(),.?":{}|<>]', password):
        raise ValidationError(_('パスワードには特殊文字を1文字以上含めることを推奨します。'))

class AgeRangeValidator:
    """年齢範囲のバリデータクラス"""
    def __init__(self, min_age=0, max_age=120):
        self.min_age = min_age
        self.max_age = max_age

    def __call__(self, value):
        from datetime import date
        if value:
            today = date.today()
            age = today.year - value.year - ((today.month, today.day) < (value.month, value.day))
            
            if age < self.min_age:
                raise ValidationError(
                    f'年齢は{self.min_age}歳以上である必要があります。',
                    code='age_too_young'
                )
            
            if age > self.max_age:
                raise ValidationError(
                    f'年齢は{self.max_age}歳以下である必要があります。',
                    code='age_too_old'
                )

    def deconstruct(self):
        return ('users.validators.AgeRangeValidator', (), {'min_age': self.min_age, 'max_age': self.max_age})</code></pre>
                            </li>
                            <li><strong>models.pyの更新</strong>:
                                <pre class="code-block"><code class="language-python"># users/models.py にバリデータを追加
from .validators import validate_phone_number, validate_username_chars, AgeRangeValidator

class User(AbstractUser):
    username = models.CharField(
        'ユーザー名',
        max_length=150,
        unique=True,
        validators=[validate_username_chars],  # カスタムバリデータ追加
        help_text='英数字、ハイフン、アンダースコアのみ使用可能'
    )
    
    phone_number = models.CharField(
        '電話番号',
        validators=[validate_phone_number],  # 更新されたバリデータ
        max_length=15,
        blank=True,
        help_text='ハイフン区切りで入力 (例: 090-1234-5678)'
    )
    
    birth_date = models.DateField(
        '生年月日',
        null=True,
        blank=True,
        validators=[AgeRangeValidator(min_age=13, max_age=100)],  # 年齢制限
        help_text='YYYY-MM-DD形式（13歳以上100歳以下）'
    )</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>実装 8-2: セキュリティ強化設定</h5>
                        <p>Django標準のセキュリティ機能を活用して脆弱性対策を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>settings.pyセキュリティ設定</strong>:
                                <pre class="code-block"><code class="language-python"># myproject/settings.py にセキュリティ設定を追加

# セキュリティ設定
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'

# CSRF設定
CSRF_COOKIE_SECURE = not DEBUG  # HTTPSでのみCSRFクッキーを送信
CSRF_COOKIE_HTTPONLY = True
CSRF_COOKIE_AGE = 3600  # 1時間でCSRFトークンを期限切れに

# セッション設定
SESSION_COOKIE_SECURE = not DEBUG  # HTTPSでのみセッションクッキーを送信
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_AGE = 3600  # 1時間でセッションを期限切れに
SESSION_EXPIRE_AT_BROWSER_CLOSE = True

# パスワードバリデーション強化
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
        'OPTIONS': {
            'min_length': 8,
        }
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
    # カスタムバリデータ追加
    {
        'NAME': 'users.validators.CustomPasswordValidator',
    },
]

# SQLインジェクション対策（デフォルトで有効だが明示的に設定）
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# メール設定（開発環境）
if DEBUG:
    EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
else:
    # 本番環境では適切なメール設定を行う
    EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
    EMAIL_HOST = config('EMAIL_HOST', default='localhost')
    EMAIL_PORT = config('EMAIL_PORT', default=587, cast=int)
    EMAIL_HOST_USER = config('EMAIL_HOST_USER', default='')
    EMAIL_HOST_PASSWORD = config('EMAIL_HOST_PASSWORD', default='')
    EMAIL_USE_TLS = config('EMAIL_USE_TLS', default=True, cast=bool)</code></pre>
                            </li>
                            <li><strong>カスタムパスワードバリデータ</strong>:
                                <pre class="code-block"><code class="language-python"># users/validators.py に追加
from django.contrib.auth.password_validation import ValidationError

class CustomPasswordValidator:
    """カスタムパスワードバリデータ"""
    
    def validate(self, password, user=None):
        """パスワードのバリデーション"""
        errors = []
        
        # 長さチェック
        if len(password) < 8:
            errors.append(ValidationError(
                _('パスワードは8文字以上である必要があります。'),
                code='password_too_short'
            ))
        
        # 複雑さチェック
        if not re.search(r'[A-Z]', password):
            errors.append(ValidationError(
                _('パスワードには大文字を1文字以上含める必要があります。'),
                code='password_no_upper'
            ))
        
        if not re.search(r'[a-z]', password):
            errors.append(ValidationError(
                _('パスワードには小文字を1文字以上含める必要があります。'),
                code='password_no_lower'
            ))
        
        if not re.search(r'[0-9]', password):
            errors.append(ValidationError(
                _('パスワードには数字を1文字以上含める必要があります。'),
                code='password_no_digit'
            ))
        
        # ユーザー情報との類似性チェック
        if user:
            user_info = [
                user.username if hasattr(user, 'username') else '',
                user.first_name if hasattr(user, 'first_name') else '',
                user.last_name if hasattr(user, 'last_name') else '',
                user.email if hasattr(user, 'email') else '',
            ]
            
            for info in user_info:
                if info and info.lower() in password.lower():
                    errors.append(ValidationError(
                        _('パスワードにユーザー情報と類似した内容を含めることはできません。'),
                        code='password_too_similar'
                    ))
                    break
        
        if errors:
            raise ValidationError(errors)
    
    def get_help_text(self):
        return _('パスワードは8文字以上で、大文字・小文字・数字を含める必要があります。')</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>実装 8-3: CSRF・XSS対策の実装</h5>
                        <p>クロスサイトスクリプティング（XSS）とCSRF攻撃への対策を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>テンプレートでの適切なエスケープ</strong>:
                                <pre class="code-block"><code class="language-html">&lt;!-- templates/users/secure_display.html (新規作成) --&gt;
{% extends 'base.html' %}
{% load static %}

{% block title %}セキュアな表示例{% endblock %}

{% block content %}
&lt;div class="row"&gt;
    &lt;div class="col-md-8"&gt;
        &lt;h3&gt;適切なエスケープの例&lt;/h3&gt;
        
        &lt;!-- 自動エスケープ（推奨） --&gt;
        &lt;p&gt;&lt;strong&gt;ユーザー名:&lt;/strong&gt; {{ user.username }}&lt;/p&gt;
        
        &lt;!-- HTMLを安全に表示したい場合（慎重に使用） --&gt;
        {% if user.bio %}
            &lt;div class="user-bio"&gt;
                {{ user.bio|linebreaks }}  &lt;!-- 改行をHTMLに変換 --&gt;
            &lt;/div&gt;
        {% endif %}
        
        &lt;!-- URLの安全な生成 --&gt;
        &lt;a href="{% url 'users:user_detail' user.pk %}" class="btn btn-primary"&gt;
            詳細を見る
        &lt;/a&gt;
        
        &lt;!-- JavaScriptに値を安全に渡す --&gt;
        &lt;script&gt;
            // JSONフィルターを使用してJavaScriptで安全に使用
            const userData = {{ user_json|safe }};
            console.log('User ID:', userData.id);
        &lt;/script&gt;
    &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</code></pre>
                            </li>
                            <li><strong>CSRFトークンの適切な使用</strong>:
                                <pre class="code-block"><code class="language-html">&lt;!-- すべてのPOSTフォームでCSRFトークンを使用 --&gt;
&lt;form method="post"&gt;
    {% csrf_token %}
    &lt;!-- フォームフィールド --&gt;
&lt;/form&gt;

&lt;!-- AJAXリクエストでのCSRF対策 --&gt;
&lt;script&gt;
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// AJAXリクエスト例
fetch('/api/users/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
    },
    body: JSON.stringify(data)
});
&lt;/script&gt;</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>実装 8-4: セキュリティミドルウェアの実装</h5>
                        <p>カスタムセキュリティミドルウェアを作成して追加の保護機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>セキュリティミドルウェア作成</strong>:
                                <pre class="code-block"><code class="language-python"># users/middleware.py にセキュリティ機能を追加
import logging
import time
from django.core.cache import cache
from django.http import HttpResponseForbidden
from django.utils.deprecation import MiddlewareMixin

logger = logging.getLogger(__name__)

class SecurityMiddleware(MiddlewareMixin):
    """追加のセキュリティ機能を提供するミドルウェア"""
    
    def process_request(self, request):
        # レート制限
        if self.is_rate_limited(request):
            logger.warning(f'Rate limit exceeded for IP: {self.get_client_ip(request)}')
            return HttpResponseForbidden('アクセス制限中: リクエストが多すぎます。')
        
        # セキュリティヘッダーの追加
        return None
    
    def process_response(self, request, response):
        # セキュリティヘッダーの追加
        response['X-Content-Type-Options'] = 'nosniff'
        response['X-Frame-Options'] = 'DENY'
        response['X-XSS-Protection'] = '1; mode=block'
        response['Referrer-Policy'] = 'strict-origin-when-cross-origin'
        
        # Content Security Policyの設定
        csp = "default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' fonts.googleapis.com cdn.jsdelivr.net; font-src 'self' fonts.gstatic.com;"
        response['Content-Security-Policy'] = csp
        
        return response
    
    def is_rate_limited(self, request):
        """簡単なレート制限の実装"""
        client_ip = self.get_client_ip(request)
        cache_key = f'rate_limit_{client_ip}'
        
        # 1分間に60リクエストまで許可
        current_requests = cache.get(cache_key, 0)
        if current_requests >= 60:
            return True
        
        cache.set(cache_key, current_requests + 1, 60)
        return False
    
    def get_client_ip(self, request):
        """クライアントIPアドレスを取得"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0]
        else:
            ip = request.META.get('REMOTE_ADDR')
        return ip</code></pre>
                            </li>
                            <li><strong>settings.pyでミドルウェア有効化</strong>:
                                <pre class="code-block"><code class="language-python"># myproject/settings.py のMIDDLEWARE設定を更新
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'users.middleware.SecurityMiddleware',  # 追加
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.locale.LocaleMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

# 開発環境でのみDebug Toolbarを有効化
if DEBUG:
    MIDDLEWARE.append('debug_toolbar.middleware.DebugToolbarMiddleware')</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>実装 8-5: セキュリティテスト</h5>
                        <p>実装したセキュリティ機能をテストして動作を確認します。</p>
                        
                        <h6>動作確認</h6>
                        <ol>
                            <li><strong>バリデーションテスト</strong>:
                                <ul>
                                    <li>無効な電話番号でのユーザー登録テスト</li>
                                    <li>弱いパスワードでの登録テスト</li>
                                    <li>無効なユーザー名での登録テスト</li>
                                </ul>
                            </li>
                            <li><strong>CSRFテスト</strong>:
                                <ul>
                                    <li>CSRFトークンなしでのPOSTリクエストテスト</li>
                                    <li>無効なCSRFトークンでのリクエストテスト</li>
                                </ul>
                            </li>
                            <li><strong>セキュリティヘッダーテスト</strong>:
                                <ul>
                                    <li>ブラウザの開発者ツールでレスポンスヘッダー確認</li>
                                    <li>X-Frame-Options、CSP等の設定確認</li>
                                </ul>
                            </li>
                        </ol>
                        
                        <h6>期待される結果</h6>
                        <div class="alert alert-success">
                            <p>セキュリティ機能が適切に動作し、不正なリクエストが適切にブロックされる</p>
                        </div>
                    </div>

                    <div class="quiz-container">
                        <h5>ステップ完了チェック</h5>
                        <ul class="list-unstyled">
                            <li>☐ カスタムバリデータが実装され、正常に動作する</li>
                            <li>☐ CSRF対策が有効になっている</li>
                            <li>☐ XSS対策のためのエスケープが適切に行われている</li>
                            <li>☐ セキュリティヘッダーが適切に設定されている</li>
                            <li>☐ パスワード強度検証が実装されている</li>
                            <li>☐ レート制限機能が動作している</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="step7-crud-operations.html" class="btn btn-secondary">← 前のステップ: CRUD操作</a>
                        <a href="step9-testing-debugging.html" class="btn btn-primary">次のステップ: テスト・デバッグ →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'default' });</script>
</body>
</html>