<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django実践チュートリアル ステップ7 - 基本的なCRUD操作の実装</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding-top: 56px; }
        .navbar { background-color: #4caf50; }
        .sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
        .chapter-title { color: #4caf50; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #4caf50; padding-bottom: 0.5rem; }
        .section-title { color: #66bb6a; margin-top: 1.2rem; margin-bottom: 0.8rem; }
        .quiz-container { background-color: #e8f5e8; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #4caf50; }
        .exercise-container { background-color: #f3e5f5; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; border-left: 4px solid #9c27b0; }
        .highlight { background-color: #ffecb3; border-radius: 8px; padding: 1rem; margin: 1rem 0; border-left: 4px solid #ffc107; }
        .code-block { background-color: #1e1e1e; border-radius: 5px; padding: 1rem; margin: 1rem 0; }
        .nav-link.active { background-color: #4caf50 !important; color: white !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand"><strong>Django実践チュートリアル</strong></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>チュートリアルステップ</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="step1-environment-setup.html">ステップ1: 開発環境構築</a></li>
                        <li class="nav-item"><a class="nav-link" href="step2-docker-postgresql.html">ステップ2: Docker・PostgreSQL</a></li>
                        <li class="nav-item"><a class="nav-link" href="step3-django-project-init.html">ステップ3: プロジェクト初期化</a></li>
                        <li class="nav-item"><a class="nav-link" href="step4-models-migration.html">ステップ4: モデル・マイグレーション</a></li>
                        <li class="nav-item"><a class="nav-link" href="step5-views-templates-urls.html">ステップ5: ビュー・テンプレート・URL</a></li>
                        <li class="nav-item"><a class="nav-link" href="step6-admin-interface.html">ステップ6: 管理サイト</a></li>
                        <li class="nav-item"><a class="nav-link active" href="step7-crud-operations.html">ステップ7: CRUD操作</a></li>
                        <li class="nav-item"><a class="nav-link" href="step8-validation-security.html">ステップ8: バリデーション・セキュリティ</a></li>
                        <li class="nav-item"><a class="nav-link" href="step9-testing-debugging.html">ステップ9: テスト・デバッグ</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">ステップ7: 基本的なCRUD操作の実装</h1>
                </div>

                <div id="step7">
                    <div class="highlight">
                        <h5>このステップで実装すること</h5>
                        <ul>
                            <li>ユーザー一覧表示（ListView）</li>
                            <li>ユーザー詳細表示（DetailView）</li>
                            <li>ユーザー登録フォーム（CreateView）</li>
                            <li>ユーザー情報更新（UpdateView）</li>
                            <li>ユーザー削除機能（DeleteView）</li>
                            <li>ページネーションの実装</li>
                        </ul>
                    </div>

                    <h2 class="chapter-title">フル機能CRUDアプリケーションの構築</h2>

                    <div class="exercise-container">
                        <h5>実装 7-1: 残りのテンプレートファイル作成</h5>
                        <p>ユーザーの作成・編集・削除・詳細表示用のテンプレートを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>ユーザー詳細テンプレート</strong>:
                                <pre class="code-block"><code class="language-html">&lt;!-- templates/users/user_detail.html --&gt;
{% extends 'base.html' %}
{% block title %}{{ user.username }} - 詳細 - {{ block.super }}{% endblock %}
{% block content %}
&lt;div class="row"&gt;
    &lt;div class="col-md-8"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header d-flex justify-content-between align-items-center"&gt;
                &lt;h5 class="mb-0"&gt;ユーザー詳細: {{ user.username }}&lt;/h5&gt;
                &lt;div&gt;
                    &lt;a href="{% url 'users:user_update' user.pk %}" class="btn btn-warning btn-sm"&gt;編集&lt;/a&gt;
                    &lt;a href="{% url 'users:user_delete' user.pk %}" class="btn btn-danger btn-sm"&gt;削除&lt;/a&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
                &lt;table class="table"&gt;
                    &lt;tr&gt;&lt;th&gt;ユーザー名&lt;/th&gt;&lt;td&gt;{{ user.username }}&lt;/td&gt;&lt;/tr&gt;
                    &lt;tr&gt;&lt;th&gt;フルネーム&lt;/th&gt;&lt;td&gt;{{ user.get_full_name|default:'-' }}&lt;/td&gt;&lt;/tr&gt;
                    &lt;tr&gt;&lt;th&gt;メール&lt;/th&gt;&lt;td&gt;&lt;a href="mailto:{{ user.email }}"&gt;{{ user.email }}&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;
                    &lt;tr&gt;&lt;th&gt;電話番号&lt;/th&gt;&lt;td&gt;{{ user.phone_number|default:'-' }}&lt;/td&gt;&lt;/tr&gt;
                    &lt;tr&gt;&lt;th&gt;年齢&lt;/th&gt;&lt;td&gt;{% if user.get_age %}{{ user.get_age }}歳{% else %}-{% endif %}&lt;/td&gt;&lt;/tr&gt;
                    &lt;tr&gt;&lt;th&gt;ステータス&lt;/th&gt;&lt;td&gt;&lt;span class="badge bg-{% if user.is_active %}success{% else %}secondary{% endif %}"&gt;{% if user.is_active %}アクティブ{% else %}非アクティブ{% endif %}&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;
                    &lt;tr&gt;&lt;th&gt;登録日&lt;/th&gt;&lt;td&gt;{{ user.date_joined|date:"Y年m月d日 H:i" }}&lt;/td&gt;&lt;/tr&gt;
                    &lt;tr&gt;&lt;th&gt;最終ログイン&lt;/th&gt;&lt;td&gt;{{ user.last_login|date:"Y年m月d日 H:i"|default:'-' }}&lt;/td&gt;&lt;/tr&gt;
                &lt;/table&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;a href="{% url 'users:user_list' %}" class="btn btn-secondary mt-3"&gt;一覧に戻る&lt;/a&gt;
{% endblock %}</code></pre>
                            </li>
                            <li><strong>ユーザー作成・編集フォーム</strong>:
                                <pre class="code-block"><code class="language-html">&lt;!-- templates/users/user_form.html --&gt;
{% extends 'base.html' %}
{% block title %}{% if form.instance.pk %}{{ form.instance.username }} - 編集{% else %}新規ユーザー登録{% endif %} - {{ block.super }}{% endblock %}
{% block content %}
&lt;div class="row justify-content-center"&gt;
    &lt;div class="col-md-8"&gt;
        &lt;div class="card"&gt;
            &lt;div class="card-header"&gt;
                &lt;h5 class="mb-0"&gt;{% if form.instance.pk %}ユーザー情報編集{% else %}新規ユーザー登録{% endif %}&lt;/h5&gt;
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
                &lt;form method="post"&gt;
                    {% csrf_token %}
                    {% for field in form %}
                    &lt;div class="mb-3"&gt;
                        &lt;label for="{{ field.id_for_label }}" class="form-label"&gt;{{ field.label }}{% if field.field.required %} *{% endif %}&lt;/label&gt;
                        {% if field.field.widget.input_type == 'checkbox' %}
                            &lt;div class="form-check"&gt;
                                {{ field|add_class:"form-check-input" }}
                            &lt;/div&gt;
                        {% else %}
                            {{ field|add_class:"form-control" }}
                        {% endif %}
                        {% if field.help_text %}
                            &lt;div class="form-text"&gt;{{ field.help_text }}&lt;/div&gt;
                        {% endif %}
                        {% if field.errors %}
                            &lt;div class="text-danger"&gt;{{ field.errors }}&lt;/div&gt;
                        {% endif %}
                    &lt;/div&gt;
                    {% endfor %}
                    &lt;div class="d-flex justify-content-between"&gt;
                        &lt;a href="{% url 'users:user_list' %}" class="btn btn-secondary"&gt;キャンセル&lt;/a&gt;
                        &lt;button type="submit" class="btn btn-success"&gt;{% if form.instance.pk %}更新{% else %}登録{% endif %}&lt;/button&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</code></pre>
                            </li>
                            <li><strong>削除確認テンプレート</strong>:
                                <pre class="code-block"><code class="language-html">&lt;!-- templates/users/user_confirm_delete.html --&gt;
{% extends 'base.html' %}
{% block title %}{{ user.username }} - 削除確認 - {{ block.super }}{% endblock %}
{% block content %}
&lt;div class="row justify-content-center"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="card border-danger"&gt;
            &lt;div class="card-header bg-danger text-white"&gt;
                &lt;h5 class="mb-0"&gt;ユーザー削除確認&lt;/h5&gt;
            &lt;/div&gt;
            &lt;div class="card-body"&gt;
                &lt;p class="card-text"&gt;以下のユーザーを削除してもよろしいですか？&lt;/p&gt;
                &lt;div class="alert alert-warning"&gt;
                    &lt;strong&gt;{{ user.username }} ({{ user.get_full_name }})&lt;/strong&gt;&lt;br&gt;
                    メール: {{ user.email }}&lt;br&gt;
                    登録日: {{ user.date_joined|date:"Y年m月d日" }}
                &lt;/div&gt;
                &lt;p class="text-danger"&gt;&lt;strong&gt;注意: この操作は取り消すことができません。&lt;/strong&gt;&lt;/p&gt;
                &lt;form method="post"&gt;
                    {% csrf_token %}
                    &lt;div class="d-flex justify-content-between"&gt;
                        &lt;a href="{% url 'users:user_detail' user.pk %}" class="btn btn-secondary"&gt;キャンセル&lt;/a&gt;
                        &lt;button type="submit" class="btn btn-danger"&gt;削除を実行&lt;/button&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
{% endblock %}</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>実装 7-2: Djangoフォームのカスタマイズ</h5>
                        <p>より使いやすいフォームを作成し、バリデーション機能を追加します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>users/forms.py作成</strong>:
                                <pre class="code-block"><code class="language-python"># users/forms.py (新規作成)
from django import forms
from django.contrib.auth.forms import UserCreationForm
from .models import User

class CustomUserCreationForm(UserCreationForm):
    """カスタムユーザー作成フォーム"""
    email = forms.EmailField(required=True, help_text='有効なメールアドレスを入力してください。')
    first_name = forms.CharField(max_length=50, required=True, help_text='姓を入力してください。')
    last_name = forms.CharField(max_length=50, required=True, help_text='名を入力してください。')
    
    class Meta:
        model = User
        fields = ('username', 'email', 'first_name', 'last_name', 'password1', 'password2')
    
    def clean_email(self):
        email = self.cleaned_data.get('email')
        if email and User.objects.filter(email=email).exists():
            raise forms.ValidationError('このメールアドレスは既に使用されています。')
        return email

class UserUpdateForm(forms.ModelForm):
    """ユーザー更新フォーム"""
    class Meta:
        model = User
        fields = ['username', 'email', 'first_name', 'last_name', 'phone_number', 'birth_date', 'is_active']
        widgets = {
            'birth_date': forms.DateInput(attrs={'type': 'date'}),
            'phone_number': forms.TextInput(attrs={'placeholder': '090-1234-5678'}),
        }
    
    def clean_email(self):
        email = self.cleaned_data.get('email')
        if email and User.objects.filter(email=email).exclude(pk=self.instance.pk).exists():
            raise forms.ValidationError('このメールアドレスは既に使用されています。')
        return email</code></pre>
                            </li>
                            <li><strong>views.pyの更新</strong>: フォームクラスを使用するように変更
                                <pre class="code-block"><code class="language-python"># users/views.py に追加・変更
from .forms import CustomUserCreationForm, UserUpdateForm

class UserCreateView(CreateView):
    """ユーザー作成"""
    model = User
    form_class = CustomUserCreationForm  # フォームクラス指定
    template_name = 'users/user_form.html'
    success_url = reverse_lazy('users:user_list')
    
    def form_valid(self, form):
        user = form.save(commit=False)
        user.set_password(form.cleaned_data['password1'])  # パスワード暗号化
        user.save()
        messages.success(self.request, f'ユーザー「{user.username}」が正常に作成されました。')
        return super().form_valid(form)

class UserUpdateView(UpdateView):
    """ユーザー更新"""
    model = User
    form_class = UserUpdateForm  # フォームクラス指定
    template_name = 'users/user_form.html'
    success_url = reverse_lazy('users:user_list')
    
    def form_valid(self, form):
        messages.success(self.request, f'ユーザー「{form.instance.username}」の情報が正常に更新されました。')
        return super().form_valid(form)</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>実装 7-3: ページネーション機能の強化</h5>
                        <p>大量データに対応したページネーション機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><strong>UserListViewの拡張</strong>:
                                <pre class="code-block"><code class="language-python"># users/views.py のUserListView更新
class UserListView(ListView):
    model = User
    template_name = 'users/user_list.html'
    context_object_name = 'users'
    paginate_by = 5  # 1ページあたりの表示件数
    
    def get_queryset(self):
        queryset = User.objects.all()
        
        # 検索機能
        search_query = self.request.GET.get('search')
        if search_query:
            queryset = queryset.filter(
                Q(username__icontains=search_query) |
                Q(email__icontains=search_query) |
                Q(first_name__icontains=search_query) |
                Q(last_name__icontains=search_query)
            )
        
        # ソート機能
        sort = self.request.GET.get('sort', '-date_joined')
        valid_sorts = ['username', '-username', 'email', '-email', 'date_joined', '-date_joined']
        if sort in valid_sorts:
            queryset = queryset.order_by(sort)
        
        return queryset
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_query'] = self.request.GET.get('search', '')
        context['current_sort'] = self.request.GET.get('sort', '-date_joined')
        context['total_count'] = self.get_queryset().count()
        return context</code></pre>
                            </li>
                        </ol>
                    </div>

                    <div class="exercise-container">
                        <h5>実装 7-4: 最終動作確認</h5>
                        <p>すべてのCRUD機能が正常に動作することを確認します。</p>
                        
                        <h6>動作確認</h6>
                        <ol>
                            <li>開発サーバー起動: <code>python manage.py runserver</code></li>
                            <li>http://127.0.0.1:8000/ でユーザー一覧を確認</li>
                            <li>新規ユーザー登録をテスト</li>
                            <li>ユーザー詳細表示を確認</li>
                            <li>ユーザー情報の編集をテスト</li>
                            <li>検索機能をテスト</li>
                            <li>ページネーションをテスト</li>
                            <li>ユーザー削除をテスト</li>
                        </ol>
                        
                        <h6>期待される結果</h6>
                        <div class="alert alert-success">
                            <p>フル機能のCRUDアプリケーションが完成し、すべての操作が正常に動作する</p>
                        </div>
                    </div>

                    <div class="quiz-container">
                        <h5>ステップ完了チェック</h5>
                        <ul class="list-unstyled">
                            <li>☐ すべてのテンプレートが作成されている</li>
                            <li>☐ カスタムフォームが実装されている</li>
                            <li>☐ ユーザーの作成・詳細・編集・削除が動作する</li>
                            <li>☐ 検索・ソート機能が動作する</li>
                            <li>☐ ページネーションが正常に機能する</li>
                            <li>☐ フォームバリデーションが適切に動作する</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="step6-admin-interface.html" class="btn btn-secondary">← 前のステップ: 管理サイト</a>
                        <a href="step8-validation-security.html" class="btn btn-primary">次のステップ: バリデーション・セキュリティ →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="bg-dark text-white mt-5">
        <div class="container-fluid py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2025 F-Circle. All rights reserved.<br>
本資料はAIツールを活用し、人間による編集・監修のもと作成されています。無断転載・再配布を禁じます。</p>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'default' });</script>
</body>
</html>