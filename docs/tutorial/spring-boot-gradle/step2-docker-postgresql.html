<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot + Gradle チュートリアル Step 2 - DockerでPostgreSQL環境構築</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #4caf50;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #4caf50;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #4caf50;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #66bb6a;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #4caf50;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #4caf50 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Spring Boot + Gradle チュートリアル</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">
                                Step 1: 環境構築
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step2-docker-postgresql.html">
                                Step 2: PostgreSQL環境
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-spring-mvc-web.html">
                                Step 3: Webコントローラー
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-spring-data-jpa.html">
                                Step 4: データベースアクセス
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-registration.html">
                                Step 5: ユーザー登録機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-thymeleaf-ui.html">
                                Step 6: 画面実装
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-user-list-detail.html">
                                Step 7: 一覧・詳細機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step8-user-update-delete.html">
                                Step 8: 更新・削除機能
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step9-security-error.html">
                                Step 9: セキュリティ基礎
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step10-deployment.html">
                                Step 10: デプロイメント
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 2: DockerでPostgreSQL環境構築</h1>
                </div>

                <div id="step2">
                    <h2 class="chapter-title">DockerでPostgreSQL環境構築</h2>
                    
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>Docker Composeファイルの作成</li>
                            <li>PostgreSQLコンテナの起動と管理</li>
                            <li>pgAdminコンテナの設定と接続</li>
                            <li>データベースとスキーマの作成</li>
                            <li>永続化ボリュームの設定</li>
                            <li>Spring Bootからの接続設定</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.1 Docker Composeとは</h3>
                    <p>Docker Composeは、複数のDockerコンテナを定義・実行するためのツールです。YAMLファイルで設定を記述し、一つのコマンドで複数のサービスを起動できます。</p>

                    <div class="exercise-container">
                        <h5>実習 2-1: Docker Composeファイルの作成</h5>
                        <p>PostgreSQLとpgAdminを含むDocker Compose設定を作成します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>プロジェクトのルートディレクトリに<code>docker-compose.yml</code>ファイルを作成</li>
                            <li>以下の設定を記述：</li>
                        </ol>
                        <h6>docker-compose.yml</h6>
                        <pre class="code-block"><code class="language-yaml">version: '3.8'

services:
  # PostgreSQLデータベース
  postgres:
    image: postgres:15
    container_name: user-management-db
    environment:
      POSTGRES_DB: userdb
      POSTGRES_USER: dbuser
      POSTGRES_PASSWORD: dbpass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - user-management-network

  # pgAdmin（データベース管理ツール）
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: user-management-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "8081:80"
    depends_on:
      - postgres
    networks:
      - user-management-network

volumes:
  postgres_data:

networks:
  user-management-network:
    driver: bridge</code></pre>
                        <h6>設定の説明</h6>
                        <ul>
                            <li><strong>postgres:</strong> PostgreSQL 15のコンテナ</li>
                            <li><strong>pgadmin:</strong> Web上でデータベースを管理できるツール</li>
                            <li><strong>volumes:</strong> データを永続化するための設定</li>
                            <li><strong>networks:</strong> コンテナ間通信のためのネットワーク</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.2 初期データベーススキーマの作成</h3>
                    <p>データベース起動時に実行される初期化SQLファイルを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-2: 初期化SQLファイルの作成</h5>
                        <p>データベースとテーブルを作成するSQLファイルを準備します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>プロジェクトのルートディレクトリに<code>init.sql</code>ファイルを作成</li>
                            <li>以下のSQLを記述：</li>
                        </ol>
                        <h6>init.sql</h6>
                        <pre class="code-block"><code class="language-sql">-- データベースの作成（既に存在する場合は省略）
-- CREATE DATABASE userdb;

-- ユーザーテーブルの作成
CREATE TABLE IF NOT EXISTS users (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- サンプルデータの挿入
INSERT INTO users (name, email, password) VALUES
('田中太郎', 'tanaka@example.com', 'password123'),
('佐藤花子', 'sato@example.com', 'password456'),
('山田次郎', 'yamada@example.com', 'password789')
ON CONFLICT (email) DO NOTHING;

-- 確認用のクエリ
SELECT * FROM users;</code></pre>
                        <h6>SQLの説明</h6>
                        <ul>
                            <li><strong>BIGSERIAL:</strong> 自動増分のID</li>
                            <li><strong>VARCHAR:</strong> 可変長文字列</li>
                            <li><strong>UNIQUE:</strong> 重複を許さない制約</li>
                            <li><strong>TIMESTAMP:</strong> 日時データ</li>
                            <li><strong>ON CONFLICT DO NOTHING:</strong> 重複時は無視</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.3 Dockerコンテナの起動と確認</h3>
                    <p>作成したDocker Compose設定を使用してPostgreSQLとpgAdminを起動します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-3: コンテナの起動</h5>
                        <p>Docker Composeを使用してデータベース環境を起動します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>VS Codeのターミナルでプロジェクトルートに移動</li>
                            <li>以下のコマンドでコンテナを起動：</li>
                        </ol>
                        <h6>起動コマンド</h6>
                        <pre class="code-block"><code class="language-bash"># バックグラウンドでコンテナを起動
docker-compose up -d

# コンテナの状態確認
docker-compose ps</code></pre>
                        <h6>期待される結果</h6>
                        <pre class="code-block"><code class="language-bash">Name                        Command                State           Ports
--------------------------------------------------------------------------------
user-management-db          docker-entrypoint.sh postgres   Up      0.0.0.0:5432->5432/tcp
user-management-pgadmin     /entrypoint.sh                   Up      0.0.0.0:8081->80/tcp</code></pre>
                        <h6>ログの確認</h6>
                        <pre class="code-block"><code class="language-bash"># PostgreSQLのログを確認
docker-compose logs postgres

# 全サービスのログを確認
docker-compose logs</code></pre>
                    </div>

                    <h3 class="section-title">2.4 pgAdminでの接続確認</h3>
                    <p>pgAdminを使用してPostgreSQLデータベースに接続し、データを確認します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-4: pgAdminでのデータベース接続</h5>
                        <p>ブラウザからpgAdminにアクセスしてデータベースを確認します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>ブラウザで <a href="http://localhost:8081" target="_blank">http://localhost:8081</a> にアクセス</li>
                            <li>ログイン情報を入力：
                                <ul>
                                    <li><strong>Email:</strong> admin@example.com</li>
                                    <li><strong>Password:</strong> admin123</li>
                                </ul>
                            </li>
                            <li>「Add New Server」をクリック</li>
                            <li>「General」タブで以下を設定：
                                <ul>
                                    <li><strong>Name:</strong> UserManagementDB</li>
                                </ul>
                            </li>
                            <li>「Connection」タブで以下を設定：
                                <ul>
                                    <li><strong>Host name/address:</strong> postgres</li>
                                    <li><strong>Port:</strong> 5432</li>
                                    <li><strong>Maintenance database:</strong> userdb</li>
                                    <li><strong>Username:</strong> dbuser</li>
                                    <li><strong>Password:</strong> dbpass</li>
                                </ul>
                            </li>
                            <li>「Save」をクリックして接続</li>
                        </ol>
                        <h6>データの確認</h6>
                        <ol>
                            <li>左側のツリーで「UserManagementDB」→「Databases」→「userdb」→「Schemas」→「public」→「Tables」→「users」を展開</li>
                            <li>「users」テーブルを右クリックして「View/Edit Data」→「All Rows」を選択</li>
                            <li>サンプルデータが3件表示されることを確認</li>
                        </ol>
                    </div>

                    <h3 class="section-title">2.5 Spring Bootからの接続設定</h3>
                    <p>Spring BootアプリケーションからPostgreSQLに接続するための設定を行います。</p>

                    <div class="exercise-container">
                        <h5>実習 2-5: application.propertiesの設定</h5>
                        <p>データベース接続情報をSpring Bootの設定ファイルに記述します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li><code>src/main/resources/application.properties</code>を開く</li>
                            <li>以下の設定を追加：</li>
                        </ol>
                        <h6>application.properties</h6>
                        <pre class="code-block"><code class="language-ini"># データベース接続設定
spring.datasource.url=jdbc:postgresql://localhost:5432/userdb
spring.datasource.username=dbuser
spring.datasource.password=dbpass
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA/Hibernate設定
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect

# Thymeleaf設定
spring.thymeleaf.cache=false

# 開発ツール設定
spring.devtools.restart.enabled=true</code></pre>
                        <h6>設定の説明</h6>
                        <ul>
                            <li><strong>datasource.url:</strong> データベース接続URL</li>
                            <li><strong>hibernate.ddl-auto=update:</strong> テーブル構造を自動更新</li>
                            <li><strong>show-sql=true:</strong> 実行されるSQLをログに出力</li>
                            <li><strong>thymeleaf.cache=false:</strong> 開発中はテンプレートキャッシュを無効化</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.6 接続テストの実行</h3>
                    <p>Spring Bootアプリケーションからデータベースに正常に接続できることを確認します。</p>

                    <div class="exercise-container">
                        <h5>実習 2-6: データベース接続テスト</h5>
                        <p>簡単なエンティティクラスを作成してデータベース接続を確認します。</p>
                        <h6>手順</h6>
                        <ol>
                            <li>新しいファイルを作成：<code>src/main/java/com/example/usermanagement/User.java</code></li>
                            <li>以下のコードを記述：</li>
                        </ol>
                        <h6>User.java（簡易版）</h6>
                        <pre class="code-block"><code class="language-java">package com.example.usermanagement;

import jakarta.persistence.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private String email;
    private String password;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    // デフォルトコンストラクタ
    public User() {}
    
    // getterとsetter
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    
    public String getPassword() { return password; }
    public void setPassword(String password) { this.password = password; }
    
    public LocalDateTime getCreatedAt() { return createdAt; }
    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }
    
    public LocalDateTime getUpdatedAt() { return updatedAt; }
    public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
}</code></pre>
                        <h6>手順（続き）</h6>
                        <ol start="3">
                            <li>アプリケーションを起動：</li>
                        </ol>
                        <pre class="code-block"><code class="language-bash">./gradlew bootRun</code></pre>
                        <h6>期待される結果</h6>
                        <p>起動ログにHibernateのSQL文が表示され、データベースに正常に接続されていることが確認できます。</p>
                    </div>

                    <div class="warning">
                        <h5>トラブルシューティング</h5>
                        <ul>
                            <li><strong>ポート5432が既に使用されている場合:</strong> PostgreSQLが既にインストールされている可能性があります。docker-compose.ymlのポートを「5433:5432」に変更し、application.propertiesのURLも「localhost:5433」に変更してください。</li>
                            <li><strong>Docker Composeが見つからない場合:</strong> Docker Desktopが正しくインストールされているか確認してください。</li>
                            <li><strong>pgAdminにアクセスできない場合:</strong> ブラウザのキャッシュをクリアするか、プライベートウィンドウで試してください。</li>
                            <li><strong>接続エラーが発生する場合:</strong> ファイアウォールやセキュリティソフトがポートをブロックしていないか確認してください。</li>
                        </ul>
                    </div>

                    <h3 class="section-title">2.7 コンテナの管理コマンド</h3>
                    <p>開発中に使用する基本的なDockerコマンドを覚えておきましょう。</p>

                    <div class="highlight">
                        <h5>よく使用するDockerコマンド</h5>
                        <pre class="code-block"><code class="language-bash"># コンテナの起動
docker-compose up -d

# コンテナの停止
docker-compose down

# コンテナの状態確認
docker-compose ps

# ログの確認
docker-compose logs

# データベースコンテナに直接接続
docker exec -it user-management-db psql -U dbuser -d userdb

# コンテナの再起動
docker-compose restart

# ボリュームも含めて完全削除（データが消えます）
docker-compose down -v</code></pre>
                    </div>

                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li>Docker Composeファイルの標準的なファイル名は何ですか？</li>
                            <li>PostgreSQLのデフォルトポート番号は何番ですか？</li>
                            <li>JPAで自動増分IDを定義するアノテーションは何ですか？</li>
                            <li>「hibernate.ddl-auto=update」の設定の意味は何ですか？</li>
                            <li>Dockerコンテナをバックグラウンドで起動するオプションは何ですか？</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>docker-compose.yml</li>
                                <li>5432番</li>
                                <li>@GeneratedValue(strategy = GenerationType.IDENTITY)</li>
                                <li>エンティティクラスの変更に応じてテーブル構造を自動更新する</li>
                                <li>-d（デタッチモード）</li>
                            </ol>
                        </details>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="step1-environment-setup.html" class="btn btn-secondary">← 前の章 Step 1: 環境構築</a>
                        <a href="step3-spring-mvc-web.html" class="btn btn-primary">次の章 → Step 3: Webコントローラー</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>