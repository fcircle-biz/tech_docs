<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP.NET(VB) 実践チュートリアル Step 3 - ユーザー登録機能の実装</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ベースレイアウト */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }

        /* ナビゲーション - ASP.NET系テーマ */
        .navbar {
            background-color: #1976d2;
        }

        .navbar-brand, .navbar-nav .nav-link {
            color: white !important;
            font-weight: 500;
        }

        .navbar-nav .nav-link:hover {
            color: #bbdefb !important;
        }

        /* サイドバー */
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }

        .sidebar .nav-link {
            color: #495057;
            font-weight: 500;
        }

        .sidebar .nav-link:hover {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .sidebar .nav-link.active {
            background-color: #1976d2 !important;
            color: white !important;
        }

        /* タイトル */
        .chapter-title {
            color: #1976d2;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 0.5rem;
        }

        .section-title {
            color: #42a5f5;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }

        /* コンテンツボックス */
        .quiz-container {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #1976d2;
        }

        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }

        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }

        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .info {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
        }

        /* コードブロック */
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .step-number {
            background-color: #1976d2;
            color: white;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ASP.NET VB チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="README.md">チュートリアルTOP</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        チュートリアル目次
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 環境構築とASP.NET基礎</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-database-connection.html">Step 2: データベース設計と接続</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step3-user-registration.html">Step 3: ユーザー登録機能</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-list-detail.html">Step 4: ユーザー一覧・詳細表示</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-update-delete.html">Step 5: ユーザー更新・削除</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-testing-debug.html">Step 6: 動作確認とデバッグ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 3: ユーザー登録機能の実装</h1>
                    <div class="badge bg-primary">所要時間: 2.5時間</div>
                </div>

                <div id="step3">
                    <h2 class="chapter-title">Web Formsによるユーザー登録システムの構築</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>このステップで学ぶこと</h5>
                        <ul>
                            <li>ASP.NET サーバーコントロール（TextBox、Button、Label等）の活用</li>
                            <li>ポストバック処理とイベントドリブン開発</li>
                            <li>ASP.NETバリデーションコントロールによる入力検証</li>
                            <li>UserDAOクラスの拡張（INSERT処理の実装）</li>
                            <li>マスターページによる共通レイアウトの作成</li>
                            <li>Response.Redirectによるページ遷移</li>
                            <li>Server.HtmlEncodeによるXSS対策</li>
                            <li>例外処理とユーザーフレンドリーなエラー表示</li>
                        </ul>
                    </div>

                    <h3 class="section-title">3.1 Web.config設定（必須）</h3>
                    <p>ASP.NET Web Formsでバリデーションコントロールを使用する前に、Web.configファイルに必要な設定を追加します。</p>
                    
                    <!-- 実習0 -->
                    <div class="exercise-container">
                        <h5>実習 3-0: Web.configファイルの設定</h5>
                        <p>ASP.NETバリデーションコントロールを正常に動作させるため、Web.configに必要な設定を追加します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>ソリューションエクスプローラーでプロジェクトルートの「Web.config」ファイルを開く</li>
                            <li>&lt;appSettings&gt;セクションを探し、以下の設定を追加する</li>
                            <li>既に&lt;appSettings&gt;セクションが存在しない場合は、&lt;configuration&gt;タグ内に作成する</li>
                        </ol>
                        
                        <h6>Web.config修正例</h6>
                        <pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;configuration&gt;
  &lt;connectionStrings&gt;
    &lt;add name="DefaultConnection" 
         connectionString="Server=(localdb)\MSSQLLocalDB;Database=UserManagementDB;Integrated Security=true;" 
         providerName="System.Data.SqlClient" /&gt;
  &lt;/connectionStrings&gt;
  
  &lt;appSettings&gt;
    &lt;add key="DatabaseConnectionTimeout" value="30" /&gt;
    &lt;add key="EnableDatabaseLogging" value="true" /&gt;
    &lt;add key="vs:EnableBrowserLink" value="false" /&gt;
    &lt;add key="ValidationSettings:UnobtrusiveValidationMode" value="None" /&gt;
  &lt;/appSettings&gt;
  
  &lt;system.web&gt;
    &lt;compilation debug="true" targetFramework="4.8" /&gt;
    &lt;httpRuntime targetFramework="4.8" /&gt;
  &lt;/system.web&gt;
&lt;/configuration&gt;</code></pre>
                        
                        <h6>期待される結果</h6>
                        <ul>
                            <li>Web.configファイルが正常に保存される</li>
                            <li>ASP.NETバリデーションコントロールがエラーなく動作する</li>
                            <li>jQueryへの依存なしでバリデーション機能が使用できる</li>
                        </ul>
                        
                        <div class="warning">
                            <h6>⚠️ 重要：この設定は必須です</h6>
                            <p><strong>ValidationSettings:UnobtrusiveValidationMode</strong>を設定しないと、バリデーションコントロール使用時に「jquery の ScriptResourceMapping が必要です」というエラーが発生します。</p>
                        </div>
                        
                        <div class="info">
                            <h6>💡 SQL Server LocalDBの管理コマンド</h6>
                            <p>データベース接続でエラーが発生した場合、以下のコマンドでLocalDBを管理できます：</p>
                            <pre><code># LocalDBインスタンスの状態確認
sqllocaldb info MSSQLLocalDB

# LocalDBインスタンスの停止
sqllocaldb stop MSSQLLocalDB

# LocalDBインスタンスの開始
sqllocaldb start MSSQLLocalDB

# LocalDBインスタンスの再起動（停止→開始）
sqllocaldb stop MSSQLLocalDB
sqllocaldb start MSSQLLocalDB</code></pre>
                            <p><strong>使用場面：</strong> データベース接続エラーやタイムアウトが発生した場合に実行してください。</p>
                        </div>
                    </div>

                    <h3 class="section-title">3.2 UserDAOクラスの拡張（INSERT処理）</h3>
                    <p>ユーザー登録機能に必要なINSERT処理をUserDAOクラスに追加します。</p>
                    
                    <!-- 実習1 -->
                    <div class="exercise-container">
                        <h5>実習 3-1: UserDAOクラスにユーザー登録機能を追加</h5>
                        <p>新規ユーザーをデータベースに登録するメソッドをUserDAOクラスに実装します。</p>
                        
                        <h6>App_Code/UserDAO.vb に追加するメソッド</h6>
                        <pre><code>''' &lt;summary&gt;
''' 新規ユーザーの登録
''' &lt;/summary&gt;
''' &lt;param name="user"&gt;登録するユーザー情報&lt;/param&gt;
''' &lt;returns&gt;登録されたユーザーID&lt;/returns&gt;
Public Shared Function InsertUser(user As User) As Integer
    Try
        Using connection As New SqlConnection(DatabaseConfig.GetConnectionString())
            connection.Open()
            
            Dim query As String = "
                INSERT INTO users (username, email, full_name, birth_date) 
                VALUES (@Username, @Email, @FullName, @BirthDate);
                SELECT SCOPE_IDENTITY();"
            
            Using command As New SqlCommand(query, connection)
                command.Parameters.AddWithValue("@Username", user.Username)
                command.Parameters.AddWithValue("@Email", user.Email)
                command.Parameters.AddWithValue("@FullName", user.FullName)
                
                If user.BirthDate.HasValue Then
                    command.Parameters.AddWithValue("@BirthDate", user.BirthDate.Value)
                Else
                    command.Parameters.AddWithValue("@BirthDate", DBNull.Value)
                End If
                
                Return CInt(command.ExecuteScalar())
            End Using
        End Using
        
    Catch ex As Exception
        Throw New Exception("ユーザーの登録に失敗しました。", ex)
    End Try
End Function



</code></pre>
                        
                        <h6>期待される結果</h6>
                        <ul>
                            <li>InsertUser()メソッドが正常にコンパイルされる</li>
                            <li>基本的なユーザー登録処理が動作する</li>
                            <li>データベースに新しいユーザーが挿入される</li>
                            <li>Using文によりSqlConnectionとSqlCommandが自動的にクローズされる</li>
                        </ul>
                        
                        <div class="info">
                            <h6>💡 Using文によるリソース管理</h6>
                            <p>VB.NETの<strong>Using文</strong>により、データベース接続が確実にクローズされます：</p>
                            <ul>
                                <li><strong>Using connection</strong>: SqlConnectionが自動的にクローズ・破棄される</li>
                                <li><strong>Using command</strong>: SqlCommandが自動的にクローズ・破棄される</li>
                                <li><strong>例外発生時</strong>: エラーが発生してもリソースは確実に解放される</li>
                                <li><strong>手動クローズ不要</strong>: connection.Close()の記述は不要</li>
                            </ul>
                            <p><strong>重要：</strong> Using文の使用により、データベース接続のリークを防ぎ、安全なリソース管理が実現されます。</p>
                        </div>
                    </div>

                    <h3 class="section-title">3.3 マスターページの作成</h3>
                    <p>共通レイアウトを管理するマスターページを作成し、統一されたデザインでページを構築します。</p>

                    <h4><span class="step-number">1</span>Visual Studioでのマスターページ作成手順</h4>
                    <ol>
                        <li><strong>既存のSite.Masterがある場合</strong>
                            <ul>
                                <li>ソリューションエクスプローラーでSite.Masterファイルを探す</li>
                                <li>既にある場合は、そのファイルを編集して以下のコードに置き換える</li>
                            </ul>
                        </li>
                        <li><strong>Site.Masterが存在しない場合の作成手順</strong>
                            <ol type="a">
                                <li>ソリューションエクスプローラーでプロジェクト名を右クリック</li>
                                <li>「追加」→「新しい項目」を選択</li>
                                <li>左側で「Web」カテゴリを選択</li>
                                <li>「マスターページ」を選択</li>
                                <li>名前を「Site.Master」に設定</li>
                                <li>「追加」をクリック</li>
                            </ol>
                        </li>
                        <li><strong>ビルドアクションの確認</strong>
                            <ul>
                                <li>作成されたSite.Masterファイルを右クリック→「プロパティ」</li>
                                <li>「ビルドアクション」が「コンテンツ」になっていることを確認</li>
                            </ul>
                        </li>
                    </ol>

                    <h4><span class="step-number">2</span>Site.Masterファイルの編集</h4>
                    <p>作成または既存のSite.Masterファイルを以下のコードで更新します。</p>
                    <pre><code>&lt;%@ Master Language="VB" AutoEventWireup="false" CodeBehind="Site.master.vb" Inherits="UserManagementApp.SiteMaster" %&gt;

&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head runat="server"&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;
    &lt;title&gt;&lt;%: Page.Title %&gt; - ユーザー管理システム&lt;/title&gt;
    
    &lt;!-- Bootstrap 5 CDN --&gt;
    &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
    
    &lt;!-- Google Fonts --&gt;
    &lt;link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&amp;display=swap" rel="stylesheet"&gt;
    
    &lt;!-- カスタムCSS --&gt;
    &lt;style&gt;
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar-brand {
            font-weight: 700;
        }
        
        .main-content {
            min-height: calc(100vh - 120px);
            padding: 2rem 0;
        }
        
        .footer {
            background-color: #343a40;
            color: white;
            text-align: center;
            padding: 1rem 0;
            margin-top: auto;
        }
    &lt;/style&gt;
    
    &lt;asp:ContentPlaceHolder ID="head" runat="server"&gt;
    &lt;/asp:ContentPlaceHolder&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id="form1" runat="server"&gt;
        &lt;!-- ナビゲーションバー --&gt;
        &lt;nav class="navbar navbar-expand-lg navbar-dark bg-primary"&gt;
            &lt;div class="container"&gt;
                &lt;a class="navbar-brand" href="Default.aspx"&gt;ユーザー管理システム&lt;/a&gt;
                
                &lt;button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"&gt;
                    &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;
                &lt;/button&gt;
                
                &lt;div class="collapse navbar-collapse" id="navbarNav"&gt;
                    &lt;ul class="navbar-nav me-auto"&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;a class="nav-link" href="Default.aspx"&gt;ホーム&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;a class="nav-link" href="Users/Create.aspx"&gt;ユーザー登録&lt;/a&gt;
                        &lt;/li&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;a class="nav-link" href="Users/List.aspx"&gt;ユーザー一覧&lt;/a&gt;
                        &lt;/li&gt;
                    &lt;/ul&gt;
                    
                    &lt;ul class="navbar-nav"&gt;
                        &lt;li class="nav-item"&gt;
                            &lt;span class="navbar-text"&gt;
                                &lt;asp:Label ID="lblCurrentTime" runat="server"&gt;&lt;/asp:Label&gt;
                            &lt;/span&gt;
                        &lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/nav&gt;
        
        &lt;!-- メインコンテンツ --&gt;
        &lt;main class="main-content"&gt;
            &lt;div class="container"&gt;
                &lt;asp:ContentPlaceHolder ID="MainContent" runat="server"&gt;
                &lt;/asp:ContentPlaceHolder&gt;
            &lt;/div&gt;
        &lt;/main&gt;
        
        &lt;!-- フッター --&gt;
        &lt;footer class="footer"&gt;
            &lt;div class="container"&gt;
                &lt;p&gt;&amp;copy; 2024 ユーザー管理システム - ASP.NET VB.NET チュートリアル&lt;/p&gt;
            &lt;/div&gt;
        &lt;/footer&gt;
    &lt;/form&gt;
    
    &lt;!-- Bootstrap JavaScript --&gt;
    &lt;script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

                    <h4><span class="step-number">2</span>Site.Master.vb（コードビハインド）</h4>
                    <pre><code>Public Class SiteMaster
    Inherits System.Web.UI.MasterPage

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        ' 現在時刻を表示
        lblCurrentTime.Text = DateTime.Now.ToString("yyyy年MM月dd日 HH:mm")
    End Sub
End Class</code></pre>

                    <h3 class="section-title">3.4 ユーザー登録フォームの実装</h3>
                    <p>ASP.NETサーバーコントロールとバリデーションコントロールを使用したユーザー登録フォームを作成します。</p>

                    <!-- 実習2 -->
                    <div class="exercise-container">
                        <h5>実習 3-3: ユーザー登録フォームの作成</h5>
                        <p>Usersフォルダを作成し、ユーザー登録機能を実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li>プロジェクトにUsersフォルダを作成</li>
                            <li>Create.aspxファイルを作成</li>
                            <li>サーバーコントロールとバリデーションを実装</li>
                        </ol>
                        
                        <h6>Users/Create.aspx</h6>
                        <pre><code>&lt;%@ Page Title="ユーザー登録" Language="vb" MasterPageFile="~/Site.Master" AutoEventWireup="false" CodeBehind="Create.aspx.vb" Inherits="UserManagementApp.Create" %&gt;

&lt;asp:Content ID="Content1" ContentPlaceHolderID="head" runat="server"&gt;
&lt;/asp:Content&gt;

&lt;asp:Content ID="Content2" ContentPlaceHolderID="MainContent" runat="server"&gt;
    &lt;div class="row justify-content-center"&gt;
        &lt;div class="col-lg-8"&gt;
            &lt;div class="card shadow"&gt;
                &lt;div class="card-header bg-primary text-white"&gt;
                    &lt;h3 class="card-title mb-0"&gt;
                        &lt;i class="fas fa-user-plus"&gt;&lt;/i&gt; 新規ユーザー登録
                    &lt;/h3&gt;
                &lt;/div&gt;
                &lt;div class="card-body"&gt;
                    &lt;!-- エラー・成功メッセージ表示エリア --&gt;
                    &lt;asp:Panel ID="pnlMessages" runat="server" Visible="false"&gt;
                        &lt;asp:Label ID="lblMessage" runat="server" CssClass="alert d-block"&gt;&lt;/asp:Label&gt;
                    &lt;/asp:Panel&gt;
                    
                    &lt;!-- バリデーションサマリー --&gt;
                    &lt;asp:ValidationSummary ID="vsUserRegistration" runat="server" 
                                           CssClass="alert alert-danger" 
                                           HeaderText="以下のエラーを修正してください："
                                           DisplayMode="BulletList" /&gt;
                    
                    &lt;div class="row"&gt;
                        &lt;!-- ユーザー名 --&gt;
                        &lt;div class="col-md-6 mb-3"&gt;
                            &lt;label for="txtUsername" class="form-label"&gt;ユーザー名 &lt;span class="text-danger"&gt;*&lt;/span&gt;&lt;/label&gt;
                            &lt;asp:TextBox ID="txtUsername" runat="server" CssClass="form-control" 
                                         placeholder="半角英数字・アンダースコアのみ" MaxLength="50"&gt;&lt;/asp:TextBox&gt;
                            
                            &lt;asp:RequiredFieldValidator ID="rfvUsername" runat="server" 
                                                        ControlToValidate="txtUsername"
                                                        ErrorMessage="ユーザー名は必須です。"
                                                        CssClass="text-danger small"
                                                        Display="Dynamic" /&gt;
                            
                            &lt;asp:RegularExpressionValidator ID="revUsername" runat="server"
                                                            ControlToValidate="txtUsername"
                                                            ValidationExpression="^[a-zA-Z0-9_]{3,50}$"
                                                            ErrorMessage="ユーザー名は3～50文字の半角英数字・アンダースコアで入力してください。"
                                                            CssClass="text-danger small"
                                                            Display="Dynamic" /&gt;
                            
                        &lt;/div&gt;
                        
                        &lt;!-- メールアドレス --&gt;
                        &lt;div class="col-md-6 mb-3"&gt;
                            &lt;label for="txtEmail" class="form-label"&gt;メールアドレス &lt;span class="text-danger"&gt;*&lt;/span&gt;&lt;/label&gt;
                            &lt;asp:TextBox ID="txtEmail" runat="server" CssClass="form-control" 
                                         TextMode="Email" placeholder="例: user@example.com" MaxLength="100"&gt;&lt;/asp:TextBox&gt;
                            
                            &lt;asp:RequiredFieldValidator ID="rfvEmail" runat="server" 
                                                        ControlToValidate="txtEmail"
                                                        ErrorMessage="メールアドレスは必須です。"
                                                        CssClass="text-danger small"
                                                        Display="Dynamic" /&gt;
                            
                            &lt;asp:RegularExpressionValidator ID="revEmail" runat="server"
                                                            ControlToValidate="txtEmail"
                                                            ValidationExpression="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                                                            ErrorMessage="正しいメールアドレス形式で入力してください。"
                                                            CssClass="text-danger small"
                                                            Display="Dynamic" /&gt;
                            
                        &lt;/div&gt;
                    &lt;/div&gt;
                    
                    &lt;div class="row"&gt;
                        &lt;!-- 氏名 --&gt;
                        &lt;div class="col-md-6 mb-3"&gt;
                            &lt;label for="txtFullName" class="form-label"&gt;氏名 &lt;span class="text-danger"&gt;*&lt;/span&gt;&lt;/label&gt;
                            &lt;asp:TextBox ID="txtFullName" runat="server" CssClass="form-control" 
                                         placeholder="例: 山田太郎" MaxLength="100"&gt;&lt;/asp:TextBox&gt;
                            
                            &lt;asp:RequiredFieldValidator ID="rfvFullName" runat="server" 
                                                        ControlToValidate="txtFullName"
                                                        ErrorMessage="氏名は必須です。"
                                                        CssClass="text-danger small"
                                                        Display="Dynamic" /&gt;
                        &lt;/div&gt;
                        
                        &lt;!-- 生年月日 --&gt;
                        &lt;div class="col-md-6 mb-3"&gt;
                            &lt;label for="txtBirthDate" class="form-label"&gt;生年月日（任意）&lt;/label&gt;
                            &lt;asp:TextBox ID="txtBirthDate" runat="server" CssClass="form-control" 
                                         TextMode="Date"&gt;&lt;/asp:TextBox&gt;
                            
                        &lt;/div&gt;
                    &lt;/div&gt;
                    
                    &lt;!-- 操作ボタン --&gt;
                    &lt;div class="row"&gt;
                        &lt;div class="col-12"&gt;
                            &lt;hr /&gt;
                            &lt;div class="d-flex justify-content-between"&gt;
                                &lt;div&gt;
                                    &lt;asp:Button ID="btnRegister" runat="server" 
                                                Text="登録する" 
                                                CssClass="btn btn-primary btn-lg"
                                                OnClick="btnRegister_Click" /&gt;
                                    
                                    &lt;asp:Button ID="btnClear" runat="server" 
                                                Text="クリア" 
                                                CssClass="btn btn-secondary btn-lg ms-2"
                                                CausesValidation="false"
                                                OnClick="btnClear_Click" /&gt;
                                &lt;/div&gt;
                                
                                &lt;div&gt;
                                    &lt;a href="List.aspx" class="btn btn-outline-primary"&gt;ユーザー一覧へ&lt;/a&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/asp:Content&gt;</code></pre>
                        
                        <h6>Users/Create.aspx.vb</h6>
                        <pre><code>Public Class Create
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not IsPostBack Then
            ' 初期表示時の処理
            pnlMessages.Visible = False
            
            ' 日付の最大値を今日に設定
            txtBirthDate.Attributes("max") = DateTime.Today.ToString("yyyy-MM-dd")
        End If
    End Sub

    Protected Sub btnRegister_Click(sender As Object, e As EventArgs) Handles btnRegister.Click
        Try
            ' ページバリデーションの確認
            If Not Page.IsValid Then
                ShowMessage("入力内容に不備があります。エラーを確認してください。", "alert-warning")
                Return
            End If
            
            ' ユーザーオブジェクトの作成
            Dim newUser As New User() With {
                .Username = txtUsername.Text.Trim(),
                .Email = txtEmail.Text.Trim(),
                .FullName = txtFullName.Text.Trim(),
                .BirthDate = GetBirthDate()
            }
            
            
            ' データベースに登録
            Dim newUserId As Integer = UserDAO.InsertUser(newUser)
            
            ' 成功メッセージの表示
            ShowMessage($"ユーザー '{Server.HtmlEncode(newUser.FullName)}' を正常に登録しました。（ID: {newUserId}）", "alert-success")
            
            ' フォームのクリア
            ClearForm()
            
            ' 一覧ページへのリダイレクト（オプション）
            ' Response.Redirect("List.aspx")
            
        Catch ex As InvalidOperationException
            ' 業務ロジックエラー（重複など）
            ShowMessage($"登録エラー: {Server.HtmlEncode(ex.Message)}", "alert-warning")
            
        Catch ex As Exception
            ' システムエラー
            System.Diagnostics.Debug.WriteLine($"ユーザー登録エラー: {ex.Message}")
            ShowMessage("システムエラーが発生しました。しばらく時間をおいて再度お試しください。", "alert-danger")
        End Try
    End Sub

    Protected Sub btnClear_Click(sender As Object, e As EventArgs) Handles btnClear.Click
        ClearForm()
        pnlMessages.Visible = False
    End Sub



    Private Sub ShowMessage(message As String, cssClass As String)
        lblMessage.Text = message
        lblMessage.CssClass = $"alert {cssClass} d-block"
        pnlMessages.Visible = True
    End Sub

    Private Sub ClearForm()
        txtUsername.Text = ""
        txtEmail.Text = ""
        txtFullName.Text = ""
        txtBirthDate.Text = ""
    End Sub

    Private Function GetBirthDate() As Date?
        If String.IsNullOrEmpty(txtBirthDate.Text) Then
            Return Nothing
        End If
        
        Dim birthDate As Date
        If Date.TryParse(txtBirthDate.Text, birthDate) Then
            Return birthDate
        Else
            Return Nothing
        End If
    End Function
End Class</code></pre>
                        
                        <h6>期待される結果</h6>
                        <ul>
                            <li>マスターページを使用した統一されたレイアウト</li>
                            <li>入力フォームがBootstrapでスタイリングされている</li>
                            <li>クライアントサイド・サーバーサイド両方のバリデーション</li>
                            <li>重複チェック機能が動作する</li>
                            <li>登録成功時にメッセージが表示される</li>
                            <li>エラー処理が適切に実装されている</li>
                        </ul>
                    </div>

                    <div class="info">
                        <h6>💡 ASP.NET バリデーションコントロールの特徴</h6>
                        <ul>
                            <li><strong>RequiredFieldValidator:</strong> 必須入力チェック</li>
                            <li><strong>RegularExpressionValidator:</strong> 正規表現による形式チェック</li>
                            <li><strong>CompareValidator:</strong> 他の値や固定値との比較</li>
                            <li><strong>CustomValidator:</strong> カスタムロジックによるバリデーション</li>
                            <li><strong>ValidationSummary:</strong> エラーメッセージの一覧表示</li>
                        </ul>
                    </div>

                    <h3 class="section-title">3.5 動作確認とテスト</h3>
                    <p>実装したユーザー登録機能が正常に動作することを確認します。</p>


                    <!-- 理解度確認 -->
                    <div class="quiz-container">
                        <h5>ASP.NET・VB.NET理解度クイズ</h5>
                        <ol>
                            <li>ASP.NETでポストバック（PostBack）が発生するタイミングを2つ挙げてください。</li>
                            <li>VB.NETでButton_Clickイベントハンドラーを定義する構文を書いてください。</li>
                            <li>RequiredFieldValidatorコントロールの必須プロパティは何ですか？</li>
                            <li>Response.Redirectメソッドの用途を説明してください。</li>
                            <li>Server.HtmlEncodeメソッドを使用する理由を説明してください。</li>
                            <li>Page.IsValidプロパティの用途を説明してください。</li>
                        </ol>
                        <details>
                            <summary>解答例</summary>
                            <ol>
                                <li>サーバーコントロールのボタンクリック時、DropDownListの選択変更時（AutoPostBack=True）</li>
                                <li><code>Protected Sub btnRegister_Click(sender As Object, e As EventArgs) Handles btnRegister.Click</code></li>
                                <li>ControlToValidate（検証対象のコントロールID）</li>
                                <li>他のページへリダイレクト（転送）するため</li>
                                <li>XSS攻撃を防ぐため（HTMLの特殊文字をエスケープ）</li>
                                <li>ページ内の全バリデーションコントロールが有効かどうかを確認</li>
                            </ol>
                        </details>
                    </div>

                    <!-- ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step2-database-connection.html" class="btn btn-secondary">← 前のステップ</a>
                        <a href="step4-user-list-detail.html" class="btn btn-primary">次のステップ: ユーザー一覧・詳細表示 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>