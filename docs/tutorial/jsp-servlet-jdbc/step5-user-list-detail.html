<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSP/Servlet/JDBC 実践チュートリアル Step 5 - ユーザー一覧・詳細表示機能</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #f57c00;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e !important;
            color: #ffffff;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        .data-flow {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .data-step {
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            background-color: #e3f2fd;
            display: inline-block;
            min-width: 120px;
        }

        .flow-arrow {
            font-size: 1.5em;
            color: #666;
            margin: 0 10px;
        }

        .table-preview {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .table-preview table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        .table-preview th, .table-preview td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .table-preview th {
            background-color: #007bff;
            color: white;
        }

        .jsp-concept {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #4caf50;
        }

        .scriptlet-example {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">JSP/Servlet/JDBC 実践チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-nav-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="README.html">JSP/Servlet/JDBC</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>チュートリアル目次</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 開発環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-mvc-architecture.html">Step 2: MVC概要</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-database-jdbc.html">Step 3: DB・JDBC</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step4-user-registration.html">Step 4: ユーザー登録</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step5-user-list-detail.html">Step 5: 一覧・詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">Step 6: 更新・削除</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-search-finalization.html">Step 7: 検索・仕上げ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 5: ユーザー一覧・詳細表示機能</h1>
                </div>

                <div id="step5">
                    <h2 class="chapter-title">ユーザー一覧・詳細表示機能</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>UserDAOのfindAllメソッドを使用した全データ取得</li>
                            <li>JSPでのスクリプトレットを使用したテーブル表示</li>
                            <li>Servletからの複数データをJSPに渡す方法</li>
                            <li>ユーザー詳細画面での単一データの表示</li>
                            <li>GETパラメータによるIDの受け渡し</li>
                            <li>リンクを使用した画面間の遷移</li>
                        </ul>
                    </div>

                    <!-- データ表示の処理フロー -->
                    <h3 class="section-title">5.1 データ表示の処理フロー</h3>
                    <p>データベースからデータを取得し、JSPで表示するまでの処理フローを理解します。</p>

                    <div class="data-flow">
                        <h5>ユーザー一覧表示の処理フロー</h5>
                        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin: 20px 0;">
                            <div class="data-step">
                                <strong>1. リクエスト</strong><br>
                                <small>ブラウザ<br>GET /user-list</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="data-step">
                                <strong>2. データ取得</strong><br>
                                <small>Servlet<br>DAO.findAll()</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="data-step">
                                <strong>3. データ設定</strong><br>
                                <small>Servlet<br>request.setAttribute</small>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin: 20px 0;">
                            <div class="data-step">
                                <strong>4. JSP遷移</strong><br>
                                <small>Servlet<br>forward</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="data-step">
                                <strong>5. データ表示</strong><br>
                                <small>JSP<br>スクリプトレット</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="data-step">
                                <strong>6. HTML生成</strong><br>
                                <small>ブラウザ<br>テーブル表示</small>
                            </div>
                        </div>
                    </div>

                    <!-- ユーザー一覧Servletの作成 -->
                    <h3 class="section-title">5.2 ユーザー一覧Servletの作成</h3>
                    <p>データベースから全ユーザー情報を取得し、一覧表示用JSPに渡すServletを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-1: ユーザー一覧Servletの作成</h5>
                        <p>UserDAOを使用して全ユーザーデータを取得し、JSPに渡すServletを実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>controller</code> パッケージに新しいクラス <code>UserListServlet</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>UserListServlet.java</h6>
                        <pre class="code-block"><code class="language-java">package controller;

import java.io.IOException;
import java.sql.SQLException;
import java.util.List;

import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.User;
import model.UserDAO;

/**
 * ユーザー一覧表示Servlet
 * GET: ユーザー一覧の取得と表示
 * Controller層（MVCパターン）
 */
@WebServlet("/user-list")
public class UserListServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    
    private UserDAO userDAO = new UserDAO();

    /**
     * GETリクエスト: ユーザー一覧の表示
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        try {
            // データベースから全ユーザーを取得
            List&lt;User&gt; userList = userDAO.findAll();
            
            // ユーザー数も取得
            int userCount = userDAO.count();
            
            // 成功メッセージの取得（リダイレクト時のメッセージ）
            String message = request.getParameter("message");
            
            // リクエストスコープにデータを設定
            request.setAttribute("userList", userList);
            request.setAttribute("userCount", userCount);
            
            if (message != null && !message.trim().isEmpty()) {
                request.setAttribute("successMessage", message);
            }
            
            // 一覧表示用JSPにフォワード
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-list.jsp");
            dispatcher.forward(request, response);
            
        } catch (SQLException e) {
            // データベースエラーの場合
            request.setAttribute("errorMessage", "データベースエラーが発生しました: " + e.getMessage());
            
            // エラー表示用の空リストを設定
            request.setAttribute("userList", List.of());
            request.setAttribute("userCount", 0);
            
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-list.jsp");
            dispatcher.forward(request, response);
        }
    }
}</code></pre>
                    </div>

                    <!-- ユーザー一覧JSPの作成 -->
                    <h3 class="section-title">5.3 ユーザー一覧JSPの作成</h3>
                    <p>Servletから受け取ったユーザーリストをテーブル形式で表示するJSPを作成します。</p>

                    <div class="jsp-concept">
                        <h5>JSPでのリスト表示のポイント</h5>
                        <ul>
                            <li><strong>拡張for文</strong>: <code>for (User user : userList)</code> でリストをループ</li>
                            <li><strong>スクリプトレット</strong>: <code>&lt;% %&gt;</code> でJavaコードを実行</li>
                            <li><strong>式</strong>: <code>&lt;%= %&gt;</code> で値を出力</li>
                            <li><strong>条件分岐</strong>: <code>if</code> 文でデータの有無をチェック</li>
                            <li><strong>null チェック</strong>: データの存在確認を適切に行う</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 5-2: ユーザー一覧JSPの作成</h5>
                        <p>スクリプトレットを使用してユーザーデータをテーブル形式で表示するJSPを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>src/main/webapp/jsp</code> フォルダに新しいファイル <code>user-list.jsp</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>user-list.jsp</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;%@ page import="java.util.List" %&gt;
&lt;%@ page import="model.User" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ユーザー一覧 - Simple User Management System&lt;/title&gt;
    &lt;style&gt;
        body {
            font-family: 'Meiryo', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            display: inline-block;
        }
        .btn:hover {
            background-color: #0056b3;
            color: white;
            text-decoration: none;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-danger {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e9ecef;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        .info-box {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #bee5eb;
        }
        .actions {
            white-space: nowrap;
        }
        .actions a {
            margin-right: 5px;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;div class="header"&gt;
            &lt;h1&gt;ユーザー一覧&lt;/h1&gt;
            &lt;a href="../user-form" class="btn btn-success"&gt;新規ユーザー登録&lt;/a&gt;
        &lt;/div&gt;
        
        &lt;%
            // 成功メッセージの表示
            String successMessage = (String) request.getAttribute("successMessage");
            if (successMessage != null && !successMessage.isEmpty()) {
        %&gt;
        &lt;div class="success-message"&gt;
            &lt;%= successMessage %&gt;
        &lt;/div&gt;
        &lt;%
            }
            
            // エラーメッセージの表示
            String errorMessage = (String) request.getAttribute("errorMessage");
            if (errorMessage != null && !errorMessage.isEmpty()) {
        %&gt;
        &lt;div class="error-message"&gt;
            &lt;strong&gt;エラー:&lt;/strong&gt; &lt;%= errorMessage %&gt;
        &lt;/div&gt;
        &lt;%
            }
            
            // ユーザーリストとユーザー数の取得
            @SuppressWarnings("unchecked")
            List&lt;User&gt; userList = (List&lt;User&gt;) request.getAttribute("userList");
            Integer userCount = (Integer) request.getAttribute("userCount");
            
            if (userCount == null) userCount = 0;
        %&gt;
        
        &lt;div class="info-box"&gt;
            &lt;h4&gt;ユーザー管理情報&lt;/h4&gt;
            &lt;p&gt;&lt;strong&gt;登録ユーザー数:&lt;/strong&gt; &lt;%= userCount %&gt; 件&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;表示内容:&lt;/strong&gt; 全ユーザーの一覧（ID、ユーザー名、メールアドレス、氏名、登録日時）&lt;/p&gt;
        &lt;/div&gt;
        
        &lt;%
            // ユーザーリストの表示
            if (userList != null && !userList.isEmpty()) {
        %&gt;
        &lt;table&gt;
            &lt;thead&gt;
                &lt;tr&gt;
                    &lt;th&gt;ID&lt;/th&gt;
                    &lt;th&gt;ユーザー名&lt;/th&gt;
                    &lt;th&gt;メールアドレス&lt;/th&gt;
                    &lt;th&gt;氏名&lt;/th&gt;
                    &lt;th&gt;登録日時&lt;/th&gt;
                    &lt;th&gt;操作&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
                &lt;%
                    // スクリプトレットでリストをループ処理
                    for (User user : userList) {
                %&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;%= user.getId() %&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;%= user.getUsername() %&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;%= user.getEmail() %&gt;&lt;/td&gt;
                    &lt;td&gt;
                        &lt;%
                            // 氏名のnullチェック
                            String fullName = user.getFullName();
                            if (fullName != null && !fullName.trim().isEmpty()) {
                        %&gt;
                            &lt;%= fullName %&gt;
                        &lt;%
                            } else {
                        %&gt;
                            &lt;span style="color: #6c757d;"&gt;（未設定）&lt;/span&gt;
                        &lt;%
                            }
                        %&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                        &lt;%
                            // 作成日時の表示（日時フォーマット）
                            if (user.getCreatedAt() != null) {
                                java.text.SimpleDateFormat sdf = new java.text.SimpleDateFormat("yyyy/MM/dd HH:mm");
                        %&gt;
                            &lt;%= sdf.format(user.getCreatedAt()) %&gt;
                        &lt;%
                            } else {
                        %&gt;
                            &lt;span style="color: #6c757d;"&gt;（不明）&lt;/span&gt;
                        &lt;%
                            }
                        %&gt;
                    &lt;/td&gt;
                    &lt;td class="actions"&gt;
                        &lt;a href="../user-detail?id=&lt;%= user.getId() %&gt;" class="btn" style="font-size: 12px; padding: 5px 10px;"&gt;詳細&lt;/a&gt;
                        &lt;a href="../user-edit?id=&lt;%= user.getId() %&gt;" class="btn" style="font-size: 12px; padding: 5px 10px; background-color: #ffc107; color: #212529;"&gt;編集&lt;/a&gt;
                        &lt;a href="../user-delete?id=&lt;%= user.getId() %&gt;" class="btn btn-danger" 
                           onclick="return confirm('ユーザー「&lt;%= user.getFullName() != null ? user.getFullName() : user.getUsername() %&gt;」を削除しますか？')"&gt;削除&lt;/a&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;%
                    }
                %&gt;
            &lt;/tbody&gt;
        &lt;/table&gt;
        &lt;%
            } else {
        %&gt;
        &lt;div class="no-data"&gt;
            &lt;h3&gt;登録されたユーザーがありません&lt;/h3&gt;
            &lt;p&gt;「新規ユーザー登録」ボタンから最初のユーザーを登録してください。&lt;/p&gt;
        &lt;/div&gt;
        &lt;%
            }
        %&gt;
        
        &lt;hr&gt;
        &lt;p&gt;
            &lt;a href="../user-form" class="btn"&gt;新規ユーザー登録&lt;/a&gt; | 
            &lt;a href="../user-test" class="btn"&gt;テストページ&lt;/a&gt; | 
            &lt;a href="../index.jsp" class="btn"&gt;トップページ&lt;/a&gt;
        &lt;/p&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <!-- ユーザー詳細Servletの作成 -->
                    <h3 class="section-title">5.4 ユーザー詳細Servletの作成</h3>
                    <p>IDをパラメータとして受け取り、特定のユーザー情報を表示するServletを作成します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-3: ユーザー詳細Servletの作成</h5>
                        <p>GETパラメータでIDを受け取り、該当ユーザーの詳細情報を表示するServletを実装します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>controller</code> パッケージに新しいクラス <code>UserDetailServlet</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>UserDetailServlet.java</h6>
                        <pre class="code-block"><code class="language-java">package controller;

import java.io.IOException;
import java.sql.SQLException;

import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.User;
import model.UserDAO;

/**
 * ユーザー詳細表示Servlet
 * GET: 指定されたIDのユーザー詳細情報を表示
 * Controller層（MVCパターン）
 */
@WebServlet("/user-detail")
public class UserDetailServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    
    private UserDAO userDAO = new UserDAO();

    /**
     * GETリクエスト: ユーザー詳細の表示
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // IDパラメータの取得
        String idParam = request.getParameter("id");
        
        // IDパラメータの検証
        if (idParam == null || idParam.trim().isEmpty()) {
            request.setAttribute("errorMessage", "ユーザーIDが指定されていません。");
            request.setAttribute("user", null);
            
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-detail.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        int userId;
        try {
            userId = Integer.parseInt(idParam);
        } catch (NumberFormatException e) {
            request.setAttribute("errorMessage", "無効なユーザーIDです: " + idParam);
            request.setAttribute("user", null);
            
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-detail.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        try {
            // 指定されたIDのユーザーを取得
            User user = userDAO.findById(userId);
            
            if (user != null) {
                // ユーザーが見つかった場合
                request.setAttribute("user", user);
                request.setAttribute("successMessage", "ユーザー情報を取得しました。");
            } else {
                // ユーザーが見つからなかった場合
                request.setAttribute("errorMessage", "ID " + userId + " のユーザーが見つかりません。");
                request.setAttribute("user", null);
            }
            
            // 詳細表示用JSPにフォワード
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-detail.jsp");
            dispatcher.forward(request, response);
            
        } catch (SQLException e) {
            // データベースエラーの場合
            request.setAttribute("errorMessage", "データベースエラーが発生しました: " + e.getMessage());
            request.setAttribute("user", null);
            
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-detail.jsp");
            dispatcher.forward(request, response);
        }
    }
}</code></pre>
                    </div>

                    <!-- ユーザー詳細JSPの作成 -->
                    <h3 class="section-title">5.5 ユーザー詳細JSPの作成</h3>
                    <p>単一のユーザー情報を詳細に表示するJSPを作成します。</p>

                    <div class="scriptlet-example">
                        <h5>ユーザー詳細画面でのスクリプトレット活用例</h5>
                        <ul>
                            <li><strong>null チェック</strong>: <code>if (user != null)</code> でデータ存在確認</li>
                            <li><strong>条件付き表示</strong>: データがある場合のみ詳細情報を表示</li>
                            <li><strong>日時フォーマット</strong>: SimpleDateFormat でタイムスタンプを整形</li>
                            <li><strong>文字列処理</strong>: 空文字やnullの場合の代替表示</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 5-4: ユーザー詳細JSPの作成</h5>
                        <p>単一ユーザーの詳細情報を見やすく表示するJSPを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>src/main/webapp/jsp</code> フォルダに新しいファイル <code>user-detail.jsp</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>user-detail.jsp</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;%@ page import="model.User" %&gt;
&lt;%@ page import="java.text.SimpleDateFormat" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ユーザー詳細 - Simple User Management System&lt;/title&gt;
    &lt;style&gt;
        body {
            font-family: 'Meiryo', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            display: inline-block;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
            color: white;
            text-decoration: none;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .user-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #dee2e6;
        }
        .info-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        .info-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .info-label {
            font-weight: bold;
            color: #495057;
            display: block;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 16px;
            color: #212529;
            background-color: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
            text-align: center;
        }
        .user-stats {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #bee5eb;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;div class="header"&gt;
            &lt;h1&gt;ユーザー詳細情報&lt;/h1&gt;
            &lt;a href="../user-list" class="btn btn-secondary"&gt;一覧に戻る&lt;/a&gt;
        &lt;/div&gt;
        
        &lt;%
            // 成功メッセージの表示
            String successMessage = (String) request.getAttribute("successMessage");
            if (successMessage != null && !successMessage.isEmpty()) {
        %&gt;
        &lt;div class="success-message"&gt;
            &lt;%= successMessage %&gt;
        &lt;/div&gt;
        &lt;%
            }
            
            // エラーメッセージの表示
            String errorMessage = (String) request.getAttribute("errorMessage");
            if (errorMessage != null && !errorMessage.isEmpty()) {
        %&gt;
        &lt;div class="error-message"&gt;
            &lt;strong&gt;エラー:&lt;/strong&gt; &lt;%= errorMessage %&gt;
        &lt;/div&gt;
        &lt;%
            }
            
            // ユーザー情報の取得
            User user = (User) request.getAttribute("user");
            
            if (user != null) {
        %&gt;
        &lt;div class="user-stats"&gt;
            &lt;h4&gt;ユーザー詳細情報&lt;/h4&gt;
            &lt;p&gt;&lt;strong&gt;ユーザーID:&lt;/strong&gt; &lt;%= user.getId() %&gt; の詳細情報を表示しています。&lt;/p&gt;
        &lt;/div&gt;
        
        &lt;div class="user-info"&gt;
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;ユーザーID&lt;/span&gt;
                &lt;div class="info-value"&gt;&lt;%= user.getId() %&gt;&lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;ユーザー名&lt;/span&gt;
                &lt;div class="info-value"&gt;&lt;%= user.getUsername() %&gt;&lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;メールアドレス&lt;/span&gt;
                &lt;div class="info-value"&gt;&lt;%= user.getEmail() %&gt;&lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;氏名&lt;/span&gt;
                &lt;div class="info-value"&gt;
                    &lt;%
                        String fullName = user.getFullName();
                        if (fullName != null && !fullName.trim().isEmpty()) {
                    %&gt;
                        &lt;%= fullName %&gt;
                    &lt;%
                        } else {
                    %&gt;
                        &lt;span style="color: #6c757d; font-style: italic;"&gt;（未設定）&lt;/span&gt;
                    &lt;%
                        }
                    %&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;登録日時&lt;/span&gt;
                &lt;div class="info-value"&gt;
                    &lt;%
                        if (user.getCreatedAt() != null) {
                            SimpleDateFormat sdf = new SimpleDateFormat("yyyy年MM月dd日 HH時mm分ss秒");
                    %&gt;
                        &lt;%= sdf.format(user.getCreatedAt()) %&gt;
                    &lt;%
                        } else {
                    %&gt;
                        &lt;span style="color: #6c757d; font-style: italic;"&gt;（不明）&lt;/span&gt;
                    &lt;%
                        }
                    %&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            
            &lt;div class="info-group"&gt;
                &lt;span class="info-label"&gt;最終更新日時&lt;/span&gt;
                &lt;div class="info-value"&gt;
                    &lt;%
                        if (user.getUpdatedAt() != null) {
                            SimpleDateFormat sdf = new SimpleDateFormat("yyyy年MM月dd日 HH時mm分ss秒");
                    %&gt;
                        &lt;%= sdf.format(user.getUpdatedAt()) %&gt;
                    &lt;%
                        } else {
                    %&gt;
                        &lt;span style="color: #6c757d; font-style: italic;"&gt;（不明）&lt;/span&gt;
                    &lt;%
                        }
                    %&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div class="actions"&gt;
            &lt;a href="../user-edit?id=&lt;%= user.getId() %&gt;" class="btn btn-warning"&gt;編集&lt;/a&gt;
            &lt;a href="../user-delete?id=&lt;%= user.getId() %&gt;" class="btn btn-danger" 
               onclick="return confirm('ユーザー「&lt;%= user.getFullName() != null ? user.getFullName() : user.getUsername() %&gt;」を削除しますか？')"&gt;削除&lt;/a&gt;
            &lt;a href="../user-list" class="btn btn-secondary"&gt;一覧に戻る&lt;/a&gt;
        &lt;/div&gt;
        
        &lt;%
            } else {
        %&gt;
        &lt;div class="no-data"&gt;
            &lt;h3&gt;ユーザー情報が見つかりません&lt;/h3&gt;
            &lt;p&gt;指定されたユーザーIDのユーザーが存在しないか、削除された可能性があります。&lt;/p&gt;
            &lt;a href="../user-list" class="btn"&gt;ユーザー一覧に戻る&lt;/a&gt;
        &lt;/div&gt;
        &lt;%
            }
        %&gt;
        
        &lt;hr&gt;
        &lt;p&gt;
            &lt;a href="../user-list" class="btn"&gt;ユーザー一覧&lt;/a&gt; | 
            &lt;a href="../user-form" class="btn"&gt;新規ユーザー登録&lt;/a&gt; | 
            &lt;a href="../index.jsp" class="btn"&gt;トップページ&lt;/a&gt;
        &lt;/p&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <!-- 動作確認 -->
                    <h3 class="section-title">5.6 一覧・詳細機能の動作確認</h3>
                    <p>作成したユーザー一覧・詳細表示機能が正常に動作することを確認します。</p>

                    <div class="exercise-container">
                        <h5>実習 5-5: 一覧・詳細機能の動作確認</h5>
                        <p>様々なケースで一覧・詳細表示機能をテストし、正常に動作することを確認します。</p>
                        
                        <h6>動作確認手順</h6>
                        <ol>
                            <li><strong>ユーザー一覧の確認</strong>
                                <ul>
                                    <li>ブラウザで <code>http://localhost:8080/SimpleUserManagementSystem/user-list</code> にアクセス</li>
                                    <li>登録済みユーザー（サンプルデータ + Step 4で登録したデータ）が表示されることを確認</li>
                                    <li>テーブル形式で以下の項目が表示されることを確認：
                                        <ul>
                                            <li>ID、ユーザー名、メールアドレス、氏名、登録日時</li>
                                            <li>各行に「詳細」「編集」「削除」ボタン</li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            
                            <li><strong>ユーザー詳細の確認</strong>
                                <ul>
                                    <li>一覧画面から任意のユーザーの「詳細」ボタンをクリック</li>
                                    <li>ユーザー詳細画面が表示されることを確認</li>
                                    <li>以下の情報が適切に表示されることを確認：
                                        <ul>
                                            <li>ユーザーID、ユーザー名、メールアドレス、氏名</li>
                                            <li>登録日時、最終更新日時（フォーマット済み）</li>
                                            <li>編集・削除・一覧戻りボタン</li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            
                            <li><strong>パラメータエラーのテスト</strong>
                                <ul>
                                    <li>ブラウザで <code>http://localhost:8080/SimpleUserManagementSystem/user-detail?id=999</code> にアクセス</li>
                                    <li>存在しないIDのエラーメッセージが表示されることを確認</li>
                                    <li>ブラウザで <code>http://localhost:8080/SimpleUserManagementSystem/user-detail?id=abc</code> にアクセス</li>
                                    <li>無効なIDのエラーメッセージが表示されることを確認</li>
                                </ul>
                            </li>
                            
                            <li><strong>画面遷移の確認</strong>
                                <ul>
                                    <li>詳細画面から「一覧に戻る」ボタンで一覧画面に戻れることを確認</li>
                                    <li>一覧画面から「新規ユーザー登録」ボタンで登録フォームに遷移できることを確認</li>
                                    <li>登録後の成功メッセージが一覧画面で表示されることを確認</li>
                                </ul>
                            </li>
                        </ol>

                        <h6>期待される結果</h6>
                        <ul>
                            <li>ユーザー一覧がテーブル形式で見やすく表示される</li>
                            <li>日時が読みやすい形式でフォーマットされる</li>
                            <li>null値や空文字が適切に処理される</li>
                            <li>エラー時に適切なメッセージが表示される</li>
                            <li>画面間の遷移がスムーズに動作する</li>
                        </ul>
                    </div>

                    <!-- スクリプトレットのベストプラクティス -->
                    <div class="jsp-concept">
                        <h5>スクリプトレット使用時のベストプラクティス</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>推奨事項</h6>
                                <ul>
                                    <li>null チェックを確実に行う</li>
                                    <li>長い処理はServlet側で実行</li>
                                    <li>適切な例外処理を実装</li>
                                    <li>コメントで処理内容を明記</li>
                                    <li>コードの可読性を重視</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>注意点</h6>
                                <ul>
                                    <li>大量のJavaコードは避ける</li>
                                    <li>複雑なビジネスロジックは含めない</li>
                                    <li>データベースアクセスは行わない</li>
                                    <li>HTMLとJavaコードを適切に分離</li>
                                    <li>XSS攻撃に注意（サニタイズ）</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>ServletからJSPにリストデータを渡すために使用するメソッドは何ですか？</strong></li>
                            <li><strong>JSPでListをループ処理するスクリプトレットの記述方法を説明してください。</strong></li>
                            <li><strong>GETパラメータを取得するServletのメソッドは何ですか？</strong></li>
                            <li><strong>以下のJSPコードの問題点を指摘してください:</strong>
                                <pre><code>&lt;%= user.getFullName() %&gt;</code></pre>
                            </li>
                            <li><strong>ユーザー一覧画面でデータが存在しない場合の表示方法を説明してください。</strong></li>
                            <li><strong>日時データを見やすい形式で表示するために使用するJavaクラスは何ですか？</strong></li>
                        </ol>
                        
                        <details style="margin-top: 20px;">
                            <summary>解答例を表示</summary>
                            <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                <ol>
                                    <li>request.setAttribute(String name, Object value)</li>
                                    <li>&lt;% for (User user : userList) { %&gt; ～ &lt;% } %&gt; の形式で拡張for文を使用</li>
                                    <li>request.getParameter(String parameterName)</li>
                                    <li>nullチェックがないため、user.getFullName()がnullの場合にNullPointerExceptionが発生する可能性</li>
                                    <li>条件分岐でリストが空またはnullの場合を判定し、「データがありません」メッセージを表示</li>
                                    <li>java.text.SimpleDateFormat クラス</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">5.7 まとめ</h3>
                    <p>このステップでは、ユーザー一覧・詳細表示機能の実装を通じてデータ取得と表示の方法を学習しました：</p>
                    <ul>
                        <li><strong>データ取得</strong>: UserDAOのfindAll、findByIdメソッドによるデータベースアクセス</li>
                        <li><strong>リスト表示</strong>: スクリプトレットでの拡張for文によるテーブル生成</li>
                        <li><strong>データ渡し</strong>: ServletからJSPへのリクエストスコープでのデータ連携</li>
                        <li><strong>パラメータ処理</strong>: GETパラメータの取得と検証</li>
                        <li><strong>null処理</strong>: 適切なnullチェックと代替表示</li>
                        <li><strong>日時フォーマット</strong>: SimpleDateFormatによる見やすい日時表示</li>
                        <li><strong>エラー処理</strong>: 存在しないデータや不正パラメータの適切な処理</li>
                    </ul>
                    
                    <p>次のステップでは、ユーザー情報の更新・削除機能を実装し、CRUDのU（Update）とD（Delete）操作を学習します。</p>

                    <!-- ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step4-user-registration.html" class="btn btn-secondary">← 前の章: ユーザー登録機能の実装</a>
                        <a href="step6-user-update-delete.html" class="btn btn-primary">次の章: ユーザー更新・削除機能 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>