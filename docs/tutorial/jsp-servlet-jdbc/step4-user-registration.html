<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSP/Servlet/JDBC 実践チュートリアル Step 4 - ユーザー登録機能の実装</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Highlight.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: #f57c00;
        }
        
        .sidebar {
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .chapter-title {
            color: #f57c00;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f57c00;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            color: #ff9800;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
        }
        
        .quiz-container {
            background-color: #fff3e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f57c00;
        }
        
        .exercise-container {
            background-color: #f3e5f5;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #9c27b0;
        }
        
        .highlight {
            background-color: #ffecb3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .warning {
            background-color: #ffebee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }
        
        .code-block {
            background-color: #1e1e1e !important;
            color: #ffffff;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .nav-link.active {
            background-color: #f57c00 !important;
            color: white !important;
        }

        .form-flow {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .form-step {
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            background-color: #e8f5e8;
            display: inline-block;
            min-width: 120px;
        }

        .flow-arrow {
            font-size: 1.5em;
            color: #666;
            margin: 0 10px;
        }

        .validation-info {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #2196f3;
        }

        .form-preview {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .form-preview input, .form-preview textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-preview .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="../../../index.html">JSP/Servlet/JDBC 実践チュートリアル</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-nav-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../../index.html">ホーム</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="README.html">JSP/Servlet/JDBC</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>チュートリアル目次</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="step1-environment-setup.html">Step 1: 開発環境構築</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step2-mvc-architecture.html">Step 2: MVC概要</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step3-database-jdbc.html">Step 3: DB・JDBC</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="step4-user-registration.html">Step 4: ユーザー登録</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step5-user-list-detail.html">Step 5: 一覧・詳細</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step6-user-update-delete.html">Step 6: 更新・削除</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="step7-search-finalization.html">Step 7: 検索・仕上げ</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Step 4: ユーザー登録機能の実装</h1>
                </div>

                <div id="step4">
                    <h2 class="chapter-title">ユーザー登録機能の実装</h2>
                    
                    <!-- 学習目標 -->
                    <div class="highlight">
                        <h5>この章で学ぶこと</h5>
                        <ul>
                            <li>HTMLフォームの作成とJSPでの動的表示</li>
                            <li>POSTリクエストによるフォームデータの送信と受信</li>
                            <li>Servletでのリクエストパラメータ取得と検証</li>
                            <li>UserDAOのinsertメソッドを活用したデータ挿入</li>
                            <li>フォーム検証とエラーメッセージの表示</li>
                            <li>登録完了後のリダイレクト処理</li>
                        </ul>
                    </div>

                    <!-- フォーム処理の流れ -->
                    <h3 class="section-title">4.1 ユーザー登録の処理フロー</h3>
                    <p>Webアプリケーションでのフォーム処理は、表示→入力→送信→検証→保存→結果表示の流れで行われます。</p>

                    <div class="form-flow">
                        <h5>ユーザー登録フォーム処理の流れ</h5>
                        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin: 20px 0;">
                            <div class="form-step">
                                <strong>1. フォーム表示</strong><br>
                                <small>JSP<br>GET /user-form</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="form-step">
                                <strong>2. ユーザー入力</strong><br>
                                <small>HTML Form<br>データ入力</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="form-step">
                                <strong>3. データ送信</strong><br>
                                <small>POST submit<br>パラメータ送信</small>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; margin: 20px 0;">
                            <div class="form-step">
                                <strong>4. データ検証</strong><br>
                                <small>Servlet<br>バリデーション</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="form-step">
                                <strong>5. データ保存</strong><br>
                                <small>DAO<br>DB挿入</small>
                            </div>
                            <span class="flow-arrow">→</span>
                            <div class="form-step">
                                <strong>6. 結果表示</strong><br>
                                <small>JSP<br>成功/エラー</small>
                            </div>
                        </div>
                    </div>

                    <!-- ユーザー登録フォームJSPの作成 -->
                    <h3 class="section-title">4.2 ユーザー登録フォーム（JSP）の作成</h3>
                    <p>ユーザー情報を入力するためのフォーム画面をJSPで作成します。スクリプトレットを使用してエラーメッセージの表示や入力値の復元を行います。</p>

                    <div class="exercise-container">
                        <h5>実習 4-1: ユーザー登録フォームJSPの作成</h5>
                        <p>ユーザー名、メールアドレス、氏名を入力するフォーム画面を作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>src/main/webapp/jsp</code> フォルダに新しいファイル <code>user-form.jsp</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>user-form.jsp</h6>
                        <pre class="code-block"><code class="language-jsp">&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;%@ page import="java.util.List" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ユーザー登録 - Simple User Management System&lt;/title&gt;
    &lt;style&gt;
        body {
            font-family: 'Meiryo', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }
        input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0,123,255,0.3);
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        .field-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
        .required {
            color: #dc3545;
        }
        .form-info {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #bee5eb;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="container"&gt;
        &lt;h1&gt;ユーザー登録&lt;/h1&gt;
        
        &lt;div class="form-info"&gt;
            &lt;h4&gt;登録フォームの使い方&lt;/h4&gt;
            &lt;ul&gt;
                &lt;li&gt;すべての項目は必須入力です&lt;/li&gt;
                &lt;li&gt;ユーザー名は半角英数字で入力してください&lt;/li&gt;
                &lt;li&gt;メールアドレスは有効な形式で入力してください&lt;/li&gt;
                &lt;li&gt;氏名は日本語で入力できます&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
        
        &lt;%
            // エラーメッセージの表示
            String errorMessage = (String) request.getAttribute("errorMessage");
            if (errorMessage != null && !errorMessage.isEmpty()) {
        %&gt;
        &lt;div class="error-message"&gt;
            &lt;strong&gt;エラー:&lt;/strong&gt; &lt;%= errorMessage %&gt;
        &lt;/div&gt;
        &lt;%
            }
            
            // 成功メッセージの表示
            String successMessage = (String) request.getAttribute("successMessage");
            if (successMessage != null && !successMessage.isEmpty()) {
        %&gt;
        &lt;div class="success-message"&gt;
            &lt;strong&gt;成功:&lt;/strong&gt; &lt;%= successMessage %&gt;
        &lt;/div&gt;
        &lt;%
            }
            
            // フィールドエラーリストの取得
            @SuppressWarnings("unchecked")
            List&lt;String&gt; fieldErrors = (List&lt;String&gt;) request.getAttribute("fieldErrors");
            
            // 入力値の復元（エラー時に入力内容を保持）
            String username = (String) request.getAttribute("username");
            String email = (String) request.getAttribute("email");
            String fullName = (String) request.getAttribute("fullName");
            
            if (username == null) username = "";
            if (email == null) email = "";
            if (fullName == null) fullName = "";
        %&gt;
        
        &lt;form action="../user-register" method="post"&gt;
            &lt;div class="form-group"&gt;
                &lt;label for="username"&gt;ユーザー名 &lt;span class="required"&gt;*&lt;/span&gt;&lt;/label&gt;
                &lt;input type="text" id="username" name="username" value="&lt;%= username %&gt;" 
                       placeholder="例: tanaka_taro" maxlength="50" required&gt;
                &lt;%
                    if (fieldErrors != null) {
                        for (String error : fieldErrors) {
                            if (error.contains("ユーザー名")) {
                %&gt;
                &lt;div class="field-error"&gt;&lt;%= error %&gt;&lt;/div&gt;
                &lt;%
                            }
                        }
                    }
                %&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label for="email"&gt;メールアドレス &lt;span class="required"&gt;*&lt;/span&gt;&lt;/label&gt;
                &lt;input type="email" id="email" name="email" value="&lt;%= email %&gt;" 
                       placeholder="例: tanaka@example.com" maxlength="100" required&gt;
                &lt;%
                    if (fieldErrors != null) {
                        for (String error : fieldErrors) {
                            if (error.contains("メール")) {
                %&gt;
                &lt;div class="field-error"&gt;&lt;%= error %&gt;&lt;/div&gt;
                &lt;%
                            }
                        }
                    }
                %&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;label for="fullName"&gt;氏名 &lt;span class="required"&gt;*&lt;/span&gt;&lt;/label&gt;
                &lt;input type="text" id="fullName" name="fullName" value="&lt;%= fullName %&gt;" 
                       placeholder="例: 田中太郎" maxlength="100" required&gt;
                &lt;%
                    if (fieldErrors != null) {
                        for (String error : fieldErrors) {
                            if (error.contains("氏名")) {
                %&gt;
                &lt;div class="field-error"&gt;&lt;%= error %&gt;&lt;/div&gt;
                &lt;%
                            }
                        }
                    }
                %&gt;
            &lt;/div&gt;
            
            &lt;div class="form-group"&gt;
                &lt;button type="submit" class="btn"&gt;ユーザー登録&lt;/button&gt;
                &lt;button type="reset" class="btn btn-secondary"&gt;リセット&lt;/button&gt;
            &lt;/div&gt;
        &lt;/form&gt;
        
        &lt;hr&gt;
        &lt;p&gt;
            &lt;a href="../user-list"&gt;ユーザー一覧へ&lt;/a&gt; | 
            &lt;a href="../user-test"&gt;テストページ&lt;/a&gt; | 
            &lt;a href="../index.jsp"&gt;トップページ&lt;/a&gt;
        &lt;/p&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                    </div>

                    <!-- フォーム表示用Servletの作成 -->
                    <h3 class="section-title">4.3 フォーム表示用Servletの作成</h3>
                    <p>ユーザー登録フォームを表示するためのServletを作成します。GETリクエストでフォームを表示し、POSTリクエストで登録処理を行います。</p>

                    <div class="exercise-container">
                        <h5>実習 4-2: フォーム表示用Servletの作成</h5>
                        <p>ユーザー登録フォームの表示を制御するServletを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>controller</code> パッケージに新しいクラス <code>UserFormServlet</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>UserFormServlet.java</h6>
                        <pre class="code-block"><code class="language-java">package controller;

import java.io.IOException;

import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

/**
 * ユーザー登録フォーム表示Servlet
 * GET: フォーム表示
 * Controller層（MVCパターン）
 */
@WebServlet("/user-form")
public class UserFormServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;

    /**
     * GETリクエスト: ユーザー登録フォームの表示
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // フォーム表示用JSPにフォワード
        RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-form.jsp");
        dispatcher.forward(request, response);
    }
}</code></pre>
                    </div>

                    <!-- ユーザー登録処理Servletの作成 -->
                    <h3 class="section-title">4.4 ユーザー登録処理Servletの作成</h3>
                    <p>フォームから送信されたデータを受信し、検証を行い、データベースに保存する処理を実装します。</p>

                    <div class="validation-info">
                        <h5>フォーム検証のポイント</h5>
                        <ul>
                            <li><strong>必須チェック</strong>: すべてのフィールドが入力されているか</li>
                            <li><strong>長さチェック</strong>: 文字数制限内に収まっているか</li>
                            <li><strong>形式チェック</strong>: メールアドレスが正しい形式か</li>
                            <li><strong>重複チェック</strong>: ユーザー名・メールが既に存在しないか</li>
                            <li><strong>文字種チェック</strong>: ユーザー名が半角英数字のみか</li>
                        </ul>
                    </div>

                    <div class="exercise-container">
                        <h5>実習 4-3: ユーザー登録処理Servletの作成</h5>
                        <p>フォームデータの受信、検証、データベース保存を行うServletを作成します。</p>
                        
                        <h6>手順</h6>
                        <ol>
                            <li><code>controller</code> パッケージに新しいクラス <code>UserRegisterServlet</code> を作成</li>
                            <li>以下のコードを入力:</li>
                        </ol>

                        <h6>UserRegisterServlet.java</h6>
                        <pre class="code-block"><code class="language-java">package controller;

import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Pattern;

import jakarta.servlet.RequestDispatcher;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import model.User;
import model.UserDAO;

/**
 * ユーザー登録処理Servlet
 * POST: フォームデータの受信と登録処理
 * Controller層（MVCパターン）
 */
@WebServlet("/user-register")
public class UserRegisterServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    
    private UserDAO userDAO = new UserDAO();
    
    // 正規表現パターン
    private static final Pattern USERNAME_PATTERN = Pattern.compile("^[a-zA-Z0-9_]{3,50}$");
    private static final Pattern EMAIL_PATTERN = Pattern.compile("^[\\w\\.-]+@[\\w\\.-]+\\.[a-zA-Z]{2,}$");

    /**
     * POSTリクエスト: ユーザー登録処理
     */
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // リクエストパラメータの取得
        String username = request.getParameter("username");
        String email = request.getParameter("email");
        String fullName = request.getParameter("fullName");
        
        // 入力値の前後空白除去
        if (username != null) username = username.trim();
        if (email != null) email = email.trim();
        if (fullName != null) fullName = fullName.trim();
        
        // 入力値をリクエストに設定（エラー時の値復元用）
        request.setAttribute("username", username);
        request.setAttribute("email", email);
        request.setAttribute("fullName", fullName);
        
        // バリデーション実行
        List&lt;String&gt; errors = validateInput(username, email, fullName);
        
        // バリデーションエラーがある場合
        if (!errors.isEmpty()) {
            request.setAttribute("fieldErrors", errors);
            request.setAttribute("errorMessage", "入力内容にエラーがあります。確認してください。");
            
            // フォームページに戻る
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-form.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        // 重複チェック
        try {
            // ユーザー名の重複チェック
            User existingUserByUsername = userDAO.findByUsername(username);
            if (existingUserByUsername != null) {
                errors.add("ユーザー名 '" + username + "' は既に使用されています。");
            }
            
            // メールアドレスの重複チェック（簡易版 - 実際はEMAIL用メソッドを追加すべき）
            List&lt;User&gt; allUsers = userDAO.findAll();
            for (User user : allUsers) {
                if (email.equals(user.getEmail())) {
                    errors.add("メールアドレス '" + email + "' は既に使用されています。");
                    break;
                }
            }
            
            // 重複エラーがある場合
            if (!errors.isEmpty()) {
                request.setAttribute("fieldErrors", errors);
                request.setAttribute("errorMessage", "入力されたユーザー名またはメールアドレスは既に使用されています。");
                
                RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-form.jsp");
                dispatcher.forward(request, response);
                return;
            }
            
        } catch (SQLException e) {
            // データベースエラー
            request.setAttribute("errorMessage", "データベースエラーが発生しました: " + e.getMessage());
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-form.jsp");
            dispatcher.forward(request, response);
            return;
        }
        
        // ユーザーオブジェクトの作成と登録
        try {
            User newUser = new User(username, email, fullName);
            boolean success = userDAO.insert(newUser);
            
            if (success) {
                // 登録成功 - ユーザー一覧ページにリダイレクト
                response.sendRedirect("user-list?message=ユーザー「" + fullName + "」を登録しました。");
            } else {
                // 登録失敗
                request.setAttribute("errorMessage", "ユーザー登録に失敗しました。再度お試しください。");
                RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-form.jsp");
                dispatcher.forward(request, response);
            }
            
        } catch (SQLException e) {
            // データベースエラー
            request.setAttribute("errorMessage", "データベースエラーが発生しました: " + e.getMessage());
            RequestDispatcher dispatcher = request.getRequestDispatcher("/jsp/user-form.jsp");
            dispatcher.forward(request, response);
        }
    }
    
    /**
     * 入力値の検証
     * @param username ユーザー名
     * @param email メールアドレス
     * @param fullName 氏名
     * @return List&lt;String&gt; エラーメッセージリスト
     */
    private List&lt;String&gt; validateInput(String username, String email, String fullName) {
        List&lt;String&gt; errors = new ArrayList&lt;&gt;();
        
        // ユーザー名の検証
        if (username == null || username.isEmpty()) {
            errors.add("ユーザー名は必須です。");
        } else if (username.length() &lt; 3) {
            errors.add("ユーザー名は3文字以上で入力してください。");
        } else if (username.length() &gt; 50) {
            errors.add("ユーザー名は50文字以内で入力してください。");
        } else if (!USERNAME_PATTERN.matcher(username).matches()) {
            errors.add("ユーザー名は半角英数字とアンダースコアのみ使用できます。");
        }
        
        // メールアドレスの検証
        if (email == null || email.isEmpty()) {
            errors.add("メールアドレスは必須です。");
        } else if (email.length() &gt; 100) {
            errors.add("メールアドレスは100文字以内で入力してください。");
        } else if (!EMAIL_PATTERN.matcher(email).matches()) {
            errors.add("メールアドレスの形式が正しくありません。");
        }
        
        // 氏名の検証
        if (fullName == null || fullName.isEmpty()) {
            errors.add("氏名は必須です。");
        } else if (fullName.length() &gt; 100) {
            errors.add("氏名は100文字以内で入力してください。");
        }
        
        return errors;
    }
}</code></pre>
                    </div>

                    <!-- 動作確認 -->
                    <h3 class="section-title">4.5 ユーザー登録機能の動作確認</h3>
                    <p>作成したユーザー登録機能が正常に動作することを確認します。</p>

                    <div class="exercise-container">
                        <h5>実習 4-4: ユーザー登録機能の動作確認</h5>
                        <p>様々なケースでユーザー登録機能をテストし、正常に動作することを確認します。</p>
                        
                        <h6>動作確認手順</h6>
                        <ol>
                            <li><strong>正常系のテスト</strong>
                                <ul>
                                    <li>ブラウザで <code>http://localhost:8080/SimpleUserManagementSystem/user-form</code> にアクセス</li>
                                    <li>以下の情報を入力:
                                        <ul>
                                            <li>ユーザー名: <code>test_user1</code></li>
                                            <li>メールアドレス: <code>test1@example.com</code></li>
                                            <li>氏名: <code>テストユーザー1</code></li>
                                        </ul>
                                    </li>
                                    <li>「ユーザー登録」ボタンをクリック</li>
                                    <li>ユーザー一覧ページにリダイレクトされ、成功メッセージが表示されることを確認</li>
                                </ul>
                            </li>
                            
                            <li><strong>必須チェックのテスト</strong>
                                <ul>
                                    <li>再度フォームページにアクセス</li>
                                    <li>すべての項目を空欄のまま「ユーザー登録」をクリック</li>
                                    <li>エラーメッセージが表示されることを確認</li>
                                </ul>
                            </li>
                            
                            <li><strong>形式チェックのテスト</strong>
                                <ul>
                                    <li>ユーザー名: <code>あいうえお</code>（日本語）</li>
                                    <li>メールアドレス: <code>invalid-email</code>（不正な形式）</li>
                                    <li>氏名: <code>正常な氏名</code></li>
                                    <li>適切なエラーメッセージが表示されることを確認</li>
                                </ul>
                            </li>
                            
                            <li><strong>重複チェックのテスト</strong>
                                <ul>
                                    <li>既に登録した <code>test_user1</code> と同じユーザー名で登録を試行</li>
                                    <li>重複エラーが表示されることを確認</li>
                                </ul>
                            </li>
                        </ol>

                        <h6>期待される結果</h6>
                        <ul>
                            <li>正常なデータは正常に登録される</li>
                            <li>バリデーションエラーは適切なメッセージで通知される</li>
                            <li>エラー時に入力値が保持される</li>
                            <li>重複データは登録できない</li>
                            <li>登録成功時はユーザー一覧ページにリダイレクトされる</li>
                        </ul>
                    </div>

                    <!-- トラブルシューティング -->
                    <div class="warning">
                        <h5>よくある問題と解決方法</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>1. フォームが表示されない</h6>
                                <ul>
                                    <li>user-form.jspファイルの配置場所を確認（src/main/webapp/jsp/）</li>
                                    <li>UserFormServletのマッピング（@WebServlet("/user-form")）を確認</li>
                                    <li>RequestDispatcherのパス（/jsp/user-form.jsp）を確認</li>
                                </ul>
                                
                                <h6>2. データが登録されない</h6>
                                <ul>
                                    <li>PostgreSQLサービスが起動しているか確認</li>
                                    <li>DatabaseUtilの接続情報が正しいか確認</li>
                                    <li>usersテーブルが存在するか確認</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>3. 文字化けが発生する</h6>
                                <ul>
                                    <li>CharacterEncodingFilterが動作しているか確認</li>
                                    <li>JSPファイルのエンコーディング設定を確認</li>
                                    <li>データベースの文字エンコーディング（UTF-8）を確認</li>
                                </ul>
                                
                                <h6>4. エラーメッセージが表示されない</h6>
                                <ul>
                                    <li>リクエストスコープへの属性設定を確認</li>
                                    <li>JSPでのスクリプトレット記述を確認</li>
                                    <li>条件分岐（if文）の記述を確認</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 理解度確認クイズ -->
                    <div class="quiz-container">
                        <h5>理解度確認クイズ</h5>
                        <ol>
                            <li><strong>HTMLフォームでPOSTメソッドを使用する理由を説明してください。</strong></li>
                            <li><strong>Servletでリクエストパラメータを取得するメソッドは何ですか？</strong></li>
                            <li><strong>フォーム検証でチェックすべき主な項目を5つ挙げてください。</strong></li>
                            <li><strong>データ登録成功後にリダイレクトを使用する理由を説明してください。</strong></li>
                            <li><strong>以下のJSPコードの役割を説明してください:</strong>
                                <pre><code>&lt;%= request.getAttribute("username") %&gt;</code></pre>
                            </li>
                            <li><strong>正規表現パターン `^[a-zA-Z0-9_]{3,50}$` の意味を説明してください。</strong></li>
                        </ol>
                        
                        <details style="margin-top: 20px;">
                            <summary>解答例を表示</summary>
                            <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                <ol>
                                    <li>POSTメソッドはデータをHTTPボディに含めて送信するため、URLに表示されず、大量のデータを送信でき、セキュリティ面でも優れているため</li>
                                    <li>request.getParameter(String parameterName)</li>
                                    <li>①必須チェック ②長さチェック ③形式チェック ④重複チェック ⑤文字種チェック</li>
                                    <li>ブラウザの更新ボタンによる重複送信を防ぎ、PRG（Post-Redirect-Get）パターンでユーザビリティを向上させるため</li>
                                    <li>リクエストスコープから"username"属性を取得して表示する（エラー時の入力値復元に使用）</li>
                                    <li>半角英数字とアンダースコアのみで、3文字以上50文字以下の文字列にマッチする</li>
                                </ol>
                            </div>
                        </details>
                    </div>

                    <!-- まとめ -->
                    <h3 class="section-title">4.6 まとめ</h3>
                    <p>このステップでは、ユーザー登録機能の実装を通じてWebアプリケーションの基本的なフォーム処理を学習しました：</p>
                    <ul>
                        <li><strong>フォーム作成</strong>: JSPでのHTMLフォーム作成、スクリプトレットによる動的表示</li>
                        <li><strong>データ受信</strong>: Servletでのリクエストパラメータ取得</li>
                        <li><strong>データ検証</strong>: サーバーサイドバリデーション、正規表現パターン</li>
                        <li><strong>エラー処理</strong>: エラーメッセージ表示、入力値復元</li>
                        <li><strong>データ保存</strong>: UserDAOを使用したデータベース挿入</li>
                        <li><strong>画面遷移</strong>: フォワードとリダイレクトの使い分け</li>
                    </ul>
                    
                    <p>次のステップでは、登録したユーザーを一覧表示し、詳細情報を閲覧する機能を実装して、データ取得と表示の方法を学習します。</p>

                    <!-- ナビゲーション -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="step3-database-jdbc.html" class="btn btn-secondary">← 前の章: データベース設計とJDBC接続</a>
                        <a href="step5-user-list-detail.html" class="btn btn-primary">次の章: ユーザー一覧・詳細表示機能 →</a>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js 初期化 -->
    <script>hljs.highlightAll();</script>
</body>
</html>