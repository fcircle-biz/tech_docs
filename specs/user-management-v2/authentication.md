# 認証機能

## 認証の基本概念

### セッションとは

ユーザーがログインしてからログアウトするまでの「接続状態」を管理する仕組み。

```
[ログイン] → [セッション開始] → [各ページにアクセス] → [ログアウト] → [セッション終了]
```

## 認証フロー

### 1. ユーザー登録（サインアップ）

```
ユーザー                    システム
   |                          |
   |-- 登録情報を入力 -------->|
   |   (username, password,   |
   |    email, full_name)     |
   |                          |-- 入力値を検証
   |                          |-- パスワードをハッシュ化
   |                          |-- データベースに保存
   |<-- 登録完了 -------------|
   |                          |
```

**処理手順：**
1. フォームから入力値を受け取る
2. 入力値のバリデーション
   - 必須項目のチェック
   - ユーザー名の重複チェック
   - パスワードの長さチェック（例：8文字以上）
3. パスワードをハッシュ化
4. データベースに保存
5. 登録完了画面またはログイン画面へ遷移

### 2. ログイン

```
ユーザー                    システム
   |                          |
   |-- username, password --->|
   |                          |-- ユーザー名でDB検索
   |                          |-- パスワード照合
   |                          |-- セッションにユーザーID保存
   |<-- ログイン成功 ---------|
   |                          |
```

**処理手順：**
1. ユーザー名とパスワードを受け取る
2. ユーザー名でデータベースを検索
3. ユーザーが存在しない場合 → エラー
4. `is_active` が FALSE の場合 → エラー
5. 入力パスワードとハッシュを照合
6. 一致しない場合 → エラー
7. セッションにユーザーIDを保存
8. ユーザー一覧画面へ遷移

### 3. 認証チェック（各ページ）

```
ユーザー                    システム
   |                          |
   |-- ページにアクセス ------>|
   |                          |-- セッションを確認
   |                          |   └─ ユーザーIDあり？
   |                          |
   |<-- ページ表示 -----------|  (あり: 表示)
   |<-- ログイン画面へ -------|  (なし: リダイレクト)
```

**処理手順：**
1. セッションからユーザーIDを取得
2. ユーザーIDがない → ログイン画面へリダイレクト
3. ユーザーIDがある → ページを表示

### 4. ログアウト

```
ユーザー                    システム
   |                          |
   |-- ログアウト要求 -------->|
   |                          |-- セッションを破棄
   |<-- ログイン画面へ -------|
```

**処理手順：**
1. セッションを破棄（クリア）
2. ログイン画面へリダイレクト

## バリデーションルール

### ユーザー登録時

| 項目 | ルール |
|------|--------|
| ユーザー名 | 必須、3〜50文字、半角英数字とアンダースコアのみ、重複不可 |
| パスワード | 必須、8文字以上 |
| メールアドレス | 必須、メール形式 |
| 氏名 | 必須、100文字以内 |
| 生年月日 | 任意、日付形式 |

### ログイン時

| 項目 | ルール |
|------|--------|
| ユーザー名 | 必須 |
| パスワード | 必須 |

## エラーメッセージ例

| 状況 | メッセージ |
|------|------------|
| ユーザー名が未入力 | ユーザー名を入力してください |
| ユーザー名が重複 | このユーザー名は既に使用されています |
| パスワードが短い | パスワードは8文字以上で入力してください |
| ログイン失敗 | ユーザー名またはパスワードが正しくありません |
| アカウント無効 | このアカウントは無効になっています |

## セキュリティ上の注意点

### パスワード

- 平文で保存しない（必ずハッシュ化）
- ログやエラーメッセージに表示しない
- 画面上では `***` でマスク表示

### ログイン失敗時

- 「ユーザー名が間違っています」「パスワードが間違っています」と個別に表示しない
- 「ユーザー名またはパスワードが正しくありません」と曖昧に表示

### セッション

- ログアウト時は確実にセッションを破棄
- セッションIDは推測困難なランダム値（フレームワークに任せる）

## 画面遷移図

```
[ログイン画面] ─────────────────────────────────┐
      │                                         │
      │ 新規登録リンク                          │ ログイン成功
      ▼                                         ▼
[ユーザー登録画面]                        [ユーザー一覧画面]
      │                                    │    │    │
      │ 登録完了                          │    │    │
      └──────────────────────────────────┘    │    │
                                              │    │
                    ┌─────────────────────────┘    │
                    │                              │
                    ▼                              ▼
            [ユーザー詳細画面]              [ユーザー編集画面]
                    │                              │
                    │                              │
                    ▼                              │
            [削除確認画面]                         │
                    │                              │
                    └──────────────────────────────┘
                                  │
                                  │ ログアウト
                                  ▼
                           [ログイン画面]
```

## 実装のヒント

### フレームワーク別

| フレームワーク | 認証機能 |
|----------------|----------|
| Django | `django.contrib.auth` |
| Laravel | Laravel Breeze / Sanctum |
| Spring Boot | Spring Security |
| Express.js | Passport.js |
| OutSystems | 組み込みのUser Entity と Login Action |

初心者はフレームワークの認証機能を活用することを推奨。
自作する場合は、まずこのドキュメントの基本フローを理解してから実装する。
